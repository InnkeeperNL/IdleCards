var next_turn_timeout,next_action_timeout,current_page=1,cards_per_page=8,showing_heroes=!1,max_deck_size=30,edit_mode="view";function show_deck_edit(){show_available_cards(showing_heroes),show_current_deck(),update_edit_view_slider()}function show_available_cards(e){void 0!=gamedata.edit_mode&&(edit_mode=gamedata.edit_mode),cards_per_page=8,!0==e||!0==showing_heroes?$(".hero_mode").addClass("active"):$(".hero_mode").removeClass("active"),!0==e||!0==showing_heroes?$("#content_deck_edit .current_hero").addClass("glowing_hero"):$("#content_deck_edit .current_hero").removeClass("glowing_hero"),gamedata.owned_cards=sortObj(gamedata.owned_cards),$("#content_deck_edit .available_cards").html("");var t=0;void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck];if($.each(a,function(e,t){t<1&&delete a[e]}),gamedata.owned_cards[gamedata.decks[gamedata.current_deck].hero]<1&&delete gamedata.decks[gamedata.current_deck].hero,gamedata.decks[gamedata.current_deck]=sortObj(gamedata.decks[gamedata.current_deck]),void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero])var o=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0];else var o="colorless";if("colorless"==o&&(o=get_second_deck_color()),void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero]&&void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1])var n=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1];else var n=get_second_deck_color(o);$.each(gamedata.owned_cards,function(r,s){var c=s+0;void 0!=a[r]&&(c-=a[r]),void 0!=a.hero&&a.hero==r&&(c-=1),c<0&&(a[r]+=c,gamedata.decks[gamedata.current_deck][r]=a[r],0==a[r]&&delete gamedata.decks[gamedata.current_deck][r],a[r]<0&&(delete gamedata.decks[gamedata.current_deck][r],delete gamedata.decks[gamedata.current_deck].hero),saveToLocalStorage());var d=!1,l=!1;if(("boost"==all_available_cards[r].type||"recipe"==all_available_cards[r].type||"fragment"==all_available_cards[r].type||"material"==all_available_cards[r].type||"consumable"==all_available_cards[r].type||"token"==all_available_cards[r].type||"currency"==all_available_cards[r].type||"cardback"==all_available_cards[r].type||"item"==all_available_cards[r].type||"treasure"==all_available_cards[r].type||!1==$("."+all_available_cards[r].type+"_type_filter").prop("checked"))&&(d=!0),(void 0==e||!1==e)&&(!1==n&&all_available_cards[r].color[0]!=o&&void 0!=all_available_cards[r].color[1]&&all_available_cards[r].color[1]!=o&&(l=!0),$.each(all_available_cards[r].color,function(e,t){t!=o&&!1!=n&&t!=n&&"colorless"!=t&&(l=!0)})),c>0&&(void 0==e||!1==e||void 0!=all_available_cards[r].hero_version)&&!1==d&&!1==check_filters(r,e)&&++t/cards_per_page>current_page-1&&t/cards_per_page<=current_page){if(void 0!=e&&!0==e){var u=parse_card(r,void 0,!0);$("#content_deck_edit .available_cards").append('<div class="available_card_container" onclick="set_hero(\''+r+"')\">"+u+"</div>")}else{var u=parse_card(r,c);!0==l?$("#content_deck_edit .available_cards").append("<div onclick=\"show_card_details('"+r+'\')" class="available_card_container faded">'+u+"</div>"):$("#content_deck_edit .available_cards").append("<div onclick=\"add_card_to_deck('"+r+'\')" class="available_card_container">'+u+"</div>")}}}),1==current_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/cards_per_page<=current_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),t>0&&""==$("#content_deck_edit .available_cards").html()&&(current_page=1,show_available_cards(e)),0==t?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_page+" / "+Math.ceil(t/cards_per_page)),$(".current_deck_colors").html("");var r="";r+='<div class="deck_color color_'+o+'"></div>',r+='<div class="deck_color color_'+n+'"></div>',$(".current_deck_colors").html(r),void 0==gamedata.decks[gamedata.current_deck].hero&&(void 0==e||!1==e)&&show_available_cards(!0)}function get_second_deck_color(e){var t=!1;if(void 0==e&&(e=!1,void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero]&&(e=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0])),void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero]&&void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1])t=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1];else{var a=gamedata.decks[gamedata.current_deck];$.each(a,function(a,o){void 0!=all_available_cards[a]&&$.each(all_available_cards[a].color,function(a,o){!1==t&&"colorless"!=o&&o!=e&&(t=o)})})}return t}function show_available_heroes(){show_available_cards(showing_heroes=!0!=showing_heroes)}function show_current_hero_details(){show_available_heroes()}function show_current_deck(){void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var e=gamedata.decks[gamedata.current_deck];if($("#content_deck_edit .current_deck").html(""),$("#content_deck_edit .current_hero").html(""),void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero])var t=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0];else var t="colorless";if("colorless"==t&&(t=get_second_deck_color()),void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero]&&void 0!=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1])var a=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1];else var a=get_second_deck_color(t);$.each(e,function(o,n){if("hero"==o){var r=parse_card(n,void 0,!0);$("#content_deck_edit .current_hero").append("<div>"+r+"</div>")}if("hero"!=o&&n>0){if(void 0==all_available_cards[o]||"colorless"!=all_available_cards[o].color[0]&&all_available_cards[o].color[0]!=t&&all_available_cards[o].color[0]!=a||void 0!=all_available_cards[o].color[1]&&all_available_cards[o].color[1]!=t&&all_available_cards[o].color[1]!=a)delete e[o],saveToLocalStorage();else{var r=parse_card(o,n),s=check_filters(o);$("#content_deck_edit .current_deck").append("<div onclick=\"remove_card_from_deck('"+o+'\')" class="filtered_'+s+'">'+r+"</div>")}}});var o=count_current_deck_cards(e),n=o/max_deck_size*100;o<max_deck_size?$(".card_count").html('<div class="fill_bar" style="height:'+n+'%;"></div><span><br/>'+o+'<br/><span style="color:#555">'+max_deck_size+"</span></span>"):$(".card_count").html('<div class="fill_bar" style="height:'+n+'%;"></div><span style="color:#555"><br/>'+o+"<br/>"+max_deck_size+"</span>")}function parse_card(e,t,a,o){"scraps"==e&&(e="scraps_placeholder");var n="";if(void 0!=all_available_cards[e]){var r=all_available_cards[e];void 0!=a&&!0==a&&((r=r.hero_version).color=all_available_cards[e].color),n+='<div class="card card_type_'+r.type+'">',count_object(r.color)>1?$.each(r.color,function(e,t){n+='<div class="card_color color_'+t+" color_number_"+e+'"></div>'}):n+='<div class="card_color color_'+r.color[0]+'"></div>';var s="";void 0!=r.image_position&&(s=";background-position:"+r.image_position),n+='<div class="card_image" style="background-image:url(images/'+r.image+")"+s+'"></div>';var c="";if($.each(r.abilities,function(e,t){if((("strike"!=e||!0==a)&&("strike_unit"!=e||!0!=a)||1!=t)&&(""!=c&&(c+=",&nbsp;</span>"),void 0!=all_abilities[e])){var o=t,n=0;if("object"==typeof o){var o=t.level;void 0!=t.delay&&(n=t.delay-0)}var r=all_abilities[e];c+='<span style="color:'+r.name_color+'">',c+=r.name,(o>1||void 0!=r.show_amount_adjustment||void 0!=t.level_2)&&(void 0!=r.show_amount_adjustment&&(o+=r.show_amount_adjustment),c+=" "+o,void 0!=r.post_name&&(c+=r.post_name)),void 0!=t.level_2&&t.level_2>1&&(c+="/"+t.level_2),n>0&&void 0==t.delay&&(c+=" ("+n+")"),void 0!=t.delay&&t.delay>0&&(c+=" ("+(t.delay-0)+")")}}),"cardback"==r.type&&void 0!=r.reward&&void 0!=r.reward.type&&"card_back"==r.reward.type&&void 0!=gamedata.owned_card_backs&&void 0!=gamedata.owned_card_backs[e]&&(c+='<span style="color:rgba(0,200,0,0.9)">collected</span>'),"cardback"==r.type&&void 0!=r.reward&&void 0!=r.reward.type&&"card_back"==r.reward.type&&(void 0==gamedata.owned_card_backs||void 0==gamedata.owned_card_backs[e])&&(c+='<span style="color:rgba(255,0,0,0.9)">not collected</span>'),"fragment"==r.type&&void 0!=owned_buildings_fragments[e]){c+='<span style="color:rgba(255,255,255,0.9)">built,</span> ';var d=calculate_upgrade_cost(owned_buildings_fragments[e].building_level),l=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(l=gamedata.owned_cards[e]),l>=d?c+='<span style="color:rgba(0,200,0,0.9)">'+l+" / "+d+"</span>":c+='<span style="color:rgba(255,255,255,0.9)">'+l+" / "+d+"</span>"}if("fragment"==r.type&&void 0==owned_buildings_fragments[e]&&(c+='<span style="color:rgba(255,0,0,0.9)">not built</span>'),""!=c&&(c+="</span>"),n+='<div class="card_abilities"><div class="card_type">'+r.type+"</div>"+c+"</div>",void 0!=r.time&&!1!=r.time&&(n+='<div class="card_time">'+r.time+"</div>"),"cardback"==r.type&&void 0!=r.reward&&void 0!=r.reward.type&&"card_back"==r.reward.type)n+='<div class="card_name">Card back</div>';else{var u=findLongestWord(r.name),m=20;u>8&&(m*=8/u),m+="px",void 0==o?n+='<div class="card_name" style="font-size:'+m+';">'+capitalizeFirstLetter(r.name)+"</div>":n+='<div class="card_name" style="font-size:'+m+';">'+capitalizeFirstLetter(o)+"</div>"}void 0!=t&&(n+='<div class="owned_amount">'+t+"</div>"),!1!==r.power&&(n+='<div class="card_power">'+r.power+"</div>"),!1!=r.health&&(n+='<div class="card_health">'+r.health+"</div>"),r.armor>0&&(n+='<div class="card_armor">'+r.armor+"</div>"),n+='<div class="unit_effects">',$.each(r.effects,function(e,t){n+='<div class="effect_'+e+'">'+t+"</div>"}),n+="</div>",void 0!=r.shiny&&!0==r.shiny&&(n+='<div class="shiny"></div>'),n+="</div>"}return n}function set_deck_edit_page(e){(current_page+=e)<1&&(current_page=1),show_deck_edit()}function add_card_to_deck(e,t){if("edit"==edit_mode||!0==t){void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck];void 0==a[e]&&(a[e]=0),void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>a[e]&&count_current_deck_cards(a)<max_deck_size&&(a[e]<5&&void 0==all_available_cards[e].unique||a[e]<1&&a.hero!=e)&&a[e]++,saveToLocalStorage(),show_deck_edit()}else{void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck],o=!0;void 0==a[e]&&(a[e]=0),a[e]>=5&&(o=!1),void 0!=all_available_cards[e].unique&&a[e]>0&&(o=!1),void 0!=all_available_cards[e].unique&&a.hero==e&&(o=!1),void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>a[e]&&count_current_deck_cards(a)<max_deck_size&&!0==o?show_card_details(e,!1,void 0,"add_to_deck"):show_card_details(e,!1,void 0,!1)}}function count_current_deck_cards(e){var t=0;return $.each(e,function(e,a){"hero"!=e&&(t+=a)}),t}function clear_current_deck(){gamedata.decks[gamedata.current_deck]={},saveToLocalStorage(),show_deck_edit()}function remove_card_from_deck(e,t){if("edit"==edit_mode||!0==t){void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck];void 0==a[e]&&(a[e]=0),void 0!=gamedata.owned_cards[e]&&a[e]>0&&a[e]--,0==a[e]&&delete a[e],saveToLocalStorage(),show_deck_edit()}else!1==showing_heroes||void 0==all_available_cards[e].hero_version?show_card_details(e,showing_heroes,void 0,"remove_from_deck"):show_card_details(e,showing_heroes,void 0,"set_hero")}function set_hero(e,t){if("edit"==edit_mode||!0==t){void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck];void 0==a[e]&&(a[e]=0),void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>a[e]?(a.hero=e,void 0!=all_available_cards[e].unique&&void 0!=a[e]&&remove_card_from_deck(e,!0)):void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(a.hero=e,void 0!=all_available_cards[e].unique&&void 0!=a[e]&&remove_card_from_deck(e,!0)),saveToLocalStorage(),show_deck_edit()}else show_card_details(e,!0,void 0,"set_hero")}function check_hero_color(){void 0==gamedata.decks[gamedata.current_deck]&&(gamedata.current_deck=0);var e=gamedata.decks[gamedata.current_deck],t=all_available_cards[e.hero].color[0],a=get_second_deck_color();$.each(e,function(o,n){"hero"!=o&&"colorless"!=all_available_cards[o].color[0]&&all_available_cards[o].color[0]!=t&&all_available_cards[o].color[0]!=a&&delete e[o],"hero"!=o&&void 0!=all_available_cards[o].color[1]&&"colorless"!=all_available_cards[o].color[1]&&all_available_cards[o].color[1]!=t&&all_available_cards[o].color[1]!=a&&delete e[o]})}function gain_random_card(){var e=get_random_card("any");void 0==gamedata.owned_cards[e]?gamedata.owned_cards[e]=1:gamedata.owned_cards[e]+=1,saveToLocalStorage()}function gain_all_cards(e){void 0==e&&(e=1),$.each(all_available_cards,function(t,a){void 0==namechanges[t]&&(void 0==gamedata.owned_cards[t]?gamedata.owned_cards[t]=e:gamedata.owned_cards[t]<e&&(gamedata.owned_cards[t]=e))}),saveToLocalStorage()}function gain_card(e,t){void 0==t&&(t=1),"scrap"!=e&&void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]?gamedata.owned_cards[e]=t:gamedata.owned_cards[e]+=t,t>0&&check_quests("gained_card_"+e,void 0,t)),"scrap"==e&&gain_scraps(t),saveToLocalStorage()}function count_card_colors(e){void 0==e&&(e=0);var t={},a={},o={};$.each(all_available_cards,function(n,r){if(void 0!=r.pick_chance&&r.pick_chance>=e&&("creature"==r.type||"structure"==r.type||"object"==r.type||"spell"==r.type||"artifact"==r.type)&&($.each(r.color,function(e,n){void 0==t[n]?(t[n]=1,a[n]={}):t[n]+=1,void 0==o[n]&&(o[n]=0),o[n]+=r.time,void 0==a[n][r.time]&&(a[n][r.time]=0),a[n][r.time]++}),count_object(r.color)>1)){var s=r.color;void 0==t[s]&&void 0==t[r.color[1]+","+r.color[0]]?t[s]=1:void 0!=t[r.color[1]+","+r.color[0]]?(t[r.color[1]+","+r.color[0]]+=1,console.log(n)):t[s]+=1}}),t=sortObj(t,"value"),$.each(t,function(e,t){console.log(e+": "+t)}),console.log(a),$.each(o,function(e,a){console.log(e+" a.t.: "+Math.floor(a/t[e]*10)/10)})}function check_card_recipes(e){var t={};return $.each(e,function(e,a){0==count_object(t)?$.each(all_available_cards,function(e,o){void 0!=o.recipe&&void 0!=o.recipe[a]&&(t[e]=o.recipe)}):$.each(t,function(e,o){void 0!=all_available_cards[e].recipe&&void 0==all_available_cards[e].recipe[a]&&delete t[e]})}),t}function select_mode(e){edit_mode=e,$(".edit_view div").removeClass("active"),$(".edit_view .select_"+e).addClass("active")}function toggle_edit_view_mode(){void 0==gamedata.edit_mode&&(gamedata.edit_mode="view"),edit_mode="edit"==(edit_mode=gamedata.edit_mode)?"view":"edit",gamedata.edit_mode=edit_mode,saveToLocalStorage(),update_edit_view_slider()}function update_edit_view_slider(){$(".edit_view div").removeClass("active"),"view"==edit_mode?($(".edit_view .edit_view_slider").addClass("viewing"),$(".edit_view .select_view").addClass("active")):($(".edit_view .edit_view_slider").removeClass("viewing"),$(".edit_view .select_edit").addClass("active"))}function show_card_details(e,t,a,o,n){if(void 0!=all_available_cards[e]||void 0!=all_chapters[e]){var r=all_available_cards[e];void 0!=all_chapters[e]&&(r=all_chapters[e].hero),$(".detail_overlay .card_detail").html(""),void 0!=t&&!0==t&&void 0==r.hero_version&&(t=!1),void 0!=n&&void 0!=battle_info.combat_units[n]&&(r=battle_info.combat_units[n],t=!1);var s="",c="";if(c=void 0!=all_available_cards[e]&&(void 0==n||void 0==battle_info.combat_units[n])?parse_card(e,a,t):'<div class="unit">'+$(".unit_id_"+n).html()+"</div>",s+='<div class="available_cards">',s+=c,s+="</div>",void 0!=r.quote&&(s+='<div class="card_quote">',s+=r.quote.split('"').join('<span class="card_quote_quote">"</span>'),s+="</div>"),void 0!=r.value&&r.value>0&&"currency"!=all_available_cards[e].type&&"recipe"!=all_available_cards[e].type&&(s+='<div class="card_value">Value: ',s+=numberWithCommas(r.value),void 0!=r.recipe&&"recipe"!=r.type&&(void 0!=gamedata.known_recipes&&void 0!=gamedata.known_recipes[e]?s+="<br/>Recipe known":s+="<br/>Recipe not known"),1==r.used_in_recipes&&(s+="<br/>Used in 1 recipe"),r.used_in_recipes>1&&(s+="<br/>Used in "+r.used_in_recipes+" recipes"),void 0!=gamedata.owned_cards[e]&&(s+="<br/>Owned: "+Math.floor(gamedata.owned_cards[e])),void 0!=all_available_cards[e]&&(void 0==n||void 0==battle_info.combat_units[n])&&"consumable"==all_available_cards[e].type&&void 0!=all_available_cards[e].reward&&void 0!=all_available_cards[e].reward.type&&"card_back"==all_available_cards[e].reward.type&&(void 0==gamedata.owned_card_backs[all_available_cards[e].reward.card_back_id]?s+="<br/>Not collected":s+="<br/>Collected"),s+="</div>"),s+='<div class="ability_details">',s+='<div class="single_ability">',s+='<span class="single_ability_name">'+capitalizeFirstLetter(r.name)+"</span>",s+='<span class="single_ability_description">',$.each(r.subtypes,function(e,t){e>0&&(s+=", "),s+=t.replace("_"," ")}),s+="</span>",s+='<span class="single_ability_name">'+r.type+"</span>",s+='<span class="single_ability_description">',("creature"==r.type||"structure"==r.type||"object"==r.type)&&(s+="Unit. Stays on the board until destroyed. "),"creature"==r.type&&(s+="The basic unit type."),"structure"==r.type&&(s+="Cannot be healed, but can be repaired. Is immune to being moved or poisoned and all mental abilities."),"object"==r.type&&(s+="Cannot be healed and is immune to being moved or poisoned and all mental abilities."),"artifact"==r.type&&(s+="Attaches to your hero. There is a maximum of 5 active artifacts. Stays in game untill destroyed or untill it has no active abilities."),("spell"==r.type||"attack"==r.type)&&(s+="Action card. Effects fire once. "),"token"==r.type&&(s+="Not used in battles."),"currency"==r.type&&(s+="Not used in battles."),"fragment"==r.type){s+="Not used in battles. Can be used to construct buildings in your town.<br/><br/>";var d="";$.each(all_buildings,function(t,a){a.fragment_id==e&&(d=a.description)}),s+=d}if("consumable"==r.type){s+="Use this from your inventory under rewards.<br/><br/>";var d="";void 0!=all_available_cards[e].reward&&void 0!=all_available_cards[e].reward.description&&(d=all_available_cards[e].reward.description),s+=d}"spell"==r.type&&(s+=""),"artifact"==r.type&&(s+=""),"attack"==r.type&&(s+=""),s+="</span>",s+="</div>",void 0!=r.description&&(s+='<div class="single_ability">',s+='<span class="single_ability_description">',s+=r.description,s+="</span>",s+="</div>");var l=r.abilities;void 0!=t&&!0==t&&void 0!=r.hero_version&&(l=r.hero_version.abilities),void 0!=n&&void 0!=battle_info.combat_units[n]&&(l=battle_info.combat_units[n].abilities),$.each(l,function(e,t){var a=all_abilities[e],o=t,n=0;if("object"==typeof o){var o=t.level,n=0;if("object"==typeof t){var o=t.level;void 0!=t.starting_delay&&(n=t.starting_delay-0)}}s+='<div class="single_ability">',s+='<span class="single_ability_name" style="color:'+a.name_color+'">',s+=a.name,(o>1||void 0!=a.show_amount_adjustment||void 0!=t.level_2)&&(void 0!=a.show_amount_adjustment&&(o+=a.show_amount_adjustment),s+=" "+o,void 0!=a.post_name&&(s+=a.post_name)),void 0!=t.level_2&&t.level_2>1&&(s+="/"+t.level_2),n>0&&(s+=" ("+n+")"),s+="</span>";var r="-",c=t+0;"object"==typeof t&&(c=t.level+0),void 0!=a.show_amount_adjustment&&(c+=a.show_amount_adjustment),void 0!=a.description&&(r=a.description),r=check_plural(r.split("{LEVEL}").join(c),c),r=void 0!=t.level_2?r.split("{LEVEL2}").join(t.level_2):r.split("{LEVEL2}").join("1"),s+='<span class="single_ability_description">',s+=r,void 0!=t.additional_text&&(s+=" "+t.additional_text),s+="</span>",s+="</div>"}),s+="</div>",void 0!=o&&"add_to_deck"==o&&(s+='<div class="add_card_to_deck_from_details_button" onclick="add_card_to_deck(\''+e+"', true)\">ADD TO DECK</div>"),void 0!=o&&"remove_from_deck"==o&&(s+='<div class="add_card_to_deck_from_details_button" onclick="remove_card_from_deck(\''+e+"', true)\">REMOVE FROM DECK</div>"),void 0!=o&&"set_hero"==o&&(s+='<div class="add_card_to_deck_from_details_button" onclick="set_hero(\''+e+"', true)\">SET AS HERO</div>"),setTimeout(function(){$(".detail_overlay").removeClass("hidden"),$(".detail_overlay .card_detail").html(s)},10)}else $(".detail_overlay .card_detail").html("")}function reset_filters(){$(".name_filter").val(""),$(".ability_filter").val(""),$(".min_cost_filter").val(""),$(".max_cost_filter").val(""),$(".min_value_filter").val(""),$(".max_value_filter").val(""),$(".filter_checkbox").prop("checked",!0)}function clear_filters(){$(".name_filter").val(""),$(".ability_filter").val(""),$(".min_cost_filter").val(""),$(".max_cost_filter").val(""),$(".min_value_filter").val(""),$(".max_value_filter").val(""),$(".filter_checkbox").prop("checked",!1)}var current_campaign=-1,current_chapter="";function show_campaigns(){$(".all_campaigns_container").html("");var e=0;$.each(all_campaigns,function(t,a){var o=parse_campaign(t,++e);$(".all_campaigns_container").append(o),setTimeout(function(){$(".campaign_"+t).removeClass("pre_load")},Math.random()*e*50)})}function parse_campaign(e,t){var a="",o=all_campaigns[e];a+='<div class="card pre_load campaign_'+e+'" onclick="current_campaign = '+e+", show_content('single_campaign')\">",count_object(o.color)>1?$.each(o.color,function(e,t){a+='<div class="card_color color_'+t+" color_number_"+e+'"></div>'}):a+='<div class="card_color color_'+o.color[0]+'"></div>';var n="";return void 0!=o.image_position&&(n=";background-position:"+o.image_position),a+='<div class="card_image" style="background-image:url(images/'+o.image+")"+n+'"></div>',void 0!=o.description&&(a+='<div class="card_abilities">'+o.description+"</div>"),void 0!=t&&(a+='<div class="card_power">'+t+"</div>"),a+='<div class="card_name">'+capitalizeFirstLetter(o.name)+"</div>",a+="</div>"}function parse_chapter(e,t){var a="",o=all_chapters[e],n=!0,r="";$.each(all_chapters[e].needs_cleared,function(e,t){void 0==gamedata.cleared_chapters[t]&&(n=!1,r+=capitalizeFirstLetter(all_chapters[t].name)+"<br/>")}),!1==n?(a+='<div class="card pre_load disabled chapter_'+e+'">',a+='<div class="need_to_clear">Clear to unlock:<br/>'+r+"</div>"):void 0==gamedata.cleared_chapters[e]?a+='<div class="card unlocked pre_load chapter_'+e+'" onclick="current_chapter=\''+e+"',show_chapter_details()\">":void 0==o.additional_clear_rewards?a+='<div class="card unlocked pre_load chapter_'+e+' chapter_done" onclick="current_chapter=\''+e+"',show_chapter_details()\">":a+='<div class="card unlocked pre_load chapter_'+e+'" onclick="current_chapter=\''+e+"',show_chapter_details()\">",count_object(o.color)>1?$.each(o.color,function(e,t){a+='<div class="card_color color_'+t+" color_number_"+e+'"></div>'}):a+='<div class="card_color color_'+o.color[0]+'"></div>';var s="";return void 0!=o.image_position&&(s=";background-position:"+o.image_position),a+='<div class="card_image" style="background-image:url(images/'+o.image+")"+s+'"></div>',void 0!=o.description&&(a+='<div class="card_abilities">'+o.description+"</div>"),a+='<div class="card_name">'+capitalizeFirstLetter(o.name)+"</div>",!1==n&&(a+='<div class="locked">LOCKED</div>'),void 0!=gamedata.cleared_chapters[e]&&!0==n&&(a+='<div class="cleared">CLEARED</div>'),a+="</div>"}function show_single_campaign(){$(".single_campaign_container").html("");var e=0;$.each(all_campaigns[current_campaign].chapters,function(t,a){var o=parse_chapter(a,++e);$(".single_campaign_container").append(o),setTimeout(function(){$(".chapter_"+a).removeClass("pre_load")},100*Math.random()+1)})}function show_chapter_details(){$(".detail_overlay .card_detail").html("");var e=current_chapter,t="",a=all_chapters[current_chapter];t+='<button class="start_campaign" onclick="current_chapter=\''+e+"',show_chapter_battle()\">START</button>";var o="";t+='<div class="available_cards">',t+='<div class="card">',void 0!=a.image_position&&(o=";background-position:"+a.image_position),t+='<div class="card_image" style="background-image:url(images/'+a.image+")"+o+'"></div>',t+="</div>",t+="</div>",t+='<div class="ability_details">',t+='<div class="single_ability">',t+='<div class="single_ability_name">',t+=capitalizeFirstLetter(a.name),t+="</div>",void 0!=a.description&&(t+='<div class="single_ability_description">'+a.description+"</div>"),t+="</div>",t+="</div>",void 0==gamedata.cleared_chapters[e]?(t+='<div class="reward_cards">',t+='<div class="reward_title">Rewards:</div>',$.each(a.first_clear_rewards,function(e,a){if("scraps"!=e){var o=parse_card(e,a);t+='<div class="single_reward" onclick="show_card_details(\''+e+"')\">",t+=o,t+="</div>"}else a>1?t+='<div class="single_reward"><div class="scrap_reward">'+a+" scraps</div></div>":t+='<div class="single_reward"><div class="scrap_reward">'+a+" scrap</div></div>"}),t+="</div>"):void 0!=a.additional_clear_rewards&&(t+='<div class="reward_cards">',t+='<div class="reward_title">Possible rewards:</div>',$.each(a.additional_clear_rewards,function(e,a){if("scraps"!=e){var o=parse_card(e,a);t+='<div class="single_reward" onclick="show_card_details(\''+e+"')\">",t+=o,t+="</div>"}else a>1?t+='<div class="single_reward"><div class="scrap_reward">'+a+" scraps</div></div>":t+='<div class="single_reward"><div class="scrap_reward">'+a+" scrap</div></div>"}),t+="</div>"),$(".detail_overlay .card_detail").append(t),$(".detail_overlay").removeClass("hidden")}var intro_step=0;function run_intro(e){void 0!=e||void 0==gamedata.viewed_intro?(gamedata.viewed_intro=!0,saveToLocalStorage(),$(".intro").css("display","block"),$(".intro").html(""),$(".intro").append('<div class="skip_intro_button">SKIP</div>'),$(".main_window").addClass("hidden"),intro_step=0,show_next_step()):skip_intro()}function show_next_step(){var e=intro_steps[intro_step],t=intro_step+0,a="";a+='<div class="intro_step step_'+t+'" style="',void 0!=e.text_size&&(a+="font-size:"+e.text_size+";"),void 0!=e.text_align&&(a+="text-align:"+e.text_align+";"),void 0!=e.start_location&&$.each(e.start_location,function(e,t){a+=e+":"+t+";"}),void 0!=e.image&&"none"!=e.image&&(a+="background-image:url("+e.image+");"),a+='">',void 0!=e.text&&(a+=e.text),a+="</div>",setTimeout(function(){$(".intro").append(a),setTimeout(function(){$(".step_"+t).addClass("visible"),adjust_step_position(t,e)},50),setTimeout(function(){$(".step_"+t).removeClass("visible"),$(".step_"+t).css("opacity","0")},e.time_on_screen)},e.timeout),void 0!=intro_steps[intro_step+1]?(intro_step++,show_next_step()):setTimeout(function(){skip_intro()},e.timeout+e.time_on_screen+2e3)}function adjust_step_position(e,t){$.each(t.end_location,function(t,a){$(".step_"+e).css(t,a)}),void 0!=t.opacity&&$(".step_"+e).css("opacity",t.opacity)}function skip_intro(){$(".main_window").removeClass("hidden"),$(".intro").css("display","none")}var intro_steps={0:{timeout:0,time_on_screen:2e3,text:"Long ago...",text_size:"10vw",image:"none",start_location:{left:"10%",top:"30%"},end_location:{left:"15%",top:"30%"}},1:{timeout:2500,time_on_screen:3e3,image:"images/cards/butterfly-2049567_640.jpg",opacity:.3,start_location:{right:"0%",top:"0%",left:"0%",bottom:"0%"},end_location:{right:"-5%",top:"-5%",left:"-0%",bottom:"-0%"}},2:{timeout:2500,time_on_screen:2e3,text:"There was peace in the world",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"60%",left:"-100%"},end_location:{right:"15%",top:"60%"}},3:{timeout:6500,time_on_screen:3e3,image:"images/cards/fantasy-3366526_640.jpg",opacity:.3,start_location:{right:"0%",top:"0%",left:"0%",bottom:"-120%"},end_location:{right:"-5%",top:"-0%",left:"-5%",bottom:"-140%"}},4:{timeout:6e3,time_on_screen:3e3,text:"Then man arrived",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"20%",right:"-100%"},end_location:{left:"15%",bottom:"20%"}},5:{timeout:1e4,time_on_screen:3500,image:"images/cards/confrontation-930744_640.jpg",opacity:.3,start_location:{right:"-10%",top:"-0%",left:"-0%",bottom:"-100%"},end_location:{right:"-0%",top:"-0%",left:"-10%",bottom:"-100%"}},6:{timeout:1e4,time_on_screen:2500,text:"Aggressive by nature...",text_size:"5vw",text_align:"right",image:"none",start_location:{left:"-110%",top:"20%",right:"10%"},end_location:{right:"15%",top:"20%"}},7:{timeout:13e3,time_on_screen:5500,image:"images/cards/barbarian-4616094_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-20%",left:"-10%",bottom:"-80%"},end_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-150%"}},8:{timeout:13e3,time_on_screen:2500,text:"men started fighting<br/>amongst themselves",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"15%",top:"30%",left:"-100%"},end_location:{right:"20%",top:"30%"}},9:{timeout:15e3,time_on_screen:2e3,text:"breaking apart into factions",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"20%",top:"50%",right:"-100%"},end_location:{left:"25%",top:"50%"}},10:{timeout:18e3,time_on_screen:3500,image:"images/cards/farewell-587277_1280.jpg",opacity:.3,start_location:{right:"-0%",top:"-50%",left:"-0%",bottom:"-0%"},end_location:{right:"-20%",top:"-60%",left:"-0%",bottom:"-0%"}},11:{timeout:18e3,time_on_screen:2500,text:"Some kept the old ways",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"70%",right:"-100%"},end_location:{left:"15%"}},12:{timeout:21e3,time_on_screen:3500,image:"images/cards/fantasy-2961723_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-80%"},end_location:{right:"-10%",top:"-0%",left:"-10%",bottom:"-110%"}},13:{timeout:21e3,time_on_screen:2500,text:"Some embraced nature",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},14:{timeout:24e3,time_on_screen:3500,image:"images/cards/fantasy-1390177_1280.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-0%",left:"-0%",bottom:"-90%"}},15:{timeout:24e3,time_on_screen:2500,text:"Some sought magic in the north",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},16:{timeout:27e3,time_on_screen:3500,image:"images/cards/castle-832543_640.jpg",opacity:.3,start_location:{right:"-10%",top:"-0%",left:"-10%",bottom:"-20%"},end_location:{right:"-0%",top:"-20%",left:"-0%",bottom:"-0%"}},17:{timeout:27e3,time_on_screen:2500,text:"Some found a god to worship",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},18:{timeout:3e4,time_on_screen:3500,image:"images/cards/monster-5369480_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-20%",bottom:"-200%"},end_location:{right:"-0%",top:"-0%",left:"-10%",bottom:"-150%"}},19:{timeout:3e4,time_on_screen:2500,text:"Others embraced darkness",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},20:{timeout:33e3,time_on_screen:3500,image:"images/cards/fire-2648873_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-30%",left:"-10%",bottom:"-30%"}},21:{timeout:33e3,time_on_screen:2500,text:"or just wanted the world to burn",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"10%",right:"-100%"},end_location:{left:"15%"}},22:{timeout:37e3,time_on_screen:2500,text:"After many years of war...",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},23:{timeout:39e3,time_on_screen:8e3,image:"images/cards/take-532097_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-30%",left:"-10%",bottom:"-30%"}},24:{timeout:4e4,time_on_screen:2500,text:"a hero dreamt of a book",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"10%",right:"-100%"},end_location:{left:"15%"}},25:{timeout:42e3,time_on_screen:2500,text:"that would let him bring man together",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"40%",right:"-100%"},end_location:{left:"15%"}},26:{timeout:45e3,time_on_screen:2500,text:"The question is...",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},27:{timeout:48e3,time_on_screen:4e3,text:"Will you?",text_size:"5vw",text_align:"center",image:"none",start_location:{right:"0%",top:"40%",left:"0%"},end_location:{}}},current_merchant_page=1,selling_card_id="",sell_amount=1,selling_price=1,listings_page=1,showing_mine=!1,buy_sell="buy",current_lowest_price=0,your_offer="",global_listings={},current_listing_id=!1;function show_merchant(){selling_price=1,sell_amount=1,cards_per_page=12,$("#content_merchant .tinkering_list").html('<span class="no_tinker">No cards fit your<br/>current filters.</span>'),gamedata.owned_cards=sortObj(gamedata.owned_cards),$("#content_merchant .tinkering_list").html("");var e=0;$.each(gamedata.owned_cards,function(t,a){var o=a+0;if((o>0||"buy"==buy_sell)&&!1==check_filters(t)&&void 0==all_available_cards[t].non_tradable&&++e/cards_per_page>current_merchant_page-1&&e/cards_per_page<=current_merchant_page){var n=parse_card(t,o);$("#content_merchant .tinkering_list").append('<div onclick="current_lowest_price=0;selling_price='+all_available_cards[t].value+";show_sell_card_content('"+t+"')\">"+n+"</div>")}}),1==current_merchant_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),e/cards_per_page<=current_merchant_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),Math.ceil(e/12)<current_merchant_page&&e>0&&(current_merchant_page=1,show_merchant()),0==e&&$("#content_merchant .tinkering_list").html('<span class="no_tinker">No cards fit your<br/>current filters.</span>'),0==e?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_merchant_page+" / "+Math.ceil(e/cards_per_page))}function set_merchant_page(e){(current_merchant_page+=e)<1&&(current_merchant_page=1),show_merchant()}function set_market_page(e){(listings_page+=e)<1&&(listings_page=1),!1==showing_mine?show_market():show_my_market()}function show_sell_card_content(e){selling_card_id=e,"sell"==buy_sell?show_content("sell_card"):show_content("buy_card")}function show_buy_card(){show_sell_card()}function show_sell_card(){if(""==selling_card_id||void 0==all_available_cards[selling_card_id]||gamedata.owned_cards[selling_card_id]<1&&"sell"==buy_sell||void 0!=all_available_cards[selling_card_id].non_tradable)show_content("merchant");else{sell_amount<1&&(sell_amount=1),sell_amount>gamedata.owned_cards[selling_card_id]&&"sell"==buy_sell&&(sell_amount=gamedata.owned_cards[selling_card_id]);var e=parse_card(selling_card_id,gamedata.owned_cards[selling_card_id]);"sell"==buy_sell?$(".sell_card_container").html("Selling:<br/><div onclick=\"show_card_details('"+selling_card_id+"')\""+e):$(".sell_card_container").html("Buying:<br/><div onclick=\"show_card_details('"+selling_card_id+"')\""+e),$(".sell_card_amount_container .sell_amount").html(numberWithCommas(sell_amount));var t=Math.floor(sell_amount*all_available_cards[selling_card_id].value/2);0==t?($(".merchant_offer").html("The merchant does not want this.<br/>Maybe offer more cards?"),$(".sell_to_merchant_button").addClass("hidden")):($(".sell_to_merchant_button").removeClass("hidden"),1==t?$(".merchant_offer").html("The merchant offers you 1 scrap for this."):$(".merchant_offer").html("The merchant offers you "+numberWithCommas(t)+" scraps for this.")),selling_price<all_available_cards[selling_card_id].value/2&&(selling_price=Math.floor(all_available_cards[selling_card_id].value/2)),selling_price>40*all_available_cards[selling_card_id].value&&(selling_price=Math.floor(40*all_available_cards[selling_card_id].value)),selling_price<1&&(selling_price=1),$(".price_amount").html(numberWithCommas(selling_price)),"sell"==buy_sell?get_lowest_price(selling_card_id):get_highest_price(selling_card_id)}}function adjust_sell_amount(e){sell_amount+=e,show_sell_card()}function adjust_selling_price(e){e>0&&selling_price>=20&&(e=5),e>0&&selling_price>=50&&(e=10),e>0&&selling_price>=100&&(e=20),e>0&&selling_price>=500&&(e=50),e>0&&selling_price>=1e3&&(e=100),(selling_price+=e)<1&&(selling_price=1),selling_price>1e3&&(selling_price=100*Math.floor(selling_price/100)),selling_price>500&&selling_price<1e3&&(selling_price=50*Math.floor(selling_price/50)),selling_price>100&&selling_price<500&&(selling_price=20*Math.floor(selling_price/20)),selling_price>50&&selling_price<100&&(selling_price=10*Math.floor(selling_price/10)),selling_price>20&&selling_price<50&&(selling_price=5*Math.floor(selling_price/5)),"sell"!=buy_sell&&selling_price>gamedata.scraps&&(selling_price=gamedata.scraps),show_sell_card()}function take_merchant_offer(){if(sell_amount>0&&sell_amount<=gamedata.owned_cards[selling_card_id]){var e=Math.floor(sell_amount*all_available_cards[selling_card_id].value/2);gamedata.owned_cards[selling_card_id]-=sell_amount,gain_scraps(e),show_available_cards(!1)}check_quests("sell_to_merchant"),sell_amount=1,show_content("merchant")}function place_offer(){sell_amount>0&&sell_amount<=gamedata.owned_cards[selling_card_id]?(gamedata.owned_cards[selling_card_id]-=sell_amount,saveToLocalStorage(),show_available_cards(!1),$.post("ajax.php",{data:"place_offer",current_id:gamedata.account_id,card_id:selling_card_id,card_amount:sell_amount,price:selling_price},function(e){console.log(e),show_content("merchant")})):(sell_amount=1,show_content("merchant"))}function place_buy_offer(){sell_amount>0&&gamedata.scraps>=selling_price*sell_amount?(gamedata.scraps-=selling_price*sell_amount,saveToLocalStorage(),show_available_cards(!1),$.post("ajax.php",{data:"place_buy_offer",current_id:gamedata.account_id,card_id:selling_card_id,card_amount:sell_amount,price:selling_price},function(e){console.log(e),show_content("merchant")})):(sell_amount=1,show_content("merchant"))}function show_market(){$(".market_list").html(""),showing_mine=!1,"buy"==buy_sell?($(".market_view_slider").addClass("buying"),$(".select_buy").addClass("active"),$(".select_sell").removeClass("active"),$.post("ajax.php",{data:"get_market",current_id:gamedata.account_id},function(e){parse_current_market(JSON.parse(e))})):($(".market_view_slider").removeClass("buying"),$(".select_sell").addClass("active"),$(".select_buy").removeClass("active"),showing_mine=!1,$.post("ajax.php",{data:"get_market_offers",current_id:gamedata.account_id},function(e){parse_current_market(JSON.parse(e))}))}function show_my_market(){$(".market_list").html(""),showing_mine=!0,"buy"==buy_sell?($(".market_view_slider").addClass("buying"),$(".select_buy").addClass("active"),$(".select_sell").removeClass("active")):($(".market_view_slider").removeClass("buying"),$(".select_sell").addClass("active"),$(".select_buy").removeClass("active")),$.post("ajax.php",{data:"get_your_market",current_id:gamedata.account_id},function(e){parse_current_market(JSON.parse(e),!0)})}function get_lowest_price(e){0==current_lowest_price?($(".current_market_price").html(""),$.post("ajax.php",{data:"get_lowest_price",card_id:e},function(e){var t=JSON.parse(e);your_offer="",count_object(t)>0&&void 0!=t.user_id&&t.user_id==gamedata.account_id&&(your_offer=" (yours)"),null!=t&&void 0!=t.price?(current_lowest_price=t.price,$(".current_market_price").html("Lowest price on the market for this is "+numberWithCommas(t.price)+" each"+your_offer)):(current_lowest_price=null,$(".current_market_price").html("There are no offers for this on the market"))})):null!=current_lowest_price&&void 0!=current_lowest_price?$(".current_market_price").html("Lowest price on the market for this is "+numberWithCommas(current_lowest_price)+" each"+your_offer):$(".current_market_price").html("There are no offers for this on the market")}function get_highest_price(e){0==current_lowest_price?($(".current_market_price").html(""),$.post("ajax.php",{data:"get_highest_price",card_id:e},function(e){var t=JSON.parse(e);your_offer="",count_object(t)>0&&void 0!=t.user_id&&t.user_id==gamedata.account_id&&(your_offer=" (yours)"),null!=t&&void 0!=t.price?(current_lowest_price=t.price,$(".current_market_price").html("Highest price on the market for this is "+numberWithCommas(t.price)+" each"+your_offer)):(current_lowest_price=null,$(".current_market_price").html("There are no requests for this on the market"))})):null!=current_lowest_price&&void 0!=current_lowest_price?$(".current_market_price").html("Highest price on the market for this is "+numberWithCommas(current_lowest_price)+" each"+your_offer):$(".current_market_price").html("There are no requests for this on the market")}function buy_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"buy_listing",listing_id:e},function(e){complete_buy_listing(JSON.parse(e))})}function sell_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"sell_listing",listing_id:e},function(e){complete_sell_listing(JSON.parse(e))})}function complete_buy_listing(e){check_quests("complete_buy_listing"),gamedata.scraps-=e.price,gain_card(e.card_id),show_market()}function complete_sell_listing(e){check_quests("complete_sell_listing"),gamedata.owned_cards[e.card_id]-=1,gamedata.scraps+=parseInt(e.price),saveToLocalStorage(),show_market()}function cancel_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"claim_listing",listing_id:e},function(t){var a=JSON.parse(t);$.post("ajax.php",{data:"delete_listing",listing_id:e},function(e){complete_cancel_listing(a)})})}function cancel_buy_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"claim_listing",listing_id:e},function(t){var a=JSON.parse(t);$.post("ajax.php",{data:"delete_listing",listing_id:e},function(e){complete_cancel_buy_listing(a)})})}function complete_cancel_listing(e){for(var t=e.card_amount-e.sold,a=t-1;a>=0;a--)gain_card(e.card_id);show_card_details(e.card_id,void 0,t),!1==showing_mine?show_market():show_my_market()}function complete_cancel_buy_listing(e){var t=e.card_amount-e.sold;gain_scraps(e.price*t),!1==showing_mine?show_market():show_my_market()}function claim_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"claim_listing",listing_id:e},function(e){complete_claim_listing(JSON.parse(e))})}function claim_buy_listing(e){$(".market_list").html(""),$.post("ajax.php",{data:"claim_listing",listing_id:e},function(e){complete_claim_buy_listing(JSON.parse(e))})}function complete_claim_listing(e){gain_scraps(e.price*e.sold),!1==showing_mine?show_market():show_my_market()}function complete_claim_buy_listing(e){for(var t=e.sold-1;t>=0;t--)gain_card(e.card_id);show_card_details(e.card_id,void 0,e.sold),!1==showing_mine?show_market():show_my_market()}function parse_current_market(e,t){$("#content_market .page_selection").addClass("hidden"),$("#content_my_market .page_selection").addClass("hidden"),!1==current_listing_id?($("#content_market .menu_button").removeClass("hidden"),$("#content_market .market_view").removeClass("hidden"),$("#content_market .select_filters").removeClass("hidden"),$(".market_list").removeClass("showing_single")):($("#content_market .menu_button").addClass("hidden"),$("#content_market .market_view").addClass("hidden"),$("#content_market .select_filters").addClass("hidden"),$(".market_list").addClass("showing_single")),1==gamedata.scraps?$(".scrap_count").html(gamedata.scraps+" scrap"):$(".scrap_count").html(gamedata.scraps+" scraps"),$(".market_list").html("");var a="";!1==current_listing_id&&(global_listings=e),$(".market_list").append(a);var o=0;if($.each(e,function(e,a){if((!1==current_listing_id||current_listing_id==a.id)&&void 0!=all_available_cards[a.card_id]&&!1==check_filters(a.card_id)&&(a.card_amount-a.sold>0||!0==t)&&(!0!=t||a.user_id==gamedata.account_id&&!0==t)&&(++o<=6*listings_page&&o>(listings_page-1)*6||!1!=current_listing_id)){var n="",r=parse_card(a.card_id),s=0;void 0!=gamedata.owned_cards[a.card_id]&&gamedata.owned_cards[a.card_id]>0&&(s=gamedata.owned_cards[a.card_id]),n+='<div class="single_market_card"><div onclick="show_card_details(\''+a.card_id+"')\">"+r+"</div>",a.user_id!=gamedata.account_id&&a.card_amount-a.sold>0&&("sell"==a.buy_sell&&(n+='<div class="market_description"><span class="selling">In stock: '+(a.card_amount-a.sold)+"</span><br/>Price: "+numberWithCommas(a.price)+"<br/>Owned: "+s+"</div>",gamedata.scraps>=a.price&&(!1==current_listing_id?n+='<div class="market_buy_button" onclick="current_listing_id='+a.id+';parse_current_market(global_listings)">VIEW</div>':n+='<div class="market_buy_button" onclick="buy_listing('+a.id+')">BUY</div>'),!1!=current_listing_id&&(n+='<div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>')),"buy"==a.buy_sell&&(n+='<div class="market_description"><span class="buying">Requested: '+(a.card_amount-a.sold)+"</span><br/>Pays: "+numberWithCommas(a.price)+"<br/>Owned: "+s+"</div>",s>=1&&(!1==current_listing_id?n+='<div class="market_sell_button" onclick="current_listing_id='+a.id+';parse_current_market(global_listings)">VIEW</div>':n+='<div class="market_sell_button" onclick="sell_listing('+a.id+')">SELL</div>'),!1!=current_listing_id&&(n+='<div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>'))),a.user_id==gamedata.account_id&&("sell"==a.buy_sell&&(n+='<div class="market_description"><span class="selling">SELLING</span><br/>Price: '+numberWithCommas(a.price),a.sold>0?n+="<br/>Sold: "+a.sold:n+="<br/>Offering: "+a.card_amount,n+="</div>",a.sold>0?n+='<div class="market_buy_button" onclick="claim_listing('+a.id+')">CLAIM</div>':n+='<div class="market_cancel_button" onclick="cancel_listing('+a.id+')">CANCEL</div>'),"buy"==a.buy_sell&&(n+='<div class="market_description"><span class="buying">BUYING</span><br/>Price: '+numberWithCommas(a.price),a.sold>0?n+="<br/>Bought: "+a.sold:n+="<br/>Requesting: "+a.card_amount,n+="</div>",a.sold>0?n+='<div class="market_buy_button" onclick="claim_buy_listing('+a.id+')">CLAIM</div>':n+='<div class="market_cancel_button" onclick="cancel_buy_listing('+a.id+')">CANCEL</div>')),n+="</div>",$(".market_list").append(n)}}),0==o){var a='<div class="listing no_hover"><span class="no_results">No results found</span>';!1!=current_listing_id&&(a+='<br/><br/><div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>'),a+="</div>",$(".market_list").append(a)}o>1&&($("#content_market .page_selection").removeClass("hidden"),$("#content_my_market .page_selection").removeClass("hidden"),1==listings_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),o/6<=listings_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),Math.ceil(o/6)<listings_page&&(listings_page=1,!1==showing_mine?parse_current_market(e):parse_current_market(e,!0)),$(".page_selection .page_number").html(listings_page+" / "+Math.ceil(o/6)))}function check_filters(e,t){var a={};a.ability="",""!=$(".ability_filter").val()&&(a.ability=$(".ability_filter").val()),a.name="",""!=$(".name_filter").val()&&(a.name=$(".name_filter").val()),""!=$(".min_cost_filter").val()&&(a.min_cost=parseInt($(".min_cost_filter").val())),""!=$(".max_cost_filter").val()&&(a.max_cost=parseInt($(".max_cost_filter").val())),""!=$(".min_value_filter").val()&&(a.min_value=parseInt($(".min_value_filter").val())),""!=$(".max_value_filter").val()&&(a.max_value=parseInt($(".max_value_filter").val()));var o=!1;if(""!=a.name){var n=!1;-1!=all_available_cards[e].name.indexOf(a.name)&&(n=!0),$.each(all_available_cards[e].subtypes,function(e,t){-1!=t.indexOf(a.name)&&(n=!0)}),!1==n&&(o=!0)}if(""!=a.ability){var r=!1,s=all_available_cards[e].abilities;void 0!=t&&!0==t&&void 0!=all_available_cards[e].hero_version&&void 0!=all_available_cards[e].hero_version.abilities&&(s=all_available_cards[e].hero_version.abilities),$.each(s,function(e,t){if("object"==typeof t)var o=all_abilities[e].name+" "+t.level;else if(void 0!=all_abilities[e])var o=all_abilities[e].name+" "+t;else{var o="";console.log(e)}-1!=o.indexOf(a.ability)&&(r=!0),-1!=all_abilities[e].description.indexOf(a.ability)&&(r=!0)}),!1==r&&(o=!0)}return void 0!=a.min_cost&&all_available_cards[e].time<a.min_cost&&(o=!0),void 0!=a.max_cost&&all_available_cards[e].time>a.max_cost&&(o=!0),void 0!=a.min_value&&all_available_cards[e].value<a.min_value&&(o=!0),void 0!=a.max_value&&all_available_cards[e].value>a.max_value&&(o=!0),!1==$("."+all_available_cards[e].type+"_type_filter").prop("checked")&&(o=!0),void 0!=namechanges[e]&&(o=!0),$.each(all_available_cards[e].color,function(e,t){void 0!=t&&!1==$("."+t+"_color_filter").prop("checked")&&(o=!0)}),o}function toggle_market_view_mode(){buy_sell="sell"==buy_sell?"buy":"sell",show_market()}function toggle_my_market_view_mode(){buy_sell="sell"==buy_sell?"buy":"sell",show_my_market()}var current_tinker_page=1,current_tinker="",min_tinker=0;function show_tinker(){void 0==gamedata.known_recipes&&(gamedata.known_recipes={},saveToLocalStorage()),$(".tinkering_container").html('<span class="no_tinker">You need 5 identical cards and an unknown recipe that can be crafted with that card to be able to tinker</span>'),$(".tinker_min_amount").html("OWNED: "+min_tinker);var e="",t=0;$.each(gamedata.owned_cards,function(a,o){if(o>=min_tinker&&!1==check_filters(a)){var n=0;if($.each(all_available_cards,function(e,t){if(void 0==gamedata.known_recipes[e]&&void 0!=t.recipe&&void 0!=t.recipe[a]){var o=!0;$.each(t.recipe,function(e,t){void 0==gamedata.known_recipes[e]&&void 0!=all_available_cards[e].recipe&&(o=!1)}),!0==o&&n++}}),n>0&&++t>12*current_tinker_page-12&&t<=12*current_tinker_page){var r=parse_card(a,o+" ("+n+")");o>4?e+="<div onclick=\"current_tinker='"+a+"';show_content('single_tinker')\">"+r+"</div>":e+='<div class="faded" onclick="current_tinker=\''+a+"';show_content('single_tinker')\">"+r+"</div>"}}}),t>12?($("#content_tinker .page_selection").show(),1==current_tinker_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/12<=current_tinker_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),0==t?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_tinker_page+" / "+Math.ceil(t/12))):$("#content_tinker .page_selection").hide(),t>0&&Math.ceil(t/12)<current_tinker_page?(current_tinker_page=1,show_tinker()):""!=e&&$(".tinkering_container").html('<div class="tinkering_list">'+e+"</div>")}function toggle_min_tinker(){var e=min_tinker+0;0==e&&(min_tinker=1),1==e&&(min_tinker=5),5==e&&(min_tinker=10),10==e&&(min_tinker=0)}function show_single_tinker(){var e=get_possible_tinker_results(current_tinker);if(void 0==all_available_cards[current_tinker]||1>count_object(e))show_content("tinker");else{var t=all_available_cards[current_tinker];$(".single_tinker_name").html(capitalizeFirstLetter(t.name)),$(".single_tinker_container").html("");var a=0;void 0!=gamedata.owned_cards[current_tinker]&&(a=gamedata.owned_cards[current_tinker]);var o=parse_card(current_tinker,a);if($(".single_tinker_container").append('<div class="tinker_card_container">'+o+"</div>"),a>=0){a>4?($(".single_tinker_container").append('<div class="tinker_confirmation_description">Use 5 of these cards<br/>to find a new recipe?</div>'),$(".single_tinker_container").append('<div class="tinker_confirmation_button" onclick="tinker_current()">TINKER</div>')):$(".single_tinker_container").append('<div class="tinker_confirmation_description">You need 5 of these cards<br/>to find a new recipe.</div>');var n="",r=0;$.each(e,function(e,t){r<12&&(n+="<div onclick=\"show_card_details('"+e+"')\">"+parse_card(e)+"</div>"),r++}),$(".single_tinker_container").append('<div class="craftable_with_this"><span class="craftable_with_this_title">Based on what you have discovered so far, you can discover the following recipes:</span><br/>'+n+"</div>")}}}function set_tinker_page(e){(current_tinker_page+=e)<1&&(current_tinker_page=1),show_tinker()}function tinker_current(){var e=0;if(void 0!=gamedata.owned_cards[current_tinker]&&(e=gamedata.owned_cards[current_tinker]),void 0==all_available_cards[current_tinker]||e<5)show_content("tinker");else{all_available_cards[current_tinker],$(".tinker_confirmation_description").remove(),$(".tinker_confirmation_button").remove(),$(".single_tinker_container .craftable_with_this").remove(),setTimeout(function(){$(".tinker_card_container").html("")},500),$(".tinker_card_container").css("left","350px");for(var t=get_possible_tinker_results(current_tinker),a=!1,o=500,n=1;n<=14;n++){var r="";(count_object(t)>1||Math.ceil(n/2)==n/2)&&(a=get_random_key_from_object(t),r=parse_card(a));var s=o+50*n*3,c=!0;14==n&&(c=!1),show_tinker_temp_result(r,n,o,c,s),o+=50*n}o+=1e3,!1!=a&&(gamedata.owned_cards[current_tinker]-=5,gamedata.known_recipes[a]=!0,show_available_cards(!1),gain_card(a),saveToLocalStorage(),setTimeout(function(){show_card_details(a),show_single_tinker()},o))}}function show_tinker_temp_result(e,t,a,o,n){setTimeout(function(){$(".tinker_card_container").append('<div class="possible_new_recipe card_to_show_id_'+t+'">'+e+"</div>")},a),!0==o&&setTimeout(function(){$(".card_to_show_id_"+t).addClass("faded_out")},n)}function get_possible_tinker_results(e){var t={};return $.each(all_available_cards,function(a,o){if(void 0==gamedata.known_recipes[a]&&void 0!=o.recipe&&void 0!=o.recipe[e]){var n=!0;$.each(o.recipe,function(e,t){void 0==gamedata.known_recipes[e]&&void 0!=all_available_cards[e].recipe&&(n=!1)}),!0==n&&(t[a]=!0)}}),t}function tinker_card(e){if(gamedata.owned_cards[e]>4){var t={};if($.each(all_available_cards,function(a,o){if(void 0==gamedata.known_recipes[a]&&void 0!=o.recipe&&void 0!=o.recipe[e]){var n=!0;$.each(o.recipe,function(e,t){void 0==gamedata.known_recipes[e]&&void 0==all_available_cards[e].basic_reward&&(n=!1)}),!0==n&&(t[a]=!0)}}),count_object(t)>0){var a=get_random_key_from_object(t);gamedata.owned_cards[e]-=5,gamedata.known_recipes[a]=!0,show_card_details(a),show_available_cards(!1),saveToLocalStorage(),show_tinker()}}}var current_crafting_page=1,current_craft="",view_tinkerable=!1,cards_per_crafting_page=12;function show_craft(){void 0==gamedata.known_recipes&&(gamedata.known_recipes={},saveToLocalStorage()),$(".tinker_view").show(),gamedata.known_recipes=sortObj(gamedata.known_recipes),$(".craft_container").html('<span class="no_tinker">Use tinkering to find recipes</span>'),$(".carft_back_button").hide(),$(".craft_home_button").show(),$(".craft_button").hide();var e="",t=0;$.each(gamedata.known_recipes,function(a,o){var n=!1;if(void 0==all_available_cards[a].recipe&&(n=!0),!1==n&&!1==check_filters(a)){var r=!0;$.each(all_available_cards[a].recipe,function(e,t){(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<t)&&(r=!1)});var s=0;if($.each(all_available_cards,function(e,t){if(void 0==gamedata.known_recipes[e]&&void 0!=t.recipe&&"object"==typeof t.recipe&&void 0!=t.recipe[a]){var o=!0;$.each(t.recipe,function(e,t){void 0==gamedata.known_recipes[e]&&void 0!=all_available_cards[e].recipe&&void 0==all_available_cards[e].basic_reward&&(o=!1)}),!0==o&&s++}}),(s>0||!1==view_tinkerable)&&++t>current_crafting_page*cards_per_crafting_page-cards_per_crafting_page&&t<=current_crafting_page*cards_per_crafting_page){var c=0;void 0!=gamedata.owned_cards[a]&&gamedata.owned_cards[a]>0&&(c=gamedata.owned_cards[a]);var d=parse_card(a,c);e+='<span class="can_craft_'+r+'" onclick="show_card_recipe(\''+a+"')\">"+d+"</span>"}}}),t>cards_per_crafting_page?($("#content_craft .page_selection").show(),1==current_crafting_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/cards_per_crafting_page<=current_crafting_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),0==t?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_crafting_page+" / "+Math.ceil(t/cards_per_crafting_page))):$("#content_craft .page_selection").hide(),t>0&&Math.ceil(t/cards_per_crafting_page)<current_crafting_page?(current_crafting_page=1,show_craft()):""!=e&&$(".craft_container").html('<div class="tinkering_list">'+e+"</div>")}function set_crafting_page(e){(current_crafting_page+=e)<1&&(current_crafting_page=1),show_craft()}function show_card_recipe(e){$(".craft_container").html(""),$(".tinker_view").hide(),$("#content_craft .page_selection").hide(),gamedata.known_recipes=sortObj(gamedata.known_recipes),current_craft=e;var t="",a=!0,o=count_object(all_available_cards[e].recipe);$(".craft_container").removeClass("cost_1"),$(".craft_container").removeClass("cost_2"),$(".craft_container").removeClass("cost_3"),$(".craft_container").removeClass("cost_4"),$(".craft_container").addClass("cost_"+o);var n=!0;$.each(all_available_cards[e].recipe,function(e,o){"peasant"!=e&&(n=!1);var r="";if(r+='<div class="single_cost_container">',void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<o){a=!1;var s=gamedata.owned_cards[e];void 0==s&&(s=0),r+='<div class="craft_not_enough"  onclick="show_card_details(\''+e+"')\">"+parse_card(e,'<span style="color:rgba(255,0,0,1)">'+s+"</span>/"+o)+"</div>"}else r+='<div class=""  onclick="show_card_details(\''+e+"')\">"+parse_card(e,gamedata.owned_cards[e]+"/"+o)+"</div>";void 0!=gamedata.known_recipes[e]&&void 0!=all_available_cards[e].recipe&&(r+='<div class="menu_button slim recipe_button" no-new-page="true" onclick="show_card_recipe(\''+e+"')\">RECIPE</div>"),r+="</div>",t+=r}),t+="<br/>";var r=gamedata.owned_cards[e];void 0==r&&(r=0),t+='<div class="recipe_result active" onclick="show_card_details(\''+e+"')\">"+parse_card(e,r)+"</div>",void 0!=all_available_cards[e].hero_version&&(t+='<div class="recipe_hero_result" onclick="show_card_details(\''+e+"', true)\">"+parse_card(e,r,!0)+"</div>",t+='<div class="swap_hero_button" onclick="swap_hero_preview()">SWAP CARDS</div>'),t+="<br/>",!0==a?t+='<div class="menu_button slim craft_button" onclick="craft_current_card()" no-new-page="true">CRAFT</div><br/>':t+='<div class="menu_button slim craft_button not_enough" no-new-page="true">CRAFT</div><br/>',!1==n&&get_upgrade_factor("quick_craft","any",!0)>1&&(gamedata.owned_cards.peasant>=all_available_cards[e].value?t+='<br/><div class="menu_button slim craft_button" onclick="quick_craft_current_card()" no-new-page="true">QUICK CRAFT<br/><span>('+nFormatter(gamedata.owned_cards.peasant,3)+" / "+all_available_cards[e].value+" peasants)</span></div>":t+='<br/><div class="menu_button slim craft_button" no-new-page="true">QUICK CRAFT<br/><span class="button_subtext not_enough">('+nFormatter(gamedata.owned_cards.peasant,3)+" / "+all_available_cards[e].value+" peasants)</span></div>");var s=0,c=0;$.each(all_available_cards,function(t,a){if(void 0==gamedata.known_recipes[t]&&void 0!=a.recipe&&"object"==typeof a.recipe&&void 0!=a.recipe[e]){var o=!0;$.each(a.recipe,function(e,t){void 0==gamedata.known_recipes[e]&&void 0!=all_available_cards[e].recipe&&(o=!1)}),!0==o&&s++,c++}});var d=0,l="";$.each(gamedata.known_recipes,function(t,a){if(void 0!=all_available_cards[t].recipe&&void 0!=all_available_cards[t].recipe[e]&&++d<900){var o=parse_card(t);l+="<span onclick=\"show_card_recipe('"+t+"')\">"+o+"</span>"}}),d>0&&(t+='<div class="craftable_with_this">',d>800?t+='<div class="craftable_with_this_title">This card can be used to craft these and '+(d-8)+" more:</div>":t+='<div class="craftable_with_this_title">This card can be used to craft:</div>',t+=l,t+="</div>"),$(".craft_container").html(t),$(".carft_back_button").show(),$(".craft_home_button").hide(),void 0==all_available_cards[e].recipe&&show_content("craft")}function swap_hero_preview(){$(".recipe_result").hasClass("active")?($(".recipe_result").removeClass("active"),$(".recipe_hero_result").addClass("active")):($(".recipe_result").addClass("active"),$(".recipe_hero_result").removeClass("active"))}function craft_current_card(){var e=current_craft;if(void 0!=all_available_cards[e]){var t=!0;$.each(all_available_cards[e].recipe,function(e,a){(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<a)&&(t=!1)}),!0==t&&($.each(all_available_cards[e].recipe,function(e,t){gamedata.owned_cards[e]-=t}),gain_card(e),check_quests("craft_card_of_value",all_available_cards[e].value),show_available_cards(!1),saveToLocalStorage()),show_card_recipe(e)}}function quick_craft_current_card(){var e=current_craft;gamedata.owned_cards.peasant>=all_available_cards[e].value&&(gamedata.owned_cards.peasant-=all_available_cards[e].value,gain_card(e),check_quests("craft_card_of_value",all_available_cards[e].value),show_available_cards(!1),saveToLocalStorage(),show_card_recipe(e))}function toggle_tinker_view_mode(){$(".tinker_view div").removeClass("active"),!0==view_tinkerable?($(".tinker_view .tinker_view_slider").addClass("viewing"),$(".tinker_view .select_all").addClass("active"),view_tinkerable=!1):($(".tinker_view .tinker_view_slider").removeClass("viewing"),$(".tinker_view .select_tinkerable").addClass("active"),view_tinkerable=!0),show_craft()}var current_scrap_page=1,current_shop_type="",scrap_card_amount=1;function show_scrap(){void 0==gamedata.scraps&&(gamedata.scraps=0,saveToLocalStorage()),$(".scrap_count").html("Scrap: "+gamedata.scraps),$(".scrap_container").html('<span class="no_tinker">You need '+(scrap_card_amount+6)+" or more identical cards to scrap them</span>");var e="",t=0;$.each(gamedata.owned_cards,function(a,o){if(o>=scrap_card_amount+6&&("creature"==all_available_cards[a].type||"structure"==all_available_cards[a].type||"spell"==all_available_cards[a].type||"object"==all_available_cards[a].type||"artifact"==all_available_cards[a].type)&&++t>12*current_scrap_page-12&&t<=12*current_scrap_page){var n=parse_card(a,o,!1);e+='<div class="scrap_this_card_container" onclick="scrap_card(\''+a+"')\">"+n+"</div>"}}),t>12?($("#content_scrap .page_selection").show(),1==current_scrap_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/12<=current_scrap_page?$(".page_selection .next_page").addClass("no_page",0):$(".page_selection .next_page").removeClass("no_page"),$(".page_selection .page_number").html(current_scrap_page+" / "+Math.ceil(t/12))):$("#content_scrap .page_selection").hide(),t>0&&Math.ceil(t/12)<current_scrap_page?(current_scrap_page=1,show_scrap()):(""!=e&&$(".scrap_container").html('<div class="tinkering_list">'+e+"</div>"),t>1?$(".scrap_all_container").show():$(".scrap_all_container").hide())}function set_scrap_page(e){(current_scrap_page+=e)<1&&(current_scrap_page=1),show_scrap()}function scrap_all(){all_current_rewards={};var e=0;$.each(gamedata.owned_cards,function(t,a){("creature"==all_available_cards[t].type||"structure"==all_available_cards[t].type||"spell"==all_available_cards[t].type||"object"==all_available_cards[t].type||"artifact"==all_available_cards[t].type)&&(e+=scrap_card(t,!0))}),current_reward_text=check_plural("You scrapped "+e+" card(s)",e),current_reward_origin="scrap",show_available_cards(!1)}function scrap_card(e,t){var a=0;if(gamedata.owned_cards[e]>=scrap_card_amount+6){(void 0==t||!1==t)&&(all_current_rewards={},current_reward_origin="scrap"),a=gamedata.owned_cards[e]-6,gamedata.owned_cards[e]-=a;var o=all_available_cards[e].value*a/2,n=round_by_percent(Math.random()*o+o);all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:n,pickable:!1},check_quests("scrap_cards",void 0,void 0,void 0,void 0,all_available_cards[e].value,a),saveToLocalStorage(),(void 0==t||!1==t)&&(current_reward_text=check_plural("You scrapped '"+capitalizeFirstLetter(all_available_cards[e].name)+"' "+a+" time(s)",a),show_available_cards(!1),show_content("current_rewards"))}return a}function gain_scraps(e){gamedata.scraps=parseInt(gamedata.scraps)+parseInt(e),e>1?$(".detail_overlay  .card_detail").html('<div class="big_text">You gained:<br/>'+e+" scraps</div>"):$(".detail_overlay  .card_detail").html('<div class="big_text">You gained:<br/>'+e+" scrap</div>"),e>0&&check_quests("gained_scraps",void 0,void 0,void 0,void 0,void 0,e),check_quests("scraps_owned",void 0,void 0,void 0,void 0,gamedata.scraps),$(".detail_overlay").removeClass("hidden"),saveToLocalStorage()}function show_arena_shop(){show_scrap_shop("arena")}function show_raid_shop(){show_scrap_shop("raid")}function show_card_shop(){show_scrap_shop("shop")}function show_scrap_shop(e){void 0==gamedata.scraps&&(gamedata.scraps=0,saveToLocalStorage()),void 0==e&&(e="scrap"),current_shop_type=e+"",$(".scrap_count").html("Scrap: "+gamedata.scraps);var t=new Date().getMonth()+1;$(".scrap_shop_content").html(""),$.each(all_offers,function(a,o){if((void 0==o.months_available||!0==match_array_values([t],o.months_available))&&(void 0==e||o.shop_type==e)){void 0==gamedata.owned_cards[o.result]&&(gamedata.owned_cards[o.result]=0);var n="",r=parse_card(o.result,gamedata.owned_cards[o.result]),s=!0;n+='<div class="single_building_recipe">',n+='<div class="single_building_recipe_costs">',$.each(o.costs,function(e,t){if(void 0!=all_available_cards[e]){var a=0;if(void 0!=gamedata.owned_cards[e]&&(a=gamedata.owned_cards[e]),a<t){s=!1;var o=parse_card(e,'<span style="color:red">'+numberWithCommas(a)+" / "+t+"</span>")}else var o=parse_card(e,numberWithCommas(a)+" / "+t);n+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+e+"')\">"+o+"</div>"}"scraps"==e&&(gamedata.scraps<t?(s=!1,n+='<div class="single_building_recipe_cost">'+parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+t+"</span>")+"</div>"):n+='<div class="single_building_recipe_cost">'+parse_card("scraps_placeholder",numberWithCommas(gamedata.scraps)+" / "+t)+"</div>")}),n+="</div>",void 0!=o.text&&(n+='<div class="single_building_recipe_text">'+o.text+"</div>"),n+='<div class="single_building_recipe_result" onclick="show_card_details(\''+o.result+"')\">"+r+"</div>",!0==s&&(n+='<div class="single_building_recipe_craft_button" onclick="buy_offer(\''+a+"')\">BUY</div>"),n+='<div style="clear:both"></div>',n+="</div>",$(".scrap_shop_content").append(n)}})}function buy_offer(e){if(void 0!=all_available_cards[all_offers[e].result]){var t=!0;if($.each(all_offers[e].costs,function(e,a){void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<a)&&(t=!1),"scraps"==e&&gamedata.scraps<a&&(t=!1)}),!0==t){for($.each(all_offers[e].costs,function(e,t){void 0!=all_available_cards[e]&&(gamedata.owned_cards[e]-=t),"scraps"==e&&(gamedata.scraps-=t)}),i=0;i<all_offers[e].amount;i++)gain_card(all_offers[e].result);show_available_cards(!1),saveToLocalStorage()}show_scrap_shop(current_shop_type)}}function use_scraps(e){if("all"==e&&(e=gamedata.scraps),"half"==e&&(e=Math.floor(gamedata.scraps/2)),gamedata.scraps>=e){gamedata.scraps-=e,show_scrap_shop(),saveToLocalStorage(),current_rewards={};for(var t=0;t<3;t++){var a=get_basic_reward_card(current_rewards),o=round_by_percent(Math.random()*e*.2+e/10);current_rewards[t]={card_id:a,card_amount:o}}var n='<div class="reward_cards big_rewards"><span class="reward_title">Choose one reward</span><br/>';$.each(current_rewards,function(e,t){n+='<div onclick="gain_reward('+e+')">'+parse_card(t.card_id,t.card_amount)+"</div>"}),n+="</div>",$(".detail_overlay  .card_detail").html(n),$(".detail_overlay").removeClass("hidden"),$(".detail_overlay").addClass("non_clickable")}}function buy_random_card(e){if(gamedata.scraps<e)show_content("scrap_shop");else{var t=get_random_card_based_on_value(2);!1!=t&&(gamedata.scraps-=e,gain_card(t),show_card_details(t),show_content("scrap_shop"))}}var shown_achievement_options={all:!0,busy:!0,complete:!0,done:!0},logged_achieve=0;function toggle_shown_achievements(){var e="",t=!1;$.each(shown_achievement_options,function(a,o){""==e&&(e=a+""),!0==t&&(e=a+"",t=!1),a==gamedata.shown_achievements&&(t=!0)}),gamedata.shown_achievements=e,show_achievements()}function show_quests(){check_new_quests();var e=0;$(".current_quest_container").html(""),$.each(gamedata.quests,function(t,a){if(void 0==all_quests[a.quest_id])console.log("unknown quest: "+t),check_new_quests();else{e++;var o=all_quests[a.quest_id],n="";a.progress>=a.amount&&(n="complete");var r='<div class="single_quest '+n+'">';if(void 0==a.completed||!1==a.completed){if(void 0!=o.image){var s="";void 0!=o.image_position&&(s="background-position:"+o.image_position+";"),r+='<div class="background" style="'+s+"background-image:url(images/"+o.image+')"></div>'}r+='<div class="progress_bar" style="width:'+(100-a.progress/a.amount*100)+'%"></div>',r+='<div class="single_quest_name">'+capitalizeFirstLetter(o.name)+"</div>",r+='<div class="single_quest_description">',"complete"!=n?(r+=check_plural(o.description.split("{AMOUNT}").join(a.amount),a.amount)+"<br/>",r+="Progress: "+a.progress):r+='<div class="claim_quest_button" onclick="claim_quest('+t+')">CLAIM REWARD</div>',r+="</div>",r+='<div class="single_quest_reward_title">Reward:</div>',r+='<div class="single_quest_reward_container">',$.each(a.rewards,function(e,t){var a=t;"scraps"==e&&(1==a?r+='<div class="single_quest_reward">'+a+" scrap</div>":r+='<div class="single_quest_reward">'+a+" scraps</div>"),"reputation"==e&&(r+='<div class="single_quest_reward">'+a+" reputation</div>"),void 0!=all_available_cards[e]&&(1==a?r+='<div class="single_quest_reward">'+capitalizeFirstLetter(all_available_cards[e].name)+"</div>":r+='<div class="single_quest_reward">'+a+" x "+all_available_cards[e].name+"</div>")}),r+="</div>"}r+="</div>",$(".current_quest_container").append(r)}}),e<6&&count_object(all_quests)>5&&show_quests()}function show_daily_quests(){check_new_quests();var e=new Date,t=new Date,a=new Date;t.setHours(0,0,0,0),a.setHours(24,0,0,0),$(".current_daily_quest_container").html(""),$.each(gamedata.daily_quests,function(e,t){void 0==all_quests[t.quest_id]&&(console.log("unknown daily quest: "+e),check_new_quests());var a=all_quests[t.quest_id],o="",n="";t.progress>=t.amount&&(o="complete"),!1!=t.completed&&(n="claimed");var r='<div class="single_quest '+o+" "+n+'">';if(void 0!=a.image){var s="";void 0!=a.image_position&&(s="background-position:"+a.image_position+";"),r+='<div class="background" style="'+s+"background-image:url(images/"+a.image+')"></div>'}r+='<div class="progress_bar" style="width:'+(100-t.progress/t.amount*100)+'%"></div>',r+='<div class="single_quest_name">'+capitalizeFirstLetter(a.name)+"</div>",r+='<div class="single_quest_description">',"complete"!=o?(r+=check_plural(a.description.split("{AMOUNT}").join(t.amount),t.amount)+"<br/>",r+="Progress: "+t.progress):!1==t.completed?r+='<div class="claim_quest_button" onclick="claim_daily_quest('+e+')">CLAIM<br/>REWARD</div>':(r+=check_plural(a.description.split("{AMOUNT}").join(t.amount),t.amount)+"<br/>",r+='<span class="claimed_text">CLAIMED</span>'),r+="</div>",r+='<div class="single_quest_reward_title">Reward:</div>',r+='<div class="single_quest_reward_container">',$.each(a.rewards,function(e,a){if(a*=get_upgrade_factor("summon_reward","any",!0),"scraps"==e){var o=Math.ceil(t.amount*a);1==o?r+='<div class="single_quest_reward">'+o+" scrap</div>":r+='<div class="single_quest_reward">'+o+" scraps</div>"}void 0!=all_available_cards[e]&&(1==(a=Math.floor(a))?r+='<div class="single_quest_reward">'+capitalizeFirstLetter(all_available_cards[e].name)+"</div>":r+='<div class="single_quest_reward">'+a+" x "+capitalizeFirstLetter(all_available_cards[e].name)+"</div>")}),r+="</div>",r+="</div>",$(".current_daily_quest_container").append(r)});var o=a.getTime()-e.getTime();$(".current_daily_quest_container").append('<div class="quests_reset_time">All quests will reset in: <span class="timer" data-complete-time="'+a.getTime()+'"></span></div>'),update_all_timers(),o<0&&show_daily_quests()}function check_new_quests(e){void 0==gamedata.quests&&(gamedata.quests={}),void 0==gamedata.daily_quests&&(gamedata.daily_quests={}),count_object(gamedata.quests);for(var t=1;t<=6;t++)if(void 0==gamedata.quests[t]){var a={};if($.each(all_quests,function(e,t){var o=!0;$.each(gamedata.quests,function(t,a){e==a.quest_id&&(o=!1)}),!0==o&&(a[e]=!0)}),count_object(a)>0){var o=get_random_key_from_object(a),n=Math.ceil(Math.random()*(all_quests[o].max_amount-all_quests[o].min_amount/2)*get_upgrade_factor("quest_amount","any",!0)*1+all_quests[o].min_amount/2),r=get_random_key_from_object_based_on_num_value(random_loot_drops),s=all_quests[o].reward_per_amount.scraps*n*get_upgrade_factor("summon_reward","any",!0);.25>Math.random()||all_available_cards[r].value>s/10?(r="scraps",s=Math.floor(s)):(s=Math.floor(s/all_available_cards[r].value/10))<1&&(s=1),gamedata.quests[t]={quest_id:o,amount:n,progress:0,completed:!1,rewards:{}},gamedata.quests[t].rewards[r]=s,saveToLocalStorage()}}var c=new Date;c.setHours(0,0,0,0);for(var t=1;t<=6;t++)void 0!=gamedata.daily_quests[t]&&void 0==all_quests[gamedata.daily_quests[t].quest_id]&&console.log("unknown daily quest: "+current_quest_id);for(var t=1;t<=6;t++)if(void 0==gamedata.daily_quests[t]||!1!=gamedata.daily_quests[t].completed&&new Date(gamedata.daily_quests[t].completed)<c){var a={};if($.each(all_quests,function(e,t){var o=!0;$.each(gamedata.daily_quests,function(t,a){e==a.quest_id&&(o=!1)}),!0==o&&(a[e]=!0)}),count_object(a)>0){var o=get_random_key_from_object(a);if(gamedata.daily_quests[t]={quest_id:o,amount:3*Math.floor(Math.random()*(all_quests[o].max_amount-all_quests[o].min_amount)+all_quests[o].min_amount),progress:0,completed:!1},void 0!=e&&!0==e){var d="";show_message(d+='<span class="message_title">New quest: '+all_quests[o].name+"</span>")}saveToLocalStorage()}}}var all_achievement_goals={};function check_achievement_goals(){0==count_object(all_achievement_goals)&&($.each(all_achievements,function(e,t){void 0!=t.objective&&("string"==typeof t.objective?(void 0==all_achievement_goals[t.objective]&&(all_achievement_goals[t.objective]={}),void 0==all_achievement_goals[t.objective].achievements&&(all_achievement_goals[t.objective].achievements={}),all_achievement_goals[t.objective].achievements[e]=!0):$.each(t.objective,function(t,a){void 0==all_achievement_goals[a]&&(all_achievement_goals[a]={}),void 0==all_achievement_goals[a].achievements&&(all_achievement_goals[a].achievements={}),all_achievement_goals[a].achievements[e]=!0}))}),$.each(all_quests,function(e,t){void 0!=t.objective&&("string"==typeof t.objective?(void 0==all_achievement_goals[t.objective]&&(all_achievement_goals[t.objective]={}),void 0==all_achievement_goals[t.objective].quests&&(all_achievement_goals[t.objective].quests={}),all_achievement_goals[t.objective].quests[e]=!0):$.each(t.objective,function(t,a){void 0==all_achievement_goals[a]&&(all_achievement_goals[a]={}),void 0==all_achievement_goals[a].quests&&(all_achievement_goals[a].quests={}),all_achievement_goals[a].quests[e]=!0}))}))}function check_quests(e,t,a){void 0==a&&(a=1);var o=[e];count_object(o)>0&&(check_achievement_goals(),check_new_quests(),$.each(o,function(e,o){void 0!=all_achievement_goals[o]&&($.each(gamedata.quests,function(e,t){if(void 0!=all_achievement_goals[o].quests&&void 0!=all_achievement_goals[o].quests[t.quest_id]&&t.progress<t.amount&&(void 0==t.completed||!1==t.completed)&&(t.progress+=a,t.progress>=t.amount&&void 0==t.shown_message)){t.shown_message=!0;var n="";show_message(n+='<span class="message_title">Quest complete: '+all_quests[t.quest_id].name+"</span>")}}),$.each(gamedata.daily_quests,function(e,t){if(void 0!=all_achievement_goals[o].quests&&void 0!=all_achievement_goals[o].quests[t.quest_id]&&t.progress<t.amount&&(void 0==t.completed||!1==t.completed)&&(t.progress+=a,t.progress>=t.amount&&void 0==t.shown_message)){t.shown_message=!0;var n="";show_message(n+='<span class="message_title">Daily quest complete: '+all_quests[t.quest_id].name+"</span>")}}),$.each(all_achievements,function(e,n){var r=!1;if(match_array_values(n.objective,o)&&(r=!0),match_array_values(n.objectives,o)&&(r=!0),void 0!=t&&!0==r&&(void 0!=n.max_amount&&t>n.max_amount&&(r=!1),void 0!=n.min_amount&&t<n.min_amount&&(r=!1)),!0==r&&(void 0==gamedata.achievements[e]&&(gamedata.achievements[e]={amount:0,completed:!1,claimed:!1,date_completed:!1},void 0!=n.objectives&&(gamedata.achievements[e].amount={},$.each(n.objectives,function(t,a){gamedata.achievements[e].amount[a]=0}))),!1==gamedata.achievements[e].completed&&!1==gamedata.achievements[e].claimed)){var s=!0;if(void 0!=n.objectives?(gamedata.achievements[e].amount[o]+=a,$.each(n.objectives,function(t,a){gamedata.achievements[e].amount[a]<n.amount&&(s=!1)})):(gamedata.achievements[e].amount+=a,gamedata.achievements[e].amount<n.amount&&(s=!1)),!0==s){var c="";show_message(c+='<span class="message_title">Achievement complete: '+n.name+"</span>"),gamedata.achievements[e].completed=!0,gamedata.achievements[e].date_completed=new Date}}}))}))}function claim_quest(e){if(void 0!=gamedata.quests[e]&&gamedata.quests[e].amount<=gamedata.quests[e].progress){var t=gamedata.quests[e];all_current_rewards={},current_reward_origin="quests",current_reward_text='For completing the quest <b>"'+capitalizeFirstLetter(all_quests[t.quest_id].name)+'"</b><br/>You have been rewarded with:<br/>',$.each(t.rewards,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:t}}),delete gamedata.quests[e],saveToLocalStorage(),show_content("current_rewards")}}function claim_daily_quest(e){if(void 0!=gamedata.daily_quests[e]&&gamedata.daily_quests[e].amount<=gamedata.daily_quests[e].progress&&!1==gamedata.daily_quests[e].completed){var t=gamedata.daily_quests[e];all_current_rewards={},current_reward_origin="daily_quests",current_reward_text='For completing the daily quest <b>"'+capitalizeFirstLetter(all_quests[t.quest_id].name)+'"</b><br/>You have been rewarded with:<br/>',$.each(all_quests[t.quest_id].rewards,function(e,t){t=Math.floor(t*get_upgrade_factor("summon_reward","any",!0)),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:t}}),gamedata.daily_quests[e].completed=new Date,saveToLocalStorage(),show_content("current_rewards")}}function check_quest_complete_count(){show_daily_reward(),(void 0==gamedata.quests||void 0==gamedata.daily_quests)&&check_new_quests(),6>count_object(gamedata.quests)&&check_new_quests();var e=0,t=0,a=0;$.each(gamedata.quests,function(t,a){a.progress>=a.amount&&e++}),$.each(gamedata.daily_quests,function(e,a){a.progress>=a.amount&&!1==a.completed&&t++}),$.each(gamedata.stories,function(e,t){!0==t.completed&&!1==t.claimed&&a++});var o=0;return $.each(gamedata.achievements,function(e,t){void 0==all_achievements[e]?console.log("unknown achievement: "+e):!0==t.completed&&!1==t.claimed&&o++}),0==o?$(".achievements_page_button").html(""):$(".achievements_page_button").html("&nbsp;!"),0==e?$(".quests_page_button").html(""):$(".quests_page_button").html("&nbsp;!"),0==a?$(".stories_page_button").html(""):$(".stories_page_button").html("&nbsp;!"),!1==daily_reward_claimable?$(".daily_reward_available").html(""):$(".daily_reward_available").html("&nbsp;!"),o>0||e>0||!0==daily_reward_claimable||t>0||a>0?($(".quest_button_complete_count").html("&nbsp;!"),$(".quest_complete_count").html("!"),$(".quest_complete_count").removeClass("hidden")):($(".quest_complete_count").html(""),$(".quest_complete_count").addClass("hidden"),$(".quest_button_complete_count").html("")),t>0?($(".daily_quests_page_button").html("&nbsp;!"),$(".daily_quests_complete").html("("+t+")")):$(".daily_quests_page_button").html(""),e+t}var current_achievements_page=1,achievements_per_page=25;function show_achievements(){void 0==gamedata.shown_achievements&&(gamedata.shown_achievements="all"),$(".achievement_options_button").html(gamedata.shown_achievements);var e=0;void 0==gamedata.achievements&&(gamedata.achievements={}),$(".achievements_container").html(""),$(".achievement_details").html('<span class="no_achievement_text">Select an achievement to view it\'s details.</span>');var t="",a="",o="";$.each(all_achievements,function(n,r){var s="";void 0!=gamedata.achievements[n]&&!0==gamedata.achievements[n].completed&&(s=" completed");var c="";void 0!=gamedata.achievements[n]&&!0==gamedata.achievements[n].claimed&&(c=" claimed");var d=!0;if($.each(r.needs_completed,function(e,t){(void 0==gamedata.achievements[e]||!1==gamedata.achievements[e].completed)&&(d=!1)}),"complete"==gamedata.shown_achievements&&(""==s||""!=c)&&(d=!1),"done"==gamedata.shown_achievements&&""==c&&(d=!1),"busy"==gamedata.shown_achievements&&(""!=c||""!=s)&&(d=!1),!0==d){var l='<div class="single_achievement_container">';if(l+='<div class="achievement achievement_'+n+" "+s+c+'" onclick="show_achievements_details(\''+n+"')\">",l+='<div class="achievement_image" style="background-image:url(images/'+r.image+");background-position:"+r.image_position+'"></div>',void 0==gamedata.achievements[n]||!0!=gamedata.achievements[n].completed){var u=100;if(void 0!=gamedata.achievements[n]){if("object"==typeof gamedata.achievements[n].amount){var m=0,v=0;$.each(gamedata.achievements[n].amount,function(e,t){t>r.amount&&(t=r.amount),m+=t,v++}),u=100-Math.floor(m/(r.amount*v)*100)}else u=100-Math.floor(gamedata.achievements[n].amount/r.amount*100)}l+='<div class="achievement_progress_bar" style="width:'+u+'%"></div>'}l+="</div></div>",""==s&&(t+=l),""!=s&&""==c&&(a+=l),""!=s&&""!=c&&(o+=l),++e/achievements_per_page>current_achievements_page-1&&e/achievements_per_page<=current_achievements_page&&$(".achievements_container").append(l)}}),1==current_achievements_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),e/achievements_per_page<=current_achievements_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),e>0&&Math.ceil(e/achievements_per_page)<current_achievements_page?(current_achievements_page=1,show_achievements()):(0==e?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_achievements_page+" / "+Math.ceil(e/achievements_per_page)),""!=a?$(".claim_all_container").show():$(".claim_all_container").hide())}function set_achievements_page(e){(current_achievements_page+=e)<1&&(current_achievements_page=1),show_achievements()}function show_achievements_details(e){$(".achievement_details").html("");var t=all_achievements[e];gamedata.achievements[e];var a="";void 0!=gamedata.achievements[e]&&!0==gamedata.achievements[e].completed&&(a=" completed");var o="";void 0!=gamedata.achievements[e]&&!0==gamedata.achievements[e].claimed&&(o=" claimed");var n="",r="";if(void 0!=t.image_position&&(r=";background-position:"+t.image_position),n+='<div class="achievement_image" style="background-image:url(images/'+t.image+")"+r+'"></div>',n+='<div class="achievement_title">'+capitalizeFirstLetter(t.name)+"</div>",""==a&&(void 0!=t.hide_details||!1==t.hide_details))n+='<div class="achievement_description">???</div>';else{var s=0;void 0!=gamedata.achievements[e]&&void 0!=gamedata.achievements[e].amount&&(s=gamedata.achievements[e].amount),n+='<div class="achievement_description">'+t.description+"<br/><br/>",""==a&&(void 0==t.hide_amount||!1==t.hide_amount)&&(n+="Progress: "+numberWithCommas(s)+" / "+numberWithCommas(t.amount)+"<br/>"),n+="</div>"}if(""!=a&&""!=o){var c=new Date(gamedata.achievements[e].date_completed),d=c.getDate()+"-"+(c.getMonth()+1)+"-"+c.getFullYear();c.getHours(),c.getMinutes(),c.getSeconds(),n+='<div class="completed_on">Completed on: '+d+"</div>"}""!=a&&""==o&&(n+='<div class="achievement_claim_button" onclick="claim_achievement(\''+e+"')\">CLAIM</div>"),$(".achievement_details").html(n),$(".claim_all_container").hide()}function open_achievement(e){$(".achievement").not(".achievement_"+e).removeClass("open"),$(".achievement_"+e).hasClass("open")?$(".achievement_"+e).removeClass("open"):$(".achievement_"+e).addClass("open")}function claim_all_achievements(){all_current_rewards={};var e=0;$.each(gamedata.achievements,function(t,a){var o=all_achievements[t];!0==a.completed&&!1==a.claimed&&(e++,a.claimed=!0,$.each(o.rewards,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t.reward_id,reward_amount:t.reward_amount}}))}),count_object(all_current_rewards)>0&&(current_reward_origin="achievements",current_reward_text=check_plural("For completing "+e+" achievement(s)<br/>You have been rewarded with:<br/>",e),saveToLocalStorage())}function claim_achievement(e){var t=all_achievements[e],a=gamedata.achievements[e];!0==a.completed&&!1==a.claimed&&(a.claimed=!0,all_current_rewards=t.rewards,current_reward_origin="achievements",current_reward_text='For completing the achievement <b>"'+capitalizeFirstLetter(t.name)+'"</b><br/>You have been rewarded with:<br/>',saveToLocalStorage(),show_content("current_rewards"))}function get_completed_achievement_count(){var e=0;return $.each(gamedata.achievements,function(t,a){!0==a.completed&&e++}),e}function complete_random_daily(){var e={};if($.each(gamedata.daily_quests,function(t,a){!1==a.completed&&a.progress<a.amount&&(e[t]=!0)}),!(count_object(e)>0))return!1;var t=get_random_key_from_object(e);return console.log("ding"),gamedata.daily_quests[t].progress=gamedata.daily_quests[t].amount,saveToLocalStorage(),show_daily_quests(),check_quest_complete_count(),!0}function reset_daily_quests(){delete gamedata.daily_quests,show_daily_quests(),check_quest_complete_count()}function reset_radnom_daily_quest(){var e={};if($.each(gamedata.daily_quests,function(t,a){!1!=a.completed&&(e[t]=!0)}),!(count_object(e)>0))return!1;var t=get_random_key_from_object(e);return delete gamedata.daily_quests[t],check_new_quests(!0),!0}function reset_achievements(){void 0!=gamedata.achievements&&$.each(all_achievements,function(e,t){void 0!=gamedata.achievements[e]&&!0==gamedata.achievements[e].completed||void 0!=gamedata.achievements[e]&&void 0!=t.reset_if_incomplete&&!0==t.reset_if_incomplete&&(gamedata.achievements[e].amount=0,void 0!=t.objectives&&(gamedata.achievements[e].amount={},$.each(t.objectives,function(t,a){gamedata.achievements[e].amount[a]=0})))})}function show_arena(){$(".current_arena_container").html('<div class="loading_arena">Loading arena</div>'),$(".refresh_button").addClass("hidden"),get_fightable_arena_decks()}function show_echoes(){$(".current_arena_container").html('<div class="loading_arena">Loading arena</div>'),$(".refresh_button").addClass("hidden"),get_fightable_echo_decks()}function show_arena_decks(){$(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading your decks</div>'),get_owned_arena_decks()}function get_owned_arena_decks(){$.post("ajax.php",{data:"get_owned_arena_decks",current_id:gamedata.account_id},function(e){parse_owned_decks(all_owned_decks=JSON.parse(e))})}function parse_owned_decks(e){void 0==gamedata.arena_decks_owned&&(gamedata.arena_decks_owned=!1);for(var t="",a=1;a<=5;a++){t+='<div class="owned_deck_container">';var o=!1,n=0,r=0,s=!1;$.each(e,function(e,c){c.deck_id==a&&((2>calculate_scrap_reward(c.wins,c.losses)||c.losses>9)&&(s=!0),n=c.unclaimed,r=c.id,c.deck_content=JSON.parse(c.deck_content),void 0!=c.deck_content.hero&&(t+='<div class="owned_deck owned_deck_'+a+'">',t+='<div class="background" style="background-image:url(images/'+all_available_cards[c.deck_content.hero].image+')"></div>',t+="<span>"+capitalizeFirstLetter(all_available_cards[c.deck_content.hero].name)+"</span>",t+='<div class="wins_losses">Rank '+(parseInt(c.rank)+1)+"<br/>Battles: "+c.wins+"<br/>Losses: "+c.losses,c.unclaimed>0?t+="<br/><br/>Scraps won: "+2*c.unclaimed:t+="<br/><br/><br/>",t+="</div>",t+='<div class="arena_deck_content">',$.each(c.deck_content,function(e,a){"hero"!=e&&void 0!=all_available_cards[e]&&(t+='<div class="arena_deck_content_line">',t+=a+" "+all_available_cards[e].name,t+="</div>")}),t+="</div>",!0==s&&(t+='<div class="arena_deck_broken">BROKEN</div>'),t+="</div>",o=!0,gamedata.arena_decks_owned=!0))}),!1==o&&(t+='<div class="owned_deck empty_deck owned_deck_'+a+'">EMPTY</div>'),!0==s?t+='<div class="replace_deck_button replace_now" onclick="replace_deck('+a+')">REPLACE</div>':t+='<div class="replace_deck_button" onclick="replace_deck('+a+')">REPLACE</div>',!0==o&&n>0&&r>0&&(t+='<div class="replace_deck_button" onclick="claim_deck('+r+')">CLAIM</div>'),t+="</div>"}count_object(e)>0||!1==gamedata.arena_decks_owned?(saveToLocalStorage(),$(".current_arena_decks_container").html(t)):$(".current_arena_decks_container").html('<div class="loading_arena_decks">Failed to load your decks<br/>Please try again later.</div>')}function parse_single_fightable_deck(e){var t=JSON.parse(e.deck_content);$(".current_arena_container").html("");var a="";void 0!=t.hero&&(a+='<div class="single_enemy_deck">',a+='<div class="background" style="background-image:url(images/'+all_available_cards[t.hero].image+')"></div>',a+="<span>"+capitalizeFirstLetter(all_available_cards[t.hero].name)+"<br/><i>"+e.name+"</i></span>",a+='<div class="wins_losses">Rank '+(parseInt(e.rank)+1)+"<br/>"+e.wins+" battles<br/>"+e.losses+" losses",a+="</div>",a+="</div>",gamedata.scraps>0&&(a+='<div class="fight_single_deck_button" onclick="fight_deck('+e.id+')">FIGHT</div>'),a+='<div class="single_arena_deck_content">',$.each(t,function(e,t){if("hero"!=e&&void 0!=all_available_cards[e]){var o=parse_card(e,t);a+='<div class="single_arena_deck_card">',a+="<div onclick=\"show_card_details('"+e+"',undefined,"+t+')">'+o+"</div>",a+="</div>"}}),a+="</div>"),$(".current_arena_container").html(a)}function replace_deck(e){void 0!=gamedata.decks[gamedata.current_deck].hero&&($(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading your decks</div>'),$.post("ajax.php",{data:"replace_deck",current_id:gamedata.account_id,deck_id:e,deck:JSON.stringify(gamedata.decks[gamedata.current_deck]),card_back:gamedata.hand_card_back},function(e){console.log(e),get_owned_arena_decks()}))}function upload_new_king_of_the_hill(){void 0!=gamedata.decks[gamedata.current_deck].hero&&$.post("ajax.php",{data:"upload_new_king_of_the_hill",current_id:gamedata.account_id,deck:JSON.stringify(gamedata.decks[gamedata.current_deck])},function(e){console.log(e)})}function show_single_arena_enemy(e){$(".current_arena_container").html('<div class="loading_arena_decks">Loading enemy deck.</div>'),$("#content_arena .menu_button.slim").addClass("hidden"),$("#content_arena .menu_button.slim.refresh_button").removeClass("hidden"),$.post("ajax.php",{data:"get_deck",deck_id:e},function(e){count_object(JSON.parse(e))>0?parse_single_fightable_deck(all_fightable_decks=JSON.parse(e)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load enemy.<br/>Please try again later.</div>'),$(".refresh_button").removeClass("hidden"),setTimeout(function(){get_fightable_arena_decks()},500))})}function get_fightable_arena_decks(){$.post("ajax.php",{data:"get_fightable_arena_decks",current_id:gamedata.account_id},function(e){count_object(JSON.parse(e))>0?parse_fightable_decks(all_fightable_decks=JSON.parse(e)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load arena.<br/>Please try again later.</div>'),$(".refresh_button").removeClass("hidden"),console.log("failed"),setTimeout(function(){},500))})}function get_fightable_echo_decks(){$.post("ajax.php",{data:"get_fightable_echo_decks",current_id:gamedata.account_id},function(e){count_object(JSON.parse(e))>0?parse_fightable_decks(all_fightable_decks=JSON.parse(e)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load arena.<br/>Please try again later.</div>'),$(".refresh_button").removeClass("hidden"),console.log("failed"),setTimeout(function(){},500))})}function parse_fightable_decks(e){$("#content_arena .menu_button.slim").removeClass("hidden");var t="";void 0==gamedata.scraps&&(gamedata.scraps=0,saveToLocalStorage());var a=0,o=0;void 0==gamedata.wins_today&&(gamedata.wins_today=0),void 0!=gamedata.wins_today&&(o=gamedata.wins_today),o>20&&(o=20),$.each(e,function(e,n){if(a++,t+='<div class="fightable_deck_container">',n.deck_content=JSON.parse(n.deck_content),void 0!=n.deck_content.hero){n.user_id!=gamedata.account_id&&a<11-o/4?t+='<div class="fightable_deck owned_deck_'+n.id+' fightable" onclick="fight_deck('+n.id+')">':t+='<div class="fightable_deck owned_deck_'+n.id+' not_fightable">',t+='<div class="background" style="background-image:url(images/'+all_available_cards[n.deck_content.hero].image+')"></div>',6==n.deck_id?t+="<span>"+capitalizeFirstLetter(all_available_cards[n.deck_content.hero].name)+"<br/><i>"+n.name+"'s echo</i></span>":t+="<span>"+capitalizeFirstLetter(all_available_cards[n.deck_content.hero].name)+"<br/><i>"+n.name+"</i></span>",t+='<div class="wins_losses">Rank '+(parseInt(n.rank)+1)+": "+n.wins+" / "+n.losses;var r=calculate_scrap_reward(n.wins,n.losses);1==r?t+="<br/>Bounty: "+r+" scrap":t+="<br/>Bounty: "+r+" scraps",t+="<br/>Battle cost: 1 scrap",t+="</div>",t+="</div>",deck_found=!0}t+="</div>"}),t+='<div class="arena_cost_description">Defeating an enemy rewards the bounty and additional loot.<br/>You currently have '+numberWithCommas(gamedata.scraps)+" scraps<br/>You have won "+gamedata.wins_today+" battles today</div>",$(".current_arena_container").html(t),$(".refresh_button").removeClass("hidden")}function fight_deck(e){$(".current_arena_container").html('<div class="loading_arena">Loading battle</div>'),arena_deck_id=e,$.post("ajax.php",{data:"get_deck",deck_id:e},function(e){var t=JSON.parse((current_deck=JSON.parse(e)).deck_content);void 0!=t.hero&&gamedata.scraps>0?(gamedata.scraps-=1,saveToLocalStorage(),arena_reward_amount=calculate_scrap_reward(current_deck.wins,current_deck.losses),arena_card_back=current_deck.card_back,6==current_deck.deck_id?show_arena_battle(t,current_deck.name+"'s echo"):show_arena_battle(t,current_deck.name)):show_arena()})}function fight_king_of_the_hill(e){gamedata.last_king_fight=new Date,$(".current_king_of_the_hill_container").html('<div class="loading_arena">Loading battle</div>'),$(".recent_kings_container").html(""),$(".king_rewards_container").html(""),arena_deck_id=e,$.post("ajax.php",{data:"get_deck",deck_id:e},function(e){arena_reward_amount=calculate_scrap_reward((current_deck=JSON.parse(e)).wins,current_deck.losses),show_king_of_the_hill_battle(JSON.parse(current_deck.deck_content),current_deck.name,current_deck.wins)})}function claim_deck(e){$(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading rewards</div>'),$.post("ajax.php",{data:"claim_deck",deck_id:e},function(e){e>0?(current_reward_origin="arena_decks",current_reward_text="You got some prizes in the arena",all_current_rewards={0:{reward_id:"scraps",reward_amount:2*e}},20*Math.random()<e&&(all_current_rewards[1]={reward_id:"arena_shard",reward_amount:1}),show_content("current_rewards")):show_arena_decks()})}function calculate_scrap_reward(e,t){var a=Math.floor(parseInt(e)+1-(parseInt(t)+1)+5);return a<2&&(a=2),a}function get_king_of_the_hill(){$.post("ajax.php",{data:"king_of_the_hill"},function(e){parse_king_of_the_hill(JSON.parse(e))})}function get_recent_kings(){$.post("ajax.php",{data:"get_recent_kings"},function(e){parse_recent_kings(JSON.parse(e))})}function get_king_rewards(){$.post("ajax.php",{data:"get_king_rewards",current_id:gamedata.account_id},function(e){parse_king_rewards(parseInt(JSON.parse(e)))})}function show_king_of_the_hill(){$(".current_king_of_the_hill_container").html('<div class="loading_king_of_the_hill">Loading king of the hill</div>'),$(".recent_kings_container").html(""),$(".king_rewards_container").html(""),get_king_of_the_hill(),get_recent_kings(),get_king_rewards()}function parse_king_of_the_hill(e){var t="";if(void 0==gamedata.last_king_fight&&(gamedata.last_king_fight=new Date),null!=e){if(t+='<div class="fightable_deck_container">',e.deck_content=JSON.parse(e.deck_content),void 0!=e.deck_content.hero&&(e.user_id!=gamedata.account_id?t+='<div class="fightable_deck owned_deck_'+e.id+'" onclick="fight_deck('+e.id+')">':t+='<div class="fightable_deck owned_deck_'+e.id+'">',t+='<div class="background" style="background-image:url(images/'+all_available_cards[e.deck_content.hero].image+')"></div>',t+="<span>"+capitalizeFirstLetter(all_available_cards[e.deck_content.hero].name)+"<br/><i>"+e.name+"</i></span>",t+='<div class="wins_losses">Battles: '+e.wins,t+="</div>",t+="</div>",e.user_id!=gamedata.account_id)){var a=king_battle_timeout-(new Date().getTime()-new Date(gamedata.last_king_fight).getTime())/1e3,o=new Date().getTime()+1e3*a;a<=0?t+='<div class="fight_deck_button" onclick="fight_king_of_the_hill('+e.id+')">FIGHT</div>':t+='<div class="fight_deck_button timer" data-complete-time='+o+' data-complete-function="show_king_of_the_hill">'+toHHMMSS(a)+"</div>"}t+="</div>"}else t+='<div class="fightable_deck_container">',t+='<button class="menu_button king_of_the_hill_button" data-target-content="king_of_the_hill">RELOAD</button>',t+="</div>";$(".current_king_of_the_hill_container").html(t)}function parse_recent_kings(e){var t="Recent kings";$.each(e,function(e,a){t+='<div class="single_king">',t+='<span class="king_name">'+a.name+"</span><br/>",t+="Battles: "+a.wins,t+="</div>"}),$(".recent_kings_container").html(t)}function parse_king_rewards(e){var t="<span>Gain 25 scraps and 5 arena shards for taking the hill.<br/><br/>Gain 10 scraps for every defensive battle on the hill.</span>";e>0&&(t="",t+="<span>Current rewards:</span><br/>",t+=10*e+" scraps",t+='<div class="claim_king_button" onclick="claim_king()">CLAIM</div>'),$(".king_rewards_container").html(t)}function claim_king(){$.post("ajax.php",{data:"claim_king_rewards",current_id:gamedata.account_id},function(e){gain_scraps(10*parseInt(JSON.parse(e))),show_king_of_the_hill()})}var new_building_id=0,current_fragment_page=1,current_construction="",all_current_rewards={},current_reward_origin="",current_reward_text="",base_building_cost=4,building_scraps_cost=10,storage_maxed=0,town_production_stored=0,town_max_storage=0,do_no_apply_factions=!1,current_adventure="",current_adventure_units={},suggest_mode="all",owned_buildings_fragments={};function toggle_suggest_mode(){$(".suggest_view div").removeClass("active"),"matched"==suggest_mode?($(".suggest_view .suggest_slider").addClass("all"),$(".suggest_view .suggest_all").addClass("active"),suggest_mode="all"):($(".suggest_view .suggest_slider").removeClass("all"),$(".suggest_view .suggest_matched").addClass("active"),suggest_mode="matched"),show_adventure_units()}function check_owned_buildings(){owned_buildings_fragments={},$.each(gamedata.town,function(e,t){void 0==owned_buildings_fragments[all_buildings[t.building_id].fragment_id]&&(owned_buildings_fragments[all_buildings[t.building_id].fragment_id]={building_id:t.building_id,building_level:t.level})}),console.log(owned_buildings_fragments)}function show_town(){$(".town_content").html("");var e="",t=new Date().getTime();void 0==gamedata.town&&(gamedata.town={},saveToLocalStorage()),void 0==gamedata.max_buildings&&(gamedata.max_buildings=get_highest_key_in_object(gamedata.town),saveToLocalStorage()),storage_maxed=0,town_production_stored=0,town_max_storage=0,$.each(all_buildings,function(a,o){var n=!0;if($.each(o.needed_upgrades,function(e,t){(void 0==gamedata.upgrades||void 0==gamedata.upgrades[e]||gamedata.upgrades[e]<t)&&(n=!1)}),!0==n){void 0==gamedata.town[a]&&(gamedata.town[a]={building_id:a,level:1},saveToLocalStorage());var r=o;e+='<div class="building" onclick="current_building_id=\''+a+"';show_content('single_building')\">",e+='<div class="background" style="background-image:url(images/'+r.image+')"></div>',e+="<span>"+capitalizeFirstLetter(r.name)+"</span>",e+='<span class="current_status">';var s=0,c=0,d=0;if(void 0!=gamedata.town[a]){void 0==gamedata.town[a].level&&(gamedata.town[a].level=1),d=gamedata.town[a].level+0;var l=0;if($.each(gamedata.town[a].expeditions,function(e,a){d-=1,a.done_time<=t&&(c+=1),a.done_time>t&&(s+=1,(0==l||l>a.done_time)&&(l=a.done_time))}),$.each(gamedata.town[a].adventures,function(e,a){d-=1,a.done_time<=t&&(c+=1),a.done_time>t&&(s+=1,(0==l||l>a.done_time)&&(l=a.done_time))}),(void 0!=gamedata.town[a].adventures||void 0!=gamedata.town[a].expeditions)&&(s>0&&(e+='<br/><span class="timer" data-complete-time='+l+"></span>"),c>0&&(e+='<br/><b><span style="color:#afa">DONE</span></b>'),d>0&&0==c&&0==s&&(e+="<br/>Idle")),void 0!=gamedata.town[a]&&"shop"==r.type){var u=0;$.each(gamedata.town[a].current_offers,function(e,t){(void 0==t.sold||new Date(t.offer_expires)<new Date)&&u++}),u>0&&(e+="<br/>Offer available")}var m=0,v=0;gamedata.town[a].level,void 0!=gamedata.town[a]&&void 0!=gamedata.town[a].productions&&void 0!=r.productions&&$.each(r.productions,function(e,t){if(void 0!=gamedata.town[a].productions[e]&&(void 0==gamedata.town[a].productions[e].production_id||!1!=gamedata.town[a].productions[e].production_id)){void 0==gamedata.town[a].productions[e].speed_level&&(gamedata.town[a].productions[e].speed_level=1),void 0==gamedata.town[a].productions[e].storage_level&&(gamedata.town[a].productions[e].storage_level=1);var o=gamedata.town[a].productions[e],t=r.productions[e],n=calculate_production_speed(o.speed_level,t.base_time,t.defeated_heroes_speed_bonusses,t.production_achievement_bonus,gamedata.town[a].level),s=(new Date().getTime()-o.last_claimed)/1e3,c=calculate_production_storage(o.storage_level,t.base_storage,t.defeated_heroes_speed_bonusses,gamedata.town[a].level),d=Math.floor(s/n);d>c&&(d=c),m+=d,v+=c,town_production_stored+=d,town_max_storage+=c}}),v>0&&(m>=v?(e+='<br/><span style="color:#f00"><b>STORAGE FULL</b></span>',storage_maxed++):m>0?e+='<br/><span style="color:#afa">Storage: '+nFormatter(m,2)+" / "+nFormatter(v,2)+"</span>":e+="<br/>Storage: 0 / "+v)}e+="</span>",e+="</div>"}}),$(".town_content").html(e),1==count_object(gamedata.town)?($.each(gamedata.town,function(e,t){current_building_id=e}),"single_building"==last_content?show_content("home"):show_content("single_building")):update_all_timers()}function calculate_production_speed(e,t,a,o,n){var r=1;return $.each(a,function(e,t){void 0!=gamedata.defeated_heroes&&void 0!=gamedata.defeated_heroes[e]&&(r+=gamedata.defeated_heroes[e]*t)}),void 0!=o&&(r*=1+get_completed_achievement_count()*o),Math.ceil(t/((1+sqr(e)/20)*r*n))}function calculate_production_speed_cost(e,t){return Math.ceil(t*(1+sqr(sqr(e))/50))}function calculate_production_storage(e,t,a,o){var n=1;return $.each(a,function(e,t){void 0!=gamedata.defeated_heroes&&void 0!=gamedata.defeated_heroes[e]&&(n+=gamedata.defeated_heroes[e]*t)}),Math.floor(t*(1+sqr(e)/20)*n*o)}function calculate_new_building_slot_cost(){for(var e=10,t=0;t<=gamedata.max_buildings;t++)e*=2.5;return 10*Math.floor(e/10)}function buy_new_building_slot(){var e=calculate_new_building_slot_cost();gamedata.scraps>=e&&(gamedata.scraps-=e,gamedata.max_buildings+=1,saveToLocalStorage()),show_content("town")}function show_new_buildings(){cards_per_page=12,$("#content_new_buildings .new_buildings_list").html('<span class="no_tinker">You have no fragments.<br/>You can find them in battles.</span>'),gamedata.owned_cards=sortObj(gamedata.owned_cards);var e=0;$.each(all_buildings,function(t,a){var o=!1,n=0;if(void 0==gamedata.owned_cards[a.fragment_id]?o=!0:n=gamedata.owned_cards[a.fragment_id]+0,1==++e&&$("#content_new_buildings .new_buildings_list").html(""),e/cards_per_page>current_fragment_page-1&&e/cards_per_page<=current_fragment_page){var r=parse_card(a.fragment_id,n);void 0==gamedata.town[new_building_id]&&(n<base_building_cost?$("#content_new_buildings .new_buildings_list").append('<div class="fragment faded" onclick="show_construct_building(\''+t+"')\">"+r+"</div>"):$("#content_new_buildings .new_buildings_list").append('<div class="fragment" onclick="show_construct_building(\''+t+"')\">"+r+"</div>"))}}),1==current_fragment_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),e/cards_per_page<=current_fragment_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),e>0&&Math.ceil(e/cards_per_page)<current_fragment_page&&(current_fragment_page=1,show_new_buildings()),0==e?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_fragment_page+" / "+Math.ceil(e/cards_per_page))}function set_fragments_page(e){(current_fragment_page+=e)<1&&(current_fragment_page=1),show_new_buildings()}function show_construct_building(e){current_construction="",void 0!=all_buildings[e]&&(current_construction=e),""!=current_construction&&show_content("construction")}function show_construction(){if(""==current_construction||void 0==all_buildings[current_construction])show_content("town");else{var e=all_buildings[current_construction];$(".construction_content").html("");var t=0;void 0!=gamedata.owned_cards[e.fragment_id]&&(t=gamedata.owned_cards[e.fragment_id]);var a=parse_card(e.fragment_id,t+" / "+base_building_cost);t<base_building_cost&&(a=parse_card(e.fragment_id,'<span style="color:red">'+t+" / "+base_building_cost+"</span>")),gamedata.scraps<base_building_cost*building_scraps_cost?a+=parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(base_building_cost*building_scraps_cost)+"</span>"):a+=parse_card("scraps_placeholder",""+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(base_building_cost*building_scraps_cost)),$(".construction_content").append('<div class="construction_name">'+capitalizeFirstLetter(e.name)+"</div>"),gamedata.owned_cards[e.fragment_id]<base_building_cost||gamedata.scraps<base_building_cost*building_scraps_cost?$(".construction_content").append('<div class="construction_description">'+capitalizeFirstLetter(e.description)+"</div>"):($(".construction_content").append('<div class="construction_description">'+capitalizeFirstLetter(e.description)+"</div>"),$(".construction_content").append('<div onclick="construct_current_building()" class="construction_button">BUILD</div>')),$(".construction_content").append('<div class="fragment_cost">'+a+'<div style="clear:both"></div></div>')}}function construct_current_building(){if(""!=current_construction&&void 0!=all_buildings[current_construction]&&void 0==gamedata.town[new_building_id]){var e=all_buildings[current_construction];gamedata.owned_cards[e.fragment_id]>=base_building_cost&&gamedata.scraps>=base_building_cost*building_scraps_cost&&(gamedata.owned_cards[e.fragment_id]-=base_building_cost,gamedata.scraps-=base_building_cost*building_scraps_cost,gamedata.town[new_building_id]={building_id:current_construction,level:1},saveToLocalStorage())}current_building_id=new_building_id,show_content("single_building")}function upgrade_current_building(){if(void 0!=current_building_id){var e=all_buildings[gamedata.town[current_building_id].building_id],t=calculate_upgrade_cost(gamedata.town[current_building_id].level);gamedata.owned_cards[e.fragment_id]>=t&&gamedata.scraps>=t*building_scraps_cost&&(gamedata.owned_cards[e.fragment_id]-=t,gamedata.scraps-=t*building_scraps_cost,gamedata.town[current_building_id].level+=1,saveToLocalStorage())}show_content("single_building")}function show_single_building(){if(void 0==gamedata.town[current_building_id])show_content("town");else{$(".new_expedition_button").remove(),$(".building_recipes_button").remove();var e="",t=gamedata.town[current_building_id],a=all_buildings[t.building_id],o=t.level;$(".building_bg").css("background-image","url(images/"+a.image+")"),$("#content_single_building h2").html(capitalizeFirstLetter(a.name)),$(".upgrade_building_button").removeClass("click_me");var n=calculate_upgrade_cost(o);if(gamedata.owned_cards[a.fragment_id]>=n&&gamedata.scraps>=n*building_scraps_cost&&$(".upgrade_building_button").addClass("click_me"),void 0!=a.productions){var r=!1;void 0==t.productions&&(t.productions={}),count_object(a.productions)>1&&(e+='<div class="claim_all_production_button" onclick="claim_all_production()">CLAIM ALL</div>'),$.each(a.productions,function(o,n){if(void 0==t.productions[o]&&void 0==n.unlock_cost&&(t.productions[o]={level:1,speed_level:1,storage_level:1,last_claimed:new Date().getTime()},void 0!=n.production_pickable&&!0==n.production_pickable&&(t.productions[o].production_id=!1),saveToLocalStorage()),void 0!=t.productions[o]){var s=t.productions[o],n=a.productions[o],c=calculate_production_speed(s.speed_level,n.base_time,n.defeated_heroes_speed_bonusses,n.production_achievement_bonus,t.level),d=(new Date().getTime()-s.last_claimed)/1e3,l=Math.floor(d/c),u=calculate_production_storage(s.storage_level,n.base_storage,n.defeated_heroes_speed_bonusses,t.level),m=Math.floor(d/c);m>u&&(m=u);var v=new Date().getTime()+(c-(d-c*l))*1e3,p="";p+='<div class="single_expedition production_bar">';var f="";if(void 0!=all_available_cards[o]&&(f=o),"scraps"==o&&(f="scraps_placeholder"),void 0!=all_available_cards[o]||void 0!=t.productions[o].production_id&&!1!=t.productions[o].production_id){var b=o;void 0!=t.productions[o].production_id&&!1!=t.productions[o].production_id&&void 0!=all_available_cards[t.productions[o].production_id]&&(f=b=t.productions[o].production_id),p+='<span class="single_new_expedition_name">'+capitalizeFirstLetter(all_available_cards[f].name)+"<br/></span>";var h=parse_card(f);p+="<span onclick=\"claim_production('"+o+"')\">"+h+"</span>",p+="<div onclick=\"claim_production('"+o+'\')" class="production_time">'+toHHMMSS(c)+"</div>",l<u&&(p+="<div onclick=\"claim_production('"+o+'\')" class="production_time_left timer" data-complete-time='+v+' data-complete-function="show_single_building"></div>'),p+="<div onclick=\"claim_production('"+o+'\')" class="production_storage_container">',p+='<div class="production_storage_bar" style="width:'+Math.floor(m/u*100)+'%"></div>',p+='<div class="production_storage_amount">'+nFormatter(m,2)+" / "+nFormatter(u,2)+"</div>",p+="</div>",void 0!=n.production_pickable&&!0==n.production_pickable&&(p+="<div onclick=\"cancel_pickable_production('"+o+'\')" class="cancel_pickable_production_button">CHANGE</div>')}else void 0!=n.production_pickable&&!0==n.production_pickable&&(p+='<span class="single_new_expedition_name">Pick production<br/></span>',$.each(n.pickable_productions,function(e,t){var a=check_defeated_heroes(t.available),n="";void 0!=all_available_cards[e]&&(n=e),"scraps"==e&&(n="scraps_placeholder");var r=parse_card(n);""==a&&(p+="<span onclick=\"set_pickable_production('"+o+"','"+e+"')\">"+r+"</span>")}));if(p+='<div class="increase_production_container">',void 0!=all_available_cards[o]||void 0!=t.productions[o].production_id&&!1!=t.productions[o].production_id){if(count_object(n.upgrade_cost_speed)>0){p+='<div class="upgrade_section">',p+='<span class="">Production</span><br/>';var g=!0;$.each(n.upgrade_cost_speed,function(e,t){var a=calculate_production_speed_cost(s.speed_level,t),o=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(o=gamedata.owned_cards[e]),"scraps"==e&&(o=gamedata.scraps);var n="",r="Scraps";void 0!=all_available_cards[e]&&(r=capitalizeFirstLetter(all_available_cards[e].name)),o<a?(n=r+': <span style="color:red">'+nFormatter(o,3)+" / "+nFormatter(a,3)+"</span>",g=!1):n=r+': <span style="">'+nFormatter(o,3)+" / "+nFormatter(a,3)+"</span>",p+='<div class="production_upgrade_cost" onclick="show_card_details(\''+e+"')\">"+n+"</div>"}),!0==g&&(p+='<br/><div class="production_upgrade_button" onclick="upgrade_production(\''+o+"')\">UPGRADE</div>"),p+="</div>"}p+='<div class="upgrade_section">',p+='<span class="">Storage</span><br/>';var g=!0;$.each(n.upgrade_cost_storage,function(e,t){var a=calculate_production_speed_cost(s.storage_level,t),o=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(o=gamedata.owned_cards[e]),"scraps"==e&&(o=gamedata.scraps);var n="",r="Scraps";void 0!=all_available_cards[e]&&(r=capitalizeFirstLetter(all_available_cards[e].name)),o<a?(n=r+': <span style="color:red">'+nFormatter(o,3)+" / "+nFormatter(a,3)+"</span>",g=!1):n=r+': <span style="">'+nFormatter(o,3)+" / "+nFormatter(a,3)+"</span>",p+='<div class="production_upgrade_cost" onclick="show_card_details(\''+e+"')\">"+n+"</div>"}),!0==g&&(p+='<br/><div class="production_upgrade_button" onclick="upgrade_storage(\''+o+"')\">UPGRADE</div>"),p+="</div>"}p+="</div>",p+='<div style="clear:both"></div>',p+="</div>",e+=p}else if(!1==r){r=n.unlock_cost;var w="";gamedata.scraps<r&&(w="button_red"),e+='<div class="claim_all_production_button '+w+'" onclick="buy_next_production(\''+o+"')\">UNLOCK NEXT<br/>"+nFormatter(gamedata.scraps,3)+" / "+nFormatter(r,3)+" scraps</div>"}})}void 0!=a.recipes&&count_object(a.recipes)>0&&(e+=show_building_recipes()),void 0!=a.recipe_shop&&(void 0==gamedata.known_recipes&&(gamedata.known_recipes={}),$.each(a.recipe_shop,function(t,a){if(void 0==gamedata.known_recipes[t]){var o=!0,n=!0;if(void 0==gamedata.defeated_heroes&&(gamedata.defeated_heroes={}),$.each(a.shown,function(e,t){(void 0==gamedata.defeated_heroes[e]||gamedata.defeated_heroes[e]<t)&&(o=!1)}),$.each(a.available,function(e,t){(void 0==gamedata.defeated_heroes[e]||gamedata.defeated_heroes[e]<t)&&(n=!1)}),!0==o){var r="",s=parse_card(t),c=!0;r+='<div class="single_building_recipe">',r+='<span class="single_new_expedition_name">Recipe: '+capitalizeFirstLetter(all_available_cards[t].name+"</span>"),!0==n?(r+='<div class="single_building_recipe_costs"><br/>',$.each(a.cost,function(e,t){var a=0;"scraps"==e&&(a=gamedata.scraps),void 0!=gamedata.owned_cards[e]&&(a=gamedata.owned_cards[e]);var o="Scraps";if(void 0!=all_available_cards[e]&&(o=capitalizeFirstLetter(all_available_cards[e].name)),a<t){c=!1;var n=o+': <span style="color:red">'+nFormatter(a,3)+" / "+nFormatter(t,3)+"</span>"}else var n=o+': <span style="">'+nFormatter(a,3)+" / "+nFormatter(t,3)+"</span>";r+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+e+"')\">"+n+"</div>"}),r+="</div>",r+='<div class="single_building_recipe_result" onclick="show_card_details(\''+t+"')\">"+s+"</div>",!0==c&&(r+='<div class="single_building_recipe_craft_button" onclick="learn_local_recipe(\''+t+"')\">LEARN</div>")):r+='<div class="single_building_recipe_result" onclick="show_card_details(\''+t+'\')" style="opacity:0.5">'+s+"</div>",r+='<div style="clear:both"></div>',r+="</div>",e+=r}}})),void 0!=a.shop_type&&(check_current_offers(),$.each(t.current_offers,function(t,a){var o="";a.card_amount>1&&(o=""+a.card_amount+"x ");var n="";n+='<div class="single_expedition single_offer"><span class="single_new_expedition_name">'+capitalizeFirstLetter(all_available_cards[a.card_id].name)+'</span><br/><span class="single_new_expedition_description">'+capitalizeFirstLetter(a.buysell)+"ing: "+o+capitalizeFirstLetter(all_available_cards[a.card_id].name)+". <br/></span>","buy"==a.buysell&&(n+="Offer: "+nFormatter(a.offer_price,3)+" scraps."),"sell"==a.buysell&&(n+="Price: "+nFormatter(a.offer_price,3)+" scraps."),n+="<br/>("+nFormatter(a.offer_price/(all_available_cards[a.card_id].value*a.card_amount)*100,0)+"%)";var r=0;void 0!=gamedata.owned_cards[a.card_id]&&(r=gamedata.owned_cards[a.card_id]),void 0==a.sold?(n+='<div class="offer_image" onclick="show_card_details(\''+a.card_id+"')\">"+parse_card(a.card_id,o)+"</div>","buy"==a.buysell&&void 0!=gamedata.known_recipes&&void 0!=gamedata.known_recipes[a.card_id]&&(n+="<div class=\"craft_offer_button\" onclick=\"show_content('craft');show_card_recipe('"+a.card_id+"')\">CRAFT</div>"),r>=a.card_amount&&"buy"==a.buysell&&void 0==a.sold&&(n+='<div class="complete_expedition_button complete_offer_button buysell_sell" onclick="complete_offer('+t+')">SELL</div>'),gamedata.scraps>=a.offer_price&&"sell"==a.buysell&&void 0==a.sold&&(n+='<div class="complete_expedition_button complete_offer_button" onclick="complete_offer('+t+')">BUY</div>')):n+='<span class="single_new_expedition_description">Trade complete.</span>',n+='<div class="timer" data-complete-time="'+new Date(a.offer_expires).getTime()+'" data-complete-function="show_single_building"></div>',n+="</div>",e+=n})),void 0!=a.show_potions&&!0==a.show_potions&&(void 0==t.potions&&(t.potions={}),t.potions=sortObj(t.potions),e+='<div class="single_expedition production_bar potion_bar">',$.each(all_upgrades,function(a,o){"potion"==o.upgrade_type&&(void 0!=t.potions[a]?e+=parse_potion_button(a):e+=parse_potion_button(a,!1))}),e+="</div>");var s=0;void 0!=a.expeditions&&(void 0==t.expeditions?(t.expeditions={},saveToLocalStorage()):$.each(t.expeditions,function(t,a){var o="",n=all_expeditions[a.expedition_id];o+='<div class="single_expedition"><span class="single_new_expedition_name busy_expedition_name">'+capitalizeFirstLetter(n.name)+"</span>",o+='<div class="timer" data-complete-time="'+a.done_time+'" data-complete-show="complete_expedition_button_'+current_building_id+"_"+t+'" data-complete-hide="cancel_expedition_button_'+current_building_id+"_"+t+'"></div>',o+='<div class="complete_expedition_button_'+current_building_id+"_"+t+' complete_expedition_button hidden" onclick="complete_expedition('+t+')">COMPLETE</div>',(void 0==n.cannot_cancel||!1==n.cannot_cancel)&&(o+='<div class="cancel_expedition_button_'+current_building_id+"_"+t+' cancel_expedition_button" onclick="cancel_expedition('+t+')">CANCEL</div>'),o+="</div>",e+=o}),s+=count_object(t.expeditions),count_object(t.expeditions)),void 0!=a.adventures&&(void 0==t.adventures?(t.adventures={},saveToLocalStorage()):$.each(t.adventures,function(t,a){var o="",n=all_adventures[a.adventure_id];o+='<div class="single_expedition"><span class="single_new_expedition_name">'+capitalizeFirstLetter(n.name)+'</span><br/><span class="single_new_expedition_description">'+n.description+"<br/><br/>Current party:</span>",o+='<div class="timer" data-complete-time="'+a.done_time+'" data-complete-show="complete_expedition_button_'+current_building_id+"_"+t+'" data-complete-hide="cancel_expedition_button_'+current_building_id+"_"+t+'"></div>',o+='<div class="complete_expedition_button_'+current_building_id+"_"+t+' complete_expedition_button hidden" onclick="complete_adventure('+t+')">COMPLETE</div>',o+='<div class="cancel_expedition_button_'+current_building_id+"_"+t+' cancel_expedition_button" onclick="cancel_adventure('+t+')">CANCEL</div>',o+='<div class="adventuring_units">',$.each(a.units,function(e,t){if(void 0!=all_available_cards[t]){var a=parse_card(t);o+="<div onclick=\"show_card_details('"+t+"')\">"+a+"</div>"}}),o+='<div style="clear:both;"></div>',o+="</div>",o+="</div>",e+=o}),s+=count_object(t.adventures),count_object(t.adventures)),(void 0!=a.expeditions||a.adventures)!=void 0&&s<1&&(void 0!=a.new_mission_title?e+='<div class="new_expedition_button" onclick="show_content(\'new_mission\')">'+a.new_mission_title+"</div><br/>":e+='<div class="new_expedition_button" onclick="show_content(\'new_mission\')">ENTER</div><br/>'),e+="",$(".single_building_content_list").html(e),update_all_timers()}}function buy_next_production(e){var t=gamedata.town[current_building_id],a=all_buildings[t.building_id];if(void 0!=a.productions[e]&&void 0==t.productions[e]){var o=a.productions[e].unlock_cost;gamedata.scraps>=o&&(gamedata.scraps-=o,t.productions[e]={level:1,speed_level:1,storage_level:1,last_claimed:new Date().getTime()},saveToLocalStorage(),show_single_building())}}function set_pickable_production(e,t){var a=gamedata.town[current_building_id],o=all_buildings[a.building_id];void 0!=o.productions&&void 0!=o.productions[e]&&void 0!=o.productions[e].pickable_productions&&void 0!=o.productions[e].pickable_productions[t]&&(a.productions[e].production_id=t,new_time=new Date().getTime(),a.productions[e].last_claimed=new_time,saveToLocalStorage(),show_single_building())}function cancel_pickable_production(e){var t=gamedata.town[current_building_id];all_buildings[t.building_id],t.productions[e].production_id=!1,saveToLocalStorage(),show_single_building()}function upgrade_production(e){var t=gamedata.town[current_building_id],a=all_buildings[t.building_id];t.level;var o=t.productions[e],n=a.productions[e],r=!0;$.each(n.upgrade_cost_speed,function(e,t){var a=calculate_production_speed_cost(o.speed_level,t),n=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(n=gamedata.owned_cards[e]),"scraps"==e&&(n=gamedata.scraps),n<a&&(r=!1)}),!0==r&&($.each(n.upgrade_cost_speed,function(e,t){var a=calculate_production_speed_cost(o.speed_level,t);void 0!=gamedata.owned_cards[e]&&(gamedata.owned_cards[e]-=a),"scraps"==e&&(gamedata.scraps-=a)}),o.speed_level++,saveToLocalStorage()),show_single_building()}function upgrade_storage(e){var t=gamedata.town[current_building_id],a=all_buildings[t.building_id];t.level;var o=t.productions[e],n=a.productions[e],r=!0;$.each(n.upgrade_cost_storage,function(e,t){var a=calculate_production_speed_cost(o.storage_level,t),n=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(n=gamedata.owned_cards[e]),"scraps"==e&&(n=gamedata.scraps),n<a&&(r=!1)}),!0==r&&($.each(n.upgrade_cost_speed,function(e,t){var a=calculate_production_speed_cost(o.storage_level,t);void 0!=gamedata.owned_cards[e]&&(gamedata.owned_cards[e]-=a),"scraps"==e&&(gamedata.scraps-=a)}),o.storage_level++,saveToLocalStorage()),show_single_building()}function claim_all_production(){var e=gamedata.town[current_building_id];all_current_rewards={},$.each(e.productions,function(e,t){claim_production(e,!0)}),count_object(all_current_rewards)>0&&(current_reward_text="You claimed the production.",current_reward_origin="single_building",saveToLocalStorage(),show_content("current_rewards"))}function claim_production(e,t){var a=gamedata.town[current_building_id],o=all_buildings[a.building_id];a.level;var n=a.productions[e],r=o.productions[e],s=calculate_production_speed(n.speed_level,r.base_time,r.defeated_heroes_speed_bonusses,r.production_achievement_bonus,a.level),c=(new Date().getTime()-n.last_claimed)/1e3,d=calculate_production_storage(n.storage_level,r.base_storage,r.defeated_heroes_speed_bonusses,a.level),l=Math.floor(c/s),u=e;void 0!=a.productions[e].production_id&&!1!=a.productions[e].production_id&&void 0!=all_available_cards[a.productions[e].production_id]&&(u=a.productions[e].production_id),l>d&&(l=d);var m=n.last_claimed+l*s*1e3;Math.floor(c/s)>=d&&(m=new Date().getTime()),l>0&&(n.last_claimed=m,void 0!=t&&!0==t?all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:u,reward_amount:l}:(all_current_rewards={0:{reward_id:u,reward_amount:l}},current_reward_text="You claimed the production.",current_reward_origin="single_building",saveToLocalStorage(),show_content("current_rewards")))}function clear_all_offers(){$.each(gamedata.town,function(e,t){void 0!=t.current_offers&&(t.current_offers={})})}function complete_offer(e){var t=gamedata.town[current_building_id];all_buildings[t.building_id];var a=t.current_offers[e],o=0;void 0!=gamedata.owned_cards[a.card_id]&&(o=gamedata.owned_cards[a.card_id]),"buy"==a.buysell&&o>=a.card_amount&&void 0==a.sold&&(gamedata.owned_cards[a.card_id]-=a.card_amount,gamedata.scraps+=a.offer_price,a.sold=!0,check_quests("sell_card_in_town"),new Date().addMinutes(10)<new Date(a.offer_expires)&&(a.offer_expires=new Date().addMinutes(10)),saveToLocalStorage()),"sell"==a.buysell&&gamedata.scraps>=a.offer_price&&void 0==a.sold&&(void 0==gamedata.owned_cards[a.card_id]&&(gamedata.owned_cards[a.card_id]=0),gamedata.owned_cards[a.card_id]+=a.card_amount,gamedata.scraps-=a.offer_price,a.sold=!0,check_quests("buy_card_in_town"),new Date().addMinutes(10)<new Date(a.offer_expires)&&(a.offer_expires=new Date().addMinutes(10)),saveToLocalStorage()),show_single_building()}function check_current_offers(){var e=gamedata.town[current_building_id],t=all_buildings[e.building_id];e.level;var a=!1;void 0==e.current_offers&&(gamedata.town[current_building_id].current_offers={});for(var o=0;o<1;o++)void 0!=e.current_offers[o]&&new Date(e.current_offers[o].offer_expires)<new Date&&delete e.current_offers[o],void 0==e.current_offers[o]&&delete e.current_offers[o],void 0==e.current_offers[o]&&(e.current_offers[o]=create_new_building_offer(t),a=!0);!0==a&&saveToLocalStorage()}function create_new_building_offer(e){var t="buy";Math.random()>.75&&(t="sell");var a=!1;if("buy"==t){if(Math.random()>.1){var o={};$.each(gamedata.owned_cards,function(t,a){match_array_values(all_available_cards[t].type,e.shop_type)&&(o[t]=!0)}),count_object(o)>0&&(a=get_random_key_from_object(o))}if(!1==a&&void 0!=gamedata.known_recipes&&count_object(gamedata.known_recipes)>4&&Math.random()>.3){var o={};$.each(gamedata.known_recipes,function(t,a){match_array_values(all_available_cards[t].type,e.shop_type)&&(o[t]=!0)}),count_object(o)>0&&(a=get_random_key_from_object(o))}}!1==a&&(a=get_random_card(e.shop_type));var n=!1;if(!1!=a){var r=1;"buy"==t&&void 0!=gamedata.owned_cards[a]&&r<gamedata.owned_cards[a]&&gamedata.owned_cards[a]>0&&(r=Math.ceil(Math.random()*gamedata.owned_cards[a]*1));var s=Math.ceil(all_available_cards[a].value*r*(1+Math.random()*(5/get_upgrade_factor("merchant_"+t,void 0,!0))));"buy"==t&&(s=Math.ceil(all_available_cards[a].value*r*(Math.random()*(get_upgrade_factor("merchant_"+t,void 0,!0)-1)+1))),n={card_id:a,buysell:t,card_amount:r,offer_price:s,offer_expires:new Date().addHours(1)}}return n}function show_upgrade_building(){if(void 0==gamedata.town[current_building_id])show_content("town");else{var e=all_buildings[gamedata.town[current_building_id].building_id];$(".upgrade_content").html("");var t=0;void 0!=gamedata.owned_cards[e.fragment_id]&&(t=gamedata.owned_cards[e.fragment_id]);var a=calculate_upgrade_cost(gamedata.town[current_building_id].level),o=parse_card(e.fragment_id,t+" / "+a);t<a&&(o=parse_card(e.fragment_id,'<span style="color:red">'+t+" / "+a+"</span>")),gamedata.scraps<a*building_scraps_cost?o+=parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(a*building_scraps_cost)+"</span>"):o+=parse_card("scraps_placeholder",""+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(a*building_scraps_cost)),$(".upgrade_content").append('<div class="fragment_cost">'+o+"</div>"),$(".upgrade_content").append('<div class="construction_name">'+capitalizeFirstLetter(e.name)+"</div>"),gamedata.owned_cards[e.fragment_id]<a||gamedata.scraps<a*building_scraps_cost?$(".upgrade_content").append('<div class="construction_description">'+capitalizeFirstLetter(e.upgrade_description)+"</div>"):($(".upgrade_content").append('<div class="construction_description">'+capitalizeFirstLetter(e.upgrade_description)+"</div>"),$(".upgrade_content").append('<div onclick="upgrade_current_building()" class="construction_button">UPGRADE</div>'))}}function calculate_upgrade_cost(e){return Math.floor(base_building_cost*(e*(1+e/2)))}function show_delete_building(){for(var e=base_building_cost,t=gamedata.town[current_building_id].level-1;t>0;t--)e+=calculate_upgrade_cost(t);$(".returned_fragments").html(e)}function delete_current_building(){if(void 0==gamedata.town[current_building_id])show_content("town");else{var e,t=gamedata.town[current_building_id];all_current_rewards={0:{reward_id:all_buildings[t.building_id].fragment_id,reward_amount:base_building_cost}},current_reward_text="The building has been destroyed.",current_reward_origin="town",delete gamedata.town[current_building_id],saveToLocalStorage(),show_content("current_rewards")}}function show_new_mission(){if(void 0==gamedata.town[current_building_id])show_content("town");else{$(".new_expedition_content").html("");var e=0,t=0,a="",o=gamedata.town[current_building_id],n=all_buildings[o.building_id];o.level,$.each(n.expeditions,function(o,n){if(void 0!=all_expeditions[n]){""==a&&(a=""+n),e+=1;var r=all_expeditions[n],s=!0,c="";c+='<div class="single_new_expedition">',c+='<div class="single_new_expedition_name">',c+=capitalizeFirstLetter(r.name),c+="</div>",c+=r.description,count_object(r.costs)>0&&(c+="<b>Cost:</b>"),c+='<div class="expedition_costs">',$.each(r.costs,function(e,a){t+=1;var o="";if("scraps"==e&&gamedata.scraps<a&&(s=!1,o='style="color:#c33;"'),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<a)&&(s=!1,o='style="color:#c33;"'),"scraps"==e&&(c+='Scraps: <span class="expedition_cost_amount" '+o+">"+gamedata.scraps+" / "+a+"</span><br/>"),void 0!=all_available_cards[e]){var n=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(n=gamedata.owned_cards[e]),c+=capitalizeFirstLetter(all_available_cards[e].name)+': <span class="expedition_cost_amount" '+o+">"+n+" / "+a+"</span><br/>"}}),c+="</div>",void 0!=r.rewards&&(c+="<b>Possible rewards</b>",c+='<div class="possible_rewards">',$.each(r.rewards,function(e,t){if("scraps"==e){var a=parse_card("scraps_placeholder");c+="<div onclick=\"show_card_details('scraps_placeholder')\">"+a+"</div>"}if("potion"==e){var a=parse_card("potion_placeholder");c+="<div>"+a+"</div>"}if(void 0!=all_available_cards[e]){var a=parse_card(e);c+="<div onclick=\"show_card_details('"+e+"')\">"+a+"</div>"}}),c+='<div style="clear:both;"></div>',c+="</div>"),!0==s&&(c+='<div class="start_new_expedition" onclick="start_new_expedition(\''+n+"')\">START</div>"),c+="</div>",$(".new_expedition_content").append(c)}}),$.each(n.adventures,function(a,o){if(void 0!=all_adventures[o]){e+=1,console.log(o);var n=all_adventures[o],r=!0,s="";s+='<div class="single_new_expedition">',s+='<div class="single_new_expedition_name">',s+=capitalizeFirstLetter(n.name),s+="</div>",s+=n.description,count_object(n.costs)>0&&(s+="<b>Cost:</b>"),s+='<div class="expedition_costs">',$.each(n.costs,function(e,a){t+=1;var o="";if("scraps"==e&&gamedata.scraps<a&&(r=!1,o='style="color:#c33;"'),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<a)&&(r=!1,o='style="color:#c33;"'),"scraps"==e&&(s+='Scraps: <span class="expedition_cost_amount" '+o+">"+gamedata.scraps+" / "+a+"</span><br/>"),void 0!=all_available_cards[e]){var n=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(n=gamedata.owned_cards[e]),s+=capitalizeFirstLetter(all_available_cards[e].name)+': <span class="expedition_cost_amount" '+o+">"+n+" / "+a+"</span><br/>"}}),s+="</div>",void 0!=n.rewards&&(s+="<b>Possible rewards</b>",s+='<div class="possible_rewards">',$.each(n.rewards,function(e,t){if("scraps"==e){var a=parse_card("scraps_placeholder");s+="<div onclick=\"show_card_details('scraps_placeholder')\">"+a+"</div>"}if(void 0!=all_available_cards[e]){var a=parse_card(e);s+="<div onclick=\"show_card_details('"+e+"')\">"+a+"</div>"}}),s+='<div style="clear:both;"></div>',s+="</div>"),!0==r&&(s+='<div class="start_new_expedition" onclick="current_adventure=\''+o+"';current_adventure_units={};show_content('adventure_units')\">START</div>"),s+="</div>",$(".new_expedition_content").append(s)}}),1==e&&0==t&&void 0!=a&&start_new_expedition(a)}}function show_new_expedition(){if(void 0==gamedata.town[current_building_id])show_content("town");else{$(".new_expedition_content").html("");var e=gamedata.town[current_building_id],t=all_buildings[e.building_id];e.level,void 0==t.expeditions?show_content("town"):$.each(t.expeditions,function(e,t){if(void 0!=all_expeditions[t]){var a=all_expeditions[t],o=!0,n="";n+='<div class="single_new_expedition">',n+='<div class="single_new_expedition_name">',n+=capitalizeFirstLetter(a.name),n+="</div>",n+=a.description,count_object(a.costs)>0&&(n+="<b>Cost:</b>"),n+='<div class="expedition_costs">',$.each(a.costs,function(e,t){var a="";if("scraps"==e&&gamedata.scraps<t&&(o=!1,a='style="color:#c33;"'),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<t)&&(o=!1,a='style="color:#c33;"'),"scraps"==e&&(n+='Scraps: <span class="expedition_cost_amount" '+a+">"+gamedata.scraps+" / "+t+"</span><br/>"),void 0!=all_available_cards[e]){var r=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(r=gamedata.owned_cards[e]),n+=capitalizeFirstLetter(all_available_cards[e].name)+': <span class="expedition_cost_amount" '+a+">"+r+" / "+t+"</span><br/>"}}),n+="</div>",void 0!=a.rewards&&(n+="<b>Possible rewards</b>",n+='<div class="possible_rewards">',$.each(a.rewards,function(e,t){if("scraps"==e){var a=parse_card("scraps_placeholder");n+="<div onclick=\"show_card_details('scraps_placeholder')\">"+a+"</div>"}if(void 0!=all_available_cards[e]){var a=parse_card(e);n+="<div onclick=\"show_card_details('"+e+"')\">"+a+"</div>"}}),n+='<div style="clear:both;"></div>',n+="</div>"),!0==o&&(n+='<div class="start_new_expedition" onclick="start_new_expedition(\''+t+"')\">START</div>"),n+="</div>",$(".new_expedition_content").append(n)}})}}function show_new_adventure(){if(void 0==gamedata.town[current_building_id])show_content("town");else{$(".new_expedition_content").html("");var e=gamedata.town[current_building_id],t=all_buildings[e.building_id];e.level,void 0==t.adventures?show_content("town"):$.each(t.adventures,function(e,a){if(void 0!=all_adventures[a]){var o=all_adventures[a],n=!0,r="";r+='<div class="single_new_expedition">',r+='<div class="single_new_expedition_name">',r+=capitalizeFirstLetter(o.name),r+="</div>",r+=o.description,count_object(o.costs)>0&&(r+="<b>Cost:</b>"),r+='<div class="expedition_costs">',$.each(o.costs,function(e,t){var a="";if("scraps"==e&&gamedata.scraps<t&&(n=!1,a='style="color:#c33;"'),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<t)&&(n=!1,a='style="color:#c33;"'),"scraps"==e&&(r+='Scraps: <span class="expedition_cost_amount" '+a+">"+gamedata.scraps+" / "+t+"</span><br/>"),void 0!=all_available_cards[e]){var o=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(o=gamedata.owned_cards[e]),r+=capitalizeFirstLetter(all_available_cards[e].name)+': <span class="expedition_cost_amount" '+a+">"+o+" / "+t+"</span><br/>"}}),r+="</div>",void 0!=o.rewards&&(r+="<b>Possible rewards</b>",r+='<div class="possible_rewards">',$.each(o.rewards,function(e,t){if("scraps"==e){var a=parse_card("scraps_placeholder");r+="<div onclick=\"show_card_details('scraps_placeholder')\">"+a+"</div>"}if(void 0!=all_available_cards[e]){var a=parse_card(e);r+="<div onclick=\"show_card_details('"+e+"')\">"+a+"</div>"}}),r+='<div style="clear:both;"></div>',r+="</div>"),!0==n&&(r+='<div class="start_new_expedition" onclick="current_adventure=\''+a+"';current_adventure_units={};show_content('adventure_units')\">START</div>"),r+="</div>",$(".new_expedition_content").append(r),1==count_object(t.adventures)&&(void 0==o.costs||0==count_object(o.costs))?($(".single_adventure_back").show(),$(".multiple_adventure_back").hide(),current_adventure=a,current_adventure_units={},show_content("adventure_units")):($(".single_adventure_back").hide(),$(".multiple_adventure_back").show())}})}}var current_adventure_units_page=1;function show_adventure_units(){var e=!1;if($(".selected_adventure_units").html(""),void 0==all_adventures[current_adventure])show_content("town");else{for(var t=all_adventures[current_adventure],a="",o=0;o<t.unit_count;o++){var n='<div class="adventure_unit">';void 0!=current_adventure_units[o]&&(void 0==all_available_cards[current_adventure_units[o]]||gamedata.owned_cards[current_adventure_units[o]]<1?delete current_adventure_units[o]:(n+='<div onclick="remove_adventure_unit('+o+')">'+parse_card(current_adventure_units[o])+"</div>",e=!0)),n+="</div>",a+=n}$(".selected_adventure_units").html(a),$(".creature_type_filter").prop("checked",!0),$(".adventure_units_list").html("");var r="",s=0;$.each(all_available_cards,function(e,a){var o=0;void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(o=gamedata.owned_cards[e]),$.each(current_adventure_units,function(t,a){e==a&&(o-=1)});var n=!0;if("matched"==suggest_mode&&(n=!1,$.each(a.abilities,function(e,a){!0==match_array_values(t.ability_suggestions,e)&&(n=!0)}),void 0!=a.subtypes&&void 0!=t.ability_suggestions&&!0==match_array_values(t.ability_suggestions,a.subtypes)&&(n=!0)),!1==check_filters(e)&&"creature"==a.type&&o>0&&!0==n&&++s>8*current_adventure_units_page-8&&s<=8*current_adventure_units_page){var c=parse_card(e,o);void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&(r+="<div onclick=\"add_adventure_unit('"+e+"')\">"+c+"</div>")}}),s>8?($("#content_adventure_units .page_selection").show(),1==current_adventure_units_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),s/8<=current_adventure_units_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),0==s?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_adventure_units_page+" / "+Math.ceil(s/8))):$("#content_adventure_units .page_selection").hide(),s>0&&Math.ceil(s/8)<current_adventure_units_page?(current_adventure_units_page=1,show_adventure_units()):""!=r&&$(".adventure_units_list").html(""+r),!0==e&&$(".selected_adventure_units").append('<div class="start_new_expedition" onclick="start_adventure()">START</div>')}}function start_adventure(){var e=all_adventures[current_adventure],t=!0;if($.each(e.costs,function(e,a){"scraps"==e&&gamedata.scraps<a?t=!1:"scraps"==e&&(gamedata.scraps-=a),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<a)?t=!1:void 0!=all_available_cards[e]&&(gamedata.owned_cards[e]-=a)}),$.each(current_adventure_units,function(e,t){void 0!=gamedata.owned_cards[t]&&gamedata.owned_cards[t]>0&&(gamedata.owned_cards[t]-=1)}),!0==t&&void 0!=gamedata.town[current_building_id]&&count_object(current_adventure_units)>0){void 0==gamedata.town[current_building_id].adventures&&(gamedata.town[current_building_id].adventures={});var a=get_highest_key_in_object(gamedata.town[current_building_id].adventures)+1,o=new Date().getTime()+1e3*e.time;gamedata.town[current_building_id].adventures[a]={adventure_id:current_adventure,done_time:o,units:current_adventure_units},saveToLocalStorage()}show_content("single_building")}function complete_adventure(e){var t=gamedata.town[current_building_id],a=t.adventures[e],o=all_adventure_results[get_random_key_from_object_based_on_num_value(all_adventures[a.adventure_id].results)],n=o.base_success+0;$.each(o.bonus_success,function(e,t){$.each(a.units,function(a,o){var r=all_available_cards[o];"number"==typeof t&&void 0!=r[e]&&"number"==typeof r[e]&&r[e]>0&&(n+=t*r[e]),"object"==typeof t&&void 0!=r[e]&&"object"==typeof r[e]&&$.each(t,function(t,a){void 0!=r[e][t]&&"number"==typeof r[e][t]&&(n+=a*r[e][t]),void 0!=r[e][t]&&"object"==typeof r[e][t]&&(n+=a),!0==match_array_values(t,r[e])&&(n+=a)})})}),(void 0==o.base_success||o.base_success<=90)&&n>90&&(n=90),console.log("success chance: "+n);var r={};$.each(a.units,function(e,t){r[e]=0,void 0==o.survive_chance?r[e]=100:r[e]=o.survive_chance,$.each(o.bonus_survive,function(a,o){var n=all_available_cards[t];void 0!=n[a]&&"number"==typeof n[a]&&n[a]>0&&(r[e]+=o*n[a]),"object"==typeof o&&void 0!=n[a]&&"object"==typeof n[a]&&$.each(o,function(t,o){void 0!=n[a][t]&&"number"==typeof n[a][t]&&(r[e]+=o*n[a][t]),void 0!=n[a][t]&&"object"==typeof n[a][t]&&(r[e]+=o),!0==match_array_values(t,n[a])&&(r[e]+=o)})}),void 0!=o.survive_chance&&o.survive_chance<90&&r[e]>90&&(r[e]=90),console.log("survive chance: "+t+" "+r[e])}),all_current_rewards={},current_reward_origin="single_building",current_reward_text="";var s=!1;$.each(a.units,function(e,t){r[e]>=100*Math.random()&&(s=!0,all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t,reward_amount:1,no_faction:!0})}),n>=100*Math.random()&&!0==s?(current_reward_text=o.success_text,$.each(o.rewards,function(e,t){var a=round_by_percent(Math.random()*(t.max-t.min))+t.min;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:a}})):current_reward_text=!0==s?o.fail_text:o.no_return_text,delete t.adventures[e],show_content("current_rewards")}function cancel_adventure(e){var t=gamedata.town[current_building_id],a=t.adventures[e];all_adventure_results[get_random_key_from_object_based_on_num_value(all_adventures[a.adventure_id].results)],all_current_rewards={},current_reward_origin="single_building",current_reward_text="",$.each(a.units,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t,reward_amount:1,no_faction:!0}}),delete t.adventures[e],show_content("current_rewards")}function set_adventure_units_page(e){(current_adventure_units_page+=e)<1&&(current_adventure_units_page=1),show_adventure_units()}function remove_adventure_unit(e){delete current_adventure_units[e],show_adventure_units()}function add_adventure_unit(e){for(var t=-1,a=all_adventures[current_adventure],o=0;o<a.unit_count;o++)void 0==current_adventure_units[o]&&-1==t&&(t=o);-1!=t&&(current_adventure_units[t]=e),show_adventure_units()}function start_new_expedition(e){$(".new_expedition_content").html("");var t=all_expeditions[e],a=!0;if($.each(t.costs,function(e,t){"scraps"==e&&gamedata.scraps<t?a=!1:"scraps"==e&&(gamedata.scraps-=t),void 0!=all_available_cards[e]&&(void 0==gamedata.owned_cards[e]||gamedata.owned_cards[e]<t)?a=!1:void 0!=all_available_cards[e]&&(gamedata.owned_cards[e]-=t)}),!0==a&&void 0!=gamedata.town[current_building_id]){void 0==gamedata.town[current_building_id].expeditions&&(gamedata.town[current_building_id].expeditions={});var o=get_highest_key_in_object(gamedata.town[current_building_id].expeditions)+1,n=new Date().getTime()+1e3*t.time;gamedata.town[current_building_id].expeditions[o]={expedition_id:e,done_time:n},saveToLocalStorage()}show_content("single_building")}function complete_expedition(e){var t=gamedata.town[current_building_id];all_buildings[t.building_id],t.level;var a=t.expeditions[e],o=all_expeditions[a.expedition_id];if(current_reward_origin="single_building",current_reward_text="",void 0!=a&&a.done_time<=new Date().getTime()){if(all_current_rewards={},void 0==o.possible_results){if(void 0!=o.allways_rewards&&$.each(o.allways_rewards,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:t}}),void 0==o.success_chance||100*Math.random()<o.success_chance){current_reward_text=o.success_text,void 0!=o.success_rewards&&$.each(o.success_rewards,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:t}});var n=1;void 0!=o.success_picks&&(n=o.success_picks);for(var r=1;r<=n;r++){var s=get_random_key_from_object(o.rewards),c=Math.floor(Math.random()*o.rewards[s]+o.rewards[s]);c<1&&(c=1),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:s,reward_amount:c}}}else if(current_reward_text=o.fail_text,void 0!=o.fail_rewards){var s=get_random_key_from_object(o.fail_rewards),c=Math.floor(Math.random()*o.fail_rewards[s]+o.fail_rewards[s]);c<1&&(c=1),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:s,reward_amount:c}}}else{var s=get_random_key_from_object_based_on_num_value(o.possible_results);if(void 0!=all_expedition_results[s]&&(current_reward_text=all_expedition_results[s].text,$.each(all_expedition_results[s].base_rewards,function(e,t){var a=round_by_percent(Math.random()*(t.max-t.min))+t.min;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:a}}),void 0!=all_expedition_results[s].additional_reward_picks))for(var r=1;r<=all_expedition_results[s].additional_reward_picks;r++){var d=get_random_key_from_object_based_on_num_value(all_expedition_results[s].additional_reward_chances),l=all_expedition_results[s].additional_rewards[d],u=round_by_percent(Math.random()*(l.max-l.min))+l.min;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d,reward_amount:u}}}delete gamedata.town[current_building_id].expeditions[e]}show_content("current_rewards")}function cancel_expedition(e){var t=gamedata.town[current_building_id];all_buildings[t.building_id],t.level;var a=t.expeditions[e],o=all_expeditions[a.expedition_id];current_reward_origin="single_building",current_reward_text="",do_no_apply_factions=!0,all_current_rewards={},void 0!=o.costs&&$.each(o.costs,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:t}}),delete gamedata.town[current_building_id].expeditions[e],saveToLocalStorage(),show_content("current_rewards")}function show_current_rewards(){$(".current_rewards_content").html("");var e="",t=0,a=0,o=!1,n=!1,r=!1,s=!1,c=!1,d=count_object(all_current_rewards);$.each(all_current_rewards,function(e,t){"scraps_placeholder"==t.reward_id&&(t.reward_id="scraps"),0==all_current_rewards[e].reward_amount?delete all_current_rewards[e]:$.each(all_current_rewards,function(a,o){void 0!=all_current_rewards[a]&&t.reward_id==o.reward_id&&e<a&&(all_current_rewards[e].reward_amount+=all_current_rewards[a].reward_amount,delete all_current_rewards[a])})}),void 0!=gamedata.factions&&!1==do_no_apply_factions&&$.each(gamedata.factions,function(e,t){var a=t.level;void 0!=all_factions[e]&&$.each(all_current_rewards,function(t,o){$.each(all_factions[e].loot_bonus,function(e,t){o.reward_id==e&&void 0==o.no_faction&&(o.reward_amount=round_by_percent(o.reward_amount*(1+a*t/100)))})})}),void 0!=gamedata.upgrades&&$.each(all_current_rewards,function(e,t){var a=get_upgrade_factor("loot",[t.reward_id],!0);t.reward_amount=round_by_percent(t.reward_amount*a)}),do_no_apply_factions=!1;var l=0;if($.each(all_current_rewards,function(e,t){void 0!=t.pickable&&!0==t.pickable&&l++}),1==l&&$.each(all_current_rewards,function(e,t){void 0!=t.pickable&&!0==t.pickable&&delete all_current_rewards[e].pickable}),void 0!=current_reward_text&&(e+='<div class="reward_text">'+current_reward_text+"</div>"),$.each(all_current_rewards,function(d,l){if("scraps"==l.reward_id){if(void 0==l.pickable||!1==l.pickable)void 0==gamedata.scraps?gamedata.scraps=l.reward_amount:gamedata.scraps+=l.reward_amount,check_quests("gained_scraps",void 0,l.reward_amount),check_quests("scraps_owned",gamedata.scraps),t+=l.reward_amount;else{var u=parse_card("scraps_placeholder",l.reward_amount);e+='<div class="single_current_reward reward_'+d+'">'+u+'<div class="menu_button slim pick_reward_button" onclick="pick_reward('+d+')">PICK</div></div>'}}if("potion"==l.reward_id){var m=get_random_upgrade("potion"),v=!1;void 0==gamedata.town[current_building_id]&&(gamedata.town[current_building_id]={building_id:"alchemist"}),void 0==gamedata.town[current_building_id].potions&&(gamedata.town[current_building_id].potions={}),void 0==gamedata.town[current_building_id].potions[m]&&(v=!0);var u=parse_card("potion_placeholder",void 0,void 0,all_upgrades[m].name);!1==v?(void 0==gamedata.upgrades[m]?gamedata.upgrades[m]=1:gamedata.upgrades[m]++,e+='<div class="single_current_reward">'+u+"</div>"):(gamedata.town[current_building_id].potions[m]=!0,e+='<div class="single_current_reward glowing_reward">'+u+"</div>"),saveToLocalStorage()}if("reputation"==l.reward_id&&gain_current_rep(l.reward_amount),void 0!=all_available_cards[l.reward_id]){var p=all_available_cards[l.reward_id].value*l.reward_amount;void 0!=p&&p==a&&void 0!=l.pickable&&!0==l.pickable&&(n=!0),void 0!=p&&p>a&&void 0!=l.pickable&&!0==l.pickable&&(a=p,o=d,n=!1);var f=0,b="";if(void 0!=gamedata.owned_cards[l.reward_id]?f=gamedata.owned_cards[l.reward_id]:b='</div><div class="new_card">NEW',f==r&&void 0!=l.pickable&&!0==l.pickable&&(c=!0),(!1===r||f<r)&&void 0!=l.pickable&&!0==l.pickable&&(r=f,s=d,c=!1),void 0==l.pickable||!1==l.pickable){var h=!1;void 0!=all_available_cards[l.reward_id]&&"recipe"==all_available_cards[l.reward_id].type&&(void 0==gamedata.known_recipes&&(gamedata.known_recipes={}),gamedata.known_recipes[all_available_cards[l.reward_id].recipe]=!0,h=!0),void 0!=all_available_cards[l.reward_id]&&"cardback"==all_available_cards[l.reward_id].type&&(gamedata.owned_card_backs[all_available_cards[l.reward_id].reward.card_back_id]=!0,h=!0),!1==h&&gain_card(l.reward_id,l.reward_amount),void 0!=gamedata.owned_cards[l.reward_id]&&gamedata.owned_cards[l.reward_id]>0&&(f=gamedata.owned_cards[l.reward_id]);var u=parse_card(l.reward_id,l.reward_amount+b);e+='<div class="single_current_reward" onclick="show_card_details(\''+l.reward_id+"')\">"+u+"</div>"}else{var u=parse_card(l.reward_id,l.reward_amount+' <span class="currently_owned">('+f+")</span>");e+='<div class="single_current_reward reward_'+d+' pickable_reward"><div onclick="show_card_details(\''+l.reward_id+"')\">"+u+'</div><div class="menu_button slim pick_reward_button" onclick="pick_reward('+d+')">PICK</div></div>'}}}),t>0){var u=parse_card("scraps_placeholder",t);e+='<div class="single_current_reward">'+u+"</div>"}$.each(all_current_rewards,function(e,t){(void 0==t.pickable||!1==t.pickable)&&delete all_current_rewards[e]}),0==count_object(all_current_rewards)?e+='<div class="claim_current_rewards_button" onclick="show_content(\''+current_reward_origin+"')\">CLAIM</div>":e+='<div class="claim_current_rewards_button hidden" onclick="show_content(\''+current_reward_origin+"')\">CLAIM</div>",$(".current_rewards_content").html(e),!1==n&&!1!==o&&$(".reward_"+o+" .card").addClass("glowing_reward"),!1==c&&!1!==s&&$(".reward_"+s+" .card").addClass("glowing_reward"),saveToLocalStorage(),0==d&&""==current_reward_text&&show_content(current_reward_origin)}function pick_reward(e){$(".single_current_reward .card").removeClass("glowing_reward"),$.each(all_current_rewards,function(t,a){if(t==e){if("scraps"==a.reward_id){void 0==gamedata.scraps?gamedata.scraps=a.reward_amount:gamedata.scraps+=a.reward_amount,$(".reward_"+t+" .card").remove();var o=parse_card("scraps_placeholder",a.reward_amount);$(".reward_"+t+" div").append(o)}if(void 0!=all_available_cards[a.reward_id]){check_quests("card_picked_"+a.reward_id),gain_card(a.reward_id,a.reward_amount),$(".reward_"+t+" .card").remove();var o=parse_card(a.reward_id,a.reward_amount);$(".reward_"+t+" div").append(o)}$(".reward_"+t).css("overflow","visible"),$(".reward_"+t+" .pick_reward_button").remove()}else $(".reward_"+t).css("width","0px"),$(".reward_"+t).css("margin-left","0px"),$(".reward_"+t).css("margin-right","0px"),$(".reward_"+t).css("overflow","hidden"),$(".reward_"+t+" .pick_reward_button").remove();delete all_current_rewards[t]}),$(".claim_current_rewards_button").removeClass("hidden")}function return_exp_cost(e){var t=all_expeditions[e];$.each(t.costs,function(e,t){"scraps"==e&&(gamedata.scraps+=t),void 0!=all_available_cards[e]&&gain_card(e)})}function show_building_recipes(){var e=gamedata.town[current_building_id],t=all_buildings[e.building_id],a="",o={};return o.ability="",""!=$(".ability_filter").val()&&(o.ability=$(".ability_filter").val()),o.name="",""!=$(".name_filter").val()&&(o.name=$(".name_filter").val()),void 0==t.recipes?show_content("town"):($(".building_recipes_content").html(""),$.each(t.recipes,function(e,t){if(""==check_defeated_heroes(t.available)&&(0==count_object(t.costs)&&void 0!=all_available_cards[e].recipe&&(t.costs=all_available_cards[e].recipe),check_filters(e),1)){void 0==gamedata.owned_cards[e]&&(gamedata.owned_cards[e]=0);var o="",n=parse_card(e,gamedata.owned_cards[e]),r=!0;o+='<div class="single_building_recipe">',o+='<span class="single_building_recipe_result" onclick="show_card_details(\''+e+"')\">"+n+"</span>",o+='<div class="single_building_recipe_costs">',void 0!=all_available_cards[e].quote&&""!=all_available_cards[e].quote&&(o+="<span><i>"+all_available_cards[e].quote+"</i><br/><br/></span>");var s=1;void 0!=t.costs_increas_factor&&(s=to_the_nth(1,gamedata.owned_cards[e],t.costs_increas_factor)),$.each(t.costs,function(e,t){var a=0;"scraps"==e&&(a=gamedata.scraps),void 0!=gamedata.owned_cards[e]&&(a=gamedata.owned_cards[e]);var n="Scraps";if(void 0!=all_available_cards[e]&&(n=capitalizeFirstLetter(all_available_cards[e].name)),a<Math.floor(t*s)){r=!1;var c=n+': <span style="color:red">'+nFormatter(a,3)+" / "+nFormatter(Math.floor(t*s),3)+"</span>"}else var c=n+': <span style="">'+nFormatter(a,3)+" / "+nFormatter(Math.floor(t*s),3)+"</span>";o+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+e+"')\">"+c+"</div>"}),o+="</div>",o+='<div class="single_building_recipe_arrow"><</div>',!0==r&&(o+='<div class="single_building_recipe_craft_button" onclick="craft_local_card(\''+e+"')\">BUY</div>"),o+='<div style="clear:both"></div>',o+="</div>",a+=o}})),a}function craft_local_card(e){var t=gamedata.town[current_building_id],a=all_buildings[t.building_id].recipes[e];0==count_object(a.costs)&&void 0!=all_available_cards[e].recipe&&(a.costs=all_available_cards[e].recipe);var o=1;if(void 0!=a.costs_increas_factor&&(o=to_the_nth(1,gamedata.owned_cards[e],a.costs_increas_factor)),void 0!=all_available_cards[e]){var n=!0;$.each(a.costs,function(e,t){var a=0;"scraps"==e&&(a=gamedata.scraps),void 0!=gamedata.owned_cards[e]&&(a=gamedata.owned_cards[e]),a<Math.floor(t*o)&&(n=!1)}),!0==n&&($.each(a.costs,function(e,t){void 0!=gamedata.owned_cards[e]&&(gamedata.owned_cards[e]-=Math.floor(t*o)),"scraps"==e&&(gamedata.scraps-=Math.floor(t*o))}),gain_card(e),show_available_cards(!1),saveToLocalStorage()),show_single_building()}}function learn_local_recipe(e){var t=gamedata.town[current_building_id],a=all_buildings[t.building_id].recipe_shop[e];if(void 0!=all_available_cards[e]&&void 0==gamedata.known_recipes[e]){var o=!0;$.each(a.cost,function(e,t){var a=0;e="scraps",a=gamedata.scraps,void 0!=gamedata.owned_cards[e]&&(a=gamedata.owned_cards[e]),a<t&&(o=!1)}),!0==o&&($.each(a.cost,function(e,t){void 0!=gamedata.owned_cards[e]&&(gamedata.owned_cards[e]-=t),"scraps"==e&&(gamedata.scraps-=t)}),gamedata.known_recipes[e]=!0,show_available_cards(!1),saveToLocalStorage(),show_single_building(e))}}function update_all_timers(){$(".timer").each(function(e){var t=$(this).attr("data-complete-time"),a=new Date().getTime(),o=t-a;if(o>0)o>=1e3&&toHHMMSS(Math.floor(o/1e3)),$(this).html("");else if(void 0!=$(this).attr("data-complete-show")&&($(this).addClass("hidden"),$("."+$(this).attr("data-complete-show")).removeClass("hidden")),void 0!=$(this).attr("data-complete-hide")&&$("."+$(this).attr("data-complete-hide")).addClass("hidden"),void 0!=$(this).attr("data-complete-function")){var n=window[$(this).attr("data-complete-function")];"function"==typeof n&&n()}}),clearTimeout(timer_timeout),timer_timeout=setTimeout(function(){update_all_timers()},1e3)}function toHHMMSS(e){var t=parseInt(e,10);return[Math.floor(t/3600/24),Math.floor(t/3600)%24,Math.floor(t/60)%60,t%60].map(e=>e<10?"0"+e:e).filter((e,t)=>"00"!==e||t>0).join(":")}var timer_timeout=setTimeout(function(){update_all_timers()},1e3),daily_reward_claimable=!1;function show_daily_reward(e){var t=new Date().getMonth()+1,a=new Date().getDate();if(void 0!=e&&(t=e),void 0==gamedata.daily_rewards&&(gamedata.daily_rewards={},gamedata.daily_rewards.free_picks=0,gamedata.daily_rewards.current_month=t,gamedata.daily_rewards.last_claimed=a-1,saveToLocalStorage()),void 0==gamedata.daily_rewards.available_rewards||18>count_object(gamedata.daily_rewards.available_rewards)){gamedata.daily_rewards.available_rewards={};for(var o=1;o<=18;o++){18==o&&(o=40);var n=8*o+5,r=get_random_reward(n,t);if(void 0!=gamedata.daily_rewards.available_rewards[o-1]&&gamedata.daily_rewards.available_rewards[o-1].reward==r&&(r=get_random_reward(n,t)),void 0!=all_available_cards[r]){var s=round_by_percent(o*(1+o/5)/all_available_cards[r].value);s<1&&(s=1),gamedata.daily_rewards.available_rewards[o]={reward:r,amount:s}}}saveToLocalStorage()}$(".daily_reward_content").html("");var c=0,d=!1;$.each(gamedata.daily_rewards.available_rewards,function(e,t){if(void 0!=all_available_cards[t.reward]){var a="",o="";c+=t.amount,t.amount<1&&(o=" claimed "),a+='<div class="single_reward '+o+'" onclick="show_card_details(\''+t.reward+"')\">";var n="";void 0!=all_available_cards[t.reward].image_position&&(n="background-position:"+all_available_cards[t.reward].image_position+";"),a+='<div class="background" style="background-image:url(images/'+all_available_cards[t.reward].image+");"+n+'"></div>',t.amount>1&&(a+='<div class="daily_reward_amount">x'+t.amount+"</div>"),a+=e+"</div>",$(".daily_reward_content").append(a)}else d=!0}),(gamedata.daily_rewards.last_claimed!=a||gamedata.daily_rewards.free_picks>0)&&c>0?(daily_reward_claimable=!0,gamedata.daily_rewards.free_picks>0?$(".daily_reward_content").append('<div class="claim_daily_reward_button" onclick="claim_daily_reward()">CLAIM ('+gamedata.daily_rewards.free_picks+")</div>"):$(".daily_reward_content").append('<div class="claim_daily_reward_button" onclick="claim_daily_reward()">CLAIM</div>')):daily_reward_claimable=!1,(!0==d||c<1)&&(gamedata.daily_rewards.available_rewards={},show_daily_reward())}function get_random_reward(e,t){var a={};return $.each(all_available_cards,function(o,n){if(n.value<=e&&n.value>e/2e7&&n.pick_chance>0&&"cardback"!=n.type){if(void 0!=n.months_available&&!0==match_array_values([t],n.months_available)){if(n.value<=2*e){var r=3*n.value/e;r<10&&(r=10),a[o]=r}}else a[o]=n.value/e}}),get_random_key_from_object_based_on_num_value(a)}function claim_daily_reward(){var e=new Date().getDate(),t=!1;(gamedata.daily_rewards.last_claimed!=e||gamedata.daily_rewards.free_picks>0)&&(gamedata.daily_rewards.last_claimed!=e?gamedata.daily_rewards.last_claimed=e:gamedata.daily_rewards.free_picks-=1,$.each(gamedata.daily_rewards.available_rewards,function(e,a){a.amount>0&&!1==t&&(current_battle_type="daily",endless_waves=!1,fixed_hero=!1,current_reward_origin="daily_reward",(all_current_rewards={})[get_highest_key_in_object(all_current_rewards)+1]={reward_id:a.reward,reward_amount:a.amount},t=!0,add_basic_win_rewards(sqr(e)*get_upgrade_factor("summon_reward","any",!0)),gamedata.daily_rewards.available_rewards[e].amount=0,saveToLocalStorage())})),!0==t?show_content("current_rewards"):show_daily_reward()}var current_inventory_page=1,current_consumable="";function show_inventory(){cards_per_page=12,$(".inventory_content").html('<span class="no_tinker">You have no consumables.</span>'),gamedata.owned_cards=sortObj(gamedata.owned_cards);var e=0;$.each(gamedata.owned_cards,function(t,a){if(void 0!=all_available_cards[t]){var o=a+0,n=!1;if("consumable"!=all_available_cards[t].type&&"token"!=all_available_cards[t].type&&"currency"!=all_available_cards[t].type&&"material"!=all_available_cards[t].type&&"treasure"!=all_available_cards[t].type&&(n=!0),o>0&&!1==n&&!1==check_filters(t)&&(1==++e&&$(".inventory_content").html(""),e/cards_per_page>current_inventory_page-1&&e/cards_per_page<=current_inventory_page)){var r=parse_card(t,o);("consumable"==all_available_cards[t].type||"cardback"==all_available_cards[t].type)&&$(".inventory_content").append("<span onclick=\"current_consumable='"+t+"';show_content('single_consumable');\">"+r+"</span>"),("token"==all_available_cards[t].type||"currency"==all_available_cards[t].type||"material"==all_available_cards[t].type||"treasure"==all_available_cards[t].type)&&$(".inventory_content").append("<span onclick=\"show_card_details('"+t+"');\">"+r+"</span>")}}else delete gamedata.owned_cards[t]}),1==current_inventory_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),e/cards_per_page<=current_inventory_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),e>0&&Math.ceil(e/cards_per_page)<current_inventory_page&&(current_inventory_page=1,show_inventory()),0==e?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_inventory_page+" / "+Math.ceil(e/cards_per_page))}function set_inventory_page(e){(current_inventory_page+=e)<1&&(current_inventory_page=1),show_inventory()}function show_single_consumable(){if(void 0==gamedata.owned_cards[current_consumable]||void 0==all_available_cards[current_consumable]||0==gamedata.owned_cards[current_consumable])show_content("inventory");else{$(".single_consumable_content").html("");var e=parse_card(current_consumable,gamedata.owned_cards[current_consumable]);$(".single_consumable_content").append('<div class="fragment_cost" onclick="show_card_details(\''+current_consumable+"')\">"+e+"</div>");var t="";if(t+='<div class="construction_description">',t+='<div class="construction_name">'+capitalizeFirstLetter(all_available_cards[current_consumable].name)+"</div><br/>",void 0!=all_available_cards[current_consumable].reward&&void 0!=all_available_cards[current_consumable].reward.description&&(t+=capitalizeFirstLetter(all_available_cards[current_consumable].reward.description)+"<br/><br/>"),void 0!=all_available_cards[current_consumable].reward&&"boost"==all_available_cards[current_consumable].reward.type){var a=0;void 0!=gamedata.combat_boosts&&void 0!=gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]&&(a=gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]),a<1?t+="Boost not active":t+="Boosts active: "+a+" uses left"}if(void 0!=all_available_cards[current_consumable].reward&&"loot_charges"==all_available_cards[current_consumable].reward.type){var a=0;void 0!=gamedata.loot_charges&&(a=gamedata.loot_charges),a<1?t+="You have no current loot bonus.":t+="The next time you receive random loot the stack size will be increased by "+a+"."}if(void 0!=all_available_cards[current_consumable].reward&&"loot_rarity"==all_available_cards[current_consumable].reward.type){var a=0;void 0!=gamedata.loot_rarity&&(a=gamedata.loot_rarity),a<1?t+="You have no current loot bonus.":t+="The chance of rare loot is increased by "+a+"%."}t+="</div>",$(".single_consumable_content").append(t);var o='<div class="use_inventory_buttons">';if(void 0!=all_available_cards[current_consumable].reward){var n=!0;"card_back"==all_available_cards[current_consumable].reward.type&&void 0!=gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]&&(n=!1),!0==n&&("card_back"==all_available_cards[current_consumable].reward.type?o+='<div onclick="use_current_inventory()" class="use_inventory_button">COLLECT</div>':void 0==all_available_cards[current_consumable].reward.amount_used?o+='<div onclick="use_current_inventory()" class="use_inventory_button">USE</div>':$.each(all_available_cards[current_consumable].reward.amount_used,function(e,t){"all"!=t&&gamedata.owned_cards[current_consumable]>=t&&(o+='<div onclick="use_current_inventory('+t+')" class="use_inventory_button">USE '+t+"</div>"),"all"==t&&gamedata.owned_cards[current_consumable]>1&&(o+='<div onclick="use_current_inventory('+gamedata.owned_cards[current_consumable]+')" class="use_inventory_button">USE ALL</div>')}))}o+="</div>",$(".single_consumable_content").append(o)}}function use_current_inventory(e){if(void 0==e&&(e=1),void 0==gamedata.owned_cards[current_consumable]||void 0==all_available_cards[current_consumable]||0==gamedata.owned_cards[current_consumable])show_content("inventory");else{if(gamedata.owned_cards[current_consumable]-=e,void 0!=all_available_cards[current_consumable].reward){if("card_back"==all_available_cards[current_consumable].reward.type&&(void 0==gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]&&(gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]=!0),saveToLocalStorage(),show_content("inventory")),"function"==all_available_cards[current_consumable].reward.type){var t=window[all_available_cards[current_consumable].reward.execute];"function"==typeof t?!1==t()&&(gamedata.owned_cards[current_consumable]+=e):gamedata.owned_cards[current_consumable]+=e,saveToLocalStorage(),show_content("inventory")}if("reputation"==all_available_cards[current_consumable].reward.type){var a="";"current"==all_available_cards[current_consumable].reward.faction&&void 0!=gamedata.current_faction&&(a=gamedata.current_faction),void 0!=all_factions[all_available_cards[current_consumable].reward.faction]&&(a=all_available_cards[current_consumable].reward.faction),void 0!=all_factions[a]?gain_rep(a,all_available_cards[current_consumable].reward.amount*e):(gamedata.owned_cards[current_consumable]+=e,e=0),saveToLocalStorage(),show_content("single_consumable")}if("random_card"==all_available_cards[current_consumable].reward.type){all_current_rewards={},current_reward_origin="single_consumable",current_reward_text=all_available_cards[current_consumable].reward.text;for(var o=e-1;o>=0;o--){var n=1;void 0!=all_available_cards[current_consumable].reward.pick_amount&&(n=all_available_cards[current_consumable].reward.pick_amount);var r={};for(l=0;l<n;l++){var s=get_random_card_based_on_value(all_available_cards[current_consumable].reward.min_value,all_available_cards[current_consumable].reward.color,all_available_cards[current_consumable].reward.card_type,all_available_cards[current_consumable].reward.all_pick_chance,r,all_available_cards[current_consumable].reward.max_value);!1==s&&(s=get_random_card_based_on_value(all_available_cards[current_consumable].reward.min_value,all_available_cards[current_consumable].reward.color,all_available_cards[current_consumable].reward.card_type,!0,void 0,all_available_cards[current_consumable].reward.max_value)),r[get_highest_key_in_object(r)+1]=s;var c=1;void 0!=all_available_cards[current_consumable].reward.amount&&(c=all_available_cards[current_consumable].reward.amount),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:s,reward_amount:c,pickable:all_available_cards[current_consumable].reward.pickable}}}saveToLocalStorage(),show_content("current_rewards")}if("random_basic_card"==all_available_cards[current_consumable].reward.type){all_current_rewards={},current_reward_origin="single_consumable",current_reward_text=all_available_cards[current_consumable].reward.text;for(var o=e-1;o>=0;o--){var n=1;void 0!=all_available_cards[current_consumable].reward.pick_amount&&(n=all_available_cards[current_consumable].reward.pick_amount);var r={};for(l=0;l<n;l++){var s=get_basic_reward_card(r);!1==s&&(s=get_basic_reward_card(r)),r[get_highest_key_in_object(r)+1]=s;var c=1;void 0!=all_available_cards[current_consumable].reward.amount&&(c=all_available_cards[current_consumable].reward.amount),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:s,reward_amount:c,pickable:all_available_cards[current_consumable].reward.pickable}}}saveToLocalStorage(),show_content("current_rewards")}if("random_card_back"==all_available_cards[current_consumable].reward.type){all_current_rewards={},current_reward_origin="single_consumable",current_reward_text=all_available_cards[current_consumable].reward.text;for(var o=e-1;o>=0;o--){var n=1;void 0!=all_available_cards[current_consumable].reward.pick_amount&&(n=all_available_cards[current_consumable].reward.pick_amount);var r={};for(l=0;l<n;l++){var s=get_back_card_card(r);!1==s&&(s=get_back_card_card(r)),r[get_highest_key_in_object(r)+1]=s;var c=1;void 0!=all_available_cards[current_consumable].reward.amount&&(c=all_available_cards[current_consumable].reward.amount),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:s,reward_amount:c,pickable:all_available_cards[current_consumable].reward.pickable}}}saveToLocalStorage(),show_content("current_rewards")}if("scraps"==all_available_cards[current_consumable].reward.type){all_current_rewards={},current_reward_origin="single_consumable",current_reward_text=all_available_cards[current_consumable].reward.text,current_rewards={};for(var d=0,l=e-1;l>=0;l--){var c=1;void 0!=all_available_cards[current_consumable].reward.amount&&(c=all_available_cards[current_consumable].reward.amount),void 0!=all_available_cards[current_consumable].reward.min_amount&&(c=Math.floor(Math.random()*(c-all_available_cards[current_consumable].reward.min_amount+1))+all_available_cards[current_consumable].reward.min_amount),d+=c}all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:d,pickable:all_available_cards[current_consumable].reward.pickable},saveToLocalStorage(),show_content("current_rewards")}"boost"==all_available_cards[current_consumable].reward.type&&(void 0==gamedata.combat_boosts&&(gamedata.combat_boosts={}),void 0==gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]?gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]=all_available_cards[current_consumable].reward.amount:gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]+=all_available_cards[current_consumable].reward.amount,saveToLocalStorage(),show_content("single_consumable")),"loot_charges"==all_available_cards[current_consumable].reward.type&&(void 0==gamedata.loot_charges&&(gamedata.loot_charges=0),gamedata.loot_charges+=all_available_cards[current_consumable].reward.amount*e,saveToLocalStorage(),show_content("single_consumable")),"loot_rarity"==all_available_cards[current_consumable].reward.type&&(void 0==gamedata.loot_rarity&&(gamedata.loot_rarity=0),gamedata.loot_rarity+=all_available_cards[current_consumable].reward.amount*e,saveToLocalStorage(),show_content("single_consumable"))}e>0&&check_quests("used_consumable_"+current_consumable,void 0,e)}}var current_active_raid={},current_raid_points=0,current_raid_id=0;function show_raids(){$(".refresh_raids_button").addClass("hidden"),$("#content_raids .main_new_raid_button").removeClass("hidden"),$("#content_raids .main_join_raid_button").removeClass("hidden"),$("#content_raids .raids_content").removeClass("full"),get_active_raids_list()}function get_active_raids_list(){void 0!=gamedata.account_id&&($(".raids_content").html('<div class="loading_arena_decks">Loading active raids</div>'),$.post("ajax.php",{data:"get_active_raids",current_id:gamedata.account_id},function(e){count_object(JSON.parse(e))>0?parse_active_raids_list(all_active_raids=JSON.parse(e)):$(".raids_content").html('<div class="loading_arena_decks">No active raids found.</div>')}))}function parse_active_raids_list(e){var t="";$.each(e,function(e,a){a.points_left<0&&(a.points_left=0),t+='<div class="fightable_deck_container">',void 0!=a.hero&&(a.hero=JSON.parse(a.hero),a.user_id==gamedata.account_id?t+='<div class="fightable_deck owned_deck_'+a.active_raid_id+' fightable" onclick="current_raid_id='+a.active_raid_id+';view_raid()">':t+='<div class="fightable_deck owned_deck_'+a.active_raid_id+' not_fightable">',t+='<div class="background" style="background-image:url(images/'+a.hero.image+')"></div>',t+="<span>"+capitalizeFirstLetter(a.raid_name)+"</span>",t+='<div class="wins_losses">',t+="Points: "+parseInt(a.points_earned)+"<br/>",t+="Health: "+parseInt(a.points_left)+" / "+parseInt(a.points),t+="</div>",t+="</div>",deck_found=!0),t+="</div>"}),$("#content_raids .arena_shop_button").removeClass("hidden"),$(".raids_content").html(t)}function view_raid(){$("#content_raids .arena_shop_button").addClass("hidden"),$("#content_raids .main_new_raid_button").addClass("hidden"),$("#content_raids .main_join_raid_button").addClass("hidden"),$("#content_raids .arena_shop_button").addClass("hidden"),void 0!=gamedata.account_id&&($(".raids_content").html('<div class="loading_arena_decks">Loading raid</div>'),$.post("ajax.php",{data:"get_raid",raid_id:current_raid_id},function(e){count_object(JSON.parse(e))>0?parse_active_raid(active_raid=JSON.parse(e)):show_content("raids")}))}function parse_active_raid(e){var t="";$(".refresh_raids_button").removeClass("hidden"),$("#content_raids .raids_content").addClass("full");var a=e[0];a.points_left<0&&(a.points_left=0),a.hero=JSON.parse(a.hero),current_active_raid=a,$("#join_code").val(a.join_code);var o='<div class="contributer_list">';o+="</div>";var n="",r=0;parseInt(a.points_left)>0&&(r=parseInt(a.points_left));var s=0;r>0&&(s=r/parseInt(a.points)*100),n+='<div class="single_raid_container">',n+='<div class="raid_image" style="background-image:url(images/'+a.hero.image+')"></div>',n+='<span class="raid_name">'+capitalizeFirstLetter(a.raid_name)+"<br/></span>",n+='<span class="raid_description"><br/>'+a.description+"<br/><br/>Join code: "+a.join_code+'<span class="copy_code_button" onclick="copy_current_join_code()">Copy code</span></span>',n+='<div class="raid_health"><div class="raid_health_bar" style="width:'+s+'%"></div><span>Health: '+r+" / "+parseInt(a.points)+"</span></div>",n+='<div class="raid_rewards"></div>',n+="</div>",a.points_left>0?n+='<div class="start_raid_button" onclick="start_raid()">ATTACK</div>':n+='<div class="start_raid_button hidden claim_raid_button" onclick="claim_raid()">CLAIM</div>',t=n+o,$(".raids_content").html(t),show_raid_contributers()}function show_raid_rewards(){$(".raid_rewards").html(""),$.post("ajax.php",{data:"get_raid_rewards",raid_id:current_active_raid.raid_id},function(e){e=JSON.parse(e);var t=!1,a=!1;$.each(e,function(e,o){!1==a&&parseInt(o.min_points)<=current_raid_points&&(a=o),parseInt(o.min_points)>current_raid_points&&(t=o)});var o="",n="";!1!=a&&(o+='<div class="raid_reward_block">Current reward<br/>',$.each(JSON.parse(a.rewards),function(e,t){var a=t.reward_id;void 0!=all_available_cards[a]&&(o+='<div class="card_holder" onclick="show_card_details(\''+a+"')\">"+parse_card(a,t.reward_amount)+"</div>"),"scraps"==a&&(o+=parse_card("scraps_placeholder",t.reward_amount))}),o+="</div>"),!1!=t?(n+='<div class="raid_reward_block">Reward at '+t.min_points+" points<br/>",$.each(JSON.parse(t.rewards),function(e,t){var a=t.reward_id;void 0!=all_available_cards[a]&&(n+='<div class="card_holder" onclick="show_card_details(\''+a+"')\">"+parse_card(a,t.reward_amount)+"</div>"),"scraps"==a&&(n+=parse_card("scraps_placeholder",t.reward_amount))}),n+="</div>"):n+='<div class="raid_reward_block">Maximum rewards reached<br/><br/><br/><br/></div>',$(".raid_rewards").html(""+o+n)})}function show_raid_contributers(){current_raid_points=0,void 0!=gamedata.account_id&&($(".contributer_list").html('<div class="loading_arena_decks">Loading</div>'),$.post("ajax.php",{data:"get_raid_contributers",raid_id:current_raid_id},function(e){if(count_object(JSON.parse(e))>0){all_contributers=JSON.parse(e);var t="Contributers<br/>";$.each(all_contributers,function(e,a){if(""!=a.name){var o="";a.user_id==gamedata.account_id&&(o=" current_user "),t+='<div class="single_contributer '+o+'">'+a.name+'<span class="contributed_amount">'+a.points_earned+"</span></div>"}a.user_id==gamedata.account_id&&(current_raid_points=a.points_earned,$(".claim_raid_button").removeClass("hidden"))}),$(".contributer_list").html(t)}show_raid_rewards()}))}function upload_raid_points_gained(e){void 0!=current_active_raid.raid_id&&void 0!=gamedata.account_id&&$.post("ajax.php",{data:"upload_raid_points_gained",current_id:gamedata.account_id,raid_id:current_active_raid.active_raid_id,points:e},function(e){})}function claim_raid(){void 0!=current_active_raid.raid_id&&void 0!=gamedata.account_id&&($(".raids_content").html('<div class="loading_arena_decks">Loading rewards</div>'),$.post("ajax.php",{data:"get_raid_rewards",raid_id:current_active_raid.raid_id},function(e){var t=!1;$.each(JSON.parse(e),function(e,a){!1==t&&parseInt(a.min_points)<=current_raid_points&&(all_current_rewards=JSON.parse(a.rewards),t=!0,current_reward_origin="raids",current_reward_text="The raid has finished.<br/>Claim your reward.",$.post("ajax.php",{data:"clear_raid",raid_id:current_active_raid.active_raid_id,current_id:gamedata.account_id},function(e){check_quests("raid_rewards_claimed"),show_content("current_rewards")}))}),!1==t&&(all_current_rewards={},t=!0,current_reward_origin="raids",current_reward_text="The raid has finished.<br/>You failed to get any rewards.",$.post("ajax.php",{data:"clear_raid",raid_id:current_active_raid.active_raid_id,current_id:gamedata.account_id},function(e){show_content("current_rewards")}))}))}var raid_start_ids={raid_key_1:{cost_id:"raid_key",name:"Basic raid",description:"Start a basic raid",cost_amount:1,raid_type:"basic"}};function show_start_raid(){var e="";$.each(raid_start_ids,function(t,a){var o="";o+='<div class="single_building_recipe">',o+="<h2>"+capitalizeFirstLetter(a.name)+"</h2>",o+='<div class="new_raid_description">'+a.description+"</div>";var n=0;void 0!=gamedata.owned_cards[a.cost_id]&&(n=gamedata.owned_cards[a.cost_id]);var r=parse_card(a.cost_id,n+" / "+a.cost_amount);o+=r,void 0!=gamedata.owned_cards[a.cost_id]&&gamedata.owned_cards[a.cost_id]>=a.cost_amount&&(o+='<div class="start_new_raid_button" onclick="start_new_raid(\''+t+"')\">START</div>"),o+='<div style="clear:both;"></div>',o+="</div>",e+=o}),$(".new_raids_content").html(e)}function start_new_raid(e){var t=raid_start_ids[e];void 0!=gamedata.owned_cards[t.cost_id]&&gamedata.owned_cards[t.cost_id]>=t.cost_amount&&(gamedata.owned_cards[t.cost_id]-=t.cost_amount,saveToLocalStorage(),$(".new_raids_content").html('<div class="loading_arena_decks">Starting raid</div>'),$.post("ajax.php",{data:"start_new_raid",current_id:gamedata.account_id,raid_type:raid_start_ids[e].raid_type},function(e){parseInt(e)>0&&show_content("raids")}))}function join_raid(){if(""!=$(".raid_code").val()){var e=$(".raid_code").val();10==e.length?$.post("ajax.php",{data:"join_raid",current_id:gamedata.account_id,raid_code:e},function(e){console.log(e),parseInt(e)>0?show_content("raids"):$(".raid_join_error").html("Incorrect raid code")}):$(".raid_join_error").html("Raid code to short")}else $(".raid_join_error").html("Please enter a raid code")}function show_join_raid(){$(".raid_code").val(""),$(".raid_join_error").html("")}function copy_current_join_code(){var e=document.getElementById("join_code");e.select(),e.setSelectionRange(0,99999),document.execCommand("copy")}var current_collection_page=1;function show_collection(){$(".tinkering_container").html("");var e="",t=0,a=0,o=0,n=0,r=0;$.each(all_available_cards,function(s,c){if(!1==check_filters(s)&&"currency"!=c.type&&"consumable"!=c.type&&"cardback"!=c.type&&void 0==namechanges[s]&&c.pick_chance>0&&(n++,t++,void 0!=gamedata.owned_cards[s]&&a++,void 0!=c.recipe&&r++,void 0!=c.recipe&&void 0!=gamedata.known_recipes[s]&&o++,t>12*current_collection_page-12&&t<=12*current_collection_page)){var d=parse_card(s),l="";void 0!=gamedata.known_recipes&&void 0==gamedata.known_recipes[s]&&void 0!=all_available_cards[s].recipe&&(l="unowned_summon"),void 0!=gamedata.owned_cards[s]?e+='<div class="collection_card_container '+l+'" onclick="show_card_details(\''+s+"')\">"+d+"</div>":e+='<div class="collection_card_container not_in_collection  '+l+'">'+d+"</div>"}}),t>12?($("#content_collection .page_selection").show(),1==current_collection_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/12<=current_collection_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),0==t?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_collection_page+" / "+Math.ceil(t/12))):$("#content_collection .page_selection").hide(),t>0&&Math.ceil(t/12)<current_collection_page?(current_collection_page=1,show_collection()):""!=e&&$(".tinkering_container").html('<div class="tinkering_list">'+e+"</div>");var s=Math.floor(a/n*100),c=Math.floor(o/r*100);0==a&&(s=0),0==o&&(c=0),$(".collection_count").html("Cards: "+s+"%"),$(".collection_recipe_count").html("Recipes: "+c+"%")}function set_collection_page(e){(current_collection_page+=e)<1&&(current_collection_page=1),show_collection()}var all_icons={air:{},broken:{},power:{},lightning:{},bomb:{},healing:{},bolster:{},wither:{},strike:{},arrow:{},hoof:{},fireray:{},stun:{},fire:{},meteor:{},burn:{},teleport:{},poison:{},curse:{},doom:{},bless:{},frost:{},lull:{},magic:{},armor:{},water:{},dodge:{},shield:{},fly:{},parry:{},resurrect:{},repair:{},energize:{},dice:{},dice_g:{},go_again:{},cleanse:{},voodoo:{},drain:{},book:{},hasten:{},slow:{},discard:{},death:{},magic_shield:{},eye:{},spikes:{},money:{},stone:{},fluffyswirl:{},music:{},wound:{}};function show_icons(){var e="";$.each(all_icons,function(t,a){e+='<div class="icon icon_'+t+'"></div>'}),$(".icons_container").html(e)}var current_card_backs_page=1,card_backs_per_page=12;function show_card_backs(){$(".tinkering_container").html(""),void 0==gamedata.show_hand_colors||!0==gamedata.show_hand_colors?$(".show_hand_colors_button").html("COLOR VISIBLE"):$(".show_hand_colors_button").html("COLOR INVISIBLE"),void 0==gamedata.owned_card_backs&&(gamedata.owned_card_backs={});var e="",t=0,a=0;$.each(all_card_backs,function(o,n){if(void 0!=gamedata.owned_card_backs[o]&&(a++,++t>current_card_backs_page*card_backs_per_page-card_backs_per_page&&t<=current_card_backs_page*card_backs_per_page)){var r=!1;void 0!=all_available_cards[o.replace("card_back_","")]&&(r=all_available_cards[o.replace("card_back_","")]);var s="";!1!=r&&void 0!=r.image_position&&(s=";background-position:"+r.image_position);var c='<div class="pickable_card_back" style="background-image:url(images/'+n+")"+s+'"></div>',d="";void 0!=gamedata.hand_card_back&&gamedata.hand_card_back==n&&(d='<div class="card_back_active">ACTIVE</div>'),void 0!=gamedata.owned_card_backs[o]?e+='<span class="card_back_container" onclick="set_card_back(\''+o+"')\">"+c+d+"</span>":e+='<div class="not_in_collection">'+c+"</div>"}}),t>card_backs_per_page?($("#content_card_backs .page_selection").show(),1==current_card_backs_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),t/card_backs_per_page<=current_card_backs_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),0==t?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_card_backs_page+" / "+Math.ceil(t/card_backs_per_page))):$("#content_card_backs .page_selection").hide(),t>0&&Math.ceil(t/card_backs_per_page)<current_card_backs_page?(current_card_backs_page=1,show_card_backs()):""!=e&&$(".tinkering_container").html('<div class="tinkering_list">'+e+"</div>")}function set_card_back_page(e){(current_card_backs_page+=e)<1&&(current_card_backs_page=1),show_card_backs()}function set_card_back(e){gamedata.hand_card_back=all_card_backs[e],saveToLocalStorage(),show_card_backs()}function clear_card_back(){gamedata.hand_card_back="",saveToLocalStorage(),show_card_backs()}function toggle_show_hand_colors(){void 0==gamedata.show_hand_colors||!0==gamedata.show_hand_colors?gamedata.show_hand_colors=!1:gamedata.show_hand_colors=!0,void 0==gamedata.show_hand_colors||!0==gamedata.show_hand_colors?$(".show_hand_colors_button").html("COLOR VISIBLE"):$(".show_hand_colors_button").html("COLOR INVISIBLE")}function toggle_all_cardbacks(){$.each(all_card_backs,function(e,t){void 0!=gamedata.owned_card_backs[e]?delete gamedata.owned_card_backs[e]:gamedata.owned_card_backs[e]=!0})}var showing_faction="",base_faction_rep=250,base_rep_reward=25,color_bonus_rep=0;function show_factions(){void 0==gamedata.factions&&(gamedata.factions={});var e="";e+='<div class="single_expedition">',e+='<span class="single_new_expedition_name">Factions</span><br/>',gamedata.current_faction&&void 0!=all_factions[gamedata.current_faction]&&(e+='<span class="faction_description representing_current">Representing: '+capitalizeFirstLetter(all_factions[gamedata.current_faction].name)+"</span><br/>"),e+='<span class="faction_description">Choose a faction to represent. You will get reputation with that faction for all battles won.<br/>If you gain levels with factions, they will increase the amount of certain rewards.</span><br/>',e+="</div>",$.each(all_factions,function(t,a){var o=check_defeated_heroes(a.shown),n=check_defeated_heroes(a.available);if(""==o){var r="",s="";void 0!=gamedata.current_faction&&gamedata.current_faction==t&&(r="active",s="Representing: ");var c=0,d=0,l=0,u=base_faction_rep,m=0;void 0!=gamedata.factions[t]&&(c=gamedata.factions[t].reputation,gamedata.factions[t].level=calculate_faction_level(c),d=(c-(l=(m=gamedata.factions[t].level)*m*base_faction_rep))/((u=(m+1)*(m+1)*base_faction_rep)-l)*100),e+='<div class="single_expedition '+r+'">',e+='<div class="faction_background" style="background-image:url(images/'+a.image+')"></div>',""==n?(e+='<span class="single_new_expedition_name">'+s+capitalizeFirstLetter(a.name)+"</span>",e+='<div class="faction_info_button" onclick="showing_faction=\''+t+"';show_content('single_faction')\">INFO</div>",""==r&&(e+='<div class="activate_faction_button" onclick="activate_faction(\''+t+"')\">REPRESENT</div>"),e+='<div class="reputation_bar"><div class="reputation_progress_bar" style="width:'+d+'%"></div><div class="reputation_progress_left">level: '+m+'</div><div class="reputation_progress_right">'+numberWithCommas(c)+" / "+numberWithCommas(u)+"</div></div>"):e+='<span class="not_available_text">'+n+"</span>",e+="</div>"}}),$(".factions_container").html(e)}function show_single_faction(){var e=all_factions[showing_faction],t="",a=0;void 0!=gamedata.factions[showing_faction]&&(a=gamedata.factions[showing_faction].level),t+='<span class="faction_name">'+capitalizeFirstLetter(e.name)+"</span><br/>",t+='<span class="faction_description">'+capitalizeFirstLetter(e.description)+"</span><br/>",t+='<span class="faction_description">Gain reputation with this faction by winning battles while representing this faction.</span><br/>',t+='<span class="faction_description"><br/>Current bonusses:</span><br/>',$.each(e.loot_bonus,function(e,o){t+='<span class="faction_bonus_title">'+capitalizeFirstLetter(all_available_cards[e].name)+':</span><span class="faction_bonus_current">+'+o*a+'%</span><span class="faction_bonus_per_level">('+o+"% per level)</span><br/>"}),$(".faction_bg").css("background-image","url(images/"+e.image+")"),$(".single_faction_container").html(t)}function activate_faction(e){gamedata.current_faction=e,void 0==gamedata.factions[e]&&(gamedata.factions[e]={level:0,reputation:0}),saveToLocalStorage(),show_factions()}function calculate_faction_level(e){return Math.floor(Math.sqrt(e/base_faction_rep))}function gain_current_rep(e){gain_rep(gamedata.current_faction,e)}var rep_bar_message_counter=0;function gain_rep(e,t){if(void 0!=all_factions[e]){t=round_by_percent(t*get_upgrade_factor("reputation",[e,"any"])),void 0==gamedata.factions[e]&&(gamedata.factions[e]={level:0,reputation:0});var a=all_factions[e],o=gamedata.factions[e].reputation+0,n=gamedata.factions[e].level+0,r=n*n*base_faction_rep,s=(n+1)*(n+1)*base_faction_rep,c=(o-r)/(s-r)*100;gamedata.factions[e].reputation+=t,gamedata.factions[e].level=calculate_faction_level(gamedata.factions[e].reputation),saveToLocalStorage(),rep_bar_message_counter++;var d=gamedata.factions[e].reputation+0,l=gamedata.factions[e].level+0,u=l*l*base_faction_rep,m=(l+1)*(l+1)*base_faction_rep,v=(d-u)/(m-u)*100,p=rep_bar_message_counter+0,f="";f+='<span class="faction_name">'+capitalizeFirstLetter(a.name)+"</span><br/>",show_message(f+='<div class="reputation_bar rep_bar_message_counter_'+p+'"><div class="reputation_progress_bar" style="width:'+c+'%"></div><div class="reputation_progress_bar_gained bar_1" style="left:'+c+'%;width:0%"></div><div class="reputation_progress_bar_gained bar_2" style="left:0%;width:0%"></div><div class="reputation_progress_left">level: '+n+'</div><div class="reputation_progress_right">'+numberWithCommas(o)+" (+"+t+") / "+numberWithCommas(s)+"</div></div>");var b=v-c;if(n==l)setTimeout(function(){$(".rep_bar_message_counter_"+p+" .reputation_progress_bar_gained.bar_1").css("width",b+"%")},510),setTimeout(function(){$(".rep_bar_message_counter_"+p+" .reputation_progress_right").html(numberWithCommas(d)+" / "+numberWithCommas(m))},2510);else{var h=100-c;setTimeout(function(){$(".rep_bar_message_counter_"+p+" .reputation_progress_bar_gained.bar_1").css("width",h+"%")},510),setTimeout(function(){$(".rep_bar_message_counter_"+p+" .reputation_progress_bar_gained.bar_2").css("width",v+"%"),$(".rep_bar_message_counter_"+p+" .reputation_progress_bar_gained.bar_1").css("display","none"),$(".rep_bar_message_counter_"+p+" .reputation_progress_bar").css("width","0%"),$(".rep_bar_message_counter_"+p+" .reputation_progress_right").html(numberWithCommas(d)+" / "+numberWithCommas(m)),$(".rep_bar_message_counter_"+p+" .reputation_progress_left").html("Level: "+l),$(".rep_bar_message_counter_"+p+" .reputation_progress_left").addClass("levelup"),setTimeout(function(){$(".rep_bar_message_counter_"+p+" .reputation_progress_left").removeClass("levelup")},500)},2510)}}}var showing_chapter=!1;function show_journal(e){!1!=showing_chapter&&void 0!=all_story_chapters[showing_chapter]&&(e=showing_chapter),void 0==gamedata.stories&&(gamedata.stories={}),$(".journal_back").hide(),$(".story_back").hide();var t="";if((void 0==e||void 0==all_story_chapters[e])&&($(".journal_back").show(),$.each(all_story_chapters,function(e,a){var o=!0,n=!0;$.each(a.stories,function(e,t){!0==t&&(void 0==gamedata.stories[e]||!1==gamedata.stories[e].claimed)&&(n=!1)}),$.each(a.needs_completed,function(e,t){(void 0==gamedata.stories[e]||!1==gamedata.stories[e].claimed)&&(o=!1)}),!0==o&&(t+=parse_chapter(e,n))})),void 0!=e&&void 0!=all_story_chapters[e]){$(".story_back").show();var a=all_story_chapters[e],o=0;$.each(all_stories,function(e,n){if(void 0!=a.stories[e]){var r=!0;void 0!=gamedata.stories[e]&&!0==gamedata.stories[e].claimed&&(r=!1),$.each(n.needs_completed,function(e,t){(void 0==gamedata.stories[e]||!1==gamedata.stories[e].claimed)&&(r=!1)}),!0==r&&(void 0==gamedata.stories[e]&&(gamedata.stories[e]={amount:0,completed:!1,claimed:!1,date_completed:!1}),o++,t+=parse_story(e))}}),0==o&&void 0!=all_story_chapters[e].complete_text&&(t+='<div class="story">',t+='<div class="story_name">Chapter complete</div>',t+='<div class="story_description">'+all_story_chapters[e].complete_text+"</div>",t+="</div>")}$(".journal_content").html(t)}function parse_chapter(e,t){var a="";if(void 0!=all_story_chapters[e]){var o=all_story_chapters[e];a+='<div class="chapter chapter_done_'+t+'" onclick="showing_chapter=\''+e+"';show_journal('"+e+"')\">",a+='<div class="chapter_bg"></div>',a+='<div class="chapter_name">'+o.name+"</div>",a+='<div class="chapter_subname">'+o.subname+"</div>",a+="</div>"}return a}function parse_story(e){var t="";if(void 0!=gamedata.stories[e]&&void 0!=all_stories[e]){var a=all_stories[e],o=gamedata.stories[e];t+='<div class="story">',t+='<div class="chapter_bg"></div>',t+='<div class="story_name">'+a.name+"</div>",t+='<div class="story_description">'+a.description+"</div>",t+='<div class="story_progress_name">Objective: '+a.objective_name+"</div>",t+='<div class="story_progress_bar_container">';var n=Math.floor(o.amount/a.amount*100);n>0&&(t+='<div class="fake_pbc"><div class="story_progress_bar" style="width:'+n+'%"></div></div>'),t+='<div class="story_progress">'+o.amount+" / "+a.amount+"</div>",t+="</div>",count_object(a.rewards)>0&&(t+='<div class="story_rewards">',$.each(a.rewards,function(e,a){var o=a.reward_id;"scraps"==a.reward_id&&(o="scraps_placeholder");var n=parse_card(o,a.reward_amount);t+="<span onclick=\"show_card_details('"+o+"')\">"+n+"</span>"}),t+="</div>"),!0==o.completed&&!1==o.claimed?t+='<div class="claim_story_button" onclick="claim_story(\''+e+"')\">COMPLETE</div>":t+='<div class="claim_story_button" onclick="show_content(\'map\')">MAP</div>',t+="</div>"}return t}function claim_story(e){if(void 0!=gamedata.stories[e]&&void 0!=all_stories[e]){var t=all_stories[e],a=gamedata.stories[e];!0==a.completed&&!1==a.claimed&&(all_current_rewards={},current_reward_origin="journal",current_reward_text="",void 0!=t.reward_text&&(current_reward_text=t.reward_text),$.each(t.rewards,function(e,t){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t.reward_id,reward_amount:t.reward_amount}}),a.claimed=!0,saveToLocalStorage(),show_content("current_rewards"))}}function show_map(){void 0==gamedata.current_location&&(gamedata.current_location="map",saveToLocalStorage());var e="";"none"!=gamedata.current_location&&void 0!=all_locations[gamedata.current_location]&&"none"!=all_locations[gamedata.current_location].parent_location&&(all_locations[gamedata.current_location],e+=parse_location(gamedata.current_location,void 0,!0)),$.each(all_locations,function(t,a){if(a.parent_location==gamedata.current_location){var o=!0;$.each(a.needs_stories_complete,function(e,t){(void 0==gamedata.stories||void 0==gamedata.stories[t]||!1==gamedata.stories[t].claimed)&&(o=!1)}),e+=parse_location(t,o)}}),$(".map_content").html(e),void 0==all_locations[gamedata.current_location]?(delete gamedata.current_location,show_map()):void 0!=all_available_cards[all_locations[gamedata.current_location].card_image]&&$(".map_bg").css("background-image","url(images/"+all_available_cards[all_locations[gamedata.current_location].card_image].image+")")}function parse_location(e,t,a){var o="";if(void 0!=all_locations[e]){var n=all_locations[e];if(void 0==a||!1==a){var r="false";void 0!=gamedata.achievements[e]&&!0==gamedata.achievements[e].completed&&(r="true"),o+='<div class="location map_col_'+n.map_col+" map_row_"+n.map_row+" location_type_"+n.type+" cleared_battle_"+r+" can_enter_"+t+'">',"location"==n.type&&void 0!=t&&!0==t&&(o+='<div class="location_click_event" onclick="set_location(\''+e+"')\"></div>"),"battle"==n.type&&(o+='<div class="location_click_event" onclick="map_hero=\''+n.hero_id+"';endless_waves=false;show_random_battle()\"></div>",o+='<div class="map_icon battle_icon"></div>'),void 0!=all_available_cards[n.card_image]&&(o+='<div class="location_bg" style="background-image:url(images/'+all_available_cards[n.card_image].image+')"></div>')}else o+='<div class="location map_col_1 map_row_1 map_back_button">',o+='<div class="location_click_event" onclick="set_location(\''+n.parent_location+"')\"></div>",void 0!=all_available_cards[all_locations[n.parent_location].card_image]&&(o+='<div class="location_bg" style="background-image:url(images/'+all_available_cards[all_locations[n.parent_location].card_image].image+')"></div>');o+="</div>"}return o}function set_location(e){void 0!=all_locations[e]&&(gamedata.current_location=e,saveToLocalStorage(),show_map())}var selected_pre_summon_buff="",selected_post_summon_buff="";function show_summon(e){$(".summon_container").html(""),void 0==gamedata.summon_pre_buffs&&(gamedata.summon_pre_buffs={});var t="",a="",o="";void 0!=e&&!0==e&&(a="just_summoned"),void 0!=gamedata.current_summon&&(void 0==gamedata.current_summon.tries||gamedata.current_summon.tries<1||void 0==gamedata.current_summon.level)&&delete gamedata.current_summon;var n=get_summon_stats();if($.each(gamedata.summon_pre_buffs,function(e,t){n=adjust_summon_stats(n,t)}),correct_summon_stats(n),void 0==gamedata.loot_rarity&&(gamedata.loot_rarity=0),gamedata.loot_rarity,void 0==gamedata.current_summon||void 0!=e&&!0==e){t+='<div class="summoned_hero_container '+a+'">';var r=parse_card("empty_card");t+="<span>"+r+"</span>",t+='<span class="summon_stats">',t+="<br/>",(10!=n.min_level||10!=n.max_level)&&(t+="Power: "+Math.floor(10*n.min_level),n.min_level!=n.max_level&&(t+=" - "+Math.ceil(10*n.max_level)),t+="%<br/>"),t+="Rarity: "+n.min_rarity,n.min_rarity!=n.max_rarity&&(t+=" - "+n.max_rarity),t+="<br/>",t+="Tries: "+n.max_tries+"<br/>",t+="Reward: "+nFormatter(Math.floor(100*n.reward_bonus),3)+"%<br/>",t+="<br/>",t+="</span>",t+='<div class="menu_button slim summon button" onclick="summon_now()">SUMMON</div><br/><br/>',get_upgrade_factor("show_altar","any",!0)>1&&(t+='<div class="menu_button slim summon button" data-target-content="altar">ALTAR</div><br/><br/>');for(var s=1;s<n.max_pre_buffs+1;s++){t+='<span class="pebuff" onclick="remove_prebuff(\''+s+"')\">";var c=parse_card("empty_card_orange");c=void 0!=gamedata.summon_pre_buffs[s]?parse_card(gamedata.summon_pre_buffs[s]):parse_card("empty_card"),t+=c,t+="</span>"}t+="<br/><br/>",""!=selected_pre_summon_buff&&void 0!=all_available_cards[selected_pre_summon_buff]&&(t+='<div class="selected_pre_summon_buff_container">',t+='<span class="selected_pre_summon_buff">'+parse_card(selected_pre_summon_buff)+"</span>",t+='<span class="selected_pre_summon_buff_text">'+all_available_cards[selected_pre_summon_buff].name+"<br/>"+all_available_cards[selected_pre_summon_buff].description+"</span>",count_object(gamedata.summon_pre_buffs)<n.max_pre_buffs?t+='<div class="menu_button slim summon button use_summon_pre_buff_button" onclick="use_summon_pre_buff(\''+selected_pre_summon_buff+"')\">USE</div>":t+='<div class="menu_button slim summon button use_summon_pre_buff_button")">FULL</div>',t+="</div><br/>"),count_object(gamedata.summon_pre_buffs),n.max_pre_buffs,$.each(all_available_cards,function(e,a){if(void 0!=a.summon_pre_buff&&void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0){var o=parse_card(e,gamedata.owned_cards[e]);t+='<span class="summon_consumable" onclick="select_summon_pre_buff(\''+e+"')\">"+o+"</span>"}}),t+="<br/><br/>",t+="</div>"}if(void 0!=gamedata.current_summon||void 0!=e&&!0==e){var d=Math.floor(gamedata.current_summon.loot_rarity*gamedata.current_summon.reward_count/card_drop_chance_reduction/all_available_cards[gamedata.current_summon.hero].value*100);(void 0==all_available_cards[gamedata.current_summon.hero].recipe||void 0!=gamedata.known_recipes[gamedata.current_summon.hero])&&(d=Math.floor(gamedata.current_summon.loot_rarity*gamedata.current_summon.reward_count/card_drop_chance_reduction/all_available_cards[gamedata.current_summon.hero].value*100)),d>100&&(d=100),t+='<div class="summon_hero_container '+a+'">';var l="";void 0==gamedata.owned_cards[gamedata.current_summon.hero]&&(l='</div><div class="new_card">NEW');var r=parse_card(gamedata.current_summon.hero,l,!0,void 0);void 0!=gamedata.known_recipes&&void 0==gamedata.known_recipes[gamedata.current_summon.hero]&&void 0!=all_available_cards[gamedata.current_summon.hero].recipe&&(o="unowned_summon"),t+='<span class="'+o+'" onclick="show_card_details(\''+gamedata.current_summon.hero+"', true)\">"+r+"</span>",t+='<span class="summon_stats">',t+="<br/>",(10!=n.min_level||10!=n.max_level||10!=gamedata.current_summon.level)&&(t+="Power: "+Math.floor(10*gamedata.current_summon.level)+"%<br/>"),t+="Drop: "+d+"%<br/>",t+="Tries: "+gamedata.current_summon.tries+"<br/>",t+="Reward: "+nFormatter(gamedata.current_summon.reward_count,3)+"<br/>",t+="<br/>",t+="</span>",t+='<div class="menu_button slim summon button" onclick="endless_waves=false;selected_post_summon_buff=\'\'" data-target-content="summoned_battle">FIGHT</div><br/><br/>',""!=selected_post_summon_buff&&void 0!=all_available_cards[selected_post_summon_buff]&&(t+='<div class="selected_pre_summon_buff_container">',t+='<span class="selected_pre_summon_buff">'+parse_card(selected_post_summon_buff)+"</span>",t+='<span class="selected_pre_summon_buff_text">'+all_available_cards[selected_post_summon_buff].name+"<br/>"+all_available_cards[selected_post_summon_buff].description+"</span>",t+='<div class="menu_button slim summon button use_summon_pre_buff_button" onclick="use_summon_post_buff(\''+selected_post_summon_buff+"')\">USE</div>",t+="</div><br/>"),$.each(all_available_cards,function(e,a){if(void 0!=a.summon_post_buff&&void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0){var o=parse_card(e,gamedata.owned_cards[e]);t+='<span class="summon_consumable" onclick="select_summon_post_buff(\''+e+"')\">"+o+"</span>"}}),(n.max_rarity>1||n.max_level>0)&&(t+='<br/><br/><div class="menu_button slim summon button" onclick="clear_current_summon()" data-target-content="summon">CLEAR</div>'),t+="</div>",count_object(gamedata.summon_pre_buffs)>0&&(gamedata.summon_pre_buffs={},saveToLocalStorage())}$(".summon_container").html(t)}function show_waves(){var e="";e+='<div class="summoned_hero_container">';var t=parse_card("conscription");e+="<span>"+t+"</span><br/>",e+='<span class="summon_stats">',e+="Starting power: "+10*get_upgrade_factor("wave_min_power","any",!0)+"%<br/>",e+="Wave growth: "+Math.ceil(100/get_upgrade_factor("wave_power_increase","any",!0))/10+"%",e+="</span><br><br>",e+='<div class="menu_button slim summon button" onclick=\'endless_waves=true\' data-target-content="waves_battle">START</div>',e+="</div>",$(".waves_container").html(e)}function adjust_summon_stats(e,t){return void 0!=all_available_cards[t]&&void 0!=all_available_cards[t].summon_pre_buff&&$.each(all_available_cards[t].summon_pre_buff,function(t,a){(void 0==a.buff_amount_type||"fixed"==a.buff_amount_type)&&void 0!=e[a.buff_type]&&(e[a.buff_type]+=a.buff_amount),(void 0==a.buff_amount_type||"percent"==a.buff_amount_type)&&void 0!=e[a.buff_type]&&(e[a.buff_type]*=1+a.buff_amount/100)}),e}function get_summon_stats(){void 0==gamedata.highest_summon_won&&(gamedata.highest_summon_won=0),void 0==gamedata.summon_min_power&&(gamedata.summon_min_power=1);var e=.9*gamedata.summon_min_power,t=1.1*gamedata.summon_min_power;t=1.2*(e=(gamedata.battles_won+1)/(5*gamedata.battles_lost+10)*10);var a=get_upgrade_factor("summon_max_rarity","any",!0);return{min_rarity:get_upgrade_factor("summon_min_rarity","any",!0),max_rarity:a,common_reduction:a,min_level:e,max_level:t,max_tries:get_upgrade_factor("summon_tries","any",!0),reward_bonus:get_upgrade_factor("summon_reward","any",!0),loot_rarity:get_upgrade_factor("summon_loot_rarity","any",!0),drop_chance:0,max_pre_buffs:get_upgrade_factor("summon_max_pre_buffs","any",!0)}}function correct_summon_stats(e){return $.each(e,function(t,a){a<0&&(e[t]=0),"reward_bonus"!=t&&"max_level"!=t&&"min_level"!=t&&(e[t]=Math.floor(e[t]))}),e.max_rarity<e.min_rarity&&(e.max_rarity=e.min_rarity),e.min_level<1&&(e.min_level=1),e.min_level>e.max_level&&(e.min_level=e.max_level),e}function clear_current_summon(){delete gamedata.current_summon}function show_summoned_battle(){gamedata.current_summon.tries-=1,saveToLocalStorage(),enemy_card_back="",endless_waves=!1,current_battle_type="summoned",show_content("battle")}function show_waves_battle(){all_current_rewards={},enemy_card_back="",endless_waves=!0,endless_wave_count=1,current_battle_type="summoned",show_content("battle")}function summon_now(e){var t=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(e,a){t=adjust_summon_stats(t,a)}),correct_summon_stats(t);var a=get_random_hero(!0,t.min_rarity,t.max_rarity,t.common_reduction);void 0!=e&&!0==e&&void 0!=all_available_cards[current_altar]&&void 0!=gamedata.owned_cards[current_altar]&&gamedata.owned_cards[current_altar]>0&&(a=current_altar,gamedata.owned_cards[current_altar]-=1,current_altar="");var o=t.min_level+Math.random()*(t.max_level-t.min_level);gamedata.current_summon={hero:a,tries:t.max_tries,level:o,loot_rarity:t.loot_rarity,reward_count:round_by_percent(20*t.reward_bonus*get_effective_power_factor(o)*(1+o/100))},selected_pre_summon_buff="",selected_post_summon_buff="",saveToLocalStorage(),show_summon(!0)}function select_summon_pre_buff(e){selected_pre_summon_buff=selected_pre_summon_buff!=e?e:"",show_summon()}function select_summon_post_buff(e){selected_post_summon_buff=selected_post_summon_buff!=e?e:"",show_summon()}function use_summon_pre_buff(e){var t=get_summon_stats();if(void 0==gamedata.summon_pre_buffs&&(gamedata.summon_pre_buffs={}),void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&count_object(gamedata.summon_pre_buffs)<t.max_pre_buffs&&void 0!=all_available_cards[e]&&void 0!=all_available_cards[e].summon_pre_buff){for(var a=!1,o=1;o<t.max_pre_buffs+1;o++)void 0==gamedata.summon_pre_buffs[o]&&!1==a&&(a=o);gamedata.summon_pre_buffs[a]=e,gain_card(e,-1),saveToLocalStorage(),show_summon()}}function remove_prebuff(e){void 0!=gamedata.summon_pre_buffs[e]&&void 0!=all_available_cards[gamedata.summon_pre_buffs[e]]&&(gain_card(gamedata.summon_pre_buffs[e],1),delete gamedata.summon_pre_buffs[e],saveToLocalStorage(),show_summon())}function use_summon_post_buff(e){if(void 0!=gamedata.owned_cards[e]&&gamedata.owned_cards[e]>0&&void 0!=all_available_cards[e]&&void 0!=all_available_cards[e].summon_post_buff){var t=!1,a=all_available_cards[e].summon_post_buff;void 0==gamedata.current_summon["unbuffed_"+a.buff_type]&&(gamedata.current_summon["unbuffed_"+a.buff_type]=gamedata.current_summon[a.buff_type]+0),void 0!=gamedata.current_summon[a.buff_type]&&"fixed"==a.buff_amount_type&&(a.buff_amount>0||gamedata.current_summon[a.buff_type]+a.buff_amount>0)&&(gamedata.current_summon[a.buff_type]+=a.buff_amount,t=!0),void 0!=gamedata.current_summon[a.buff_type]&&"percent"==a.buff_amount_type&&(a.buff_amount>0||gamedata.current_summon[a.buff_type]+a.buff_amount>0)&&(gamedata.current_summon[a.buff_type]+=Math.ceil(gamedata.current_summon["unbuffed_"+a.buff_type]*(0+a.buff_amount/100)),t=!0),!0==t&&(gain_card(e,-1),gamedata.owned_cards[e]<1&&(selected_post_summon_buff=""),saveToLocalStorage(),show_summon())}}var current_altar="";function show_altar(){var e="",t="",a=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(e,t){a=adjust_summon_stats(a,t)}),correct_summon_stats(a);var o=(a.max_level-a.min_level)/2+a.min_level;e+='<div class="summoned_hero_container">';var n=parse_card("empty_card");if(void 0!=all_available_cards[current_altar]&&(void 0!=gamedata.known_recipes&&void 0==gamedata.known_recipes[current_altar]&&void 0!=all_available_cards[current_altar].recipe&&(t="unowned_summon"),n='<span class="'+t+'" onclick="show_card_details(\''+current_altar+"', true)\">"+parse_card(current_altar)+"</span>"),e+="<span>"+n+"</span>",e+='<span class="summon_stats">',e+="<br/>",(10!=a.min_level||10!=a.max_level)&&(e+="Power: "+Math.floor(10*a.min_level),a.min_level!=a.max_level&&(e+=" - "+Math.ceil(10*a.max_level)),e+="%<br/>"),void 0==current_altar||void 0==all_available_cards[current_altar])e+="Max rarity: "+Math.floor(a.max_rarity*get_upgrade_factor("altar_rarity","any",!0));else{var r=Math.floor(a.loot_rarity*round_by_percent(20*a.reward_bonus*get_effective_power_factor(o)*(1+o/100))/card_drop_chance_reduction/all_available_cards[current_altar].value*100);r>100&&(r=100),e+="Drop chance: ~"+r+"%"}e+="<br/>",e+="Tries: "+a.max_tries+"<br/>",e+="Reward: "+nFormatter(Math.floor(100*a.reward_bonus),3)+"%<br/>",e+="<br/>",e+="</span>",""==current_altar?e+='<div class="menu_button slim summon button" data-target-content="choose_altar">CHOOSE</div><br/><br/>':(e+='<div class="menu_button slim summon button" onclick="show_content(\'summon\');summon_now(true)" no-new-page="true">SACRIFICE</div><br/><br/>',e+='<div class="menu_button slim summon button" onclick="current_altar=\'\'" data-target-content="altar">CLEAR</div><br/><br/>'),e+="</div>",$(".altar_container").html(e)}var current_show_altar_page=1;function show_choose_altar(){var e=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(t,a){e=adjust_summon_stats(e,a)});var t=e.max_rarity*get_upgrade_factor("altar_rarity","any",!0);cards_per_page=12,$(".choose_altar_container").html('<span class="no_tinker">You have no cards that match your filter.</span>'),gamedata.owned_cards=sortObj(gamedata.owned_cards);var a=0;$.each(gamedata.owned_cards,function(e,o){if(void 0!=all_available_cards[e]){var n=o+0,r=!1;if((void 0==all_available_cards[e].hero_version||all_available_cards[e].value>t)&&(r=!0),n>0&&!1==r&&!1==check_filters(e)&&(1==++a&&$(".choose_altar_container").html(""),a/cards_per_page>current_show_altar_page-1&&a/cards_per_page<=current_show_altar_page)){var s=parse_card(e,n);$(".choose_altar_container").append("<span onclick=\"current_altar='"+e+"';show_content('altar');\">"+s+"</span>")}}else delete gamedata.owned_cards[e]}),1==current_show_altar_page?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),a/cards_per_page<=current_show_altar_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),a>0&&Math.ceil(a/cards_per_page)<current_show_altar_page&&(current_show_altar_page=1,show_choose_altar()),0==a?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_show_altar_page+" / "+Math.ceil(a/cards_per_page))}function set_altar_page(e){(current_show_altar_page+=e)<1&&(current_show_altar_page=1),show_choose_altar()}var floating_text_amount=0;function parse_floating_text(e,t,a){var o="",n=Math.floor(40*Math.random())+40,r=++floating_text_amount+"";return void 0==a||!1==a?o+='<div class="floating_text floating_text_'+r+'" style="top:'+(Math.floor(40*Math.random())+40)+"%;left:"+n+"%;color:"+t+'">':o+='<div class="floating_text down floating_text_'+r+'" style="left:'+n+"%;color:"+t+'">',o+=e,o+="</div>"}var units_left_to_process={},all_timeouts={},timeout_key=0,latest_result=0,latest_slot=-10,current_rewards={},amount_reduced=0,game_paused=!1,ready_to_resume=!1,hand_slot_id=0,highest_unit_id=3,passive_effect_count=0,pickup_rewards={};function start_next_turn(){if($(".turn_pointer").removeClass("turn_pointer_1"),$(".turn_pointer").removeClass("turn_pointer_2"),$(".turn_pointer").addClass("turn_pointer_"+active_turn),current_phase="",total_timeout<0&&(total_timeout=0),total_turn_counter++,$(".total_turn_counter").html(total_turn_counter),$(".resign_button").css("display","block"),reduce_all_ability_delays(active_turn),enable_all_units_to_act(!0,active_turn),reset_temp_health(active_turn),reset_temp_skills(active_turn),total_turn_counter>=80){total_timeout+=500,$(".total_turn_counter_container").css("color","#f00");for(var e=0;e<=5;e++)$.each(battle_info.combat_units,function(t,a){a.slot==e&&a.side==active_turn&&(receive_damage(t,void 0,Math.floor(total_turn_counter/5)-15,[]),check_unit_alive(t))})}var t=total_turn_counter/160/3*get_upgrade_factor("floating_chance","any",!0);t>.5&&(t=.5),Math.random()<t&&spawn_monthly_pickup(),current_phase="start_turn",next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},total_timeout)}var current_phase="",turn_phases={start_turn:!0,draw_card:!0,combat_start:!0,basic:!1,end_turn:!0};function end_this_turn(){reset_temp_power(active_turn),active_turn=1==active_turn?2:1;var e=fight_number+0;if(battle_info.combat_units[2].current_health>0&&battle_info.combat_units[1].current_health>0&&!0==combat_alive)next_action_timeout=setTimeout(function(){!1==game_paused?e==fight_number?start_next_turn():console.log(e+" != "+fight_number):ready_to_resume=!0},total_timeout);else if(!0==combat_alive){if(battle_info.combat_units[2].current_health>0&&battle_info.combat_units[1].current_health<1){if(check_quests("battle_won_any"),check_quests("battle_won_type_"+current_battle_type),get_effective_power_factor(difficulty_setting)>=1&&(check_quests("battle_won_any_turn_count",total_turn_counter),check_quests("battle_won_"+current_battle_type+"_turn_count",total_turn_counter)),check_quests("battle_won_any_health_left_"+battle_info.combat_units[2].current_health),$(".unit_type_artifact.side_1").addClass("dead"),"summoned"==current_battle_type){if($(".turn_pointer").addClass("hidden"),!0==endless_waves){var t=battle_info.combat_units[1].card_type;void 0!=battle_info.combat_units[1].original_card_type&&(t=battle_info.combat_units[1].original_card_type);var a=round_by_percent(20*get_upgrade_factor("summon_reward","any",!0)*get_effective_power_factor(difficulty_setting)*(1+difficulty_setting/100)),o=add_basic_win_rewards(a,t,!0);!0==o?total_timeout+=1e3:$(".unit_id_1").addClass("dead"),check_quests("battle_won_number_wave",endless_wave_count),endless_wave_count+=1,endless_waves=!0,current_battle_type="summoned",all_timeouts[++timeout_key]=setTimeout(function(){clear_all_timeouts(),$(".projectile").remove(),show_content("battle")},total_timeout+1e3),check_quests("battle_won_wave"),get_effective_power_factor(difficulty_setting)>=1&&check_quests("battle_won_wave_turn_count",total_turn_counter),check_quests("battle_won_wave_health_left_"+battle_info.combat_units[1].current_health)}else{gamedata.battles_won++,all_current_rewards={},current_reward_text="You won the battle!",void 0==gamedata.summon_min_power&&(gamedata.summon_min_power=1),gamedata.summon_min_power+=1;var a=20,t=battle_info.combat_units[1].card_type;void 0!=battle_info.combat_units[1].original_card_type&&(t=battle_info.combat_units[1].original_card_type);var o=add_basic_win_rewards(a,t);!0==o?total_timeout+=1e3:$(".unit_id_1").addClass("dead"),current_reward_origin="summon",all_timeouts[++timeout_key]=setTimeout(function(){show_content("current_rewards")},total_timeout+1e3),check_quests("battle_won_summoned"),get_effective_power_factor(difficulty_setting)>=1&&check_quests("battle_won_summoned_turn_count",total_turn_counter),check_quests("battle_won_summoned_health_left_"+battle_info.combat_units[1].current_health)}$(".side_1.type_artifact").addClass("dead")}}else $(".turn_pointer").addClass("hidden"),$(".unit_id_2").addClass("dead"),$(".unit_type_artifact.side_2").addClass("dead"),battle_info.combat_units[2].current_health<1&&battle_info.combat_units[1].current_health<1?(!0!=endless_waves&&gamedata.battles_tied++,check_quests("battle_tie_any")):(!0!=endless_waves&&gamedata.battles_lost++,gamedata.summon_min_power*=.75,check_quests("battle_loss_any"),check_quests("battle_loss_any_turn_count",total_turn_counter),check_quests("battle_loss_"+current_battle_type+"_turn_count",total_turn_counter),check_quests("battle_loss_any_health_left_"+battle_info.combat_units[1].current_health)),!0==endless_waves?(current_reward_origin="waves",current_reward_text="You defeated "+(endless_wave_count-1)+" waves!",all_timeouts[++timeout_key]=setTimeout(function(){show_content("current_rewards")},total_timeout+1e3)):(timeout_key++,next_turn_timeout=setTimeout(function(){clear_all_timeouts(),end_combat()},total_timeout+1e3));combat_alive=!1,saveToLocalStorage()}}var process_counter=0,all_counter_timeouts={};function process_next_unit(e,t){var a=nowint();check_all_ready_cards();var o=find_next_unit_to_act(active_turn);!1!=o?(process_single_unit(o,void 0,t,e),next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},total_timeout),total_timeout=0):(current_phase=find_next_phase(),enable_all_units_to_act(!1,active_turn),!1!=current_phase?("draw_card"==current_phase&&(reduce_all_hand_times(active_turn),check_all_ready_cards(),draw_card(active_turn,void 0,void 0,void 0),current_phase=find_next_phase()),next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},total_timeout),total_timeout=0):(next_action_timeout=setTimeout(function(){end_this_turn()},total_timeout),total_timeout=0));var n=nowint()-a;if(n>10){var r=++process_counter+0;$(".all_save_icons").append('<div class="saving_icon save_'+r+' save_danger" style="width:'+n/2+'px"></div>'),all_counter_timeouts[r]=setTimeout(function(){$(".save_"+r).remove(),clearTimeout(all_counter_timeouts[r]),delete all_counter_timeouts[r]},1e3)}total_timeout+=n}function find_next_phase(){var e=!1,t=!1,a=!1;return $.each(turn_phases,function(o,n){!0==a&&!1==e&&(e=o,t=n),o==current_phase&&!1==e&&(a=!0)}),e}function find_next_unit_to_act(e){for(var t=!1,a=-5;a<=5;a++)$.each(battle_info.combat_units,function(e,o){!1==t&&o.acted_this_turn<1&&o.slot==a&&!0==combat_alive&&(void 0==o.failed_to_act_this_phase||!1==o.failed_to_act_this_phase)&&(t=e)});return t}function add_basic_win_rewards(e,t,a){var o=1+gamedata.loot_rarity/100;void 0==e&&(e=20),"summoned"==current_battle_type&&void 0!=gamedata.current_summon&&!1==endless_waves&&(e=gamedata.current_summon.reward_count,void 0!=gamedata.current_summon.loot_rarity&&(o=gamedata.current_summon.loot_rarity)),"summoned"==current_battle_type&&!0==endless_waves&&(o=get_upgrade_factor("summon_loot_rarity","any",!0)),void 0==gamedata.loot_charges&&(gamedata.loot_charges=0),void 0==gamedata.loot_rarity&&(gamedata.loot_rarity=0),gamedata.loot_charges>0&&(e+=gamedata.loot_charges),gamedata.loot_charges=0,gamedata.loot_rarity=0,!1==endless_waves&&(current_rewards={}),!1!=fixed_hero&&void 0!=all_enemy_heroes[fixed_hero]&&void 0!=all_enemy_heroes[fixed_hero].drops&&$.each(all_enemy_heroes[fixed_hero].drops,function(e,t){var o=round_by_percent(Math.random()*t);o>0&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:o},void 0!=a&&!0==a&&show_drop(e,o))});var n=!1;if(void 0!=t&&void 0!=all_available_cards["recipe_"+t]&&(void 0==gamedata.known_recipes||void 0==gamedata.known_recipes[t])&&Math.random()<o*e/card_drop_chance_reduction/all_available_cards[t].value&&void 0!=all_available_cards[t].recipe&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"recipe_"+t,reward_amount:1},e-=Math.ceil(all_available_cards[t].value/2),void 0!=a&&!0==a&&show_drop("recipe_"+t,1),void 0==gamedata.known_recipes&&(gamedata.known_recipes={}),gamedata.known_recipes[t]=!0),void 0!=t&&(Math.random()<o*e/card_drop_chance_reduction/all_available_cards[t].value&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t,reward_amount:1},e-=Math.ceil(all_available_cards[t].value/2),n=!0,$(".unit_id_1").removeClass("side_1"),$(".unit_id_1").addClass("side_2"),$(".unit_id_1").addClass("won_hero")),$.each(all_available_cards[t].loot,function(e,t){100*Math.random()<t&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e,reward_amount:1,pickable:!0},void 0!=a&&!0==a&&show_drop(e,1))})),void 0!=t&&void 0!=all_available_cards[t]){var r=all_available_cards[t].value,s={};if($.each(all_available_cards,function(e,t){t.value<=r&&(void 0==gamedata.known_recipes||void 0==gamedata.known_recipes[e]||void 0==t.recipe)&&t.pick_chance>0&&("spell"==t.type||"artifact"==t.type||("structure"==t.type||"creature"==t.type)&&t.pick_chance>0&&void 0==t.hero_version)&&(void 0!=t.recipe?s["recipe_"+e]=1/t.value:s[e]=1/t.value)}),count_object(s)>0){var c=get_random_key_from_object_based_on_num_value(s);Math.random()<o*e/card_drop_chance_reduction/all_available_cards[t].value&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:c,reward_amount:1},void 0!=a&&!0==a&&show_drop(c,1),e-=Math.ceil(all_available_cards[c].value/2),"recipe"==all_available_cards[c].type&&(void 0==gamedata.known_recipes&&(gamedata.known_recipes={}),gamedata.known_recipes[all_available_cards[c].recipe]=!0))}}if("daily"!=current_battle_type){var d=get_random_key_from_object_based_on_num_value(random_loot_drops);void 0!=d&&void 0!=all_available_cards[d]&&Math.random()<o*e/card_drop_chance_reduction/sqr(all_available_cards[d].value)*get_upgrade_factor("loot_drop_chance",d,!0)&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d,reward_amount:1},void 0!=a&&!0==a&&show_drop(d,1))}else $.each(random_loot_drops,function(t,n){if(void 0!=t&&void 0!=all_available_cards[t]){var r=o*e/card_drop_chance_reduction/sqr(all_available_cards[t].value);r>.5&&(r=.5),Math.random()<r&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:t,reward_amount:1},void 0!=a&&!0==a&&show_drop(t,1),e-=all_available_cards[t].value)}});return e>0&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:e}),n}var loot_drop_counter=0;function show_drop(e,t){var a=++loot_drop_counter+0,o=parse_card(e,t);all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container").append('<div class="loot_drop unit side_1 slot_0 loot_drop_'+a+'">'+o+"</div>")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".loot_drop_"+a).addClass("dropped")},total_timeout+100),all_timeouts[++timeout_key]=setTimeout(function(){$(".loot_drop_"+a).removeClass("dropped"),$(".loot_drop_"+a).addClass("picked_up"),$(".loot_drop_"+a).removeClass("side_1"),$(".loot_drop_"+a).addClass("side_2")},total_timeout+600),total_timeout+=500}function gain_reward(e){if($(".detail_overlay").removeClass("non_clickable"),void 0!=current_rewards[e]){for(var t=0;t<current_rewards[e].card_amount;t++)gain_card(current_rewards[e].card_id);show_card_details(current_rewards[e].card_id)}current_rewards={}}function process_single_unit(e,t,a,o){void 0==o&&(o="basic");var n=!1,r=battle_info.combat_units[e];return r.acted_this_turn<1&&!0==combat_alive&&(void 0==r.effects||void 0==r.effects.stunned||0==r.effects.stunned||void 0!=a&&!0==a)?($.each(r.abilities,function(s,c){var d=all_abilities[s];void 0!=battle_info.combat_units[e]&&(void 0==r.effects.stunned||0==r.effects.stunned||void 0!=a&&!0==a)&&void 0!=d.proc&&(!0==match_array_values(d.proc,o)||!0==t&&!0==match_array_values(d.proc,"on_play")&&"basic"==o)&&(void 0==r.ability_delays[s]||r.ability_delays[s]<1)&&!0==process_ability(e,d,c,e,void 0,o)&&(n=!0,check_ability_delay(e,s))}),!0==n&&(total_timeout+=1e3*battle_speed),!0==n&&void 0!=battle_info.combat_units[e]?r.acted_this_turn+=1:r.failed_to_act_this_phase=!0):"basic"==o?(void 0!=r.effects&&void 0!=r.effects.stunned&&r.effects.stunned>0&&process_passive_effect(e,"stunned",r.effects.stunned),r.acted_this_turn+=1,r.acted_this_turn>0&&(r.failed_to_act_this_phase=!0)):r.failed_to_act_this_phase=!0,void 0!=battle_info.combat_units[e]&&(void 0==a||!1==a)&&($.each(r.effects,function(t,a){a>0&&void 0!=battle_info.combat_units[e]&&"stunned"!=t&&process_passive_effect(e,t,a)}),void 0!=battle_info.combat_units[e]&&update_passive_effects(e)),n}function reset_temp_skills(e){$.each(battle_info.combat_units,function(t,a){!0==combat_alive&&a.side==e&&void 0!=a.temp_skills&&count_object(a.temp_skills)>0&&($.each(a.temp_skills,function(e,o){grant_skill(t,t,-1*o,e,!1),delete a.temp_skills[e]}),check_visible_skills(t))})}function reset_temp_health(e){$.each(battle_info.combat_units,function(t,a){!0==combat_alive&&a.side==e&&void 0!=a.armor&&0!=a.armor&&(total_timeout+=500*battle_speed,a.armor=0,check_unit_hp(t)),!0==combat_alive&&a.side==e&&void 0!=a.temp_health&&0!=a.temp_health&&(total_timeout+=500*battle_speed,a.temp_health>0&&(a.temp_health-=1),a.temp_health<0&&(a.temp_health+=1),check_unit_hp(t),check_unit_alive(t))})}function reset_temp_power(e){$.each(battle_info.combat_units,function(t,a){!0==combat_alive&&a.side==e&&void 0!=a.temp_power&&a.temp_power<0&&(total_timeout+=500*battle_speed,a.temp_power=0,check_unit_power(t))})}function reduce_all_ability_delays(e){$.each(battle_info.combat_units,function(t,a){if(!0==combat_alive&&a.side==e){var o=!1;if(void 0==a.ability_delays&&(a.ability_delays={}),$.each(a.ability_delays,function(e,t){a.ability_delays[e]>0&&(a.ability_delays[e]-=1,o=!0)}),!0==o){var n=parse_abilities(t);all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+t+" .card_abilities").html(n)},total_timeout)}void 0!=battle_info.combat_units[t]&&void 0==battle_info.combat_units[t].effects&&(battle_info.combat_units[t].effects={})}})}function check_ability_delay(e,t){if(void 0!=battle_info.combat_units[e]&&void 0!=battle_info.combat_units[e].abilities[t]){var a=!1,o=all_abilities[t],n=battle_info.combat_units[e],r=n.abilities[t];void 0!=o.delay&&void 0==r.delay&&(n.ability_delays[t]=calculate_effect({amount:o.delay},void 0,e,r),a=!0),void 0!=battle_info.combat_units[e].abilities[t].delay&&(n.ability_delays[t]=calculate_effect({amount:battle_info.combat_units[e].abilities[t].delay},void 0,e,battle_info.combat_units[e].abilities[t]),a=!0)}}function check_unopposed_ally(e){for(var t=!1,a=1;a<=5;a++){var o=!1,n=!1;$.each(battle_info.combat_units,function(t,r){r.side==e&&r.slot==a&&(o=!0),r.side!=e&&r.slot==a&&(n=!0)}),!0==o&&!1==n&&(t=!0)}return t}function process_passive_effect(e,t,a){if(void 0!=battle_info.combat_units[e]&&"burning"==t&&!0==combat_alive){var o=Math.ceil(battle_info.combat_units[e].effects.burning/2);create_projectile(e,e,"burn",!1,void 0,battle_info.combat_units[e].side,void 0,void 0,void 0,!0),receive_damage(e,void 0,o,["fire","burning"]),void 0!=battle_info.combat_units[e]&&(battle_info.combat_units[e].effects.burning-=o,update_passive_effects(e),check_unit_alive(e)),total_timeout+=500*battle_speed}void 0!=battle_info.combat_units[e]&&"poisoned"==t&&!0==combat_alive&&(create_projectile(e,e,"poison",!1,void 0,battle_info.combat_units[e].side,void 0,void 0,void 0,!0),receive_damage(e,void 0,Math.ceil(a/2),["poisoned","ignores_armor"]),void 0!=battle_info.combat_units[e]&&(battle_info.combat_units[e].effects.poisoned=Math.floor(battle_info.combat_units[e].effects.poisoned/2),update_passive_effects(e),check_unit_alive(e)),total_timeout+=500*battle_speed),void 0!=battle_info.combat_units[e]&&"stunned"==t&&!0==combat_alive&&(battle_info.combat_units[e].effects.stunned-=1,void 0!=battle_info.combat_units[e]&&update_passive_effects(e),total_timeout+=500*battle_speed),void 0!=battle_info.combat_units[e]&&"doom"==t&&!0==combat_alive&&Math.random()<=a/10&&(timeout_key++,passive_effect_count++,create_projectile(e,e,"doom",!1,void 0,battle_info.combat_units[e].side,void 0,void 0,void 0,!0),total_timeout-=250*battle_speed,check_unit_alive(e,void 0,!0),total_timeout+=750*battle_speed)}var skills_to_show_icon={explode:"bomb",wounded:"wound",blessed:"bless"};function update_passive_effects(e){all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e+" .unit_effects").html("")},total_timeout),$.each(battle_info.combat_units[e].effects,function(t,a){a>0&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e+" .unit_effects").prepend('<div class="effect_'+t+'">'+a+"</div>")},total_timeout))}),$.each(battle_info.combat_units[e].abilities,function(t,a){a>0&&void 0!=skills_to_show_icon[t]&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e+" .unit_effects").prepend('<div class="projectile_'+skills_to_show_icon[t]+'">'+a+"</div>")},total_timeout))}),check_visible_skills(e)}function process_ability(e,t,a,o,n,r,s){if(void 0!=battle_info.combat_units[e]){void 0==n&&(n=!1);var c=!0;if(void 0==battle_info.combat_units[e]&&(c=!1),void 0!=t.need_power&&!0==t.need_power&&1>calculate_effect({amount:"origin_power"},void 0,e,void 0)&&(c=!1),void 0!=t.need_armor&&!0==t.need_armor&&battle_info.combat_units[e].armor<1&&(c=!1),void 0!=t.unopposed_ally&&!0==t.unopposed_ally&&!1==check_unopposed_ally(battle_info.combat_units[e].side)&&(c=!1),void 0!=t.origin_type&&(void 0==battle_info.combat_units[o]||t.origin_type!=battle_info.combat_units[o].type)&&(c=!1),void 0!=t.origin_damaged&&(void 0==battle_info.combat_units[o]||battle_info.combat_units[o].health<=battle_info.combat_units[o].current_health)&&(c=!1),void 0!=t.origin_does_not_have_ability&&void 0!=battle_info.combat_units[o]&&$.each(battle_info.combat_units[o].abilities,function(e,a){!0==match_array_values(t.origin_does_not_have_ability,[e])&&(c=!1)}),void 0!=t.origin_has_opposing&&void 0!=battle_info.combat_units[o]&&(!1==t.origin_has_opposing&&0==count_object(filter_targets_by_has_no_opposing({0:o}))&&(c=!1),!0==t.origin_has_opposing&&count_object(filter_targets_by_has_no_opposing({0:o}))>0&&(c=!1)),void 0!=t.origin_has_effect&&void 0!=battle_info.combat_units[o]&&(void 0==battle_info.combat_units[o].effects||void 0==battle_info.combat_units[o].effects[t.origin_has_effect]||battle_info.combat_units[o].effects[t.origin_has_effect]<1)&&(c=!1),void 0!=t.this_has_effect&&void 0!=battle_info.combat_units[e]&&(void 0==battle_info.combat_units[e].effects||void 0==battle_info.combat_units[e].effects[t.this_has_effect]||battle_info.combat_units[e].effects[t.this_has_effect]<1)&&(c=!1),void 0!=t.max_enemy_units&&count_enemy_units(battle_info.combat_units[e].side)>t.max_enemy_units&&(c=!1),void 0!=t.max_ally_units&&count_ally_units(battle_info.combat_units[e].side)>t.max_ally_units&&(c=!1),void 0!=t.min_ally_units&&count_ally_units(battle_info.combat_units[e].side)<t.min_ally_units&&(c=!1),void 0!=t.min_enemy_units&&count_enemy_units(battle_info.combat_units[e].side)<t.min_enemy_units&&(c=!1),void 0!=t.min_unopposed_enemy_units&&count_unopposed_enemy_units(battle_info.combat_units[e].side)<t.min_unopposed_enemy_units&&(c=!1),void 0!=t.min_double_free_slots&&count_double_free_slots()<t.min_double_free_slots&&(c=!1),void 0!=t.min_units&&count_ally_units(battle_info.combat_units[e].side)+count_enemy_units(battle_info.combat_units[e].side)<t.min_units&&(c=!1),void 0!=t.max_ally_artifacts&&count_ally_artifacts(battle_info.combat_units[e].side)>calculate_effect({amount:t.max_ally_artifacts},void 0,o,a)&&(c=!1),void 0!=t.min_enemy_artifacts&&count_enemy_artifacts(battle_info.combat_units[e].side)<calculate_effect({amount:t.min_enemy_artifacts},void 0,o,a)&&(c=!1),void 0!=t.have_free_adjacent_slot&&!1==find_free_slot(battle_info.combat_units[e].side,battle_info.combat_units[e].card_type,"none","adjacent_of_origin",void 0,e)&&(c=!1),void 0!=t.cannot_proc_while_stunned&&void 0!=battle_info.combat_units[e].effects.stunned&&battle_info.combat_units[e].effects.stunned>0&&(c=!1),!0==match_array_values(t.proc,"basic")&&void 0!=battle_info.combat_units[e].effects.stunned&&battle_info.combat_units[e].effects.stunned>0&&(c=!1),void 0!=t.min_cards_in_deck&&count_deck_cards(battle_info["deck_"+battle_info.combat_units[e].side])<t.min_cards_in_deck&&(c=!1),void 0!=t.min_enemy_cards_in_deck&&(1==battle_info.combat_units[e].side&&count_deck_cards(battle_info.deck_2)<t.min_enemy_cards_in_deck&&(c=!1),2==battle_info.combat_units[e].side&&count_deck_cards(battle_info.deck_1)<t.min_enemy_cards_in_deck&&(c=!1)),void 0!=t.max_hand_cards&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[e].side])>t.max_hand_cards&&(c=!1),void 0!=t.min_ally_hand_cards&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[e].side])<t.min_ally_hand_cards&&(c=!1),void 0!=t.min_ally_creature_cards_in_grave&&count_grave_cards(battle_info["deck_"+battle_info.combat_units[e].side],"creature")<t.min_ally_creature_cards_in_grave&&(c=!1),void 0!=t.min_enemy_hand_cards&&(1==battle_info.combat_units[e].side&&count_hand_cards(battle_info.deck_2)<calculate_effect({amount:t.min_enemy_hand_cards},void 0,o,a)&&(c=!1),2==battle_info.combat_units[e].side&&count_hand_cards(battle_info.deck_1)<calculate_effect({amount:t.min_enemy_hand_cards},void 0,o,a)&&(c=!1)),void 0!=t.max_enemy_hand_cards&&(1==battle_info.combat_units[e].side&&count_hand_cards(battle_info.deck_2)>=calculate_effect({amount:t.max_enemy_hand_cards},void 0,o,a)&&(c=!1),2==battle_info.combat_units[e].side&&count_hand_cards(battle_info.deck_1)>=calculate_effect({amount:t.max_enemy_hand_cards},void 0,o,a)&&(c=!1)),void 0!=t.specific_proc&&(void 0==r||r!=t.specific_proc)&&(c=!1),void 0!=t.ability_effects&&!0==c)$.each(t.ability_effects,function(t,s){n=process_ability(e,s,a,o,n,r)});else if(!0==c){void 0!=t.remove_skill_before_use&&void 0!=battle_info.combat_units[e]&&"spell"!=battle_info.combat_units[e].type&&(set_skill(e,e,0,t.remove_skill_before_use,!1),check_visible_skills(e));var d=battle_info.combat_units[e].unit_id+0,l=1;void 0!=t.proc_amount&&(l=calculate_effect({amount:t.proc_amount},e,e,a)),void 0!=t.min_proc_amount&&l<t.min_proc_amount&&(l=calculate_effect({amount:t.min_proc_amount},e,e,a)),void 0!=t.proc_amount_adjustment&&(l+=t.proc_amount_adjustment),void 0!=t.need_to_be_alive&&!0==t.need_to_be_alive&&0==battle_info.combat_units[e].current_health&&(l=0);var u=total_timeout+0,m=total_timeout+0,v=0,p=!1;void 0!=t.uses_power&&!0==t.uses_power&&void 0!=e&&void 0!=battle_info.combat_units[e]&&void 0!=battle_info.combat_units[e].temp_power&&battle_info.combat_units[e].temp_power>0&&battle_info.combat_units[e].temp_power>v&&(v=battle_info.combat_units[e].temp_power+0);for(var f=1;f<=l;f++){var c=check_ability_can_fire(e,t,a,o);if(!0==c&&(void 0==t.proc_chance||calculate_effect({amount:t.proc_chance,amount_factor:t.proc_factor},e,o,a)>=100*Math.random())&&void 0!=battle_info.combat_units[e]&&(battle_info.combat_units[e].current_health>0||!1===battle_info.combat_units[e].health||void 0!=t.proc_while_dead&&!0==t.proc_while_dead)){var b={};if($.each(t.targets,function(n,r){(0==count_object(b)||void 0!=r.add_targets&&!0==r.add_targets)&&!0==combat_alive&&(b=find_targets(e,r,o,a,t,b))}),count_object(b)>0&&!0==combat_alive){void 0!=t.animation&&(void 0==t.do_not_pause_between||1==f)&&("string"==typeof t.animation?(all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+d).addClass(t.animation)},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+d).removeClass(t.animation)},total_timeout+1e3*battle_speed)):$.each(t.animation,function(e,t){all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+d).addClass(t)},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+d).removeClass(t)},total_timeout+1e3*battle_speed)}),total_timeout+=500*battle_speed);var h=!0;$.each(b,function(r,d){c=check_ability_can_fire(e,t,a,o),void 0!=battle_info.combat_units[e]&&!0==c&&$.each(t.effects,function(o,r){void 0!=r.check_target_alive&&(void 0==battle_info.combat_units[d]||battle_info.combat_units[d].current_health<1)&&(h=!1),!0==h&&(void 0==r.proc_chance||r.proc_chance>100*Math.random())&&(void 0!=t.do_not_pause_between&&!0==t.do_not_pause_between&&(total_timeout=u+0),p=process_effect(d,e,r,a),void 0!=t.do_not_pause_between&&!0==t.do_not_pause_between&&m<total_timeout&&(m=total_timeout+0),!1==p&&(h=!1),!0==p&&!1==n&&(n=!0)),(void 0==s||!0==s)&&check_unit_alive(d,e,void 0,r.subtypes)})}),total_timeout<m&&(total_timeout=m),!0==n&&void 0!=t.reduce_skill_after_use&&void 0!=battle_info.combat_units[e]&&"spell"!=battle_info.combat_units[e].type&&(grant_skill(e,e,-1,t.reduce_skill_after_use,!1),check_visible_skills(e)),!0==n&&void 0!=t.remove_skill_after_use&&void 0!=battle_info.combat_units[e]&&"spell"!=battle_info.combat_units[e].type&&(set_skill(e,e,0,t.remove_skill_after_use,!1),check_visible_skills(e))}}!0==n&&void 0!=t.on_each_success&&void 0!=battle_info.combat_units[e]&&(n=process_ability(e,t.on_each_success,a,o,n))}}!0==n&&void 0!=battle_info.combat_units[e]&&v>0&&(battle_info.combat_units[e].temp_power-=v,v=0,check_unit_power(e)),void 0!=t.remove_skill&&void 0!=battle_info.combat_units[e]&&"spell"!=battle_info.combat_units[e].type&&(set_skill(e,e,0,t.remove_skill,!1),check_visible_skills(e),update_passive_effects(e)),!0==n&&void 0!=t.animation&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+d).removeClass(t.animation)},total_timeout+10)),!0==n&&void 0!=t.adjust_skill_after_use&&void 0!=battle_info.combat_units[e]&&"spell"!=battle_info.combat_units[e].type&&(set_skill(e,e,a+t.adjust_skill_after_use.amount,t.adjust_skill_after_use.skill_id),check_visible_skills(e)),void 0!=battle_info.combat_units[e]&&"artifact"==battle_info.combat_units[e].type&&(1>count_object(battle_info.combat_units[e].abilities)||1==count_object(battle_info.combat_units[e].abilities)&&(void 0!=battle_info.combat_units[e].abilities.delay||void 0!=battle_info.combat_units[e].abilities.eternal||void 0!=battle_info.combat_units[e].abilities.restless))&&check_unit_alive(e,void 0,!0),!1==n&&void 0!=t.on_failure&&void 0!=battle_info.combat_units[e]&&(n=process_ability(e,t.on_failure,a,o,n)),!0==n&&void 0!=t.on_success&&void 0!=battle_info.combat_units[e]&&(n=process_ability(e,t.on_success,a,o,n)),!0==n&&void 0!=battle_info.combat_units[e]&&(battle_info.combat_units[e].used_ability=!0)}return n}function check_adjacent(e,t){var a=battle_info.combat_units[e],o=a.side,n=!1;return $.each(battle_info.combat_units,function(e,r){(r.slot==a.slot+1||r.slot==a.slot-1)&&r.side==o&&("any"==t||t==r.type)&&(n=!0)}),n}function check_ability_can_fire(e,t,a,o){var n=!0;return void 0!=battle_info.combat_units[e]?(void 0!=t.own_max_hp&&battle_info.combat_units[e].current_health>t.own_max_hp&&(n=!1),void 0!=t.cannot_proc_while_stunned&&!0==t.cannot_proc_while_stunned&&void 0!=battle_info.combat_units[e].effects.stunned&&battle_info.combat_units[e].effects.stunned>0&&(n=!1),void 0!=t.has_used_ability&&!0==t.has_used_ability&&void 0!=battle_info.combat_units[e].used_ability&&!1==battle_info.combat_units[e].used_ability&&(n=!1),void 0!=t.has_used_ability&&!1==t.has_used_ability&&void 0!=battle_info.combat_units[e].used_ability&&!0==battle_info.combat_units[e].used_ability&&(n=!1),void 0!=t.has_no_adjacent&&!0==check_adjacent(e,t.has_no_adjacent)&&(n=!1),void 0!=t.has_adjacent&&!1==check_adjacent(e,t.has_adjacent)&&(n=!1),0==battle_info.combat_units[e].current_health&&!1!==battle_info.combat_units[e].health&&(void 0==t.proc_while_dead||!1==t.proc_while_dead)&&(n=!1),void 0!=t.max_ally_units&&count_ally_units(battle_info.combat_units[e].side)>t.max_ally_units&&(n=!1),void 0!=t.min_ally_units&&count_ally_units(battle_info.combat_units[e].side)<t.min_ally_units&&(n=!1),void 0!=t.min_enemy_units&&count_enemy_units(battle_info.combat_units[e].side)<t.min_enemy_units&&(n=!1),void 0!=t.min_cards_in_deck&&count_deck_cards(battle_info["deck_"+battle_info.combat_units[e].side])<t.min_cards_in_deck&&(n=!1),void 0!=t.max_hand_cards&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[e].side])>t.max_hand_cards&&(n=!1)):n=!1,n}function count_units(){var e=0;return $.each(battle_info.combat_units,function(t,a){a.slot>0&&void 0!=a.current_health&&a.current_health>0&&e++}),e}function count_enemy_units(e,t){var a=0;return $.each(battle_info.combat_units,function(o,n){n.side!=e&&n.slot>0&&void 0!=n.current_health&&n.current_health>0&&(void 0==t||"any"==t||t==n.type)&&a++}),a}function count_unopposed_enemy_units(e){var t=0;return $.each(battle_info.combat_units,function(a,o){if(o.side!=e&&o.slot>0&&void 0!=o.current_health&&o.current_health>0){var n=!0;$.each(battle_info.combat_units,function(t,a){o.slot==a.slot&&a.side==e&&(n=!1)}),!0==n&&t++}}),t}function count_double_free_slots(){for(var e=0,t=1;t<=5;t++){var a=!0;$.each(battle_info.combat_units,function(e,o){o.slot==t&&(a=!1)}),!0==a&&(e+=1)}return e}function count_ally_units(e,t){var a=0;return $.each(battle_info.combat_units,function(o,n){n.side==e&&n.slot>0&&void 0!=n.current_health&&n.current_health>0&&(void 0==t||"any"==t||t==n.type)&&a++}),a}function count_ally_artifacts(e){var t=0;return $.each(battle_info.combat_units,function(a,o){o.side==e&&o.slot<0&&"artifact"==o.type&&t++}),t}function count_enemy_artifacts(e){var t=0;return $.each(battle_info.combat_units,function(a,o){o.side!=e&&o.slot<0&&"artifact"==o.type&&t++}),t}function process_effect(e,t,a,o){var n=calculate_effect(a,e,t,o),r=s,s=!0,c=!1,d=!1;if(void 0!=battle_info.combat_units[e]&&(void 0!=a.set_latest_slot&&!0==a.set_latest_slot&&(latest_slot=battle_info.combat_units[e].slot),$.each(battle_info.combat_units[e].abilities,function(o,n){var r=all_abilities[o].grants_immunities;void 0!=r&&!0==match_array_values(r,a.subtypes)&&(void 0==all_abilities[o].cannot_proc_while_stunned||void 0==battle_info.combat_units[e].effects.stunned||0==battle_info.combat_units[e].effects.stunned)&&(d=!0),void 0!=battle_info.combat_units[t]&&void 0!=all_abilities[o].negated_by_ability&&$.each(battle_info.combat_units[t].abilities,function(e,t){e==all_abilities[o].negated_by_ability&&(d=!1)})})),void 0!=battle_info.combat_units[t]&&(void 0==battle_info.combat_units[t].used_effect||!1==battle_info.combat_units[t].used_effect)&&check_ability_procs(battle_info.combat_units[t].side,battle_info.combat_units[t].type+"_about_to_use_ability",t,a.subtypes),void 0!=battle_info.combat_units[t]&&(battle_info.combat_units[t].used_effect=!0),void 0!=battle_info.combat_units[t]){if(void 0!=battle_info.combat_units[e]&&($.each(battle_info.combat_units[e].abilities,function(o,n){!0==match_array_values(all_abilities[o].proc,["targeted_by"])&&(void 0==all_abilities[o].subtypes||!0==match_array_values(all_abilities[o].subtypes,a.subtypes))&&process_ability(e,all_abilities[o],n,t,void 0,"targeted_by"),!0==match_array_values(all_abilities[o].proc,["targeted_by_"+battle_info.combat_units[t].type])&&(void 0==all_abilities[o].subtypes||!0==match_array_values(all_abilities[o].subtypes,a.subtypes))&&process_ability(e,all_abilities[o],n,t,void 0,"targeted_by")}),0==battle_info.combat_units[e].slot&&check_ability_procs(battle_info.combat_units[e].side,"hero_targeted_by",t,a.subtypes),void 0!=battle_info.combat_units[e]&&check_ability_procs(battle_info.combat_units[e].side,"ally_targeted_by",e,a.subtypes)),void 0!=battle_info.combat_units[t]){var l=battle_info.combat_units[t].side+0;void 0!=battle_info.combat_units[e]&&$.each(battle_info.combat_units[e].abilities,function(o,n){if(match_array_values(all_abilities[o].proc,"avoid_effect")){var r=match_array_values(all_abilities[o].subtypes,a.subtypes);if(!0==r&&void 0!=all_abilities[o].subtypes_while_origin_has_ability&&void 0!=battle_info.combat_units[t]&&(void 0==battle_info.combat_units[t]?r=!1:$.each(all_abilities[o].subtypes_while_origin_has_ability,function(e,o){if(match_array_values(e,a.subtypes)){var n=!1;$.each(battle_info.combat_units[t].abilities,function(e,t){t>0&&match_array_values(e,o)&&(n=!0)}),!1==n&&(r=!1)}})),!0==r){var s=calculate_effect({amount:all_abilities[o].effect},e,t,n),d=!1,l=!1;!0==c&&(l=!0),(void 0==all_abilities[o].cannot_proc_while_stunned||void 0==battle_info.combat_units[e].effects.stunned||0==battle_info.combat_units[e].effects.stunned)&&!1==c&&100*Math.random()<=s&&(void 0!=all_abilities[o].negated_by_ability&&$.each(all_abilities[o].negated_by_ability,function(e,a){$.each(battle_info.combat_units[t].abilities,function(e,t){e==a&&(d=!0)})}),!1==d&&(c=!0,latest_result=0,process_ability(e,all_abilities[o],n,t,void 0,"avoid_effect")))}}})}if(void 0!=battle_info.combat_units[t]&&!1==c&&!1==d&&!0==combat_alive&&(void 0==a.chance||a.chance>=100*Math.random())){var u=1;void 0!=a.effect_count&&(u=calculate_effect({amount:a.effect_count},e,t,o));for(var m=u-1;m>=0;m--){if(void 0!=a.pause_before&&(total_timeout+=a.pause_before*battle_speed),void 0!=a.self_projectile&&((total_timeout-=500*battle_speed)<0&&(total_timeout=0),create_projectile(t,t,a.self_projectile,!1,a.projectile_target,a.side,void 0,void 0,void 0,!0),total_timeout+=1e3*battle_speed),void 0!=a.projectile&&((total_timeout-=500*battle_speed)<0&&(total_timeout=0),create_projectile(t,e,a.projectile,!1,a.projectile_target,a.side),total_timeout+=1e3*battle_speed),void 0!=a.target_projectile&&((total_timeout-=500*battle_speed)<0&&(total_timeout=0),create_projectile(e,e,a.target_projectile,!1,a.projectile_target,a.side,void 0,void 0,void 0,!0),total_timeout+=1e3*battle_speed),void 0!=a.pause_before_effect&&(total_timeout+=a.pause_before_effect*battle_speed),void 0!=battle_info.combat_units[e]&&((void 0!=battle_info.combat_units[t]&&2==battle_info.combat_units[t].side||2==l)&&$.each(a.subtypes,function(t,a){var o=battle_info.combat_units[e].card_type+"_affected_by_"+a;void 0!=all_achievement_goals[o]&&check_quests(o),void 0!=battle_info.combat_units[e]&&$.each(battle_info.combat_units[e].subtypes,function(e,t){var o=t+"_affected_by_"+a;void 0!=all_achievement_goals[o]&&check_quests(o)})}),check_single_unit_proc(e,void 0,"pre_affected_by_"+a.type,t,a.subtypes),check_single_unit_proc(e,void 0,"pre_affected_by_any",t,a.subtypes)),void 0!=battle_info.combat_units[e]&&void 0!=battle_info.combat_units[t]){var v=!1;if("increase_loot_charges"==a.type&&n>0&&(void 0==gamedata.loot_charges&&(gamedata.loot_charges=0),gamedata.loot_charges+=n),"damage"==a.type&&n>0&&(v=receive_damage(e,t,n,a.subtypes)),"drain"==a.type&&(v=receive_damage(e,t,n,a.subtypes),"creature"==battle_info.combat_units[e].type&&void 0!=battle_info.combat_units[t]&&battle_info.combat_units[t].current_health<battle_info.combat_units[t].health&&receive_healing(t,t,v,[])),"healing"==a.type&&receive_healing(e,t,n,a.subtypes),"set_hp"==a.type&&set_hp(e,t,n,a.subtypes),"set_max_hp"==a.type&&set_max_hp(e,t,n,a.subtypes),"reduce_power"==a.type&&reduce_power(e,t,n,a.subtypes),"increase_power"==a.type&&increase_power(e,t,n,a.subtypes),"enable_to_act"==a.type&&enable_to_act(e,t,n,a.subtypes),"go_again"==a.type&&go_again(e,t,n,a.subtypes),"set_power"==a.type&&set_power(e,t,n,a.subtypes),"increase_health"==a.type&&increase_health(e,t,n,a.subtypes),"grant_temp_power"==a.type&&grant_temp_power(e,t,n,a.subtypes),"grant_temp_health"==a.type&&grant_temp_health(e,t,n,a.subtypes),"reduce_health"==a.type&&(latest_result=reduce_health(e,t,n,a.subtypes)),"reduce_current_health"==a.type&&(latest_result=reduce_current_health(e,t,n,a.subtypes)),"set_health"==a.type&&(latest_result=set_health(e,t,n,a.subtypes)),"reduce_max_health"==a.type&&reduce_max_health(e,t,n,a.subtypes),"reduce_armor"==a.type&&reduce_armor(e,t,n,a.subtypes),"increase_armor"==a.type&&increase_armor(e,t,n,a.subtypes),"set_armor"==a.type&&(latest_result=set_armor(e,t,n,a.subtypes)),"grant_skill"==a.type&&(grant_skill(e,t,n,a.skill_id,void 0,a.skill_at_front),check_visible_skills(e)),"grant_temp_skill"==a.type&&(grant_temp_skill(e,t,n,a.skill_id,void 0,a.skill_at_front),check_visible_skills(e)),"set_skill"==a.type&&(set_skill(e,t,n,a.skill_id),check_visible_skills(e)),"change_side"==a.type&&change_side(e,t),"ability"==a.type&&process_ability(e,a,o,t),"random_ability"==a.type){var p=a.ability_options[get_random_key_from_object(a.ability_options)];void 0!=all_abilities[p]&&(s=process_ability(e,all_abilities[p],n,t))}"move"==a.type&&(s=move_unit(e,a,t)),"set_unit_type"==a.type&&set_unit_type(e,a,t),"turn_into"==a.type&&turn_into(e,a,t,o),"turn_into_original"==a.type&&(s=turn_into_original(e,t)),"apply_burn"==a.type&&apply_burn(e,n,t),"reduce_burn"==a.type&&reduce_burn(e,n,t),"apply_poison"==a.type&&apply_poison(e,n,t),"apply_stun"==a.type&&(apply_stun(e,n,t,a.allways_apply),check_visible_skills(e)),"apply_curse"==a.type&&apply_curse(e,n,t),"apply_doom"==a.type&&apply_doom(e,n,t),"apply_energy"==a.type&&apply_energy(e,n,t),"apply_blessed"==a.type&&apply_blessed(e,n,t),"set_effect_amount"==a.type&&set_effect_amount(e,n,t,a),"destroy"==a.type&&destroy_unit(e,t),"disappear"==a.type&&disappear_unit(e,t),"move_to_deck"==a.type&&move_to_deck(e,a,t),"reduce_negative_effects"==a.type&&(reduce_negative_effects(e,n,t),check_visible_skills(e)),"absorb"==a.type&&absorb(e,t,a.absorb_specs)}if("set_status"==a.type&&(s=set_status(e,a,t)),"remove_card"==a.type&&remove_card_from_combat(e,a,t),"reduce_ready_time"==a.type&&reduce_ready_time(e,a,n,t),"increase_ready_time"==a.type&&increase_ready_time(e,a,n,t),"play_card"==a.type){var f=battle_info.combat_units[t],b=f.side;("ally"==a.side&&2==f.side||"enemy"==a.side&&1==f.side)&&(b=2),("ally"==a.side&&1==f.side||"enemy"==a.side&&2==f.side)&&(b=1),play_card(b,e,!0,t),s=!0}if("add_card_to_deck"==a.type)for(var m=n-1;m>=0;m--)add_card_to_combat_deck(battle_info.combat_units[e].side,a.card_id,a.card_status);if("draw_card"==a.type)for(var m=n-1;m>=0;m--)draw_card(battle_info.combat_units[e].side,void 0,a.card_type);if("summon_unit"==a.type){var h=!1,g=!0;void 0!=a.forced_slot&&(g=a.forced_slot);for(var m=n-1;m>=0;m--){if("random"!=a.card_id&&"self"!=a.card_id&&"origin_card"!=a.card_id)var w=play_unit_card(battle_info.combat_units[e].side,a.card_id,void 0,g,t);else{if("random"==a.card_id){var y="any";void 0!=a.card_type&&(y=calculate_effect({amount:a.card_type},e,t,o));var k=100;void 0!=a.card_time&&(k=calculate_effect({amount:a.card_time},e,t,o));var _=void 0;void 0!=a.card_time_min&&(_=calculate_effect({amount:a.card_time_min},e,t,o));var x=void 0;void 0!=a.card_color&&(x=calculate_effect({amount:a.card_color},e,t,o));var C=void 0;void 0!=a.card_subtype&&(C=calculate_effect({amount:a.card_subtype},e,t,o));var j=get_random_card_based_on_time(y,k,x,x,C,_,void 0,a.not_subtypes),w=play_unit_card(battle_info.combat_units[e].side,j,void 0,g,t)}if("self"==a.card_id)var w=clone_unit(battle_info.combat_units[e].side,e,a.clone_stunned,t,a);if("origin_card"==a.card_id)var w=play_unit_card(battle_info.combat_units[e].side,battle_info.combat_units[e].card_type,void 0,g,t)}!0==w&&(h=!0)}!1==h&&!1==r&&(s=!1)}if("play_action_card"==a.type){for(var h=!1,m=n-1;m>=0;m--){if("random"!=a.card_id)var w=play_action_card(battle_info.combat_units[e].side,a.card_id,void 0,!0);else{var y="any";void 0!=a.card_type&&(y=calculate_effect({amount:a.card_type},e,t,o));var k=100;void 0!=a.card_time&&(k=calculate_effect({amount:a.card_time},e,t,o));var x=void 0;void 0!=a.card_color&&(x=calculate_effect({amount:a.card_color},e,t,o));var j=get_random_card_based_on_time(y,k,x,x),w=play_action_card(battle_info.combat_units[e].side,j,void 0,!0)}!0==w&&(h=!0)}!1==h&&!1==r&&(s=!1)}if("play_artifact_card"==a.type){for(var h=!1,m=n-1;m>=0;m--){if("random"!=a.card_id)var w=play_artifact_card(battle_info.combat_units[e].side,a.card_id,void 0,!0);else{var y="any";void 0!=a.card_type&&(y=calculate_effect({amount:a.card_type},e,t,o));var k=100;void 0!=a.card_time&&(k=calculate_effect({amount:a.card_time},e,t,o));var x=void 0;void 0!=a.card_color&&(x=calculate_effect({amount:a.card_color},e,t,o));var j=get_random_card_based_on_time(y,k,x,x),w=play_artifact_card(battle_info.combat_units[e].side,j,void 0,!0)}!0==w&&(h=!0)}!1==h&&!1==r&&(s=!1)}void 0!=a.increase_timeout&&(total_timeout+=a.increase_timeout*battle_speed),void 0!=battle_info.combat_units[e]&&(check_single_unit_proc(e,void 0,"affected_by_"+a.type,t,a.subtypes),check_single_unit_proc(e,void 0,"affected_by_any",t,a.subtypes)),void 0!=battle_info.combat_units[t]&&check_single_unit_proc(t,void 0,"hit_with_ability",e,a.subtypes),void 0!=a.projectile&&(total_timeout+=1e3*battle_speed)}}else void 0!=a.self_projectile&&(total_timeout-=1e3*battle_speed,create_projectile(t,t,a.self_projectile,!1,a.projectile_target,a.side,void 0,void 0,void 0,!0),total_timeout+=500*battle_speed),void 0!=a.projectile&&(total_timeout-=1e3*battle_speed,create_projectile(t,e,a.projectile,!1,a.projectile_target,a.side),total_timeout+=500*battle_speed),void 0!=a.target_projectile&&(total_timeout-=1e3*battle_speed,create_projectile(e,e,a.target_projectile,!1,a.projectile_target,a.side,void 0,void 0,void 0,!0),total_timeout+=500*battle_speed),void 0!=a.on_failure&&process_ability(t,a.on_failure,o,void 0);!0==c&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("dodge")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("dodge")},total_timeout+50),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("dodge")},total_timeout+500),total_timeout+=500*battle_speed,void 0!=battle_info.combat_units[t]&&void 0!=a.on_avoided&&process_ability(t,a.on_avoided,ability_level,void 0,"on_avoided"),void 0!=battle_info.combat_units[t]&&$.each(battle_info.combat_units[t].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,"been_avoided")&&(void 0==all_abilities[a].subtypes||!0==match_array_values(all_abilities[a].subtypes,subtypes))&&(void 0==all_abilities[a].not_subtypes||!1==match_array_values(all_abilities[a].not_subtypes,subtypes))&&process_ability(t,all_abilities[a],o,e,void 0,"been_avoided")})),!0==d&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("combat_softfade")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("combat_softfade")},total_timeout+500)),!0==s&&(!1==c&&void 0!=a.on_success&&(!1===v||v>0)&&process_ability(t,a.on_success,o,e),(void 0!=battle_info.combat_units[t]&&2==battle_info.combat_units[t].side||2==l)&&$.each(a.subtypes,function(e,t){check_quests("ally_performed_"+t),add_battle_stats("ally_performed_"+t,n)}),void 0!=battle_info.combat_units[t]&&$.each(battle_info.combat_units[t].abilities,function(o,n){$.each(a.subtypes,function(a,r){!0==match_array_values(all_abilities[o].proc,"performed_"+r)&&(void 0==all_abilities[o].subtypes||!0==match_array_values(all_abilities[o].subtypes,r))&&(void 0==all_abilities[o].not_subtypes||!1==match_array_values(all_abilities[o].not_subtypes,r))&&process_ability(t,all_abilities[o],n,e,void 0,"performed_"+r)}),!0==match_array_values(all_abilities[o].proc,"performed_ability")&&(void 0==all_abilities[o].subtypes||!0==match_array_values(all_abilities[o].subtypes,a.subtypes))&&(void 0==all_abilities[o].not_subtypes||!1==match_array_values(all_abilities[o].not_subtypes,a.subtypes))&&process_ability(t,all_abilities[o],n,e,void 0,"performed_ability")}))}return s}function reduce_negative_effects(e,t,a){for(var o=battle_info.combat_units[e],n=1;n<=t;n++){var r=0,s=!1;void 0!=o.effects.burning&&o.effects.burning>0&&(r+=o.effects.burning),void 0!=o.effects.poisoned&&o.effects.poisoned>0&&(r+=o.effects.poisoned),void 0!=o.effects.cursed&&o.effects.cursed>0&&(r+=o.effects.cursed),void 0!=o.effects.doom&&o.effects.doom>0&&(r+=o.effects.doom);var c=Math.ceil(Math.random()*r);void 0!=o.effects.burning&&!1==s&&o.effects.burning>0&&(c-=o.effects.burning)<=0&&(o.effects.burning-=1,s=!0,total_timeout+=200*battle_speed),void 0!=o.effects.poisoned&&!1==s&&o.effects.poisoned>0&&(c-=o.effects.poisoned)<=0&&(o.effects.poisoned-=1,s=!0,total_timeout+=200*battle_speed),void 0!=o.effects.cursed&&!1==s&&o.effects.cursed>0&&(c-=o.effects.cursed)<=0&&(o.effects.cursed-=1,s=!0,total_timeout+=200*battle_speed),void 0!=o.effects.doom&&!1==s&&o.effects.doom>0&&(c-=o.effects.doom)<=0&&(o.effects.doom-=1,s=!0,total_timeout+=200*battle_speed),update_passive_effects(e)}}function absorb(e,t,a){if(void 0!=battle_info.combat_units[e]&&void 0!=battle_info.combat_units[t]){if(void 0!=a.absorb_abilities&&!0==a.absorb_abilities){var o;o="all"==a.absorb_abilities_amount?count_object(battle_info.combat_units[e].abilities):a.absorb_abilities_amount+0,$.each(battle_info.combat_units[e].abilities,function(n,r){if(o>0&&(void 0==a.absorb_negative_abilities||!0==a.absorb_negative_abilities||void 0==all_abilities[n].negative_ability)){void 0==battle_info.combat_units[t].abilities[n]?battle_info.combat_units[t].abilities[n]=r:battle_info.combat_units[t].abilities[n]+=r,delete battle_info.combat_units[e].abilities[n],total_timeout+=500;var s=parse_abilities(e);all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_abilities").html(s)},total_timeout);var s=parse_abilities(t);all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+t+" .card_abilities").html(s)},total_timeout),check_visible_skills(e),check_visible_skills(t)}})}void 0!=a.absorb_power&&!0==a.absorb_power&&battle_info.combat_units[e].power>0&&(!1===battle_info.combat_units[t].power?battle_info.combat_units[t].power=battle_info.combat_units[e].power:battle_info.combat_units[t].power+=battle_info.combat_units[e].power,battle_info.combat_units[e].power=!1,check_unit_power(e),check_unit_power(t),total_timeout+=500),void 0!=a.absorb_armor&&!0==a.absorb_armor&&battle_info.combat_units[e].armor>0&&(!1===battle_info.combat_units[t].armor?battle_info.combat_units[t].armor=battle_info.combat_units[e].armor:battle_info.combat_units[t].armor+=battle_info.combat_units[e].armor,battle_info.combat_units[e].armor=!1,check_unit_power(e),check_unit_power(t),total_timeout+=500),void 0!=a.absorb_health&&!0==a.absorb_health&&battle_info.combat_units[e].current_health>0&&(!1===battle_info.combat_units[t].current_health?(battle_info.combat_units[t].current_health=battle_info.combat_units[e].current_health,battle_info.combat_units[t].health=battle_info.combat_units[e].health):(battle_info.combat_units[t].current_health+=battle_info.combat_units[e].current_health,battle_info.combat_units[t].health+=battle_info.combat_units[e].health),battle_info.combat_units[e].current_health=!1,check_unit_hp(e),check_unit_hp(t),total_timeout+=500)}}function apply_burn(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.burning?o.effects.burning=t:o.effects.burning+=t,timeout_key++;var n=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_burned passive_effect_'+n+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+n).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function set_effect_amount(e,t,a,o){if(void 0!=battle_info.combat_units[e]){var n=battle_info.combat_units[e];void 0==n.effects&&(n.effects={}),$.each(o.effect_names,function(e,t){n.effects[e]=t,t<1&&delete n.effects[e]}),void 0!=o.effect_name&&(n.effects[o.effect_name]=t),update_passive_effects(e)}}function reduce_burn(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0!=o.effects.burning&&(t>o.effects.burning&&(t=o.effects.burning),o.effects.burning-=t),update_passive_effects(e)}}function apply_poison(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.poisoned?o.effects.poisoned=t:o.effects.poisoned+=t,timeout_key++;var n=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_poisoned passive_effect_'+n+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+n).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function apply_curse(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.cursed?o.effects.cursed=t:o.effects.cursed+=t,timeout_key++;var n=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_cursed passive_effect_'+n+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+n).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function apply_doom(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.doom?o.effects.doom=t:o.effects.doom+=t,o.effects.doom>10&&(o.effects.doom=10),timeout_key++;var n=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_doomed passive_effect_'+n+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+n).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function apply_energy(e,t,a){if(0!=t&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.energy?o.effects.energy=t:o.effects.energy+=t,o.effects.energy<0&&(o.effects.energy=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("blue_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("blue_glow")},total_timeout+500),total_timeout+=250*battle_speed,update_passive_effects(e)}}function apply_blessed(e,t,a){if(t>0&&void 0!=battle_info.combat_units[e]){var o=battle_info.combat_units[e];void 0==o.effects&&(o.effects={}),void 0==o.effects.blessed?o.effects.blessed=t:o.effects.blessed+=t,o.effects.blessed<0&&(o.effects.blessed=0),o.effects.blessed>10&&(o.effects.blessed=10),timeout_key++;var n=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_blessed passive_effect_'+n+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+n).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function apply_stun(e,t,a,o){if(t>0&&void 0!=battle_info.combat_units[e]){var n=battle_info.combat_units[e];"object"!=n.type&&n.type,void 0==n.effects&&(n.effects={}),void 0==n.effects.stunned?n.effects.stunned=t:n.effects.stunned<t&&(n.effects.stunned=t),timeout_key++;var r=++passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").append('<div class="just_stunned passive_effect_'+r+'"></div>')},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image .passive_effect_"+r).remove()},total_timeout+750),total_timeout+=250*battle_speed,update_passive_effects(e)}}function set_unit_type(e,t,a){var o=battle_info.combat_units[e];if(void 0!=o){o.type=t.new_type;var n=parse_abilities(e);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_abilities").html(n)},total_timeout)}}function move_unit(e,t,a){var o=battle_info.combat_units[e],n=find_free_slot(o.side,o.card_type,t.safe_slot,t.placement,t.opposing_type,a,t.slot_filters);if(void 0!=t.placement&&"right"==t.placement&&n<o.slot&&(n=!1),void 0!=t.placement&&"left"==t.placement&&n>o.slot&&(n=!1),!1==n)return all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+a).removeClass("combat_zoom")},total_timeout),latest_result=0,!1;var r=o.slot+0;o.old_slot=r,o.slot=n;var s=o.slot+0;return all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).removeClass("slot_"+r),$(".unit_id_"+e).addClass("slot_"+s)},total_timeout),total_timeout+=500*battle_speed,check_ability_procs(o.side,"moved",e,t.subtypes),(latest_result=r-s)<0&&(latest_result*=-1),!0}function change_side(e,t){var a=battle_info.combat_units[e],o=!1;if(1==a.side&&(o=2),2==a.side&&(o=1),!1!=o){var n=a.side+0;a.side=o;var r=o;all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).removeClass("flying")},total_timeout),total_timeout+=100*battle_speed,all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).removeClass("side_"+n),$(".unit_id_"+e).addClass("side_"+r)},total_timeout);var s=0;$.each(battle_info.combat_units,function(e,t){t.side==a.side&&t.slot==a.slot&&s++}),s>1?move_unit(e,{type:"move",safe_slot:"dont care",has_opposing:"dont care",placement:"random"},t):total_timeout+=500*battle_speed,check_visible_skills(e)}}function move_to_deck(e,t,a){var o=battle_info.combat_units[e];if(void 0!=o){var n=void 0;void 0!=o.card_id&&(n=parseInt(o.card_id)+0);var r=o.side+0,s=o.origin_side+0,c="deck";if(void 0!=t.new_status&&(c=t.new_status),"hand"==c&&void 0!=n&&count_hand_cards(battle_info["deck_"+o.side])>9&&(c="deck"),"hand"==c&&void 0!=n&&10>count_hand_cards(battle_info["deck_"+o.side])){battle_info["deck_"+s][n].status="deck",draw_card(s,n,void 0,void 0,!1),total_timeout-=1500*battle_speed;var d=battle_info.combat_units[e].slot+0,l=battle_info["deck_"+s][n].hand_slot+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).removeClass("side_"+r),$(".unit_id_"+e).addClass("side_"+s),$(".unit_id_"+e).removeClass("slot_"+d),$(".unit_id_"+e).addClass("hand_card fake_hand_slot_"+l)},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).remove()},total_timeout+1500*battle_speed),delete battle_info.combat_units[e]}else delete battle_info.combat_units[e],all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).addClass("combat_fade")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e).remove()},total_timeout+500);if(void 0!=n&&"hand"!=c&&(battle_info["deck_"+s][n].status="deck","grave"==c)){battle_info["deck_"+s][n].status="grave",check_ability_procs("deck_"+s,"moved_to_grave",n);var u=all_available_cards[battle_info["deck_"+s][n].card_id].type;check_ability_procs("deck_"+s,u+"_moved_to_grave",n)}total_timeout+=500*battle_speed,update_deck_counts()}}function set_status(e,t,a){var o=battle_info.combat_units[a],n=o.side;("ally"==t.side&&2==o.side||"enemy"==t.side&&1==o.side)&&(n=2),("ally"==t.side&&1==o.side||"enemy"==t.side&&2==o.side)&&(n=1);var r=battle_info["deck_"+n][e].status+"";if("hand"==r){var s=battle_info["deck_"+n][e].hand_slot+0,c=n+0,d=battle_info["deck_"+n][e].hand_slot_id+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+s+".side_"+c+".hand_slot_id_"+d).remove()},total_timeout+500*battle_speed),check_ability_procs(n,"discarded",a,void 0,void 0)}if("hand"!=r){if("deck"==t.new_status||"hand"==t.new_status&&count_deck_cards(battle_info["deck_"+n])>9){var c=n+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".deck_counter_"+c).addClass("combat_zoom"),$(".deck_counter_"+c).addClass("green_text")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".deck_counter_"+c).removeClass("combat_zoom"),$(".deck_counter_"+c).removeClass("green_text")},total_timeout+500*battle_speed)}if("grave"==t.new_status){var c=n+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".deck_counter_"+c).addClass("combat_zoom"),$(".deck_counter_"+c).addClass("red_text")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".deck_counter_"+c).removeClass("combat_zoom"),$(".deck_counter_"+c).removeClass("red_text")},total_timeout+500*battle_speed)}}return"hand"!=t.new_status?battle_info["deck_"+n][e].status=t.new_status:(battle_info["deck_"+n][e].status="deck",draw_card(n,e)),total_timeout+=500*battle_speed,update_deck_counts(),!0}function remove_card_from_combat(e,t,a){var o=battle_info.combat_units[a],n=o.side;if(("ally"==t.side&&2==o.side||"enemy"==t.side&&1==o.side)&&(n=2),("ally"==t.side&&1==o.side||"enemy"==t.side&&2==o.side)&&(n=1),battle_info["deck_"+n][e].status,"hand"==battle_info["deck_"+n][e].status){var r=battle_info["deck_"+n][e].hand_slot+0,s=n+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+r+".side_"+s).remove()},total_timeout)}delete battle_info["deck_"+n][e],total_timeout+=500*battle_speed,update_deck_counts()}function reduce_ready_time(e,t,a,o){var n=battle_info.combat_units[o],r=n.side;if(("ally"==t.side&&2==n.side||"enemy"==t.side&&1==n.side)&&(r=2),("ally"==t.side&&1==n.side||"enemy"==t.side&&2==n.side)&&(r=1),"hand"==battle_info["deck_"+r][e].status){battle_info["deck_"+r][e].time_left-=a,battle_info["deck_"+r][e].time_left<0&&(battle_info["deck_"+r][e].time_left=0);var s=battle_info["deck_"+r][e].hand_slot_id+0,c=battle_info["deck_"+r][e].time_left+0,d=r+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_id_"+s+".side_"+d+" .card_time").html(c),$(".hand_slot_id_"+s+".side_"+d).addClass("green_glow combat_zoom")},total_timeout),total_timeout+=500*battle_speed,all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_id_"+s+".side_"+d).removeClass("green_glow combat_zoom")},total_timeout+500*battle_speed)}}function increase_ready_time(e,t,a,o){var n=battle_info.combat_units[o],r=n.side;if(("ally"==t.side&&2==n.side||"enemy"==t.side&&1==n.side)&&(r=2),("ally"==t.side&&1==n.side||"enemy"==t.side&&2==n.side)&&(r=1),"hand"==battle_info["deck_"+r][e].status){battle_info["deck_"+r][e].time_left+=a,battle_info["deck_"+r][e].time_left<0&&(battle_info["deck_"+r][e].time_left=0);var s=battle_info["deck_"+r][e].hand_slot_id+0,c=battle_info["deck_"+r][e].time_left+0,d=r+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_id_"+s+".side_"+d+" .card_time").html(c),$(".hand_slot_id_"+s+".side_"+d).addClass("red_glow combat_zoom")},total_timeout),total_timeout+=500*battle_speed,all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_id_"+s+".side_"+d).removeClass("red_glow combat_zoom")},total_timeout+500*battle_speed)}}function receive_damage(e,t,a,o){if(latest_result=0,void 0==battle_info.combat_units[e])return 0;var n=battle_info.combat_units[e],r=battle_info.combat_units[t],s=n.side+0,c=void 0;if(void 0!=r&&(c=r.side+0),void 0!=r&&$.each(r.abilities,function(e,t){!0==match_array_values(all_abilities[e].proc,"add_subtype_to_damage")&&(o=o.concat(all_abilities[e].subtypes))}),amount_reduced=0,a>0){var d=0;if(n.armor>0&&!1==match_array_values(["ignores_armor"],o)){match_array_values(["breaks_armor"],o);var l=a/n.armor;l>=1&&(a-=n.armor,d=n.armor,n.armor=0),l<1&&(round_by_percent(l),n.armor>a?(n.armor-=a,d=a):(d=n.armor,n.armor-=a),a=n.armor<0?-1*n.armor:0),n.armor=0}if(d>0){check_unit_hp(e),timeout_key++;var u=".slot_"+battle_info.combat_units[e].slot+".side_"+battle_info.combat_units[e].side;all_timeouts[timeout_key]=setTimeout(function(){var e=parse_floating_text(d,"#ccc",!1);$(".battle_container .slot_container"+u).append(e)},total_timeout)}}if(a>0&&$.each(n.abilities,function(n,s){if(!0==match_array_values(all_abilities[n].proc,"max_incoming_damage")&&(!0==match_array_values(o,all_abilities[n].subtypes)||void 0==all_abilities[n].subtypes)&&!1==match_array_values(o,all_abilities[n].negated_by)&&(void 0==all_abilities[n].origin_not_self||e!=t)&&(void 0==all_abilities[n].has_origin_unit||void 0!=r&&r.current_health>0)&&(void 0==all_abilities[n].cannot_proc_while_stunned||void 0==battle_info.combat_units[e].effects.stunned||0==battle_info.combat_units[e].effects.stunned)&&(void 0==all_abilities[n].reduce_chance||100*Math.random()<=calculate_effect({amount:all_abilities[n].reduce_chance},e,t,s))){var c=calculate_effect({amount:all_abilities[n].amount},e,t,s);if(a>c){var d=(amount_reduced=a-c)+0;if((a=c)>=0){timeout_key++;var l=".slot_"+battle_info.combat_units[e].slot+".side_"+battle_info.combat_units[e].side;all_timeouts[timeout_key]=setTimeout(function(){var e=parse_floating_text(d,"#ccc",!1);$(".battle_container .slot_container"+l).append(e)},total_timeout),process_ability(e,all_abilities[n],s,t,void 0,"reduce_incoming_damage"),check_ability_delay(e,n)}}}}),a>0&&void 0!=n.effects&&void 0!=n.effects.cursed&&(a+=n.effects.cursed,n.effects.cursed=0,n.effects.cursed<1&&delete n.effects.cursed,update_passive_effects(e)),a>0&&void 0!=n.effects&&void 0!=n.effects.blessed&&n.effects.blessed>0&&(void 0==r||void 0==r.abilities.hexed)){var m=a+0;a-=n.effects.blessed,n.effects.blessed-=m,n.effects.blessed<0&&(n.effects.blessed=0),update_passive_effects(e)}if($.each(n.abilities,function(s,c){!0==match_array_values(all_abilities[s].proc,"reduce_incoming_damage")&&(!0==match_array_values(o,all_abilities[s].subtypes)||void 0==all_abilities[s].subtypes)&&!1==match_array_values(o,all_abilities[s].negated_by)&&(void 0==all_abilities[s].origin_not_self||e!=t)&&(void 0==all_abilities[s].has_origin_unit||void 0!=r&&r.current_health>0)&&(void 0==all_abilities[s].cannot_proc_while_stunned||void 0==battle_info.combat_units[e].effects.stunned||0==battle_info.combat_units[e].effects.stunned)&&!0==check_ability_can_fire(e,all_abilities[s],c,t)&&(void 0==n.ability_delays[s]||n.ability_delays[s]<1)&&(void 0==all_abilities[s].reduce_chance||100*Math.random()<=calculate_effect({amount:all_abilities[s].reduce_chance},e,t,c))&&(process_ability(e,all_abilities[s],c,t,void 0,"reduce_incoming_damage"),amount_reduced=calculate_effect({amount:all_abilities[s].amount},e,t,c),check_ability_delay(e,s),a<amount_reduced&&(amount_reduced=a),a-=amount_reduced)}),!(a>0))return all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("combat_hit")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("combat_hit")},total_timeout+500),0;var v=0,p=n.current_health;void 0!=n.temp_health&&(p+=n.temp_health),a>p&&p>0&&(v=a-p),a>p&&0!=n.slot&&(a=p),1==n.side&&(0==n.slot?check_quests("enemy_hero_damaged"):(check_quests("enemy_unit_damaged"),check_quests("enemy_"+n.type+"_damaged")),check_quests("dealt_damage",a)),void 0!=n.temp_health&&n.temp_health>0?(n.temp_health-=a,n.temp_health<0&&(n.current_health+=n.temp_health,n.temp_health=0)):n.current_health-=a,timeout_key++,passive_effect_count++;var f=a+0;if(n.side,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("combat_hit"),$(".battle_container .unit_id_"+e+" .card_image").addClass("red_glow")},total_timeout),f>0){timeout_key++;var u=".slot_"+battle_info.combat_units[e].slot+".side_"+battle_info.combat_units[e].side;all_timeouts[timeout_key]=setTimeout(function(){var e=parse_floating_text(f,"#f00",!1);$(".battle_container .slot_container"+u).append(e)},total_timeout)}all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("combat_hit"),$(".battle_container .unit_id_"+e+" .card_image").removeClass("red_glow")},total_timeout+500),latest_result=a;var b=a+0;return check_unit_hp(e),latest_result=b,void 0!=battle_info.combat_units[t]&&b>0&&$.each(battle_info.combat_units[t].abilities,function(a,n){!0==match_array_values(all_abilities[a].proc,"dealt_damage")&&(void 0==all_abilities[a].subtypes||!0==match_array_values(all_abilities[a].subtypes,o))&&(void 0==all_abilities[a].not_subtypes||!1==match_array_values(all_abilities[a].not_subtypes,o))&&process_ability(t,all_abilities[a],n,e,void 0,"dealt_damage",!1),latest_result=b}),void 0!=battle_info.combat_units[t]&&b>0&&e<3&&battle_info.combat_units[t].side!=battle_info.combat_units[e].side&&$.each(battle_info.combat_units[t].abilities,function(a,n){!0==match_array_values(all_abilities[a].proc,"dealt_damage_to_hero")&&(void 0==all_abilities[a].subtypes||!0==match_array_values(all_abilities[a].subtypes,o))&&(void 0==all_abilities[a].not_subtypes||!1==match_array_values(all_abilities[a].not_subtypes,o))&&process_ability(t,all_abilities[a],n,e,void 0,"dealt_damage_to_hero",!0),latest_result=b}),void 0!=battle_info.combat_units[e]&&(b>0||d>0)&&$.each(n.abilities,function(a,r){!0==match_array_values(all_abilities[a].proc,"receive_damage")&&(void 0==all_abilities[a].subtypes||!0==match_array_values(all_abilities[a].subtypes,o))&&(void 0==all_abilities[a].not_subtypes||!1==match_array_values(all_abilities[a].not_subtypes,o))&&(void 0==n.ability_delays[a]||n.ability_delays[a]<1)&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("attack")},total_timeout),!0==process_ability(e,all_abilities[a],r,t,void 0,"receive_damage")&&check_ability_delay(e,a)),latest_result=b}),void 0!=battle_info.combat_units[t]&&v>0&&$.each(battle_info.combat_units[t].abilities,function(a,n){!0==match_array_values(all_abilities[a].proc,"overkill")&&(void 0==all_abilities[a].subtypes||!0==match_array_values(all_abilities[a].subtypes,o))&&(void 0==all_abilities[a].not_subtypes||!1==match_array_values(all_abilities[a].not_subtypes,o))&&process_ability(t,all_abilities[a],v,e,void 0,"overkill",!1),latest_result=b}),latest_result=b,(1==e||2==e)&&check_ability_procs(s,"hero_damaged",t,o),check_ability_procs(s,"takes_damage",e,o),check_ability_procs(c,"has_dealt_damage",t,o),latest_result=b,a}function receive_healing(e,t,a,o){var n=battle_info.combat_units[e];if(battle_info.combat_units[t],a>n.health-n.current_health&&(a=n.health-n.current_health),void 0!=n&&void 0!=n.effects&&n.effects.blessed,a>0){n.current_health<0&&(n.current_health=0),n.current_health+=a,n.current_health>0&&void 0!=n.dead&&delete n.dead,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("green_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("green_glow")},total_timeout+500);var r=a+0;timeout_key++;var s=".slot_"+battle_info.combat_units[e].slot+".side_"+battle_info.combat_units[e].side;all_timeouts[timeout_key]=setTimeout(function(){var e=parse_floating_text(r,"rgba(55,255,55,0.9)",!1);$(".battle_container .slot_container"+s).append(e)},total_timeout),check_unit_hp(e)}}function set_hp(e,t,a,o){var n=battle_info.combat_units[e],r="green";a<n.current_health&&(r="purple"),n.current_health=a,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass(r+"_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass(r+"_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}function set_max_hp(e,t,a,o){if(void 0!=battle_info.combat_units[e]){var n=battle_info.combat_units[e],r="green";a<n.health&&(r="purple"),n.health=a,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass(r+"_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass(r+"_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}}function enable_to_act(e,t,a,o){battle_info.combat_units[e].failed_to_act_this_phase=!1,battle_info.combat_units[e].acted_this_turn=0}function go_again(e,t,a,o){var n=battle_info.combat_units[e];n.acted_this_turn>1&&(n.acted_this_turn=1),n.acted_this_turn-=a,delete n.failed_to_act_this_phase,n.failed_to_act_this_phase=!1,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("orange_glow"),$(".battle_container .unit_id_"+e).removeClass("attack"),$(".battle_container .unit_id_"+e).removeClass("combat_zoom")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("orange_glow")},total_timeout+500*battle_speed),total_timeout+=500*battle_speed,"spell"==n.type&&$.each(n.abilities,function(t,a){var o=all_abilities[t];void 0!=battle_info.combat_units[e]&&void 0!=o.proc&&"basic"==o.proc&&process_ability(e,o,a,e)})}function increase_power(e,t,a,o){if(0!=a&&!1!==battle_info.combat_units[e].power){var n=battle_info.combat_units[e];n.power+=a,n.power<0&&(n.power=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("orange_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("orange_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_power(e),check_ability_procs(n.side,n.type+"_gains_power",e),check_ability_procs(n.side,"gains_power",e)}}function grant_temp_power(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e];void 0==n.temp_power&&(n.temp_power=0),n.temp_power+=a,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("orange_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("orange_glow")},total_timeout+500),check_unit_power(e),check_ability_procs(n.side,n.type+"_gains_power",e),check_ability_procs(n.side,"gains_power",e),total_timeout+=500*battle_speed}}function grant_temp_health(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e];void 0==n.temp_health&&(n.temp_health=0),n.temp_health+=a,all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("green_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("green_glow")},total_timeout+500),check_unit_hp(e),check_unit_alive(e),total_timeout+=500*battle_speed}}function increase_health(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e];n.health+=a,n.current_health+=a,n.health<0&&(n.health=0),n.current_health<0&&(n.current_health=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("green_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("green_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}}function reduce_health(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e],r=a+0,s=a+0;n.health-0<a&&(r=n.health-0),n.current_health-0<s&&(s=n.current_health-0),n.health>0&&(n.health-=r),n.current_health>0&&(n.current_health-=s),n.health<0&&(n.health=0),n.current_health<0&&(n.current_health=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}return s}function reduce_current_health(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e],r=a+0;n.current_health-0<r&&(r=n.current_health-0),n.current_health>0&&(n.current_health-=r),n.current_health<0&&(n.current_health=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}return r}function set_health(e,t,a,o){if(0!=a){var n=battle_info.combat_units[e],r="green";a<n.health&&(r="purple"),n.health=a,n.current_health=a,n.health<0&&(n.health=0),n.current_health<0&&(n.current_health=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass(r+"_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass(r+"_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}return a}function reduce_max_health(e,t,a,o){if(void 0!=battle_info.combat_units[e]){var n=battle_info.combat_units[e];n.health-=a,n.health<0&&(n.health=0),n.current_health<0&&(n.current_health=0),n.current_health>n.health&&(n.current_health=n.health),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}}function reduce_armor(e,t,a,o){var n=battle_info.combat_units[e];n.armor>0&&(n.armor-=a,n.armor<0&&(n.armor=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e))}function increase_armor(e,t,a,o){var n=battle_info.combat_units[e];n.armor+=a,n.armor<0&&(n.armor=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("green_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("green_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e)}function set_armor(e,t,a,o){var n=0,r=battle_info.combat_units[e],s=parseInt(r.armor);if(s!=a){r.armor=a,r.armor<0&&(r.armor=0),timeout_key++;var c="red";s<r.armor&&(c="green"),all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass(c+"_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass(c+"_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(e),n=a}return n}function reduce_power(e,t,a,o){var n=battle_info.combat_units[e];!1!==n.power&&(n.power-=a,n.power<0&&(n.power=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_power(e))}function set_power(e,t,a,o){var n=battle_info.combat_units[e],r=n.power+0;n.power=a,n.power<0&&(n.power=0),timeout_key++,r>n.power&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("purple_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("purple_glow")},total_timeout+500)),r<n.power&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("orange_glow")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("orange_glow")},total_timeout+500)),total_timeout+=500*battle_speed,check_unit_power(e)}function grant_temp_skill(e,t,a,o,n,r){if(void 0!=battle_info.combat_units[e]){var s=battle_info.combat_units[e];void 0==s.temp_skills&&(s.temp_skills={}),void 0==s.temp_skills[o]?s.temp_skills[o]=a:s.temp_skills[o]+=a,grant_skill(e,t,a,o,n,r)}}function grant_skill(e,t,a,o,n,r){"random"==o&&5>count_object(battle_info.combat_units[e].abilities)&&(o=find_new_ability(battle_info.combat_units[e].abilities,battle_info.combat_units[e])),"random"==o&&count_object(battle_info.combat_units[e].abilities)>=5&&(o=get_random_key_from_object(battle_info.combat_units[e].abilities));var s=battle_info.combat_units[e];if(void 0==s.abilities[o]){if(void 0!=r&&!0==r){var c={};c[o]=a,$.each(s.abilities,function(e,t){c[e]=t+0}),s.abilities=true_copyobject(c)}else s.abilities[o]=a}else"object"==typeof s.abilities[o]?(s.abilities[o].level+=a,void 0!=all_abilities[o]&&void 0!=all_abilities[o].max_level&&s.abilities[o].level>all_abilities[o].max_level&&(s.abilities[o].level=all_abilities[o].max_level)):(s.abilities[o]+=a,void 0!=all_abilities[o]&&void 0!=all_abilities[o].max_level&&s.abilities[o]>all_abilities[o].max_level&&(s.abilities[o]=all_abilities[o].max_level));"object"==typeof s.abilities[o]?s.abilities[o].level<1&&delete s.abilities[o]:s.abilities[o]<1&&delete s.abilities[o];var d=0;(void 0==n||!0==n)&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass("green_glow")},total_timeout),d=500),timeout_key++;var l=parse_abilities(e);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass("green_glow"),$(".battle_container .unit_id_"+e+" .card_abilities").html(l)},total_timeout+d),update_passive_effects(e),total_timeout+=d*battle_speed}function set_skill(e,t,a,o,n){var r=battle_info.combat_units[e],s="green",c=r.abilities[o]+0;if(void 0==r.abilities[o]&&a>0||void 0!=r.abilities[o]&&r.abilities[o]!=a){r.abilities[o]=a,r.abilities[o]<=0&&(delete r.abilities[o],s="red",e==t&&(s="")),r.abilities[o]<c&&(s="dark");var d=0;void 0!=n&&!0==n&&(timeout_key++,""!=s&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").addClass(s+"_glow")},total_timeout),d=500)),timeout_key++;var l=parse_abilities(e);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_image").removeClass(s+"_glow"),$(".battle_container .unit_id_"+e+" .card_abilities").html(l)},total_timeout+d),total_timeout+=d*battle_speed}}function check_unit_hp(e){var t=battle_info.combat_units[e];t.current_health<1?t.current_health=0:void 0!=t.dead&&delete t.dead,t.current_health>t.health&&(t.current_health=t.health),t.armor<1&&(t.armor=0);var a=t.armor,o=t.current_health,n=0;void 0!=t.temp_health&&(n=t.temp_health);var r=o+n;r<0&&(r=0);var s=t.health+n;s<1&&(s=1);var c=100-o/s*100,d=100-r/s*100,l=n/s*100;all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_health .max_health").html(r),$(".battle_container .unit_id_"+e+" .card_health .current_health").html(""),$(".battle_container .unit_id_"+e+" .card_health .current_health").css("height",d+"%"),$(".battle_container .unit_id_"+e+" .card_health .temp_health").css("height",l+"%"),$(".battle_container .unit_id_"+e+" .card_health .temp_health").css("bottom",100-c+"%"),$(".battle_container .unit_id_"+e+" .card_armor").html(a),a>0?$(".battle_container .unit_id_"+e+" .card_armor").css("opacity",1):$(".battle_container .unit_id_"+e+" .card_armor").css("opacity",0)},total_timeout)}function check_visible_skills(e){var t=battle_info.combat_units[e];void 0!=t&&(void 0!=t.abilities.stealth&&t.abilities.stealth>0?all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("stealth")},total_timeout+10):all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("stealth")},total_timeout+10),void 0!=t.abilities.flying&&t.abilities.flying>0&&(void 0==t.effects||void 0==t.effects.stunned||0==t.effects.stunned)&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("flying")},total_timeout+10)),(void 0==t.abilities.flying||0==t.abilities.flying||void 0!=t.effects&&void 0!=t.effects.stunned&&t.effects.stunned>0)&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("flying")},total_timeout+10)))}function disappear_unit(e,t){if(void 0!=battle_info.combat_units[e]){var a=battle_info.combat_units[e];if(0!==a.slot){if(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("combat_fade")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).remove()},total_timeout+500),void 0!=a.card_id&&"in_play"==battle_info["deck_"+a.origin_side][a.card_id].status){battle_info["deck_"+a.origin_side][a.card_id].status="grave",update_deck_counts(),check_ability_procs(a.origin_side,"moved_to_grave",a.card_id);var o=all_available_cards[battle_info["deck_"+a.origin_side][a.card_id].card_id].type;check_ability_procs(a.origin_side,o+"_moved_to_grave",a.card_id)}delete battle_info.combat_units[e]}}}function destroy_unit(e,t){check_unit_alive(e,t,!0)}function check_unit_alive(e,t,a,o){if(void 0!=battle_info.combat_units[e]){var n=battle_info.combat_units[e],r=n.type+"";if(void 0!=a&&!0==a&&(n.health=0,n.current_health=0,n.temp_health=0),void 0==n.temp_health&&(n.temp_health=0),!1!==n.health&&(0===n.current_health||n.current_health+n.temp_health<=0)&&void 0==n.dead){if(n.dead=!0,1==n.side&&void 0!=t&&void 0!=battle_info.combat_units[t]&&2==battle_info.combat_units[t].side&&(check_quests("enemy_"+n.type+"_killed"),2==battle_info.combat_units[t].unit_id&&check_quests("enemy_"+n.type+"_killed_by_hero")),2==n.side&&void 0!=t&&void 0!=battle_info.combat_units[t]&&1==battle_info.combat_units[t].side&&(check_quests("ally_"+n.type+"_killed"),2==battle_info.combat_units[t].unit_id&&check_quests("ally_"+n.type+"_killed_by_hero")),void 0!=battle_info.combat_units[e]&&(0===n.current_health||n.current_health+n.temp_health<=0)&&$.each(battle_info.combat_units[e].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,["pre_own_death"])&&process_ability(e,all_abilities[a],o,t,void 0,"pre_own_death")}),void 0!=battle_info.combat_units[e]&&(0===n.current_health||n.current_health+n.temp_health<=0)&&void 0!=battle_info.combat_units[t]&&$.each(battle_info.combat_units[t].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,["prekill","prekill_"+n.type])&&process_ability(t,all_abilities[a],o,e,void 0,"prekill")}),void 0!=battle_info.combat_units[e]&&(0===n.current_health||n.current_health+n.temp_health<=0)&&$.each(battle_info.combat_units[e].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,["own_death"])&&process_ability(e,all_abilities[a],o,t,void 0,"own_death")}),void 0!=battle_info.combat_units[e]&&(check_ability_procs(n.side,r+"_death",e),check_ability_procs(n.side,"death",e)),void 0!=battle_info.combat_units[e]&&(void 0!=battle_info.combat_units[t]&&$.each(battle_info.combat_units[t].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,["kill","kill_"+r])&&process_ability(t,all_abilities[a],o,e,void 0,"kill")}),void 0!=battle_info.combat_units[t]&&check_ability_procs(n.side,r+"_killed",t)),void 0!=battle_info.combat_units[e]&&(0===n.current_health||n.current_health+n.temp_health<=0)&&$.each(battle_info.combat_units[e].abilities,function(a,o){!0==match_array_values(all_abilities[a].proc,["post_own_death"])&&process_ability(e,all_abilities[a],o,t,void 0,"post_own_death")}),void 0!=battle_info.combat_units[e]){if(0!==n.slot&&(0===n.current_health||n.current_health+n.temp_health<=0)){if(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).removeClass("flying"),$(".battle_container .unit_id_"+e).removeClass("stealth"),$(".battle_container .unit_id_"+e).addClass("dead")},total_timeout),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).remove()},total_timeout+1e3),void 0!=n.card_id&&"in_play"==battle_info["deck_"+n.origin_side][n.card_id].status){battle_info["deck_"+n.origin_side][n.card_id].status="grave",update_deck_counts(),check_ability_procs(n.origin_side,"moved_to_grave",n.card_id);var s=all_available_cards[battle_info["deck_"+n.origin_side][n.card_id].card_id].type;check_ability_procs(n.origin_side,s+"_moved_to_grave",n.card_id)}check_ability_procs(n.side,"post_any_death",e)}0!==n.slot&&(0===n.current_health||n.current_health+n.temp_health<=0)?delete battle_info.combat_units[e]:void 0!=n.dead&&delete n.dead}else all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).addClass("dead")},total_timeout+2e3),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e).remove()},total_timeout+3e3)}}}function check_ability_procs(e,t,a,o,n){void 0==n&&(n=-10),$.each(battle_info.combat_units,function(r,s){s.slot==n&&check_single_unit_proc(r,e,t,a,o)}),n<5&&check_ability_procs(e,t,a,o,n+1)}function check_single_unit_proc(e,t,a,o,n){if(void 0!=battle_info.combat_units[e]){var r=battle_info.combat_units[e];$.each(r.abilities,function(s,c){if((void 0==r.ability_delays[s]||r.ability_delays[s]<1)&&(void 0==all_abilities[s].subtypes||!0==match_array_values(all_abilities[s].subtypes,n))&&(void 0==all_abilities[s].not_subtypes||!1==match_array_values(all_abilities[s].not_subtypes,n))&&(void 0==all_abilities[s].origin_not_self||o!=e)){var d=!1;r.side==t&&!0==match_array_values(all_abilities[s].proc,"ally_"+a)&&(d=process_ability(e,all_abilities[s],c,o,void 0,"ally_"+a)),r.side!=t&&!0==match_array_values(all_abilities[s].proc,"enemy_"+a)&&(d=process_ability(e,all_abilities[s],c,o,void 0,"enemy_"+a)),!0==match_array_values(all_abilities[s].proc,"any_"+a)&&(d=process_ability(e,all_abilities[s],c,o,void 0,"any_"+a)),!0==match_array_values(all_abilities[s].proc,a)&&(d=process_ability(e,all_abilities[s],c,o,void 0,a)),!0==d&&void 0!=battle_info.combat_units[e]&&check_ability_delay(e,s)}})}}function check_unit_power(e){var t=battle_info.combat_units[e];t.power<1&&!1!==t.power&&(t.power=0);var a=t.power;!1!==a&&void 0!=t.temp_power&&(a+=t.temp_power)<0&&(a=0),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+e+" .card_power").html(a),!1===a?$(".battle_container .unit_id_"+e+" .card_power").addClass("hidden"):$(".battle_container .unit_id_"+e+" .card_power").removeClass("hidden")},total_timeout)}function calculate_effect(e,t,a,o){if(void 0!=e){var n=1;if("object"==typeof o){n=o.level_2;var o=o.level}if("string"==typeof e)var r=e;else var r=e.amount;if("amount_reduced"==r&&(r=amount_reduced),void 0!=battle_info.combat_units[a]){if("origin_cost"==r&&(r=battle_info.combat_units[a].time),"origin_power"==r&&!1!==(r=battle_info.combat_units[a].power)&&void 0!=battle_info.combat_units[a].temp_power&&(r+=battle_info.combat_units[a].temp_power)<0&&(r=0),"origin_armor"==r&&(r=battle_info.combat_units[a].armor),"origin_max_health"==r&&(r=battle_info.combat_units[a].health),"ally_hand_card_count"==r&&(r=count_hand_cards(battle_info["deck_"+battle_info.combat_units[a].side])),"enemy_hand_card_count"==r&&(r=1==battle_info.combat_units[a].side?count_hand_cards(battle_info.deck_2):count_hand_cards(battle_info.deck_1)),"enemy_unit_count"==r&&(r=1==battle_info.combat_units[a].side?count_ally_units(2):count_ally_units(1)),"ally_deck_card_count"==r&&(r=count_deck_cards(battle_info["deck_"+battle_info.combat_units[a].side])),"ally_grave_creature_card_count"==r&&(r=count_grave_cards(battle_info["deck_"+battle_info.combat_units[a].side],"creature")),"ally_burn_count"==r){var s=0;$.each(battle_info.combat_units,function(e,t){t.side==battle_info.combat_units[a].side&&void 0!=t.effects&&void 0!=t.effects.burning&&t.effects.burning>0&&(s+=t.effects.burning)}),r=s}"origin_energy"==r&&(r=void 0!=battle_info.combat_units[a].effects&&void 0!=battle_info.combat_units[a].effects.energy?battle_info.combat_units[a].effects.energy:0),"origin_poison"==r&&(r=void 0!=battle_info.combat_units[a].effects&&void 0!=battle_info.combat_units[a].effects.poisoned?battle_info.combat_units[a].effects.poisoned:0),"origin_burn"==r&&(r=void 0!=battle_info.combat_units[a].effects&&void 0!=battle_info.combat_units[a].effects.burning?battle_info.combat_units[a].effects.burning:0),"origin_doom"==r&&(r=void 0!=battle_info.combat_units[a].effects&&void 0!=battle_info.combat_units[a].effects.doom?battle_info.combat_units[a].effects.doom:0),"times_played"==r&&(r=0,void 0!=battle_info.combat_units[a].card_id&&void 0!=battle_info.combat_units[a].origin_side&&void 0!=battle_info["deck_"+battle_info.combat_units[a].origin_side][battle_info.combat_units[a].card_id].played&&(r=battle_info["deck_"+battle_info.combat_units[a].origin_side][battle_info.combat_units[a].card_id].played))}if(void 0!=battle_info.combat_units[t]){if("target_cost"==r&&(r=battle_info.combat_units[t].time),"target_power"==r&&!1!==(r=battle_info.combat_units[t].power)&&void 0!=battle_info.combat_units[t].temp_power&&(r+=battle_info.combat_units[t].temp_power)<0&&(r=0),"target_health"==r){var c=battle_info.combat_units[t].current_health;void 0!=battle_info.combat_units[t].temp_health&&(c+=parseInt(battle_info.combat_units[t].temp_health)),r=c}"target_max_health"==r&&(r=battle_info.combat_units[t].health),"target_energy"==r&&(r=void 0!=battle_info.combat_units[t].effects&&void 0!=battle_info.combat_units[t].effects.energy?battle_info.combat_units[t].effects.energy:0),"target_slot"==r&&(r=battle_info.combat_units[t].slot),"ally_units_heroes_artifacts"==r&&(r=count_ally_units(battle_info.combat_units[t].side)+count_ally_artifacts(battle_info.combat_units[t].side)+1),"target_ally_units"==r&&(r=count_ally_units(battle_info.combat_units[t].side)),"adjacent_structure_count"==r&&(r=count_adjacent(battle_info.combat_units[t].slot,battle_info.combat_units[t].side,"structure")),"adjacent_creature_count"==r&&(r=count_adjacent(battle_info.combat_units[t].slot,battle_info.combat_units[t].side,"creature")),"adjacent_count"==r&&(r=count_adjacent(battle_info.combat_units[t].slot,battle_info.combat_units[t].side)),"target_burn"==r&&(r=void 0!=battle_info.combat_units[t].effects&&void 0!=battle_info.combat_units[t].effects.burning?battle_info.combat_units[t].effects.burning:0),"target_poison"==r&&(r=void 0!=battle_info.combat_units[t].effects&&void 0!=battle_info.combat_units[t].effects.poisoned?battle_info.combat_units[t].effects.poisoned:0)}if("units_in_play"==r&&(r=count_ally_units(1)+count_ally_units(2)),"ability_level"==r&&(r=o),"ability_level_2"==r&&(r=n),"latest_result"==r&&(r=latest_result),void 0!=e.amount_factor&&("ability_level"==e.amount_factor?r*=o:r*=e.amount_factor),void 0!=e.amount_factors&&$.each(e.amount_factors,function(e,t){"ability_level"==t?r*=o:r*=t}),void 0!=e.amount_adjustment&&(r+=calculate_effect({amount:e.amount_adjustment},t,a,o)),void 0!=e.crit_chance&&void 0!=e.crit_amount_factor&&100*Math.random()<=e.crit_chance&&(r*=e.crit_amount_factor),void 0!=e.crit_on_themes&&void 0!=e.crit_amount_factor&&void 0!=t&&void 0!=battle_info.combat_units[t]&&match_array_values(battle_info.combat_units[t].theme,e.crit_on_themes)&&(r*=e.crit_amount_factor),void 0!=e.crit_on_has_skills&&void 0!=e.crit_amount_factor&&void 0!=t&&void 0!=battle_info.combat_units[t]&&$.each(e.crit_on_has_skills,function(a,o){void 0!=battle_info.combat_units[t].abilities&&void 0!=battle_info.combat_units[t].abilities[o]&&(r*=e.crit_amount_factor)}),r>0&&void 0!=battle_info.combat_units[a]&&void 0!=e.scales&&!0==e.scales){if(1==battle_info.combat_units[a].origin_side){var d=get_effective_power_factor();r=r*d>=1?round_by_percent(r*d):Math.ceil(r*d)}if(2==battle_info.combat_units[a].origin_side){var l=get_upgrade_factor("ability_effect",e.subtypes);r*=l}}if(void 0!=battle_info.combat_units[a]&&2==battle_info.combat_units[a].origin_side){var l=get_upgrade_factor(e.type,e.subtypes);1!=l&&(r=round_by_percent(r*l))}if("number"==typeof r){if(void 0!=e.amount_rounding)switch(e.amount_rounding){case"down":r=Math.floor(r);break;case"random":r=round_by_percent(r);break;default:r=Math.ceil(r)}else r=Math.ceil(r);void 0!=e.max_amount&&("ability_level"==e.max_amount&&void 0!=o&&r>o&&(r=o),"number"==typeof e.max_amount&&r>e.max_amount&&(r=e.max_amount))}return r}}function count_adjacent(e,t,a){var o=0;return $.each(battle_info.combat_units,function(n,r){r.side==t&&(r.slot==e+1||r.slot==e-1)&&(void 0==a||r.type==a)&&o++}),o}function find_targets(e,t,a,o,n,r){if(void 0==s)var s={};var c=battle_info.combat_units[e];if(void 0!=t.use_latest_slot&&!0==t.use_latest_slot){var c=copyobject(battle_info.combat_units[e]);c.slot=latest_slot,latest_slot=-10}if("unit"==t.target||"unit_or_hero"==t.target||"hero"==t.target||"artifact"==t.target||"any"==t.target){var d="any",l=1,u=5;("unit_or_hero"==t.target||"hero"==t.target)&&(l=0),"hero"==t.target&&(u=0),"artifact"==t.target&&(l=-5,u=-1),"any"==t.target&&(l=-10,u=5),("ally"==t.side&&2==c.side||"enemy"==t.side&&1==c.side)&&(d=2),("ally"==t.side&&1==c.side||"enemy"==t.side&&2==c.side)&&(d=1);var m=get_highest_key_in_object(s)+1;if(void 0==t.from_right||!1==t.from_right)for(var v=l;v<=u;v++)$.each(battle_info.combat_units,function(e,t){(t.side==d||"any"==d)&&t.slot==v&&(s[m]=t.unit_id,m++)});else for(var v=u;v>=l;v--)$.each(battle_info.combat_units,function(e,t){(t.side==d||"any"==d)&&t.slot==v&&(s[m]=t.unit_id,m++)});if(void 0!=t.origin_unit&&!0==t.origin_unit){var p=!1;$.each(s,function(e,t){t==a&&(s={0:a},p=!0)}),!1==p&&(s={})}void 0!=t.not_self&&!0==t.not_self&&(s=filter_targets_by_not_self(s,e)),s=filter_targets_by_immunities(s,e,n,a),void 0!=t.specific_slots&&$.each(s,function(e,a){!1==match_array_values(battle_info.combat_units[a].slot,t.specific_slots)&&delete s[e]}),void 0!=t.has_origin_card&&(s=filter_targets_by_has_origin_card(s,t.has_origin_card)),void 0!=t.not_types&&(s=filter_targets_by_not_types(s,t.not_types)),void 0!=t.subtypes&&(s=filter_targets_by_subtypes(s,t.subtypes)),void 0!=t.not_subtypes&&(s=filter_targets_by_not_subtypes(s,t.not_subtypes)),void 0!=t.card_ids&&(s=filter_targets_by_card_ids(s,t.card_ids,!1)),void 0!=t.not_card_ids&&(s=filter_targets_by_card_ids(s,t.not_card_ids,!0)),void 0!=t.has_ability&&(s=filter_targets_by_has_ability(s,t.has_ability)),void 0!=t.has_theme&&(s=filter_targets_by_has_theme(s,t.has_theme)),void 0!=t.does_not_have_ability&&(s=filter_targets_by_does_not_have_ability(s,t.does_not_have_ability)),void 0!=t.max_abilities&&(s=filter_targets_by_max_abilities(s,t.max_abilities,o)),void 0!=t.is_transformed&&!0==t.is_transformed&&(s=filter_targets_by_is_transformed(s)),void 0!=t.damaged&&!0==t.damaged&&(s=filter_targets_by_damaged(s)),void 0!=t.damaged&&!1==t.damaged&&(s=filter_targets_by_not_damaged(s)),void 0!=t.has_negative_effect&&!0==t.has_negative_effect&&(s=filter_targets_by_has_negative_effect(s)),void 0!=t.has_effect&&(s=filter_targets_by_has_effect(s,t.has_effect,o)),void 0!=t.not_stunned&&(s=filter_targets_by_not_stunned(s,t.not_stunned)),void 0!=t.min_cost&&0!=t.min_cost&&(s=filter_targets_by_min_cost(s,t.min_cost,a,o)),void 0!=t.max_cost&&0!=t.max_cost&&(s=filter_targets_by_max_cost(s,t.max_cost,a,o)),void 0!=t.min_hp&&(s=filter_targets_by_min_hp(s,t.min_hp)),void 0!=t.min_total_hp&&(s=filter_targets_by_min_total_hp(s,t.min_total_hp)),void 0!=t.max_hp&&(s=filter_targets_by_max_hp(s,t.max_hp,a,o)),void 0!=t.min_armor&&t.min_armor>0&&(s=filter_targets_by_min_armor(s,t.min_armor)),void 0!=t.max_armor&&(s=filter_targets_by_max_armor(s,calculate_effect({amount:t.max_armor},e,a,o))),void 0!=t.min_power&&t.min_power>=0&&(s=filter_targets_by_min_power(s,t.min_power)),void 0!=t.max_power&&(s=filter_targets_by_max_power(s,calculate_effect({amount:t.max_power},e,a,o))),void 0!=t.has_opposing&&!1==t.has_opposing&&(s=filter_targets_by_has_no_opposing(s)),void 0!=t.has_opposing&&!0==t.has_opposing&&(s=filter_targets_by_has_opposing(s)),void 0!=t.has_opposing_creature&&!1==t.has_opposing_creature&&(s=filter_targets_by_has_no_opposing(s,"creature")),void 0!=t.has_opposing_creature&&!0==t.has_opposing_creature&&(s=filter_targets_by_has_opposing(s,"creature")),void 0!=t.has_opposing_structure&&!1==t.has_opposing_structure&&(s=filter_targets_by_has_no_opposing(s,"structure")),void 0!=t.has_opposing_structure&&!0==t.has_opposing_structure&&(s=filter_targets_by_has_opposing(s,"structure")),void 0!=t.has_adjacent_creature&&!0==t.has_adjacent_creature&&(s=filter_targets_by_has_adjacent(s,"creature")),void 0!=t.has_adjacent_creature&&!1==t.has_adjacent_creature&&(s=filter_targets_by_has_no_adjacent(s,"creature")),void 0!=t.has_opposing_structure&&!1==t.has_opposing_structure&&(s=filter_targets_by_has_no_opposing(s,"structure")),void 0!=t.has_opposing_structure&&!0==t.has_opposing_structure&&(s=filter_targets_by_has_opposing(s,"structure")),void 0!=t.slot_free&&!0==t.slot_free&&(s=filter_targets_by_slot_free(s)),void 0!=t.position&&(s=filter_targets_by_position(s,e,t.position,c.slot)),void 0!=t.lowest_power&&!0==t.lowest_power&&(s=filter_targets_by_lowest_power(s)),void 0!=t.highest_power&&!0==t.highest_power&&(s=filter_targets_by_highest_power(s)),void 0!=t.lowest_hp&&!0==t.lowest_hp&&(s=filter_targets_by_lowest_hp(s)),void 0!=t.highest_hp&&!0==t.highest_hp&&(s=filter_targets_by_highest_hp(s)),void 0!=t.highest_max_hp&&!0==t.highest_max_hp&&(s=filter_targets_by_highest_max_hp(s)),void 0!=t.highest_armor&&!0==t.highest_armor&&(s=filter_targets_by_highest_armor(s)),void 0!=t.highest_cost&&!0==t.highest_cost&&(s=filter_targets_by_highest_cost(s)),void 0!=t.lowest_cost&&!0==t.lowest_cost&&(s=filter_targets_by_lowest_cost(s)),!1==match_array_values(n.proc,["redirect"])&&(s=filter_targets_by_redirect(s,n,a))}if("card"==t.target){var d=c.side;("ally"==t.side&&2==c.side||"enemy"==t.side&&1==c.side)&&(d=2),("ally"==t.side&&1==c.side||"enemy"==t.side&&2==c.side)&&(d=1);var m=0;if("hand"!=t.status)$.each(battle_info["deck_"+d],function(e,a){(a.status==t.status||"any"==t.status)&&("hand"!=t.status||a.time_left>0||void 0!=t.can_target_zero)&&(s[m]=e,m++)});else for(var f=1;f<=10;f++)$.each(battle_info["deck_"+d],function(e,a){a.hand_slot==f&&(a.status==t.status||"any"==t.status)&&("hand"!=t.status||a.time_left>0||void 0!=t.can_target_zero)&&(s[m]=e,m++)});if(void 0!=t.origin_unit&&!0==t.origin_unit){var p=!1;$.each(s,function(e,t){t==a&&(s={0:a},p=!0)}),!1==p&&(s={})}void 0!=t.max_abilities&&(s=filter_target_cards_by_max_abilities(s,t.max_abilities,o,d)),void 0!=t.types&&filter_targets_by_card_type(s,t.types,d),void 0!=t.highest_time_left&&!0==t.highest_time_left&&(s=filter_targets_by_highest_time_left(s,d)),void 0!=t.lowest_time_left&&!0==t.lowest_time_left&&(s=filter_targets_by_lowest_time_left(s,d)),void 0!=t.lowest_cost&&!0==t.lowest_cost&&(s=filter_targets_by_lowest_cost_card(s,d))}void 0!=t.add_targets&&!0==t.add_targets&&void 0!=r&&count_object(r)>0&&$.each(r,function(e,t){s[get_highest_key_in_object(s)+1]=t});var b=calculate_effect({amount:t.target_amount},void 0,e,o);if(count_object(s)>b)for(var h=count_object(s)-b-1;h>=0;h--)delete s[get_random_key_from_object(s)];return s}function filter_targets_by_redirect(e,t,a){var o=[];void 0!=t.effects&&void 0!=t.effects[0]&&void 0!=t.effects[0].subtypes&&(o=t.effects[0].subtypes);var n={};return $.each(e,function(t,r){if(0==count_object(n))for(var s=-5;s<=5;s++)$.each(battle_info.combat_units,function(c,d){d.slot==s&&$.each(d.abilities,function(s,d){if((void 0==all_abilities[s].proc_chance||all_abilities[s].proc_chance>=100*Math.random())&&!0==match_array_values(all_abilities[s].proc,["redirect"])&&!0==match_array_values(o,all_abilities[s].subtypes)&&void 0==n[t]&&!0==check_ability_can_fire(c,all_abilities[s],d,t)){var l=find_targets(c,all_abilities[s].from_targets,r,d,all_abilities[s]);$.each(l,function(o,l){if(l==r){var u=find_targets(c,all_abilities[s].to_target,a,d,all_abilities[s]);count_object(u)>0&&(e[t]=u[get_random_key_from_object(u)],n[t]=!0,void 0!=all_abilities[s].reduce_skill_after_use&&void 0!=battle_info.combat_units[c]&&"spell"!=battle_info.combat_units[c].type&&(grant_skill(c,c,-1,all_abilities[s].reduce_skill_after_use,!1),check_visible_skills(c)),void 0!=all_abilities[s].remove_skill_after_use&&void 0!=battle_info.combat_units[c]&&"spell"!=battle_info.combat_units[c].type&&(set_skill(c,c,0,all_abilities[s].remove_skill_after_use,!1),check_visible_skills(c)))}})}})})}),e}function filter_targets_by_has_origin_card(e,t){return $.each(e,function(a,o){(void 0==t||!0==t)&&void 0==battle_info.combat_units[o].card_id&&delete e[a],void 0!=t&&!1==t&&void 0!=battle_info.combat_units[o].card_id&&delete e[a]}),e}function filter_targets_by_slot_free(e){return $.each(e,function(t,a){!1==check_slot_free(battle_info.combat_units[a].slot,battle_info.combat_units[a].side)&&delete e[t]}),e}function filter_targets_by_not_self(e,t){return $.each(e,function(a,o){o==t&&delete e[a]}),e}function filter_targets_by_has_theme(e,t){return $.each(e,function(a,o){!1==match_array_values(battle_info.combat_units[o].theme,t)&&delete e[a]}),e}function filter_targets_by_has_ability(e,t){return $.each(e,function(a,o){void 0==battle_info.combat_units[o].abilities[t]&&delete e[a]}),e}function filter_targets_by_does_not_have_ability(e,t){return $.each(e,function(a,o){void 0!=battle_info.combat_units[o].abilities[t]&&delete e[a]}),e}function filter_targets_by_max_abilities(e,t,a){return $.each(e,function(o,n){$.each(t,function(t,r){var s=r;"ability_level"==s&&(s=a-1),void 0!=battle_info.combat_units[n].abilities[t]&&battle_info.combat_units[n].abilities[t]>s&&delete e[o]})}),e}function filter_target_cards_by_max_abilities(e,t,a,o){return $.each(e,function(n,r){var s=all_available_cards[battle_info["deck_"+o][r].card_id];$.each(t,function(t,o){var r=o;"ability_level"==r&&(r=a-1),void 0!=s.abilities[t]&&s.abilities[t]>r&&delete e[n]})}),e}function filter_targets_by_immunities(e,t,a,o){return $.each(e,function(t,n){var r=!1;$.each(battle_info.combat_units[n].abilities,function(e,t){var n=all_abilities[e].grants_immunities;$.each(a.effects,function(e,t){void 0!=n&&(!0==match_array_values(n,[t.type])||!0==match_array_values(n,t.subtypes)||void 0!=battle_info.combat_units[o]&&!0==match_array_values(n,[battle_info.combat_units[o].type]))&&(r=!0)}),void 0!=all_abilities[e].negated_by_ability&&void 0!=battle_info.combat_units[o]&&$.each(battle_info.combat_units[o].abilities,function(t,a){t==all_abilities[e].negated_by_ability&&(r=!1)})}),!0==r&&delete e[t]}),e}function filter_targets_by_highest_time_left(e,t){var a=!1;return $.each(e,function(e,o){(battle_info["deck_"+t][o].time_left>a||!1==a)&&(a=battle_info["deck_"+t][o].time_left)}),$.each(e,function(o,n){battle_info["deck_"+t][n].time_left<a&&delete e[o]}),e}function filter_targets_by_lowest_time_left(e,t){var a=!1;return $.each(e,function(e,o){(battle_info["deck_"+t][o].time_left<a||!1==a)&&(a=battle_info["deck_"+t][o].time_left)}),$.each(e,function(o,n){battle_info["deck_"+t][n].time_left>a&&delete e[o]}),e}function filter_targets_by_card_type(e,t,a){return $.each(e,function(o,n){!1==match_array_values([all_available_cards[battle_info["deck_"+a][n].card_id].type],t)&&delete e[o]}),e}function filter_targets_by_not_types(e,t){return $.each(e,function(a,o){!0==match_array_values([battle_info.combat_units[o].type],t)&&delete e[a],!0==match_array_values(["hero"],t)&&(1==o||2==o)&&delete e[a]}),e}function filter_targets_by_subtypes(e,t){return $.each(e,function(a,o){var n=battle_info.combat_units[o].subtypes;(void 0==n||!1==match_array_values(n,t))&&delete e[a]}),e}function filter_targets_by_not_subtypes(e,t){return $.each(e,function(a,o){var n=battle_info.combat_units[o].subtypes;void 0!=n&&!0==match_array_values(n,t)&&delete e[a]}),e}function filter_targets_by_card_ids(e,t,a){return $.each(e,function(o,n){match_array_values([battle_info.combat_units[n].card_type],t)==a&&delete e[o]}),e}function filter_targets_by_not_card_ids(e,t){return $.each(e,function(a,o){!0==match_array_values([battle_info.combat_units[o].name],t)&&delete e[a]}),e}function filter_targets_by_damaged(e){return $.each(e,function(t,a){battle_info.combat_units[a].current_health>=battle_info.combat_units[a].health&&delete e[t]}),e}function filter_targets_by_not_damaged(e){return $.each(e,function(t,a){battle_info.combat_units[a].current_health!=battle_info.combat_units[a].health&&delete e[t]}),e}function filter_targets_by_is_transformed(e){return $.each(e,function(t,a){void 0==battle_info.combat_units[a].original_card_type&&delete e[t]}),e}function filter_targets_by_has_negative_effect(e){return $.each(e,function(t,a){(void 0==battle_info.combat_units[a].effects||(void 0==battle_info.combat_units[a].effects.burning||0==battle_info.combat_units[a].effects.burning)&&(void 0==battle_info.combat_units[a].effects.poisoned||0==battle_info.combat_units[a].effects.poisoned)&&(void 0==battle_info.combat_units[a].effects.cursed||0==battle_info.combat_units[a].effects.cursed)&&(void 0==battle_info.combat_units[a].effects.doom||0==battle_info.combat_units[a].effects.doom))&&delete e[t]}),e}function filter_targets_by_has_effect(e,t,a){var o=t.amount;return"ability_level"==o&&(o=a),$.each(e,function(n,r){void 0==battle_info.combat_units[r].effects&&0!=o&&"min"==t.limit?delete e[n]:(void 0==battle_info.combat_units[r].effects[t.effect_name]&&0!=o&&"min"==t.limit&&delete e[n],$.each(battle_info.combat_units[r].effects,function(r,s){var c=o;"ability_level"==c&&void 0!=a&&(c=a),t.effect_name==r&&(s>=c&&"less"==t.limit||s>c&&"max"==t.limit||s<c&&"min"==t.limit)&&delete e[n]}))}),e}function filter_targets_by_not_stunned(e,t){return $.each(e,function(t,a){void 0!=battle_info.combat_units[a].effects.stunned&&battle_info.combat_units[a].effects.stunned>0&&delete e[t]}),e}function filter_targets_by_min_cost(e,t,a,o){return $.each(e,function(n,r){var s=calculate_effect(t,n,a,o);battle_info.combat_units[r].time<s&&delete e[n]}),e}function filter_targets_by_max_cost(e,t,a,o){return $.each(e,function(n,r){var s=calculate_effect(t,n,a,o);battle_info.combat_units[r].time>s&&delete e[n]}),e}function filter_targets_by_min_hp(e,t){return $.each(e,function(a,o){var n=battle_info.combat_units[o].current_health;void 0!=battle_info.combat_units[o].temp_health&&(n+=battle_info.combat_units[o].temp_health),n<t&&!1!==n&&delete e[a]}),e}function filter_targets_by_min_total_hp(e,t){return $.each(e,function(a,o){battle_info.combat_units[o].health<t&&!1!==battle_info.combat_units[o].health&&delete e[a]}),e}function filter_targets_by_max_hp(e,t,a,o){return $.each(e,function(n,r){var s=calculate_effect({amount:t},r,a,o),c=battle_info.combat_units[r].current_health;void 0!=battle_info.combat_units[r].temp_health&&(c+=battle_info.combat_units[r].temp_health),c>s&&delete e[n]}),e}function filter_targets_by_min_armor(e,t){return $.each(e,function(a,o){battle_info.combat_units[o].armor<t&&delete e[a]}),e}function filter_targets_by_max_armor(e,t){return $.each(e,function(a,o){battle_info.combat_units[o].armor>=t&&delete e[a]}),e}function filter_targets_by_min_power(e,t){return $.each(e,function(a,o){var n=calculate_effect({amount:"target_power"},o,void 0,void 0);(n<t||!1===n)&&delete e[a]}),e}function filter_targets_by_max_power(e,t){return $.each(e,function(a,o){calculate_effect({amount:"target_power"},o,void 0,void 0)>t&&delete e[a]}),e}function filter_targets_by_lowest_hp(e){var t=!1;return $.each(e,function(e,a){var o=battle_info.combat_units[a].current_health;void 0!=battle_info.combat_units[a].temp_health&&(o+=parseInt(battle_info.combat_units[a].temp_health)),(o<t||!1==t)&&(t=o)}),$.each(e,function(a,o){var n=battle_info.combat_units[o].current_health;void 0!=battle_info.combat_units[o].temp_health&&(n+=parseInt(battle_info.combat_units[o].temp_health)),n>t&&delete e[a]}),e}function filter_targets_by_highest_hp(e){var t=!1;return $.each(e,function(e,a){var o=battle_info.combat_units[a].current_health;void 0!=battle_info.combat_units[a].temp_health&&(o+=parseInt(battle_info.combat_units[a].temp_health)),(o>t||!1==t)&&(t=o)}),$.each(e,function(a,o){var n=battle_info.combat_units[o].current_health;void 0!=battle_info.combat_units[o].temp_health&&(n+=parseInt(battle_info.combat_units[o].temp_health)),n<t&&delete e[a]}),e}function filter_targets_by_highest_max_hp(e){var t=!1;return $.each(e,function(e,a){(battle_info.combat_units[a].health>t||!1==t)&&(t=battle_info.combat_units[a].health)}),$.each(e,function(a,o){battle_info.combat_units[o].health<t&&delete e[a]}),e}function filter_targets_by_highest_armor(e){var t=!1;return $.each(e,function(e,a){(battle_info.combat_units[a].armor>t||!1==t)&&(t=battle_info.combat_units[a].armor)}),$.each(e,function(a,o){battle_info.combat_units[o].armor<t&&delete e[a]}),e}function filter_targets_by_lowest_power(e){var t=!1;return $.each(e,function(e,a){(battle_info.combat_units[a].power<t||!1==t)&&(t=!1===battle_info.combat_units[a].power?0:battle_info.combat_units[a].power)}),$.each(e,function(a,o){battle_info.combat_units[o].power>t&&delete e[a]}),e}function filter_targets_by_highest_power(e){var t=!1;return $.each(e,function(e,a){(battle_info.combat_units[a].power>t||!1==t)&&(t=battle_info.combat_units[a].power)}),$.each(e,function(a,o){battle_info.combat_units[o].power<t&&delete e[a]}),e}function filter_targets_by_highest_cost(e){var t=!1;return $.each(e,function(e,a){(battle_info.combat_units[a].time>t||!1==t)&&(t=battle_info.combat_units[a].time)}),$.each(e,function(a,o){battle_info.combat_units[o].time<t&&delete e[a]}),e}function filter_targets_by_lowest_cost(e){var t=-1;return $.each(e,function(e,a){(battle_info.combat_units[a].time<t||-1==t)&&(t=battle_info.combat_units[a].time)}),$.each(e,function(a,o){battle_info.combat_units[o].time>t&&t>-1&&delete e[a]}),e}function filter_targets_by_lowest_cost_card(e,t){var a=!1;return $.each(e,function(e,o){(all_available_cards[battle_info["deck_"+t][o].card_id].time<a||!1==a)&&(a=all_available_cards[battle_info["deck_"+t][o].card_id].time)}),$.each(e,function(o,n){all_available_cards[battle_info["deck_"+t][n].card_id].time>a&&!1!=a&&delete e[o]}),e}function filter_targets_by_has_no_opposing(e,t){return $.each(e,function(a,o){var n=!1;$.each(battle_info.combat_units,function(e,a){a.side!=battle_info.combat_units[o].side&&a.slot==battle_info.combat_units[o].slot&&a.current_health>0&&(void 0==t||a.type==t)&&(n=!0)}),!0==n&&delete e[a]}),e}function filter_targets_by_has_opposing(e,t){return $.each(e,function(a,o){var n=!1;$.each(battle_info.combat_units,function(e,a){a.side!=battle_info.combat_units[o].side&&a.slot==battle_info.combat_units[o].slot&&a.current_health>0&&(void 0==t||a.type==t)&&(n=!0)}),!1==n&&delete e[a]}),e}function filter_targets_by_has_adjacent(e,t){return $.each(e,function(a,o){var n=!1;$.each(battle_info.combat_units,function(e,a){a.side==battle_info.combat_units[o].side&&(a.slot==battle_info.combat_units[o].slot+1||a.slot==battle_info.combat_units[o].slot-1)&&0!=a.slot&&a.current_health>0&&(void 0==t||a.type==t)&&(n=!0)}),!1==n&&delete e[a]}),e}function filter_targets_by_has_no_adjacent(e,t){return $.each(e,function(a,o){var n=!1;$.each(battle_info.combat_units,function(e,a){a.side==battle_info.combat_units[o].side&&(a.slot==battle_info.combat_units[o].slot+1||a.slot==battle_info.combat_units[o].slot-1)&&0!=a.slot&&a.current_health>0&&(void 0==t||a.type==t)&&(n=!0)}),!0==n&&delete e[a]}),e}function filter_targets_by_position(e,t,a,o){void 0==o&&(o=0);var n=o+0;if(n<0&&(n=0),"self"==a&&$.each(e,function(a,o){o!=t&&delete e[a]}),"opposing"==a&&$.each(e,function(t,a){battle_info.combat_units[a].slot!=n&&delete e[t]}),"opposing_wide"==a&&$.each(e,function(t,a){(battle_info.combat_units[a].slot>n+1||battle_info.combat_units[a].slot<n-1)&&delete e[t]}),"adjacent"==a&&$.each(e,function(t,a){battle_info.combat_units[a].slot!=n-1&&battle_info.combat_units[a].slot!=n+1&&delete e[t]}),"not_adjacent"==a&&$.each(e,function(t,a){(battle_info.combat_units[a].slot==n-1||battle_info.combat_units[a].slot==n+1)&&delete e[t]}),"nearest"==a){var r=10;$.each(e,function(e,t){var a=battle_info.combat_units[t].slot-n;a<0&&(a*=-1),a<r&&(r=a)}),$.each(e,function(t,a){var o=battle_info.combat_units[a].slot-n;o<0&&(o*=-1),o>r&&delete e[t]})}if("right"==a){var s=0;$.each(e,function(e,t){battle_info.combat_units[t].slot>s&&(s=battle_info.combat_units[t].slot)}),$.each(e,function(t,a){battle_info.combat_units[a].slot<s&&delete e[t]})}if("left"==a){var c=10;$.each(e,function(e,t){battle_info.combat_units[t].slot<c&&(c=battle_info.combat_units[t].slot)}),$.each(e,function(t,a){battle_info.combat_units[a].slot>c&&delete e[t]})}return e}function process_combat_units(e,t,a){for(var o=-5;o<=5;o++)$.each(battle_info.combat_units,function(n,r){r.side==e&&r.acted_this_turn<1&&r.slot==o&&!0==combat_alive&&(process_single_unit(n,void 0,a,t),check_all_ready_cards())});var n=!1;$.each(battle_info.combat_units,function(t,a){a.side==e&&a.acted_this_turn<1&&(n=!0)}),!0==n&&!0==combat_alive&&process_combat_units(e,t,a)}function enable_all_units_to_act(e,t){$.each(battle_info.combat_units,function(a,o){(void 0==t||o.side==t)&&(o.failed_to_act_this_phase=!1,(void 0==o.acted_this_turn||o.acted_this_turn>0||!0==e)&&(o.acted_this_turn=0),void 0!=e&&!0==e&&(o.used_ability=!1))})}function check_all_ready_cards(e){e=void 0;for(var t=1;t<=2;t++)if(void 0==e||e==t)for(var a=1;a<=10;a++)$.each(battle_info["deck_"+t],function(e,o){o.time_left<=0&&"hand"==o.status&&o.hand_slot==a&&!0==combat_alive&&play_card(t,e)});for(var o=!0,t=1;t<=2;t++)(void 0==e||e==t)&&$.each(battle_info["deck_"+t],function(e,t){t.time_left<=0&&"hand"==t.status&&(o=!1)});!1==o&&!0==combat_alive&&check_all_ready_cards(e)}function play_card(e,t,a,o){var n=all_available_cards[battle_info["deck_"+e][t].card_id],r=!0,s=1;if(1==e&&(s=2),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_allies&&count_ally_units(e)<n.abilities.minimum_allies&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_ally_creatures&&count_ally_units(e,"creature")<n.abilities.minimum_ally_creatures&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_dead_ally_creatures&&count_grave_cards(battle_info["deck_"+e],"creature")<n.abilities.minimum_dead_ally_creatures&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_enemies&&count_enemy_units(e)<n.abilities.minimum_enemies&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_enemy_creatures&&count_enemy_units(e,"creature")<n.abilities.minimum_enemy_creatures&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.maximum_allies&&count_ally_units(e)>n.abilities.maximum_allies&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.maximum_enemies&&count_enemy_units(e)>n.abilities.maximum_enemies&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.minimum_units&&count_units()<n.abilities.minimum_units&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.maximum_units&&count_units()>n.abilities.maximum_units&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.no_allies&&count_ally_units(e)>0&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.maximum_hero_health&&battle_info.combat_units[e].current_health/battle_info.combat_units[e].health*100>n.abilities.maximum_hero_health&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.min_enemy_hand_cards&&count_hand_cards(battle_info["deck_"+s])<n.abilities.min_enemy_hand_cards&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.min_hand_cards&&count_hand_cards(battle_info["deck_"+e])<n.abilities.min_hand_cards&&(r=!1),(void 0==a||!1==a)&&void 0!=n.abilities.max_hand_cards&&count_hand_cards(battle_info["deck_"+e])>n.abilities.max_hand_cards&&(r=!1),!0==r){var c=!1;battle_info["deck_"+e][t].status="in_play",("creature"==n.type||"structure"==n.type||"object"==n.type)&&(c=play_unit_card(e,battle_info["deck_"+e][t].card_id,t,a,o)),"artifact"==n.type&&(c=play_artifact_card(e,battle_info["deck_"+e][t].card_id,t)),("spell"==n.type||"attack"==n.type||"consumable"==n.type)&&(c=play_action_card(e,battle_info["deck_"+e][t].card_id,t)),!0==c&&update_deck_counts()}else var c=!1;if(!0==c&&(void 0==battle_info["deck_"+e][t].played?battle_info["deck_"+e][t].played=1:battle_info["deck_"+e][t].played+=1),!1==c&&battle_info["deck_"+e][t].time_left<1){battle_info["deck_"+e][t].status="hand",battle_info["deck_"+e][t].time_left<1&&(battle_info["deck_"+e][t].time_left=1);var d=battle_info["deck_"+e][t].hand_slot+0,l=battle_info["deck_"+e][t].time_left+0,u=e+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+d+".side_"+u+" .card_time").html(l)},total_timeout)}else check_ability_procs(e,"card_played"),void 0==o&&check_all_ready_cards()}function clone_unit(e,t,a,o,n){var r=!1,s=find_free_slot(e,battle_info.combat_units[t].card_type);if(!1!=s&&!0==combat_alive){var c=++highest_unit_id;battle_info.combat_units[c]=true_copyobject(battle_info.combat_units[t]),battle_info.combat_units[c].abilities={},$.each(battle_info.combat_units[t].abilities,function(e,t){"bring_clone"!=e&&(void 0==n.remove_skills||!1==match_array_values(n.remove_skills,e))&&(battle_info.combat_units[c].abilities[e]=t)}),battle_info.combat_units[c].slot=s,battle_info.combat_units[c].unit_id=c,battle_info.combat_units[c].card_id=void 0,battle_info.combat_units[c].acted_this_turn=0,void 0!=a&&!0==a&&(void 0==battle_info.combat_units[c].effects.stunned?battle_info.combat_units[c].effects.stunned=1:battle_info.combat_units[c].effects.stunned+=1),r=!0;var d=0;void 0!=battle_info["deck_"+e][t]&&(d=battle_info["deck_"+e][t].hand_slot);var l="";if(void 0!=o&&void 0!=battle_info.combat_units[o]&&("creature"==battle_info.combat_units[o].type||"structure"==battle_info.combat_units[o].type||"object"==battle_info.combat_units[o].type)){var u=parse_combat_unit(battle_info.combat_units[c],"slot_"+battle_info.combat_units[o].slot,!0);l="slot_"+battle_info.combat_units[o].slot}else var u=parse_combat_unit(battle_info.combat_units[c],"hand_card fake_hand_slot_"+d);timeout_key++;var m=battle_info.combat_units[c].slot;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(u),setTimeout(function(){$(".unit_id_"+c).removeClass("hand_card"),$(".unit_id_"+c).removeClass("fake_hand_slot_"+d),$(".unit_id_"+c).removeClass(l),$(".unit_id_"+c).addClass("slot_"+m)},50)},total_timeout),check_visible_skills(c),check_unit_power(c),check_unit_hp(c),update_passive_effects(c),total_timeout+=500*battle_speed,$.each(battle_info.combat_units[c].abilities,function(e,t){!0==match_array_values(all_abilities[e].proc,["on_play"])&&"bring_clone"!=e&&(total_timeout+=500,process_ability(c,all_abilities[e],t,void 0,"on_play"))})}return r}function turn_into(e,t,a,o){if(void 0!=battle_info.combat_units[e]&&void 0!=t.card_id){var n=true_copyobject(battle_info.combat_units[e]),r=true_copyobject(battle_info.combat_units[e].effects),s=0;void 0!=battle_info.combat_units[e].abilities.blessed&&(s+=battle_info.combat_units[e].abilities.blessed);var c=battle_info.combat_units[e].card_type,d=t.card_id+"",l=t.card_subtypes;if("target_subtypes"==t.card_subtypes&&(l=battle_info.combat_units[e].subtypes),void 0!=t.additional_subtypes&&$.each(t.additional_subtypes,function(e,t){l[get_highest_key_in_object(l)+1]=t}),"random"==d&&(d=get_random_card_based_on_time(t.card_type,calculate_effect({amount:t.max_time,amount_adjustment:t.max_time_adjustment},e,a,o),void 0,void 0,l,calculate_effect({amount:t.min_time},e,a,o),[c])),!1!=d){var u=create_combat_unit(all_available_cards[d],n.side);0==n.slot&&void 0!=all_available_cards[d].hero_version&&(u=create_hero(d,n.side)),$.each(u,function(t,a){battle_info.combat_units[e][t]=a}),battle_info.combat_units[e].card_type=d,void 0==n.original_card_type&&(battle_info.combat_units[e].original_card_type=c),battle_info.combat_units[e].current_health=battle_info.combat_units[e].health,$.each(battle_info.combat_units[e].abilities,function(t,a){void 0!=all_abilities[t].remove_on_transform&&!0==all_abilities[t].remove_on_transform&&delete battle_info.combat_units[e].abilities[t]}),s>0&&(void 0==battle_info.combat_units[e].abilities.blessed||battle_info.combat_units[e].abilities.blessed<s)&&(battle_info.combat_units[e].abilities.blessed=s),battle_info.combat_units[e].effects=true_copyobject(r),battle_info.combat_units[e].original_unit=true_copyobject(n);var m=parse_abilities(e);all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e+" .card_image").css("background-image","url(images/"+u.image+")"),void 0!=u.image_position?$(".unit_id_"+e+" .card_image").css("background-position",u.image_position):$(".unit_id_"+e+" .card_image").css("background-position",""),$(".unit_id_"+e+" .card_name").html(capitalizeFirstLetter(u.name)),$(".battle_container .unit_id_"+e+" .card_abilities").html(m),$(".battle_container .unit_id_"+e+" .card_color").removeClass("color_green color_blue color_purple color_red color_orange color_yellow color_colorless"),1==count_object(u.color)?($(".battle_container .unit_id_"+e+" .card_color").addClass("color_"+u.color[0]),$(".battle_container .unit_id_"+e+" .color_number_0").addClass("color_number_0_not"),$(".battle_container .unit_id_"+e+" .color_number_0").removeClass("color_number_0"),$(".battle_container .unit_id_"+e+" .color_number_1").addClass("hidden")):($(".battle_container .unit_id_"+e+" .color_number_0").addClass("color_"+u.color[0]),$(".battle_container .unit_id_"+e+" .color_number_1").addClass("color_"+u.color[1]),$(".battle_container .unit_id_"+e+" .color_number_1").removeClass("hidden"))},total_timeout),check_unit_hp(e),check_visible_skills(e),check_unit_power(e),update_passive_effects(e),total_timeout+=500*battle_speed}}}function turn_into_original(e,t){if(void 0==battle_info.combat_units[e]||void 0==battle_info.combat_units[e].original_card_type)return!1;battle_info.combat_units[e].original_card_type;var a=true_copyobject(battle_info.combat_units[e]),o=true_copyobject(battle_info.combat_units[e].original_unit),n=true_copyobject(battle_info.combat_units[e].effects);battle_info.combat_units[e].card_type=battle_info.combat_units[e].original_card_type,$.each(o,function(t,a){battle_info.combat_units[e][t]=a}),battle_info.combat_units[e].slot=a.slot,battle_info.combat_units[e].side=a.side,delete battle_info.combat_units[e].original_card_type,$.each(battle_info.combat_units[e].abilities,function(t,a){void 0!=all_abilities[t].remove_on_transform&&!0==all_abilities[t].remove_on_transform&&delete battle_info.combat_units[e].abilities[t]}),battle_info.combat_units[e].effects=true_copyobject(n);var r=parse_abilities(e);return all_timeouts[++timeout_key]=setTimeout(function(){$(".unit_id_"+e+" .card_image").css("background-image","url(images/"+o.image+")"),void 0!=o.image_position?$(".unit_id_"+e+" .card_image").css("background-position",o.image_position):$(".unit_id_"+e+" .card_image").css("background-position",""),$(".unit_id_"+e+" .card_name").html(capitalizeFirstLetter(o.name)),$(".battle_container .unit_id_"+e+" .card_abilities").html(r),$(".battle_container .unit_id_"+e+" .card_color").removeClass("color_green color_blue color_purple color_red color_orange color_yellow color_colorless"),1==count_object(o.color)?($(".battle_container .unit_id_"+e+" .card_color").addClass("color_"+o.color[0]),$(".battle_container .unit_id_"+e+" .color_number_0").addClass("color_number_0_not"),$(".battle_container .unit_id_"+e+" .color_number_0").removeClass("color_number_0"),$(".battle_container .unit_id_"+e+" .color_number_1").addClass("hidden")):($(".battle_container .unit_id_"+e+" .color_number_0_not").addClass("color_number_0"),$(".battle_container .unit_id_"+e+" .color_number_0_not").removeClass("color_number_0_not"),$(".battle_container .unit_id_"+e+" .color_number_0").addClass("color_"+o.color[0]),$(".battle_container .unit_id_"+e+" .color_number_1").addClass("color_"+o.color[1]),$(".battle_container .unit_id_"+e+" .color_number_1").removeClass("hidden"))},total_timeout),check_unit_hp(e),check_visible_skills(e),check_unit_power(e),update_passive_effects(e),total_timeout+=500*battle_speed,!0}function play_unit_card(e,t,a,o,n){var r=!1,s=find_free_slot(e,t);if((void 0!=o&&!1==s||void 0!=o&&!0!=o)&&(s=find_free_slot(e,t,"none",o,void 0,n,void 0)),!1!=s&&!0==combat_alive){var c=++highest_unit_id;battle_info.combat_units[c]=create_combat_unit(all_available_cards[t],e),battle_info.combat_units[c].slot=s,battle_info.combat_units[c].side=e,battle_info.combat_units[c].origin_side=e,battle_info.combat_units[c].unit_id=c,battle_info.combat_units[c].card_id=a,battle_info.combat_units[c].card_type=t,e==active_turn?battle_info.combat_units[c].acted_this_turn=0:battle_info.combat_units[c].acted_this_turn=1,battle_info.combat_units[c].used_ability=!1,battle_info.combat_units[c].current_health=battle_info.combat_units[c].health,r=!0;var d=0;void 0!=battle_info["deck_"+e][a]&&(d=battle_info["deck_"+e][a].hand_slot);var l="",u="side_"+e;if(void 0!=n&&void 0!=battle_info.combat_units[n]&&("creature"==battle_info.combat_units[n].type||"structure"==battle_info.combat_units[n].type||"object"==battle_info.combat_units[n].type||"spell"==battle_info.combat_units[n].type||"artifact"==battle_info.combat_units[n].type)){battle_info.combat_units[n].side!=e&&(u="side_"+battle_info.combat_units[n].side);var m=parse_combat_unit(battle_info.combat_units[c],"slot_"+battle_info.combat_units[n].slot+" combat_unzoom "+u,!0);l="slot_"+battle_info.combat_units[n].slot+" combat_unzoom "+u}else var m=parse_combat_unit(battle_info.combat_units[c],"hand_card fake_hand_slot_"+d,!0);timeout_key++;var v=battle_info.combat_units[c].slot;if(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(m),$(".unit_id_"+c).removeClass("side_"+e),$(".unit_id_"+c).addClass(u)},total_timeout),timeout_key++,void 0!=battle_info["deck_"+e][a]){var p=battle_info["deck_"+e][a].hand_slot+0,f=e+0,b=battle_info["deck_"+e][a].hand_slot_id+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+p+".side_"+f+".hand_slot_id_"+b).each(function(){this.remove()})},total_timeout),battle_info["deck_"+e][a].status="in_play"}all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+c).removeClass("hand_card"),$(".unit_id_"+c).removeClass("fake_hand_slot_"+d),$(".unit_id_"+c).removeClass(l),$(".unit_id_"+c).removeClass(u),$(".unit_id_"+c).addClass("side_"+e),$(".unit_id_"+c).addClass("slot_"+v)},total_timeout+150),check_visible_skills(c),update_passive_effects(c),total_timeout+=1e3*battle_speed,void 0!=battle_info.combat_units[n]&&$.each(battle_info.combat_units[n].abilities,function(e,t){!0==match_array_values(all_abilities[e].proc,["played_unit"])&&process_ability(n,all_abilities[e],t,c,void 0,"played_unit")}),check_ability_procs(e,all_available_cards[t].type+"_card_played",c),check_ability_procs(e,"unit_card_played",c),2==e&&(check_quests(all_available_cards[t].type+"_card_played"),add_battle_stats(all_available_cards[t].type+"_card_played"),$.each(all_available_cards[t].subtypes,function(e,t){check_quests(t+"_card_played")})),void 0!=battle_info.combat_units[c]&&$.each(battle_info.combat_units[c].abilities,function(e,t){!0==match_array_values(all_abilities[e].proc,["on_play"])&&(total_timeout+=1e3*battle_speed,void 0!=battle_info.combat_units[c]&&process_ability(c,all_abilities[e],t,void 0,void 0,"on_play"))}),void 0!=battle_info["deck_"+e][a]&&"hand"==battle_info["deck_"+e][a].status&&(r=!1)}return r}function play_action_card(e,t,a,o){var n=!1;if(!0==combat_alive){var r=++highest_unit_id;battle_info.combat_units[r]=create_combat_unit(all_available_cards[t],e),battle_info.combat_units[r].slot=-10,battle_info.combat_units[r].side=e,battle_info.combat_units[r].origin_side=e,battle_info.combat_units[r].unit_id=r,battle_info.combat_units[r].card_id=a,battle_info.combat_units[r].card_type=t,battle_info.combat_units[r].acted_this_turn=0,battle_info.combat_units[r].used_ability=!1,battle_info.combat_units[r].current_health=battle_info.combat_units[r].health,n=!0;var s=0;void 0!=battle_info["deck_"+e][a]&&(s=battle_info["deck_"+e][a].hand_slot+0);var c=parse_combat_unit(battle_info.combat_units[r],"hand_card fake_hand_slot_"+s),d=total_timeout+0;total_timeout+=1500*battle_speed,check_ability_procs(e,all_available_cards[t].type+"_card_preplayed",r);var l=!1,u=!1;if(void 0!=battle_info.combat_units[r]?l=process_single_unit(r,!0):(u=!0,l=!0),!0==l||void 0!=o){check_ability_procs(e,all_available_cards[t].type+"_card_willbeplayed",r);var m=0;void 0!=a&&(m=battle_info["deck_"+e][a].hand_slot+0);var v=e+0;void 0!=battle_info["deck_"+e][a]&&void 0!=battle_info.combat_units[r]&&(battle_info["deck_"+e][a].status="grave",check_ability_procs("deck_"+e,"moved_to_grave",a)),all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+s+".side_"+v).remove(),$(".battle_container").append(c),setTimeout(function(){$(".unit_id_"+r).removeClass("hand_card"),$(".unit_id_"+r).removeClass("fake_hand_slot_"+s)},100)},d),total_timeout+=500*battle_speed,void 0!=battle_info.combat_units[r]&&total_timeout<d+5e3*battle_speed&&(total_timeout=d+5e3*battle_speed),void 0!=battle_info.combat_units[r]&&(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+r).remove()},total_timeout),total_timeout+=500*battle_speed),!1==u&&(check_ability_procs(e,all_available_cards[t].type+"_card_played",a),2==e&&(check_quests(all_available_cards[t].type+"_card_played"),add_battle_stats(all_available_cards[t].type+"_card_played"),$.each(all_available_cards[t].subtypes,function(e,t){check_quests(t+"_card_played")})))}else total_timeout=d+0;delete battle_info.combat_units[r]}return l}function play_artifact_card(e,t,a,o){var n=!1;o=!0;var r=find_free_artifact_slot(e);if(!1!=r&&!0==combat_alive){var s=++highest_unit_id;battle_info.combat_units[s]=create_combat_unit(all_available_cards[t],e),battle_info.combat_units[s].slot=r,battle_info.combat_units[s].side=e,battle_info.combat_units[s].origin_side=e,battle_info.combat_units[s].unit_id=s,battle_info.combat_units[s].card_id=a,battle_info.combat_units[s].card_type=t,battle_info.combat_units[s].acted_this_turn=0,battle_info.combat_units[s].used_ability=!1,battle_info.combat_units[s].current_health=battle_info.combat_units[s].health,n=!0;var c=0;void 0!=battle_info["deck_"+e][a]&&(c=battle_info["deck_"+e][a].hand_slot);var d=parse_combat_unit(battle_info.combat_units[s],"hand_card fake_hand_slot_"+c),l=total_timeout+0;if(total_timeout+=100*battle_speed,void 0!=o){var u=0;void 0!=a&&(u=battle_info["deck_"+e][a].hand_slot+0);var m=e+0;void 0!=battle_info["deck_"+e][a]&&(battle_info["deck_"+e][a].status="in_play"),all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+u+".side_"+m).remove(),$(".battle_container").append(d),setTimeout(function(){$(".unit_id_"+s).removeClass("hand_card"),$(".unit_id_"+s).removeClass("fake_hand_slot_"+c)},100)},l),total_timeout<l+100&&(total_timeout=l+100),all_timeouts[++timeout_key]=setTimeout(function(){},total_timeout),$.each(battle_info.combat_units,function(e,t){"artifact"==t.type&&t.side}),setTimeout(function(){$(".unit_id_"+s).addClass("placed")},total_timeout),total_timeout+=500*battle_speed,check_ability_procs(e,all_available_cards[t].type+"_card_played",a),2==e&&(check_quests(all_available_cards[t].type+"_card_played"),add_battle_stats(all_available_cards[t].type+"_card_played"),$.each(all_available_cards[t].subtypes,function(e,t){check_quests(t+"_card_played")})),$.each(battle_info.combat_units[s].abilities,function(e,t){!0==match_array_values(all_abilities[e].proc,["on_play"])&&(total_timeout+=1e3*battle_speed,process_ability(s,all_abilities[e],t,void 0,void 0,"on_play"))})}return!0}return!1}function find_free_artifact_slot(e){for(var t=!1,a={},o=-5;o<=-1;o++)!0==check_slot_free(o,e)&&(a[o]=o);return pick_left_most_slot(a)}function find_free_slot(e,t,a,o,n,r,s){var c=!1,d={},l=all_available_cards[t];if("artifact"!=l.type)for(var u=1;u<=5;u++){var m=check_slot_free(u,e);!0==m&&(d[u]=u)}else for(var u=-5;u<=-1;u++){var m=check_slot_free(u,e);!0==m&&(d[u]=u)}return void 0==a&&void 0!=l.safe_slot&&!0==l.safe_slot&&(d=filter_free_slots_by_safe(d,n)),void 0==a&&void 0!=l.safe_slot&&!1==l.safe_slot&&(d=filter_free_slots_by_not_safe(d,n)),void 0!=a&&!0==a&&(d=filter_free_slots_by_safe(d,n)),void 0!=a&&!1==a&&(d=filter_free_slots_by_not_safe(d,n)),void 0!=s&&$.each(s,function(e,t){"has_adjacent_structure"==e&&!0==t&&(d=filter_free_slots_by_has_adjacent(d,"structure",r)),"has_adjacent_creature"==e&&!0==t&&(d=filter_free_slots_by_has_adjacent(d,"creature",r)),"opposing_structure"==e&&(d=filter_free_slots_by_opposing(d,"structure",r,t))}),count_object(d)>0&&(void 0==o?((void 0==l.placement||"left"==l.placement)&&(c=pick_left_most_slot(d)),void 0!=l.placement&&"right"==l.placement&&(c=pick_right_most_slot(d)),void 0!=l.placement&&"random"==l.placement&&(c=pick_random_slot(d))):("right"==o&&(c=pick_right_most_slot(d)),"left"==o&&(c=pick_left_most_slot(d)),"random"==o&&(c=pick_random_slot(d)),"furthest"==o&&(c=pick_furthest_slot(d,r)),"adjacent_of_origin"==o&&(c=pick_adjacent_slot(d,r)),"origin_old_slot"==o&&(c=pick_origin_old_slot(d,r)),"opposing"==o&&(c=void 0!=r&&void 0!=battle_info.combat_units[r]&&void 0!=d[battle_info.combat_units[r].slot]&&battle_info.combat_units[r].slot))),c}function filter_free_slots_by_opposing(e,t,a,o){return $.each(e,function(a,n){var r=!1;$.each(battle_info.combat_units,function(e,a){a.slot==n&&(void 0==t||t==a.type)&&(r=!0)}),r==o&&delete e[a]}),e}function filter_free_slots_by_has_adjacent(e,t,a){return $.each(e,function(o,n){var r=!1;$.each(battle_info.combat_units,function(e,o){(o.slot==n+1||o.slot==n-1)&&(void 0==t||t==o.type)&&(void 0==a||a!=o.unit_id)&&o.side==battle_info.combat_units[a].side&&(r=!0)}),!1==r&&delete e[o]}),e}function check_slot_free(e,t){var a=!0;return $.each(battle_info.combat_units,function(o,n){var r=0;void 0!=n.current_health&&n.current_health>0&&void 0==n.dead&&(r+=n.current_health),void 0!=n.temp_health&&n.temp_health>0&&void 0==n.dead&&(r+=n.temp_health),n.side==t&&n.slot==e&&(r>0||!1==n.health)&&void 0==n.dead&&(a=!1)}),a}function filter_free_slots_by_safe(e,t){return $.each(e,function(a,o){$.each(battle_info.combat_units,function(n,r){r.slot==o&&(void 0==t||t==r.type)&&delete e[a]})}),e}function filter_free_slots_by_not_safe(e,t){return $.each(e,function(a,o){var n=!1;$.each(battle_info.combat_units,function(e,a){a.slot==o&&(void 0==t||t==a.type)&&a.current_health>0&&(n=!0)}),!1==n&&delete e[a]}),e}function pick_left_most_slot(e){var t=!1;return $.each(e,function(e,a){(!1==t||a<t)&&(t=a)}),t}function pick_right_most_slot(e){var t=!1;return $.each(e,function(e,a){(!1==t||a>t)&&(t=a)}),t}function pick_furthest_slot(e,t){var a=!1,o=0;void 0!=battle_info.combat_units[t]&&(o=battle_info.combat_units[t].slot);var n=0;return $.each(e,function(e,t){var r=t-o;r<0&&(r*=-1),r>=n&&(a=t,n=r+0)}),a}function pick_random_slot(e){var t=!1;return e[get_random_key_from_object(e)]}function pick_adjacent_slot(e,t){var a=!1,o=battle_info.combat_units[t].slot;return $.each(e,function(t,a){a!=o-1&&a!=o+1&&delete e[t]}),count_object(e)>0&&(a=e[get_random_key_from_object(e)]),a}function pick_origin_old_slot(e,t){var a=!1,o=!1;return void 0!=battle_info.combat_units[t].old_slot&&(o=battle_info.combat_units[t].old_slot),$.each(e,function(t,a){a!=o&&delete e[t]}),count_object(e)>0&&(a=e[get_random_key_from_object(e)]),a}function reduce_all_hand_times(e){var t=!1;$.each(battle_info["deck_"+e],function(a,o){if("hand"==o.status&&o.time_left>0&&!0==combat_alive){t=!0,o.time_left-=1;var n=o.hand_slot+0,r=o.time_left+0,s=e+0;all_timeouts[++timeout_key]=setTimeout(function(){$(".hand_slot_"+n+".side_"+s+" .card_time").html(r)},total_timeout)}}),!0==t&&!0==combat_alive&&(total_timeout+=500*battle_speed)}function add_card_to_combat_deck(e,t,a){if(void 0!=all_available_cards[t]){var o=battle_info["deck_"+e],n=get_highest_key_in_object(o)+1;o[n]={card_id:t,status:"deck",time_left:all_available_cards[t].time},"grave"==a&&(o[n].status="grave"),update_deck_counts(),"hand"==a?draw_card(e,n):total_timeout+=250*battle_speed}}function draw_card(e,t,a,o,n){void 0==n&&(n=!0);var r=battle_info["deck_"+e],s=count_deck_cards(r,a),c=Math.ceil(Math.random()*s),d=!1,l=get_first_free_hand_slot(r),u=0,m=!1;hand_slot_id+=1,!1!=l&&s>0&&!0==combat_alive&&($.each(r,function(o,s){if(("deck"==s.status||void 0!=t)&&(void 0==a||all_available_cards[s.card_id].type==a)&&(0==--c&&void 0==t||void 0!=t&&o==t)&&!1==d){m=o,void 0!=all_available_cards[s.card_id].abilities.righthand&&(l=get_last_free_hand_slot(r)),s.status="hand",s.hand_slot=l,s.time_left=all_available_cards[s.card_id].time,s.hand_slot_id=hand_slot_id;var v=parse_hand_card(e,o,n,hand_slot_id);all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container").append(v),all_timeouts[timeout_key]=setTimeout(function(){$(".hand_card.hand_slot_"+l).removeClass("just_drawn")},50)},total_timeout),d=!0,u=all_available_cards[s.card_id].time}}),!0==d&&(update_deck_counts(),u>0?total_timeout+=500*battle_speed:total_timeout+=500),!1!=m&&!0==n&&check_ability_procs(e,"card_drawn",m,[])),0==s&&!0==combat_alive&&void 0!=o&&receive_damage(e,void 0,o,[])}function parse_hand_card(e,t,a,o){var n=battle_info["deck_"+e][t],r="",s="",c=all_available_cards[n.card_id];void 0!=a&&!0==a&&(s="just_drawn");var d="";(2==e||!0==test_mode)&&(d="onclick=\"show_card_details('"+n.card_id+"')\"");var l=!1;if(r+='<div class="card hand_card hand_slot_'+n.hand_slot+" side_"+e+" "+s+" hand_slot_id_"+o+'" '+d+' style="">',2==e&&void 0!=gamedata.hand_card_back&&""!=gamedata.hand_card_back&&(l=!0,r+='<div class="hand_card_back" style="background-image:url(images/'+gamedata.hand_card_back+')"></div>'),1==e&&void 0!=enemy_card_back&&""!=enemy_card_back&&(l=!0,r+='<div class="hand_card_back" style="background-image:url(images/'+enemy_card_back+')"></div>'),void 0==gamedata.show_hand_colors||gamedata.show_hand_colors,count_object(c.color)>1?$.each(c.color,function(e,t){r+='<div class="card_color color_'+t+" color_number_"+e+'"></div>'}):r+='<div class="card_color color_'+c.color[0]+'"></div>',r+='<div class="card_time">'+n.time_left+"</div>",2==e){var u=findLongestWord(c.name),m=13;u>8&&(m=13*(8/u)),r+='<div class="card_name" style="font-size:'+m+'px">'+c.name+"</div>"}return r+="</div>"}function show_unit_details(e,t){var a="";$.each($(".unit.slot_"+t+".side_"+e),function(e,t){var o=t.getAttribute("data-card_type");void 0!=all_available_cards[o]&&(a=o)}),""!=a&&$.each(battle_info.combat_units,function(o,n){n.side==e&&n.slot==t&&(a=n.card_type)}),""!=a&&(0==t?(show_card_details(a,!0),pause_game()):(show_card_details(a),pause_game()))}function get_first_free_hand_slot(e){for(var t=!1,a=1;a<11;a++){var o=!0;!1==t?$.each(e,function(e,t){"hand"==t.status&&void 0!=t.hand_slot&&t.hand_slot==a&&(o=!1)}):o=!1,!0==o&&(t=a)}return t}function get_last_free_hand_slot(e){for(var t=!1,a=10;a>0;a--){var o=!0;!1==t?$.each(e,function(e,t){"hand"==t.status&&void 0!=t.hand_slot&&t.hand_slot==a&&(o=!1)}):o=!1,!0==o&&(t=a)}return t}function clear_all_timeouts(){$.each(all_timeouts,function(e,t){clearTimeout(all_timeouts[e]),delete all_timeouts[e]}),clearTimeout(next_turn_timeout),clearTimeout(next_action_timeout)}function set_all_enemy_cards(e){$.each(battle_info.deck_1,function(t,a){a.card_id=e})}function update_wins_losses(e,t,a){void 0==a?$.post("ajax.php",{data:"update_wins_losses",deck_id:arena_deck_id,wins:e,losses:t},function(e){}):(console.log(gamedata.account_id),$.post("ajax.php",{data:"update_wins_losses",current_id:gamedata.account_id,deck_id:arena_deck_id,wins:e,losses:t},function(e){console.log(e)}))}function resign_combat(){clear_all_timeouts(),$(".projectile").remove(),!0==endless_waves?(current_reward_origin="waves",current_reward_text="You resigned at wave "+endless_wave_count+"...",show_content("current_rewards")):(gamedata.battles_lost++,gamedata.summon_min_power*=.9,saveToLocalStorage(),show_content("summon"))}function end_combat(e){void 0!=e&&!0==e&&(gamedata.battles_lost++,gamedata.summon_min_power*=.9,saveToLocalStorage()),clear_all_timeouts(),$(".projectile").remove(),"random"==current_battle_type&&(void 0!=map_hero&&void 0!=all_available_cards[map_hero]?show_content("map"):show_content("random_battles")),"summoned"==current_battle_type&&show_content("summon")}function pause_game(){}function check_ready_to_resume(){!0==game_paused&&(game_paused=!1,!0==ready_to_resume&&!0==combat_alive&&process_next_turn())}function process_player_combat_boosts(){void 0!=gamedata.combat_boosts&&(gamedata.combat_boosts=sortObj(gamedata.combat_boosts),$.each(gamedata.combat_boosts,function(e,t){t>0&&(("creature"==all_available_cards[e].type||"structure"==all_available_cards[e].type||"object"==all_available_cards[e].type)&&play_unit_card(2,e),("spell"==all_available_cards[e].type||"consumable"==all_available_cards[e].type)&&play_action_card(2,e),"artifact"==all_available_cards[e].type&&play_artifact_card(2,e),gamedata.combat_boosts[e]-=1)}),saveToLocalStorage())}function process_enemy_combat_boosts(){void 0!=battle_info.enemy_combat_boosts&&$.each(battle_info.enemy_combat_boosts,function(e,t){if(t>0)for(var a=t-1;a>=0;a--)play_action_card(1,e,void 0,!0)})}var projectile_count=0;function create_projectile(e,t,a,o,n,r,s,c,d,l){if(void 0!=battle_info.combat_units[e]&&(void 0!=battle_info.combat_units[t]||void 0!=n)){void 0==s&&(s=""),c=void 0!=c?'style="color:'+c+'"':"",void 0==d&&(d=1e3);var u=d*battle_speed;u<500&&(u=500);var m=++projectile_count+0,v=battle_info.combat_units[e],p=v.slot+"",f=v.side+"";if(void 0==n)var b=battle_info.combat_units[t],h="slot_"+b.slot,g=b.side+"";else{if("deck"==n&&void 0!=r){var w=1;"ally"==r&&2==f&&(w=2),"enemy"==r&&1==f&&(w=2);var b=battle_info["deck_"+w][t],h="hand_card hand_slot_"+b.hand_slot;"hand"!=b.status&&(h="hand_card deck_slot");var g=w+""}if("deck"==n&&void 0==r)var h=h="hand_card deck_slot",g=f+""}var y="";void 0!=l&&!0==l&&(y=" big ");var k='<div class="projectile card unit projectile_count_'+m+" projectile_"+a+" slot_"+p+" side_"+f+" "+y+'"><div class="projectile_text" '+c+">"+s+"</div></div>";all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container").append(k)},total_timeout-0),all_timeouts[++timeout_key]=setTimeout(function(){$(".projectile_count_"+m).removeClass("slot_"+p+" side_"+f),$(".projectile_count_"+m).addClass(h+" side_"+g)},total_timeout+u/10*1),void 0!=o&&!0==o?(all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .projectile_count_"+m).addClass("dead")},total_timeout+u/3*1),all_timeouts[++timeout_key]=setTimeout(function(){$(".battle_container .projectile_count_"+m).remove()},total_timeout+1*u)):all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .projectile_count_"+m).remove()},total_timeout+1*u)}}var possible_pickups={},pickup_counter=0,clear_pickup_timers={},last_spawned_pickup=0;function spawn_monthly_pickup(){if(100>count_object(pickup_rewards)&&last_spawned_pickup+1e3<nowint()){last_spawned_pickup=nowint();var e=++pickup_counter+0;1>count_object(possible_pickups)&&(possible_pickups=get_all_possible_pickups());var t=1,a=get_random_key_from_object_based_on_num_value(possible_pickups);.75>Math.random()&&(a="scraps",t=round_by_percent(get_upgrade_factor("floating_scraps","any",!0)));var o='<div class="pickup pickup_'+pickup_counter+'" style="top:'+Math.floor(80*Math.random()+10)+'%" onclick="claim_pickups('+pickup_counter+')">'+parse_card(a)+"</div>";$(".battle_container").append(o),pickup_rewards[e]={card_id:a,card_amount:t},clear_pickup_timers[e]=setTimeout(function(){pickup_rewards={},$(".pickup_"+e).remove()},15e3)}}function claim_pickups(e){if(void 0!=pickup_rewards[e]){if(void 0!=gamedata.upgrades){var t=get_upgrade_factor("loot",[pickup_rewards[e].card_id],!0);pickup_rewards[e].card_amount=round_by_percent(pickup_rewards[e].card_amount*t)}check_quests("claimed_pickup"),void 0!=all_available_cards[pickup_rewards[e].card_id]&&gain_card(pickup_rewards[e].card_id,pickup_rewards[e].card_amount),"scraps"==pickup_rewards[e].card_id&&(gamedata.scraps+=pickup_rewards[e].card_amount)}$(".pickup_"+e).remove(),delete pickup_rewards[e],clearTimeout(clear_pickup_timers[e])}function get_all_possible_pickups(){var e={},t=new Date().getMonth()+1;return $.each(all_available_cards,function(a,o){match_array_values(t,o.months_available)&&"currency"==o.type&&(e[a]=1/Math.sqrt(o.value))}),e.peasant=1,e}var current_battle_type="",battle_info={},total_timeout=0,active_turn=1,total_turn_counter=0,combat_alive=!1,difficulty_setting=1,current_test_deck=0,arena_deck={},arena_deck_id=0,arena_reward_amount=0,current_arena_player_name="",endless_waves=!1,fight_number=0,king_of_the_hill_streak=0,enemy_card_back="",arena_card_back="",fixed_hero=!1,next_random_hero="",map_hero="",battle_stats={},endless_wave_count=1;function show_random_battle(){enemy_card_back="",current_battle_type="random",show_content("battle")}function show_battle(){if(set_game_speed(!1),battle_speed>.65&&($(".main_window").removeClass("game_speed_fast"),$(".main_window").removeClass("game_speed_medium"),$(".main_window").addClass("game_speed_slow")),.65==battle_speed&&($(".main_window").removeClass("game_speed_slow"),$(".main_window").removeClass("game_speed_fast"),$(".main_window").addClass("game_speed_medium")),battle_speed<.65&&($(".main_window").removeClass("game_speed_slow"),$(".main_window").removeClass("game_speed_medium"),$(".main_window").addClass("game_speed_fast")),!1==endless_waves&&gamedata.battles_started++,saveToLocalStorage(),clear_all_timeouts(),fight_number+=1,void 0!=gamedata.decks[gamedata.current_deck].hero){(battle_info={}).combat_units={},battle_info.enemy_combat_boosts={},battle_stats={},$(".battle_container").html(""),$(".projectile").remove(),$(".battle_container").append('<div class="total_turn_counter_container">TURN: <span class="total_turn_counter"></span></div>'),$(".resign_button").css("display","none"),total_timeout=0,total_turn_counter=0,active_turn=Math.ceil(2*Math.random()),$(".battle_container").append('<div class="turn_pointer turn_pointer_'+active_turn+'"></div>'),combat_alive=!0;for(var e=1;e<3;e++)for(var t=-5;t<6;t++)$(".battle_container").append('<div class="unit slot_container side_'+e+" slot_"+t+'" onclick="show_unit_details('+e+","+t+')"></div>');if(void 0!=gamedata.decks[gamedata.current_deck].hero){battle_info.combat_units[2]=create_hero(gamedata.decks[gamedata.current_deck].hero,2),battle_info.combat_units[2].color=["green"],battle_info.combat_units[2].slot=0,battle_info.combat_units[2].side=2,battle_info.combat_units[2].origin_side=2,battle_info.combat_units[2].unit_id=2,battle_info.combat_units[2].card_type=gamedata.decks[gamedata.current_deck].hero+"",battle_info.combat_units[2].current_health=battle_info.combat_units[2].health;var a=parse_combat_unit(battle_info.combat_units[2],void 0,void 0,!0);$(".battle_container").append(a)}if("test_deck"==current_battle_type){battle_info.combat_units[1]=create_hero(gamedata.decks[current_test_deck].hero),battle_info.combat_units[1].slot=0,battle_info.combat_units[1].side=1,battle_info.combat_units[1].origin_side=1,battle_info.combat_units[1].unit_id=1,battle_info.combat_units[1].card_type=o,battle_info.combat_units[1].current_health=battle_info.combat_units[1].health,enemy_card_back=battle_info.combat_units[1].image+"";var a=parse_combat_unit(battle_info.combat_units[1],void 0,void 0,!0);$(".battle_container").append(a)}if("summoned"==current_battle_type){if(!1==endless_waves){var o=gamedata.current_summon.hero;difficulty_setting=gamedata.current_summon.level}if(!0==endless_waves){var n=get_summon_stats(),o=get_random_hero(!0,n.min_rarity,n.max_rarity,n.common_reduction);difficulty_setting=(endless_wave_count-1)/get_upgrade_factor("wave_power_increase","any",!0)+get_upgrade_factor("wave_min_power","any",!0)}battle_info.combat_units[1]=create_hero(o,1),battle_info.combat_units[1].color=["red"],battle_info.combat_units[1].slot=0,battle_info.combat_units[1].side=1,battle_info.combat_units[1].origin_side=1,battle_info.combat_units[1].unit_id=1,battle_info.combat_units[1].card_type=o,battle_info.combat_units[1].current_health=battle_info.combat_units[1].health;var a=parse_combat_unit(battle_info.combat_units[1],void 0,void 0,!0);enemy_card_back=battle_info.combat_units[1].image+"",$(".battle_container").append(a)}battle_info.deck_2={};var r=0;if($.each(gamedata.decks[gamedata.current_deck],function(e,t){if("hero"!=e)for(var a=0;a<t;a++)battle_info.deck_2[r]={card_id:e,status:"deck",time_left:all_available_cards[e].time},r++}),"summoned"==current_battle_type){if(!0==endless_waves||void 0==gamedata.current_summon.deck){var s=30*get_effective_power_factor();s>30&&(s=30),s<1&&(s=1),Math.random()>1.5?battle_info.deck_1=construct_random_deck(s,o):battle_info.deck_1=construct_random_deck(s,o,!0),!1==endless_waves&&(gamedata.current_summon.deck=true_copyobject(battle_info.deck_1))}else battle_info.deck_1=true_copyobject(gamedata.current_summon.deck)}update_deck_counts(),check_visible_skills(1),check_visible_skills(2),total_timeout=0,("summoned"==current_battle_type||"king_of_the_hill"==current_battle_type)&&show_vs(),all_timeouts[++timeout_key]=setTimeout(function(){start_next_turn()},total_timeout)}else show_content("home"),$(".detail_overlay  .card_detail").html('<div class="big_text">You need to asign a hero<br/>to be able to fight a battle</div>'),$(".detail_overlay").removeClass("hidden")}function show_vs(){var e="",t="";!0==endless_waves&&(t+="<br/><span>Wave "+endless_wave_count+" ("+Math.floor(10*difficulty_setting)+"%)</span>"),e+='<div class="vs_container">',e+='<div class="vs_player_image" style="background-image:url(images/'+battle_info.combat_units[2].image+')"></div>',e+='<div class="vs_enemy_image" style="background-image:url(images/'+battle_info.combat_units[1].image+')"></div>',e+='<div class="vs_player_name">'+capitalizeFirstLetter(battle_info.combat_units[2].name)+"</div>",e+='<div class="vs_enemy_name">'+capitalizeFirstLetter(battle_info.combat_units[1].name)+t+"</div>",e+='<div class="vs_vs">V&nbsp;<br/>&nbsp;S</div>',e+="</div>",$(".main_window").append(e),"king_of_the_hill"==current_battle_type&&$(".vs_enemy_name span").prepend("King "),total_timeout+=100,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_player_image").addClass("active"),$(".vs_enemy_image").addClass("active")},total_timeout),total_timeout+=400,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_player_name").addClass("active")},total_timeout),total_timeout+=0,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_enemy_name").addClass("active")},total_timeout),total_timeout+=0,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_vs").addClass("active")},total_timeout),total_timeout+=0,all_timeouts[timeout_key]=setTimeout(function(){$(".vs_vs").addClass("active2")},total_timeout),total_timeout+=2e3,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_container").addClass("faded")},total_timeout),total_timeout+=1e3,all_timeouts[++timeout_key]=setTimeout(function(){$(".vs_container").remove()},total_timeout),total_timeout-=2500}function convert_deck(e){var t=e.hero,a={};(a=create_combat_unit(t)).slot=0,a.side=1,a.origin_side=1,a.unit_id=1,a.current_health=a.health;var o={},n=0;$.each(e.deck,function(e,t){if("hero"!=e)for(var a=0;a<t;a++)o[n]={card_id:e,status:"deck",time_left:all_available_cards[e].time},n++}),console.log(JSON.stringify(a)),console.log("-------------"),console.log(JSON.stringify(o))}function create_fake_hero(e){var t={},a=get_random_hero();return void 0!=e&&(a=e),(t=create_hero(a)).slot=0,t.side=1,t.origin_side=1,t.unit_id=1,t.card_type=a,t.current_health=t.health,t}function construct_random_enemy_deck(e,t){void 0==e&&(e=get_random_hero()),void 0==t&&(t=30);var a=create_fake_hero(e),o=construct_random_deck(t,e,!0);console.log(a),console.log("-------------"),console.log(o)}var random_deck_times={basic:{percent_main:10,percent_slow:90,percent_massive:200},fast:{percent_main:30,percent_slow:90,percent_massive:200},slow:{percent_main:10,percent_slow:70,percent_massive:200},cheap:{percent_main:55,percent_slow:90,percent_massive:200},muscle:{percent_main:0,percent_slow:75,percent_massive:200},cheap_only:{percent_main:90,percent_slow:90,percent_massive:200}};function get_active_deck_speed(){var e=0,t=gamedata.decks[gamedata.current_deck],a=count_object(t)-1,o=0;return a>0&&(a=0,$.each(t,function(e,t){"hero"!=e&&void 0!=all_available_cards[e]&&(o+=all_available_cards[e].time*t,a+=t)}),e=o/a),e}var show_deck_construction=!1;function construct_random_deck(e,t,a){var o=1e3,n=0,r=0,s=0;Math.random()>.5&&(o=Math.floor(6*Math.random())+3);var c={},d=all_available_cards[t].color[0],l=!1,u=[],m=["cardback"];void 0!=all_available_cards[t].color[1]&&(l=all_available_cards[t].color[1]);var v=!1;void 0!=all_available_cards[t].hero_version.theme&&(v=all_available_cards[t].hero_version.theme);var p=get_random_card("any",o,d,l,0,v,u,m),f=0,b=get_random_key_from_object(random_deck_times);.5>Math.random()&&(b="basic"),void 0!=all_available_cards[t].hero_version.time_theme&&.9>Math.random()&&(b=all_available_cards[t].hero_version.time_theme);var h=get_active_deck_speed();.25>Math.random()&&(h>0&&h<2&&(b="cheap"),h>=2&&h<4&&(b="fast"),h>=4&&h<6&&(b="basic"),h>=6&&h<8&&(b="slow"),h>=8&&(b="muscle"));var g=random_deck_times[b];if(void 0!=all_available_cards[t].hero_version.deck_times&&$.each(all_available_cards[t].hero_version.deck_times,function(e,t){g[e]=t}),e<30){var w=30/e;$.each(g,function(e,t){g[e]*=w})}for(var y=0;y<e;y++){f+=1;var k=y/e*100;if(n=0,o=4,k>=g.percent_main&&(n=5,o=9),k>=g.percent_slow&&(n=10,o=150),k>=g.percent_massive&&(n=16,o=100),f=0,$.each(c,function(e,t){t.card_id==p&&(f+=1)}),f>4||void 0!=all_available_cards[p].max_in_deck&&f>=all_available_cards[p].max_in_deck){var _=!1;$.each(u,function(e,t){t==p&&(_=!0)}),!1==_&&(u[get_highest_key_in_object(u)+1]=p)}(f>4||void 0!=a&&!0==a)&&(p=get_random_card("any",o,d,l,n,v,u,m),void 0!=all_available_cards[p]&&("artifact"==all_available_cards[p].type&&r>3&&(void 0==all_available_cards[p].selfdestructs||!1==all_available_cards[p].selfdestructs)||"spell"==all_available_cards[p].type&&s>10)&&(p=get_random_card("any",o,d,l,n,v,u,m)),void 0!=all_available_cards[p]&&"artifact"==all_available_cards[p].type&&(void 0==all_available_cards[p].selfdestructs||!1==all_available_cards[p].selfdestructs)&&++r>4&&!1==match_array_values(m,["artifact"])&&(m[count_object(m)]="artifact"),void 0!=all_available_cards[p]&&"spell"==all_available_cards[p].type&&s++,f=0),void 0!=all_available_cards[p]&&all_available_cards[p].pick_chance>0?($.each(all_available_cards[p].color,function(e,t){"colorless"==d&&(d=t),t!=d&&"colorless"!=t&&(l=t)}),c[y]={card_id:p,status:"deck",time_left:all_available_cards[p].time}):console.log(p)}if(c=check_deck_min_enemy_targets(c,v),!0==show_deck_construction){console.log("DECK CONSTRUCTION"),console.log("Theme:"),console.log(v);var x={},C=0;$.each(c,function(e,t){void 0==x[t.card_id]?x[t.card_id]=1:x[t.card_id]++,C+=all_available_cards[t.card_id].time}),console.log("cards:"),console.log(x),console.log("deck times:"),console.log(b),console.log(g),console.log("artifact count: "+r),console.log("average card time: "+C/30)}return c}function check_deck_min_enemy_targets(e,t){var a=count_object(e),o=0,n={},r={};if($.each(e,function(e,t){void 0!=all_available_cards[t.card_id]&&!0==match_array_values("aoe",all_available_cards[t.card_id].theme)?(o++,n[e]=t.time_left):r[e]=t.time_left}),!0==show_deck_construction&&console.log("aoe theme count: "+o),o+1<=a/10){for(var s=get_random_key_from_object(r),c=true_copyobject(t),d=3;d>=0;d--)c[get_highest_key_in_object(c)+1]="aoe";var l=get_random_card("any",r[s]+2,void 0,void 0,r[s]-2,c,void 0,void 0);!1==l&&(l=get_random_card("any",r[s]+2,void 0,void 0,r[s]-2,["aoe"],void 0,void 0)),!0==show_deck_construction&&console.log("replacing "+e[s].card_id+"("+e[s].time_left+") with "+l+"("+all_available_cards[l].time+")"),!1!=l&&(e[s]={card_id:l,status:"deck",time_left:all_available_cards[l].time}),e=check_deck_min_enemy_targets(e,t)}return e}function count_enemy_deck_cards(){if(void 0!=battle_info&&void 0!=battle_info.deck_1){var e={};$.each(battle_info.deck_1,function(t,a){void 0==e[a.card_id]?e[a.card_id]=1:e[a.card_id]++}),console.log(e)}}function update_deck_counts(){var e=count_deck_cards(battle_info.deck_1),t=count_grave_cards(battle_info.deck_1),a=count_deck_cards(battle_info.deck_2),o=count_grave_cards(battle_info.deck_2);setTimeout(function(){$(".player_deck_counter").html(a+" / "+o),$(".enemy_deck_counter").html(e+" / "+t)},total_timeout)}function count_deck_cards(e,t){var a=0;return $.each(e,function(e,o){"deck"==o.status&&(void 0==t||all_available_cards[o.card_id].type==t)&&a++}),a}function count_hand_cards(e,t){var a=0;return $.each(e,function(e,o){"hand"==o.status&&(void 0==t||all_available_cards[o.card_id].type==t)&&a++}),a}function count_grave_cards(e,t){var a=0;return $.each(e,function(e,o){"grave"==o.status&&(void 0==t||all_available_cards[o.card_id].type==t)&&a++}),a}function get_random_hero(e,t,a,o){void 0==gamedata.known_recipes&&(gamedata.known_recipes={});var n=!1,r=0;$.each(all_available_cards,function(n,s){if(void 0!=s.hero_version&&(void 0==a||s.value<=a)&&(void 0==t||s.value>=t)){if(void 0==e||!1==e)r+=1;else{var c=s.value;void 0!=o&&c<o&&(void 0!=gamedata.known_recipes[n]||void 0==s.recipe)&&(c=o),r+=1/(c*c)}}});var s=Math.random()*r;return $.each(all_available_cards,function(r,c){if(void 0!=c.hero_version&&(void 0==a||c.value<=a)&&(void 0==t||c.value>=t)){if(void 0==e||!1==e)s-=1;else{var d=c.value;void 0!=o&&d<o&&(void 0!=gamedata.known_recipes[r]||void 0==c.recipe)&&(d=o),s-=1/(d*d)}s<=0&&!1==n&&(n=r)}}),!1==n&&void 0!=t&&(t/=2,n=get_random_hero(e,t,a,o)),!1==n&&(n="peasant"),n}function get_random_card(e,t,a,o,n,r,s,c){var d=0,l=!1,u=new Date().getMonth()+1;$.each(all_available_cards,function(l,m){if(void 0!=m.type&&!1==match_array_values(m.type,c)&&(match_array_values(m.type,e)||"any"==e)&&(void 0==t||t>=m.time)&&(void 0==n||n<=m.time)&&(void 0==m.months_available||!0==match_array_values([u],m.months_available))){var v=!0;if(void 0!=a&&void 0!=o&&(!1==o&&m.color[0]!=a&&void 0!=m.color[1]&&m.color[1]!=a&&(v=!1),$.each(m.color,function(e,t){t!=a&&!1!=o&&t!=o&&"colorless"!=t&&(v=!1)})),void 0!=s&&!0==match_array_values(s,l)&&(v=!1),void 0!=m.pick_chance&&0==m.pick_chance&&(v=!1),void 0!=m.not_theme&&match_array_values(m.not_theme,r)>0&&(v=!1),!0==v){var p=1;void 0!=m.pick_chance&&(p=m.pick_chance),"colorless"==m.color[0]&&(p*=1),void 0!=r&&(p*=to_the_nth(1,10,match_array_values(m.theme,r,!0)+1)),d+=p}}});var m=Math.random()*d;return $.each(all_available_cards,function(d,v){if(void 0!=v.type&&!1==match_array_values(v.type,c)&&(match_array_values(v.type,e)||"any"==e)&&(void 0==t||t>=v.time)&&(void 0==n||n<=v.time)&&(void 0==v.months_available||!0==match_array_values([u],v.months_available))){var p=!0;if(void 0!=a&&void 0!=o&&(!1==o&&v.color[0]!=a&&void 0!=v.color[1]&&v.color[1]!=a&&(p=!1),$.each(v.color,function(e,t){t!=a&&!1!=o&&t!=o&&"colorless"!=t&&(p=!1)})),void 0!=s&&!0==match_array_values(s,d)&&(p=!1),void 0!=v.pick_chance&&0==v.pick_chance&&(p=!1),void 0!=v.not_theme&&match_array_values(v.not_theme,r)>0&&(p=!1),!0==p){var f=1;void 0!=v.pick_chance&&(f=v.pick_chance),"colorless"==v.color[0]&&(f*=1),void 0!=r&&(f*=to_the_nth(1,10,match_array_values(v.theme,r,!0)+1)),(m-=f)<=0&&!1==l&&(l=d)}}}),!1==l&&(l=get_random_card(e,t,a,o)),l}function get_random_card_based_on_time(e,t,a,o,n,r,s,c){var d=0,l=!1,u=new Date().getMonth()+1;$.each(all_available_cards,function(l,m){if(m.pick_chance>0&&void 0!=m.type&&(void 0==c||!1==match_array_values(m.subtypes,c)||"any"==c)&&(m.type==e||"any"==e||void 0==e)&&(void 0==t||t>=m.time)&&(void 0==r||r<=m.time)&&(void 0==n||!0==match_array_values(n,m.subtypes))&&(void 0==m.months_available||!0==match_array_values([u],m.months_available))){var v=!0;if(void 0!=a&&void 0!=o&&(!1==o&&m.color[0]!=a&&void 0!=m.color[1]&&m.color[1]!=a&&(v=!1),$.each(m.color,function(e,t){t!=a&&!1!=o&&t!=o&&(v=!1)})),void 0!=s&&!0==match_array_values(s,l)&&(v=!1),!0==v){var p=1;void 0!=m.time&&m.time>1&&(p/=sqr(m.time/1)),d+=p}}});var m=Math.random()*d;return $.each(all_available_cards,function(d,v){if(v.pick_chance>0&&void 0!=v.type&&(void 0==c||!1==match_array_values(v.subtypes,c)||"any"==c)&&(v.type==e||"any"==e||void 0==e)&&(void 0==t||t>=v.time)&&(void 0==r||r<=v.time)&&(void 0==n||!0==match_array_values(n,v.subtypes))&&(void 0==v.months_available||!0==match_array_values([u],v.months_available))){var p=!0;if(void 0!=a&&void 0!=o&&(!1==o&&v.color[0]!=a&&void 0!=v.color[1]&&v.color[1]!=a&&(p=!1),$.each(v.color,function(e,t){t!=a&&!1!=o&&t!=o&&(p=!1)})),void 0!=s&&!0==match_array_values(s,d)&&(p=!1),!0==p){var f=1;void 0!=v.time&&v.time>1&&(f/=sqr(v.time/1)),(m-=f)<=0&&!1==l&&(l=d)}}}),!1==l&&(l=get_random_card_based_on_time(e,t+1)),l}function test_based_on_time(e,t,a,o,n,r,s,c,d){for(var l=0,u=!1,m=!1,v=0;v<e;v++){var p=get_random_card_based_on_time(t,a,o,n,r,s,c,d);l+=all_available_cards[p].time,(!1===u||all_available_cards[p].time<u)&&(u=all_available_cards[p].time),(!1===m||all_available_cards[p].time>m)&&(m=all_available_cards[p].time)}l/=e,console.log("average: "+l),console.log("lowest: "+u),console.log("highest: "+m)}function get_random_card_based_on_value(e,t,a,o,n,r){var s=0,c=!1;void 0==e&&(e=1),e<=0&&(e=1);var d=new Date().getMonth()+1;$.each(all_available_cards,function(c,l){(void 0==n||!1==match_array_values(n,c))&&(l.recipe,1)&&(l.pick_chance>0||void 0!=l.basic_reward||void 0!=o)&&(void 0==a&&"cardback"!=l.type&&"consumable"!=l.type&&"currency"!=l.type&&"item"!=l.type&&"treasure"!=l.type||!0==match_array_values(l.type,a))&&void 0!=l.value&&l.value>=e&&(void 0==r||l.value<=r)&&(void 0==t||l.color[0]==t)&&(void 0==l.months_available||!0==match_array_values([d],l.months_available))&&(s+=get_pick_chance_on_value(l.value,e))});var l=Math.random()*s;return $.each(all_available_cards,function(s,u){(void 0==n||!1==match_array_values(n,s))&&(u.recipe,1)&&(u.pick_chance>0||void 0!=u.basic_reward||void 0!=o)&&(void 0==a&&"cardback"!=u.type&&"consumable"!=u.type&&"currency"!=u.type&&"item"!=u.type&&"treasure"!=u.type||!0==match_array_values(u.type,a))&&void 0!=u.value&&u.value>=e&&(void 0==r||u.value<=r)&&(void 0==t||u.color[0]==t)&&(void 0==u.months_available||!0==match_array_values([d],u.months_available))&&(l-=get_pick_chance_on_value(u.value,e))<=0&&!1==c&&(c=s)}),c}function get_pick_chance_on_value(e,t){var a=1;return(void 0==t||t<1)&&(t=1),void 0!=e&&(e<1&&(e=1),a=1e5/(e*(1+e/10))),a}function apply_min_value(e,t){return(void 0==t||t<1)&&(t=1),e=100*e+sqr(t)}function get_basic_reward_card(e){var t=new Date().getMonth()+1,a="peasant",o={};return $.each(all_available_cards,function(a,n){if(void 0!=n.basic_reward&&!0==n.basic_reward||1==n.value&&!0==match_array_values([t],n.months_available)){var r=!0;$.each(e,function(e,t){t.card_id==a&&(r=!1)}),!0==r&&(o[a]=!0)}}),count_object(o)>0&&(a=get_random_key_from_object(o)),a}function get_fragment_card(){var e=new Date().getMonth()+1,t="",a={};return $.each(all_available_cards,function(t,o){"fragment"==o.type&&(void 0==o.months_available||!0==match_array_values([e],o.months_available))&&(a[t]=1/o.value*(1/o.value))}),count_object(a)>0&&(t=get_random_key_from_object_based_on_num_value(a)),t}function get_back_card_card(){var e=new Date().getMonth()+1,t="",a={};return $.each(all_available_cards,function(t,o){void 0==o.non_tradable&&"cardback"==o.type&&void 0!=o.reward&&void 0!=o.reward.type&&"card_back"==o.reward.type&&(void 0==o.months_available||!0==match_array_values([e],o.months_available))&&(a[t]=1/o.value*(1/o.value))}),count_object(a)>0&&(t=get_random_key_from_object_based_on_num_value(a)),t}function check_get_random_card_value(e,t,a,o){for(var n=[],r=0,s=1,c=s;c>0;c--){var d=get_random_card_based_on_value(e,t,a,o,n);r+=all_available_cards[d].value}console.log(r/s)}function check_get_random_card(){for(var e=100;e>=0;e--)!1==get_random_card("any")&&console.log("failed")}function parse_combat_unit(e,t,a,o){var n="",r=e;void 0==t&&(t="");var s=" slot_"+e.slot;void 0!=a&&!0==a&&(s=""),"chapter_battle"==current_battle_type&&"object"==typeof e.card_type?n+='<div class="unit unit_id_'+e.unit_id+" unit_type_"+e.type+s+" side_"+e.side+" "+t+'" onclick="show_card_details(\''+current_chapter+"', "+o+",undefined,undefined,"+e.unit_id+'), pause_game()">':n+='<div class="unit unit_id_'+e.unit_id+" unit_type_"+e.type+s+" side_"+e.side+" "+t+'" data-card_type="'+e.card_type+'" onclick="show_card_details(\''+e.card_type+"', "+o+'), pause_game()">',count_object(r.color)>1?$.each(r.color,function(e,t){n+='<div class="card_color color_'+t+" color_number_"+e+'"></div>'}):n+='<div class="card_color color_'+r.color[0]+' color_number_0"></div><div class="card_color color_'+r.color[0]+' color_number_1"></div>';var c="";void 0!=r.image_position&&(c=";background-position:"+r.image_position),n+='<div class="card_image" style="background-image:url(images/'+r.image+")"+c+'"></div>',void 0!=r.time&&!1!=r.time&&(n+='<div class="card_time">'+r.time+"</div>"),n+='<div class="card_name">'+capitalizeFirstLetter(r.name)+"</div>",!1!==r.power?n+='<div class="card_power">'+r.power+"</div>":n+='<div class="card_power hidden"></div>',!1!=r.health&&(n+='<div class="card_health"><div class="current_health"></div><div class="temp_health"></div><div class="max_health">'+r.current_health+"</div></div>");var d="0";return r.armor>0&&(d=1),n+='<div class="card_armor" style="opacity:'+d+'">'+r.armor+"</div>",n+='<div class="unit_effects">',$.each(r.effects,function(e,t){n+='<div class="effect_'+e+'">'+t+"</div>"}),n+="</div>",n+="</div>"}function parse_abilities(e){var t=battle_info.combat_units[e],a="";return $.each(t.abilities,function(e,o){if(("strike"!=e&&"strike_unit"!=e||1!=o)&&void 0!=all_abilities[e]&&void 0==all_abilities[e].do_not_show){""!=a&&(a+=",&nbsp;</span>");var n=o;if("object"==typeof n)var n=o.level;var r=all_abilities[e];a+='<span class="'+e+'" style="color:'+r.name_color+'">',a+=r.name,(n>1||void 0!=r.show_amount_adjustment||void 0!=o.level_2)&&(void 0!=r.show_amount_adjustment&&(n+=r.show_amount_adjustment),n>1&&(a+=" "+n),void 0!=r.post_name&&(a+=r.post_name)),void 0!=o.level_2&&o.level_2>1&&(a+="/"+o.level_2),void 0!=t.ability_delays[e]&&t.ability_delays[e]>0&&(a+=" ("+t.ability_delays[e]+")")}}),""!=a&&(a+="</span>"),a="",a='<div class="card_type">'+t.type+"</div>"+a}function create_hero(e,t){var a=all_available_cards[e].hero_version;a.color=all_available_cards[e].color;var o=create_combat_unit(a);if(void 0!=t&&1==t){var n=get_effective_power_factor();o.power>0&&(o.power*n>1?o.power=round_by_percent(o.power*n):o.power=Math.ceil(o.power*n)),o.health*n>1?o.health=round_by_percent(o.health*n):o.health=Math.ceil(o.health*n),$.each(o.abilities,function(e,t){void 0!=all_abilities[e]&&void 0!=all_abilities[e].scales&&!0==all_abilities[e].scales&&(t*n>1?o.abilities[e]=round_by_percent(t*n):o.abilities[e]=Math.ceil(t*n))})}return o}function apply_power_factor(e,t){var a=get_effective_power_factor();return 1==t&&(e.power>0&&(e.power*a>1?e.power=round_by_percent(e.power*a):e.power=Math.ceil(e.power*a)),e.health>0&&(e.health*a>1?e.health=round_by_percent(e.health*a):e.health=Math.ceil(e.health*a)),e.armor>0&&(e.armor=Math.ceil(e.armor*a)),$.each(e.abilities,function(t,o){void 0!=all_abilities[t]&&void 0!=all_abilities[t].scales&&!0==all_abilities[t].scales&&(o*a>1?e.abilities[t]=round_by_percent(o*a):e.abilities[t]=Math.ceil(o*a))})),e}function get_effective_power_factor(e){void 0==e&&(e=difficulty_setting);var t=sqr(.5+e/20);t=.1*e,difficulty_setting<10&&(t=e/10);var t=.5+e/20,t=0+e/10;return t}function create_combat_unit(e,t){var a=true_copyobject(e);a.effects=true_copyobject(e.effects),void 0==a.effects&&(a.effects={});var o={};return $.each(a.abilities,function(e,t){o[e]=t}),a.abilities=o,(a=apply_power_factor(a,t)).ability_delays={},$.each(a.abilities,function(e,t){void 0!=all_abilities[e].starting_delay&&(a.ability_delays[e]=all_abilities[e].starting_delay),"object"==typeof t&&void 0!=t.starting_delay&&(a.ability_delays[e]=t.starting_delay)}),a}function add_battle_stats(e,t,a){void 0==t&&(t=1),check_achievement_goals(),void 0==battle_stats[e+"_total"]&&(battle_stats[e+"_total"]=0),void 0==battle_stats[e+"_times"]&&(battle_stats[e+"_times"]=0),void 0==battle_stats[e+"_max"]&&(battle_stats[e+"_max"]=0),battle_stats[e+"_total"]+=t,battle_stats[e+"_times"]+=1,t>battle_stats[e+"_max"]&&(battle_stats[e+"_max"]=t),void 0!=all_achievement_goals[e]&&check_quests(e),void 0!=all_achievement_goals[e+"_total"]&&check_quests(e+"_total",battle_stats[e+"_total"]),void 0!=all_achievement_goals[e+"_times"]&&check_quests(e+"_times",battle_stats[e+"_times"]),void 0!=all_achievement_goals[e+"_max"]&&check_quests(e+"_max",battle_stats[e+"_max"])}function find_new_ability(e,t){var a="",o=0,n=[],r=0;$.each(e,function(e,t){void 0!=all_abilities[e].show_amount&&all_abilities[e].show_amount,n[r]=e,r++}),$.each(all_abilities,function(e,a){!1==match_array_values(n,[e])&&check_if_ability_can_be_added(e,t)&&o++});var s=Math.floor(Math.random()*o)+1;return $.each(all_abilities,function(e,o){!1==match_array_values(n,[e])&&check_if_ability_can_be_added(e,t)&&--s<1&&""==a&&(a=e)}),a}function check_if_ability_can_be_added(e,t){var a=!1,o=all_abilities[e];return void 0!=o.good_random&&!0==o.good_random&&(a=!0),void 0!=o.need_power&&!0==o.need_power&&t.power<1&&(a=!1),"dealt_damage"==o.proc&&t.power<1&&(a=!1),"overkill"==o.proc&&t.power<2&&(a=!1),a}