'use strict';var current_page=1,cards_per_page=8,showing_heroes=!1,max_deck_size=30,edit_mode="view";function show_deck_edit(){show_available_cards(showing_heroes);show_current_deck();update_edit_view_slider()}
function show_available_cards(a){gamedata.edit_mode!=void 0&&(edit_mode=gamedata.edit_mode);cards_per_page=8;a==1||showing_heroes==1?$(".hero_mode").addClass("active"):$(".hero_mode").removeClass("active");a==1||showing_heroes==1?$("#content_deck_edit .current_hero").addClass("glowing_hero"):$("#content_deck_edit .current_hero").removeClass("glowing_hero");gamedata.owned_cards=sortObj(gamedata.owned_cards);$("#content_deck_edit .available_cards").html("");var b=0;gamedata.decks[gamedata.current_deck]==
void 0&&(gamedata.current_deck=0);var c=gamedata.decks[gamedata.current_deck];$.each(c,function(g,h){h<1&&delete c[g]});gamedata.owned_cards[gamedata.decks[gamedata.current_deck].hero]<1&&delete gamedata.decks[gamedata.current_deck].hero;gamedata.decks[gamedata.current_deck]=sortObj(gamedata.decks[gamedata.current_deck]);var e=all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=void 0?all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0]:"colorless";e=="colorless"&&
(e=get_second_deck_color());var d=all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=void 0&&all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]!=void 0?all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]:get_second_deck_color(e);$.each(gamedata.owned_cards,function(g,h){h+=0;c[g]!=void 0&&(h-=c[g]);c.hero!=void 0&&c.hero==g&&--h;h<0&&(c[g]+=h,gamedata.decks[gamedata.current_deck][g]=c[g],c[g]==0&&delete gamedata.decks[gamedata.current_deck][g],
c[g]<0&&(delete gamedata.decks[gamedata.current_deck][g],delete gamedata.decks[gamedata.current_deck].hero),saveToLocalStorage());var k=!1,l=!1;if(all_available_cards[g].type=="boost"||all_available_cards[g].type=="recipe"||all_available_cards[g].type=="fragment"||all_available_cards[g].type=="material"||all_available_cards[g].type=="consumable"||all_available_cards[g].type=="token"||all_available_cards[g].type=="currency"||all_available_cards[g].type=="cardback"||all_available_cards[g].type=="item"||
all_available_cards[g].type=="treasure"||$("."+all_available_cards[g].type+"_type_filter").prop("checked")==0)k=!0;if(a==void 0||a==0)d==0&&all_available_cards[g].color[0]!=e&&all_available_cards[g].color[1]!=void 0&&all_available_cards[g].color[1]!=e&&(l=!0),$.each(all_available_cards[g].color,function(p,n){n!=e&&d!=0&&n!=d&&n!="colorless"&&(l=!0)});h>0&&(a==void 0||a==0||all_available_cards[g].hero_version!=void 0)&&k==0&&check_filters(g,a)==0&&(b++,b/cards_per_page>current_page-1&&b/cards_per_page<=
current_page&&(a!=void 0&&a==1?(h=parse_card(g,void 0,!0),$("#content_deck_edit .available_cards").append('<div class="available_card_container" onclick="set_hero(\''+g+"')\">"+h+"</div>")):(h=parse_card(g,h),l==1?$("#content_deck_edit .available_cards").append("<div onclick=\"show_card_details('"+g+'\')" class="available_card_container faded">'+h+"</div>"):$("#content_deck_edit .available_cards").append("<div onclick=\"add_card_to_deck('"+g+'\')" class="available_card_container">'+h+"</div>"))))});
current_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");b/cards_per_page<=current_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");b>0&&$("#content_deck_edit .available_cards").html()==""&&(current_page=1,show_available_cards(a));b==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page");$(".page_selection .page_number").html(current_page+
" / "+Math.ceil(b/cards_per_page));$(".current_deck_colors").html("");var f='<div class="deck_color color_'+e+'"></div><div class="deck_color color_'+(d+'"></div>');$(".current_deck_colors").html(f);gamedata.decks[gamedata.current_deck].hero!=void 0||a!=void 0&&a!=0||show_available_cards(!0)}
function get_second_deck_color(a){var b=!1;a==void 0&&(a=!1,all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=void 0&&(a=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0]));all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=void 0&&all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]!=void 0?b=all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]:$.each(gamedata.decks[gamedata.current_deck],function(c,e){all_available_cards[c]!=
void 0&&$.each(all_available_cards[c].color,function(d,f){b==0&&f!="colorless"&&f!=a&&(b=f)})});return b}function show_available_heroes(){showing_heroes=showing_heroes==1?!1:!0;show_available_cards(showing_heroes)}function show_current_hero_details(){show_available_heroes()}
function show_current_deck(){gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck];$("#content_deck_edit .current_deck").html("");$("#content_deck_edit .current_hero").html("");var b=all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=void 0?all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[0]:"colorless";b=="colorless"&&(b=get_second_deck_color());var c=all_available_cards[gamedata.decks[gamedata.current_deck].hero]!=
void 0&&all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]!=void 0?all_available_cards[gamedata.decks[gamedata.current_deck].hero].color[1]:get_second_deck_color(b);$.each(a,function(f,g){if(f=="hero"){var h=parse_card(g,void 0,!0);$("#content_deck_edit .current_hero").append("<div>"+h+"</div>")}f!="hero"&&g>0&&(all_available_cards[f]==void 0||all_available_cards[f].color[0]!="colorless"&&all_available_cards[f].color[0]!=b&&all_available_cards[f].color[0]!=c||all_available_cards[f].color[1]!=
void 0&&all_available_cards[f].color[1]!=b&&all_available_cards[f].color[1]!=c?(delete a[f],saveToLocalStorage()):(h=parse_card(f,g),g=check_filters(f),$("#content_deck_edit .current_deck").append("<div onclick=\"remove_card_from_deck('"+f+'\')" class="filtered_'+g+'">'+h+"</div>")))});var e=count_current_deck_cards(a),d=e/max_deck_size*100;e<max_deck_size?$(".card_count").html('<div class="fill_bar" style="height:'+d+'%;"></div><span><br/>'+e+'<br/><span style="color:#555">'+max_deck_size+"</span></span>"):
$(".card_count").html('<div class="fill_bar" style="height:'+d+'%;"></div><span style="color:#555"><br/>'+e+"<br/>"+max_deck_size+"</span>")}
function parse_card(a,b,c,e){a=="scraps"&&(a="scraps_placeholder");var d="";if(all_available_cards[a]!=void 0){var f=all_available_cards[a];c!=void 0&&c==1&&(f=f.hero_version,f.color=all_available_cards[a].color);d+='<div class="card card_type_'+f.type+'">';count_object(f.color)>1?$.each(f.color,function(l,p){d+='<div class="card_color color_'+p+" color_number_"+l+'"></div>'}):d+='<div class="card_color color_'+f.color[0]+'"></div>';var g="";f.image_position!=void 0&&(g=";background-position:"+f.image_position);
d+='<div class="card_image" style="background-image:url(images/'+f.image+")"+g+'"></div>';var h="";$.each(f.abilities,function(l,p){if(!(l=="strike"&&c!=1||l=="strike_unit"&&c==1)||p!=1)if(h!=""&&(h+=",&nbsp;</span>"),all_abilities[l]!=void 0){var n=p,q=0;typeof n=="object"&&(n=p.level,p.delay!=void 0&&(q=p.delay-0));l=all_abilities[l];h+='<span style="color:'+l.name_color+'">';h+=l.name;if(n>1||l.show_amount_adjustment!=void 0||p.level_2!=void 0)l.show_amount_adjustment!=void 0&&(n+=l.show_amount_adjustment),
h+=" "+n,l.post_name!=void 0&&(h+=l.post_name);p.level_2!=void 0&&p.level_2>1&&(h+="/"+p.level_2);q>0&&p.delay==void 0&&(h+=" ("+q+")");p.delay!=void 0&&p.delay>0&&(h+=" ("+(p.delay-0)+")")}});f.type=="cardback"&&f.reward!=void 0&&f.reward.type!=void 0&&f.reward.type=="card_back"&&gamedata.owned_card_backs!=void 0&&gamedata.owned_card_backs[a]!=void 0&&(h+='<span style="color:rgba(0,200,0,0.9)">collected</span>');f.type!="cardback"||f.reward==void 0||f.reward.type==void 0||f.reward.type!="card_back"||
gamedata.owned_card_backs!=void 0&&gamedata.owned_card_backs[a]!=void 0||(h+='<span style="color:rgba(255,0,0,0.9)">not collected</span>');if(f.type=="fragment"&&owned_buildings_fragments[a]!=void 0){h+='<span style="color:rgba(255,255,255,0.9)">built,</span> ';g=calculate_upgrade_cost(owned_buildings_fragments[a].building_level);var k=0;gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>0&&(k=gamedata.owned_cards[a]);h=k>=g?h+('<span style="color:rgba(0,200,0,0.9)">'+k+" / "+g+"</span>"):h+
('<span style="color:rgba(255,255,255,0.9)">'+k+" / "+g+"</span>")}f.type=="fragment"&&owned_buildings_fragments[a]==void 0&&(h+='<span style="color:rgba(255,0,0,0.9)">not built</span>');h!=""&&(h+="</span>");d+='<div class="card_abilities"><div class="card_type">'+f.type+"</div>"+h+"</div>";f.time!=void 0&&f.time!=0&&(d+='<div class="card_time">'+f.time+"</div>");f.type=="cardback"&&f.reward!=void 0&&f.reward.type!=void 0&&f.reward.type=="card_back"?d+='<div class="card_name">Card back</div>':(a=
findLongestWord(f.name),g=20,a>8&&(g*=8/a),g+="px",d=e==void 0?d+('<div class="card_name" style="font-size:'+g+';">'+capitalizeFirstLetter(f.name)+"</div>"):d+('<div class="card_name" style="font-size:'+g+';">'+capitalizeFirstLetter(e)+"</div>"));b!=void 0&&(d+='<div class="owned_amount">'+b+"</div>");f.power!==!1&&(d+='<div class="card_power">'+f.power+"</div>");f.health!=0&&(d+='<div class="card_health">'+f.health+"</div>");f.armor>0&&(d+='<div class="card_armor">'+f.armor+"</div>");d+='<div class="unit_effects">';
$.each(f.effects,function(l,p){d+='<div class="effect_'+l+'">'+p+"</div>"});d+="</div>";f.shiny!=void 0&&f.shiny==1&&(d+='<div class="shiny"></div>');d+="</div>"}return d}function set_deck_edit_page(a){current_page+=a;current_page<1&&(current_page=1);show_deck_edit()}
function add_card_to_deck(a,b){if(edit_mode=="edit"||b==1)gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0),b=gamedata.decks[gamedata.current_deck],b[a]==void 0&&(b[a]=0),gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>b[a]&&count_current_deck_cards(b)<max_deck_size&&(b[a]<5&&all_available_cards[a].unique==void 0||b[a]<1&&b.hero!=a)&&b[a]++,saveToLocalStorage(),show_deck_edit();else{gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0);b=gamedata.decks[gamedata.current_deck];
var c=!0;b[a]==void 0&&(b[a]=0);b[a]>=5&&(c=!1);all_available_cards[a].unique!=void 0&&b[a]>0&&(c=!1);all_available_cards[a].unique!=void 0&&b.hero==a&&(c=!1);gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>b[a]&&count_current_deck_cards(b)<max_deck_size&&c==1?show_card_details(a,!1,void 0,"add_to_deck"):show_card_details(a,!1,void 0,!1)}}function count_current_deck_cards(a){var b=0;$.each(a,function(c,e){c!="hero"&&(b+=e)});return b}
function clear_current_deck(){gamedata.decks[gamedata.current_deck]={};saveToLocalStorage();show_deck_edit()}
function remove_card_from_deck(a,b){edit_mode=="edit"||b==1?(gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0),b=gamedata.decks[gamedata.current_deck],b[a]==void 0&&(b[a]=0),gamedata.owned_cards[a]!=void 0&&b[a]>0&&b[a]--,b[a]==0&&delete b[a],saveToLocalStorage(),show_deck_edit()):showing_heroes==0||all_available_cards[a].hero_version==void 0?show_card_details(a,showing_heroes,void 0,"remove_from_deck"):show_card_details(a,showing_heroes,void 0,"set_hero")}
function set_hero(a,b){edit_mode=="edit"||b==1?(gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0),b=gamedata.decks[gamedata.current_deck],b[a]==void 0&&(b[a]=0),gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>b[a]?(b.hero=a,all_available_cards[a].unique!=void 0&&b[a]!=void 0&&remove_card_from_deck(a,!0)):gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>0&&(b.hero=a,all_available_cards[a].unique!=void 0&&b[a]!=void 0&&remove_card_from_deck(a,!0)),saveToLocalStorage(),
show_deck_edit()):show_card_details(a,!0,void 0,"set_hero")}
function check_hero_color(){gamedata.decks[gamedata.current_deck]==void 0&&(gamedata.current_deck=0);var a=gamedata.decks[gamedata.current_deck],b=all_available_cards[a.hero].color[0],c=get_second_deck_color();$.each(a,function(e,d){e!="hero"&&all_available_cards[e].color[0]!="colorless"&&all_available_cards[e].color[0]!=b&&all_available_cards[e].color[0]!=c&&delete a[e];e!="hero"&&all_available_cards[e].color[1]!=void 0&&all_available_cards[e].color[1]!="colorless"&&all_available_cards[e].color[1]!=
b&&all_available_cards[e].color[1]!=c&&delete a[e]})}function gain_random_card(){var a=get_random_card("any");gamedata.owned_cards[a]=gamedata.owned_cards[a]==void 0?1:gamedata.owned_cards[a]+1;saveToLocalStorage()}function gain_all_cards(a){a==void 0&&(a=1);$.each(all_available_cards,function(b,c){namechanges[b]==void 0&&(gamedata.owned_cards[b]==void 0?gamedata.owned_cards[b]=a:gamedata.owned_cards[b]<a&&(gamedata.owned_cards[b]=a))});saveToLocalStorage()}
function gain_card(a,b){b==void 0&&(b=1);a!="scrap"&&all_available_cards[a]!=void 0&&(gamedata.owned_cards[a]=gamedata.owned_cards[a]==void 0?b:gamedata.owned_cards[a]+b,b>0&&check_quests("gained_card_"+a,void 0,b));a=="scrap"&&gain_scraps(b);saveToLocalStorage()}
function count_card_colors(a){a==void 0&&(a=0);var b={},c={},e={};$.each(all_available_cards,function(d,f){if(f.pick_chance!=void 0&&f.pick_chance>=a&&(f.type=="creature"||f.type=="structure"||f.type=="object"||f.type=="spell"||f.type=="artifact")&&($.each(f.color,function(h,k){b[k]==void 0?(b[k]=1,c[k]={}):b[k]+=1;e[k]==void 0&&(e[k]=0);e[k]+=f.time;c[k][f.time]==void 0&&(c[k][f.time]=0);c[k][f.time]++}),count_object(f.color)>1)){var g=f.color;b[g]==void 0&&b[f.color[1]+","+f.color[0]]==void 0?b[g]=
1:b[f.color[1]+","+f.color[0]]!=void 0?(b[f.color[1]+","+f.color[0]]+=1,console.log(d)):b[g]+=1}});b=sortObj(b,"value");$.each(b,function(d,f){console.log(d+": "+f)});console.log(c);$.each(e,function(d,f){console.log(d+" a.t.: "+Math.floor(f/b[d]*10)/10)})}
function check_card_recipes(a){var b={};$.each(a,function(c,e){count_object(b)==0?$.each(all_available_cards,function(d,f){f.recipe!=void 0&&f.recipe[e]!=void 0&&(b[d]=f.recipe)}):$.each(b,function(d,f){all_available_cards[d].recipe!=void 0&&all_available_cards[d].recipe[e]==void 0&&delete b[d]})});return b}function select_mode(a){edit_mode=a;$(".edit_view div").removeClass("active");$(".edit_view .select_"+a).addClass("active")}
function toggle_edit_view_mode(){gamedata.edit_mode==void 0&&(gamedata.edit_mode="view");edit_mode=gamedata.edit_mode;edit_mode=edit_mode=="edit"?"view":"edit";gamedata.edit_mode=edit_mode;saveToLocalStorage();update_edit_view_slider()}
function update_edit_view_slider(){$(".edit_view div").removeClass("active");edit_mode=="view"?($(".edit_view .edit_view_slider").addClass("viewing"),$(".edit_view .select_view").addClass("active")):($(".edit_view .edit_view_slider").removeClass("viewing"),$(".edit_view .select_edit").addClass("active"))}
function show_card_details(a,b,c,e,d){if(all_available_cards[a]!=void 0||all_chapters[a]!=void 0){var f=all_available_cards[a];all_chapters[a]!=void 0&&(f=all_chapters[a].hero);$(".detail_overlay .card_detail").html("");b!=void 0&&b==1&&f.hero_version==void 0&&(b=!1);d!=void 0&&battle_info.combat_units[d]!=void 0&&(f=battle_info.combat_units[d],b=!1);var g="",h="";h=all_available_cards[a]==void 0||d!=void 0&&battle_info.combat_units[d]!=void 0?'<div class="unit">'+$(".unit_id_"+d).html()+"</div>":
parse_card(a,c,b);g+='<div class="available_cards">';g+=h;g+="</div>";f.quote!=void 0&&(g+='<div class="card_quote">',g+=f.quote.split('"').join('<span class="card_quote_quote">"</span>'),g+="</div>");f.value!=void 0&&f.value>0&&all_available_cards[a].type!="currency"&&all_available_cards[a].type!="recipe"&&(g+='<div class="card_value">Value: ',g+=numberWithCommas(f.value),f.recipe!=void 0&&f.type!="recipe"&&(g=gamedata.known_recipes!=void 0&&gamedata.known_recipes[a]!=void 0?g+"<br/>Recipe known":
g+"<br/>Recipe not known"),f.used_in_recipes==1&&(g+="<br/>Used in 1 recipe"),f.used_in_recipes>1&&(g+="<br/>Used in "+f.used_in_recipes+" recipes"),gamedata.owned_cards[a]!=void 0&&(g+="<br/>Owned: "+Math.floor(gamedata.owned_cards[a])),all_available_cards[a]==void 0||d!=void 0&&battle_info.combat_units[d]!=void 0||all_available_cards[a].type=="consumable"&&all_available_cards[a].reward!=void 0&&all_available_cards[a].reward.type!=void 0&&all_available_cards[a].reward.type=="card_back"&&(g=gamedata.owned_card_backs[all_available_cards[a].reward.card_back_id]==
void 0?g+"<br/>Not collected":g+"<br/>Collected"),g+="</div>");g+='<div class="ability_details">';g+='<div class="single_ability">';g+='<span class="single_ability_name">'+capitalizeFirstLetter(f.name)+"</span>";g+='<span class="single_ability_description">';$.each(f.subtypes,function(l,p){l>0&&(g+=", ");g+=p.replace("_"," ")});g+="</span>";g+='<span class="single_ability_name">'+f.type+"</span>";g+='<span class="single_ability_description">';if(f.type=="creature"||f.type=="structure"||f.type=="object")g+=
"Unit. Stays on the board until destroyed. ";f.type=="creature"&&(g+="The basic unit type.");f.type=="structure"&&(g+="Cannot be healed, but can be repaired. Is immune to being moved or poisoned and all mental abilities.");f.type=="object"&&(g+="Cannot be healed and is immune to being moved or poisoned and all mental abilities.");f.type=="artifact"&&(g+="Attaches to your hero. There is a maximum of 5 active artifacts. Stays in game untill destroyed or untill it has no active abilities.");if(f.type==
"spell"||f.type=="attack")g+="Action card. Effects fire once. ";f.type=="token"&&(g+="Not used in battles.");f.type=="currency"&&(g+="Not used in battles.");if(f.type=="fragment"){g+="Not used in battles. Can be used to construct buildings in your town.<br/><br/>";var k="";$.each(all_buildings,function(l,p){p.fragment_id==a&&(k=p.description)});g+=k}f.type=="consumable"&&(g+="Use this from your inventory under rewards.<br/><br/>",k="",all_available_cards[a].reward!=void 0&&all_available_cards[a].reward.description!=
void 0&&(k=all_available_cards[a].reward.description),g+=k);f.type=="spell"&&(g+="");f.type=="artifact"&&(g+="");f.type=="attack"&&(g+="");g+="</span>";g+="</div>";f.description!=void 0&&(g+='<div class="single_ability">',g+='<span class="single_ability_description">',g+=f.description,g+="</span>",g+="</div>");c=f.abilities;b!=void 0&&b==1&&f.hero_version!=void 0&&(c=f.hero_version.abilities);d!=void 0&&battle_info.combat_units[d]!=void 0&&(c=battle_info.combat_units[d].abilities);$.each(c,function(l,
p){l=all_abilities[l];var n=p,q=0;typeof n=="object"&&(n=p.level,q=0,typeof p=="object"&&(n=p.level,p.starting_delay!=void 0&&(q=p.starting_delay-0)));g+='<div class="single_ability">';g+='<span class="single_ability_name" style="color:'+l.name_color+'">';g+=l.name;if(n>1||l.show_amount_adjustment!=void 0||p.level_2!=void 0)l.show_amount_adjustment!=void 0&&(n+=l.show_amount_adjustment),g+=" "+n,l.post_name!=void 0&&(g+=l.post_name);p.level_2!=void 0&&p.level_2>1&&(g+="/"+p.level_2);q>0&&(g+=" ("+
q+")");g+="</span>";n="-";q=p+0;typeof p=="object"&&(q=p.level+0);l.show_amount_adjustment!=void 0&&(q+=l.show_amount_adjustment);l.description!=void 0&&(n=l.description);n=check_plural(n.split("{LEVEL}").join(q),q);n=p.level_2!=void 0?n.split("{LEVEL2}").join(p.level_2):n.split("{LEVEL2}").join("1");g+='<span class="single_ability_description">';g+=n;p.additional_text!=void 0&&(g+=" "+p.additional_text);g+="</span>";g+="</div>"});g+="</div>";e!=void 0&&e=="add_to_deck"&&(g+='<div class="add_card_to_deck_from_details_button" onclick="add_card_to_deck(\''+
a+"', true)\">ADD TO DECK</div>");e!=void 0&&e=="remove_from_deck"&&(g+='<div class="add_card_to_deck_from_details_button" onclick="remove_card_from_deck(\''+a+"', true)\">REMOVE FROM DECK</div>");e!=void 0&&e=="set_hero"&&(g+='<div class="add_card_to_deck_from_details_button" onclick="set_hero(\''+a+"', true)\">SET AS HERO</div>");setTimeout(function(){$(".detail_overlay").removeClass("hidden");$(".detail_overlay .card_detail").html(g)},10)}else $(".detail_overlay .card_detail").html("")}
function reset_filters(){$(".name_filter").val("");$(".ability_filter").val("");$(".min_cost_filter").val("");$(".max_cost_filter").val("");$(".min_value_filter").val("");$(".max_value_filter").val("");$(".filter_checkbox").prop("checked",!0)}function clear_filters(){$(".name_filter").val("");$(".ability_filter").val("");$(".min_cost_filter").val("");$(".max_cost_filter").val("");$(".min_value_filter").val("");$(".max_value_filter").val("");$(".filter_checkbox").prop("checked",!1)}
var current_campaign=-1,current_chapter="";function show_campaigns(){$(".all_campaigns_container").html("");var a=0;$.each(all_campaigns,function(b,c){a++;c=parse_campaign(b,a);$(".all_campaigns_container").append(c);setTimeout(function(){$(".campaign_"+b).removeClass("pre_load")},Math.random()*a*50)})}
function parse_campaign(a,b){var c="",e=all_campaigns[a];c+='<div class="card pre_load campaign_'+a+'" onclick="current_campaign = '+a+", show_content('single_campaign')\">";count_object(e.color)>1?$.each(e.color,function(d,f){c+='<div class="card_color color_'+f+" color_number_"+d+'"></div>'}):c+='<div class="card_color color_'+e.color[0]+'"></div>';a="";e.image_position!=void 0&&(a=";background-position:"+e.image_position);c+='<div class="card_image" style="background-image:url(images/'+e.image+
")"+a+'"></div>';e.description!=void 0&&(c+='<div class="card_abilities">'+e.description+"</div>");b!=void 0&&(c+='<div class="card_power">'+b+"</div>");c+='<div class="card_name">'+capitalizeFirstLetter(e.name)+"</div>";return c+="</div>"}
function parse_chapter(a,b){var c="";b=all_chapters[a];var e=!0,d="";$.each(all_chapters[a].needs_cleared,function(g,h){gamedata.cleared_chapters[h]==void 0&&(e=!1,d+=capitalizeFirstLetter(all_chapters[h].name)+"<br/>")});e==0?(c+='<div class="card pre_load disabled chapter_'+a+'">',c+='<div class="need_to_clear">Clear to unlock:<br/>'+d+"</div>"):c=gamedata.cleared_chapters[a]==void 0?c+('<div class="card unlocked pre_load chapter_'+a+'" onclick="current_chapter=\''+a+"',show_chapter_details()\">"):
b.additional_clear_rewards==void 0?c+('<div class="card unlocked pre_load chapter_'+a+' chapter_done" onclick="current_chapter=\''+a+"',show_chapter_details()\">"):c+('<div class="card unlocked pre_load chapter_'+a+'" onclick="current_chapter=\''+a+"',show_chapter_details()\">");count_object(b.color)>1?$.each(b.color,function(g,h){c+='<div class="card_color color_'+h+" color_number_"+g+'"></div>'}):c+='<div class="card_color color_'+b.color[0]+'"></div>';var f="";b.image_position!=void 0&&(f=";background-position:"+
b.image_position);c+='<div class="card_image" style="background-image:url(images/'+b.image+")"+f+'"></div>';b.description!=void 0&&(c+='<div class="card_abilities">'+b.description+"</div>");c+='<div class="card_name">'+capitalizeFirstLetter(b.name)+"</div>";e==0&&(c+='<div class="locked">LOCKED</div>');gamedata.cleared_chapters[a]!=void 0&&e==1&&(c+='<div class="cleared">CLEARED</div>');return c+="</div>"}
function show_single_campaign(){$(".single_campaign_container").html("");var a=0;$.each(all_campaigns[current_campaign].chapters,function(b,c){a++;b=parse_chapter(c,a);$(".single_campaign_container").append(b);setTimeout(function(){$(".chapter_"+c).removeClass("pre_load")},Math.random()*100+1)})}
function show_chapter_details(){$(".detail_overlay .card_detail").html("");var a=current_chapter,b="",c=all_chapters[current_chapter];b+='<button class="start_campaign" onclick="current_chapter=\''+a+"',show_chapter_battle()\">START</button>";var e="";b+='<div class="available_cards">';b+='<div class="card">';c.image_position!=void 0&&(e=";background-position:"+c.image_position);b+='<div class="card_image" style="background-image:url(images/'+c.image+")"+e+'"></div>';b+="</div>";b+="</div>";b+='<div class="ability_details">';
b+='<div class="single_ability">';b+='<div class="single_ability_name">';b+=capitalizeFirstLetter(c.name);b+="</div>";c.description!=void 0&&(b+='<div class="single_ability_description">'+c.description+"</div>");b+="</div>";b+="</div>";gamedata.cleared_chapters[a]==void 0?(b+='<div class="reward_cards">',b+='<div class="reward_title">Rewards:</div>',$.each(c.first_clear_rewards,function(d,f){d!="scraps"?(f=parse_card(d,f),b+='<div class="single_reward" onclick="show_card_details(\''+d+"')\">",b+=
f,b+="</div>"):b=f>1?b+('<div class="single_reward"><div class="scrap_reward">'+f+" scraps</div></div>"):b+('<div class="single_reward"><div class="scrap_reward">'+f+" scrap</div></div>")}),b+="</div>"):c.additional_clear_rewards!=void 0&&(b+='<div class="reward_cards">',b+='<div class="reward_title">Possible rewards:</div>',$.each(c.additional_clear_rewards,function(d,f){d!="scraps"?(f=parse_card(d,f),b+='<div class="single_reward" onclick="show_card_details(\''+d+"')\">",b+=f,b+="</div>"):b=f>1?
b+('<div class="single_reward"><div class="scrap_reward">'+f+" scraps</div></div>"):b+('<div class="single_reward"><div class="scrap_reward">'+f+" scrap</div></div>")}),b+="</div>");$(".detail_overlay .card_detail").append(b);$(".detail_overlay").removeClass("hidden")}var intro_step=0;
function run_intro(a){a!=void 0||gamedata.viewed_intro==void 0?(gamedata.viewed_intro=!0,saveToLocalStorage(),$(".intro").css("display","block"),$(".intro").html(""),$(".intro").append('<div class="skip_intro_button">SKIP</div>'),$(".main_window").addClass("hidden"),intro_step=0,show_next_step()):skip_intro()}
function show_next_step(){var a=intro_steps[intro_step],b=intro_step+0,c="";c+='<div class="intro_step step_'+b+'" style="';a.text_size!=void 0&&(c+="font-size:"+a.text_size+";");a.text_align!=void 0&&(c+="text-align:"+a.text_align+";");a.start_location!=void 0&&$.each(a.start_location,function(e,d){c+=e+":"+d+";"});a.image!=void 0&&a.image!="none"&&(c+="background-image:url("+a.image+");");c+='">';a.text!=void 0&&(c+=a.text);c+="</div>";setTimeout(function(){$(".intro").append(c);setTimeout(function(){$(".step_"+
b).addClass("visible");adjust_step_position(b,a)},50);setTimeout(function(){$(".step_"+b).removeClass("visible");$(".step_"+b).css("opacity","0")},a.time_on_screen)},a.timeout);intro_steps[intro_step+1]!=void 0?(intro_step++,show_next_step()):setTimeout(function(){skip_intro()},a.timeout+a.time_on_screen+2E3)}function adjust_step_position(a,b){$.each(b.end_location,function(c,e){$(".step_"+a).css(c,e)});b.opacity!=void 0&&$(".step_"+a).css("opacity",b.opacity)}
function skip_intro(){$(".main_window").removeClass("hidden");$(".intro").css("display","none")}
var intro_steps={0:{timeout:0,time_on_screen:2E3,text:"Long ago...",text_size:"10vw",image:"none",start_location:{left:"10%",top:"30%"},end_location:{left:"15%",top:"30%"}},1:{timeout:2500,time_on_screen:3E3,image:"images/cards/butterfly-2049567_640.jpg",opacity:.3,start_location:{right:"0%",top:"0%",left:"0%",bottom:"0%"},end_location:{right:"-5%",top:"-5%",left:"-0%",bottom:"-0%"}},2:{timeout:2500,time_on_screen:2E3,text:"There was peace in the world",text_size:"5vw",text_align:"right",image:"none",
start_location:{right:"10%",top:"60%",left:"-100%"},end_location:{right:"15%",top:"60%"}},3:{timeout:6500,time_on_screen:3E3,image:"images/cards/fantasy-3366526_640.jpg",opacity:.3,start_location:{right:"0%",top:"0%",left:"0%",bottom:"-120%"},end_location:{right:"-5%",top:"-0%",left:"-5%",bottom:"-140%"}},4:{timeout:6E3,time_on_screen:3E3,text:"Then man arrived",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"20%",right:"-100%"},end_location:{left:"15%",bottom:"20%"}},
5:{timeout:1E4,time_on_screen:3500,image:"images/cards/confrontation-930744_640.jpg",opacity:.3,start_location:{right:"-10%",top:"-0%",left:"-0%",bottom:"-100%"},end_location:{right:"-0%",top:"-0%",left:"-10%",bottom:"-100%"}},6:{timeout:1E4,time_on_screen:2500,text:"Aggressive by nature...",text_size:"5vw",text_align:"right",image:"none",start_location:{left:"-110%",top:"20%",right:"10%"},end_location:{right:"15%",top:"20%"}},7:{timeout:13E3,time_on_screen:5500,image:"images/cards/barbarian-4616094_640.jpg",
opacity:.3,start_location:{right:"-0%",top:"-20%",left:"-10%",bottom:"-80%"},end_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-150%"}},8:{timeout:13E3,time_on_screen:2500,text:"men started fighting<br/>amongst themselves",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"15%",top:"30%",left:"-100%"},end_location:{right:"20%",top:"30%"}},9:{timeout:15E3,time_on_screen:2E3,text:"breaking apart into factions",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"20%",
top:"50%",right:"-100%"},end_location:{left:"25%",top:"50%"}},10:{timeout:18E3,time_on_screen:3500,image:"images/cards/farewell-587277_1280.jpg",opacity:.3,start_location:{right:"-0%",top:"-50%",left:"-0%",bottom:"-0%"},end_location:{right:"-20%",top:"-60%",left:"-0%",bottom:"-0%"}},11:{timeout:18E3,time_on_screen:2500,text:"Some kept the old ways",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"70%",right:"-100%"},end_location:{left:"15%"}},12:{timeout:21E3,time_on_screen:3500,
image:"images/cards/fantasy-2961723_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-80%"},end_location:{right:"-10%",top:"-0%",left:"-10%",bottom:"-110%"}},13:{timeout:21E3,time_on_screen:2500,text:"Some embraced nature",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},14:{timeout:24E3,time_on_screen:3500,image:"images/cards/fantasy-1390177_1280.jpg",opacity:.3,start_location:{right:"-0%",
top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-0%",left:"-0%",bottom:"-90%"}},15:{timeout:24E3,time_on_screen:2500,text:"Some sought magic in the north",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},16:{timeout:27E3,time_on_screen:3500,image:"images/cards/castle-832543_640.jpg",opacity:.3,start_location:{right:"-10%",top:"-0%",left:"-10%",bottom:"-20%"},end_location:{right:"-0%",top:"-20%",left:"-0%",
bottom:"-0%"}},17:{timeout:27E3,time_on_screen:2500,text:"Some found a god to worship",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},18:{timeout:3E4,time_on_screen:3500,image:"images/cards/monster-5369480_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-20%",bottom:"-200%"},end_location:{right:"-0%",top:"-0%",left:"-10%",bottom:"-150%"}},19:{timeout:3E4,time_on_screen:2500,text:"Others embraced darkness",
text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},20:{timeout:33E3,time_on_screen:3500,image:"images/cards/fire-2648873_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-30%",left:"-10%",bottom:"-30%"}},21:{timeout:33E3,time_on_screen:2500,text:"or just wanted the world to burn",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"10%",
right:"-100%"},end_location:{left:"15%"}},22:{timeout:37E3,time_on_screen:2500,text:"After many years of war...",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",bottom:"10%",right:"-100%"},end_location:{left:"15%"}},23:{timeout:39E3,time_on_screen:8E3,image:"images/cards/take-532097_640.jpg",opacity:.3,start_location:{right:"-0%",top:"-0%",left:"-0%",bottom:"-60%"},end_location:{right:"-10%",top:"-30%",left:"-10%",bottom:"-30%"}},24:{timeout:4E4,time_on_screen:2500,text:"a hero dreamt of a book",
text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"10%",right:"-100%"},end_location:{left:"15%"}},25:{timeout:42E3,time_on_screen:2500,text:"that would let him bring man together",text_size:"5vw",text_align:"left",image:"none",start_location:{left:"10%",top:"40%",right:"-100%"},end_location:{left:"15%"}},26:{timeout:45E3,time_on_screen:2500,text:"The question is...",text_size:"5vw",text_align:"right",image:"none",start_location:{right:"10%",top:"10%",left:"-100%"},end_location:{right:"15%"}},
27:{timeout:48E3,time_on_screen:4E3,text:"Will you?",text_size:"5vw",text_align:"center",image:"none",start_location:{right:"0%",top:"40%",left:"0%"},end_location:{}}},current_merchant_page=1,selling_card_id="",sell_amount=1,selling_price=1,listings_page=1,showing_mine=!1,buy_sell="buy",current_lowest_price=0,your_offer="",global_listings={},current_listing_id=!1;
function show_merchant(){sell_amount=selling_price=1;cards_per_page=12;$("#content_merchant .tinkering_list").html('<span class="no_tinker">No cards fit your<br/>current filters.</span>');gamedata.owned_cards=sortObj(gamedata.owned_cards);$("#content_merchant .tinkering_list").html("");var a=0;$.each(gamedata.owned_cards,function(b,c){c+=0;(c>0||buy_sell=="buy")&&check_filters(b)==0&&all_available_cards[b].non_tradable==void 0&&(a++,a/cards_per_page>current_merchant_page-1&&a/cards_per_page<=current_merchant_page&&
(c=parse_card(b,c),$("#content_merchant .tinkering_list").append('<div onclick="current_lowest_price=0;selling_price='+all_available_cards[b].value+";show_sell_card_content('"+b+"')\">"+c+"</div>")))});current_merchant_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");a/cards_per_page<=current_merchant_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");Math.ceil(a/
12)<current_merchant_page&&a>0&&(current_merchant_page=1,show_merchant());a==0&&$("#content_merchant .tinkering_list").html('<span class="no_tinker">No cards fit your<br/>current filters.</span>');a==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page");$(".page_selection .page_number").html(current_merchant_page+" / "+Math.ceil(a/cards_per_page))}
function set_merchant_page(a){current_merchant_page+=a;current_merchant_page<1&&(current_merchant_page=1);show_merchant()}function set_market_page(a){listings_page+=a;listings_page<1&&(listings_page=1);showing_mine==0?show_market():show_my_market()}function show_sell_card_content(a){selling_card_id=a;buy_sell=="sell"?show_content("sell_card"):show_content("buy_card")}function show_buy_card(){show_sell_card()}
function show_sell_card(){if(selling_card_id==""||all_available_cards[selling_card_id]==void 0||gamedata.owned_cards[selling_card_id]<1&&buy_sell=="sell"||all_available_cards[selling_card_id].non_tradable!=void 0)show_content("merchant");else{sell_amount<1&&(sell_amount=1);sell_amount>gamedata.owned_cards[selling_card_id]&&buy_sell=="sell"&&(sell_amount=gamedata.owned_cards[selling_card_id]);var a=parse_card(selling_card_id,gamedata.owned_cards[selling_card_id]);buy_sell=="sell"?$(".sell_card_container").html("Selling:<br/><div onclick=\"show_card_details('"+
selling_card_id+"')\""+a):$(".sell_card_container").html("Buying:<br/><div onclick=\"show_card_details('"+selling_card_id+"')\""+a);$(".sell_card_amount_container .sell_amount").html(numberWithCommas(sell_amount));a=Math.floor(sell_amount*all_available_cards[selling_card_id].value/2);a==0?($(".merchant_offer").html("The merchant does not want this.<br/>Maybe offer more cards?"),$(".sell_to_merchant_button").addClass("hidden")):($(".sell_to_merchant_button").removeClass("hidden"),a==1?$(".merchant_offer").html("The merchant offers you 1 scrap for this."):
$(".merchant_offer").html("The merchant offers you "+numberWithCommas(a)+" scraps for this."));selling_price<all_available_cards[selling_card_id].value/2&&(selling_price=Math.floor(all_available_cards[selling_card_id].value/2));selling_price>all_available_cards[selling_card_id].value*40&&(selling_price=Math.floor(all_available_cards[selling_card_id].value*40));selling_price<1&&(selling_price=1);$(".price_amount").html(numberWithCommas(selling_price));buy_sell=="sell"?get_lowest_price(selling_card_id):
get_highest_price(selling_card_id)}}function adjust_sell_amount(a){sell_amount+=a;show_sell_card()}
function adjust_selling_price(a){a>0&&selling_price>=20&&(a=5);a>0&&selling_price>=50&&(a=10);a>0&&selling_price>=100&&(a=20);a>0&&selling_price>=500&&(a=50);a>0&&selling_price>=1E3&&(a=100);selling_price+=a;selling_price<1&&(selling_price=1);selling_price>1E3&&(selling_price=Math.floor(selling_price/100)*100);selling_price>500&&selling_price<1E3&&(selling_price=Math.floor(selling_price/50)*50);selling_price>100&&selling_price<500&&(selling_price=Math.floor(selling_price/20)*20);selling_price>50&&
selling_price<100&&(selling_price=Math.floor(selling_price/10)*10);selling_price>20&&selling_price<50&&(selling_price=Math.floor(selling_price/5)*5);buy_sell!="sell"&&selling_price>gamedata.scraps&&(selling_price=gamedata.scraps);show_sell_card()}
function take_merchant_offer(){if(sell_amount>0&&sell_amount<=gamedata.owned_cards[selling_card_id]){var a=Math.floor(sell_amount*all_available_cards[selling_card_id].value/2);gamedata.owned_cards[selling_card_id]-=sell_amount;gain_scraps(a);show_available_cards(!1)}check_quests("sell_to_merchant");sell_amount=1;show_content("merchant")}
function place_offer(){sell_amount>0&&sell_amount<=gamedata.owned_cards[selling_card_id]?(gamedata.owned_cards[selling_card_id]-=sell_amount,saveToLocalStorage(),show_available_cards(!1),$.post("ajax.php",{data:"place_offer",current_id:gamedata.account_id,card_id:selling_card_id,card_amount:sell_amount,price:selling_price},function(a){console.log(a);show_content("merchant")})):(sell_amount=1,show_content("merchant"))}
function place_buy_offer(){sell_amount>0&&gamedata.scraps>=selling_price*sell_amount?(gamedata.scraps-=selling_price*sell_amount,saveToLocalStorage(),show_available_cards(!1),$.post("ajax.php",{data:"place_buy_offer",current_id:gamedata.account_id,card_id:selling_card_id,card_amount:sell_amount,price:selling_price},function(a){console.log(a);show_content("merchant")})):(sell_amount=1,show_content("merchant"))}
function show_market(){$(".market_list").html("");showing_mine=!1;buy_sell=="buy"?($(".market_view_slider").addClass("buying"),$(".select_buy").addClass("active"),$(".select_sell").removeClass("active"),$.post("ajax.php",{data:"get_market",current_id:gamedata.account_id},function(a){parse_current_market(JSON.parse(a))})):($(".market_view_slider").removeClass("buying"),$(".select_sell").addClass("active"),$(".select_buy").removeClass("active"),showing_mine=!1,$.post("ajax.php",{data:"get_market_offers",
current_id:gamedata.account_id},function(a){parse_current_market(JSON.parse(a))}))}
function show_my_market(){$(".market_list").html("");showing_mine=!0;buy_sell=="buy"?($(".market_view_slider").addClass("buying"),$(".select_buy").addClass("active"),$(".select_sell").removeClass("active")):($(".market_view_slider").removeClass("buying"),$(".select_sell").addClass("active"),$(".select_buy").removeClass("active"));$.post("ajax.php",{data:"get_your_market",current_id:gamedata.account_id},function(a){parse_current_market(JSON.parse(a),!0)})}
function get_lowest_price(a){current_lowest_price==0?($(".current_market_price").html(""),$.post("ajax.php",{data:"get_lowest_price",card_id:a},function(b){b=JSON.parse(b);your_offer="";count_object(b)>0&&b.user_id!=void 0&&b.user_id==gamedata.account_id&&(your_offer=" (yours)");b!=null&&b.price!=void 0?(current_lowest_price=b.price,$(".current_market_price").html("Lowest price on the market for this is "+numberWithCommas(b.price)+" each"+your_offer)):(current_lowest_price=null,$(".current_market_price").html("There are no offers for this on the market"))})):
current_lowest_price!=null&&current_lowest_price!=void 0?$(".current_market_price").html("Lowest price on the market for this is "+numberWithCommas(current_lowest_price)+" each"+your_offer):$(".current_market_price").html("There are no offers for this on the market")}
function get_highest_price(a){current_lowest_price==0?($(".current_market_price").html(""),$.post("ajax.php",{data:"get_highest_price",card_id:a},function(b){b=JSON.parse(b);your_offer="";count_object(b)>0&&b.user_id!=void 0&&b.user_id==gamedata.account_id&&(your_offer=" (yours)");b!=null&&b.price!=void 0?(current_lowest_price=b.price,$(".current_market_price").html("Highest price on the market for this is "+numberWithCommas(b.price)+" each"+your_offer)):(current_lowest_price=null,$(".current_market_price").html("There are no requests for this on the market"))})):
current_lowest_price!=null&&current_lowest_price!=void 0?$(".current_market_price").html("Highest price on the market for this is "+numberWithCommas(current_lowest_price)+" each"+your_offer):$(".current_market_price").html("There are no requests for this on the market")}function buy_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"buy_listing",listing_id:a},function(b){complete_buy_listing(JSON.parse(b))})}
function sell_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"sell_listing",listing_id:a},function(b){complete_sell_listing(JSON.parse(b))})}function complete_buy_listing(a){check_quests("complete_buy_listing");gamedata.scraps-=a.price;gain_card(a.card_id);show_market()}function complete_sell_listing(a){check_quests("complete_sell_listing");--gamedata.owned_cards[a.card_id];gamedata.scraps+=parseInt(a.price);saveToLocalStorage();show_market()}
function cancel_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"claim_listing",listing_id:a},function(b){var c=JSON.parse(b);$.post("ajax.php",{data:"delete_listing",listing_id:a},function(e){complete_cancel_listing(c)})})}function cancel_buy_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"claim_listing",listing_id:a},function(b){var c=JSON.parse(b);$.post("ajax.php",{data:"delete_listing",listing_id:a},function(e){complete_cancel_buy_listing(c)})})}
function complete_cancel_listing(a){for(var b=a.card_amount-a.sold,c=b-1;c>=0;c--)gain_card(a.card_id);show_card_details(a.card_id,void 0,b);showing_mine==0?show_market():show_my_market()}function complete_cancel_buy_listing(a){gain_scraps(a.price*(a.card_amount-a.sold));showing_mine==0?show_market():show_my_market()}function claim_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"claim_listing",listing_id:a},function(b){complete_claim_listing(JSON.parse(b))})}
function claim_buy_listing(a){$(".market_list").html("");$.post("ajax.php",{data:"claim_listing",listing_id:a},function(b){complete_claim_buy_listing(JSON.parse(b))})}function complete_claim_listing(a){gain_scraps(a.price*a.sold);showing_mine==0?show_market():show_my_market()}function complete_claim_buy_listing(a){for(var b=a.sold-1;b>=0;b--)gain_card(a.card_id);show_card_details(a.card_id,void 0,a.sold);showing_mine==0?show_market():show_my_market()}
function parse_current_market(a,b){$("#content_market .page_selection").addClass("hidden");$("#content_my_market .page_selection").addClass("hidden");current_listing_id==0?($("#content_market .menu_button").removeClass("hidden"),$("#content_market .market_view").removeClass("hidden"),$("#content_market .select_filters").removeClass("hidden"),$(".market_list").removeClass("showing_single")):($("#content_market .menu_button").addClass("hidden"),$("#content_market .market_view").addClass("hidden"),$("#content_market .select_filters").addClass("hidden"),
$(".market_list").addClass("showing_single"));gamedata.scraps==1?$(".scrap_count").html(gamedata.scraps+" scrap"):$(".scrap_count").html(gamedata.scraps+" scraps");$(".market_list").html("");var c="";current_listing_id==0&&(global_listings=a);$(".market_list").append(c);var e=0;$.each(a,function(d,f){if((current_listing_id==0||current_listing_id==f.id)&&all_available_cards[f.card_id]!=void 0&&check_filters(f.card_id)==0&&(f.card_amount-f.sold>0||b==1)&&(b!=1||f.user_id==gamedata.account_id&&b==1)&&
(e++,e<=listings_page*6&&e>(listings_page-1)*6||current_listing_id!=0)){d="";var g=parse_card(f.card_id),h=0;gamedata.owned_cards[f.card_id]!=void 0&&gamedata.owned_cards[f.card_id]>0&&(h=gamedata.owned_cards[f.card_id]);d+='<div class="single_market_card"><div onclick="show_card_details(\''+f.card_id+"')\">"+g+"</div>";f.user_id!=gamedata.account_id&&f.card_amount-f.sold>0&&(f.buy_sell=="sell"&&(d+='<div class="market_description"><span class="selling">In stock: '+(f.card_amount-f.sold)+"</span><br/>Price: "+
numberWithCommas(f.price)+"<br/>Owned: "+h+"</div>",gamedata.scraps>=f.price&&(d=current_listing_id==0?d+('<div class="market_buy_button" onclick="current_listing_id='+f.id+';parse_current_market(global_listings)">VIEW</div>'):d+('<div class="market_buy_button" onclick="buy_listing('+f.id+')">BUY</div>')),current_listing_id!=0&&(d+='<div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>')),f.buy_sell=="buy"&&(d+='<div class="market_description"><span class="buying">Requested: '+
(f.card_amount-f.sold)+"</span><br/>Pays: "+numberWithCommas(f.price)+"<br/>Owned: "+h+"</div>",h>=1&&(d=current_listing_id==0?d+('<div class="market_sell_button" onclick="current_listing_id='+f.id+';parse_current_market(global_listings)">VIEW</div>'):d+('<div class="market_sell_button" onclick="sell_listing('+f.id+')">SELL</div>')),current_listing_id!=0&&(d+='<div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>')));f.user_id==gamedata.account_id&&(f.buy_sell==
"sell"&&(d+='<div class="market_description"><span class="selling">SELLING</span><br/>Price: '+numberWithCommas(f.price),d=f.sold>0?d+("<br/>Sold: "+f.sold):d+("<br/>Offering: "+f.card_amount),d+="</div>",d=f.sold>0?d+('<div class="market_buy_button" onclick="claim_listing('+f.id+')">CLAIM</div>'):d+('<div class="market_cancel_button" onclick="cancel_listing('+f.id+')">CANCEL</div>')),f.buy_sell=="buy"&&(d+='<div class="market_description"><span class="buying">BUYING</span><br/>Price: '+numberWithCommas(f.price),
d=f.sold>0?d+("<br/>Bought: "+f.sold):d+("<br/>Requesting: "+f.card_amount),d+="</div>",d=f.sold>0?d+('<div class="market_buy_button" onclick="claim_buy_listing('+f.id+')">CLAIM</div>'):d+('<div class="market_cancel_button" onclick="cancel_buy_listing('+f.id+')">CANCEL</div>')));d+="</div>";$(".market_list").append(d)}});e==0&&(c='<div class="listing no_hover"><span class="no_results">No results found</span>',current_listing_id!=0&&(c+='<br/><br/><div class="market_cancel_button" onclick="current_listing_id=false;show_market()">CLOSE</div>'),
c+="</div>",$(".market_list").append(c));e>1&&($("#content_market .page_selection").removeClass("hidden"),$("#content_my_market .page_selection").removeClass("hidden"),listings_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),e/6<=listings_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),Math.ceil(e/6)<listings_page&&(listings_page=1,showing_mine==0?parse_current_market(a):
parse_current_market(a,!0)),$(".page_selection .page_number").html(listings_page+" / "+Math.ceil(e/6)))}
function check_filters(a,b){var c={ability:""};$(".ability_filter").val()!=""&&(c.ability=$(".ability_filter").val());c.name="";$(".name_filter").val()!=""&&(c.name=$(".name_filter").val());$(".min_cost_filter").val()!=""&&(c.min_cost=parseInt($(".min_cost_filter").val()));$(".max_cost_filter").val()!=""&&(c.max_cost=parseInt($(".max_cost_filter").val()));$(".min_value_filter").val()!=""&&(c.min_value=parseInt($(".min_value_filter").val()));$(".max_value_filter").val()!=""&&(c.max_value=parseInt($(".max_value_filter").val()));
var e=!1;if(c.name!=""){var d=!1;all_available_cards[a].name.indexOf(c.name)!=-1&&(d=!0);$.each(all_available_cards[a].subtypes,function(h,k){k.indexOf(c.name)!=-1&&(d=!0)});d==0&&(e=!0)}if(c.ability!=""){var f=!1,g=all_available_cards[a].abilities;b!=void 0&&b==1&&all_available_cards[a].hero_version!=void 0&&all_available_cards[a].hero_version.abilities!=void 0&&(g=all_available_cards[a].hero_version.abilities);$.each(g,function(h,k){typeof k=="object"?k=all_abilities[h].name+" "+k.level:all_abilities[h]!=
void 0?k=all_abilities[h].name+" "+k:(k="",console.log(h));k.indexOf(c.ability)!=-1&&(f=!0);all_abilities[h].description.indexOf(c.ability)!=-1&&(f=!0)});f==0&&(e=!0)}c.min_cost!=void 0&&all_available_cards[a].time<c.min_cost&&(e=!0);c.max_cost!=void 0&&all_available_cards[a].time>c.max_cost&&(e=!0);c.min_value!=void 0&&all_available_cards[a].value<c.min_value&&(e=!0);c.max_value!=void 0&&all_available_cards[a].value>c.max_value&&(e=!0);$("."+all_available_cards[a].type+"_type_filter").prop("checked")==
0&&(e=!0);namechanges[a]!=void 0&&(e=!0);$.each(all_available_cards[a].color,function(h,k){k!=void 0&&$("."+k+"_color_filter").prop("checked")==0&&(e=!0)});return e}function toggle_market_view_mode(){buy_sell=buy_sell=="sell"?"buy":"sell";show_market()}function toggle_my_market_view_mode(){buy_sell=buy_sell=="sell"?"buy":"sell";show_my_market()}var current_tinker_page=1,current_tinker="",min_tinker=0;
function show_tinker(){gamedata.known_recipes==void 0&&(gamedata.known_recipes={},saveToLocalStorage());$(".tinkering_container").html('<span class="no_tinker">You need 5 identical cards and an unknown recipe that can be crafted with that card to be able to tinker</span>');$(".tinker_min_amount").html("OWNED: "+min_tinker);var a="",b=0;$.each(gamedata.owned_cards,function(c,e){if(e>=min_tinker&&check_filters(c)==0){var d=0;$.each(all_available_cards,function(g,h){if(gamedata.known_recipes[g]==void 0&&
h.recipe!=void 0&&h.recipe[c]!=void 0){var k=!0;$.each(h.recipe,function(l,p){gamedata.known_recipes[l]==void 0&&all_available_cards[l].recipe!=void 0&&(k=!1)});k==1&&d++}});if(d>0&&(b++,b>current_tinker_page*12-12&&b<=current_tinker_page*12)){var f=parse_card(c,e+" ("+d+")");a=e>4?a+("<div onclick=\"current_tinker='"+c+"';show_content('single_tinker')\">"+f+"</div>"):a+('<div class="faded" onclick="current_tinker=\''+c+"';show_content('single_tinker')\">"+f+"</div>")}}});b>12?($("#content_tinker .page_selection").show(),
current_tinker_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),b/12<=current_tinker_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),b==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_tinker_page+" / "+Math.ceil(b/12))):$("#content_tinker .page_selection").hide();
b>0&&Math.ceil(b/12)<current_tinker_page?(current_tinker_page=1,show_tinker()):a!=""&&$(".tinkering_container").html('<div class="tinkering_list">'+a+"</div>")}function toggle_min_tinker(){var a=min_tinker+0;a==0&&(min_tinker=1);a==1&&(min_tinker=5);a==5&&(min_tinker=10);a==10&&(min_tinker=0)}
function show_single_tinker(){var a=get_possible_tinker_results(current_tinker);if(all_available_cards[current_tinker]==void 0||count_object(a)<1)show_content("tinker");else{var b=all_available_cards[current_tinker];$(".single_tinker_name").html(capitalizeFirstLetter(b.name));$(".single_tinker_container").html("");b=0;gamedata.owned_cards[current_tinker]!=void 0&&(b=gamedata.owned_cards[current_tinker]);var c=parse_card(current_tinker,b);$(".single_tinker_container").append('<div class="tinker_card_container">'+
c+"</div>");if(b>=0){b>4?($(".single_tinker_container").append('<div class="tinker_confirmation_description">Use 5 of these cards<br/>to find a new recipe?</div>'),$(".single_tinker_container").append('<div class="tinker_confirmation_button" onclick="tinker_current()">TINKER</div>')):$(".single_tinker_container").append('<div class="tinker_confirmation_description">You need 5 of these cards<br/>to find a new recipe.</div>');var e="",d=0;$.each(a,function(f,g){d<12&&(e+="<div onclick=\"show_card_details('"+
f+"')\">"+parse_card(f)+"</div>");d++});$(".single_tinker_container").append('<div class="craftable_with_this"><span class="craftable_with_this_title">Based on what you have discovered so far, you can discover the following recipes:</span><br/>'+e+"</div>")}}}function set_tinker_page(a){current_tinker_page+=a;current_tinker_page<1&&(current_tinker_page=1);show_tinker()}
function tinker_current(){var a=0;gamedata.owned_cards[current_tinker]!=void 0&&(a=gamedata.owned_cards[current_tinker]);if(all_available_cards[current_tinker]==void 0||a<5)show_content("tinker");else{$(".tinker_confirmation_description").remove();$(".tinker_confirmation_button").remove();$(".single_tinker_container .craftable_with_this").remove();setTimeout(function(){$(".tinker_card_container").html("")},500);$(".tinker_card_container").css("left","350px");a=get_possible_tinker_results(current_tinker);
for(var b=!1,c=500,e=1;e<=14;e++){var d="";if(count_object(a)>1||Math.ceil(e/2)==e/2)b=get_random_key_from_object(a),d=parse_card(b);var f=c+50*e*3,g=!0;e==14&&(g=!1);show_tinker_temp_result(d,e,c,g,f);c+=50*e}c+=1E3;b!=0&&(gamedata.owned_cards[current_tinker]-=5,gamedata.known_recipes[b]=!0,show_available_cards(!1),gain_card(b),saveToLocalStorage(),setTimeout(function(){show_card_details(b);show_single_tinker()},c))}}
function show_tinker_temp_result(a,b,c,e,d){setTimeout(function(){$(".tinker_card_container").append('<div class="possible_new_recipe card_to_show_id_'+b+'">'+a+"</div>")},c);e==1&&setTimeout(function(){$(".card_to_show_id_"+b).addClass("faded_out")},d)}
function get_possible_tinker_results(a){var b={};$.each(all_available_cards,function(c,e){if(gamedata.known_recipes[c]==void 0&&e.recipe!=void 0&&e.recipe[a]!=void 0){var d=!0;$.each(e.recipe,function(f,g){gamedata.known_recipes[f]==void 0&&all_available_cards[f].recipe!=void 0&&(d=!1)});d==1&&(b[c]=!0)}});return b}
function tinker_card(a){if(gamedata.owned_cards[a]>4){var b={};$.each(all_available_cards,function(e,d){if(gamedata.known_recipes[e]==void 0&&d.recipe!=void 0&&d.recipe[a]!=void 0){var f=!0;$.each(d.recipe,function(g,h){gamedata.known_recipes[g]==void 0&&all_available_cards[g].basic_reward==void 0&&(f=!1)});f==1&&(b[e]=!0)}});if(count_object(b)>0){var c=get_random_key_from_object(b);gamedata.owned_cards[a]-=5;gamedata.known_recipes[c]=!0;show_card_details(c);show_available_cards(!1);saveToLocalStorage();
show_tinker()}}}var current_crafting_page=1,current_craft="",view_tinkerable=!1,cards_per_crafting_page=12;
function show_craft(){gamedata.known_recipes==void 0&&(gamedata.known_recipes={},saveToLocalStorage());$(".tinker_view").show();gamedata.known_recipes=sortObj(gamedata.known_recipes);$(".craft_container").html('<span class="no_tinker">Use tinkering to find recipes</span>');$(".carft_back_button").hide();$(".craft_home_button").show();$(".craft_button").hide();var a="",b=0;$.each(gamedata.known_recipes,function(c,e){e=!1;all_available_cards[c].recipe==void 0&&(e=!0);if(e==0&&check_filters(c)==0){var d=
!0;$.each(all_available_cards[c].recipe,function(g,h){if(gamedata.owned_cards[g]==void 0||gamedata.owned_cards[g]<h)d=!1});var f=0;$.each(all_available_cards,function(g,h){if(gamedata.known_recipes[g]==void 0&&h.recipe!=void 0&&typeof h.recipe=="object"&&h.recipe[c]!=void 0){var k=!0;$.each(h.recipe,function(l,p){gamedata.known_recipes[l]==void 0&&all_available_cards[l].recipe!=void 0&&all_available_cards[l].basic_reward==void 0&&(k=!1)});k==1&&f++}});if(f>0||view_tinkerable==0)b++,b>current_crafting_page*
cards_per_crafting_page-cards_per_crafting_page&&b<=current_crafting_page*cards_per_crafting_page&&(e=0,gamedata.owned_cards[c]!=void 0&&gamedata.owned_cards[c]>0&&(e=gamedata.owned_cards[c]),e=parse_card(c,e),a+='<span class="can_craft_'+d+'" onclick="show_card_recipe(\''+c+"')\">"+e+"</span>")}});b>cards_per_crafting_page?($("#content_craft .page_selection").show(),current_crafting_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),
b/cards_per_crafting_page<=current_crafting_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),b==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_crafting_page+" / "+Math.ceil(b/cards_per_crafting_page))):$("#content_craft .page_selection").hide();b>0&&Math.ceil(b/cards_per_crafting_page)<current_crafting_page?(current_crafting_page=
1,show_craft()):a!=""&&$(".craft_container").html('<div class="tinkering_list">'+a+"</div>")}function set_crafting_page(a){current_crafting_page+=a;current_crafting_page<1&&(current_crafting_page=1);show_craft()}
function show_card_recipe(a){$(".craft_container").html("");$(".tinker_view").hide();$("#content_craft .page_selection").hide();gamedata.known_recipes=sortObj(gamedata.known_recipes);current_craft=a;var b="",c=!0,e=count_object(all_available_cards[a].recipe);$(".craft_container").removeClass("cost_1");$(".craft_container").removeClass("cost_2");$(".craft_container").removeClass("cost_3");$(".craft_container").removeClass("cost_4");$(".craft_container").addClass("cost_"+e);var d=!0;$.each(all_available_cards[a].recipe,
function(l,p){l!="peasant"&&(d=!1);var n='<div class="single_cost_container">';if(gamedata.owned_cards[l]==void 0||gamedata.owned_cards[l]<p){c=!1;var q=gamedata.owned_cards[l];q==void 0&&(q=0);n+='<div class="craft_not_enough"  onclick="show_card_details(\''+l+"')\">"+parse_card(l,'<span style="color:rgba(255,0,0,1)">'+q+"</span>/"+p)+"</div>"}else n+='<div class=""  onclick="show_card_details(\''+l+"')\">"+parse_card(l,gamedata.owned_cards[l]+"/"+p)+"</div>";gamedata.known_recipes[l]!=void 0&&all_available_cards[l].recipe!=
void 0&&(n+='<div class="menu_button slim recipe_button" no-new-page="true" onclick="show_card_recipe(\''+l+"')\">RECIPE</div>");b+=n+"</div>"});b+="<br/>";e=gamedata.owned_cards[a];e==void 0&&(e=0);b+='<div class="recipe_result active" onclick="show_card_details(\''+a+"')\">"+parse_card(a,e)+"</div>";all_available_cards[a].hero_version!=void 0&&(b+='<div class="recipe_hero_result" onclick="show_card_details(\''+a+"', true)\">"+parse_card(a,e,!0)+"</div>",b+='<div class="swap_hero_button" onclick="swap_hero_preview()">SWAP CARDS</div>');
b+="<br/>";b=c==1?b+'<div class="menu_button slim craft_button" onclick="craft_current_card()" no-new-page="true">CRAFT</div><br/>':b+'<div class="menu_button slim craft_button not_enough" no-new-page="true">CRAFT</div><br/>';d==0&&get_upgrade_factor("quick_craft","any",!0)>1&&(b=gamedata.owned_cards.peasant>=all_available_cards[a].value?b+('<br/><div class="menu_button slim craft_button" onclick="quick_craft_current_card()" no-new-page="true">QUICK CRAFT<br/><span>('+nFormatter(gamedata.owned_cards.peasant,
3)+" / "+all_available_cards[a].value+" peasants)</span></div>"):b+('<br/><div class="menu_button slim craft_button" no-new-page="true">QUICK CRAFT<br/><span class="button_subtext not_enough">('+nFormatter(gamedata.owned_cards.peasant,3)+" / "+all_available_cards[a].value+" peasants)</span></div>"));var f=0,g=0;$.each(all_available_cards,function(l,p){if(gamedata.known_recipes[l]==void 0&&p.recipe!=void 0&&typeof p.recipe=="object"&&p.recipe[a]!=void 0){var n=!0;$.each(p.recipe,function(q,m){gamedata.known_recipes[q]==
void 0&&all_available_cards[q].recipe!=void 0&&(n=!1)});n==1&&f++;g++}});var h=0,k="";$.each(gamedata.known_recipes,function(l,p){all_available_cards[l].recipe!=void 0&&all_available_cards[l].recipe[a]!=void 0&&(h++,h<900&&(p=parse_card(l),k+="<span onclick=\"show_card_recipe('"+l+"')\">"+p+"</span>"))});h>0&&(b+='<div class="craftable_with_this">',b=h>800?b+('<div class="craftable_with_this_title">This card can be used to craft these and '+(h-8)+" more:</div>"):b+'<div class="craftable_with_this_title">This card can be used to craft:</div>',
b+=k,b+="</div>");$(".craft_container").html(b);$(".carft_back_button").show();$(".craft_home_button").hide();all_available_cards[a].recipe==void 0&&show_content("craft")}function swap_hero_preview(){$(".recipe_result").hasClass("active")?($(".recipe_result").removeClass("active"),$(".recipe_hero_result").addClass("active")):($(".recipe_result").addClass("active"),$(".recipe_hero_result").removeClass("active"))}
function craft_current_card(){var a=current_craft;if(all_available_cards[a]!=void 0){var b=!0;$.each(all_available_cards[a].recipe,function(c,e){if(gamedata.owned_cards[c]==void 0||gamedata.owned_cards[c]<e)b=!1});b==1&&($.each(all_available_cards[a].recipe,function(c,e){gamedata.owned_cards[c]-=e}),gain_card(a),check_quests("craft_card_of_value",all_available_cards[a].value),show_available_cards(!1),saveToLocalStorage());show_card_recipe(a)}}
function quick_craft_current_card(){var a=current_craft;gamedata.owned_cards.peasant>=all_available_cards[a].value&&(gamedata.owned_cards.peasant-=all_available_cards[a].value,gain_card(a),check_quests("craft_card_of_value",all_available_cards[a].value),show_available_cards(!1),saveToLocalStorage(),show_card_recipe(a))}
function toggle_tinker_view_mode(){$(".tinker_view div").removeClass("active");view_tinkerable==1?($(".tinker_view .tinker_view_slider").addClass("viewing"),$(".tinker_view .select_all").addClass("active"),view_tinkerable=!1):($(".tinker_view .tinker_view_slider").removeClass("viewing"),$(".tinker_view .select_tinkerable").addClass("active"),view_tinkerable=!0);show_craft()}var current_scrap_page=1,current_shop_type="",scrap_card_amount=1;
function show_scrap(){gamedata.scraps==void 0&&(gamedata.scraps=0,saveToLocalStorage());$(".scrap_count").html("Scrap: "+gamedata.scraps);$(".scrap_container").html('<span class="no_tinker">You need '+(scrap_card_amount+6)+" or more identical cards to scrap them</span>");var a="",b=0;$.each(gamedata.owned_cards,function(c,e){e>=scrap_card_amount+6&&(all_available_cards[c].type=="creature"||all_available_cards[c].type=="structure"||all_available_cards[c].type=="spell"||all_available_cards[c].type==
"object"||all_available_cards[c].type=="artifact")&&(b++,b>current_scrap_page*12-12&&b<=current_scrap_page*12&&(e=parse_card(c,e,!1),a+='<div class="scrap_this_card_container" onclick="scrap_card(\''+c+"')\">"+e+"</div>"))});b>12?($("#content_scrap .page_selection").show(),current_scrap_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),b/12<=current_scrap_page?$(".page_selection .next_page").addClass("no_page",0):$(".page_selection .next_page").removeClass("no_page"),
$(".page_selection .page_number").html(current_scrap_page+" / "+Math.ceil(b/12))):$("#content_scrap .page_selection").hide();b>0&&Math.ceil(b/12)<current_scrap_page?(current_scrap_page=1,show_scrap()):(a!=""&&$(".scrap_container").html('<div class="tinkering_list">'+a+"</div>"),b>1?$(".scrap_all_container").show():$(".scrap_all_container").hide())}function set_scrap_page(a){current_scrap_page+=a;current_scrap_page<1&&(current_scrap_page=1);show_scrap()}
function scrap_all(){all_current_rewards={};var a=0;$.each(gamedata.owned_cards,function(b,c){if(all_available_cards[b].type=="creature"||all_available_cards[b].type=="structure"||all_available_cards[b].type=="spell"||all_available_cards[b].type=="object"||all_available_cards[b].type=="artifact")a+=scrap_card(b,!0)});current_reward_text=check_plural("You scrapped "+a+" card(s)",a);current_reward_origin="scrap";show_available_cards(!1)}
function scrap_card(a,b){var c=0;if(gamedata.owned_cards[a]>=scrap_card_amount+6){if(b==void 0||b==0)all_current_rewards={},current_reward_origin="scrap";c=gamedata.owned_cards[a]-6;gamedata.owned_cards[a]-=c;var e=all_available_cards[a].value*c/2;e=round_by_percent(Math.random()*e+e);all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:e,pickable:!1};check_quests("scrap_cards",void 0,void 0,void 0,void 0,all_available_cards[a].value,c);saveToLocalStorage();
if(b==void 0||b==0)current_reward_text=check_plural("You scrapped '"+capitalizeFirstLetter(all_available_cards[a].name)+"' "+c+" time(s)",c),show_available_cards(!1),show_content("current_rewards")}return c}
function gain_scraps(a){gamedata.scraps=parseInt(gamedata.scraps)+parseInt(a);a>1?$(".detail_overlay  .card_detail").html('<div class="big_text">You gained:<br/>'+a+" scraps</div>"):$(".detail_overlay  .card_detail").html('<div class="big_text">You gained:<br/>'+a+" scrap</div>");a>0&&check_quests("gained_scraps",void 0,void 0,void 0,void 0,void 0,a);check_quests("scraps_owned",void 0,void 0,void 0,void 0,gamedata.scraps);$(".detail_overlay").removeClass("hidden");saveToLocalStorage()}
function show_arena_shop(){show_scrap_shop("arena")}function show_raid_shop(){show_scrap_shop("raid")}function show_card_shop(){show_scrap_shop("shop")}
function show_scrap_shop(a){gamedata.scraps==void 0&&(gamedata.scraps=0,saveToLocalStorage());a==void 0&&(a="scrap");current_shop_type=a+"";$(".scrap_count").html("Scrap: "+gamedata.scraps);var b=(new Date).getMonth()+1;$(".scrap_shop_content").html("");$.each(all_offers,function(c,e){if(!(e.months_available!=void 0&&match_array_values([b],e.months_available)!=1||a!=void 0&&e.shop_type!=a)){gamedata.owned_cards[e.result]==void 0&&(gamedata.owned_cards[e.result]=0);var d="",f=parse_card(e.result,gamedata.owned_cards[e.result]),
g=!0;d+='<div class="single_building_recipe">';d+='<div class="single_building_recipe_costs">';$.each(e.costs,function(h,k){if(all_available_cards[h]!=void 0){var l=0;gamedata.owned_cards[h]!=void 0&&(l=gamedata.owned_cards[h]);l<k?(g=!1,l=parse_card(h,'<span style="color:red">'+numberWithCommas(l)+" / "+k+"</span>")):l=parse_card(h,numberWithCommas(l)+" / "+k);d+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+h+"')\">"+l+"</div>"}h=="scraps"&&(gamedata.scraps<k?(g=!1,d+=
'<div class="single_building_recipe_cost">'+parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+k+"</span>")+"</div>"):d+='<div class="single_building_recipe_cost">'+parse_card("scraps_placeholder",numberWithCommas(gamedata.scraps)+" / "+k)+"</div>")});d+="</div>";e.text!=void 0&&(d+='<div class="single_building_recipe_text">'+e.text+"</div>");d+='<div class="single_building_recipe_result" onclick="show_card_details(\''+e.result+"')\">"+f+"</div>";g==
1&&(d+='<div class="single_building_recipe_craft_button" onclick="buy_offer(\''+c+"')\">BUY</div>");d+='<div style="clear:both"></div>';d+="</div>";$(".scrap_shop_content").append(d)}})}
function buy_offer(a){if(all_available_cards[all_offers[a].result]!=void 0){var b=!0;$.each(all_offers[a].costs,function(c,e){all_available_cards[c]!=void 0&&(gamedata.owned_cards[c]==void 0||gamedata.owned_cards[c]<e)&&(b=!1);c=="scraps"&&gamedata.scraps<e&&(b=!1)});if(b==1){$.each(all_offers[a].costs,function(c,e){all_available_cards[c]!=void 0&&(gamedata.owned_cards[c]-=e);c=="scraps"&&(gamedata.scraps-=e)});for(i=0;i<all_offers[a].amount;i++)gain_card(all_offers[a].result);show_available_cards(!1);
saveToLocalStorage()}show_scrap_shop(current_shop_type)}}
function use_scraps(a){a=="all"&&(a=gamedata.scraps);a=="half"&&(a=Math.floor(gamedata.scraps/2));if(gamedata.scraps>=a){gamedata.scraps-=a;show_scrap_shop();saveToLocalStorage();current_rewards={};for(var b=0;b<3;b++){var c=get_basic_reward_card(current_rewards),e=round_by_percent(Math.random()*a*.2+a/10);current_rewards[b]={card_id:c,card_amount:e}}var d='<div class="reward_cards big_rewards"><span class="reward_title">Choose one reward</span><br/>';$.each(current_rewards,function(f,g){d+='<div onclick="gain_reward('+
f+')">'+parse_card(g.card_id,g.card_amount)+"</div>"});d+="</div>";$(".detail_overlay  .card_detail").html(d);$(".detail_overlay").removeClass("hidden");$(".detail_overlay").addClass("non_clickable")}}function buy_random_card(a){if(gamedata.scraps<a)show_content("scrap_shop");else{var b=get_random_card_based_on_value(2);b!=0&&(gamedata.scraps-=a,gain_card(b),show_card_details(b),show_content("scrap_shop"))}}var shown_achievement_options={all:!0,busy:!0,complete:!0,done:!0},logged_achieve=0;
function toggle_shown_achievements(){var a="",b=!1;$.each(shown_achievement_options,function(c,e){a==""&&(a=c+"");b==1&&(a=c+"",b=!1);c==gamedata.shown_achievements&&(b=!0)});gamedata.shown_achievements=a;show_achievements()}
function show_quests(){check_new_quests();var a=0;$(".current_quest_container").html("");$.each(gamedata.quests,function(b,c){if(all_quests[c.quest_id]==void 0)console.log("unknown quest: "+b),check_new_quests();else{a++;var e=all_quests[c.quest_id],d="";c.progress>=c.amount&&(d="complete");var f='<div class="single_quest '+d+'">';if(c.completed==void 0||c.completed==0){if(e.image!=void 0){var g="";e.image_position!=void 0&&(g="background-position:"+e.image_position+";");f+='<div class="background" style="'+
g+"background-image:url(images/"+e.image+')"></div>'}f+='<div class="progress_bar" style="width:'+(100-c.progress/c.amount*100)+'%"></div>';f+='<div class="single_quest_name">'+capitalizeFirstLetter(e.name)+"</div>";f+='<div class="single_quest_description">';d!="complete"?(f+=check_plural(e.description.split("{AMOUNT}").join(c.amount),c.amount)+"<br/>",f+="Progress: "+c.progress):f+='<div class="claim_quest_button" onclick="claim_quest('+b+')">CLAIM REWARD</div>';f+="</div>";f+='<div class="single_quest_reward_title">Reward:</div>';
f+='<div class="single_quest_reward_container">';$.each(c.rewards,function(h,k){h=="scraps"&&(f=k==1?f+('<div class="single_quest_reward">'+k+" scrap</div>"):f+('<div class="single_quest_reward">'+k+" scraps</div>"));h=="reputation"&&(f+='<div class="single_quest_reward">'+k+" reputation</div>");all_available_cards[h]!=void 0&&(f=k==1?f+('<div class="single_quest_reward">'+capitalizeFirstLetter(all_available_cards[h].name)+"</div>"):f+('<div class="single_quest_reward">'+k+" x "+all_available_cards[h].name+
"</div>"))});f+="</div>"}f+="</div>";$(".current_quest_container").append(f)}});a<6&&count_object(all_quests)>5&&show_quests()}
function show_daily_quests(){check_new_quests();var a=new Date,b=new Date;(new Date).setHours(0,0,0,0);b.setHours(24,0,0,0);$(".current_daily_quest_container").html("");$.each(gamedata.daily_quests,function(c,e){all_quests[e.quest_id]==void 0&&(console.log("unknown daily quest: "+c),check_new_quests());var d=all_quests[e.quest_id],f="",g="";e.progress>=e.amount&&(f="complete");e.completed!=0&&(g="claimed");var h='<div class="single_quest '+f+" "+g+'">';d.image!=void 0&&(g="",d.image_position!=void 0&&
(g="background-position:"+d.image_position+";"),h+='<div class="background" style="'+g+"background-image:url(images/"+d.image+')"></div>');h+='<div class="progress_bar" style="width:'+(100-e.progress/e.amount*100)+'%"></div>';h+='<div class="single_quest_name">'+capitalizeFirstLetter(d.name)+"</div>";h+='<div class="single_quest_description">';f!="complete"?(h+=check_plural(d.description.split("{AMOUNT}").join(e.amount),e.amount)+"<br/>",h+="Progress: "+e.progress):e.completed==0?h+='<div class="claim_quest_button" onclick="claim_daily_quest('+
c+')">CLAIM<br/>REWARD</div>':(h+=check_plural(d.description.split("{AMOUNT}").join(e.amount),e.amount)+"<br/>",h+='<span class="claimed_text">CLAIMED</span>');h+="</div>";h+='<div class="single_quest_reward_title">Reward:</div>';h+='<div class="single_quest_reward_container">';$.each(d.rewards,function(k,l){l*=get_upgrade_factor("summon_reward","any",!0);if(k=="scraps"){var p=Math.ceil(e.amount*l);h=p==1?h+('<div class="single_quest_reward">'+p+" scrap</div>"):h+('<div class="single_quest_reward">'+
p+" scraps</div>")}all_available_cards[k]!=void 0&&(l=Math.floor(l),h=l==1?h+('<div class="single_quest_reward">'+capitalizeFirstLetter(all_available_cards[k].name)+"</div>"):h+('<div class="single_quest_reward">'+l+" x "+capitalizeFirstLetter(all_available_cards[k].name)+"</div>"))});h+="</div>";h+="</div>";$(".current_daily_quest_container").append(h)});a=b.getTime()-a.getTime();$(".current_daily_quest_container").append('<div class="quests_reset_time">All quests will reset in: <span class="timer" data-complete-time="'+
b.getTime()+'"></span></div>');update_all_timers();a<0&&show_daily_quests()}
function check_new_quests(a){gamedata.quests==void 0&&(gamedata.quests={});gamedata.daily_quests==void 0&&(gamedata.daily_quests={});count_object(gamedata.quests);for(var b=1;b<=6;b++)if(gamedata.quests[b]==void 0){var c={};$.each(all_quests,function(h,k){var l=!0;$.each(gamedata.quests,function(p,n){h==n.quest_id&&(l=!1)});l==1&&(c[h]=!0)});if(count_object(c)>0){var e=get_random_key_from_object(c),d=Math.ceil(Math.random()*(all_quests[e].max_amount-all_quests[e].min_amount/2)*get_upgrade_factor("quest_amount",
"any",!0)+all_quests[e].min_amount/2),f=get_random_key_from_object_based_on_num_value(random_loot_drops),g=all_quests[e].reward_per_amount.scraps*d*get_upgrade_factor("summon_reward","any",!0);Math.random()<.25||all_available_cards[f].value>g/10?(f="scraps",g=Math.floor(g)):(g=Math.floor(g/all_available_cards[f].value/10),g<1&&(g=1));gamedata.quests[b]={quest_id:e,amount:d,progress:0,completed:!1,rewards:{}};gamedata.quests[b].rewards[f]=g;saveToLocalStorage()}}d=new Date;d.setHours(0,0,0,0);for(b=
1;b<=6;b++)gamedata.daily_quests[b]!=void 0&&all_quests[gamedata.daily_quests[b].quest_id]==void 0&&console.log("unknown daily quest: "+current_quest_id);for(b=1;b<=6;b++)if(gamedata.daily_quests[b]==void 0||gamedata.daily_quests[b].completed!=0&&new Date(gamedata.daily_quests[b].completed)<d)c={},$.each(all_quests,function(h,k){var l=!0;$.each(gamedata.daily_quests,function(p,n){h==n.quest_id&&(l=!1)});l==1&&(c[h]=!0)}),count_object(c)>0&&(e=get_random_key_from_object(c),gamedata.daily_quests[b]=
{quest_id:e,amount:Math.floor(Math.random()*(all_quests[e].max_amount-all_quests[e].min_amount)+all_quests[e].min_amount)*3,progress:0,completed:!1},a!=void 0&&a==1&&(f="",f+='<span class="message_title">New quest: '+all_quests[e].name+"</span>",show_message(f)),saveToLocalStorage())}var all_achievement_goals={};
function check_achievement_goals(){count_object(all_achievement_goals)==0&&($.each(all_achievements,function(a,b){b.objective!=void 0&&(typeof b.objective=="string"?(all_achievement_goals[b.objective]==void 0&&(all_achievement_goals[b.objective]={}),all_achievement_goals[b.objective].achievements==void 0&&(all_achievement_goals[b.objective].achievements={}),all_achievement_goals[b.objective].achievements[a]=!0):$.each(b.objective,function(c,e){all_achievement_goals[e]==void 0&&(all_achievement_goals[e]=
{});all_achievement_goals[e].achievements==void 0&&(all_achievement_goals[e].achievements={});all_achievement_goals[e].achievements[a]=!0}))}),$.each(all_quests,function(a,b){b.objective!=void 0&&(typeof b.objective=="string"?(all_achievement_goals[b.objective]==void 0&&(all_achievement_goals[b.objective]={}),all_achievement_goals[b.objective].quests==void 0&&(all_achievement_goals[b.objective].quests={}),all_achievement_goals[b.objective].quests[a]=!0):$.each(b.objective,function(c,e){all_achievement_goals[e]==
void 0&&(all_achievement_goals[e]={});all_achievement_goals[e].quests==void 0&&(all_achievement_goals[e].quests={});all_achievement_goals[e].quests[a]=!0}))}))}
function check_quests(a,b,c){c==void 0&&(c=1);a=[a];count_object(a)>0&&(check_achievement_goals(),check_new_quests(),$.each(a,function(e,d){all_achievement_goals[d]!=void 0&&($.each(gamedata.quests,function(f,g){all_achievement_goals[d].quests!=void 0&&all_achievement_goals[d].quests[g.quest_id]!=void 0&&g.progress<g.amount&&(g.completed==void 0||g.completed==0)&&(g.progress+=c,g.progress>=g.amount&&g.shown_message==void 0&&(g.shown_message=!0,show_message('<span class="message_title">Quest complete: '+
all_quests[g.quest_id].name+"</span>")))}),$.each(gamedata.daily_quests,function(f,g){all_achievement_goals[d].quests!=void 0&&all_achievement_goals[d].quests[g.quest_id]!=void 0&&g.progress<g.amount&&(g.completed==void 0||g.completed==0)&&(g.progress+=c,g.progress>=g.amount&&g.shown_message==void 0&&(g.shown_message=!0,show_message('<span class="message_title">Daily quest complete: '+all_quests[g.quest_id].name+"</span>")))}),$.each(all_achievements,function(f,g){var h=!1;match_array_values(g.objective,
d)&&(h=!0);match_array_values(g.objectives,d)&&(h=!0);b!=void 0&&h==1&&(g.max_amount!=void 0&&b>g.max_amount&&(h=!1),g.min_amount!=void 0&&b<g.min_amount&&(h=!1));if(h==1&&(gamedata.achievements[f]==void 0&&(gamedata.achievements[f]={amount:0,completed:!1,claimed:!1,date_completed:!1},g.objectives!=void 0&&(gamedata.achievements[f].amount={},$.each(g.objectives,function(l,p){gamedata.achievements[f].amount[p]=0}))),gamedata.achievements[f].completed==0&&gamedata.achievements[f].claimed==0)){var k=
!0;g.objectives!=void 0?(gamedata.achievements[f].amount[d]+=c,$.each(g.objectives,function(l,p){gamedata.achievements[f].amount[p]<g.amount&&(k=!1)})):(gamedata.achievements[f].amount+=c,gamedata.achievements[f].amount<g.amount&&(k=!1));k==1&&(show_message('<span class="message_title">Achievement complete: '+g.name+"</span>"),gamedata.achievements[f].completed=!0,gamedata.achievements[f].date_completed=new Date)}}))}))}
function claim_quest(a){if(gamedata.quests[a]!=void 0&&gamedata.quests[a].amount<=gamedata.quests[a].progress){var b=gamedata.quests[a];all_current_rewards={};current_reward_origin="quests";current_reward_text='For completing the quest <b>"'+capitalizeFirstLetter(all_quests[b.quest_id].name)+'"</b><br/>You have been rewarded with:<br/>';$.each(b.rewards,function(c,e){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:c,reward_amount:e}});delete gamedata.quests[a];saveToLocalStorage();
show_content("current_rewards")}}
function claim_daily_quest(a){if(gamedata.daily_quests[a]!=void 0&&gamedata.daily_quests[a].amount<=gamedata.daily_quests[a].progress&&gamedata.daily_quests[a].completed==0){var b=gamedata.daily_quests[a];all_current_rewards={};current_reward_origin="daily_quests";current_reward_text='For completing the daily quest <b>"'+capitalizeFirstLetter(all_quests[b.quest_id].name)+'"</b><br/>You have been rewarded with:<br/>';$.each(all_quests[b.quest_id].rewards,function(c,e){e=Math.floor(e*get_upgrade_factor("summon_reward",
"any",!0));all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:c,reward_amount:e}});gamedata.daily_quests[a].completed=new Date;saveToLocalStorage();show_content("current_rewards")}}
function check_quest_complete_count(){show_daily_reward();gamedata.quests!=void 0&&gamedata.daily_quests!=void 0||check_new_quests();count_object(gamedata.quests)<6&&check_new_quests();var a=0,b=0,c=0;$.each(gamedata.quests,function(d,f){f.progress>=f.amount&&a++});$.each(gamedata.daily_quests,function(d,f){f.progress>=f.amount&&f.completed==0&&b++});$.each(gamedata.stories,function(d,f){f.completed==1&&f.claimed==0&&c++});var e=0;$.each(gamedata.achievements,function(d,f){all_achievements[d]==void 0?
console.log("unknown achievement: "+d):f.completed==1&&f.claimed==0&&e++});e==0?$(".achievements_page_button").html(""):$(".achievements_page_button").html("&nbsp;!");a==0?$(".quests_page_button").html(""):$(".quests_page_button").html("&nbsp;!");c==0?$(".stories_page_button").html(""):$(".stories_page_button").html("&nbsp;!");daily_reward_claimable==0?$(".daily_reward_available").html(""):$(".daily_reward_available").html("&nbsp;!");e>0||a>0||daily_reward_claimable==1||b>0||c>0?($(".quest_button_complete_count").html("&nbsp;!"),
$(".quest_complete_count").html("!"),$(".quest_complete_count").removeClass("hidden")):($(".quest_complete_count").html(""),$(".quest_complete_count").addClass("hidden"),$(".quest_button_complete_count").html(""));b>0?($(".daily_quests_page_button").html("&nbsp;!"),$(".daily_quests_complete").html("("+b+")")):$(".daily_quests_page_button").html("");return a+b}var current_achievements_page=1,achievements_per_page=25;
function show_achievements(){gamedata.shown_achievements==void 0&&(gamedata.shown_achievements="all");$(".achievement_options_button").html(gamedata.shown_achievements);var a=0;gamedata.achievements==void 0&&(gamedata.achievements={});$(".achievements_container").html("");$(".achievement_details").html('<span class="no_achievement_text">Select an achievement to view it\'s details.</span>');var b="";$.each(all_achievements,function(c,e){var d="";gamedata.achievements[c]!=void 0&&gamedata.achievements[c].completed==
1&&(d=" completed");var f="";gamedata.achievements[c]!=void 0&&gamedata.achievements[c].claimed==1&&(f=" claimed");var g=!0;$.each(e.needs_completed,function(n,q){if(gamedata.achievements[n]==void 0||gamedata.achievements[n].completed==0)g=!1});gamedata.shown_achievements!="complete"||d!=""&&f==""||(g=!1);gamedata.shown_achievements=="done"&&f==""&&(g=!1);gamedata.shown_achievements!="busy"||f==""&&d==""||(g=!1);if(g==1){var h='<div class="single_achievement_container"><div class="achievement achievement_'+
(c+" "+d+f+'" onclick="show_achievements_details(\''+c+'\')"><div class="achievement_image" style="background-image:url(images/')+(e.image+");background-position:"+e.image_position+'"></div>');if(gamedata.achievements[c]==void 0||gamedata.achievements[c].completed!=1){var k=100;if(gamedata.achievements[c]!=void 0)if(typeof gamedata.achievements[c].amount=="object"){var l=0,p=0;$.each(gamedata.achievements[c].amount,function(n,q){q>e.amount&&(q=e.amount);l+=q;p++});k=100-Math.floor(l/(e.amount*p)*
100)}else k=100-Math.floor(gamedata.achievements[c].amount/e.amount*100);h+='<div class="achievement_progress_bar" style="width:'+k+'%"></div>'}h+="</div></div>";d!=""&&f==""&&(b+=h);a++;a/achievements_per_page>current_achievements_page-1&&a/achievements_per_page<=current_achievements_page&&$(".achievements_container").append(h)}});current_achievements_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");a/achievements_per_page<=
current_achievements_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");a>0&&Math.ceil(a/achievements_per_page)<current_achievements_page?(current_achievements_page=1,show_achievements()):(a==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_achievements_page+" / "+Math.ceil(a/achievements_per_page)),b!=""?$(".claim_all_container").show():
$(".claim_all_container").hide())}function set_achievements_page(a){current_achievements_page+=a;current_achievements_page<1&&(current_achievements_page=1);show_achievements()}
function show_achievements_details(a){$(".achievement_details").html("");var b=all_achievements[a],c="";gamedata.achievements[a]!=void 0&&gamedata.achievements[a].completed==1&&(c=" completed");var e="";gamedata.achievements[a]!=void 0&&gamedata.achievements[a].claimed==1&&(e=" claimed");var d="";b.image_position!=void 0&&(d=";background-position:"+b.image_position);d='<div class="achievement_image" style="background-image:url(images/'+b.image+")"+d+'"></div>';d+='<div class="achievement_title">'+
capitalizeFirstLetter(b.name)+"</div>";if(c!=""||b.hide_details==void 0&&b.hide_details!=0){var f=0;gamedata.achievements[a]!=void 0&&gamedata.achievements[a].amount!=void 0&&(f=gamedata.achievements[a].amount);d+='<div class="achievement_description">'+b.description+"<br/><br/>";c!=""||b.hide_amount!=void 0&&b.hide_amount!=0||(d+="Progress: "+numberWithCommas(f)+" / "+numberWithCommas(b.amount)+"<br/>");d+="</div>"}else d+='<div class="achievement_description">???</div>';c!=""&&e!=""&&(b=new Date(gamedata.achievements[a].date_completed),
f=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),b.getHours(),b.getMinutes(),b.getSeconds(),d+='<div class="completed_on">Completed on: '+f+"</div>");c!=""&&e==""&&(d+='<div class="achievement_claim_button" onclick="claim_achievement(\''+a+"')\">CLAIM</div>");$(".achievement_details").html(d);$(".claim_all_container").hide()}
function open_achievement(a){$(".achievement").not(".achievement_"+a).removeClass("open");$(".achievement_"+a).hasClass("open")?$(".achievement_"+a).removeClass("open"):$(".achievement_"+a).addClass("open")}
function claim_all_achievements(){all_current_rewards={};var a=0;$.each(gamedata.achievements,function(b,c){b=all_achievements[b];c.completed==1&&c.claimed==0&&(a++,c.claimed=!0,$.each(b.rewards,function(e,d){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d.reward_id,reward_amount:d.reward_amount}}))});count_object(all_current_rewards)>0&&(current_reward_origin="achievements",current_reward_text=check_plural("For completing "+a+" achievement(s)<br/>You have been rewarded with:<br/>",
a),saveToLocalStorage())}function claim_achievement(a){var b=all_achievements[a];a=gamedata.achievements[a];a.completed==1&&a.claimed==0&&(a.claimed=!0,all_current_rewards=b.rewards,current_reward_origin="achievements",current_reward_text='For completing the achievement <b>"'+capitalizeFirstLetter(b.name)+'"</b><br/>You have been rewarded with:<br/>',saveToLocalStorage(),show_content("current_rewards"))}
function get_completed_achievement_count(){var a=0;$.each(gamedata.achievements,function(b,c){c.completed==1&&a++});return a}function complete_random_daily(){var a={};$.each(gamedata.daily_quests,function(c,e){e.completed==0&&e.progress<e.amount&&(a[c]=!0)});if(count_object(a)>0){var b=get_random_key_from_object(a);console.log("ding");gamedata.daily_quests[b].progress=gamedata.daily_quests[b].amount;saveToLocalStorage();show_daily_quests();check_quest_complete_count();return!0}return!1}
function reset_daily_quests(){delete gamedata.daily_quests;show_daily_quests();check_quest_complete_count()}function reset_radnom_daily_quest(){var a={};$.each(gamedata.daily_quests,function(c,e){e.completed!=0&&(a[c]=!0)});if(count_object(a)>0){var b=get_random_key_from_object(a);delete gamedata.daily_quests[b];check_new_quests(!0);return!0}return!1}
function reset_achievements(){gamedata.achievements!=void 0&&$.each(all_achievements,function(a,b){gamedata.achievements[a]!=void 0&&gamedata.achievements[a].completed==1||gamedata.achievements[a]==void 0||b.reset_if_incomplete==void 0||b.reset_if_incomplete!=1||(gamedata.achievements[a].amount=0,b.objectives!=void 0&&(gamedata.achievements[a].amount={},$.each(b.objectives,function(c,e){gamedata.achievements[a].amount[e]=0})))})}
function show_arena(){$(".current_arena_container").html('<div class="loading_arena">Loading arena</div>');$(".refresh_button").addClass("hidden");get_fightable_arena_decks()}function show_echoes(){$(".current_arena_container").html('<div class="loading_arena">Loading arena</div>');$(".refresh_button").addClass("hidden");get_fightable_echo_decks()}
function show_arena_decks(){$(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading your decks</div>');get_owned_arena_decks()}function get_owned_arena_decks(){$.post("ajax.php",{data:"get_owned_arena_decks",current_id:gamedata.account_id},function(a){all_owned_decks=JSON.parse(a);parse_owned_decks(all_owned_decks)})}
function parse_owned_decks(a){gamedata.arena_decks_owned==void 0&&(gamedata.arena_decks_owned=!1);for(var b="",c=1;c<=5;c++){b+='<div class="owned_deck_container">';var e=!1,d=0,f=0,g=!1;$.each(a,function(h,k){if(k.deck_id==c){if(calculate_scrap_reward(k.wins,k.losses)<2||k.losses>9)g=!0;d=k.unclaimed;f=k.id;k.deck_content=JSON.parse(k.deck_content);k.deck_content.hero!=void 0&&(b+='<div class="owned_deck owned_deck_'+c+'">',b+='<div class="background" style="background-image:url(images/'+all_available_cards[k.deck_content.hero].image+
')"></div>',b+="<span>"+capitalizeFirstLetter(all_available_cards[k.deck_content.hero].name)+"</span>",b+='<div class="wins_losses">Rank '+(parseInt(k.rank)+1)+"<br/>Battles: "+k.wins+"<br/>Losses: "+k.losses,b=k.unclaimed>0?b+("<br/><br/>Scraps won: "+k.unclaimed*2):b+"<br/><br/><br/>",b+="</div>",b+='<div class="arena_deck_content">',$.each(k.deck_content,function(l,p){l!="hero"&&all_available_cards[l]!=void 0&&(b+='<div class="arena_deck_content_line">',b+=p+" "+all_available_cards[l].name,b+=
"</div>")}),b+="</div>",g==1&&(b+='<div class="arena_deck_broken">BROKEN</div>'),b+="</div>",e=!0,gamedata.arena_decks_owned=!0)}});e==0&&(b+='<div class="owned_deck empty_deck owned_deck_'+c+'">EMPTY</div>');b=g==1?b+('<div class="replace_deck_button replace_now" onclick="replace_deck('+c+')">REPLACE</div>'):b+('<div class="replace_deck_button" onclick="replace_deck('+c+')">REPLACE</div>');e==1&&d>0&&f>0&&(b+='<div class="replace_deck_button" onclick="claim_deck('+f+')">CLAIM</div>');b+="</div>"}count_object(a)>
0||gamedata.arena_decks_owned==0?(saveToLocalStorage(),$(".current_arena_decks_container").html(b)):$(".current_arena_decks_container").html('<div class="loading_arena_decks">Failed to load your decks<br/>Please try again later.</div>')}
function parse_single_fightable_deck(a){var b=JSON.parse(a.deck_content);$(".current_arena_container").html("");var c="";b.hero!=void 0&&(c+='<div class="single_enemy_deck">',c+='<div class="background" style="background-image:url(images/'+all_available_cards[b.hero].image+')"></div>',c+="<span>"+capitalizeFirstLetter(all_available_cards[b.hero].name)+"<br/><i>"+a.name+"</i></span>",c+='<div class="wins_losses">Rank '+(parseInt(a.rank)+1)+"<br/>"+a.wins+" battles<br/>"+a.losses+" losses",c+="</div>",
c+="</div>",gamedata.scraps>0&&(c+='<div class="fight_single_deck_button" onclick="fight_deck('+a.id+')">FIGHT</div>'),c+='<div class="single_arena_deck_content">',$.each(b,function(e,d){if(e!="hero"&&all_available_cards[e]!=void 0){var f=parse_card(e,d);c+='<div class="single_arena_deck_card">';c+="<div onclick=\"show_card_details('"+e+"',undefined,"+d+')">'+f+"</div>";c+="</div>"}}),c+="</div>");$(".current_arena_container").html(c)}
function replace_deck(a){gamedata.decks[gamedata.current_deck].hero!=void 0&&($(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading your decks</div>'),$.post("ajax.php",{data:"replace_deck",current_id:gamedata.account_id,deck_id:a,deck:JSON.stringify(gamedata.decks[gamedata.current_deck]),card_back:gamedata.hand_card_back},function(b){console.log(b);get_owned_arena_decks()}))}
function upload_new_king_of_the_hill(){gamedata.decks[gamedata.current_deck].hero!=void 0&&$.post("ajax.php",{data:"upload_new_king_of_the_hill",current_id:gamedata.account_id,deck:JSON.stringify(gamedata.decks[gamedata.current_deck])},function(a){console.log(a)})}
function show_single_arena_enemy(a){$(".current_arena_container").html('<div class="loading_arena_decks">Loading enemy deck.</div>');$("#content_arena .menu_button.slim").addClass("hidden");$("#content_arena .menu_button.slim.refresh_button").removeClass("hidden");$.post("ajax.php",{data:"get_deck",deck_id:a},function(b){count_object(JSON.parse(b))>0?(all_fightable_decks=JSON.parse(b),parse_single_fightable_deck(all_fightable_decks)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load enemy.<br/>Please try again later.</div>'),
$(".refresh_button").removeClass("hidden"),setTimeout(function(){get_fightable_arena_decks()},500))})}
function get_fightable_arena_decks(){$.post("ajax.php",{data:"get_fightable_arena_decks",current_id:gamedata.account_id},function(a){count_object(JSON.parse(a))>0?(all_fightable_decks=JSON.parse(a),parse_fightable_decks(all_fightable_decks)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load arena.<br/>Please try again later.</div>'),$(".refresh_button").removeClass("hidden"),console.log("failed"),setTimeout(function(){},500))})}
function get_fightable_echo_decks(){$.post("ajax.php",{data:"get_fightable_echo_decks",current_id:gamedata.account_id},function(a){count_object(JSON.parse(a))>0?(all_fightable_decks=JSON.parse(a),parse_fightable_decks(all_fightable_decks)):($(".current_arena_container").html('<div class="loading_arena_decks">Failed to load arena.<br/>Please try again later.</div>'),$(".refresh_button").removeClass("hidden"),console.log("failed"),setTimeout(function(){},500))})}
function parse_fightable_decks(a){$("#content_arena .menu_button.slim").removeClass("hidden");var b="";gamedata.scraps==void 0&&(gamedata.scraps=0,saveToLocalStorage());var c=0,e=0;gamedata.wins_today==void 0&&(gamedata.wins_today=0);gamedata.wins_today!=void 0&&(e=gamedata.wins_today);e>20&&(e=20);$.each(a,function(d,f){c++;b+='<div class="fightable_deck_container">';f.deck_content=JSON.parse(f.deck_content);f.deck_content.hero!=void 0&&(b=f.user_id!=gamedata.account_id&&c<11-e/4?b+('<div class="fightable_deck owned_deck_'+
f.id+' fightable" onclick="fight_deck('+f.id+')">'):b+('<div class="fightable_deck owned_deck_'+f.id+' not_fightable">'),b+='<div class="background" style="background-image:url(images/'+all_available_cards[f.deck_content.hero].image+')"></div>',b=f.deck_id==6?b+("<span>"+capitalizeFirstLetter(all_available_cards[f.deck_content.hero].name)+"<br/><i>"+f.name+"'s echo</i></span>"):b+("<span>"+capitalizeFirstLetter(all_available_cards[f.deck_content.hero].name)+"<br/><i>"+f.name+"</i></span>"),b+='<div class="wins_losses">Rank '+
(parseInt(f.rank)+1)+": "+f.wins+" / "+f.losses,d=calculate_scrap_reward(f.wins,f.losses),b=d==1?b+("<br/>Bounty: "+d+" scrap"):b+("<br/>Bounty: "+d+" scraps"),b+="<br/>Battle cost: 1 scrap",b+="</div>",b+="</div>",deck_found=!0);b+="</div>"});b+='<div class="arena_cost_description">Defeating an enemy rewards the bounty and additional loot.<br/>You currently have '+numberWithCommas(gamedata.scraps)+" scraps<br/>You have won "+gamedata.wins_today+" battles today</div>";$(".current_arena_container").html(b);
$(".refresh_button").removeClass("hidden")}
function fight_deck(a){$(".current_arena_container").html('<div class="loading_arena">Loading battle</div>');arena_deck_id=a;$.post("ajax.php",{data:"get_deck",deck_id:a},function(b){current_deck=JSON.parse(b);b=JSON.parse(current_deck.deck_content);b.hero!=void 0&&gamedata.scraps>0?(--gamedata.scraps,saveToLocalStorage(),arena_reward_amount=calculate_scrap_reward(current_deck.wins,current_deck.losses),arena_card_back=current_deck.card_back,current_deck.deck_id==6?show_arena_battle(b,current_deck.name+
"'s echo"):show_arena_battle(b,current_deck.name)):show_arena()})}
function fight_king_of_the_hill(a){gamedata.last_king_fight=new Date;$(".current_king_of_the_hill_container").html('<div class="loading_arena">Loading battle</div>');$(".recent_kings_container").html("");$(".king_rewards_container").html("");arena_deck_id=a;$.post("ajax.php",{data:"get_deck",deck_id:a},function(b){current_deck=JSON.parse(b);arena_reward_amount=calculate_scrap_reward(current_deck.wins,current_deck.losses);show_king_of_the_hill_battle(JSON.parse(current_deck.deck_content),current_deck.name,
current_deck.wins)})}
function claim_deck(a){$(".current_arena_decks_container").html('<div class="loading_arena_decks">Loading rewards</div>');$.post("ajax.php",{data:"claim_deck",deck_id:a},function(b){b>0?(current_reward_origin="arena_decks",current_reward_text="You got some prizes in the arena",all_current_rewards={0:{reward_id:"scraps",reward_amount:b*2}},Math.random()*20<b&&(all_current_rewards[1]={reward_id:"arena_shard",reward_amount:1}),show_content("current_rewards")):show_arena_decks()})}
function calculate_scrap_reward(a,b){a=Math.floor(parseInt(a)+1-(parseInt(b)+1)+5);a<2&&(a=2);return a}function get_king_of_the_hill(){$.post("ajax.php",{data:"king_of_the_hill"},function(a){parse_king_of_the_hill(JSON.parse(a))})}function get_recent_kings(){$.post("ajax.php",{data:"get_recent_kings"},function(a){parse_recent_kings(JSON.parse(a))})}
function get_king_rewards(){$.post("ajax.php",{data:"get_king_rewards",current_id:gamedata.account_id},function(a){parse_king_rewards(parseInt(JSON.parse(a)))})}function show_king_of_the_hill(){$(".current_king_of_the_hill_container").html('<div class="loading_king_of_the_hill">Loading king of the hill</div>');$(".recent_kings_container").html("");$(".king_rewards_container").html("");get_king_of_the_hill();get_recent_kings();get_king_rewards()}
function parse_king_of_the_hill(a){var b="";gamedata.last_king_fight==void 0&&(gamedata.last_king_fight=new Date);if(a!=null){b+='<div class="fightable_deck_container">';a.deck_content=JSON.parse(a.deck_content);if(a.deck_content.hero!=void 0&&(b=a.user_id!=gamedata.account_id?b+('<div class="fightable_deck owned_deck_'+a.id+'" onclick="fight_deck('+a.id+')">'):b+('<div class="fightable_deck owned_deck_'+a.id+'">'),b+='<div class="background" style="background-image:url(images/'+all_available_cards[a.deck_content.hero].image+
')"></div>',b+="<span>"+capitalizeFirstLetter(all_available_cards[a.deck_content.hero].name)+"<br/><i>"+a.name+"</i></span>",b+='<div class="wins_losses">Battles: '+a.wins,b+="</div></div>",a.user_id!=gamedata.account_id)){var c=king_battle_timeout-((new Date).getTime()-(new Date(gamedata.last_king_fight)).getTime())/1E3,e=(new Date).getTime()+c*1E3;b=c<=0?b+('<div class="fight_deck_button" onclick="fight_king_of_the_hill('+a.id+')">FIGHT</div>'):b+('<div class="fight_deck_button timer" data-complete-time='+
e+' data-complete-function="show_king_of_the_hill">'+toHHMMSS(c)+"</div>")}b+="</div>"}else b+='<div class="fightable_deck_container"><button class="menu_button king_of_the_hill_button" data-target-content="king_of_the_hill">RELOAD</button></div>';$(".current_king_of_the_hill_container").html(b)}
function parse_recent_kings(a){var b="Recent kings";$.each(a,function(c,e){b+='<div class="single_king">';b+='<span class="king_name">'+e.name+"</span><br/>";b+="Battles: "+e.wins;b+="</div>"});$(".recent_kings_container").html(b)}
function parse_king_rewards(a){var b="<span>Gain 25 scraps and 5 arena shards for taking the hill.<br/><br/>Gain 10 scraps for every defensive battle on the hill.</span>";a>0&&(b="<span>Current rewards:</span><br/>"+(a*10+' scraps<div class="claim_king_button" onclick="claim_king()">CLAIM</div>'));$(".king_rewards_container").html(b)}
function claim_king(){$.post("ajax.php",{data:"claim_king_rewards",current_id:gamedata.account_id},function(a){gain_scraps(parseInt(JSON.parse(a))*10);show_king_of_the_hill()})}
var new_building_id=0,current_fragment_page=1,current_construction="",all_current_rewards={},current_reward_origin="",current_reward_text="",base_building_cost=4,building_scraps_cost=10,storage_maxed=0,town_production_stored=0,town_max_storage=0,do_no_apply_factions=!1,current_adventure="",current_adventure_units={},suggest_mode="all",owned_buildings_fragments={};
function toggle_suggest_mode(){$(".suggest_view div").removeClass("active");suggest_mode=="matched"?($(".suggest_view .suggest_slider").addClass("all"),$(".suggest_view .suggest_all").addClass("active"),suggest_mode="all"):($(".suggest_view .suggest_slider").removeClass("all"),$(".suggest_view .suggest_matched").addClass("active"),suggest_mode="matched");show_adventure_units()}
function check_owned_buildings(){owned_buildings_fragments={};$.each(gamedata.town,function(a,b){owned_buildings_fragments[all_buildings[b.building_id].fragment_id]==void 0&&(owned_buildings_fragments[all_buildings[b.building_id].fragment_id]={building_id:b.building_id,building_level:b.level})});console.log(owned_buildings_fragments)}
function show_town(){$(".town_content").html("");var a="",b=(new Date).getTime();gamedata.town==void 0&&(gamedata.town={},saveToLocalStorage());gamedata.max_buildings==void 0&&(gamedata.max_buildings=get_highest_key_in_object(gamedata.town),saveToLocalStorage());town_max_storage=town_production_stored=storage_maxed=0;$.each(all_buildings,function(c,e){var d=!0;$.each(e.needed_upgrades,function(q,m){if(gamedata.upgrades==void 0||gamedata.upgrades[q]==void 0||gamedata.upgrades[q]<m)d=!1});if(d==1){gamedata.town[c]==
void 0&&(gamedata.town[c]={building_id:c,level:1},saveToLocalStorage());a+='<div class="building" onclick="current_building_id=\''+c+"';show_content('single_building')\">";a+='<div class="background" style="background-image:url(images/'+e.image+')"></div>';a+="<span>"+capitalizeFirstLetter(e.name)+"</span>";a+='<span class="current_status">';var f=0,g=0,h=0;if(gamedata.town[c]!=void 0){gamedata.town[c].level==void 0&&(gamedata.town[c].level=1);h=gamedata.town[c].level+0;var k=0;$.each(gamedata.town[c].expeditions,
function(q,m){--h;m.done_time<=b&&(g+=1);m.done_time>b&&(f+=1,k==0||k>m.done_time)&&(k=m.done_time)});$.each(gamedata.town[c].adventures,function(q,m){--h;m.done_time<=b&&(g+=1);m.done_time>b&&(f+=1,k==0||k>m.done_time)&&(k=m.done_time)});if(gamedata.town[c].adventures!=void 0||gamedata.town[c].expeditions!=void 0)f>0&&(a+='<br/><span class="timer" data-complete-time='+k+"></span>"),g>0&&(a+='<br/><b><span style="color:#afa">DONE</span></b>'),h>0&&g==0&&f==0&&(a+="<br/>Idle");if(gamedata.town[c]!=
void 0&&e.type=="shop"){var l=0;$.each(gamedata.town[c].current_offers,function(q,m){(m.sold==void 0||new Date(m.offer_expires)<new Date)&&l++});l>0&&(a+="<br/>Offer available")}var p=0,n=0;gamedata.town[c]!=void 0&&gamedata.town[c].productions!=void 0&&e.productions!=void 0&&$.each(e.productions,function(q,m){if(gamedata.town[c].productions[q]!=void 0&&(gamedata.town[c].productions[q].production_id==void 0||gamedata.town[c].productions[q].production_id!=0)){gamedata.town[c].productions[q].speed_level==
void 0&&(gamedata.town[c].productions[q].speed_level=1);gamedata.town[c].productions[q].storage_level==void 0&&(gamedata.town[c].productions[q].storage_level=1);var r=gamedata.town[c].productions[q];m=e.productions[q];q=calculate_production_speed(r.speed_level,m.base_time,m.defeated_heroes_speed_bonusses,m.production_achievement_bonus,gamedata.town[c].level);var t=((new Date).getTime()-r.last_claimed)/1E3;m=calculate_production_storage(r.storage_level,m.base_storage,m.defeated_heroes_speed_bonusses,
gamedata.town[c].level);r=Math.floor(t/q);r>m&&(r=m);p+=r;n+=m;town_production_stored+=r;town_max_storage+=m}});n>0&&(p>=n?(a+='<br/><span style="color:#f00"><b>STORAGE FULL</b></span>',storage_maxed++):a=p>0?a+('<br/><span style="color:#afa">Storage: '+nFormatter(p,2)+" / "+nFormatter(n,2)+"</span>"):a+("<br/>Storage: 0 / "+n))}a+="</span>";a+="</div>"}});$(".town_content").html(a);count_object(gamedata.town)==1?($.each(gamedata.town,function(c,e){current_building_id=c}),last_content=="single_building"?
show_content("home"):show_content("single_building")):update_all_timers()}function calculate_production_speed(a,b,c,e,d){var f=1;$.each(c,function(g,h){gamedata.defeated_heroes!=void 0&&gamedata.defeated_heroes[g]!=void 0&&(f+=gamedata.defeated_heroes[g]*h)});e!=void 0&&(c=1+get_completed_achievement_count()*e,f*=c);return Math.ceil(b/((1+sqr(a)/20)*f*d))}function calculate_production_speed_cost(a,b){return Math.ceil(b*(1+sqr(sqr(a))/50))}
function calculate_production_storage(a,b,c,e){var d=1;$.each(c,function(f,g){gamedata.defeated_heroes!=void 0&&gamedata.defeated_heroes[f]!=void 0&&(d+=gamedata.defeated_heroes[f]*g)});return Math.floor(b*(1+sqr(a)/20)*d*e)}function calculate_new_building_slot_cost(){for(var a=10,b=0;b<=gamedata.max_buildings;b++)a*=2.5;return Math.floor(a/10)*10}
function buy_new_building_slot(){var a=calculate_new_building_slot_cost();gamedata.scraps>=a&&(gamedata.scraps-=a,gamedata.max_buildings+=1,saveToLocalStorage());show_content("town")}
function show_new_buildings(){cards_per_page=12;$("#content_new_buildings .new_buildings_list").html('<span class="no_tinker">You have no fragments.<br/>You can find them in battles.</span>');gamedata.owned_cards=sortObj(gamedata.owned_cards);var a=0;$.each(all_buildings,function(b,c){var e=0;gamedata.owned_cards[c.fragment_id]!=void 0&&(e=gamedata.owned_cards[c.fragment_id]+0);a++;a==1&&$("#content_new_buildings .new_buildings_list").html("");a/cards_per_page>current_fragment_page-1&&a/cards_per_page<=
current_fragment_page&&(c=parse_card(c.fragment_id,e),gamedata.town[new_building_id]==void 0&&(e<base_building_cost?$("#content_new_buildings .new_buildings_list").append('<div class="fragment faded" onclick="show_construct_building(\''+b+"')\">"+c+"</div>"):$("#content_new_buildings .new_buildings_list").append('<div class="fragment" onclick="show_construct_building(\''+b+"')\">"+c+"</div>")))});current_fragment_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");
a/cards_per_page<=current_fragment_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");a>0&&Math.ceil(a/cards_per_page)<current_fragment_page&&(current_fragment_page=1,show_new_buildings());a==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page");$(".page_selection .page_number").html(current_fragment_page+" / "+Math.ceil(a/cards_per_page))}
function set_fragments_page(a){current_fragment_page+=a;current_fragment_page<1&&(current_fragment_page=1);show_new_buildings()}function show_construct_building(a){current_construction="";all_buildings[a]!=void 0&&(current_construction=a);current_construction!=""&&show_content("construction")}
function show_construction(){if(current_construction==""||all_buildings[current_construction]==void 0)show_content("town");else{var a=all_buildings[current_construction];$(".construction_content").html("");var b=0;gamedata.owned_cards[a.fragment_id]!=void 0&&(b=gamedata.owned_cards[a.fragment_id]);var c=parse_card(a.fragment_id,b+" / "+base_building_cost);b<base_building_cost&&(c=parse_card(a.fragment_id,'<span style="color:red">'+b+" / "+base_building_cost+"</span>"));c=gamedata.scraps<base_building_cost*
building_scraps_cost?c+parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(base_building_cost*building_scraps_cost)+"</span>"):c+parse_card("scraps_placeholder",""+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(base_building_cost*building_scraps_cost));$(".construction_content").append('<div class="construction_name">'+capitalizeFirstLetter(a.name)+"</div>");gamedata.owned_cards[a.fragment_id]<base_building_cost||gamedata.scraps<
base_building_cost*building_scraps_cost?$(".construction_content").append('<div class="construction_description">'+capitalizeFirstLetter(a.description)+"</div>"):($(".construction_content").append('<div class="construction_description">'+capitalizeFirstLetter(a.description)+"</div>"),$(".construction_content").append('<div onclick="construct_current_building()" class="construction_button">BUILD</div>'));$(".construction_content").append('<div class="fragment_cost">'+c+'<div style="clear:both"></div></div>')}}
function construct_current_building(){if(current_construction!=""&&all_buildings[current_construction]!=void 0&&gamedata.town[new_building_id]==void 0){var a=all_buildings[current_construction];gamedata.owned_cards[a.fragment_id]>=base_building_cost&&gamedata.scraps>=base_building_cost*building_scraps_cost&&(gamedata.owned_cards[a.fragment_id]-=base_building_cost,gamedata.scraps-=base_building_cost*building_scraps_cost,gamedata.town[new_building_id]={building_id:current_construction,level:1},saveToLocalStorage())}current_building_id=
new_building_id;show_content("single_building")}
function upgrade_current_building(){if(current_building_id!=void 0){var a=all_buildings[gamedata.town[current_building_id].building_id],b=calculate_upgrade_cost(gamedata.town[current_building_id].level);gamedata.owned_cards[a.fragment_id]>=b&&gamedata.scraps>=b*building_scraps_cost&&(gamedata.owned_cards[a.fragment_id]-=b,gamedata.scraps-=b*building_scraps_cost,gamedata.town[current_building_id].level+=1,saveToLocalStorage())}show_content("single_building")}
function show_single_building(){if(gamedata.town[current_building_id]==void 0)show_content("town");else{$(".new_expedition_button").remove();$(".building_recipes_button").remove();var a="",b=gamedata.town[current_building_id],c=all_buildings[b.building_id],e=b.level;$(".building_bg").css("background-image","url(images/"+c.image+")");$("#content_single_building h2").html(capitalizeFirstLetter(c.name));$(".upgrade_building_button").removeClass("click_me");e=calculate_upgrade_cost(e);gamedata.owned_cards[c.fragment_id]>=
e&&gamedata.scraps>=e*building_scraps_cost&&$(".upgrade_building_button").addClass("click_me");if(c.productions!=void 0){var d=!1;b.productions==void 0&&(b.productions={});count_object(c.productions)>1&&(a+='<div class="claim_all_production_button" onclick="claim_all_production()">CLAIM ALL</div>');$.each(c.productions,function(f,g){b.productions[f]==void 0&&g.unlock_cost==void 0&&(b.productions[f]={level:1,speed_level:1,storage_level:1,last_claimed:(new Date).getTime()},g.production_pickable!=void 0&&
g.production_pickable==1&&(b.productions[f].production_id=!1),saveToLocalStorage());if(b.productions[f]!=void 0){var h=b.productions[f];g=c.productions[f];var k=calculate_production_speed(h.speed_level,g.base_time,g.defeated_heroes_speed_bonusses,g.production_achievement_bonus,b.level),l=((new Date).getTime()-h.last_claimed)/1E3,p=Math.floor(l/k),n=calculate_production_storage(h.storage_level,g.base_storage,g.defeated_heroes_speed_bonusses,b.level),q=Math.floor(l/k);q>n&&(q=n);l=(new Date).getTime()+
(k-(l-k*p))*1E3;var m="";m+='<div class="single_expedition production_bar">';var r="";all_available_cards[f]!=void 0&&(r=f);f=="scraps"&&(r="scraps_placeholder");if(all_available_cards[f]!=void 0||b.productions[f].production_id!=void 0&&b.productions[f].production_id!=0){var t=f;b.productions[f].production_id!=void 0&&b.productions[f].production_id!=0&&all_available_cards[b.productions[f].production_id]!=void 0&&(r=t=b.productions[f].production_id);m+='<span class="single_new_expedition_name">'+capitalizeFirstLetter(all_available_cards[r].name)+
"<br/></span>";r=parse_card(r);m+="<span onclick=\"claim_production('"+f+"')\">"+r+"</span>";m+="<div onclick=\"claim_production('"+f+'\')" class="production_time">'+toHHMMSS(k)+"</div>";p<n&&(m+="<div onclick=\"claim_production('"+f+'\')" class="production_time_left timer" data-complete-time='+l+' data-complete-function="show_single_building"></div>');m+="<div onclick=\"claim_production('"+f+'\')" class="production_storage_container">';m+='<div class="production_storage_bar" style="width:'+Math.floor(q/
n*100)+'%"></div>';m+='<div class="production_storage_amount">'+nFormatter(q,2)+" / "+nFormatter(n,2)+"</div>";m+="</div>";g.production_pickable!=void 0&&g.production_pickable==1&&(m+="<div onclick=\"cancel_pickable_production('"+f+'\')" class="cancel_pickable_production_button">CHANGE</div>')}else g.production_pickable!=void 0&&g.production_pickable==1&&(m+='<span class="single_new_expedition_name">Pick production<br/></span>',$.each(g.pickable_productions,function(w,x){x=check_defeated_heroes(x.available);
var u="";all_available_cards[w]!=void 0&&(u=w);w=="scraps"&&(u="scraps_placeholder");u=parse_card(u);x==""&&(m+="<span onclick=\"set_pickable_production('"+f+"','"+w+"')\">"+u+"</span>")}));m+='<div class="increase_production_container">';if(all_available_cards[f]!=void 0||b.productions[f].production_id!=void 0&&b.productions[f].production_id!=0){if(count_object(g.upgrade_cost_speed)>0){m+='<div class="upgrade_section">';m+='<span class="">Production</span><br/>';var v=!0;$.each(g.upgrade_cost_speed,
function(w,x){x=calculate_production_speed_cost(h.speed_level,x);var u=0;gamedata.owned_cards[w]!=void 0&&gamedata.owned_cards[w]>0&&(u=gamedata.owned_cards[w]);w=="scraps"&&(u=gamedata.scraps);var y="Scraps";all_available_cards[w]!=void 0&&(y=capitalizeFirstLetter(all_available_cards[w].name));u<x?(x=y+': <span style="color:red">'+nFormatter(u,3)+" / "+nFormatter(x,3)+"</span>",v=!1):x=y+': <span style="">'+nFormatter(u,3)+" / "+nFormatter(x,3)+"</span>";m+='<div class="production_upgrade_cost" onclick="show_card_details(\''+
w+"')\">"+x+"</div>"});v==1&&(m+='<br/><div class="production_upgrade_button" onclick="upgrade_production(\''+f+"')\">UPGRADE</div>");m+="</div>"}m+='<div class="upgrade_section">';m+='<span class="">Storage</span><br/>';v=!0;$.each(g.upgrade_cost_storage,function(w,x){x=calculate_production_speed_cost(h.storage_level,x);var u=0;gamedata.owned_cards[w]!=void 0&&gamedata.owned_cards[w]>0&&(u=gamedata.owned_cards[w]);w=="scraps"&&(u=gamedata.scraps);var y="Scraps";all_available_cards[w]!=void 0&&(y=
capitalizeFirstLetter(all_available_cards[w].name));u<x?(x=y+': <span style="color:red">'+nFormatter(u,3)+" / "+nFormatter(x,3)+"</span>",v=!1):x=y+': <span style="">'+nFormatter(u,3)+" / "+nFormatter(x,3)+"</span>";m+='<div class="production_upgrade_cost" onclick="show_card_details(\''+w+"')\">"+x+"</div>"});v==1&&(m+='<br/><div class="production_upgrade_button" onclick="upgrade_storage(\''+f+"')\">UPGRADE</div>");m+="</div>"}m+="</div>";m+='<div style="clear:both"></div>';m+="</div>";a+=m}else d==
0&&(d=g.unlock_cost,g="",gamedata.scraps<d&&(g="button_red"),a+='<div class="claim_all_production_button '+g+'" onclick="buy_next_production(\''+f+"')\">UNLOCK NEXT<br/>"+nFormatter(gamedata.scraps,3)+" / "+nFormatter(d,3)+" scraps</div>")})}c.recipes!=void 0&&count_object(c.recipes)>0&&(a+=show_building_recipes());c.recipe_shop!=void 0&&(gamedata.known_recipes==void 0&&(gamedata.known_recipes={}),$.each(c.recipe_shop,function(f,g){if(gamedata.known_recipes[f]==void 0){var h=!0,k=!0;gamedata.defeated_heroes==
void 0&&(gamedata.defeated_heroes={});$.each(g.shown,function(q,m){if(gamedata.defeated_heroes[q]==void 0||gamedata.defeated_heroes[q]<m)h=!1});$.each(g.available,function(q,m){if(gamedata.defeated_heroes[q]==void 0||gamedata.defeated_heroes[q]<m)k=!1});if(h==1){var l="",p=parse_card(f),n=!0;l+='<div class="single_building_recipe">';l+='<span class="single_new_expedition_name">Recipe: '+capitalizeFirstLetter(all_available_cards[f].name+"</span>");k==1?(l+='<div class="single_building_recipe_costs"><br/>',
$.each(g.cost,function(q,m){var r=0;q=="scraps"&&(r=gamedata.scraps);gamedata.owned_cards[q]!=void 0&&(r=gamedata.owned_cards[q]);var t="Scraps";all_available_cards[q]!=void 0&&(t=capitalizeFirstLetter(all_available_cards[q].name));r<m?(n=!1,m=t+': <span style="color:red">'+nFormatter(r,3)+" / "+nFormatter(m,3)+"</span>"):m=t+': <span style="">'+nFormatter(r,3)+" / "+nFormatter(m,3)+"</span>";l+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+q+"')\">"+m+"</div>"}),l+="</div>",
l+='<div class="single_building_recipe_result" onclick="show_card_details(\''+f+"')\">"+p+"</div>",n==1&&(l+='<div class="single_building_recipe_craft_button" onclick="learn_local_recipe(\''+f+"')\">LEARN</div>")):l+='<div class="single_building_recipe_result" onclick="show_card_details(\''+f+'\')" style="opacity:0.5">'+p+"</div>";l+='<div style="clear:both"></div>';l+="</div>";a+=l}}}));c.shop_type!=void 0&&(check_current_offers(),$.each(b.current_offers,function(f,g){var h="";g.card_amount>1&&(h=
""+g.card_amount+"x ");var k='<div class="single_expedition single_offer"><span class="single_new_expedition_name">'+capitalizeFirstLetter(all_available_cards[g.card_id].name)+'</span><br/><span class="single_new_expedition_description">'+capitalizeFirstLetter(g.buysell)+"ing: "+h+capitalizeFirstLetter(all_available_cards[g.card_id].name)+". <br/></span>";g.buysell=="buy"&&(k+="Offer: "+nFormatter(g.offer_price,3)+" scraps.");g.buysell=="sell"&&(k+="Price: "+nFormatter(g.offer_price,3)+" scraps.");
k+="<br/>("+nFormatter(g.offer_price/(all_available_cards[g.card_id].value*g.card_amount)*100,0)+"%)";var l=0;gamedata.owned_cards[g.card_id]!=void 0&&(l=gamedata.owned_cards[g.card_id]);g.sold==void 0?(k+='<div class="offer_image" onclick="show_card_details(\''+g.card_id+"')\">"+parse_card(g.card_id,h)+"</div>",g.buysell=="buy"&&gamedata.known_recipes!=void 0&&gamedata.known_recipes[g.card_id]!=void 0&&(k+="<div class=\"craft_offer_button\" onclick=\"show_content('craft');show_card_recipe('"+g.card_id+
"')\">CRAFT</div>"),l>=g.card_amount&&g.buysell=="buy"&&g.sold==void 0&&(k+='<div class="complete_expedition_button complete_offer_button buysell_sell" onclick="complete_offer('+f+')">SELL</div>'),gamedata.scraps>=g.offer_price&&g.buysell=="sell"&&g.sold==void 0&&(k+='<div class="complete_expedition_button complete_offer_button" onclick="complete_offer('+f+')">BUY</div>')):k+='<span class="single_new_expedition_description">Trade complete.</span>';k+='<div class="timer" data-complete-time="'+(new Date(g.offer_expires)).getTime()+
'" data-complete-function="show_single_building"></div>';a+=k+"</div>"}));c.show_potions!=void 0&&c.show_potions==1&&(b.potions==void 0&&(b.potions={}),b.potions=sortObj(b.potions),a+='<div class="single_expedition production_bar potion_bar">',$.each(all_upgrades,function(f,g){g.upgrade_type=="potion"&&(a=b.potions[f]!=void 0?a+parse_potion_button(f):a+parse_potion_button(f,!1))}),a+="</div>");e=0;c.expeditions!=void 0&&(b.expeditions==void 0?(b.expeditions={},saveToLocalStorage()):$.each(b.expeditions,
function(f,g){var h=all_expeditions[g.expedition_id];var k='<div class="single_expedition"><span class="single_new_expedition_name busy_expedition_name">'+capitalizeFirstLetter(h.name)+"</span>";k+='<div class="timer" data-complete-time="'+g.done_time+'" data-complete-show="complete_expedition_button_'+current_building_id+"_"+f+'" data-complete-hide="cancel_expedition_button_'+current_building_id+"_"+f+'"></div>';k+='<div class="complete_expedition_button_'+current_building_id+"_"+f+' complete_expedition_button hidden" onclick="complete_expedition('+
f+')">COMPLETE</div>';if(h.cannot_cancel==void 0||h.cannot_cancel==0)k+='<div class="cancel_expedition_button_'+current_building_id+"_"+f+' cancel_expedition_button" onclick="cancel_expedition('+f+')">CANCEL</div>';a+=k+"</div>"}),e+=count_object(b.expeditions),count_object(b.expeditions));c.adventures!=void 0&&(b.adventures==void 0?(b.adventures={},saveToLocalStorage()):$.each(b.adventures,function(f,g){var h="",k=all_adventures[g.adventure_id];h+='<div class="single_expedition"><span class="single_new_expedition_name">'+
capitalizeFirstLetter(k.name)+'</span><br/><span class="single_new_expedition_description">'+k.description+"<br/><br/>Current party:</span>";h+='<div class="timer" data-complete-time="'+g.done_time+'" data-complete-show="complete_expedition_button_'+current_building_id+"_"+f+'" data-complete-hide="cancel_expedition_button_'+current_building_id+"_"+f+'"></div>';h+='<div class="complete_expedition_button_'+current_building_id+"_"+f+' complete_expedition_button hidden" onclick="complete_adventure('+
f+')">COMPLETE</div>';h+='<div class="cancel_expedition_button_'+current_building_id+"_"+f+' cancel_expedition_button" onclick="cancel_adventure('+f+')">CANCEL</div>';h+='<div class="adventuring_units">';$.each(g.units,function(l,p){all_available_cards[p]!=void 0&&(l=parse_card(p),h+="<div onclick=\"show_card_details('"+p+"')\">"+l+"</div>")});h+='<div style="clear:both;"></div>';h+="</div>";h+="</div>";a+=h}),e+=count_object(b.adventures),count_object(b.adventures));(c.expeditions!=void 0||c.adventures)!=
void 0&&e<1&&(a=c.new_mission_title!=void 0?a+('<div class="new_expedition_button" onclick="show_content(\'new_mission\')">'+c.new_mission_title+"</div><br/>"):a+'<div class="new_expedition_button" onclick="show_content(\'new_mission\')">ENTER</div><br/>');a+="";$(".single_building_content_list").html(a);update_all_timers()}}
function buy_next_production(a){var b=gamedata.town[current_building_id],c=all_buildings[b.building_id];c.productions[a]!=void 0&&b.productions[a]==void 0&&(c=c.productions[a].unlock_cost,gamedata.scraps>=c&&(gamedata.scraps-=c,b.productions[a]={level:1,speed_level:1,storage_level:1,last_claimed:(new Date).getTime()},saveToLocalStorage(),show_single_building()))}
function set_pickable_production(a,b){var c=gamedata.town[current_building_id],e=all_buildings[c.building_id];e.productions!=void 0&&e.productions[a]!=void 0&&e.productions[a].pickable_productions!=void 0&&e.productions[a].pickable_productions[b]!=void 0&&(c.productions[a].production_id=b,new_time=(new Date).getTime(),c.productions[a].last_claimed=new_time,saveToLocalStorage(),show_single_building())}
function cancel_pickable_production(a){gamedata.town[current_building_id].productions[a].production_id=!1;saveToLocalStorage();show_single_building()}
function upgrade_production(a){var b=gamedata.town[current_building_id],c=b.productions[a];a=all_buildings[b.building_id].productions[a];var e=!0;$.each(a.upgrade_cost_speed,function(d,f){f=calculate_production_speed_cost(c.speed_level,f);var g=0;gamedata.owned_cards[d]!=void 0&&gamedata.owned_cards[d]>0&&(g=gamedata.owned_cards[d]);d=="scraps"&&(g=gamedata.scraps);g<f&&(e=!1)});e==1&&($.each(a.upgrade_cost_speed,function(d,f){f=calculate_production_speed_cost(c.speed_level,f);gamedata.owned_cards[d]!=
void 0&&(gamedata.owned_cards[d]-=f);d=="scraps"&&(gamedata.scraps-=f)}),c.speed_level++,saveToLocalStorage());show_single_building()}
function upgrade_storage(a){var b=gamedata.town[current_building_id],c=b.productions[a];a=all_buildings[b.building_id].productions[a];var e=!0;$.each(a.upgrade_cost_storage,function(d,f){f=calculate_production_speed_cost(c.storage_level,f);var g=0;gamedata.owned_cards[d]!=void 0&&gamedata.owned_cards[d]>0&&(g=gamedata.owned_cards[d]);d=="scraps"&&(g=gamedata.scraps);g<f&&(e=!1)});e==1&&($.each(a.upgrade_cost_speed,function(d,f){f=calculate_production_speed_cost(c.storage_level,f);gamedata.owned_cards[d]!=
void 0&&(gamedata.owned_cards[d]-=f);d=="scraps"&&(gamedata.scraps-=f)}),c.storage_level++,saveToLocalStorage());show_single_building()}function claim_all_production(){var a=gamedata.town[current_building_id];all_current_rewards={};$.each(a.productions,function(b,c){claim_production(b,!0)});count_object(all_current_rewards)>0&&(current_reward_text="You claimed the production.",current_reward_origin="single_building",saveToLocalStorage(),show_content("current_rewards"))}
function claim_production(a,b){var c=gamedata.town[current_building_id],e=c.productions[a],d=all_buildings[c.building_id].productions[a],f=calculate_production_speed(e.speed_level,d.base_time,d.defeated_heroes_speed_bonusses,d.production_achievement_bonus,c.level),g=((new Date).getTime()-e.last_claimed)/1E3,h=Math.floor(g/f);d=calculate_production_storage(e.storage_level,d.base_storage,d.defeated_heroes_speed_bonusses,c.level);g=Math.floor(g/f);var k=a;c.productions[a].production_id!=void 0&&c.productions[a].production_id!=
0&&all_available_cards[c.productions[a].production_id]!=void 0&&(k=c.productions[a].production_id);g>d&&(g=d);a=e.last_claimed+g*f*1E3;h>=d&&(a=(new Date).getTime());g>0&&(e.last_claimed=a,b!=void 0&&b==1?all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:k,reward_amount:g}:(all_current_rewards={0:{reward_id:k,reward_amount:g}},current_reward_text="You claimed the production.",current_reward_origin="single_building",saveToLocalStorage(),show_content("current_rewards")))}
function clear_all_offers(){$.each(gamedata.town,function(a,b){b.current_offers!=void 0&&(b.current_offers={})})}
function complete_offer(a){a=gamedata.town[current_building_id].current_offers[a];var b=0;gamedata.owned_cards[a.card_id]!=void 0&&(b=gamedata.owned_cards[a.card_id]);a.buysell=="buy"&&b>=a.card_amount&&a.sold==void 0&&(gamedata.owned_cards[a.card_id]-=a.card_amount,gamedata.scraps+=a.offer_price,a.sold=!0,check_quests("sell_card_in_town"),(new Date).addMinutes(10)<new Date(a.offer_expires)&&(a.offer_expires=(new Date).addMinutes(10)),saveToLocalStorage());a.buysell=="sell"&&gamedata.scraps>=a.offer_price&&
a.sold==void 0&&(gamedata.owned_cards[a.card_id]==void 0&&(gamedata.owned_cards[a.card_id]=0),gamedata.owned_cards[a.card_id]+=a.card_amount,gamedata.scraps-=a.offer_price,a.sold=!0,check_quests("buy_card_in_town"),(new Date).addMinutes(10)<new Date(a.offer_expires)&&(a.offer_expires=(new Date).addMinutes(10)),saveToLocalStorage());show_single_building()}
function check_current_offers(){var a=gamedata.town[current_building_id],b=all_buildings[a.building_id],c=!1;a.current_offers==void 0&&(gamedata.town[current_building_id].current_offers={});for(var e=0;e<1;e++)a.current_offers[e]!=void 0&&new Date(a.current_offers[e].offer_expires)<new Date&&delete a.current_offers[e],a.current_offers[e]==void 0&&delete a.current_offers[e],a.current_offers[e]==void 0&&(a.current_offers[e]=create_new_building_offer(b),c=!0);c==1&&saveToLocalStorage()}
function create_new_building_offer(a){var b="buy";Math.random()>.75&&(b="sell");var c=!1;if(b=="buy"){if(Math.random()>.1){var e={};$.each(gamedata.owned_cards,function(g,h){match_array_values(all_available_cards[g].type,a.shop_type)&&(e[g]=!0)});count_object(e)>0&&(c=get_random_key_from_object(e))}c==0&&gamedata.known_recipes!=void 0&&count_object(gamedata.known_recipes)>4&&Math.random()>.3&&(e={},$.each(gamedata.known_recipes,function(g,h){match_array_values(all_available_cards[g].type,a.shop_type)&&
(e[g]=!0)}),count_object(e)>0&&(c=get_random_key_from_object(e)))}c==0&&(c=get_random_card(a.shop_type));var d=!1;if(c!=0){d=1;b=="buy"&&gamedata.owned_cards[c]!=void 0&&d<gamedata.owned_cards[c]&&gamedata.owned_cards[c]>0&&(d=Math.ceil(Math.random()*gamedata.owned_cards[c]));var f=Math.ceil(all_available_cards[c].value*d*(1+Math.random()*(5/get_upgrade_factor("merchant_"+b,void 0,!0))));b=="buy"&&(f=Math.ceil(all_available_cards[c].value*d*(Math.random()*(get_upgrade_factor("merchant_"+b,void 0,
!0)-1)+1)));d={card_id:c,buysell:b,card_amount:d,offer_price:f,offer_expires:(new Date).addHours(1)}}return d}
function show_upgrade_building(){if(gamedata.town[current_building_id]==void 0)show_content("town");else{var a=all_buildings[gamedata.town[current_building_id].building_id];$(".upgrade_content").html("");var b=0;gamedata.owned_cards[a.fragment_id]!=void 0&&(b=gamedata.owned_cards[a.fragment_id]);var c=calculate_upgrade_cost(gamedata.town[current_building_id].level),e=parse_card(a.fragment_id,b+" / "+c);b<c&&(e=parse_card(a.fragment_id,'<span style="color:red">'+b+" / "+c+"</span>"));e=gamedata.scraps<
c*building_scraps_cost?e+parse_card("scraps_placeholder",'<span style="color:red">'+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(c*building_scraps_cost)+"</span>"):e+parse_card("scraps_placeholder",""+numberWithCommas(gamedata.scraps)+" / "+numberWithCommas(c*building_scraps_cost));$(".upgrade_content").append('<div class="fragment_cost">'+e+"</div>");$(".upgrade_content").append('<div class="construction_name">'+capitalizeFirstLetter(a.name)+"</div>");gamedata.owned_cards[a.fragment_id]<
c||gamedata.scraps<c*building_scraps_cost?$(".upgrade_content").append('<div class="construction_description">'+capitalizeFirstLetter(a.upgrade_description)+"</div>"):($(".upgrade_content").append('<div class="construction_description">'+capitalizeFirstLetter(a.upgrade_description)+"</div>"),$(".upgrade_content").append('<div onclick="upgrade_current_building()" class="construction_button">UPGRADE</div>'))}}function calculate_upgrade_cost(a){return Math.floor(a*(1+a/2)*base_building_cost)}
function show_delete_building(){for(var a=base_building_cost,b=gamedata.town[current_building_id].level-1;b>0;b--)a+=calculate_upgrade_cost(b);$(".returned_fragments").html(a)}
function delete_current_building(){gamedata.town[current_building_id]==void 0?show_content("town"):(all_current_rewards={0:{reward_id:all_buildings[gamedata.town[current_building_id].building_id].fragment_id,reward_amount:base_building_cost}},current_reward_text="The building has been destroyed.",current_reward_origin="town",delete gamedata.town[current_building_id],saveToLocalStorage(),show_content("current_rewards"))}
function show_new_mission(){if(gamedata.town[current_building_id]==void 0)show_content("town");else{$(".new_expedition_content").html("");var a=0,b=0,c="",e=all_buildings[gamedata.town[current_building_id].building_id];$.each(e.expeditions,function(d,f){if(all_expeditions[f]!=void 0){c==""&&(c=""+f);a+=1;d=all_expeditions[f];var g=!0,h="";h+='<div class="single_new_expedition">';h+='<div class="single_new_expedition_name">';h+=capitalizeFirstLetter(d.name);h+="</div>";h+=d.description;count_object(d.costs)>
0&&(h+="<b>Cost:</b>");h+='<div class="expedition_costs">';$.each(d.costs,function(k,l){b+=1;var p="";k=="scraps"&&gamedata.scraps<l&&(g=!1,p='style="color:#c33;"');all_available_cards[k]!=void 0&&(gamedata.owned_cards[k]==void 0||gamedata.owned_cards[k]<l)&&(g=!1,p='style="color:#c33;"');k=="scraps"&&(h+='Scraps: <span class="expedition_cost_amount" '+p+">"+gamedata.scraps+" / "+l+"</span><br/>");if(all_available_cards[k]!=void 0){var n=0;gamedata.owned_cards[k]!=void 0&&gamedata.owned_cards[k]>
0&&(n=gamedata.owned_cards[k]);h+=capitalizeFirstLetter(all_available_cards[k].name)+': <span class="expedition_cost_amount" '+p+">"+n+" / "+l+"</span><br/>"}});h+="</div>";d.rewards!=void 0&&(h+="<b>Possible rewards</b>",h+='<div class="possible_rewards">',$.each(d.rewards,function(k,l){k=="scraps"&&(l=parse_card("scraps_placeholder"),h+="<div onclick=\"show_card_details('scraps_placeholder')\">"+l+"</div>");k=="potion"&&(l=parse_card("potion_placeholder"),h+="<div>"+l+"</div>");all_available_cards[k]!=
void 0&&(l=parse_card(k),h+="<div onclick=\"show_card_details('"+k+"')\">"+l+"</div>")}),h+='<div style="clear:both;"></div>',h+="</div>");g==1&&(h+='<div class="start_new_expedition" onclick="start_new_expedition(\''+f+"')\">START</div>");h+="</div>";$(".new_expedition_content").append(h)}});$.each(e.adventures,function(d,f){if(all_adventures[f]!=void 0){a+=1;console.log(f);d=all_adventures[f];var g=!0,h="";h+='<div class="single_new_expedition">';h+='<div class="single_new_expedition_name">';h+=
capitalizeFirstLetter(d.name);h+="</div>";h+=d.description;count_object(d.costs)>0&&(h+="<b>Cost:</b>");h+='<div class="expedition_costs">';$.each(d.costs,function(k,l){b+=1;var p="";k=="scraps"&&gamedata.scraps<l&&(g=!1,p='style="color:#c33;"');all_available_cards[k]!=void 0&&(gamedata.owned_cards[k]==void 0||gamedata.owned_cards[k]<l)&&(g=!1,p='style="color:#c33;"');k=="scraps"&&(h+='Scraps: <span class="expedition_cost_amount" '+p+">"+gamedata.scraps+" / "+l+"</span><br/>");if(all_available_cards[k]!=
void 0){var n=0;gamedata.owned_cards[k]!=void 0&&gamedata.owned_cards[k]>0&&(n=gamedata.owned_cards[k]);h+=capitalizeFirstLetter(all_available_cards[k].name)+': <span class="expedition_cost_amount" '+p+">"+n+" / "+l+"</span><br/>"}});h+="</div>";d.rewards!=void 0&&(h+="<b>Possible rewards</b>",h+='<div class="possible_rewards">',$.each(d.rewards,function(k,l){k=="scraps"&&(l=parse_card("scraps_placeholder"),h+="<div onclick=\"show_card_details('scraps_placeholder')\">"+l+"</div>");all_available_cards[k]!=
void 0&&(l=parse_card(k),h+="<div onclick=\"show_card_details('"+k+"')\">"+l+"</div>")}),h+='<div style="clear:both;"></div>',h+="</div>");g==1&&(h+='<div class="start_new_expedition" onclick="current_adventure=\''+f+"';current_adventure_units={};show_content('adventure_units')\">START</div>");h+="</div>";$(".new_expedition_content").append(h)}});a==1&&b==0&&c!=void 0&&start_new_expedition(c)}}
function show_new_expedition(){if(gamedata.town[current_building_id]==void 0)show_content("town");else{$(".new_expedition_content").html("");var a=all_buildings[gamedata.town[current_building_id].building_id];a.expeditions==void 0?show_content("town"):$.each(a.expeditions,function(b,c){if(all_expeditions[c]!=void 0){b=all_expeditions[c];var e=!0,d="";d+='<div class="single_new_expedition">';d+='<div class="single_new_expedition_name">';d+=capitalizeFirstLetter(b.name);d+="</div>";d+=b.description;
count_object(b.costs)>0&&(d+="<b>Cost:</b>");d+='<div class="expedition_costs">';$.each(b.costs,function(f,g){var h="";f=="scraps"&&gamedata.scraps<g&&(e=!1,h='style="color:#c33;"');all_available_cards[f]!=void 0&&(gamedata.owned_cards[f]==void 0||gamedata.owned_cards[f]<g)&&(e=!1,h='style="color:#c33;"');f=="scraps"&&(d+='Scraps: <span class="expedition_cost_amount" '+h+">"+gamedata.scraps+" / "+g+"</span><br/>");if(all_available_cards[f]!=void 0){var k=0;gamedata.owned_cards[f]!=void 0&&gamedata.owned_cards[f]>
0&&(k=gamedata.owned_cards[f]);d+=capitalizeFirstLetter(all_available_cards[f].name)+': <span class="expedition_cost_amount" '+h+">"+k+" / "+g+"</span><br/>"}});d+="</div>";b.rewards!=void 0&&(d+="<b>Possible rewards</b>",d+='<div class="possible_rewards">',$.each(b.rewards,function(f,g){f=="scraps"&&(g=parse_card("scraps_placeholder"),d+="<div onclick=\"show_card_details('scraps_placeholder')\">"+g+"</div>");all_available_cards[f]!=void 0&&(g=parse_card(f),d+="<div onclick=\"show_card_details('"+
f+"')\">"+g+"</div>")}),d+='<div style="clear:both;"></div>',d+="</div>");e==1&&(d+='<div class="start_new_expedition" onclick="start_new_expedition(\''+c+"')\">START</div>");d+="</div>";$(".new_expedition_content").append(d)}})}}
function show_new_adventure(){if(gamedata.town[current_building_id]==void 0)show_content("town");else{$(".new_expedition_content").html("");var a=all_buildings[gamedata.town[current_building_id].building_id];a.adventures==void 0?show_content("town"):$.each(a.adventures,function(b,c){if(all_adventures[c]!=void 0){b=all_adventures[c];var e=!0,d="";d+='<div class="single_new_expedition">';d+='<div class="single_new_expedition_name">';d+=capitalizeFirstLetter(b.name);d+="</div>";d+=b.description;count_object(b.costs)>
0&&(d+="<b>Cost:</b>");d+='<div class="expedition_costs">';$.each(b.costs,function(f,g){var h="";f=="scraps"&&gamedata.scraps<g&&(e=!1,h='style="color:#c33;"');all_available_cards[f]!=void 0&&(gamedata.owned_cards[f]==void 0||gamedata.owned_cards[f]<g)&&(e=!1,h='style="color:#c33;"');f=="scraps"&&(d+='Scraps: <span class="expedition_cost_amount" '+h+">"+gamedata.scraps+" / "+g+"</span><br/>");if(all_available_cards[f]!=void 0){var k=0;gamedata.owned_cards[f]!=void 0&&gamedata.owned_cards[f]>0&&(k=
gamedata.owned_cards[f]);d+=capitalizeFirstLetter(all_available_cards[f].name)+': <span class="expedition_cost_amount" '+h+">"+k+" / "+g+"</span><br/>"}});d+="</div>";b.rewards!=void 0&&(d+="<b>Possible rewards</b>",d+='<div class="possible_rewards">',$.each(b.rewards,function(f,g){f=="scraps"&&(g=parse_card("scraps_placeholder"),d+="<div onclick=\"show_card_details('scraps_placeholder')\">"+g+"</div>");all_available_cards[f]!=void 0&&(g=parse_card(f),d+="<div onclick=\"show_card_details('"+f+"')\">"+
g+"</div>")}),d+='<div style="clear:both;"></div>',d+="</div>");e==1&&(d+='<div class="start_new_expedition" onclick="current_adventure=\''+c+"';current_adventure_units={};show_content('adventure_units')\">START</div>");d+="</div>";$(".new_expedition_content").append(d);count_object(a.adventures)!=1||b.costs!=void 0&&count_object(b.costs)!=0?($(".single_adventure_back").hide(),$(".multiple_adventure_back").show()):($(".single_adventure_back").show(),$(".multiple_adventure_back").hide(),current_adventure=
c,current_adventure_units={},show_content("adventure_units"))}})}}var current_adventure_units_page=1;
function show_adventure_units(){var a=!1;$(".selected_adventure_units").html("");if(all_adventures[current_adventure]==void 0)show_content("town");else{for(var b=all_adventures[current_adventure],c="",e=0;e<b.unit_count;e++){var d='<div class="adventure_unit">';current_adventure_units[e]!=void 0&&(all_available_cards[current_adventure_units[e]]==void 0||gamedata.owned_cards[current_adventure_units[e]]<1?delete current_adventure_units[e]:(d+='<div onclick="remove_adventure_unit('+e+')">'+parse_card(current_adventure_units[e])+
"</div>",a=!0));d+="</div>";c+=d}$(".selected_adventure_units").html(c);$(".creature_type_filter").prop("checked",!0);$(".adventure_units_list").html("");var f="",g=0;$.each(all_available_cards,function(h,k){var l=0;gamedata.owned_cards[h]!=void 0&&gamedata.owned_cards[h]>0&&(l=gamedata.owned_cards[h]);$.each(current_adventure_units,function(n,q){h==q&&--l});var p=!0;suggest_mode=="matched"&&(p=!1,$.each(k.abilities,function(n,q){match_array_values(b.ability_suggestions,n)==1&&(p=!0)}),k.subtypes!=
void 0&&b.ability_suggestions!=void 0&&match_array_values(b.ability_suggestions,k.subtypes)==1&&(p=!0));check_filters(h)==0&&k.type=="creature"&&l>0&&p==1&&(g++,g>current_adventure_units_page*8-8&&g<=current_adventure_units_page*8&&(k=parse_card(h,l),gamedata.owned_cards[h]!=void 0&&gamedata.owned_cards[h]>0&&(f+="<div onclick=\"add_adventure_unit('"+h+"')\">"+k+"</div>")))});g>8?($("#content_adventure_units .page_selection").show(),current_adventure_units_page==1?$(".page_selection .previous_page").addClass("no_page"):
$(".page_selection .previous_page").removeClass("no_page"),g/8<=current_adventure_units_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),g==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_adventure_units_page+" / "+Math.ceil(g/8))):$("#content_adventure_units .page_selection").hide();g>0&&Math.ceil(g/8)<current_adventure_units_page?
(current_adventure_units_page=1,show_adventure_units()):f!=""&&$(".adventure_units_list").html(""+f);a==1&&$(".selected_adventure_units").append('<div class="start_new_expedition" onclick="start_adventure()">START</div>')}}
function start_adventure(){var a=all_adventures[current_adventure],b=!0;$.each(a.costs,function(e,d){e=="scraps"&&gamedata.scraps<d?b=!1:e=="scraps"&&(gamedata.scraps-=d);all_available_cards[e]!=void 0&&(gamedata.owned_cards[e]==void 0||gamedata.owned_cards[e]<d)?b=!1:all_available_cards[e]!=void 0&&(gamedata.owned_cards[e]-=d)});$.each(current_adventure_units,function(e,d){gamedata.owned_cards[d]!=void 0&&gamedata.owned_cards[d]>0&&--gamedata.owned_cards[d]});if(b==1&&gamedata.town[current_building_id]!=
void 0&&count_object(current_adventure_units)>0){gamedata.town[current_building_id].adventures==void 0&&(gamedata.town[current_building_id].adventures={});var c=get_highest_key_in_object(gamedata.town[current_building_id].adventures)+1;a=(new Date).getTime()+a.time*1E3;gamedata.town[current_building_id].adventures[c]={adventure_id:current_adventure,done_time:a,units:current_adventure_units};saveToLocalStorage()}show_content("single_building")}
function complete_adventure(a){var b=gamedata.town[current_building_id],c=b.adventures[a],e=all_adventure_results[get_random_key_from_object_based_on_num_value(all_adventures[c.adventure_id].results)],d=e.base_success+0;$.each(e.bonus_success,function(h,k){$.each(c.units,function(l,p){var n=all_available_cards[p];typeof k=="number"&&n[h]!=void 0&&typeof n[h]=="number"&&n[h]>0&&(d+=k*n[h]);typeof k=="object"&&n[h]!=void 0&&typeof n[h]=="object"&&$.each(k,function(q,m){n[h][q]!=void 0&&typeof n[h][q]==
"number"&&(d+=m*n[h][q]);n[h][q]!=void 0&&typeof n[h][q]=="object"&&(d+=m);match_array_values(q,n[h])==1&&(d+=m)})})});(e.base_success==void 0||e.base_success<=90)&&d>90&&(d=90);console.log("success chance: "+d);var f={};$.each(c.units,function(h,k){f[h]=0;f[h]=e.survive_chance==void 0?100:e.survive_chance;$.each(e.bonus_survive,function(l,p){var n=all_available_cards[k];n[l]!=void 0&&typeof n[l]=="number"&&n[l]>0&&(f[h]+=p*n[l]);typeof p=="object"&&n[l]!=void 0&&typeof n[l]=="object"&&$.each(p,function(q,
m){n[l][q]!=void 0&&typeof n[l][q]=="number"&&(f[h]+=m*n[l][q]);n[l][q]!=void 0&&typeof n[l][q]=="object"&&(f[h]+=m);match_array_values(q,n[l])==1&&(f[h]+=m)})});e.survive_chance!=void 0&&e.survive_chance<90&&f[h]>90&&(f[h]=90);console.log("survive chance: "+k+" "+f[h])});all_current_rewards={};current_reward_origin="single_building";current_reward_text="";var g=!1;$.each(c.units,function(h,k){f[h]>=Math.random()*100&&(g=!0,all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:k,
reward_amount:1,no_faction:!0})});d>=Math.random()*100&&g==1?(current_reward_text=e.success_text,$.each(e.rewards,function(h,k){k=round_by_percent(Math.random()*(k.max-k.min))+k.min;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:h,reward_amount:k}})):current_reward_text=g==1?e.fail_text:e.no_return_text;delete b.adventures[a];show_content("current_rewards")}
function cancel_adventure(a){var b=gamedata.town[current_building_id],c=b.adventures[a];get_random_key_from_object_based_on_num_value(all_adventures[c.adventure_id].results);all_current_rewards={};current_reward_origin="single_building";current_reward_text="";$.each(c.units,function(e,d){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d,reward_amount:1,no_faction:!0}});delete b.adventures[a];show_content("current_rewards")}
function set_adventure_units_page(a){current_adventure_units_page+=a;current_adventure_units_page<1&&(current_adventure_units_page=1);show_adventure_units()}function remove_adventure_unit(a){delete current_adventure_units[a];show_adventure_units()}function add_adventure_unit(a){for(var b=-1,c=all_adventures[current_adventure],e=0;e<c.unit_count;e++)current_adventure_units[e]==void 0&&b==-1&&(b=e);b!=-1&&(current_adventure_units[b]=a);show_adventure_units()}
function start_new_expedition(a){$(".new_expedition_content").html("");var b=all_expeditions[a],c=!0;$.each(b.costs,function(d,f){d=="scraps"&&gamedata.scraps<f?c=!1:d=="scraps"&&(gamedata.scraps-=f);all_available_cards[d]!=void 0&&(gamedata.owned_cards[d]==void 0||gamedata.owned_cards[d]<f)?c=!1:all_available_cards[d]!=void 0&&(gamedata.owned_cards[d]-=f)});if(c==1&&gamedata.town[current_building_id]!=void 0){gamedata.town[current_building_id].expeditions==void 0&&(gamedata.town[current_building_id].expeditions=
{});var e=get_highest_key_in_object(gamedata.town[current_building_id].expeditions)+1;b=(new Date).getTime()+b.time*1E3;gamedata.town[current_building_id].expeditions[e]={expedition_id:a,done_time:b};saveToLocalStorage()}show_content("single_building")}
function complete_expedition(a){var b=gamedata.town[current_building_id].expeditions[a],c=all_expeditions[b.expedition_id];current_reward_origin="single_building";current_reward_text="";if(b!=void 0&&b.done_time<=(new Date).getTime()){all_current_rewards={};if(c.possible_results==void 0)if(c.allways_rewards!=void 0&&$.each(c.allways_rewards,function(g,h){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:g,reward_amount:h}}),c.success_chance==void 0||Math.random()*100<
c.success_chance){current_reward_text=c.success_text;c.success_rewards!=void 0&&$.each(c.success_rewards,function(g,h){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:g,reward_amount:h}});var e=1;c.success_picks!=void 0&&(e=c.success_picks);for(b=1;b<=e;b++){var d=get_random_key_from_object(c.rewards),f=Math.floor(Math.random()*c.rewards[d]+c.rewards[d]);f<1&&(f=1);all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d,reward_amount:f}}}else current_reward_text=
c.fail_text,c.fail_rewards!=void 0&&(d=get_random_key_from_object(c.fail_rewards),f=Math.floor(Math.random()*c.fail_rewards[d]+c.fail_rewards[d]),f<1&&(f=1),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:d,reward_amount:f});else if(d=get_random_key_from_object_based_on_num_value(c.possible_results),all_expedition_results[d]!=void 0&&(current_reward_text=all_expedition_results[d].text,$.each(all_expedition_results[d].base_rewards,function(g,h){h=round_by_percent(Math.random()*
(h.max-h.min))+h.min;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:g,reward_amount:h}}),all_expedition_results[d].additional_reward_picks!=void 0))for(b=1;b<=all_expedition_results[d].additional_reward_picks;b++)c=get_random_key_from_object_based_on_num_value(all_expedition_results[d].additional_reward_chances),e=all_expedition_results[d].additional_rewards[c],e=round_by_percent(Math.random()*(e.max-e.min))+e.min,all_current_rewards[get_highest_key_in_object(all_current_rewards)+
1]={reward_id:c,reward_amount:e};delete gamedata.town[current_building_id].expeditions[a]}show_content("current_rewards")}
function cancel_expedition(a){var b=all_expeditions[gamedata.town[current_building_id].expeditions[a].expedition_id];current_reward_origin="single_building";current_reward_text="";do_no_apply_factions=!0;all_current_rewards={};b.costs!=void 0&&$.each(b.costs,function(c,e){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:c,reward_amount:e}});delete gamedata.town[current_building_id].expeditions[a];saveToLocalStorage();show_content("current_rewards")}
function show_current_rewards(){$(".current_rewards_content").html("");var a="",b=0,c=0,e=!1,d=!1,f=!1,g=!1,h=!1,k=count_object(all_current_rewards);$.each(all_current_rewards,function(n,q){q.reward_id=="scraps_placeholder"&&(q.reward_id="scraps");all_current_rewards[n].reward_amount==0?delete all_current_rewards[n]:$.each(all_current_rewards,function(m,r){all_current_rewards[m]!=void 0&&q.reward_id==r.reward_id&&n<m&&(all_current_rewards[n].reward_amount+=all_current_rewards[m].reward_amount,delete all_current_rewards[m])})});
gamedata.factions!=void 0&&do_no_apply_factions==0&&$.each(gamedata.factions,function(n,q){var m=q.level;all_factions[n]!=void 0&&$.each(all_current_rewards,function(r,t){$.each(all_factions[n].loot_bonus,function(v,w){t.reward_id==v&&t.no_faction==void 0&&(t.reward_amount=round_by_percent(t.reward_amount*(1+m*w/100)))})})});gamedata.upgrades!=void 0&&$.each(all_current_rewards,function(n,q){n=get_upgrade_factor("loot",[q.reward_id],!0);q.reward_amount=round_by_percent(q.reward_amount*n)});do_no_apply_factions=
!1;var l=0;$.each(all_current_rewards,function(n,q){q.pickable!=void 0&&q.pickable==1&&l++});l==1&&$.each(all_current_rewards,function(n,q){q.pickable!=void 0&&q.pickable==1&&delete all_current_rewards[n].pickable});current_reward_text!=void 0&&(a+='<div class="reward_text">'+current_reward_text+"</div>");$.each(all_current_rewards,function(n,q){if(q.reward_id=="scraps")if(q.pickable==void 0||q.pickable==0)gamedata.scraps=gamedata.scraps==void 0?q.reward_amount:gamedata.scraps+q.reward_amount,check_quests("gained_scraps",
void 0,q.reward_amount),check_quests("scraps_owned",gamedata.scraps),b+=q.reward_amount;else{var m=parse_card("scraps_placeholder",q.reward_amount);a+='<div class="single_current_reward reward_'+n+'">'+m+'<div class="menu_button slim pick_reward_button" onclick="pick_reward('+n+')">PICK</div></div>'}if(q.reward_id=="potion"){var r=get_random_upgrade("potion"),t=!1;gamedata.town[current_building_id]==void 0&&(gamedata.town[current_building_id]={building_id:"alchemist"});gamedata.town[current_building_id].potions==
void 0&&(gamedata.town[current_building_id].potions={});gamedata.town[current_building_id].potions[r]==void 0&&(t=!0);m=parse_card("potion_placeholder",void 0,void 0,all_upgrades[r].name);t==0?(gamedata.upgrades[r]==void 0?gamedata.upgrades[r]=1:gamedata.upgrades[r]++,a+='<div class="single_current_reward">'+m+"</div>"):(gamedata.town[current_building_id].potions[r]=!0,a+='<div class="single_current_reward glowing_reward">'+m+"</div>");saveToLocalStorage()}q.reward_id=="reputation"&&gain_current_rep(q.reward_amount);
all_available_cards[q.reward_id]!=void 0&&(m=all_available_cards[q.reward_id].value*q.reward_amount,m!=void 0&&m==c&&q.pickable!=void 0&&q.pickable==1&&(d=!0),m!=void 0&&m>c&&q.pickable!=void 0&&q.pickable==1&&(c=m,e=n,d=!1),r=0,m="",gamedata.owned_cards[q.reward_id]!=void 0?r=gamedata.owned_cards[q.reward_id]:m='</div><div class="new_card">NEW',r==f&&q.pickable!=void 0&&q.pickable==1&&(h=!0),(f===!1||r<f)&&q.pickable!=void 0&&q.pickable==1&&(f=r,g=n,h=!1),q.pickable==void 0||q.pickable==0?(n=!1,
all_available_cards[q.reward_id]!=void 0&&all_available_cards[q.reward_id].type=="recipe"&&(gamedata.known_recipes==void 0&&(gamedata.known_recipes={}),n=gamedata.known_recipes[all_available_cards[q.reward_id].recipe]=!0),all_available_cards[q.reward_id]!=void 0&&all_available_cards[q.reward_id].type=="cardback"&&(n=gamedata.owned_card_backs[all_available_cards[q.reward_id].reward.card_back_id]=!0),n==0&&gain_card(q.reward_id,q.reward_amount),m=parse_card(q.reward_id,q.reward_amount+m),a+='<div class="single_current_reward" onclick="show_card_details(\''+
q.reward_id+"')\">"+m+"</div>"):(m=parse_card(q.reward_id,q.reward_amount+' <span class="currently_owned">('+r+")</span>"),a+='<div class="single_current_reward reward_'+n+' pickable_reward"><div onclick="show_card_details(\''+q.reward_id+"')\">"+m+'</div><div class="menu_button slim pick_reward_button" onclick="pick_reward('+n+')">PICK</div></div>'))});if(b>0){var p=parse_card("scraps_placeholder",b);a+='<div class="single_current_reward">'+p+"</div>"}$.each(all_current_rewards,function(n,q){q.pickable!=
void 0&&q.pickable!=0||delete all_current_rewards[n]});a=count_object(all_current_rewards)==0?a+('<div class="claim_current_rewards_button" onclick="show_content(\''+current_reward_origin+"')\">CLAIM</div>"):a+('<div class="claim_current_rewards_button hidden" onclick="show_content(\''+current_reward_origin+"')\">CLAIM</div>");$(".current_rewards_content").html(a);d==0&&e!==!1&&$(".reward_"+e+" .card").addClass("glowing_reward");h==0&&g!==!1&&$(".reward_"+g+" .card").addClass("glowing_reward");saveToLocalStorage();
k==0&&current_reward_text==""&&show_content(current_reward_origin)}
function pick_reward(a){$(".single_current_reward .card").removeClass("glowing_reward");$.each(all_current_rewards,function(b,c){if(b==a){if(c.reward_id=="scraps"){gamedata.scraps=gamedata.scraps==void 0?c.reward_amount:gamedata.scraps+c.reward_amount;$(".reward_"+b+" .card").remove();var e=parse_card("scraps_placeholder",c.reward_amount);$(".reward_"+b+" div").append(e)}all_available_cards[c.reward_id]!=void 0&&(check_quests("card_picked_"+c.reward_id),gain_card(c.reward_id,c.reward_amount),$(".reward_"+
b+" .card").remove(),e=parse_card(c.reward_id,c.reward_amount),$(".reward_"+b+" div").append(e));$(".reward_"+b).css("overflow","visible")}else $(".reward_"+b).css("width","0px"),$(".reward_"+b).css("margin-left","0px"),$(".reward_"+b).css("margin-right","0px"),$(".reward_"+b).css("overflow","hidden");$(".reward_"+b+" .pick_reward_button").remove();delete all_current_rewards[b]});$(".claim_current_rewards_button").removeClass("hidden")}
function return_exp_cost(a){$.each(all_expeditions[a].costs,function(b,c){b=="scraps"&&(gamedata.scraps+=c);all_available_cards[b]!=void 0&&gain_card(b)})}
function show_building_recipes(){var a=all_buildings[gamedata.town[current_building_id].building_id],b="";$(".ability_filter").val()!=""&&$(".ability_filter").val();$(".name_filter").val()!=""&&$(".name_filter").val();a.recipes==void 0?show_content("town"):($(".building_recipes_content").html(""),$.each(a.recipes,function(c,e){if(check_defeated_heroes(e.available)==""){count_object(e.costs)==0&&all_available_cards[c].recipe!=void 0&&(e.costs=all_available_cards[c].recipe);check_filters(c);gamedata.owned_cards[c]==
void 0&&(gamedata.owned_cards[c]=0);var d="",f=parse_card(c,gamedata.owned_cards[c]),g=!0;d+='<div class="single_building_recipe">';d+='<span class="single_building_recipe_result" onclick="show_card_details(\''+c+"')\">"+f+"</span>";d+='<div class="single_building_recipe_costs">';all_available_cards[c].quote!=void 0&&all_available_cards[c].quote!=""&&(d+="<span><i>"+all_available_cards[c].quote+"</i><br/><br/></span>");var h=1;e.costs_increas_factor!=void 0&&(h=to_the_nth(1,gamedata.owned_cards[c],
e.costs_increas_factor));$.each(e.costs,function(k,l){var p=0;k=="scraps"&&(p=gamedata.scraps);gamedata.owned_cards[k]!=void 0&&(p=gamedata.owned_cards[k]);var n="Scraps";all_available_cards[k]!=void 0&&(n=capitalizeFirstLetter(all_available_cards[k].name));p<Math.floor(l*h)?(g=!1,l=n+': <span style="color:red">'+nFormatter(p,3)+" / "+nFormatter(Math.floor(l*h),3)+"</span>"):l=n+': <span style="">'+nFormatter(p,3)+" / "+nFormatter(Math.floor(l*h),3)+"</span>";d+='<div class="single_building_recipe_cost" onclick="show_card_details(\''+
k+"')\">"+l+"</div>"});d+="</div>";d+='<div class="single_building_recipe_arrow"><</div>';g==1&&(d+='<div class="single_building_recipe_craft_button" onclick="craft_local_card(\''+c+"')\">BUY</div>");d+='<div style="clear:both"></div>';d+="</div>";b+=d}}));return b}
function craft_local_card(a){var b=all_buildings[gamedata.town[current_building_id].building_id].recipes[a];count_object(b.costs)==0&&all_available_cards[a].recipe!=void 0&&(b.costs=all_available_cards[a].recipe);var c=1;b.costs_increas_factor!=void 0&&(c=to_the_nth(1,gamedata.owned_cards[a],b.costs_increas_factor));if(all_available_cards[a]!=void 0){var e=!0;$.each(b.costs,function(d,f){var g=0;d=="scraps"&&(g=gamedata.scraps);gamedata.owned_cards[d]!=void 0&&(g=gamedata.owned_cards[d]);g<Math.floor(f*
c)&&(e=!1)});e==1&&($.each(b.costs,function(d,f){gamedata.owned_cards[d]!=void 0&&(gamedata.owned_cards[d]-=Math.floor(f*c));d=="scraps"&&(gamedata.scraps-=Math.floor(f*c))}),gain_card(a),show_available_cards(!1),saveToLocalStorage());show_single_building()}}
function learn_local_recipe(a){var b=all_buildings[gamedata.town[current_building_id].building_id].recipe_shop[a];if(all_available_cards[a]!=void 0&&gamedata.known_recipes[a]==void 0){var c=!0;$.each(b.cost,function(e,d){e="scraps";var f=gamedata.scraps;gamedata.owned_cards[e]!=void 0&&(f=gamedata.owned_cards[e]);f<d&&(c=!1)});c==1&&($.each(b.cost,function(e,d){gamedata.owned_cards[e]!=void 0&&(gamedata.owned_cards[e]-=d);e=="scraps"&&(gamedata.scraps-=d)}),gamedata.known_recipes[a]=!0,show_available_cards(!1),
saveToLocalStorage(),show_single_building(a))}}
function update_all_timers(){$(".timer").each(function(a){a=$(this).attr("data-complete-time");var b=(new Date).getTime();a-=b;a>0?(b="",a>=1E3&&(b=toHHMMSS(Math.floor(a/1E3))),$(this).html(b)):($(this).attr("data-complete-show")!=void 0&&($(this).addClass("hidden"),$("."+$(this).attr("data-complete-show")).removeClass("hidden")),$(this).attr("data-complete-hide")!=void 0&&$("."+$(this).attr("data-complete-hide")).addClass("hidden"),$(this).attr("data-complete-function")!=void 0&&(a=window[$(this).attr("data-complete-function")],
typeof a==="function"&&a()))});clearTimeout(timer_timeout);timer_timeout=setTimeout(function(){update_all_timers()},1E3)}function toHHMMSS(a){a=parseInt(a,10);return[Math.floor(a/3600/24),Math.floor(a/3600)%24,Math.floor(a/60)%60,a%60].map(b=>b<10?"0"+b:b).filter((b,c)=>b!=="00"||c>0).join(":")}var timer_timeout=setTimeout(function(){update_all_timers()},1E3),daily_reward_claimable=!1;
function show_daily_reward(a){var b=(new Date).getMonth()+1,c=(new Date).getDate();a!=void 0&&(b=a);gamedata.daily_rewards==void 0&&(gamedata.daily_rewards={},gamedata.daily_rewards.free_picks=0,gamedata.daily_rewards.current_month=b,gamedata.daily_rewards.last_claimed=c-1,saveToLocalStorage());if(gamedata.daily_rewards.available_rewards==void 0||count_object(gamedata.daily_rewards.available_rewards)<18){gamedata.daily_rewards.available_rewards={};for(a=1;a<=18;a++){a==18&&(a=40);var e=a*8+5,d=get_random_reward(e,
b);gamedata.daily_rewards.available_rewards[a-1]!=void 0&&gamedata.daily_rewards.available_rewards[a-1].reward==d&&(d=get_random_reward(e,b));all_available_cards[d]!=void 0&&(e=round_by_percent(a*(1+a/5)/all_available_cards[d].value),e<1&&(e=1),gamedata.daily_rewards.available_rewards[a]={reward:d,amount:e})}saveToLocalStorage()}$(".daily_reward_content").html("");var f=0,g=!1;$.each(gamedata.daily_rewards.available_rewards,function(h,k){if(all_available_cards[k.reward]!=void 0){var l="";f+=k.amount;
k.amount<1&&(l=" claimed ");l='<div class="single_reward '+l+'" onclick="show_card_details(\''+k.reward+"')\">";var p="";all_available_cards[k.reward].image_position!=void 0&&(p="background-position:"+all_available_cards[k.reward].image_position+";");l+='<div class="background" style="background-image:url(images/'+all_available_cards[k.reward].image+");"+p+'"></div>';k.amount>1&&(l+='<div class="daily_reward_amount">x'+k.amount+"</div>");l+=h+"</div>";$(".daily_reward_content").append(l)}else g=!0});
(gamedata.daily_rewards.last_claimed!=c||gamedata.daily_rewards.free_picks>0)&&f>0?(daily_reward_claimable=!0,gamedata.daily_rewards.free_picks>0?$(".daily_reward_content").append('<div class="claim_daily_reward_button" onclick="claim_daily_reward()">CLAIM ('+gamedata.daily_rewards.free_picks+")</div>"):$(".daily_reward_content").append('<div class="claim_daily_reward_button" onclick="claim_daily_reward()">CLAIM</div>')):daily_reward_claimable=!1;if(g==1||f<1)gamedata.daily_rewards.available_rewards=
{},show_daily_reward()}function get_random_reward(a,b){var c={};$.each(all_available_cards,function(e,d){d.value<=a&&d.value>a/2E7&&d.pick_chance>0&&d.type!="cardback"&&(d.months_available!=void 0&&match_array_values([b],d.months_available)==1?d.value<=a*2&&(d=d.value*3/a,d<10&&(d=10),c[e]=d):c[e]=d.value/a)});return get_random_key_from_object_based_on_num_value(c)}
function claim_daily_reward(){var a=(new Date).getDate(),b=!1;if(gamedata.daily_rewards.last_claimed!=a||gamedata.daily_rewards.free_picks>0)gamedata.daily_rewards.last_claimed!=a?gamedata.daily_rewards.last_claimed=a:--gamedata.daily_rewards.free_picks,$.each(gamedata.daily_rewards.available_rewards,function(c,e){e.amount>0&&b==0&&(current_battle_type="daily",fixed_hero=endless_waves=!1,all_current_rewards={},current_reward_origin="daily_reward",all_current_rewards[get_highest_key_in_object(all_current_rewards)+
1]={reward_id:e.reward,reward_amount:e.amount},b=!0,add_basic_win_rewards(sqr(c)*get_upgrade_factor("summon_reward","any",!0)),gamedata.daily_rewards.available_rewards[c].amount=0,saveToLocalStorage())});b==1?show_content("current_rewards"):show_daily_reward()}var current_inventory_page=1,current_consumable="";
function show_inventory(){cards_per_page=12;$(".inventory_content").html('<span class="no_tinker">You have no consumables.</span>');gamedata.owned_cards=sortObj(gamedata.owned_cards);var a=0;$.each(gamedata.owned_cards,function(b,c){if(all_available_cards[b]!=void 0){c+=0;var e=!1;all_available_cards[b].type!="consumable"&&all_available_cards[b].type!="token"&&all_available_cards[b].type!="currency"&&all_available_cards[b].type!="material"&&all_available_cards[b].type!="treasure"&&(e=!0);c>0&&e==
0&&check_filters(b)==0&&(a++,a==1&&$(".inventory_content").html(""),a/cards_per_page>current_inventory_page-1&&a/cards_per_page<=current_inventory_page&&(c=parse_card(b,c),all_available_cards[b].type!="consumable"&&all_available_cards[b].type!="cardback"||$(".inventory_content").append("<span onclick=\"current_consumable='"+b+"';show_content('single_consumable');\">"+c+"</span>"),all_available_cards[b].type!="token"&&all_available_cards[b].type!="currency"&&all_available_cards[b].type!="material"&&
all_available_cards[b].type!="treasure"||$(".inventory_content").append("<span onclick=\"show_card_details('"+b+"');\">"+c+"</span>")))}else delete gamedata.owned_cards[b]});current_inventory_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");a/cards_per_page<=current_inventory_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");a>0&&Math.ceil(a/cards_per_page)<current_inventory_page&&
(current_inventory_page=1,show_inventory());a==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page");$(".page_selection .page_number").html(current_inventory_page+" / "+Math.ceil(a/cards_per_page))}function set_inventory_page(a){current_inventory_page+=a;current_inventory_page<1&&(current_inventory_page=1);show_inventory()}
function show_single_consumable(){if(gamedata.owned_cards[current_consumable]==void 0||all_available_cards[current_consumable]==void 0||gamedata.owned_cards[current_consumable]==0)show_content("inventory");else{$(".single_consumable_content").html("");var a=parse_card(current_consumable,gamedata.owned_cards[current_consumable]);$(".single_consumable_content").append('<div class="fragment_cost" onclick="show_card_details(\''+current_consumable+"')\">"+a+"</div>");a='<div class="construction_description"><div class="construction_name">'+
(capitalizeFirstLetter(all_available_cards[current_consumable].name)+"</div><br/>");all_available_cards[current_consumable].reward!=void 0&&all_available_cards[current_consumable].reward.description!=void 0&&(a+=capitalizeFirstLetter(all_available_cards[current_consumable].reward.description)+"<br/><br/>");if(all_available_cards[current_consumable].reward!=void 0&&all_available_cards[current_consumable].reward.type=="boost"){var b=0;gamedata.combat_boosts!=void 0&&gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]!=
void 0&&(b=gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]);a=b<1?a+"Boost not active":a+("Boosts active: "+b+" uses left")}all_available_cards[current_consumable].reward!=void 0&&all_available_cards[current_consumable].reward.type=="loot_charges"&&(b=0,gamedata.loot_charges!=void 0&&(b=gamedata.loot_charges),a=b<1?a+"You have no current loot bonus.":a+("The next time you receive random loot the stack size will be increased by "+b+"."));all_available_cards[current_consumable].reward!=
void 0&&all_available_cards[current_consumable].reward.type=="loot_rarity"&&(b=0,gamedata.loot_rarity!=void 0&&(b=gamedata.loot_rarity),a=b<1?a+"You have no current loot bonus.":a+("The chance of rare loot is increased by "+b+"%."));a+="</div>";$(".single_consumable_content").append(a);var c='<div class="use_inventory_buttons">';all_available_cards[current_consumable].reward!=void 0&&(a=!0,all_available_cards[current_consumable].reward.type=="card_back"&&gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]!=
void 0&&(a=!1),a==1&&(all_available_cards[current_consumable].reward.type=="card_back"?c+='<div onclick="use_current_inventory()" class="use_inventory_button">COLLECT</div>':all_available_cards[current_consumable].reward.amount_used==void 0?c+='<div onclick="use_current_inventory()" class="use_inventory_button">USE</div>':$.each(all_available_cards[current_consumable].reward.amount_used,function(e,d){d!="all"&&gamedata.owned_cards[current_consumable]>=d&&(c+='<div onclick="use_current_inventory('+
d+')" class="use_inventory_button">USE '+d+"</div>");d=="all"&&gamedata.owned_cards[current_consumable]>1&&(c+='<div onclick="use_current_inventory('+gamedata.owned_cards[current_consumable]+')" class="use_inventory_button">USE ALL</div>')})));c+="</div>";$(".single_consumable_content").append(c)}}
function use_current_inventory(a){a==void 0&&(a=1);if(gamedata.owned_cards[current_consumable]==void 0||all_available_cards[current_consumable]==void 0||gamedata.owned_cards[current_consumable]==0)show_content("inventory");else{gamedata.owned_cards[current_consumable]-=a;if(all_available_cards[current_consumable].reward!=void 0){all_available_cards[current_consumable].reward.type=="card_back"&&(gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]==void 0&&(gamedata.owned_card_backs[all_available_cards[current_consumable].reward.card_back_id]=
!0),saveToLocalStorage(),show_content("inventory"));if(all_available_cards[current_consumable].reward.type=="function"){var b=window[all_available_cards[current_consumable].reward.execute];typeof b==="function"?b()==0&&(gamedata.owned_cards[current_consumable]+=a):gamedata.owned_cards[current_consumable]+=a;saveToLocalStorage();show_content("inventory")}all_available_cards[current_consumable].reward.type=="reputation"&&(b="",all_available_cards[current_consumable].reward.faction=="current"&&gamedata.current_faction!=
void 0&&(b=gamedata.current_faction),all_factions[all_available_cards[current_consumable].reward.faction]!=void 0&&(b=all_available_cards[current_consumable].reward.faction),all_factions[b]!=void 0?gain_rep(b,all_available_cards[current_consumable].reward.amount*a):(gamedata.owned_cards[current_consumable]+=a,a=0),saveToLocalStorage(),show_content("single_consumable"));if(all_available_cards[current_consumable].reward.type=="random_card"){all_current_rewards={};current_reward_origin="single_consumable";
current_reward_text=all_available_cards[current_consumable].reward.text;for(var c=a-1;c>=0;c--){var e=1;all_available_cards[current_consumable].reward.pick_amount!=void 0&&(e=all_available_cards[current_consumable].reward.pick_amount);var d={};for(g=0;g<e;g++){var f=get_random_card_based_on_value(all_available_cards[current_consumable].reward.min_value,all_available_cards[current_consumable].reward.color,all_available_cards[current_consumable].reward.card_type,all_available_cards[current_consumable].reward.all_pick_chance,
d,all_available_cards[current_consumable].reward.max_value);f==0&&(f=get_random_card_based_on_value(all_available_cards[current_consumable].reward.min_value,all_available_cards[current_consumable].reward.color,all_available_cards[current_consumable].reward.card_type,!0,void 0,all_available_cards[current_consumable].reward.max_value));d[get_highest_key_in_object(d)+1]=f;b=1;all_available_cards[current_consumable].reward.amount!=void 0&&(b=all_available_cards[current_consumable].reward.amount);all_current_rewards[get_highest_key_in_object(all_current_rewards)+
1]={reward_id:f,reward_amount:b,pickable:all_available_cards[current_consumable].reward.pickable}}}saveToLocalStorage();show_content("current_rewards")}if(all_available_cards[current_consumable].reward.type=="random_basic_card"){all_current_rewards={};current_reward_origin="single_consumable";current_reward_text=all_available_cards[current_consumable].reward.text;for(c=a-1;c>=0;c--)for(e=1,all_available_cards[current_consumable].reward.pick_amount!=void 0&&(e=all_available_cards[current_consumable].reward.pick_amount),
d={},g=0;g<e;g++)f=get_basic_reward_card(d),f==0&&(f=get_basic_reward_card(d)),d[get_highest_key_in_object(d)+1]=f,b=1,all_available_cards[current_consumable].reward.amount!=void 0&&(b=all_available_cards[current_consumable].reward.amount),all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:f,reward_amount:b,pickable:all_available_cards[current_consumable].reward.pickable};saveToLocalStorage();show_content("current_rewards")}if(all_available_cards[current_consumable].reward.type==
"random_card_back"){all_current_rewards={};current_reward_origin="single_consumable";current_reward_text=all_available_cards[current_consumable].reward.text;for(c=a-1;c>=0;c--)for(e=1,all_available_cards[current_consumable].reward.pick_amount!=void 0&&(e=all_available_cards[current_consumable].reward.pick_amount),d={},g=0;g<e;g++)f=get_back_card_card(d),f==0&&(f=get_back_card_card(d)),d[get_highest_key_in_object(d)+1]=f,b=1,all_available_cards[current_consumable].reward.amount!=void 0&&(b=all_available_cards[current_consumable].reward.amount),
all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:f,reward_amount:b,pickable:all_available_cards[current_consumable].reward.pickable};saveToLocalStorage();show_content("current_rewards")}if(all_available_cards[current_consumable].reward.type=="scraps"){all_current_rewards={};current_reward_origin="single_consumable";current_reward_text=all_available_cards[current_consumable].reward.text;current_rewards={};c=0;for(var g=a-1;g>=0;g--)b=1,all_available_cards[current_consumable].reward.amount!=
void 0&&(b=all_available_cards[current_consumable].reward.amount),all_available_cards[current_consumable].reward.min_amount!=void 0&&(b=Math.floor(Math.random()*(b-all_available_cards[current_consumable].reward.min_amount+1))+all_available_cards[current_consumable].reward.min_amount),c+=b;all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:c,pickable:all_available_cards[current_consumable].reward.pickable};saveToLocalStorage();show_content("current_rewards")}all_available_cards[current_consumable].reward.type==
"boost"&&(gamedata.combat_boosts==void 0&&(gamedata.combat_boosts={}),gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]=gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]==void 0?all_available_cards[current_consumable].reward.amount:gamedata.combat_boosts[all_available_cards[current_consumable].reward.card_id]+all_available_cards[current_consumable].reward.amount,saveToLocalStorage(),show_content("single_consumable"));all_available_cards[current_consumable].reward.type==
"loot_charges"&&(gamedata.loot_charges==void 0&&(gamedata.loot_charges=0),gamedata.loot_charges+=all_available_cards[current_consumable].reward.amount*a,saveToLocalStorage(),show_content("single_consumable"));all_available_cards[current_consumable].reward.type=="loot_rarity"&&(gamedata.loot_rarity==void 0&&(gamedata.loot_rarity=0),gamedata.loot_rarity+=all_available_cards[current_consumable].reward.amount*a,saveToLocalStorage(),show_content("single_consumable"))}a>0&&check_quests("used_consumable_"+
current_consumable,void 0,a)}}var current_active_raid={},current_raid_points=0,current_raid_id=0;function show_raids(){$(".refresh_raids_button").addClass("hidden");$("#content_raids .main_new_raid_button").removeClass("hidden");$("#content_raids .main_join_raid_button").removeClass("hidden");$("#content_raids .raids_content").removeClass("full");get_active_raids_list()}
function get_active_raids_list(){gamedata.account_id!=void 0&&($(".raids_content").html('<div class="loading_arena_decks">Loading active raids</div>'),$.post("ajax.php",{data:"get_active_raids",current_id:gamedata.account_id},function(a){count_object(JSON.parse(a))>0?(all_active_raids=JSON.parse(a),parse_active_raids_list(all_active_raids)):$(".raids_content").html('<div class="loading_arena_decks">No active raids found.</div>')}))}
function parse_active_raids_list(a){var b="";$.each(a,function(c,e){e.points_left<0&&(e.points_left=0);b+='<div class="fightable_deck_container">';e.hero!=void 0&&(e.hero=JSON.parse(e.hero),b=e.user_id==gamedata.account_id?b+('<div class="fightable_deck owned_deck_'+e.active_raid_id+' fightable" onclick="current_raid_id='+e.active_raid_id+';view_raid()">'):b+('<div class="fightable_deck owned_deck_'+e.active_raid_id+' not_fightable">'),b+='<div class="background" style="background-image:url(images/'+
e.hero.image+')"></div>',b+="<span>"+capitalizeFirstLetter(e.raid_name)+"</span>",b+='<div class="wins_losses">',b+="Points: "+parseInt(e.points_earned)+"<br/>",b+="Health: "+parseInt(e.points_left)+" / "+parseInt(e.points),b+="</div>",b+="</div>",deck_found=!0);b+="</div>"});$("#content_raids .arena_shop_button").removeClass("hidden");$(".raids_content").html(b)}
function view_raid(){$("#content_raids .arena_shop_button").addClass("hidden");$("#content_raids .main_new_raid_button").addClass("hidden");$("#content_raids .main_join_raid_button").addClass("hidden");$("#content_raids .arena_shop_button").addClass("hidden");var a=current_raid_id;gamedata.account_id!=void 0&&($(".raids_content").html('<div class="loading_arena_decks">Loading raid</div>'),$.post("ajax.php",{data:"get_raid",raid_id:a},function(b){count_object(JSON.parse(b))>0?(active_raid=JSON.parse(b),
parse_active_raid(active_raid)):show_content("raids")}))}
function parse_active_raid(a){$(".refresh_raids_button").removeClass("hidden");$("#content_raids .raids_content").addClass("full");a=a[0];a.points_left<0&&(a.points_left=0);a.hero=JSON.parse(a.hero);current_active_raid=a;$("#join_code").val(a.join_code);var b="",c=0;parseInt(a.points_left)>0&&(c=parseInt(a.points_left));var e=0;c>0&&(e=c/parseInt(a.points)*100);b=b+'<div class="single_raid_container"><div class="raid_image" style="background-image:url(images/'+(a.hero.image+')"></div>');b+='<span class="raid_name">'+
capitalizeFirstLetter(a.raid_name)+"<br/></span>";b+='<span class="raid_description"><br/>'+a.description+"<br/><br/>Join code: "+a.join_code+'<span class="copy_code_button" onclick="copy_current_join_code()">Copy code</span></span>';b+='<div class="raid_health"><div class="raid_health_bar" style="width:'+e+'%"></div><span>Health: '+c+" / "+parseInt(a.points)+"</span></div>";b+='<div class="raid_rewards"></div></div>';b=a.points_left>0?b+'<div class="start_raid_button" onclick="start_raid()">ATTACK</div>':
b+'<div class="start_raid_button hidden claim_raid_button" onclick="claim_raid()">CLAIM</div>';a=b+'<div class="contributer_list"></div>';$(".raids_content").html(a);show_raid_contributers()}
function show_raid_rewards(){$(".raid_rewards").html("");$.post("ajax.php",{data:"get_raid_rewards",raid_id:current_active_raid.raid_id},function(a){a=JSON.parse(a);var b=!1,c=!1;$.each(a,function(f,g){c==0&&parseInt(g.min_points)<=current_raid_points&&(c=g);parseInt(g.min_points)>current_raid_points&&(b=g)});var e="",d="";c!=0&&(e+='<div class="raid_reward_block">Current reward<br/>',$.each(JSON.parse(c.rewards),function(f,g){f=g.reward_id;all_available_cards[f]!=void 0&&(e+='<div class="card_holder" onclick="show_card_details(\''+
f+"')\">"+parse_card(f,g.reward_amount)+"</div>");f=="scraps"&&(e+=parse_card("scraps_placeholder",g.reward_amount))}),e+="</div>");b!=0?(d+='<div class="raid_reward_block">Reward at '+b.min_points+" points<br/>",$.each(JSON.parse(b.rewards),function(f,g){f=g.reward_id;all_available_cards[f]!=void 0&&(d+='<div class="card_holder" onclick="show_card_details(\''+f+"')\">"+parse_card(f,g.reward_amount)+"</div>");f=="scraps"&&(d+=parse_card("scraps_placeholder",g.reward_amount))}),d+="</div>"):d+='<div class="raid_reward_block">Maximum rewards reached<br/><br/><br/><br/></div>';
$(".raid_rewards").html(""+e+d)})}
function show_raid_contributers(){var a=current_raid_id;current_raid_points=0;gamedata.account_id!=void 0&&($(".contributer_list").html('<div class="loading_arena_decks">Loading</div>'),$.post("ajax.php",{data:"get_raid_contributers",raid_id:a},function(b){if(count_object(JSON.parse(b))>0){all_contributers=JSON.parse(b);var c="Contributers<br/>";$.each(all_contributers,function(e,d){d.name!=""&&(e="",d.user_id==gamedata.account_id&&(e=" current_user "),c+='<div class="single_contributer '+e+'">'+
d.name+'<span class="contributed_amount">'+d.points_earned+"</span></div>");d.user_id==gamedata.account_id&&(current_raid_points=d.points_earned,$(".claim_raid_button").removeClass("hidden"))});$(".contributer_list").html(c)}show_raid_rewards()}))}
function upload_raid_points_gained(a){current_active_raid.raid_id!=void 0&&gamedata.account_id!=void 0&&$.post("ajax.php",{data:"upload_raid_points_gained",current_id:gamedata.account_id,raid_id:current_active_raid.active_raid_id,points:a},function(b){})}
function claim_raid(){current_active_raid.raid_id!=void 0&&gamedata.account_id!=void 0&&($(".raids_content").html('<div class="loading_arena_decks">Loading rewards</div>'),$.post("ajax.php",{data:"get_raid_rewards",raid_id:current_active_raid.raid_id},function(a){var b=!1;$.each(JSON.parse(a),function(c,e){b==0&&parseInt(e.min_points)<=current_raid_points&&(all_current_rewards=JSON.parse(e.rewards),b=!0,current_reward_origin="raids",current_reward_text="The raid has finished.<br/>Claim your reward.",
$.post("ajax.php",{data:"clear_raid",raid_id:current_active_raid.active_raid_id,current_id:gamedata.account_id},function(d){check_quests("raid_rewards_claimed");show_content("current_rewards")}))});b==0&&(all_current_rewards={},b=!0,current_reward_origin="raids",current_reward_text="The raid has finished.<br/>You failed to get any rewards.",$.post("ajax.php",{data:"clear_raid",raid_id:current_active_raid.active_raid_id,current_id:gamedata.account_id},function(c){show_content("current_rewards")}))}))}
var raid_start_ids={raid_key_1:{cost_id:"raid_key",name:"Basic raid",description:"Start a basic raid",cost_amount:1,raid_type:"basic"}};
function show_start_raid(){var a="";$.each(raid_start_ids,function(b,c){var e='<div class="single_building_recipe"><h2>'+(capitalizeFirstLetter(c.name)+"</h2>");e+='<div class="new_raid_description">'+c.description+"</div>";var d=0;gamedata.owned_cards[c.cost_id]!=void 0&&(d=gamedata.owned_cards[c.cost_id]);d=parse_card(c.cost_id,d+" / "+c.cost_amount);e+=d;gamedata.owned_cards[c.cost_id]!=void 0&&gamedata.owned_cards[c.cost_id]>=c.cost_amount&&(e+='<div class="start_new_raid_button" onclick="start_new_raid(\''+
b+"')\">START</div>");a+=e+'<div style="clear:both;"></div></div>'});$(".new_raids_content").html(a)}
function start_new_raid(a){var b=raid_start_ids[a];gamedata.owned_cards[b.cost_id]!=void 0&&gamedata.owned_cards[b.cost_id]>=b.cost_amount&&(gamedata.owned_cards[b.cost_id]-=b.cost_amount,saveToLocalStorage(),$(".new_raids_content").html('<div class="loading_arena_decks">Starting raid</div>'),$.post("ajax.php",{data:"start_new_raid",current_id:gamedata.account_id,raid_type:raid_start_ids[a].raid_type},function(c){parseInt(c)>0&&show_content("raids")}))}
function join_raid(){if($(".raid_code").val()!=""){var a=$(".raid_code").val();a.length==10?$.post("ajax.php",{data:"join_raid",current_id:gamedata.account_id,raid_code:a},function(b){console.log(b);parseInt(b)>0?show_content("raids"):$(".raid_join_error").html("Incorrect raid code")}):$(".raid_join_error").html("Raid code to short")}else $(".raid_join_error").html("Please enter a raid code")}function show_join_raid(){$(".raid_code").val("");$(".raid_join_error").html("")}
function copy_current_join_code(){var a=document.getElementById("join_code");a.select();a.setSelectionRange(0,99999);document.execCommand("copy")}var current_collection_page=1;
function show_collection(){$(".tinkering_container").html("");var a="",b=0,c=0,e=0,d=0,f=0;$.each(all_available_cards,function(k,l){if(check_filters(k)==0&&l.type!="currency"&&l.type!="consumable"&&l.type!="cardback"&&namechanges[k]==void 0&&l.pick_chance>0&&(d++,b++,gamedata.owned_cards[k]!=void 0&&c++,l.recipe!=void 0&&f++,l.recipe!=void 0&&gamedata.known_recipes[k]!=void 0&&e++,b>current_collection_page*12-12&&b<=current_collection_page*12)){l=parse_card(k);var p="";gamedata.known_recipes!=void 0&&
gamedata.known_recipes[k]==void 0&&all_available_cards[k].recipe!=void 0&&(p="unowned_summon");a=gamedata.owned_cards[k]!=void 0?a+('<div class="collection_card_container '+p+'" onclick="show_card_details(\''+k+"')\">"+l+"</div>"):a+('<div class="collection_card_container not_in_collection  '+p+'">'+l+"</div>")}});b>12?($("#content_collection .page_selection").show(),current_collection_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),
b/12<=current_collection_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),b==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_collection_page+" / "+Math.ceil(b/12))):$("#content_collection .page_selection").hide();b>0&&Math.ceil(b/12)<current_collection_page?(current_collection_page=1,show_collection()):a!=""&&$(".tinkering_container").html('<div class="tinkering_list">'+
a+"</div>");var g=Math.floor(c/d*100),h=Math.floor(e/f*100);c==0&&(g=0);e==0&&(h=0);$(".collection_count").html("Cards: "+g+"%");$(".collection_recipe_count").html("Recipes: "+h+"%")}function set_collection_page(a){current_collection_page+=a;current_collection_page<1&&(current_collection_page=1);show_collection()}
var all_icons={air:{},broken:{},power:{},lightning:{},bomb:{},healing:{},bolster:{},wither:{},strike:{},arrow:{},hoof:{},fireray:{},stun:{},fire:{},meteor:{},burn:{},teleport:{},poison:{},curse:{},doom:{},bless:{},frost:{},lull:{},magic:{},armor:{},water:{},dodge:{},shield:{},fly:{},parry:{},resurrect:{},repair:{},energize:{},dice:{},dice_g:{},go_again:{},cleanse:{},voodoo:{},drain:{},book:{},hasten:{},slow:{},discard:{},death:{},magic_shield:{},eye:{},spikes:{},money:{},stone:{},fluffyswirl:{},music:{},
wound:{}};function show_icons(){var a="";$.each(all_icons,function(b,c){a+='<div class="icon icon_'+b+'"></div>'});$(".icons_container").html(a)}var current_card_backs_page=1,card_backs_per_page=12;
function show_card_backs(){$(".tinkering_container").html("");gamedata.show_hand_colors==void 0||gamedata.show_hand_colors==1?$(".show_hand_colors_button").html("COLOR VISIBLE"):$(".show_hand_colors_button").html("COLOR INVISIBLE");gamedata.owned_card_backs==void 0&&(gamedata.owned_card_backs={});var a="",b=0,c=0;$.each(all_card_backs,function(e,d){if(gamedata.owned_card_backs[e]!=void 0&&(c++,b++,b>current_card_backs_page*card_backs_per_page-card_backs_per_page&&b<=current_card_backs_page*card_backs_per_page)){var f=
!1;all_available_cards[e.replace("card_back_","")]!=void 0&&(f=all_available_cards[e.replace("card_back_","")]);var g="";f!=0&&f.image_position!=void 0&&(g=";background-position:"+f.image_position);f='<div class="pickable_card_back" style="background-image:url(images/'+d+")"+g+'"></div>';g="";gamedata.hand_card_back!=void 0&&gamedata.hand_card_back==d&&(g='<div class="card_back_active">ACTIVE</div>');a=gamedata.owned_card_backs[e]!=void 0?a+('<span class="card_back_container" onclick="set_card_back(\''+
e+"')\">"+f+g+"</span>"):a+('<div class="not_in_collection">'+f+"</div>")}});b>card_backs_per_page?($("#content_card_backs .page_selection").show(),current_card_backs_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page"),b/card_backs_per_page<=current_card_backs_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page"),b==0?$(".page_selection .page_number").addClass("no_page"):
$(".page_selection .page_number").removeClass("no_page"),$(".page_selection .page_number").html(current_card_backs_page+" / "+Math.ceil(b/card_backs_per_page))):$("#content_card_backs .page_selection").hide();b>0&&Math.ceil(b/card_backs_per_page)<current_card_backs_page?(current_card_backs_page=1,show_card_backs()):a!=""&&$(".tinkering_container").html('<div class="tinkering_list">'+a+"</div>")}
function set_card_back_page(a){current_card_backs_page+=a;current_card_backs_page<1&&(current_card_backs_page=1);show_card_backs()}function set_card_back(a){gamedata.hand_card_back=all_card_backs[a];saveToLocalStorage();show_card_backs()}function clear_card_back(){gamedata.hand_card_back="";saveToLocalStorage();show_card_backs()}
function toggle_show_hand_colors(){gamedata.show_hand_colors=gamedata.show_hand_colors==void 0||gamedata.show_hand_colors==1?!1:!0;gamedata.show_hand_colors==void 0||gamedata.show_hand_colors==1?$(".show_hand_colors_button").html("COLOR VISIBLE"):$(".show_hand_colors_button").html("COLOR INVISIBLE")}function toggle_all_cardbacks(){$.each(all_card_backs,function(a,b){gamedata.owned_card_backs[a]!=void 0?delete gamedata.owned_card_backs[a]:gamedata.owned_card_backs[a]=!0})}
var showing_faction="",base_faction_rep=250,base_rep_reward=25,color_bonus_rep=0;
function show_factions(){gamedata.factions==void 0&&(gamedata.factions={});var a="";a+='<div class="single_expedition">';a+='<span class="single_new_expedition_name">Factions</span><br/>';gamedata.current_faction&&all_factions[gamedata.current_faction]!=void 0&&(a+='<span class="faction_description representing_current">Representing: '+capitalizeFirstLetter(all_factions[gamedata.current_faction].name)+"</span><br/>");a+='<span class="faction_description">Choose a faction to represent. You will get reputation with that faction for all battles won.<br/>If you gain levels with factions, they will increase the amount of certain rewards.</span><br/>';
a+="</div>";$.each(all_factions,function(b,c){var e=check_defeated_heroes(c.shown),d=check_defeated_heroes(c.available);if(e==""){var f=e="";gamedata.current_faction!=void 0&&gamedata.current_faction==b&&(e="active",f="Representing: ");var g=0,h=0,k=base_faction_rep,l=0;gamedata.factions[b]!=void 0&&(g=gamedata.factions[b].reputation,gamedata.factions[b].level=calculate_faction_level(g),l=gamedata.factions[b].level,h=l*l*base_faction_rep,k=(l+1)*(l+1)*base_faction_rep,h=(g-h)/(k-h)*100);a+='<div class="single_expedition '+
e+'">';a+='<div class="faction_background" style="background-image:url(images/'+c.image+')"></div>';d==""?(a+='<span class="single_new_expedition_name">'+f+capitalizeFirstLetter(c.name)+"</span>",a+='<div class="faction_info_button" onclick="showing_faction=\''+b+"';show_content('single_faction')\">INFO</div>",e==""&&(a+='<div class="activate_faction_button" onclick="activate_faction(\''+b+"')\">REPRESENT</div>"),a+='<div class="reputation_bar"><div class="reputation_progress_bar" style="width:'+
h+'%"></div><div class="reputation_progress_left">level: '+l+'</div><div class="reputation_progress_right">'+numberWithCommas(g)+" / "+numberWithCommas(k)+"</div></div>"):a+='<span class="not_available_text">'+d+"</span>";a+="</div>"}});$(".factions_container").html(a)}
function show_single_faction(){var a=all_factions[showing_faction],b="",c=0;gamedata.factions[showing_faction]!=void 0&&(c=gamedata.factions[showing_faction].level);b+='<span class="faction_name">'+capitalizeFirstLetter(a.name)+"</span><br/>";b+='<span class="faction_description">'+capitalizeFirstLetter(a.description)+"</span><br/>";b+='<span class="faction_description">Gain reputation with this faction by winning battles while representing this faction.</span><br/>';b+='<span class="faction_description"><br/>Current bonusses:</span><br/>';
$.each(a.loot_bonus,function(e,d){b+='<span class="faction_bonus_title">'+capitalizeFirstLetter(all_available_cards[e].name)+':</span><span class="faction_bonus_current">+'+d*c+'%</span><span class="faction_bonus_per_level">('+d+"% per level)</span><br/>"});$(".faction_bg").css("background-image","url(images/"+a.image+")");$(".single_faction_container").html(b)}
function activate_faction(a){gamedata.current_faction=a;gamedata.factions[a]==void 0&&(gamedata.factions[a]={level:0,reputation:0});saveToLocalStorage();show_factions()}function calculate_faction_level(a){return Math.floor(Math.sqrt(a/base_faction_rep))}function gain_current_rep(a){gain_rep(gamedata.current_faction,a)}var rep_bar_message_counter=0;
function gain_rep(a,b){if(all_factions[a]!=void 0){b=round_by_percent(b*get_upgrade_factor("reputation",[a,"any"]));gamedata.factions[a]==void 0&&(gamedata.factions[a]={level:0,reputation:0});var c=all_factions[a],e=gamedata.factions[a].reputation+0,d=gamedata.factions[a].level+0,f=d*d*base_faction_rep,g=(d+1)*(d+1)*base_faction_rep;f=(e-f)/(g-f)*100;gamedata.factions[a].reputation+=b;gamedata.factions[a].level=calculate_faction_level(gamedata.factions[a].reputation);saveToLocalStorage();rep_bar_message_counter++;
var h=gamedata.factions[a].reputation+0,k=gamedata.factions[a].level+0;a=k*k*base_faction_rep;var l=(k+1)*(k+1)*base_faction_rep,p=(h-a)/(l-a)*100,n=rep_bar_message_counter+0;c='<span class="faction_name">'+capitalizeFirstLetter(c.name)+"</span><br/>";c+='<div class="reputation_bar rep_bar_message_counter_'+n+'"><div class="reputation_progress_bar" style="width:'+f+'%"></div><div class="reputation_progress_bar_gained bar_1" style="left:'+f+'%;width:0%"></div><div class="reputation_progress_bar_gained bar_2" style="left:0%;width:0%"></div><div class="reputation_progress_left">level: '+
d+'</div><div class="reputation_progress_right">'+numberWithCommas(e)+" (+"+b+") / "+numberWithCommas(g)+"</div></div>";show_message(c);var q=p-f;if(d==k)setTimeout(function(){$(".rep_bar_message_counter_"+n+" .reputation_progress_bar_gained.bar_1").css("width",q+"%")},510),setTimeout(function(){$(".rep_bar_message_counter_"+n+" .reputation_progress_right").html(numberWithCommas(h)+" / "+numberWithCommas(l))},2510);else{var m=100-f;setTimeout(function(){$(".rep_bar_message_counter_"+n+" .reputation_progress_bar_gained.bar_1").css("width",
m+"%")},510);setTimeout(function(){$(".rep_bar_message_counter_"+n+" .reputation_progress_bar_gained.bar_2").css("width",p+"%");$(".rep_bar_message_counter_"+n+" .reputation_progress_bar_gained.bar_1").css("display","none");$(".rep_bar_message_counter_"+n+" .reputation_progress_bar").css("width","0%");$(".rep_bar_message_counter_"+n+" .reputation_progress_right").html(numberWithCommas(h)+" / "+numberWithCommas(l));$(".rep_bar_message_counter_"+n+" .reputation_progress_left").html("Level: "+k);$(".rep_bar_message_counter_"+
n+" .reputation_progress_left").addClass("levelup");setTimeout(function(){$(".rep_bar_message_counter_"+n+" .reputation_progress_left").removeClass("levelup")},500)},2510)}}}var showing_chapter=!1;
function show_journal(a){showing_chapter!=0&&all_story_chapters[showing_chapter]!=void 0&&(a=showing_chapter);gamedata.stories==void 0&&(gamedata.stories={});$(".journal_back").hide();$(".story_back").hide();var b="";if(a==void 0||all_story_chapters[a]==void 0)$(".journal_back").show(),$.each(all_story_chapters,function(d,f){var g=!0,h=!0;$.each(f.stories,function(k,l){l!=1||gamedata.stories[k]!=void 0&&gamedata.stories[k].claimed!=0||(h=!1)});$.each(f.needs_completed,function(k,l){if(gamedata.stories[k]==
void 0||gamedata.stories[k].claimed==0)g=!1});g==1&&(b+=parse_chapter(d,h))});if(a!=void 0&&all_story_chapters[a]!=void 0){$(".story_back").show();var c=all_story_chapters[a],e=0;$.each(all_stories,function(d,f){if(c.stories[d]!=void 0){var g=!0;gamedata.stories[d]!=void 0&&gamedata.stories[d].claimed==1&&(g=!1);$.each(f.needs_completed,function(h,k){if(gamedata.stories[h]==void 0||gamedata.stories[h].claimed==0)g=!1});g==1&&(gamedata.stories[d]==void 0&&(gamedata.stories[d]={amount:0,completed:!1,
claimed:!1,date_completed:!1}),e++,b+=parse_story(d))}});e==0&&all_story_chapters[a].complete_text!=void 0&&(b+='<div class="story">',b+='<div class="story_name">Chapter complete</div>',b+='<div class="story_description">'+all_story_chapters[a].complete_text+"</div>",b+="</div>")}$(".journal_content").html(b)}
function parse_chapter(a,b){var c="";if(all_story_chapters[a]!=void 0){var e=all_story_chapters[a];c=c+('<div class="chapter chapter_done_'+b+'" onclick="showing_chapter=\''+a+"';show_journal('"+a+'\')"><div class="chapter_bg"></div><div class="chapter_name">')+(e.name+"</div>");c+='<div class="chapter_subname">'+e.subname+"</div>";c+="</div>"}return c}
function parse_story(a){var b="";if(gamedata.stories[a]!=void 0&&all_stories[a]!=void 0){var c=all_stories[a],e=gamedata.stories[a];b+='<div class="story">';b+='<div class="chapter_bg"></div>';b+='<div class="story_name">'+c.name+"</div>";b+='<div class="story_description">'+c.description+"</div>";b+='<div class="story_progress_name">Objective: '+c.objective_name+"</div>";b+='<div class="story_progress_bar_container">';var d=Math.floor(e.amount/c.amount*100);d>0&&(b+='<div class="fake_pbc"><div class="story_progress_bar" style="width:'+
d+'%"></div></div>');b+='<div class="story_progress">'+e.amount+" / "+c.amount+"</div>";b+="</div>";count_object(c.rewards)>0&&(b+='<div class="story_rewards">',$.each(c.rewards,function(f,g){f=g.reward_id;g.reward_id=="scraps"&&(f="scraps_placeholder");g=parse_card(f,g.reward_amount);b+="<span onclick=\"show_card_details('"+f+"')\">"+g+"</span>"}),b+="</div>");b=e.completed==1&&e.claimed==0?b+('<div class="claim_story_button" onclick="claim_story(\''+a+"')\">COMPLETE</div>"):b+'<div class="claim_story_button" onclick="show_content(\'map\')">MAP</div>';
b+="</div>"}return b}
function claim_story(a){if(gamedata.stories[a]!=void 0&&all_stories[a]!=void 0){var b=all_stories[a];a=gamedata.stories[a];a.completed==1&&a.claimed==0&&(all_current_rewards={},current_reward_origin="journal",current_reward_text="",b.reward_text!=void 0&&(current_reward_text=b.reward_text),$.each(b.rewards,function(c,e){all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:e.reward_id,reward_amount:e.reward_amount}}),a.claimed=!0,saveToLocalStorage(),show_content("current_rewards"))}}
function show_map(){gamedata.current_location==void 0&&(gamedata.current_location="map",saveToLocalStorage());var a="";gamedata.current_location!="none"&&all_locations[gamedata.current_location]!=void 0&&all_locations[gamedata.current_location].parent_location!="none"&&(a+=parse_location(gamedata.current_location,void 0,!0));$.each(all_locations,function(b,c){if(c.parent_location==gamedata.current_location){var e=!0;$.each(c.needs_stories_complete,function(d,f){if(gamedata.stories==void 0||gamedata.stories[f]==
void 0||gamedata.stories[f].claimed==0)e=!1});a+=parse_location(b,e)}});$(".map_content").html(a);all_locations[gamedata.current_location]==void 0?(delete gamedata.current_location,show_map()):all_available_cards[all_locations[gamedata.current_location].card_image]!=void 0&&$(".map_bg").css("background-image","url(images/"+all_available_cards[all_locations[gamedata.current_location].card_image].image+")")}
function parse_location(a,b,c){var e="";if(all_locations[a]!=void 0){var d=all_locations[a];c==void 0||c==0?(c="false",gamedata.achievements[a]!=void 0&&gamedata.achievements[a].completed==1&&(c="true"),e+='<div class="location map_col_'+d.map_col+" map_row_"+d.map_row+" location_type_"+d.type+" cleared_battle_"+c+" can_enter_"+b+'">',d.type=="location"&&b!=void 0&&b==1&&(e+='<div class="location_click_event" onclick="set_location(\''+a+"')\"></div>"),d.type=="battle"&&(e+='<div class="location_click_event" onclick="map_hero=\''+
d.hero_id+"';endless_waves=false;show_random_battle()\"></div>",e+='<div class="map_icon battle_icon"></div>'),all_available_cards[d.card_image]!=void 0&&(e+='<div class="location_bg" style="background-image:url(images/'+all_available_cards[d.card_image].image+')"></div>')):(e=e+'<div class="location map_col_1 map_row_1 map_back_button"><div class="location_click_event" onclick="set_location(\''+(d.parent_location+"')\"></div>"),all_available_cards[all_locations[d.parent_location].card_image]!=void 0&&
(e+='<div class="location_bg" style="background-image:url(images/'+all_available_cards[all_locations[d.parent_location].card_image].image+')"></div>'));e+="</div>"}return e}function set_location(a){all_locations[a]!=void 0&&(gamedata.current_location=a,saveToLocalStorage(),show_map())}var selected_pre_summon_buff="",selected_post_summon_buff="";
function show_summon(a){$(".summon_container").html("");gamedata.summon_pre_buffs==void 0&&(gamedata.summon_pre_buffs={});var b="",c="",e="";a!=void 0&&a==1&&(c="just_summoned");gamedata.current_summon!=void 0&&(gamedata.current_summon.tries==void 0||gamedata.current_summon.tries<1||gamedata.current_summon.level==void 0)&&delete gamedata.current_summon;var d=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(h,k){d=adjust_summon_stats(d,k)});correct_summon_stats(d);gamedata.loot_rarity==
void 0&&(gamedata.loot_rarity=0);if(gamedata.current_summon==void 0||a!=void 0&&a==1){b+='<div class="summoned_hero_container '+c+'">';var f=parse_card("empty_card");b+="<span>"+f+"</span>";b+='<span class="summon_stats">';b+="<br/>";if(d.min_level!=10||d.max_level!=10)b+="Power: "+Math.floor(d.min_level*10),d.min_level!=d.max_level&&(b+=" - "+Math.ceil(d.max_level*10)),b+="%<br/>";b+="Rarity: "+d.min_rarity;d.min_rarity!=d.max_rarity&&(b+=" - "+d.max_rarity);b+="<br/>";b+="Tries: "+d.max_tries+"<br/>";
b+="Reward: "+nFormatter(Math.floor(d.reward_bonus*100),3)+"%<br/>";b+="<br/>";b+="</span>";b+='<div class="menu_button slim summon button" onclick="summon_now()">SUMMON</div><br/><br/>';get_upgrade_factor("show_altar","any",!0)>1&&(b+='<div class="menu_button slim summon button" data-target-content="altar">ALTAR</div><br/><br/>');for(f=1;f<d.max_pre_buffs+1;f++){b+='<span class="pebuff" onclick="remove_prebuff(\''+f+"')\">";var g=parse_card("empty_card_orange");g=gamedata.summon_pre_buffs[f]!=void 0?
parse_card(gamedata.summon_pre_buffs[f]):parse_card("empty_card");b+=g;b+="</span>"}b+="<br/><br/>";selected_pre_summon_buff!=""&&all_available_cards[selected_pre_summon_buff]!=void 0&&(b+='<div class="selected_pre_summon_buff_container">',b+='<span class="selected_pre_summon_buff">'+parse_card(selected_pre_summon_buff)+"</span>",b+='<span class="selected_pre_summon_buff_text">'+all_available_cards[selected_pre_summon_buff].name+"<br/>"+all_available_cards[selected_pre_summon_buff].description+"</span>",
b=count_object(gamedata.summon_pre_buffs)<d.max_pre_buffs?b+('<div class="menu_button slim summon button use_summon_pre_buff_button" onclick="use_summon_pre_buff(\''+selected_pre_summon_buff+"')\">USE</div>"):b+'<div class="menu_button slim summon button use_summon_pre_buff_button")">FULL</div>',b+="</div><br/>");count_object(gamedata.summon_pre_buffs);$.each(all_available_cards,function(h,k){k.summon_pre_buff!=void 0&&gamedata.owned_cards[h]!=void 0&&gamedata.owned_cards[h]>0&&(k=parse_card(h,gamedata.owned_cards[h]),
b+='<span class="summon_consumable" onclick="select_summon_pre_buff(\''+h+"')\">"+k+"</span>")});b+="<br/><br/>";b+="</div>"}if(gamedata.current_summon!=void 0||a!=void 0&&a==1){a=Math.floor(gamedata.current_summon.loot_rarity*gamedata.current_summon.reward_count/card_drop_chance_reduction/all_available_cards[gamedata.current_summon.hero].value*100);if(all_available_cards[gamedata.current_summon.hero].recipe==void 0||gamedata.known_recipes[gamedata.current_summon.hero]!=void 0)a=Math.floor(gamedata.current_summon.loot_rarity*
gamedata.current_summon.reward_count/card_drop_chance_reduction/all_available_cards[gamedata.current_summon.hero].value*100);a>100&&(a=100);b+='<div class="summon_hero_container '+c+'">';c="";gamedata.owned_cards[gamedata.current_summon.hero]==void 0&&(c='</div><div class="new_card">NEW');f=parse_card(gamedata.current_summon.hero,c,!0,void 0);gamedata.known_recipes!=void 0&&gamedata.known_recipes[gamedata.current_summon.hero]==void 0&&all_available_cards[gamedata.current_summon.hero].recipe!=void 0&&
(e="unowned_summon");b+='<span class="'+e+'" onclick="show_card_details(\''+gamedata.current_summon.hero+"', true)\">"+f+"</span>";b+='<span class="summon_stats">';b+="<br/>";if(d.min_level!=10||d.max_level!=10||gamedata.current_summon.level!=10)b+="Power: "+Math.floor(gamedata.current_summon.level*10)+"%<br/>";b+="Drop: "+a+"%<br/>";b+="Tries: "+gamedata.current_summon.tries+"<br/>";b+="Reward: "+nFormatter(gamedata.current_summon.reward_count,3)+"<br/>";b+="<br/>";b+="</span>";b+='<div class="menu_button slim summon button" onclick="endless_waves=false;selected_post_summon_buff=\'\'" data-target-content="summoned_battle">FIGHT</div><br/><br/>';
selected_post_summon_buff!=""&&all_available_cards[selected_post_summon_buff]!=void 0&&(b+='<div class="selected_pre_summon_buff_container">',b+='<span class="selected_pre_summon_buff">'+parse_card(selected_post_summon_buff)+"</span>",b+='<span class="selected_pre_summon_buff_text">'+all_available_cards[selected_post_summon_buff].name+"<br/>"+all_available_cards[selected_post_summon_buff].description+"</span>",b+='<div class="menu_button slim summon button use_summon_pre_buff_button" onclick="use_summon_post_buff(\''+
selected_post_summon_buff+"')\">USE</div>",b+="</div><br/>");$.each(all_available_cards,function(h,k){k.summon_post_buff!=void 0&&gamedata.owned_cards[h]!=void 0&&gamedata.owned_cards[h]>0&&(k=parse_card(h,gamedata.owned_cards[h]),b+='<span class="summon_consumable" onclick="select_summon_post_buff(\''+h+"')\">"+k+"</span>")});if(d.max_rarity>1||d.max_level>0)b+='<br/><br/><div class="menu_button slim summon button" onclick="clear_current_summon()" data-target-content="summon">CLEAR</div>';b+="</div>";
count_object(gamedata.summon_pre_buffs)>0&&(gamedata.summon_pre_buffs={},saveToLocalStorage())}$(".summon_container").html(b)}
function show_waves(){var a='<div class="summoned_hero_container">';var b=parse_card("conscription");a=a+("<span>"+b+'</span><br/><span class="summon_stats">Starting power: ')+(get_upgrade_factor("wave_min_power","any",!0)*10+"%<br/>");a+="Wave growth: "+Math.ceil(100/get_upgrade_factor("wave_power_increase","any",!0))/10+"%";a+="</span><br><br>";a+='<div class="menu_button slim summon button" onclick=\'endless_waves=true\' data-target-content="waves_battle">START</div>';a+="</div>";$(".waves_container").html(a)}
function adjust_summon_stats(a,b){all_available_cards[b]!=void 0&&all_available_cards[b].summon_pre_buff!=void 0&&$.each(all_available_cards[b].summon_pre_buff,function(c,e){e.buff_amount_type!=void 0&&e.buff_amount_type!="fixed"||a[e.buff_type]==void 0||(a[e.buff_type]+=e.buff_amount);e.buff_amount_type!=void 0&&e.buff_amount_type!="percent"||a[e.buff_type]==void 0||(a[e.buff_type]*=1+e.buff_amount/100)});return a}
function get_summon_stats(){gamedata.highest_summon_won==void 0&&(gamedata.highest_summon_won=0);gamedata.summon_min_power==void 0&&(gamedata.summon_min_power=1);var a=(gamedata.battles_won+1)/(gamedata.battles_lost*5+10)*10;var b=a*1.2;var c=get_upgrade_factor("summon_max_rarity","any",!0);return{min_rarity:get_upgrade_factor("summon_min_rarity","any",!0),max_rarity:c,common_reduction:c,min_level:a,max_level:b,max_tries:get_upgrade_factor("summon_tries","any",!0),reward_bonus:get_upgrade_factor("summon_reward",
"any",!0),loot_rarity:get_upgrade_factor("summon_loot_rarity","any",!0),drop_chance:0,max_pre_buffs:get_upgrade_factor("summon_max_pre_buffs","any",!0)}}function correct_summon_stats(a){$.each(a,function(b,c){c<0&&(a[b]=0);b!="reward_bonus"&&b!="max_level"&&b!="min_level"&&(a[b]=Math.floor(a[b]))});a.max_rarity<a.min_rarity&&(a.max_rarity=a.min_rarity);a.min_level<1&&(a.min_level=1);a.min_level>a.max_level&&(a.min_level=a.max_level);return a}
function clear_current_summon(){delete gamedata.current_summon}function show_summoned_battle(){--gamedata.current_summon.tries;saveToLocalStorage();enemy_card_back="";endless_waves=!1;current_battle_type="summoned";show_content("battle")}function show_waves_battle(){all_current_rewards={};enemy_card_back="";endless_waves=!0;endless_wave_count=1;current_battle_type="summoned";show_content("battle")}
function summon_now(a){var b=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(e,d){b=adjust_summon_stats(b,d)});correct_summon_stats(b);var c=get_random_hero(!0,b.min_rarity,b.max_rarity,b.common_reduction);a!=void 0&&a==1&&all_available_cards[current_altar]!=void 0&&gamedata.owned_cards[current_altar]!=void 0&&gamedata.owned_cards[current_altar]>0&&(c=current_altar,--gamedata.owned_cards[current_altar],current_altar="");a=b.min_level+Math.random()*(b.max_level-b.min_level);gamedata.current_summon=
{hero:c,tries:b.max_tries,level:a,loot_rarity:b.loot_rarity,reward_count:round_by_percent(20*b.reward_bonus*get_effective_power_factor(a)*(1+a/100))};selected_post_summon_buff=selected_pre_summon_buff="";saveToLocalStorage();show_summon(!0)}function select_summon_pre_buff(a){selected_pre_summon_buff=selected_pre_summon_buff!=a?a:"";show_summon()}function select_summon_post_buff(a){selected_post_summon_buff=selected_post_summon_buff!=a?a:"";show_summon()}
function use_summon_pre_buff(a){var b=get_summon_stats();gamedata.summon_pre_buffs==void 0&&(gamedata.summon_pre_buffs={});if(gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>0&&count_object(gamedata.summon_pre_buffs)<b.max_pre_buffs&&all_available_cards[a]!=void 0&&all_available_cards[a].summon_pre_buff!=void 0){for(var c=!1,e=1;e<b.max_pre_buffs+1;e++)gamedata.summon_pre_buffs[e]==void 0&&c==0&&(c=e);gamedata.summon_pre_buffs[c]=a;gain_card(a,-1);saveToLocalStorage();show_summon()}}
function remove_prebuff(a){gamedata.summon_pre_buffs[a]!=void 0&&all_available_cards[gamedata.summon_pre_buffs[a]]!=void 0&&(gain_card(gamedata.summon_pre_buffs[a],1),delete gamedata.summon_pre_buffs[a],saveToLocalStorage(),show_summon())}
function use_summon_post_buff(a){if(gamedata.owned_cards[a]!=void 0&&gamedata.owned_cards[a]>0&&all_available_cards[a]!=void 0&&all_available_cards[a].summon_post_buff!=void 0){var b=!1,c=all_available_cards[a].summon_post_buff;gamedata.current_summon["unbuffed_"+c.buff_type]==void 0&&(gamedata.current_summon["unbuffed_"+c.buff_type]=gamedata.current_summon[c.buff_type]+0);gamedata.current_summon[c.buff_type]!=void 0&&c.buff_amount_type=="fixed"&&(c.buff_amount>0||gamedata.current_summon[c.buff_type]+
c.buff_amount>0)&&(gamedata.current_summon[c.buff_type]+=c.buff_amount,b=!0);gamedata.current_summon[c.buff_type]!=void 0&&c.buff_amount_type=="percent"&&(c.buff_amount>0||gamedata.current_summon[c.buff_type]+c.buff_amount>0)&&(gamedata.current_summon[c.buff_type]+=Math.ceil(c.buff_amount/100*gamedata.current_summon["unbuffed_"+c.buff_type]),b=!0);b==1&&(gain_card(a,-1),gamedata.owned_cards[a]<1&&(selected_post_summon_buff=""),saveToLocalStorage(),show_summon())}}var current_altar="";
function show_altar(){var a="",b="",c=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(f,g){c=adjust_summon_stats(c,g)});correct_summon_stats(c);var e=(c.max_level-c.min_level)/2+c.min_level;a+='<div class="summoned_hero_container">';var d=parse_card("empty_card");all_available_cards[current_altar]!=void 0&&(gamedata.known_recipes!=void 0&&gamedata.known_recipes[current_altar]==void 0&&all_available_cards[current_altar].recipe!=void 0&&(b="unowned_summon"),d='<span class="'+b+'" onclick="show_card_details(\''+
current_altar+"', true)\">"+parse_card(current_altar)+"</span>");a+="<span>"+d+'</span><span class="summon_stats"><br/>';if(c.min_level!=10||c.max_level!=10)a+="Power: "+Math.floor(c.min_level*10),c.min_level!=c.max_level&&(a+=" - "+Math.ceil(c.max_level*10)),a+="%<br/>";current_altar==void 0||all_available_cards[current_altar]==void 0?a+="Max rarity: "+Math.floor(c.max_rarity*get_upgrade_factor("altar_rarity","any",!0)):(b=Math.floor(c.loot_rarity*round_by_percent(20*c.reward_bonus*get_effective_power_factor(e)*
(1+e/100))/card_drop_chance_reduction/all_available_cards[current_altar].value*100),b>100&&(b=100),a+="Drop chance: ~"+b+"%");a+="<br/>";a+="Tries: "+c.max_tries+"<br/>";a+="Reward: "+nFormatter(Math.floor(c.reward_bonus*100),3)+"%<br/>";a+="<br/>";a+="</span>";current_altar==""?a+='<div class="menu_button slim summon button" data-target-content="choose_altar">CHOOSE</div><br/><br/>':(a+='<div class="menu_button slim summon button" onclick="show_content(\'summon\');summon_now(true)" no-new-page="true">SACRIFICE</div><br/><br/>',
a+='<div class="menu_button slim summon button" onclick="current_altar=\'\'" data-target-content="altar">CLEAR</div><br/><br/>');a+="</div>";$(".altar_container").html(a)}var current_show_altar_page=1;
function show_choose_altar(){var a=get_summon_stats();$.each(gamedata.summon_pre_buffs,function(e,d){a=adjust_summon_stats(a,d)});var b=a.max_rarity*get_upgrade_factor("altar_rarity","any",!0);cards_per_page=12;$(".choose_altar_container").html('<span class="no_tinker">You have no cards that match your filter.</span>');gamedata.owned_cards=sortObj(gamedata.owned_cards);var c=0;$.each(gamedata.owned_cards,function(e,d){if(all_available_cards[e]!=void 0){d+=0;var f=!1;if(all_available_cards[e].hero_version==
void 0||all_available_cards[e].value>b)f=!0;d>0&&f==0&&check_filters(e)==0&&(c++,c==1&&$(".choose_altar_container").html(""),c/cards_per_page>current_show_altar_page-1&&c/cards_per_page<=current_show_altar_page&&(d=parse_card(e,d),$(".choose_altar_container").append("<span onclick=\"current_altar='"+e+"';show_content('altar');\">"+d+"</span>")))}else delete gamedata.owned_cards[e]});current_show_altar_page==1?$(".page_selection .previous_page").addClass("no_page"):$(".page_selection .previous_page").removeClass("no_page");
c/cards_per_page<=current_show_altar_page?$(".page_selection .next_page").addClass("no_page"):$(".page_selection .next_page").removeClass("no_page");c>0&&Math.ceil(c/cards_per_page)<current_show_altar_page&&(current_show_altar_page=1,show_choose_altar());c==0?$(".page_selection .page_number").addClass("no_page"):$(".page_selection .page_number").removeClass("no_page");$(".page_selection .page_number").html(current_show_altar_page+" / "+Math.ceil(c/cards_per_page))}
function set_altar_page(a){current_show_altar_page+=a;current_show_altar_page<1&&(current_show_altar_page=1);show_choose_altar()}var floating_text_amount=0;
function parse_floating_text(a,b,c){floating_text_amount++;var e="",d=Math.floor(Math.random()*40)+40,f=Math.floor(Math.random()*40)+40,g=floating_text_amount+"";return e=(c==void 0||c==0?e+('<div class="floating_text floating_text_'+g+'" style="top:'+f+"%;left:"+d+"%;color:"+b+'">'):e+('<div class="floating_text down floating_text_'+g+'" style="left:'+d+"%;color:"+b+'">'))+a+"</div>"}
var units_left_to_process={},all_timeouts={},next_turn_timeout,timeout_key=0,latest_result=0,latest_slot=-10,current_rewards={},amount_reduced=0,game_paused=!1,ready_to_resume=!1,hand_slot_id=0,highest_unit_id=3,passive_effect_count=0,pickup_rewards={},next_action_timeout;
function start_next_turn(){$(".turn_pointer").removeClass("turn_pointer_1");$(".turn_pointer").removeClass("turn_pointer_2");$(".turn_pointer").addClass("turn_pointer_"+active_turn);current_phase="";total_timeout<0&&(total_timeout=0);total_turn_counter++;$(".total_turn_counter").html(total_turn_counter);$(".resign_button").css("display","block");reduce_all_ability_delays(active_turn);enable_all_units_to_act(!0,active_turn);reset_temp_health(active_turn);reset_temp_skills(active_turn);if(total_turn_counter>=
80){total_timeout+=500;$(".total_turn_counter_container").css("color","#f00");for(var a=0;a<=5;a++)$.each(battle_info.combat_units,function(c,e){e.slot==a&&e.side==active_turn&&(receive_damage(c,void 0,Math.floor(total_turn_counter/5)-15,[]),check_unit_alive(c))})}var b=total_turn_counter/160/3*get_upgrade_factor("floating_chance","any",!0);b>.5&&(b=.5);Math.random()<b&&spawn_monthly_pickup();current_phase="start_turn";next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},
total_timeout)}var current_phase="",turn_phases={start_turn:!0,draw_card:!0,combat_start:!0,basic:!1,end_turn:!0};
function end_this_turn(){reset_temp_power(active_turn);active_turn=active_turn==1?2:1;var a=fight_number+0;if(battle_info.combat_units[2].current_health>0&&battle_info.combat_units[1].current_health>0&&combat_alive==1)next_action_timeout=setTimeout(function(){game_paused==0?a==fight_number?start_next_turn():console.log(a+" != "+fight_number):ready_to_resume=!0},total_timeout);else if(combat_alive==1){if(battle_info.combat_units[2].current_health>0&&battle_info.combat_units[1].current_health<1){if(check_quests("battle_won_any"),
check_quests("battle_won_type_"+current_battle_type),get_effective_power_factor(difficulty_setting)>=1&&(check_quests("battle_won_any_turn_count",total_turn_counter),check_quests("battle_won_"+current_battle_type+"_turn_count",total_turn_counter)),check_quests("battle_won_any_health_left_"+battle_info.combat_units[2].current_health),$(".unit_type_artifact.side_1").addClass("dead"),current_battle_type=="summoned"){$(".turn_pointer").addClass("hidden");if(endless_waves==1){var b=battle_info.combat_units[1].card_type;
battle_info.combat_units[1].original_card_type!=void 0&&(b=battle_info.combat_units[1].original_card_type);var c=round_by_percent(20*get_upgrade_factor("summon_reward","any",!0)*get_effective_power_factor(difficulty_setting)*(1+difficulty_setting/100));b=add_basic_win_rewards(c,b,!0);b==1?total_timeout+=1E3:$(".unit_id_1").addClass("dead");check_quests("battle_won_number_wave",endless_wave_count);endless_wave_count+=1;endless_waves=!0;current_battle_type="summoned";timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){clear_all_timeouts();$(".projectile").remove();show_content("battle")},total_timeout+1E3);check_quests("battle_won_wave");get_effective_power_factor(difficulty_setting)>=1&&check_quests("battle_won_wave_turn_count",total_turn_counter);check_quests("battle_won_wave_health_left_"+battle_info.combat_units[1].current_health)}else gamedata.battles_won++,all_current_rewards={},current_reward_text="You won the battle!",gamedata.summon_min_power==void 0&&(gamedata.summon_min_power=1),
gamedata.summon_min_power+=1,b=battle_info.combat_units[1].card_type,battle_info.combat_units[1].original_card_type!=void 0&&(b=battle_info.combat_units[1].original_card_type),b=add_basic_win_rewards(20,b),b==1?total_timeout+=1E3:$(".unit_id_1").addClass("dead"),current_reward_origin="summon",timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){show_content("current_rewards")},total_timeout+1E3),check_quests("battle_won_summoned"),get_effective_power_factor(difficulty_setting)>=1&&check_quests("battle_won_summoned_turn_count",
total_turn_counter),check_quests("battle_won_summoned_health_left_"+battle_info.combat_units[1].current_health);$(".side_1.type_artifact").addClass("dead")}}else $(".turn_pointer").addClass("hidden"),$(".unit_id_2").addClass("dead"),$(".unit_type_artifact.side_2").addClass("dead"),battle_info.combat_units[2].current_health<1&&battle_info.combat_units[1].current_health<1?(endless_waves!=1&&gamedata.battles_tied++,check_quests("battle_tie_any")):(endless_waves!=1&&gamedata.battles_lost++,gamedata.summon_min_power*=
.75,check_quests("battle_loss_any"),check_quests("battle_loss_any_turn_count",total_turn_counter),check_quests("battle_loss_"+current_battle_type+"_turn_count",total_turn_counter),check_quests("battle_loss_any_health_left_"+battle_info.combat_units[1].current_health)),endless_waves==1?(current_reward_origin="waves",current_reward_text="You defeated "+(endless_wave_count-1)+" waves!",timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){show_content("current_rewards")},total_timeout+1E3)):
(timeout_key++,next_turn_timeout=setTimeout(function(){clear_all_timeouts();end_combat()},total_timeout+1E3));combat_alive=!1;saveToLocalStorage()}}var process_counter=0,all_counter_timeouts={};
function process_next_unit(a,b){var c=nowint();check_all_ready_cards();var e=find_next_unit_to_act(active_turn);e!=0?(process_single_unit(e,void 0,b,a),next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},total_timeout)):(current_phase=find_next_phase(),enable_all_units_to_act(!1,active_turn),current_phase!=0?(current_phase=="draw_card"&&(reduce_all_hand_times(active_turn),check_all_ready_cards(),draw_card(active_turn,void 0,void 0,void 0),current_phase=
find_next_phase()),next_action_timeout=setTimeout(function(){process_next_unit(current_phase,turn_phases[current_phase])},total_timeout)):next_action_timeout=setTimeout(function(){end_this_turn()},total_timeout));total_timeout=0;a=nowint()-c;if(a>10){process_counter++;var d=process_counter+0;$(".all_save_icons").append('<div class="saving_icon save_'+d+' save_danger" style="width:'+a/2+'px"></div>');all_counter_timeouts[d]=setTimeout(function(){$(".save_"+d).remove();clearTimeout(all_counter_timeouts[d]);
delete all_counter_timeouts[d]},1E3)}total_timeout+=a}function find_next_phase(){var a=!1,b=!1;$.each(turn_phases,function(c,e){b==1&&a==0&&(a=c);c==current_phase&&a==0&&(b=!0)});return a}function find_next_unit_to_act(a){for(var b=!1,c=-5;c<=5;c++)$.each(battle_info.combat_units,function(e,d){b==0&&d.acted_this_turn<1&&d.slot==c&&combat_alive==1&&(d.failed_to_act_this_phase==void 0||d.failed_to_act_this_phase==0)&&(b=e)});return b}
function add_basic_win_rewards(a,b,c){var e=1+gamedata.loot_rarity/100;a==void 0&&(a=20);current_battle_type=="summoned"&&gamedata.current_summon!=void 0&&endless_waves==0&&(a=gamedata.current_summon.reward_count,gamedata.current_summon.loot_rarity!=void 0&&(e=gamedata.current_summon.loot_rarity));current_battle_type=="summoned"&&endless_waves==1&&(e=get_upgrade_factor("summon_loot_rarity","any",!0));gamedata.loot_charges==void 0&&(gamedata.loot_charges=0);gamedata.loot_rarity==void 0&&(gamedata.loot_rarity=
0);gamedata.loot_charges>0&&(a+=gamedata.loot_charges);gamedata.loot_charges=0;gamedata.loot_rarity=0;endless_waves==0&&(current_rewards={});fixed_hero!=0&&all_enemy_heroes[fixed_hero]!=void 0&&all_enemy_heroes[fixed_hero].drops!=void 0&&$.each(all_enemy_heroes[fixed_hero].drops,function(k,l){l=round_by_percent(Math.random()*l);l>0&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:k,reward_amount:l},c!=void 0&&c==1&&show_drop(k,l))});var d=!1;b!=void 0&&all_available_cards["recipe_"+
b]!=void 0&&(gamedata.known_recipes==void 0||gamedata.known_recipes[b]==void 0)&&Math.random()<e*a/card_drop_chance_reduction/all_available_cards[b].value&&all_available_cards[b].recipe!=void 0&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"recipe_"+b,reward_amount:1},a-=Math.ceil(all_available_cards[b].value/2),c!=void 0&&c==1&&show_drop("recipe_"+b,1),gamedata.known_recipes==void 0&&(gamedata.known_recipes={}),gamedata.known_recipes[b]=!0);b!=void 0&&(Math.random()<
e*a/card_drop_chance_reduction/all_available_cards[b].value&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:b,reward_amount:1},a-=Math.ceil(all_available_cards[b].value/2),d=!0,$(".unit_id_1").removeClass("side_1"),$(".unit_id_1").addClass("side_2"),$(".unit_id_1").addClass("won_hero")),$.each(all_available_cards[b].loot,function(k,l){Math.random()*100<l&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:k,reward_amount:1,pickable:!0},
c!=void 0&&c==1&&show_drop(k,1))}));if(b!=void 0&&all_available_cards[b]!=void 0){var f=all_available_cards[b].value,g={};$.each(all_available_cards,function(k,l){l.value<=f&&(gamedata.known_recipes==void 0||gamedata.known_recipes[k]==void 0||l.recipe==void 0)&&l.pick_chance>0&&(l.type=="spell"||l.type=="artifact"||(l.type=="structure"||l.type=="creature")&&l.pick_chance>0&&l.hero_version==void 0)&&(l.recipe!=void 0?g["recipe_"+k]=1/l.value:g[k]=1/l.value)});if(count_object(g)>0){var h=get_random_key_from_object_based_on_num_value(g);
Math.random()<e*a/card_drop_chance_reduction/all_available_cards[b].value&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:h,reward_amount:1},c!=void 0&&c==1&&show_drop(h,1),a-=Math.ceil(all_available_cards[h].value/2),all_available_cards[h].type=="recipe"&&(gamedata.known_recipes==void 0&&(gamedata.known_recipes={}),gamedata.known_recipes[all_available_cards[h].recipe]=!0))}}current_battle_type!="daily"?(b=get_random_key_from_object_based_on_num_value(random_loot_drops),
b!=void 0&&all_available_cards[b]!=void 0&&(h=e*a/card_drop_chance_reduction/sqr(all_available_cards[b].value)*get_upgrade_factor("loot_drop_chance",b,!0),Math.random()<h&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:b,reward_amount:1},c!=void 0&&c==1&&show_drop(b,1)))):$.each(random_loot_drops,function(k,l){k!=void 0&&all_available_cards[k]!=void 0&&(l=e*a/card_drop_chance_reduction/sqr(all_available_cards[k].value),l>.5&&(l=.5),Math.random()<l&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+
1]={reward_id:k,reward_amount:1},c!=void 0&&c==1&&show_drop(k,1),a-=all_available_cards[k].value))});a>0&&(all_current_rewards[get_highest_key_in_object(all_current_rewards)+1]={reward_id:"scraps",reward_amount:a});return d}var loot_drop_counter=0;
function show_drop(a,b){loot_drop_counter++;var c=loot_drop_counter+0,e=parse_card(a,b);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append('<div class="loot_drop unit side_1 slot_0 loot_drop_'+c+'">'+e+"</div>")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".loot_drop_"+c).addClass("dropped")},total_timeout+100);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".loot_drop_"+c).removeClass("dropped");$(".loot_drop_"+
c).addClass("picked_up");$(".loot_drop_"+c).removeClass("side_1");$(".loot_drop_"+c).addClass("side_2")},total_timeout+600);total_timeout+=500}function gain_reward(a){$(".detail_overlay").removeClass("non_clickable");if(current_rewards[a]!=void 0){for(var b=0;b<current_rewards[a].card_amount;b++)gain_card(current_rewards[a].card_id);show_card_details(current_rewards[a].card_id)}current_rewards={}}
function process_single_unit(a,b,c,e){e==void 0&&(e="basic");var d=!1,f=battle_info.combat_units[a];f.acted_this_turn<1&&combat_alive==1&&(f.effects==void 0||f.effects.stunned==void 0||f.effects.stunned==0||c!=void 0&&c==1)?($.each(f.abilities,function(g,h){var k=all_abilities[g];battle_info.combat_units[a]!=void 0&&(f.effects.stunned==void 0||f.effects.stunned==0||c!=void 0&&c==1)&&k.proc!=void 0&&(match_array_values(k.proc,e)==1||b==1&&match_array_values(k.proc,"on_play")==1&&e=="basic")&&(f.ability_delays[g]==
void 0||f.ability_delays[g]<1)&&process_ability(a,k,h,a,void 0,e)==1&&(d=!0,check_ability_delay(a,g))}),d==1&&(total_timeout+=1E3*battle_speed),d==1&&battle_info.combat_units[a]!=void 0?f.acted_this_turn+=1:f.failed_to_act_this_phase=!0):e=="basic"?(f.effects!=void 0&&f.effects.stunned!=void 0&&f.effects.stunned>0&&process_passive_effect(a,"stunned",f.effects.stunned),f.acted_this_turn+=1,f.acted_this_turn>0&&(f.failed_to_act_this_phase=!0)):f.failed_to_act_this_phase=!0;battle_info.combat_units[a]==
void 0||c!=void 0&&c!=0||($.each(f.effects,function(g,h){h>0&&battle_info.combat_units[a]!=void 0&&g!="stunned"&&process_passive_effect(a,g,h)}),battle_info.combat_units[a]!=void 0&&update_passive_effects(a));return d}function reset_temp_skills(a){$.each(battle_info.combat_units,function(b,c){combat_alive==1&&c.side==a&&c.temp_skills!=void 0&&count_object(c.temp_skills)>0&&($.each(c.temp_skills,function(e,d){grant_skill(b,b,-1*d,e,!1);delete c.temp_skills[e]}),check_visible_skills(b))})}
function reset_temp_health(a){$.each(battle_info.combat_units,function(b,c){combat_alive==1&&c.side==a&&c.armor!=void 0&&c.armor!=0&&(total_timeout+=500*battle_speed,c.armor=0,check_unit_hp(b));combat_alive==1&&c.side==a&&c.temp_health!=void 0&&c.temp_health!=0&&(total_timeout+=500*battle_speed,c.temp_health>0&&--c.temp_health,c.temp_health<0&&(c.temp_health+=1),check_unit_hp(b),check_unit_alive(b))})}
function reset_temp_power(a){$.each(battle_info.combat_units,function(b,c){combat_alive==1&&c.side==a&&c.temp_power!=void 0&&c.temp_power<0&&(total_timeout+=500*battle_speed,c.temp_power=0,check_unit_power(b))})}
function reduce_all_ability_delays(a){$.each(battle_info.combat_units,function(b,c){if(combat_alive==1&&c.side==a){var e=!1;c.ability_delays==void 0&&(c.ability_delays={});$.each(c.ability_delays,function(f,g){c.ability_delays[f]>0&&(--c.ability_delays[f],e=!0)});if(e==1){var d=parse_abilities(b);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+b+" .card_abilities").html(d)},total_timeout)}battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].effects==
void 0&&(battle_info.combat_units[b].effects={})}})}
function check_ability_delay(a,b){if(battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].abilities[b]!=void 0){var c=all_abilities[b],e=battle_info.combat_units[a],d=e.abilities[b];c.delay!=void 0&&d.delay==void 0&&(e.ability_delays[b]=calculate_effect({amount:c.delay},void 0,a,d));battle_info.combat_units[a].abilities[b].delay!=void 0&&(e.ability_delays[b]=calculate_effect({amount:battle_info.combat_units[a].abilities[b].delay},void 0,a,battle_info.combat_units[a].abilities[b]))}}
function check_unopposed_ally(a){for(var b=!1,c=1;c<=5;c++){var e=!1,d=!1;$.each(battle_info.combat_units,function(f,g){g.side==a&&g.slot==c&&(e=!0);g.side!=a&&g.slot==c&&(d=!0)});e==1&&d==0&&(b=!0)}return b}
function process_passive_effect(a,b,c){if(battle_info.combat_units[a]!=void 0&&b=="burning"&&combat_alive==1){var e=Math.ceil(battle_info.combat_units[a].effects.burning/2);create_projectile(a,a,"burn",!1,void 0,battle_info.combat_units[a].side,void 0,void 0,void 0,!0);receive_damage(a,void 0,e,["fire","burning"]);battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[a].effects.burning-=e,update_passive_effects(a),check_unit_alive(a));total_timeout+=500*battle_speed}battle_info.combat_units[a]!=
void 0&&b=="poisoned"&&combat_alive==1&&(create_projectile(a,a,"poison",!1,void 0,battle_info.combat_units[a].side,void 0,void 0,void 0,!0),receive_damage(a,void 0,Math.ceil(c/2),["poisoned","ignores_armor"]),battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[a].effects.poisoned=Math.floor(battle_info.combat_units[a].effects.poisoned/2),update_passive_effects(a),check_unit_alive(a)),total_timeout+=500*battle_speed);battle_info.combat_units[a]!=void 0&&b=="stunned"&&combat_alive==1&&(--battle_info.combat_units[a].effects.stunned,
battle_info.combat_units[a]!=void 0&&update_passive_effects(a),total_timeout+=500*battle_speed);battle_info.combat_units[a]!=void 0&&b=="doom"&&combat_alive==1&&Math.random()<=c/10&&(timeout_key++,passive_effect_count++,create_projectile(a,a,"doom",!1,void 0,battle_info.combat_units[a].side,void 0,void 0,void 0,!0),total_timeout-=250*battle_speed,check_unit_alive(a,void 0,!0),total_timeout+=750*battle_speed)}var skills_to_show_icon={explode:"bomb",wounded:"wound",blessed:"bless"};
function update_passive_effects(a){timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a+" .unit_effects").html("")},total_timeout);$.each(battle_info.combat_units[a].effects,function(b,c){c>0&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a+" .unit_effects").prepend('<div class="effect_'+b+'">'+c+"</div>")},total_timeout))});$.each(battle_info.combat_units[a].abilities,function(b,c){c>0&&skills_to_show_icon[b]!=void 0&&(timeout_key++,all_timeouts[timeout_key]=
setTimeout(function(){$(".unit_id_"+a+" .unit_effects").prepend('<div class="projectile_'+skills_to_show_icon[b]+'">'+c+"</div>")},total_timeout))});check_visible_skills(a)}
function process_ability(a,b,c,e,d,f,g){if(battle_info.combat_units[a]!=void 0){d==void 0&&(d=!1);var h=!0;battle_info.combat_units[a]==void 0&&(h=!1);b.need_power!=void 0&&b.need_power==1&&calculate_effect({amount:"origin_power"},void 0,a,void 0)<1&&(h=!1);b.need_armor!=void 0&&b.need_armor==1&&battle_info.combat_units[a].armor<1&&(h=!1);b.unopposed_ally!=void 0&&b.unopposed_ally==1&&check_unopposed_ally(battle_info.combat_units[a].side)==0&&(h=!1);b.origin_type==void 0||battle_info.combat_units[e]!=
void 0&&b.origin_type==battle_info.combat_units[e].type||(h=!1);b.origin_damaged!=void 0&&(battle_info.combat_units[e]==void 0||battle_info.combat_units[e].health<=battle_info.combat_units[e].current_health)&&(h=!1);b.origin_does_not_have_ability!=void 0&&battle_info.combat_units[e]!=void 0&&$.each(battle_info.combat_units[e].abilities,function(w,x){match_array_values(b.origin_does_not_have_ability,[w])==1&&(h=!1)});b.origin_has_opposing!=void 0&&battle_info.combat_units[e]!=void 0&&(b.origin_has_opposing==
0&&count_object(filter_targets_by_has_no_opposing({0:e}))==0&&(h=!1),b.origin_has_opposing==1&&count_object(filter_targets_by_has_no_opposing({0:e}))>0&&(h=!1));b.origin_has_effect!=void 0&&battle_info.combat_units[e]!=void 0&&(battle_info.combat_units[e].effects==void 0||battle_info.combat_units[e].effects[b.origin_has_effect]==void 0||battle_info.combat_units[e].effects[b.origin_has_effect]<1)&&(h=!1);b.this_has_effect!=void 0&&battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[a].effects==
void 0||battle_info.combat_units[a].effects[b.this_has_effect]==void 0||battle_info.combat_units[a].effects[b.this_has_effect]<1)&&(h=!1);b.max_enemy_units!=void 0&&count_enemy_units(battle_info.combat_units[a].side)>b.max_enemy_units&&(h=!1);b.max_ally_units!=void 0&&count_ally_units(battle_info.combat_units[a].side)>b.max_ally_units&&(h=!1);b.min_ally_units!=void 0&&count_ally_units(battle_info.combat_units[a].side)<b.min_ally_units&&(h=!1);b.min_enemy_units!=void 0&&count_enemy_units(battle_info.combat_units[a].side)<
b.min_enemy_units&&(h=!1);b.min_unopposed_enemy_units!=void 0&&count_unopposed_enemy_units(battle_info.combat_units[a].side)<b.min_unopposed_enemy_units&&(h=!1);b.min_double_free_slots!=void 0&&count_double_free_slots()<b.min_double_free_slots&&(h=!1);b.min_units!=void 0&&count_ally_units(battle_info.combat_units[a].side)+count_enemy_units(battle_info.combat_units[a].side)<b.min_units&&(h=!1);b.max_ally_artifacts!=void 0&&count_ally_artifacts(battle_info.combat_units[a].side)>calculate_effect({amount:b.max_ally_artifacts},
void 0,e,c)&&(h=!1);b.min_enemy_artifacts!=void 0&&count_enemy_artifacts(battle_info.combat_units[a].side)<calculate_effect({amount:b.min_enemy_artifacts},void 0,e,c)&&(h=!1);b.have_free_adjacent_slot!=void 0&&find_free_slot(battle_info.combat_units[a].side,battle_info.combat_units[a].card_type,"none","adjacent_of_origin",void 0,a)==0&&(h=!1);b.cannot_proc_while_stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned>0&&(h=!1);match_array_values(b.proc,
"basic")==1&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned>0&&(h=!1);b.min_cards_in_deck!=void 0&&count_deck_cards(battle_info["deck_"+battle_info.combat_units[a].side])<b.min_cards_in_deck&&(h=!1);b.min_enemy_cards_in_deck!=void 0&&(battle_info.combat_units[a].side==1&&count_deck_cards(battle_info.deck_2)<b.min_enemy_cards_in_deck&&(h=!1),battle_info.combat_units[a].side==2&&count_deck_cards(battle_info.deck_1)<b.min_enemy_cards_in_deck&&(h=!1));
b.max_hand_cards!=void 0&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[a].side])>b.max_hand_cards&&(h=!1);b.min_ally_hand_cards!=void 0&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[a].side])<b.min_ally_hand_cards&&(h=!1);b.min_ally_creature_cards_in_grave!=void 0&&count_grave_cards(battle_info["deck_"+battle_info.combat_units[a].side],"creature")<b.min_ally_creature_cards_in_grave&&(h=!1);b.min_enemy_hand_cards!=void 0&&(battle_info.combat_units[a].side==1&&count_hand_cards(battle_info.deck_2)<
calculate_effect({amount:b.min_enemy_hand_cards},void 0,e,c)&&(h=!1),battle_info.combat_units[a].side==2&&count_hand_cards(battle_info.deck_1)<calculate_effect({amount:b.min_enemy_hand_cards},void 0,e,c)&&(h=!1));b.max_enemy_hand_cards!=void 0&&(battle_info.combat_units[a].side==1&&count_hand_cards(battle_info.deck_2)>=calculate_effect({amount:b.max_enemy_hand_cards},void 0,e,c)&&(h=!1),battle_info.combat_units[a].side==2&&count_hand_cards(battle_info.deck_1)>=calculate_effect({amount:b.max_enemy_hand_cards},
void 0,e,c)&&(h=!1));b.specific_proc==void 0||f!=void 0&&f==b.specific_proc||(h=!1);if(b.ability_effects!=void 0&&h==1)$.each(b.ability_effects,function(w,x){d=process_ability(a,x,c,e,d,f)});else if(h==1){b.remove_skill_before_use!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type!="spell"&&(set_skill(a,a,0,b.remove_skill_before_use,!1),check_visible_skills(a));var k=battle_info.combat_units[a].unit_id+0,l=1;b.proc_amount!=void 0&&(l=calculate_effect({amount:b.proc_amount},
a,a,c));b.min_proc_amount!=void 0&&l<b.min_proc_amount&&(l=calculate_effect({amount:b.min_proc_amount},a,a,c));b.proc_amount_adjustment!=void 0&&(l+=b.proc_amount_adjustment);b.need_to_be_alive!=void 0&&b.need_to_be_alive==1&&battle_info.combat_units[a].current_health==0&&(l=0);var p=total_timeout+0,n=total_timeout+0,q=0,m=!1;b.uses_power!=void 0&&b.uses_power==1&&a!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].temp_power!=void 0&&battle_info.combat_units[a].temp_power>
0&&battle_info.combat_units[a].temp_power>q&&(q=battle_info.combat_units[a].temp_power+0);for(var r=1;r<=l;r++){h=check_ability_can_fire(a,b,c,e);if(h==1&&(b.proc_chance==void 0||calculate_effect({amount:b.proc_chance,amount_factor:b.proc_factor},a,e,c)>=Math.random()*100)&&battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[a].current_health>0||battle_info.combat_units[a].health===!1||b.proc_while_dead!=void 0&&b.proc_while_dead==1)){var t={};$.each(b.targets,function(w,x){(count_object(t)==
0||x.add_targets!=void 0&&x.add_targets==1)&&combat_alive==1&&(t=find_targets(a,x,e,c,b,t))});if(count_object(t)>0&&combat_alive==1){b.animation==void 0||b.do_not_pause_between!=void 0&&r!=1||(typeof b.animation=="string"?(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+k).addClass(b.animation)},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+k).removeClass(b.animation)},total_timeout+1E3*battle_speed)):$.each(b.animation,function(w,
x){timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+k).addClass(x)},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+k).removeClass(x)},total_timeout+1E3*battle_speed)}),total_timeout+=500*battle_speed);var v=!0;$.each(t,function(w,x){h=check_ability_can_fire(a,b,c,e);battle_info.combat_units[a]!=void 0&&h==1&&$.each(b.effects,function(u,y){y.check_target_alive!=void 0&&(battle_info.combat_units[x]==void 0||battle_info.combat_units[x].current_health<
1)&&(v=!1);v==1&&(y.proc_chance==void 0||y.proc_chance>Math.random()*100)&&(b.do_not_pause_between!=void 0&&b.do_not_pause_between==1&&(total_timeout=p+0),m=process_effect(x,a,y,c),b.do_not_pause_between!=void 0&&b.do_not_pause_between==1&&n<total_timeout&&(n=total_timeout+0),m==0&&(v=!1),m==1&&d==0&&(d=!0));g!=void 0&&g!=1||check_unit_alive(x,a,void 0,y.subtypes)})});total_timeout<n&&(total_timeout=n);d==1&&b.reduce_skill_after_use!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type!=
"spell"&&(grant_skill(a,a,-1,b.reduce_skill_after_use,!1),check_visible_skills(a));d==1&&b.remove_skill_after_use!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type!="spell"&&(set_skill(a,a,0,b.remove_skill_after_use,!1),check_visible_skills(a))}}d==1&&b.on_each_success!=void 0&&battle_info.combat_units[a]!=void 0&&(d=process_ability(a,b.on_each_success,c,e,d))}}d==1&&battle_info.combat_units[a]!=void 0&&q>0&&(battle_info.combat_units[a].temp_power-=q,q=0,check_unit_power(a));
b.remove_skill!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type!="spell"&&(set_skill(a,a,0,b.remove_skill,!1),check_visible_skills(a),update_passive_effects(a));d==1&&b.animation!=void 0&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+k).removeClass(b.animation)},total_timeout+10));d==1&&b.adjust_skill_after_use!=void 0&&battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type!="spell"&&(set_skill(a,a,c+b.adjust_skill_after_use.amount,
b.adjust_skill_after_use.skill_id),check_visible_skills(a));battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].type=="artifact"&&(count_object(battle_info.combat_units[a].abilities)<1||count_object(battle_info.combat_units[a].abilities)==1&&(battle_info.combat_units[a].abilities.delay!=void 0||battle_info.combat_units[a].abilities.eternal!=void 0||battle_info.combat_units[a].abilities.restless!=void 0))&&check_unit_alive(a,void 0,!0);d==0&&b.on_failure!=void 0&&battle_info.combat_units[a]!=
void 0&&(d=process_ability(a,b.on_failure,c,e,d));d==1&&b.on_success!=void 0&&battle_info.combat_units[a]!=void 0&&(d=process_ability(a,b.on_success,c,e,d));d==1&&battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[a].used_ability=!0)}return d}function check_adjacent(a,b){var c=battle_info.combat_units[a],e=c.side,d=!1;$.each(battle_info.combat_units,function(f,g){g.slot!=c.slot+1&&g.slot!=c.slot-1||g.side!=e||b!="any"&&b!=g.type||(d=!0)});return d}
function check_ability_can_fire(a,b,c,e){c=!0;battle_info.combat_units[a]!=void 0?(b.own_max_hp!=void 0&&battle_info.combat_units[a].current_health>b.own_max_hp&&(c=!1),b.cannot_proc_while_stunned!=void 0&&b.cannot_proc_while_stunned==1&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned>0&&(c=!1),b.has_used_ability!=void 0&&b.has_used_ability==1&&battle_info.combat_units[a].used_ability!=void 0&&battle_info.combat_units[a].used_ability==0&&(c=!1),b.has_used_ability!=
void 0&&b.has_used_ability==0&&battle_info.combat_units[a].used_ability!=void 0&&battle_info.combat_units[a].used_ability==1&&(c=!1),b.has_no_adjacent!=void 0&&check_adjacent(a,b.has_no_adjacent)==1&&(c=!1),b.has_adjacent!=void 0&&check_adjacent(a,b.has_adjacent)==0&&(c=!1),battle_info.combat_units[a].current_health!=0||battle_info.combat_units[a].health===!1||b.proc_while_dead!=void 0&&b.proc_while_dead!=0||(c=!1),b.max_ally_units!=void 0&&count_ally_units(battle_info.combat_units[a].side)>b.max_ally_units&&
(c=!1),b.min_ally_units!=void 0&&count_ally_units(battle_info.combat_units[a].side)<b.min_ally_units&&(c=!1),b.min_enemy_units!=void 0&&count_enemy_units(battle_info.combat_units[a].side)<b.min_enemy_units&&(c=!1),b.min_cards_in_deck!=void 0&&count_deck_cards(battle_info["deck_"+battle_info.combat_units[a].side])<b.min_cards_in_deck&&(c=!1),b.max_hand_cards!=void 0&&count_hand_cards(battle_info["deck_"+battle_info.combat_units[a].side])>b.max_hand_cards&&(c=!1)):c=!1;return c}
function count_units(){var a=0;$.each(battle_info.combat_units,function(b,c){c.slot>0&&c.current_health!=void 0&&c.current_health>0&&a++});return a}function count_enemy_units(a,b){var c=0;$.each(battle_info.combat_units,function(e,d){d.side!=a&&d.slot>0&&d.current_health!=void 0&&d.current_health>0&&(b==void 0||b=="any"||b==d.type)&&c++});return c}
function count_unopposed_enemy_units(a){var b=0;$.each(battle_info.combat_units,function(c,e){if(e.side!=a&&e.slot>0&&e.current_health!=void 0&&e.current_health>0){var d=!0;$.each(battle_info.combat_units,function(f,g){e.slot==g.slot&&g.side==a&&(d=!1)});d==1&&b++}});return b}function count_double_free_slots(){for(var a=0,b=1;b<=5;b++){var c=!0;$.each(battle_info.combat_units,function(e,d){d.slot==b&&(c=!1)});c==1&&(a+=1)}return a}
function count_ally_units(a,b){var c=0;$.each(battle_info.combat_units,function(e,d){d.side==a&&d.slot>0&&d.current_health!=void 0&&d.current_health>0&&(b==void 0||b=="any"||b==d.type)&&c++});return c}function count_ally_artifacts(a){var b=0;$.each(battle_info.combat_units,function(c,e){e.side==a&&e.slot<0&&e.type=="artifact"&&b++});return b}function count_enemy_artifacts(a){var b=0;$.each(battle_info.combat_units,function(c,e){e.side!=a&&e.slot<0&&e.type=="artifact"&&b++});return b}
function process_effect(a,b,c,e){var d=calculate_effect(c,a,b,e),f=g,g=!0,h=!1,k=!1;battle_info.combat_units[a]!=void 0&&(c.set_latest_slot!=void 0&&c.set_latest_slot==1&&(latest_slot=battle_info.combat_units[a].slot),$.each(battle_info.combat_units[a].abilities,function(u,y){y=all_abilities[u].grants_immunities;y==void 0||match_array_values(y,c.subtypes)!=1||all_abilities[u].cannot_proc_while_stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=
0||(k=!0);battle_info.combat_units[b]!=void 0&&all_abilities[u].negated_by_ability!=void 0&&$.each(battle_info.combat_units[b].abilities,function(B,z){B==all_abilities[u].negated_by_ability&&(k=!1)})}));battle_info.combat_units[b]==void 0||battle_info.combat_units[b].used_effect!=void 0&&battle_info.combat_units[b].used_effect!=0||check_ability_procs(battle_info.combat_units[b].side,battle_info.combat_units[b].type+"_about_to_use_ability",b,c.subtypes);battle_info.combat_units[b]!=void 0&&(battle_info.combat_units[b].used_effect=
!0);if(battle_info.combat_units[b]!=void 0){battle_info.combat_units[a]!=void 0&&($.each(battle_info.combat_units[a].abilities,function(u,y){match_array_values(all_abilities[u].proc,["targeted_by"])!=1||all_abilities[u].subtypes!=void 0&&match_array_values(all_abilities[u].subtypes,c.subtypes)!=1||process_ability(a,all_abilities[u],y,b,void 0,"targeted_by");match_array_values(all_abilities[u].proc,["targeted_by_"+battle_info.combat_units[b].type])!=1||all_abilities[u].subtypes!=void 0&&match_array_values(all_abilities[u].subtypes,
c.subtypes)!=1||process_ability(a,all_abilities[u],y,b,void 0,"targeted_by")}),battle_info.combat_units[a].slot==0&&check_ability_procs(battle_info.combat_units[a].side,"hero_targeted_by",b,c.subtypes),battle_info.combat_units[a]!=void 0&&check_ability_procs(battle_info.combat_units[a].side,"ally_targeted_by",a,c.subtypes));if(battle_info.combat_units[b]!=void 0){var l=battle_info.combat_units[b].side+0;battle_info.combat_units[a]!=void 0&&$.each(battle_info.combat_units[a].abilities,function(u,y){if(match_array_values(all_abilities[u].proc,
"avoid_effect")){var B=match_array_values(all_abilities[u].subtypes,c.subtypes);B==1&&all_abilities[u].subtypes_while_origin_has_ability!=void 0&&battle_info.combat_units[b]!=void 0&&(battle_info.combat_units[b]==void 0?B=!1:$.each(all_abilities[u].subtypes_while_origin_has_ability,function(E,D){if(match_array_values(E,c.subtypes)){var C=!1;$.each(battle_info.combat_units[b].abilities,function(F,H){H>0&&match_array_values(F,D)&&(C=!0)});C==0&&(B=!1)}}));if(B==1){var z=calculate_effect({amount:all_abilities[u].effect},
a,b,y),A=Math.random()*100,G=!1;(all_abilities[u].cannot_proc_while_stunned==void 0||battle_info.combat_units[a].effects.stunned==void 0||battle_info.combat_units[a].effects.stunned==0)&&h==0&&A<=z&&(all_abilities[u].negated_by_ability!=void 0&&$.each(all_abilities[u].negated_by_ability,function(E,D){$.each(battle_info.combat_units[b].abilities,function(C,F){C==D&&(G=!0)})}),G==0&&(h=!0,latest_result=0,process_ability(a,all_abilities[u],y,b,void 0,"avoid_effect")))}}})}if(battle_info.combat_units[b]!=
void 0&&h==0&&k==0&&combat_alive==1&&(c.chance==void 0||c.chance>=Math.random()*100)){var p=1;c.effect_count!=void 0&&(p=calculate_effect({amount:c.effect_count},a,b,e));for(--p;p>=0;p--){c.pause_before!=void 0&&(total_timeout+=c.pause_before*battle_speed);c.self_projectile!=void 0&&(total_timeout-=500*battle_speed,total_timeout<0&&(total_timeout=0),create_projectile(b,b,c.self_projectile,!1,c.projectile_target,c.side,void 0,void 0,void 0,!0),total_timeout+=1E3*battle_speed);c.projectile!=void 0&&
(total_timeout-=500*battle_speed,total_timeout<0&&(total_timeout=0),create_projectile(b,a,c.projectile,!1,c.projectile_target,c.side),total_timeout+=1E3*battle_speed);c.target_projectile!=void 0&&(total_timeout-=500*battle_speed,total_timeout<0&&(total_timeout=0),create_projectile(a,a,c.target_projectile,!1,c.projectile_target,c.side,void 0,void 0,void 0,!0),total_timeout+=1E3*battle_speed);c.pause_before_effect!=void 0&&(total_timeout+=c.pause_before_effect*battle_speed);battle_info.combat_units[a]!=
void 0&&((battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].side==2||l==2)&&$.each(c.subtypes,function(u,y){u=battle_info.combat_units[a].card_type+"_affected_by_"+y;all_achievement_goals[u]!=void 0&&check_quests(u);battle_info.combat_units[a]!=void 0&&$.each(battle_info.combat_units[a].subtypes,function(B,z){B=z+"_affected_by_"+y;all_achievement_goals[B]!=void 0&&check_quests(B)})}),check_single_unit_proc(a,void 0,"pre_affected_by_"+c.type,b,c.subtypes),check_single_unit_proc(a,void 0,
"pre_affected_by_any",b,c.subtypes));if(battle_info.combat_units[a]!=void 0&&battle_info.combat_units[b]!=void 0){var n=!1;c.type=="increase_loot_charges"&&d>0&&(gamedata.loot_charges==void 0&&(gamedata.loot_charges=0),gamedata.loot_charges+=d);c.type=="damage"&&d>0&&(n=receive_damage(a,b,d,c.subtypes));c.type=="drain"&&(n=receive_damage(a,b,d,c.subtypes),battle_info.combat_units[a].type=="creature"&&battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].current_health<battle_info.combat_units[b].health&&
receive_healing(b,b,n,[]));c.type=="healing"&&receive_healing(a,b,d,c.subtypes);c.type=="set_hp"&&set_hp(a,b,d,c.subtypes);c.type=="set_max_hp"&&set_max_hp(a,b,d,c.subtypes);c.type=="reduce_power"&&reduce_power(a,b,d,c.subtypes);c.type=="increase_power"&&increase_power(a,b,d,c.subtypes);c.type=="enable_to_act"&&enable_to_act(a,b,d,c.subtypes);c.type=="go_again"&&go_again(a,b,d,c.subtypes);c.type=="set_power"&&set_power(a,b,d,c.subtypes);c.type=="increase_health"&&increase_health(a,b,d,c.subtypes);
c.type=="grant_temp_power"&&grant_temp_power(a,b,d,c.subtypes);c.type=="grant_temp_health"&&grant_temp_health(a,b,d,c.subtypes);c.type=="reduce_health"&&(latest_result=reduce_health(a,b,d,c.subtypes));c.type=="reduce_current_health"&&(latest_result=reduce_current_health(a,b,d,c.subtypes));c.type=="set_health"&&(latest_result=set_health(a,b,d,c.subtypes));c.type=="reduce_max_health"&&reduce_max_health(a,b,d,c.subtypes);c.type=="reduce_armor"&&reduce_armor(a,b,d,c.subtypes);c.type=="increase_armor"&&
increase_armor(a,b,d,c.subtypes);c.type=="set_armor"&&(latest_result=set_armor(a,b,d,c.subtypes));c.type=="grant_skill"&&(grant_skill(a,b,d,c.skill_id,void 0,c.skill_at_front),check_visible_skills(a));c.type=="grant_temp_skill"&&(grant_temp_skill(a,b,d,c.skill_id,void 0,c.skill_at_front),check_visible_skills(a));c.type=="set_skill"&&(set_skill(a,b,d,c.skill_id),check_visible_skills(a));c.type=="change_side"&&change_side(a,b);c.type=="ability"&&process_ability(a,c,e,b);if(c.type=="random_ability"){var q=
c.ability_options[get_random_key_from_object(c.ability_options)];all_abilities[q]!=void 0&&(g=process_ability(a,all_abilities[q],d,b))}c.type=="move"&&(g=move_unit(a,c,b));c.type=="set_unit_type"&&set_unit_type(a,c,b);c.type=="turn_into"&&turn_into(a,c,b,e);c.type=="turn_into_original"&&(g=turn_into_original(a,b));c.type=="apply_burn"&&apply_burn(a,d,b);c.type=="reduce_burn"&&reduce_burn(a,d,b);c.type=="apply_poison"&&apply_poison(a,d,b);c.type=="apply_stun"&&(apply_stun(a,d,b,c.allways_apply),check_visible_skills(a));
c.type=="apply_curse"&&apply_curse(a,d,b);c.type=="apply_doom"&&apply_doom(a,d,b);c.type=="apply_energy"&&apply_energy(a,d,b);c.type=="apply_blessed"&&apply_blessed(a,d,b);c.type=="set_effect_amount"&&set_effect_amount(a,d,b,c);c.type=="destroy"&&destroy_unit(a,b);c.type=="disappear"&&disappear_unit(a,b);c.type=="move_to_deck"&&move_to_deck(a,c,b);c.type=="reduce_negative_effects"&&(reduce_negative_effects(a,d,b),check_visible_skills(a));c.type=="absorb"&&absorb(a,b,c.absorb_specs)}c.type=="set_status"&&
(g=set_status(a,c,b));c.type=="remove_card"&&remove_card_from_combat(a,c,b);c.type=="reduce_ready_time"&&reduce_ready_time(a,c,d,b);c.type=="increase_ready_time"&&increase_ready_time(a,c,d,b);if(c.type=="play_card"){g=battle_info.combat_units[b];q=g.side;if(c.side=="ally"&&g.side==2||c.side=="enemy"&&g.side==1)q=2;if(c.side=="ally"&&g.side==1||c.side=="enemy"&&g.side==2)q=1;play_card(q,a,!0,b);g=!0}if(c.type=="add_card_to_deck")for(p=d-1;p>=0;p--)add_card_to_combat_deck(battle_info.combat_units[a].side,
c.card_id,c.card_status);if(c.type=="draw_card")for(p=d-1;p>=0;p--)draw_card(battle_info.combat_units[a].side,void 0,c.card_type);if(c.type=="summon_unit"){q=!1;var m=!0;c.forced_slot!=void 0&&(m=c.forced_slot);for(p=d-1;p>=0;p--){if(c.card_id!="random"&&c.card_id!="self"&&c.card_id!="origin_card")var r=play_unit_card(battle_info.combat_units[a].side,c.card_id,void 0,m,b);else{if(c.card_id=="random"){r="any";c.card_type!=void 0&&(r=calculate_effect({amount:c.card_type},a,b,e));var t=100;c.card_time!=
void 0&&(t=calculate_effect({amount:c.card_time},a,b,e));var v=void 0;c.card_time_min!=void 0&&(v=calculate_effect({amount:c.card_time_min},a,b,e));var w=void 0;c.card_color!=void 0&&(w=calculate_effect({amount:c.card_color},a,b,e));var x=void 0;c.card_subtype!=void 0&&(x=calculate_effect({amount:c.card_subtype},a,b,e));r=get_random_card_based_on_time(r,t,w,w,x,v,void 0,c.not_subtypes);r=play_unit_card(battle_info.combat_units[a].side,r,void 0,m,b)}c.card_id=="self"&&(r=clone_unit(battle_info.combat_units[a].side,
a,c.clone_stunned,b,c));c.card_id=="origin_card"&&(r=play_unit_card(battle_info.combat_units[a].side,battle_info.combat_units[a].card_type,void 0,m,b))}r==1&&(q=!0)}q==0&&f==0&&(g=!1)}if(c.type=="play_action_card"){q=!1;for(p=d-1;p>=0;p--)c.card_id!="random"?r=play_action_card(battle_info.combat_units[a].side,c.card_id,void 0,!0):(r="any",c.card_type!=void 0&&(r=calculate_effect({amount:c.card_type},a,b,e)),t=100,c.card_time!=void 0&&(t=calculate_effect({amount:c.card_time},a,b,e)),w=void 0,c.card_color!=
void 0&&(w=calculate_effect({amount:c.card_color},a,b,e)),r=get_random_card_based_on_time(r,t,w,w),r=play_action_card(battle_info.combat_units[a].side,r,void 0,!0)),r==1&&(q=!0);q==0&&f==0&&(g=!1)}if(c.type=="play_artifact_card"){q=!1;for(p=d-1;p>=0;p--)c.card_id!="random"?r=play_artifact_card(battle_info.combat_units[a].side,c.card_id,void 0,!0):(r="any",c.card_type!=void 0&&(r=calculate_effect({amount:c.card_type},a,b,e)),t=100,c.card_time!=void 0&&(t=calculate_effect({amount:c.card_time},a,b,e)),
w=void 0,c.card_color!=void 0&&(w=calculate_effect({amount:c.card_color},a,b,e)),r=get_random_card_based_on_time(r,t,w,w),r=play_artifact_card(battle_info.combat_units[a].side,r,void 0,!0)),r==1&&(q=!0);q==0&&f==0&&(g=!1)}c.increase_timeout!=void 0&&(total_timeout+=c.increase_timeout*battle_speed);battle_info.combat_units[a]!=void 0&&(check_single_unit_proc(a,void 0,"affected_by_"+c.type,b,c.subtypes),check_single_unit_proc(a,void 0,"affected_by_any",b,c.subtypes));battle_info.combat_units[b]!=void 0&&
check_single_unit_proc(b,void 0,"hit_with_ability",a,c.subtypes);c.projectile!=void 0&&(total_timeout+=1E3*battle_speed)}}else c.self_projectile!=void 0&&(total_timeout-=1E3*battle_speed,create_projectile(b,b,c.self_projectile,!1,c.projectile_target,c.side,void 0,void 0,void 0,!0),total_timeout+=500*battle_speed),c.projectile!=void 0&&(total_timeout-=1E3*battle_speed,create_projectile(b,a,c.projectile,!1,c.projectile_target,c.side),total_timeout+=500*battle_speed),c.target_projectile!=void 0&&(total_timeout-=
1E3*battle_speed,create_projectile(a,a,c.target_projectile,!1,c.projectile_target,c.side,void 0,void 0,void 0,!0),total_timeout+=500*battle_speed),c.on_failure!=void 0&&process_ability(b,c.on_failure,e,void 0);h==1&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("dodge")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("dodge")},total_timeout+50),timeout_key++,all_timeouts[timeout_key]=
setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("dodge")},total_timeout+500),total_timeout+=500*battle_speed,battle_info.combat_units[b]!=void 0&&c.on_avoided!=void 0&&process_ability(b,c.on_avoided,ability_level,void 0,"on_avoided"),battle_info.combat_units[b]!=void 0&&$.each(battle_info.combat_units[b].abilities,function(u,y){match_array_values(all_abilities[u].proc,"been_avoided")!=1||all_abilities[u].subtypes!=void 0&&match_array_values(all_abilities[u].subtypes,subtypes)!=
1||all_abilities[u].not_subtypes!=void 0&&match_array_values(all_abilities[u].not_subtypes,subtypes)!=0||process_ability(b,all_abilities[u],y,a,void 0,"been_avoided")}));k==1&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("combat_softfade")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("combat_softfade")},total_timeout+500));g==1&&(h==0&&c.on_success!=void 0&&(n===!1||n>0)&&
process_ability(b,c.on_success,e,a),(battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].side==2||l==2)&&$.each(c.subtypes,function(u,y){check_quests("ally_performed_"+y);add_battle_stats("ally_performed_"+y,d)}),battle_info.combat_units[b]!=void 0&&$.each(battle_info.combat_units[b].abilities,function(u,y){$.each(c.subtypes,function(B,z){match_array_values(all_abilities[u].proc,"performed_"+z)!=1||all_abilities[u].subtypes!=void 0&&match_array_values(all_abilities[u].subtypes,z)!=1||
all_abilities[u].not_subtypes!=void 0&&match_array_values(all_abilities[u].not_subtypes,z)!=0||process_ability(b,all_abilities[u],y,a,void 0,"performed_"+z)});match_array_values(all_abilities[u].proc,"performed_ability")!=1||all_abilities[u].subtypes!=void 0&&match_array_values(all_abilities[u].subtypes,c.subtypes)!=1||all_abilities[u].not_subtypes!=void 0&&match_array_values(all_abilities[u].not_subtypes,c.subtypes)!=0||process_ability(b,all_abilities[u],y,a,void 0,"performed_ability")}))}return g}
function reduce_negative_effects(a,b,c){c=battle_info.combat_units[a];for(var e=1;e<=b;e++){var d=0,f=!1;c.effects.burning!=void 0&&c.effects.burning>0&&(d+=c.effects.burning);c.effects.poisoned!=void 0&&c.effects.poisoned>0&&(d+=c.effects.poisoned);c.effects.cursed!=void 0&&c.effects.cursed>0&&(d+=c.effects.cursed);c.effects.doom!=void 0&&c.effects.doom>0&&(d+=c.effects.doom);d=Math.ceil(Math.random()*d);c.effects.burning!=void 0&&f==0&&c.effects.burning>0&&(d-=c.effects.burning,d<=0&&(--c.effects.burning,
f=!0,total_timeout+=200*battle_speed));c.effects.poisoned!=void 0&&f==0&&c.effects.poisoned>0&&(d-=c.effects.poisoned,d<=0&&(--c.effects.poisoned,f=!0,total_timeout+=200*battle_speed));c.effects.cursed!=void 0&&f==0&&c.effects.cursed>0&&(d-=c.effects.cursed,d<=0&&(--c.effects.cursed,f=!0,total_timeout+=200*battle_speed));c.effects.doom!=void 0&&f==0&&c.effects.doom>0&&(d-=c.effects.doom,d<=0&&(--c.effects.doom,total_timeout+=200*battle_speed));update_passive_effects(a)}}
function absorb(a,b,c){if(battle_info.combat_units[a]!=void 0&&battle_info.combat_units[b]!=void 0){if(c.absorb_abilities!=void 0&&c.absorb_abilities==1){var e=c.absorb_abilities_amount=="all"?count_object(battle_info.combat_units[a].abilities):c.absorb_abilities_amount+0;$.each(battle_info.combat_units[a].abilities,function(d,f){if(e>0&&(c.absorb_negative_abilities==void 0||c.absorb_negative_abilities==1||all_abilities[d].negative_ability==void 0)){battle_info.combat_units[b].abilities[d]=battle_info.combat_units[b].abilities[d]==
void 0?f:battle_info.combat_units[b].abilities[d]+f;delete battle_info.combat_units[a].abilities[d];total_timeout+=500;var g=parse_abilities(a);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_abilities").html(g)},total_timeout);g=parse_abilities(b);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+b+" .card_abilities").html(g)},total_timeout);check_visible_skills(a);check_visible_skills(b)}})}c.absorb_power!=
void 0&&c.absorb_power==1&&battle_info.combat_units[a].power>0&&(battle_info.combat_units[b].power=battle_info.combat_units[b].power===!1?battle_info.combat_units[a].power:battle_info.combat_units[b].power+battle_info.combat_units[a].power,battle_info.combat_units[a].power=!1,check_unit_power(a),check_unit_power(b),total_timeout+=500);c.absorb_armor!=void 0&&c.absorb_armor==1&&battle_info.combat_units[a].armor>0&&(battle_info.combat_units[b].armor=battle_info.combat_units[b].armor===!1?battle_info.combat_units[a].armor:
battle_info.combat_units[b].armor+battle_info.combat_units[a].armor,battle_info.combat_units[a].armor=!1,check_unit_power(a),check_unit_power(b),total_timeout+=500);c.absorb_health!=void 0&&c.absorb_health==1&&battle_info.combat_units[a].current_health>0&&(battle_info.combat_units[b].current_health===!1?(battle_info.combat_units[b].current_health=battle_info.combat_units[a].current_health,battle_info.combat_units[b].health=battle_info.combat_units[a].health):(battle_info.combat_units[b].current_health+=
battle_info.combat_units[a].current_health,battle_info.combat_units[b].health+=battle_info.combat_units[a].health),battle_info.combat_units[a].current_health=!1,check_unit_hp(a),check_unit_hp(b),total_timeout+=500)}}
function apply_burn(a,b,c){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.burning=c.effects.burning==void 0?b:c.effects.burning+b;timeout_key++;passive_effect_count++;var e=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_burned passive_effect_'+e+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image .passive_effect_"+e).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}function set_effect_amount(a,b,c,e){if(battle_info.combat_units[a]!=void 0){var d=battle_info.combat_units[a];d.effects==void 0&&(d.effects={});$.each(e.effect_names,function(f,g){d.effects[f]=g;g<1&&delete d.effects[f]});e.effect_name!=void 0&&(d.effects[e.effect_name]=b);update_passive_effects(a)}}
function reduce_burn(a,b,c){b>0&&battle_info.combat_units[a]!=void 0&&(c=battle_info.combat_units[a],c.effects==void 0&&(c.effects={}),c.effects.burning!=void 0&&(b>c.effects.burning&&(b=c.effects.burning),c.effects.burning-=b),update_passive_effects(a))}
function apply_poison(a,b,c){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.poisoned=c.effects.poisoned==void 0?b:c.effects.poisoned+b;timeout_key++;passive_effect_count++;var e=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_poisoned passive_effect_'+e+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image .passive_effect_"+e).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}
function apply_curse(a,b,c){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.cursed=c.effects.cursed==void 0?b:c.effects.cursed+b;timeout_key++;passive_effect_count++;var e=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_cursed passive_effect_'+e+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image .passive_effect_"+e).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}
function apply_doom(a,b,c){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.doom=c.effects.doom==void 0?b:c.effects.doom+b;c.effects.doom>10&&(c.effects.doom=10);timeout_key++;passive_effect_count++;var e=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_doomed passive_effect_'+e+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image .passive_effect_"+e).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}
function apply_energy(a,b,c){b!=0&&battle_info.combat_units[a]!=void 0&&(c=battle_info.combat_units[a],c.effects==void 0&&(c.effects={}),c.effects.energy=c.effects.energy==void 0?b:c.effects.energy+b,c.effects.energy<0&&(c.effects.energy=0),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("blue_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("blue_glow")},
total_timeout+500),total_timeout+=250*battle_speed,update_passive_effects(a))}
function apply_blessed(a,b,c){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.blessed=c.effects.blessed==void 0?b:c.effects.blessed+b;c.effects.blessed<0&&(c.effects.blessed=0);c.effects.blessed>10&&(c.effects.blessed=10);timeout_key++;passive_effect_count++;var e=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_blessed passive_effect_'+
e+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image .passive_effect_"+e).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}
function apply_stun(a,b,c,e){if(b>0&&battle_info.combat_units[a]!=void 0){c=battle_info.combat_units[a];c.effects==void 0&&(c.effects={});c.effects.stunned==void 0?c.effects.stunned=b:c.effects.stunned<b&&(c.effects.stunned=b);timeout_key++;passive_effect_count++;var d=passive_effect_count+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").append('<div class="just_stunned passive_effect_'+d+'"></div>')},total_timeout);timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image .passive_effect_"+d).remove()},total_timeout+750);total_timeout+=250*battle_speed;update_passive_effects(a)}}function set_unit_type(a,b,c){c=battle_info.combat_units[a];if(c!=void 0){c.type=b.new_type;var e=parse_abilities(a);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_abilities").html(e)},total_timeout)}}
function move_unit(a,b,c){var e=battle_info.combat_units[a],d=find_free_slot(e.side,e.card_type,b.safe_slot,b.placement,b.opposing_type,c,b.slot_filters);b.placement!=void 0&&b.placement=="right"&&d<e.slot&&(d=!1);b.placement!=void 0&&b.placement=="left"&&d>e.slot&&(d=!1);if(d!=0){var f=e.slot+0;e.old_slot=f;e.slot=d;var g=e.slot+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).removeClass("slot_"+f);$(".unit_id_"+a).addClass("slot_"+g)},total_timeout);total_timeout+=
500*battle_speed;check_ability_procs(e.side,"moved",a,b.subtypes);latest_result=f-g;latest_result<0&&(latest_result*=-1);return!0}timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+c).removeClass("combat_zoom")},total_timeout);latest_result=0;return!1}
function change_side(a,b){var c=battle_info.combat_units[a],e=!1;c.side==1&&(e=2);c.side==2&&(e=1);if(e!=0){var d=c.side+0,f=c.side=e;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).removeClass("flying")},total_timeout);total_timeout+=100*battle_speed;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).removeClass("side_"+d);$(".unit_id_"+a).addClass("side_"+f)},total_timeout);var g=0;$.each(battle_info.combat_units,function(h,k){k.side==c.side&&
k.slot==c.slot&&g++});g>1?move_unit(a,{type:"move",safe_slot:"dont care",has_opposing:"dont care",placement:"random"},b):total_timeout+=500*battle_speed;check_visible_skills(a)}}
function move_to_deck(a,b,c){c=battle_info.combat_units[a];if(c!=void 0){var e=void 0;c.card_id!=void 0&&(e=parseInt(c.card_id)+0);var d=c.side+0,f=c.origin_side+0,g="deck";b.new_status!=void 0&&(g=b.new_status);g=="hand"&&e!=void 0&&count_hand_cards(battle_info["deck_"+c.side])>9&&(g="deck");if(g=="hand"&&e!=void 0&&count_hand_cards(battle_info["deck_"+c.side])<10){battle_info["deck_"+f][e].status="deck";draw_card(f,e,void 0,void 0,!1);total_timeout-=1500*battle_speed;var h=battle_info.combat_units[a].slot+
0,k=battle_info["deck_"+f][e].hand_slot+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).removeClass("side_"+d);$(".unit_id_"+a).addClass("side_"+f);$(".unit_id_"+a).removeClass("slot_"+h);$(".unit_id_"+a).addClass("hand_card fake_hand_slot_"+k)},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).remove()},total_timeout+1500*battle_speed);delete battle_info.combat_units[a]}else delete battle_info.combat_units[a],timeout_key++,
all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).addClass("combat_fade")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a).remove()},total_timeout+500);e!=void 0&&g!="hand"&&(battle_info["deck_"+f][e].status="deck",g=="grave"&&(battle_info["deck_"+f][e].status="grave",check_ability_procs("deck_"+f,"moved_to_grave",e),check_ability_procs("deck_"+f,all_available_cards[battle_info["deck_"+f][e].card_id].type+"_moved_to_grave",e)));total_timeout+=
500*battle_speed;update_deck_counts()}}
function set_status(a,b,c){var e=battle_info.combat_units[c],d=e.side;if(b.side=="ally"&&e.side==2||b.side=="enemy"&&e.side==1)d=2;if(b.side=="ally"&&e.side==1||b.side=="enemy"&&e.side==2)d=1;e=battle_info["deck_"+d][a].status+"";if(e=="hand"){var f=battle_info["deck_"+d][a].hand_slot+0,g=d+0,h=battle_info["deck_"+d][a].hand_slot_id+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+f+".side_"+g+".hand_slot_id_"+h).remove()},total_timeout+500*battle_speed);check_ability_procs(d,
"discarded",c,void 0,void 0)}if(e!="hand"){if(b.new_status=="deck"||b.new_status=="hand"&&count_deck_cards(battle_info["deck_"+d])>9)g=d+0,timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".deck_counter_"+g).addClass("combat_zoom");$(".deck_counter_"+g).addClass("green_text")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".deck_counter_"+g).removeClass("combat_zoom");$(".deck_counter_"+g).removeClass("green_text")},total_timeout+500*battle_speed);b.new_status==
"grave"&&(g=d+0,timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".deck_counter_"+g).addClass("combat_zoom");$(".deck_counter_"+g).addClass("red_text")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".deck_counter_"+g).removeClass("combat_zoom");$(".deck_counter_"+g).removeClass("red_text")},total_timeout+500*battle_speed))}b.new_status!="hand"?battle_info["deck_"+d][a].status=b.new_status:(battle_info["deck_"+d][a].status="deck",draw_card(d,a));total_timeout+=
500*battle_speed;update_deck_counts();return!0}
function remove_card_from_combat(a,b,c){c=battle_info.combat_units[c];var e=c.side;if(b.side=="ally"&&c.side==2||b.side=="enemy"&&c.side==1)e=2;if(b.side=="ally"&&c.side==1||b.side=="enemy"&&c.side==2)e=1;if(battle_info["deck_"+e][a].status=="hand"){var d=battle_info["deck_"+e][a].hand_slot+0,f=e+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+d+".side_"+f).remove()},total_timeout)}delete battle_info["deck_"+e][a];total_timeout+=500*battle_speed;update_deck_counts()}
function reduce_ready_time(a,b,c,e){e=battle_info.combat_units[e];var d=e.side;if(b.side=="ally"&&e.side==2||b.side=="enemy"&&e.side==1)d=2;if(b.side=="ally"&&e.side==1||b.side=="enemy"&&e.side==2)d=1;if(battle_info["deck_"+d][a].status=="hand"){battle_info["deck_"+d][a].time_left-=c;battle_info["deck_"+d][a].time_left<0&&(battle_info["deck_"+d][a].time_left=0);var f=battle_info["deck_"+d][a].hand_slot_id+0,g=battle_info["deck_"+d][a].time_left+0,h=d+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_id_"+
f+".side_"+h+" .card_time").html(g);$(".hand_slot_id_"+f+".side_"+h).addClass("green_glow combat_zoom")},total_timeout);total_timeout+=500*battle_speed;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_id_"+f+".side_"+h).removeClass("green_glow combat_zoom")},total_timeout+500*battle_speed)}}
function increase_ready_time(a,b,c,e){e=battle_info.combat_units[e];var d=e.side;if(b.side=="ally"&&e.side==2||b.side=="enemy"&&e.side==1)d=2;if(b.side=="ally"&&e.side==1||b.side=="enemy"&&e.side==2)d=1;if(battle_info["deck_"+d][a].status=="hand"){battle_info["deck_"+d][a].time_left+=c;battle_info["deck_"+d][a].time_left<0&&(battle_info["deck_"+d][a].time_left=0);var f=battle_info["deck_"+d][a].hand_slot_id+0,g=battle_info["deck_"+d][a].time_left+0,h=d+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_id_"+
f+".side_"+h+" .card_time").html(g);$(".hand_slot_id_"+f+".side_"+h).addClass("red_glow combat_zoom")},total_timeout);total_timeout+=500*battle_speed;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_id_"+f+".side_"+h).removeClass("red_glow combat_zoom")},total_timeout+500*battle_speed)}}
function receive_damage(a,b,c,e){latest_result=0;if(battle_info.combat_units[a]!=void 0){var d=battle_info.combat_units[a],f=battle_info.combat_units[b],g=d.side+0,h=void 0;f!=void 0&&(h=f.side+0);f!=void 0&&$.each(f.abilities,function(r,t){match_array_values(all_abilities[r].proc,"add_subtype_to_damage")==1&&(e=e.concat(all_abilities[r].subtypes))});amount_reduced=0;if(c>0){var k=0;if(d.armor>0&&match_array_values(["ignores_armor"],e)==0){match_array_values(["breaks_armor"],e);var l=c/d.armor;l>=
1&&(c-=d.armor,k=d.armor,d.armor=0);l<1&&(round_by_percent(l),d.armor>c?(d.armor-=c,k=c):(k=d.armor,d.armor-=c),c=d.armor<0?d.armor*-1:0);d.armor=0}if(k>0){check_unit_hp(a);timeout_key++;var p=".slot_"+battle_info.combat_units[a].slot+".side_"+battle_info.combat_units[a].side;all_timeouts[timeout_key]=setTimeout(function(){var r=parse_floating_text(k,"#ccc",!1);$(".battle_container .slot_container"+p).append(r)},total_timeout)}}c>0&&$.each(d.abilities,function(r,t){if(!(match_array_values(all_abilities[r].proc,
"max_incoming_damage")!=1||match_array_values(e,all_abilities[r].subtypes)!=1&&all_abilities[r].subtypes!=void 0||match_array_values(e,all_abilities[r].negated_by)!=0||all_abilities[r].origin_not_self!=void 0&&a==b||!(all_abilities[r].has_origin_unit==void 0||f!=void 0&&f.current_health>0)||all_abilities[r].cannot_proc_while_stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=0)&&(all_abilities[r].reduce_chance==void 0||Math.random()*
100<=calculate_effect({amount:all_abilities[r].reduce_chance},a,b,t))){var v=calculate_effect({amount:all_abilities[r].amount},a,b,t);if(c>v){amount_reduced=c-v;var w=amount_reduced+0;c=v;if(c>=0){timeout_key++;var x=".slot_"+battle_info.combat_units[a].slot+".side_"+battle_info.combat_units[a].side;all_timeouts[timeout_key]=setTimeout(function(){var u=parse_floating_text(w,"#ccc",!1);$(".battle_container .slot_container"+x).append(u)},total_timeout);process_ability(a,all_abilities[r],t,b,void 0,
"reduce_incoming_damage");check_ability_delay(a,r)}}}});c>0&&d.effects!=void 0&&d.effects.cursed!=void 0&&(c+=d.effects.cursed,d.effects.cursed=0,d.effects.cursed<1&&delete d.effects.cursed,update_passive_effects(a));c>0&&d.effects!=void 0&&d.effects.blessed!=void 0&&d.effects.blessed>0&&(f==void 0||f.abilities.hexed==void 0)&&(l=c+0,c-=d.effects.blessed,d.effects.blessed-=l,d.effects.blessed<0&&(d.effects.blessed=0),update_passive_effects(a));$.each(d.abilities,function(r,t){match_array_values(all_abilities[r].proc,
"reduce_incoming_damage")!=1||match_array_values(e,all_abilities[r].subtypes)!=1&&all_abilities[r].subtypes!=void 0||match_array_values(e,all_abilities[r].negated_by)!=0||all_abilities[r].origin_not_self!=void 0&&a==b||!(all_abilities[r].has_origin_unit==void 0||f!=void 0&&f.current_health>0)||all_abilities[r].cannot_proc_while_stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=void 0&&battle_info.combat_units[a].effects.stunned!=0||check_ability_can_fire(a,all_abilities[r],t,b)!=1||!(d.ability_delays[r]==
void 0||d.ability_delays[r]<1)||!(all_abilities[r].reduce_chance==void 0||Math.random()*100<=calculate_effect({amount:all_abilities[r].reduce_chance},a,b,t))||(process_ability(a,all_abilities[r],t,b,void 0,"reduce_incoming_damage"),amount_reduced=calculate_effect({amount:all_abilities[r].amount},a,b,t),check_ability_delay(a,r),c<amount_reduced&&(amount_reduced=c),c-=amount_reduced)});if(c>0){var n=0;l=d.current_health;d.temp_health!=void 0&&(l+=d.temp_health);c>l&&l>0&&(n=c-l);c>l&&d.slot!=0&&(c=
l);d.side==1&&(d.slot==0?check_quests("enemy_hero_damaged"):(check_quests("enemy_unit_damaged"),check_quests("enemy_"+d.type+"_damaged")),check_quests("dealt_damage",c));d.temp_health!=void 0&&d.temp_health>0?(d.temp_health-=c,d.temp_health<0&&(d.current_health+=d.temp_health,d.temp_health=0)):d.current_health-=c;timeout_key++;passive_effect_count++;var q=c+0;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("combat_hit");$(".battle_container .unit_id_"+a+
" .card_image").addClass("red_glow")},total_timeout);q>0&&(timeout_key++,p=".slot_"+battle_info.combat_units[a].slot+".side_"+battle_info.combat_units[a].side,all_timeouts[timeout_key]=setTimeout(function(){var r=parse_floating_text(q,"#f00",!1);$(".battle_container .slot_container"+p).append(r)},total_timeout));timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("combat_hit");$(".battle_container .unit_id_"+a+" .card_image").removeClass("red_glow")},
total_timeout+500);latest_result=c;var m=c+0;check_unit_hp(a);latest_result=m;battle_info.combat_units[b]!=void 0&&m>0&&$.each(battle_info.combat_units[b].abilities,function(r,t){match_array_values(all_abilities[r].proc,"dealt_damage")!=1||all_abilities[r].subtypes!=void 0&&match_array_values(all_abilities[r].subtypes,e)!=1||all_abilities[r].not_subtypes!=void 0&&match_array_values(all_abilities[r].not_subtypes,e)!=0||process_ability(b,all_abilities[r],t,a,void 0,"dealt_damage",!1);latest_result=
m});battle_info.combat_units[b]!=void 0&&m>0&&a<3&&battle_info.combat_units[b].side!=battle_info.combat_units[a].side&&$.each(battle_info.combat_units[b].abilities,function(r,t){match_array_values(all_abilities[r].proc,"dealt_damage_to_hero")!=1||all_abilities[r].subtypes!=void 0&&match_array_values(all_abilities[r].subtypes,e)!=1||all_abilities[r].not_subtypes!=void 0&&match_array_values(all_abilities[r].not_subtypes,e)!=0||process_ability(b,all_abilities[r],t,a,void 0,"dealt_damage_to_hero",!0);
latest_result=m});battle_info.combat_units[a]!=void 0&&(m>0||k>0)&&$.each(d.abilities,function(r,t){match_array_values(all_abilities[r].proc,"receive_damage")!=1||all_abilities[r].subtypes!=void 0&&match_array_values(all_abilities[r].subtypes,e)!=1||all_abilities[r].not_subtypes!=void 0&&match_array_values(all_abilities[r].not_subtypes,e)!=0||!(d.ability_delays[r]==void 0||d.ability_delays[r]<1)||(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("attack")},
total_timeout),process_ability(a,all_abilities[r],t,b,void 0,"receive_damage")==1&&check_ability_delay(a,r));latest_result=m});battle_info.combat_units[b]!=void 0&&n>0&&$.each(battle_info.combat_units[b].abilities,function(r,t){match_array_values(all_abilities[r].proc,"overkill")!=1||all_abilities[r].subtypes!=void 0&&match_array_values(all_abilities[r].subtypes,e)!=1||all_abilities[r].not_subtypes!=void 0&&match_array_values(all_abilities[r].not_subtypes,e)!=0||process_ability(b,all_abilities[r],
n,a,void 0,"overkill",!1);latest_result=m});latest_result=m;a!=1&&a!=2||check_ability_procs(g,"hero_damaged",b,e);check_ability_procs(g,"takes_damage",a,e);check_ability_procs(h,"has_dealt_damage",b,e);latest_result=m;return c}timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("combat_hit")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("combat_hit")},total_timeout+
500)}return 0}
function receive_healing(a,b,c,e){b=battle_info.combat_units[a];c>b.health-b.current_health&&(c=b.health-b.current_health);if(c>0){b.current_health<0&&(b.current_health=0);b.current_health+=c;b.current_health>0&&b.dead!=void 0&&delete b.dead;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("green_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("green_glow")},
total_timeout+500);var d=c+0;timeout_key++;var f=".slot_"+battle_info.combat_units[a].slot+".side_"+battle_info.combat_units[a].side;all_timeouts[timeout_key]=setTimeout(function(){var g=parse_floating_text(d,"rgba(55,255,55,0.9)",!1);$(".battle_container .slot_container"+f).append(g)},total_timeout);check_unit_hp(a)}}
function set_hp(a,b,c,e){b=battle_info.combat_units[a];var d="green";c<b.current_health&&(d="purple");b.current_health=c;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass(d+"_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass(d+"_glow")},total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a)}
function set_max_hp(a,b,c,e){if(battle_info.combat_units[a]!=void 0){b=battle_info.combat_units[a];var d="green";c<b.health&&(d="purple");b.health=c;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass(d+"_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass(d+"_glow")},total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a)}}
function enable_to_act(a,b,c,e){battle_info.combat_units[a].failed_to_act_this_phase=!1;battle_info.combat_units[a].acted_this_turn=0}
function go_again(a,b,c,e){b=battle_info.combat_units[a];b.acted_this_turn>1&&(b.acted_this_turn=1);b.acted_this_turn-=c;delete b.failed_to_act_this_phase;b.failed_to_act_this_phase=!1;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("orange_glow");$(".battle_container .unit_id_"+a).removeClass("attack");$(".battle_container .unit_id_"+a).removeClass("combat_zoom")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image").removeClass("orange_glow")},total_timeout+500*battle_speed);total_timeout+=500*battle_speed;b.type=="spell"&&$.each(b.abilities,function(d,f){d=all_abilities[d];battle_info.combat_units[a]!=void 0&&d.proc!=void 0&&d.proc=="basic"&&process_ability(a,d,f,a)})}
function increase_power(a,b,c,e){c!=0&&battle_info.combat_units[a].power!==!1&&(b=battle_info.combat_units[a],b.power+=c,b.power<0&&(b.power=0),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("orange_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("orange_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_power(a),
check_ability_procs(b.side,b.type+"_gains_power",a),check_ability_procs(b.side,"gains_power",a))}
function grant_temp_power(a,b,c,e){c!=0&&(b=battle_info.combat_units[a],b.temp_power==void 0&&(b.temp_power=0),b.temp_power+=c,timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("orange_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("orange_glow")},total_timeout+500),check_unit_power(a),check_ability_procs(b.side,b.type+"_gains_power",
a),check_ability_procs(b.side,"gains_power",a),total_timeout+=500*battle_speed)}
function grant_temp_health(a,b,c,e){c!=0&&(b=battle_info.combat_units[a],b.temp_health==void 0&&(b.temp_health=0),b.temp_health+=c,timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("green_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("green_glow")},total_timeout+500),check_unit_hp(a),check_unit_alive(a),total_timeout+=500*battle_speed)}
function increase_health(a,b,c,e){c!=0&&(b=battle_info.combat_units[a],b.health+=c,b.current_health+=c,b.health<0&&(b.health=0),b.current_health<0&&(b.current_health=0),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("green_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("green_glow")},total_timeout+500),total_timeout+=500*battle_speed,
check_unit_hp(a))}
function reduce_health(a,b,c,e){if(c!=0){b=battle_info.combat_units[a];e=c+0;var d=c+0;b.health-0<c&&(e=b.health-0);b.current_health-0<d&&(d=b.current_health-0);b.health>0&&(b.health-=e);b.current_health>0&&(b.current_health-=d);b.health<0&&(b.health=0);b.current_health<0&&(b.current_health=0);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image").removeClass("purple_glow")},total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a)}return d}
function reduce_current_health(a,b,c,e){if(c!=0){b=battle_info.combat_units[a];var d=c+0;b.current_health-0<d&&(d=b.current_health-0);b.current_health>0&&(b.current_health-=d);b.current_health<0&&(b.current_health=0);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("purple_glow")},
total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a)}return d}
function set_health(a,b,c,e){if(c!=0){b=battle_info.combat_units[a];var d="green";c<b.health&&(d="purple");b.health=c;b.current_health=c;b.health<0&&(b.health=0);b.current_health<0&&(b.current_health=0);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass(d+"_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass(d+"_glow")},total_timeout+
500);total_timeout+=500*battle_speed;check_unit_hp(a)}return c}
function reduce_max_health(a,b,c,e){battle_info.combat_units[a]!=void 0&&(b=battle_info.combat_units[a],b.health-=c,b.health<0&&(b.health=0),b.current_health<0&&(b.current_health=0),b.current_health>b.health&&(b.current_health=b.health),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("purple_glow")},
total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(a))}
function reduce_armor(a,b,c,e){b=battle_info.combat_units[a];b.armor>0&&(b.armor-=c,b.armor<0&&(b.armor=0),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_hp(a))}
function increase_armor(a,b,c,e){b=battle_info.combat_units[a];b.armor+=c;b.armor<0&&(b.armor=0);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("green_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("green_glow")},total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a)}
function set_armor(a,b,c,e){b=0;e=battle_info.combat_units[a];var d=parseInt(e.armor);if(d!=c){e.armor=c;e.armor<0&&(e.armor=0);timeout_key++;var f="red";d<e.armor&&(f="green");all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass(f+"_glow")},total_timeout);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass(f+"_glow")},total_timeout+500);total_timeout+=500*battle_speed;check_unit_hp(a);
b=c}return b}function reduce_power(a,b,c,e){b=battle_info.combat_units[a];b.power!==!1&&(b.power-=c,b.power<0&&(b.power=0),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("purple_glow")},total_timeout+500),total_timeout+=500*battle_speed,check_unit_power(a))}
function set_power(a,b,c,e){b=battle_info.combat_units[a];e=b.power+0;b.power=c;b.power<0&&(b.power=0);timeout_key++;e>b.power&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("purple_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("purple_glow")},total_timeout+500));e<b.power&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a+" .card_image").addClass("orange_glow")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("orange_glow")},total_timeout+500));total_timeout+=500*battle_speed;check_unit_power(a)}
function grant_temp_skill(a,b,c,e,d,f){if(battle_info.combat_units[a]!=void 0){var g=battle_info.combat_units[a];g.temp_skills==void 0&&(g.temp_skills={});g.temp_skills[e]=g.temp_skills[e]==void 0?c:g.temp_skills[e]+c;grant_skill(a,b,c,e,d,f)}}
function grant_skill(a,b,c,e,d,f){e=="random"&&count_object(battle_info.combat_units[a].abilities)<5&&(e=find_new_ability(battle_info.combat_units[a].abilities,battle_info.combat_units[a]));e=="random"&&count_object(battle_info.combat_units[a].abilities)>=5&&(e=get_random_key_from_object(battle_info.combat_units[a].abilities));b=battle_info.combat_units[a];if(b.abilities[e]==void 0)if(f!=void 0&&f==1){var g={};g[e]=c;$.each(b.abilities,function(k,l){g[k]=l+0});b.abilities=true_copyobject(g)}else b.abilities[e]=
c;else typeof b.abilities[e]=="object"?(b.abilities[e].level+=c,all_abilities[e]!=void 0&&all_abilities[e].max_level!=void 0&&b.abilities[e].level>all_abilities[e].max_level&&(b.abilities[e].level=all_abilities[e].max_level)):(b.abilities[e]+=c,all_abilities[e]!=void 0&&all_abilities[e].max_level!=void 0&&b.abilities[e]>all_abilities[e].max_level&&(b.abilities[e]=all_abilities[e].max_level));typeof b.abilities[e]=="object"?b.abilities[e].level<1&&delete b.abilities[e]:b.abilities[e]<1&&delete b.abilities[e];
c=0;if(d==void 0||d==1)timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass("green_glow")},total_timeout),c=500;timeout_key++;var h=parse_abilities(a);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass("green_glow");$(".battle_container .unit_id_"+a+" .card_abilities").html(h)},total_timeout+c);update_passive_effects(a);total_timeout+=c*battle_speed}
function set_skill(a,b,c,e,d){var f=battle_info.combat_units[a],g="green",h=f.abilities[e]+0;if(f.abilities[e]==void 0&&c>0||f.abilities[e]!=void 0&&f.abilities[e]!=c){f.abilities[e]=c;f.abilities[e]<=0&&(delete f.abilities[e],g="red",a==b&&(g=""));f.abilities[e]<h&&(g="dark");b=0;d!=void 0&&d==1&&(timeout_key++,g!=""&&(all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").addClass(g+"_glow")},total_timeout),b=500));timeout_key++;var k=parse_abilities(a);
all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_image").removeClass(g+"_glow");$(".battle_container .unit_id_"+a+" .card_abilities").html(k)},total_timeout+b);total_timeout+=b*battle_speed}}
function check_unit_hp(a){var b=battle_info.combat_units[a];b.current_health<1?b.current_health=0:b.dead!=void 0&&delete b.dead;b.current_health>b.health&&(b.current_health=b.health);b.armor<1&&(b.armor=0);var c=b.armor,e=b.current_health,d=0;b.temp_health!=void 0&&(d=b.temp_health);var f=e+d;f<0&&(f=0);b=b.health+d;b<1&&(b=1);var g=100-e/b*100,h=100-f/b*100,k=d/b*100;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_health .max_health").html(f);
$(".battle_container .unit_id_"+a+" .card_health .current_health").html("");$(".battle_container .unit_id_"+a+" .card_health .current_health").css("height",h+"%");$(".battle_container .unit_id_"+a+" .card_health .temp_health").css("height",k+"%");$(".battle_container .unit_id_"+a+" .card_health .temp_health").css("bottom",100-g+"%");$(".battle_container .unit_id_"+a+" .card_armor").html(c);c>0?$(".battle_container .unit_id_"+a+" .card_armor").css("opacity",1):$(".battle_container .unit_id_"+a+" .card_armor").css("opacity",
0)},total_timeout)}
function check_visible_skills(a){var b=battle_info.combat_units[a];b!=void 0&&(b.abilities.stealth!=void 0&&b.abilities.stealth>0?(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("stealth")},total_timeout+10)):(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("stealth")},total_timeout+10)),b.abilities.flying!=void 0&&b.abilities.flying>0&&(b.effects==void 0||b.effects.stunned==void 0||
b.effects.stunned==0)&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("flying")},total_timeout+10)),b.abilities.flying==void 0||b.abilities.flying==0||b.effects!=void 0&&b.effects.stunned!=void 0&&b.effects.stunned>0)&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("flying")},total_timeout+10))}
function disappear_unit(a,b){battle_info.combat_units[a]!=void 0&&(b=battle_info.combat_units[a],b.slot!==0&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("combat_fade")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).remove()},total_timeout+500),b.card_id!=void 0&&battle_info["deck_"+b.origin_side][b.card_id].status=="in_play"&&(battle_info["deck_"+b.origin_side][b.card_id].status=
"grave",update_deck_counts(),check_ability_procs(b.origin_side,"moved_to_grave",b.card_id),check_ability_procs(b.origin_side,all_available_cards[battle_info["deck_"+b.origin_side][b.card_id].card_id].type+"_moved_to_grave",b.card_id)),delete battle_info.combat_units[a]))}function destroy_unit(a,b){check_unit_alive(a,b,!0)}
function check_unit_alive(a,b,c,e){if(battle_info.combat_units[a]!=void 0){var d=battle_info.combat_units[a],f=d.type+"";c!=void 0&&c==1&&(d.health=0,d.current_health=0,d.temp_health=0);d.temp_health==void 0&&(d.temp_health=0);d.health!==!1&&(d.current_health===0||d.current_health+d.temp_health<=0)&&d.dead==void 0&&(d.dead=!0,d.side==1&&b!=void 0&&battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].side==2&&(check_quests("enemy_"+d.type+"_killed"),battle_info.combat_units[b].unit_id==
2&&check_quests("enemy_"+d.type+"_killed_by_hero")),d.side==2&&b!=void 0&&battle_info.combat_units[b]!=void 0&&battle_info.combat_units[b].side==1&&(check_quests("ally_"+d.type+"_killed"),battle_info.combat_units[b].unit_id==2&&check_quests("ally_"+d.type+"_killed_by_hero")),battle_info.combat_units[a]!=void 0&&(d.current_health===0||d.current_health+d.temp_health<=0)&&$.each(battle_info.combat_units[a].abilities,function(g,h){match_array_values(all_abilities[g].proc,["pre_own_death"])==1&&process_ability(a,
all_abilities[g],h,b,void 0,"pre_own_death")}),battle_info.combat_units[a]!=void 0&&(d.current_health===0||d.current_health+d.temp_health<=0)&&battle_info.combat_units[b]!=void 0&&$.each(battle_info.combat_units[b].abilities,function(g,h){match_array_values(all_abilities[g].proc,["prekill","prekill_"+d.type])==1&&process_ability(b,all_abilities[g],h,a,void 0,"prekill")}),battle_info.combat_units[a]!=void 0&&(d.current_health===0||d.current_health+d.temp_health<=0)&&$.each(battle_info.combat_units[a].abilities,
function(g,h){match_array_values(all_abilities[g].proc,["own_death"])==1&&process_ability(a,all_abilities[g],h,b,void 0,"own_death")}),battle_info.combat_units[a]!=void 0&&(check_ability_procs(d.side,f+"_death",a),check_ability_procs(d.side,"death",a)),battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[b]!=void 0&&$.each(battle_info.combat_units[b].abilities,function(g,h){match_array_values(all_abilities[g].proc,["kill","kill_"+f])==1&&process_ability(b,all_abilities[g],h,a,void 0,"kill")}),
battle_info.combat_units[b]!=void 0&&check_ability_procs(d.side,f+"_killed",b)),battle_info.combat_units[a]!=void 0&&(d.current_health===0||d.current_health+d.temp_health<=0)&&$.each(battle_info.combat_units[a].abilities,function(g,h){match_array_values(all_abilities[g].proc,["post_own_death"])==1&&process_ability(a,all_abilities[g],h,b,void 0,"post_own_death")}),battle_info.combat_units[a]!=void 0?(d.slot!==0&&(d.current_health===0||d.current_health+d.temp_health<=0)&&(timeout_key++,all_timeouts[timeout_key]=
setTimeout(function(){$(".battle_container .unit_id_"+a).removeClass("flying");$(".battle_container .unit_id_"+a).removeClass("stealth");$(".battle_container .unit_id_"+a).addClass("dead")},total_timeout),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).remove()},total_timeout+1E3),d.card_id!=void 0&&battle_info["deck_"+d.origin_side][d.card_id].status=="in_play"&&(battle_info["deck_"+d.origin_side][d.card_id].status="grave",update_deck_counts(),check_ability_procs(d.origin_side,
"moved_to_grave",d.card_id),check_ability_procs(d.origin_side,all_available_cards[battle_info["deck_"+d.origin_side][d.card_id].card_id].type+"_moved_to_grave",d.card_id))),d.slot!==0&&(d.current_health===0||d.current_health+d.temp_health<=0)?delete battle_info.combat_units[a]:d.dead!=void 0&&delete d.dead):(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a).addClass("dead")},total_timeout+2E3),timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+
a).remove()},total_timeout+3E3)))}}function check_ability_procs(a,b,c,e,d){d==void 0&&(d=-10);$.each(battle_info.combat_units,function(f,g){g.slot==d&&check_single_unit_proc(f,a,b,c,e)});d<5&&check_ability_procs(a,b,c,e,d+1)}
function check_single_unit_proc(a,b,c,e,d){if(battle_info.combat_units[a]!=void 0){var f=battle_info.combat_units[a];$.each(f.abilities,function(g,h){if(f.ability_delays[g]==void 0||f.ability_delays[g]<1)if(all_abilities[g].subtypes==void 0||match_array_values(all_abilities[g].subtypes,d)==1)if(all_abilities[g].not_subtypes==void 0||match_array_values(all_abilities[g].not_subtypes,d)==0)if(all_abilities[g].origin_not_self==void 0||e!=a){var k=!1;f.side==b&&match_array_values(all_abilities[g].proc,
"ally_"+c)==1&&(k=process_ability(a,all_abilities[g],h,e,void 0,"ally_"+c));f.side!=b&&match_array_values(all_abilities[g].proc,"enemy_"+c)==1&&(k=process_ability(a,all_abilities[g],h,e,void 0,"enemy_"+c));match_array_values(all_abilities[g].proc,"any_"+c)==1&&(k=process_ability(a,all_abilities[g],h,e,void 0,"any_"+c));match_array_values(all_abilities[g].proc,c)==1&&(k=process_ability(a,all_abilities[g],h,e,void 0,c));k==1&&battle_info.combat_units[a]!=void 0&&check_ability_delay(a,g)}})}}
function check_unit_power(a){var b=battle_info.combat_units[a];b.power<1&&b.power!==!1&&(b.power=0);var c=b.power;c!==!1&&b.temp_power!=void 0&&(c+=b.temp_power,c<0&&(c=0));timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+a+" .card_power").html(c);c===!1?$(".battle_container .unit_id_"+a+" .card_power").addClass("hidden"):$(".battle_container .unit_id_"+a+" .card_power").removeClass("hidden")},total_timeout)}
function calculate_effect(a,b,c,e){if(a!=void 0){var d=1;typeof e=="object"&&(d=e.level_2,e=e.level);var f=typeof a=="string"?a:a.amount;f=="amount_reduced"&&(f=amount_reduced);if(battle_info.combat_units[c]!=void 0){f=="origin_cost"&&(f=battle_info.combat_units[c].time);f=="origin_power"&&(f=battle_info.combat_units[c].power,f!==!1&&battle_info.combat_units[c].temp_power!=void 0&&(f+=battle_info.combat_units[c].temp_power,f<0&&(f=0)));f=="origin_armor"&&(f=battle_info.combat_units[c].armor);f=="origin_max_health"&&
(f=battle_info.combat_units[c].health);f=="ally_hand_card_count"&&(f=count_hand_cards(battle_info["deck_"+battle_info.combat_units[c].side]));f=="enemy_hand_card_count"&&(f=battle_info.combat_units[c].side==1?count_hand_cards(battle_info.deck_2):count_hand_cards(battle_info.deck_1));f=="enemy_unit_count"&&(f=battle_info.combat_units[c].side==1?count_ally_units(2):count_ally_units(1));f=="ally_deck_card_count"&&(f=count_deck_cards(battle_info["deck_"+battle_info.combat_units[c].side]));f=="ally_grave_creature_card_count"&&
(f=count_grave_cards(battle_info["deck_"+battle_info.combat_units[c].side],"creature"));if(f=="ally_burn_count"){var g=0;$.each(battle_info.combat_units,function(k,l){l.side==battle_info.combat_units[c].side&&l.effects!=void 0&&l.effects.burning!=void 0&&l.effects.burning>0&&(g+=l.effects.burning)});f=g}f=="origin_energy"&&(f=battle_info.combat_units[c].effects!=void 0&&battle_info.combat_units[c].effects.energy!=void 0?battle_info.combat_units[c].effects.energy:0);f=="origin_poison"&&(f=battle_info.combat_units[c].effects!=
void 0&&battle_info.combat_units[c].effects.poisoned!=void 0?battle_info.combat_units[c].effects.poisoned:0);f=="origin_burn"&&(f=battle_info.combat_units[c].effects!=void 0&&battle_info.combat_units[c].effects.burning!=void 0?battle_info.combat_units[c].effects.burning:0);f=="origin_doom"&&(f=battle_info.combat_units[c].effects!=void 0&&battle_info.combat_units[c].effects.doom!=void 0?battle_info.combat_units[c].effects.doom:0);f=="times_played"&&(f=0,battle_info.combat_units[c].card_id!=void 0&&
battle_info.combat_units[c].origin_side!=void 0&&battle_info["deck_"+battle_info.combat_units[c].origin_side][battle_info.combat_units[c].card_id].played!=void 0&&(f=battle_info["deck_"+battle_info.combat_units[c].origin_side][battle_info.combat_units[c].card_id].played))}if(battle_info.combat_units[b]!=void 0){f=="target_cost"&&(f=battle_info.combat_units[b].time);f=="target_power"&&(f=battle_info.combat_units[b].power,f!==!1&&battle_info.combat_units[b].temp_power!=void 0&&(f+=battle_info.combat_units[b].temp_power,
f<0&&(f=0)));if(f=="target_health"){var h=battle_info.combat_units[b].current_health;battle_info.combat_units[b].temp_health!=void 0&&(h+=parseInt(battle_info.combat_units[b].temp_health));f=h}f=="target_max_health"&&(f=battle_info.combat_units[b].health);f=="target_energy"&&(f=battle_info.combat_units[b].effects!=void 0&&battle_info.combat_units[b].effects.energy!=void 0?battle_info.combat_units[b].effects.energy:0);f=="target_slot"&&(f=battle_info.combat_units[b].slot);f=="ally_units_heroes_artifacts"&&
(f=count_ally_units(battle_info.combat_units[b].side)+count_ally_artifacts(battle_info.combat_units[b].side)+1);f=="target_ally_units"&&(f=count_ally_units(battle_info.combat_units[b].side));f=="adjacent_structure_count"&&(f=count_adjacent(battle_info.combat_units[b].slot,battle_info.combat_units[b].side,"structure"));f=="adjacent_creature_count"&&(f=count_adjacent(battle_info.combat_units[b].slot,battle_info.combat_units[b].side,"creature"));f=="adjacent_count"&&(f=count_adjacent(battle_info.combat_units[b].slot,
battle_info.combat_units[b].side));f=="target_burn"&&(f=battle_info.combat_units[b].effects!=void 0&&battle_info.combat_units[b].effects.burning!=void 0?battle_info.combat_units[b].effects.burning:0);f=="target_poison"&&(f=battle_info.combat_units[b].effects!=void 0&&battle_info.combat_units[b].effects.poisoned!=void 0?battle_info.combat_units[b].effects.poisoned:0)}f=="units_in_play"&&(f=count_ally_units(1)+count_ally_units(2));f=="ability_level"&&(f=e);f=="ability_level_2"&&(f=d);f=="latest_result"&&
(f=latest_result);a.amount_factor!=void 0&&(f=a.amount_factor=="ability_level"?f*e:f*a.amount_factor);a.amount_factors!=void 0&&$.each(a.amount_factors,function(k,l){f=l=="ability_level"?f*e:f*l});a.amount_adjustment!=void 0&&(f+=calculate_effect({amount:a.amount_adjustment},b,c,e));a.crit_chance!=void 0&&a.crit_amount_factor!=void 0&&Math.random()*100<=a.crit_chance&&(f*=a.crit_amount_factor);a.crit_on_themes!=void 0&&a.crit_amount_factor!=void 0&&b!=void 0&&battle_info.combat_units[b]!=void 0&&
match_array_values(battle_info.combat_units[b].theme,a.crit_on_themes)&&(f*=a.crit_amount_factor);a.crit_on_has_skills!=void 0&&a.crit_amount_factor!=void 0&&b!=void 0&&battle_info.combat_units[b]!=void 0&&$.each(a.crit_on_has_skills,function(k,l){battle_info.combat_units[b].abilities!=void 0&&battle_info.combat_units[b].abilities[l]!=void 0&&(f*=a.crit_amount_factor)});f>0&&battle_info.combat_units[c]!=void 0&&a.scales!=void 0&&a.scales==1&&(battle_info.combat_units[c].origin_side==1&&(d=get_effective_power_factor(),
f=f*d>=1?round_by_percent(f*d):Math.ceil(f*d)),battle_info.combat_units[c].origin_side==2&&(d=get_upgrade_factor("ability_effect",a.subtypes),f*=d));battle_info.combat_units[c]!=void 0&&battle_info.combat_units[c].origin_side==2&&(d=get_upgrade_factor(a.type,a.subtypes),d!=1&&(f=round_by_percent(f*d)));if(typeof f=="number"){if(a.amount_rounding!=void 0)switch(a.amount_rounding){case "down":f=Math.floor(f);break;case "random":f=round_by_percent(f);break;default:f=Math.ceil(f)}else f=Math.ceil(f);
a.max_amount!=void 0&&(a.max_amount=="ability_level"&&e!=void 0&&f>e&&(f=e),typeof a.max_amount=="number"&&f>a.max_amount&&(f=a.max_amount))}return f}}function count_adjacent(a,b,c){var e=0;$.each(battle_info.combat_units,function(d,f){f.side!=b||f.slot!=a+1&&f.slot!=a-1||c!=void 0&&f.type!=c||e++});return e}
function find_targets(a,b,c,e,d,f){if(g==void 0)var g={};var h=battle_info.combat_units[a];b.use_latest_slot!=void 0&&b.use_latest_slot==1&&(h=copyobject(battle_info.combat_units[a]),h.slot=latest_slot,latest_slot=-10);if(b.target=="unit"||b.target=="unit_or_hero"||b.target=="hero"||b.target=="artifact"||b.target=="any"){var k="any",l=1,p=5;if(b.target=="unit_or_hero"||b.target=="hero")l=0;b.target=="hero"&&(p=0);b.target=="artifact"&&(l=-5,p=-1);b.target=="any"&&(l=-10,p=5);if(b.side=="ally"&&h.side==
2||b.side=="enemy"&&h.side==1)k=2;if(b.side=="ally"&&h.side==1||b.side=="enemy"&&h.side==2)k=1;var n=get_highest_key_in_object(g)+1;if(b.from_right==void 0||b.from_right==0)for(var q=l;q<=p;q++)$.each(battle_info.combat_units,function(t,v){v.side!=k&&k!="any"||v.slot!=q||(g[n]=v.unit_id,n++)});else for(q=p;q>=l;q--)$.each(battle_info.combat_units,function(t,v){v.side!=k&&k!="any"||v.slot!=q||(g[n]=v.unit_id,n++)});if(b.origin_unit!=void 0&&b.origin_unit==1){var m=!1;$.each(g,function(t,v){v==c&&(g=
{0:c},m=!0)});m==0&&(g={})}b.not_self!=void 0&&b.not_self==1&&(g=filter_targets_by_not_self(g,a));g=filter_targets_by_immunities(g,a,d,c);b.specific_slots!=void 0&&$.each(g,function(t,v){match_array_values(battle_info.combat_units[v].slot,b.specific_slots)==0&&delete g[t]});b.has_origin_card!=void 0&&(g=filter_targets_by_has_origin_card(g,b.has_origin_card));b.not_types!=void 0&&(g=filter_targets_by_not_types(g,b.not_types));b.subtypes!=void 0&&(g=filter_targets_by_subtypes(g,b.subtypes));b.not_subtypes!=
void 0&&(g=filter_targets_by_not_subtypes(g,b.not_subtypes));b.card_ids!=void 0&&(g=filter_targets_by_card_ids(g,b.card_ids,!1));b.not_card_ids!=void 0&&(g=filter_targets_by_card_ids(g,b.not_card_ids,!0));b.has_ability!=void 0&&(g=filter_targets_by_has_ability(g,b.has_ability));b.has_theme!=void 0&&(g=filter_targets_by_has_theme(g,b.has_theme));b.does_not_have_ability!=void 0&&(g=filter_targets_by_does_not_have_ability(g,b.does_not_have_ability));b.max_abilities!=void 0&&(g=filter_targets_by_max_abilities(g,
b.max_abilities,e));b.is_transformed!=void 0&&b.is_transformed==1&&(g=filter_targets_by_is_transformed(g));b.damaged!=void 0&&b.damaged==1&&(g=filter_targets_by_damaged(g));b.damaged!=void 0&&b.damaged==0&&(g=filter_targets_by_not_damaged(g));b.has_negative_effect!=void 0&&b.has_negative_effect==1&&(g=filter_targets_by_has_negative_effect(g));b.has_effect!=void 0&&(g=filter_targets_by_has_effect(g,b.has_effect,e));b.not_stunned!=void 0&&(g=filter_targets_by_not_stunned(g,b.not_stunned));b.min_cost!=
void 0&&b.min_cost!=0&&(g=filter_targets_by_min_cost(g,b.min_cost,c,e));b.max_cost!=void 0&&b.max_cost!=0&&(g=filter_targets_by_max_cost(g,b.max_cost,c,e));b.min_hp!=void 0&&(g=filter_targets_by_min_hp(g,b.min_hp));b.min_total_hp!=void 0&&(g=filter_targets_by_min_total_hp(g,b.min_total_hp));b.max_hp!=void 0&&(g=filter_targets_by_max_hp(g,b.max_hp,c,e));b.min_armor!=void 0&&b.min_armor>0&&(g=filter_targets_by_min_armor(g,b.min_armor));b.max_armor!=void 0&&(g=filter_targets_by_max_armor(g,calculate_effect({amount:b.max_armor},
a,c,e)));b.min_power!=void 0&&b.min_power>=0&&(g=filter_targets_by_min_power(g,b.min_power));b.max_power!=void 0&&(g=filter_targets_by_max_power(g,calculate_effect({amount:b.max_power},a,c,e)));b.has_opposing!=void 0&&b.has_opposing==0&&(g=filter_targets_by_has_no_opposing(g));b.has_opposing!=void 0&&b.has_opposing==1&&(g=filter_targets_by_has_opposing(g));b.has_opposing_creature!=void 0&&b.has_opposing_creature==0&&(g=filter_targets_by_has_no_opposing(g,"creature"));b.has_opposing_creature!=void 0&&
b.has_opposing_creature==1&&(g=filter_targets_by_has_opposing(g,"creature"));b.has_opposing_structure!=void 0&&b.has_opposing_structure==0&&(g=filter_targets_by_has_no_opposing(g,"structure"));b.has_opposing_structure!=void 0&&b.has_opposing_structure==1&&(g=filter_targets_by_has_opposing(g,"structure"));b.has_adjacent_creature!=void 0&&b.has_adjacent_creature==1&&(g=filter_targets_by_has_adjacent(g,"creature"));b.has_adjacent_creature!=void 0&&b.has_adjacent_creature==0&&(g=filter_targets_by_has_no_adjacent(g,
"creature"));b.has_opposing_structure!=void 0&&b.has_opposing_structure==0&&(g=filter_targets_by_has_no_opposing(g,"structure"));b.has_opposing_structure!=void 0&&b.has_opposing_structure==1&&(g=filter_targets_by_has_opposing(g,"structure"));b.slot_free!=void 0&&b.slot_free==1&&(g=filter_targets_by_slot_free(g));b.position!=void 0&&(g=filter_targets_by_position(g,a,b.position,h.slot));b.lowest_power!=void 0&&b.lowest_power==1&&(g=filter_targets_by_lowest_power(g));b.highest_power!=void 0&&b.highest_power==
1&&(g=filter_targets_by_highest_power(g));b.lowest_hp!=void 0&&b.lowest_hp==1&&(g=filter_targets_by_lowest_hp(g));b.highest_hp!=void 0&&b.highest_hp==1&&(g=filter_targets_by_highest_hp(g));b.highest_max_hp!=void 0&&b.highest_max_hp==1&&(g=filter_targets_by_highest_max_hp(g));b.highest_armor!=void 0&&b.highest_armor==1&&(g=filter_targets_by_highest_armor(g));b.highest_cost!=void 0&&b.highest_cost==1&&(g=filter_targets_by_highest_cost(g));b.lowest_cost!=void 0&&b.lowest_cost==1&&(g=filter_targets_by_lowest_cost(g));
match_array_values(d.proc,["redirect"])==0&&(g=filter_targets_by_redirect(g,d,c))}if(b.target=="card"){k=h.side;if(b.side=="ally"&&h.side==2||b.side=="enemy"&&h.side==1)k=2;if(b.side=="ally"&&h.side==1||b.side=="enemy"&&h.side==2)k=1;n=0;if(b.status!="hand")$.each(battle_info["deck_"+k],function(t,v){v.status!=b.status&&b.status!="any"||!(b.status!="hand"||v.time_left>0||b.can_target_zero!=void 0)||(g[n]=t,n++)});else for(var r=1;r<=10;r++)$.each(battle_info["deck_"+k],function(t,v){v.hand_slot!=
r||v.status!=b.status&&b.status!="any"||!(b.status!="hand"||v.time_left>0||b.can_target_zero!=void 0)||(g[n]=t,n++)});b.origin_unit!=void 0&&b.origin_unit==1&&(m=!1,$.each(g,function(t,v){v==c&&(g={0:c},m=!0)}),m==0&&(g={}));b.max_abilities!=void 0&&(g=filter_target_cards_by_max_abilities(g,b.max_abilities,e,k));b.types!=void 0&&filter_targets_by_card_type(g,b.types,k);b.highest_time_left!=void 0&&b.highest_time_left==1&&(g=filter_targets_by_highest_time_left(g,k));b.lowest_time_left!=void 0&&b.lowest_time_left==
1&&(g=filter_targets_by_lowest_time_left(g,k));b.lowest_cost!=void 0&&b.lowest_cost==1&&(g=filter_targets_by_lowest_cost_card(g,k))}b.add_targets!=void 0&&b.add_targets==1&&f!=void 0&&count_object(f)>0&&$.each(f,function(t,v){g[get_highest_key_in_object(g)+1]=v});a=calculate_effect({amount:b.target_amount},void 0,a,e);if(count_object(g)>a)for(a=count_object(g)-a-1;a>=0;a--)delete g[get_random_key_from_object(g)];return g}
function filter_targets_by_redirect(a,b,c){var e=[];b.effects!=void 0&&b.effects[0]!=void 0&&b.effects[0].subtypes!=void 0&&(e=b.effects[0].subtypes);var d={};$.each(a,function(f,g){if(count_object(d)==0)for(var h=-5;h<=5;h++)$.each(battle_info.combat_units,function(k,l){l.slot==h&&$.each(l.abilities,function(p,n){if((all_abilities[p].proc_chance==void 0||all_abilities[p].proc_chance>=Math.random()*100)&&match_array_values(all_abilities[p].proc,["redirect"])==1&&match_array_values(e,all_abilities[p].subtypes)==
1&&d[f]==void 0&&check_ability_can_fire(k,all_abilities[p],n,f)==1){var q=find_targets(k,all_abilities[p].from_targets,g,n,all_abilities[p]);$.each(q,function(m,r){r==g&&(m=find_targets(k,all_abilities[p].to_target,c,n,all_abilities[p]),count_object(m)>0&&(a[f]=m[get_random_key_from_object(m)],d[f]=!0,all_abilities[p].reduce_skill_after_use!=void 0&&battle_info.combat_units[k]!=void 0&&battle_info.combat_units[k].type!="spell"&&(grant_skill(k,k,-1,all_abilities[p].reduce_skill_after_use,!1),check_visible_skills(k)),
all_abilities[p].remove_skill_after_use!=void 0&&battle_info.combat_units[k]!=void 0&&battle_info.combat_units[k].type!="spell"&&(set_skill(k,k,0,all_abilities[p].remove_skill_after_use,!1),check_visible_skills(k))))})}})})});return a}function filter_targets_by_has_origin_card(a,b){$.each(a,function(c,e){b!=void 0&&b!=1||battle_info.combat_units[e].card_id!=void 0||delete a[c];b!=void 0&&b==0&&battle_info.combat_units[e].card_id!=void 0&&delete a[c]});return a}
function filter_targets_by_slot_free(a){$.each(a,function(b,c){check_slot_free(battle_info.combat_units[c].slot,battle_info.combat_units[c].side)==0&&delete a[b]});return a}function filter_targets_by_not_self(a,b){$.each(a,function(c,e){e==b&&delete a[c]});return a}function filter_targets_by_has_theme(a,b){$.each(a,function(c,e){match_array_values(battle_info.combat_units[e].theme,b)==0&&delete a[c]});return a}
function filter_targets_by_has_ability(a,b){$.each(a,function(c,e){battle_info.combat_units[e].abilities[b]==void 0&&delete a[c]});return a}function filter_targets_by_does_not_have_ability(a,b){$.each(a,function(c,e){battle_info.combat_units[e].abilities[b]!=void 0&&delete a[c]});return a}
function filter_targets_by_max_abilities(a,b,c){$.each(a,function(e,d){$.each(b,function(f,g){g=="ability_level"&&(g=c-1);battle_info.combat_units[d].abilities[f]!=void 0&&battle_info.combat_units[d].abilities[f]>g&&delete a[e]})});return a}function filter_target_cards_by_max_abilities(a,b,c,e){$.each(a,function(d,f){var g=all_available_cards[battle_info["deck_"+e][f].card_id];$.each(b,function(h,k){k=="ability_level"&&(k=c-1);g.abilities[h]!=void 0&&g.abilities[h]>k&&delete a[d]})});return a}
function filter_targets_by_immunities(a,b,c,e){$.each(a,function(d,f){var g=!1;$.each(battle_info.combat_units[f].abilities,function(h,k){var l=all_abilities[h].grants_immunities;$.each(c.effects,function(p,n){l!=void 0&&(match_array_values(l,[n.type])==1||match_array_values(l,n.subtypes)==1||battle_info.combat_units[e]!=void 0&&match_array_values(l,[battle_info.combat_units[e].type])==1)&&(g=!0)});all_abilities[h].negated_by_ability!=void 0&&battle_info.combat_units[e]!=void 0&&$.each(battle_info.combat_units[e].abilities,
function(p,n){p==all_abilities[h].negated_by_ability&&(g=!1)})});g==1&&delete a[d]});return a}function filter_targets_by_highest_time_left(a,b){var c=!1;$.each(a,function(e,d){if(battle_info["deck_"+b][d].time_left>c||c==0)c=battle_info["deck_"+b][d].time_left});$.each(a,function(e,d){battle_info["deck_"+b][d].time_left<c&&delete a[e]});return a}
function filter_targets_by_lowest_time_left(a,b){var c=!1;$.each(a,function(e,d){if(battle_info["deck_"+b][d].time_left<c||c==0)c=battle_info["deck_"+b][d].time_left});$.each(a,function(e,d){battle_info["deck_"+b][d].time_left>c&&delete a[e]});return a}function filter_targets_by_card_type(a,b,c){$.each(a,function(e,d){match_array_values([all_available_cards[battle_info["deck_"+c][d].card_id].type],b)==0&&delete a[e]});return a}
function filter_targets_by_not_types(a,b){$.each(a,function(c,e){match_array_values([battle_info.combat_units[e].type],b)==1&&delete a[c];match_array_values(["hero"],b)!=1||e!=1&&e!=2||delete a[c]});return a}function filter_targets_by_subtypes(a,b){$.each(a,function(c,e){e=battle_info.combat_units[e].subtypes;e!=void 0&&match_array_values(e,b)!=0||delete a[c]});return a}
function filter_targets_by_not_subtypes(a,b){$.each(a,function(c,e){e=battle_info.combat_units[e].subtypes;e!=void 0&&match_array_values(e,b)==1&&delete a[c]});return a}function filter_targets_by_card_ids(a,b,c){$.each(a,function(e,d){match_array_values([battle_info.combat_units[d].card_type],b)==c&&delete a[e]});return a}function filter_targets_by_not_card_ids(a,b){$.each(a,function(c,e){match_array_values([battle_info.combat_units[e].name],b)==1&&delete a[c]});return a}
function filter_targets_by_damaged(a){$.each(a,function(b,c){battle_info.combat_units[c].current_health>=battle_info.combat_units[c].health&&delete a[b]});return a}function filter_targets_by_not_damaged(a){$.each(a,function(b,c){battle_info.combat_units[c].current_health!=battle_info.combat_units[c].health&&delete a[b]});return a}function filter_targets_by_is_transformed(a){$.each(a,function(b,c){battle_info.combat_units[c].original_card_type==void 0&&delete a[b]});return a}
function filter_targets_by_has_negative_effect(a){$.each(a,function(b,c){battle_info.combat_units[c].effects!=void 0&&(battle_info.combat_units[c].effects.burning!=void 0&&battle_info.combat_units[c].effects.burning!=0||battle_info.combat_units[c].effects.poisoned!=void 0&&battle_info.combat_units[c].effects.poisoned!=0||battle_info.combat_units[c].effects.cursed!=void 0&&battle_info.combat_units[c].effects.cursed!=0||battle_info.combat_units[c].effects.doom!=void 0&&battle_info.combat_units[c].effects.doom!=
0)||delete a[b]});return a}
function filter_targets_by_has_effect(a,b,c){var e=b.amount;e=="ability_level"&&(e=c);$.each(a,function(d,f){battle_info.combat_units[f].effects==void 0&&e!=0&&b.limit=="min"?delete a[d]:(battle_info.combat_units[f].effects[b.effect_name]==void 0&&e!=0&&b.limit=="min"&&delete a[d],$.each(battle_info.combat_units[f].effects,function(g,h){var k=e;k=="ability_level"&&c!=void 0&&(k=c);b.effect_name==g&&(h>=k&&b.limit=="less"||h>k&&b.limit=="max"||h<k&&b.limit=="min")&&delete a[d]}))});return a}
function filter_targets_by_not_stunned(a,b){$.each(a,function(c,e){battle_info.combat_units[e].effects.stunned!=void 0&&battle_info.combat_units[e].effects.stunned>0&&delete a[c]});return a}function filter_targets_by_min_cost(a,b,c,e){$.each(a,function(d,f){var g=calculate_effect(b,d,c,e);battle_info.combat_units[f].time<g&&delete a[d]});return a}
function filter_targets_by_max_cost(a,b,c,e){$.each(a,function(d,f){var g=calculate_effect(b,d,c,e);battle_info.combat_units[f].time>g&&delete a[d]});return a}function filter_targets_by_min_hp(a,b){$.each(a,function(c,e){var d=battle_info.combat_units[e].current_health;battle_info.combat_units[e].temp_health!=void 0&&(d+=battle_info.combat_units[e].temp_health);d<b&&d!==!1&&delete a[c]});return a}
function filter_targets_by_min_total_hp(a,b){$.each(a,function(c,e){battle_info.combat_units[e].health<b&&battle_info.combat_units[e].health!==!1&&delete a[c]});return a}function filter_targets_by_max_hp(a,b,c,e){$.each(a,function(d,f){var g=calculate_effect({amount:b},f,c,e),h=battle_info.combat_units[f].current_health;battle_info.combat_units[f].temp_health!=void 0&&(h+=battle_info.combat_units[f].temp_health);h>g&&delete a[d]});return a}
function filter_targets_by_min_armor(a,b){$.each(a,function(c,e){battle_info.combat_units[e].armor<b&&delete a[c]});return a}function filter_targets_by_max_armor(a,b){$.each(a,function(c,e){battle_info.combat_units[e].armor>=b&&delete a[c]});return a}function filter_targets_by_min_power(a,b){$.each(a,function(c,e){e=calculate_effect({amount:"target_power"},e,void 0,void 0);(e<b||e===!1)&&delete a[c]});return a}
function filter_targets_by_max_power(a,b){$.each(a,function(c,e){calculate_effect({amount:"target_power"},e,void 0,void 0)>b&&delete a[c]});return a}
function filter_targets_by_lowest_hp(a){var b=!1;$.each(a,function(c,e){c=battle_info.combat_units[e].current_health;battle_info.combat_units[e].temp_health!=void 0&&(c+=parseInt(battle_info.combat_units[e].temp_health));if(c<b||b==0)b=c});$.each(a,function(c,e){var d=battle_info.combat_units[e].current_health;battle_info.combat_units[e].temp_health!=void 0&&(d+=parseInt(battle_info.combat_units[e].temp_health));d>b&&delete a[c]});return a}
function filter_targets_by_highest_hp(a){var b=!1;$.each(a,function(c,e){c=battle_info.combat_units[e].current_health;battle_info.combat_units[e].temp_health!=void 0&&(c+=parseInt(battle_info.combat_units[e].temp_health));if(c>b||b==0)b=c});$.each(a,function(c,e){var d=battle_info.combat_units[e].current_health;battle_info.combat_units[e].temp_health!=void 0&&(d+=parseInt(battle_info.combat_units[e].temp_health));d<b&&delete a[c]});return a}
function filter_targets_by_highest_max_hp(a){var b=!1;$.each(a,function(c,e){if(battle_info.combat_units[e].health>b||b==0)b=battle_info.combat_units[e].health});$.each(a,function(c,e){battle_info.combat_units[e].health<b&&delete a[c]});return a}function filter_targets_by_highest_armor(a){var b=!1;$.each(a,function(c,e){if(battle_info.combat_units[e].armor>b||b==0)b=battle_info.combat_units[e].armor});$.each(a,function(c,e){battle_info.combat_units[e].armor<b&&delete a[c]});return a}
function filter_targets_by_lowest_power(a){var b=!1;$.each(a,function(c,e){if(battle_info.combat_units[e].power<b||b==0)b=battle_info.combat_units[e].power===!1?0:battle_info.combat_units[e].power});$.each(a,function(c,e){battle_info.combat_units[e].power>b&&delete a[c]});return a}
function filter_targets_by_highest_power(a){var b=!1;$.each(a,function(c,e){if(battle_info.combat_units[e].power>b||b==0)b=battle_info.combat_units[e].power});$.each(a,function(c,e){battle_info.combat_units[e].power<b&&delete a[c]});return a}function filter_targets_by_highest_cost(a){var b=!1;$.each(a,function(c,e){if(battle_info.combat_units[e].time>b||b==0)b=battle_info.combat_units[e].time});$.each(a,function(c,e){battle_info.combat_units[e].time<b&&delete a[c]});return a}
function filter_targets_by_lowest_cost(a){var b=-1;$.each(a,function(c,e){if(battle_info.combat_units[e].time<b||b==-1)b=battle_info.combat_units[e].time});$.each(a,function(c,e){battle_info.combat_units[e].time>b&&b>-1&&delete a[c]});return a}
function filter_targets_by_lowest_cost_card(a,b){var c=!1;$.each(a,function(e,d){if(all_available_cards[battle_info["deck_"+b][d].card_id].time<c||c==0)c=all_available_cards[battle_info["deck_"+b][d].card_id].time});$.each(a,function(e,d){all_available_cards[battle_info["deck_"+b][d].card_id].time>c&&c!=0&&delete a[e]});return a}
function filter_targets_by_has_no_opposing(a,b){$.each(a,function(c,e){var d=!1;$.each(battle_info.combat_units,function(f,g){g.side!=battle_info.combat_units[e].side&&g.slot==battle_info.combat_units[e].slot&&g.current_health>0&&(b==void 0||g.type==b)&&(d=!0)});d==1&&delete a[c]});return a}
function filter_targets_by_has_opposing(a,b){$.each(a,function(c,e){var d=!1;$.each(battle_info.combat_units,function(f,g){g.side!=battle_info.combat_units[e].side&&g.slot==battle_info.combat_units[e].slot&&g.current_health>0&&(b==void 0||g.type==b)&&(d=!0)});d==0&&delete a[c]});return a}
function filter_targets_by_has_adjacent(a,b){$.each(a,function(c,e){var d=!1;$.each(battle_info.combat_units,function(f,g){g.side!=battle_info.combat_units[e].side||g.slot!=battle_info.combat_units[e].slot+1&&g.slot!=battle_info.combat_units[e].slot-1||g.slot==0||!(g.current_health>0)||b!=void 0&&g.type!=b||(d=!0)});d==0&&delete a[c]});return a}
function filter_targets_by_has_no_adjacent(a,b){$.each(a,function(c,e){var d=!1;$.each(battle_info.combat_units,function(f,g){g.side!=battle_info.combat_units[e].side||g.slot!=battle_info.combat_units[e].slot+1&&g.slot!=battle_info.combat_units[e].slot-1||g.slot==0||!(g.current_health>0)||b!=void 0&&g.type!=b||(d=!0)});d==1&&delete a[c]});return a}
function filter_targets_by_position(a,b,c,e){e==void 0&&(e=0);var d=e+0;d<0&&(d=0);c=="self"&&$.each(a,function(k,l){l!=b&&delete a[k]});c=="opposing"&&$.each(a,function(k,l){battle_info.combat_units[l].slot!=d&&delete a[k]});c=="opposing_wide"&&$.each(a,function(k,l){(battle_info.combat_units[l].slot>d+1||battle_info.combat_units[l].slot<d-1)&&delete a[k]});c=="adjacent"&&$.each(a,function(k,l){battle_info.combat_units[l].slot!=d-1&&battle_info.combat_units[l].slot!=d+1&&delete a[k]});c=="not_adjacent"&&
$.each(a,function(k,l){battle_info.combat_units[l].slot!=d-1&&battle_info.combat_units[l].slot!=d+1||delete a[k]});if(c=="nearest"){var f=10;$.each(a,function(k,l){k=battle_info.combat_units[l].slot-d;k<0&&(k*=-1);k<f&&(f=k)});$.each(a,function(k,l){l=battle_info.combat_units[l].slot-d;l<0&&(l*=-1);l>f&&delete a[k]})}if(c=="right"){var g=0;$.each(a,function(k,l){battle_info.combat_units[l].slot>g&&(g=battle_info.combat_units[l].slot)});$.each(a,function(k,l){battle_info.combat_units[l].slot<g&&delete a[k]})}if(c==
"left"){var h=10;$.each(a,function(k,l){battle_info.combat_units[l].slot<h&&(h=battle_info.combat_units[l].slot)});$.each(a,function(k,l){battle_info.combat_units[l].slot>h&&delete a[k]})}return a}
function process_combat_units(a,b,c){for(var e=-5;e<=5;e++)$.each(battle_info.combat_units,function(f,g){g.side==a&&g.acted_this_turn<1&&g.slot==e&&combat_alive==1&&(process_single_unit(f,void 0,c,b),check_all_ready_cards())});var d=!1;$.each(battle_info.combat_units,function(f,g){g.side==a&&g.acted_this_turn<1&&(d=!0)});d==1&&combat_alive==1&&process_combat_units(a,b,c)}
function enable_all_units_to_act(a,b){$.each(battle_info.combat_units,function(c,e){if(b==void 0||e.side==b){e.failed_to_act_this_phase=!1;if(e.acted_this_turn==void 0||e.acted_this_turn>0||a==1)e.acted_this_turn=0;a!=void 0&&a==1&&(e.used_ability=!1)}})}
function check_all_ready_cards(a){a=void 0;for(var b=1;b<=2;b++)if(a==void 0||a==b)for(var c=1;c<=10;c++)$.each(battle_info["deck_"+b],function(d,f){f.time_left<=0&&f.status=="hand"&&f.hand_slot==c&&combat_alive==1&&play_card(b,d)});var e=!0;for(b=1;b<=2;b++)a!=void 0&&a!=b||$.each(battle_info["deck_"+b],function(d,f){f.time_left<=0&&f.status=="hand"&&(e=!1)});e==0&&combat_alive==1&&check_all_ready_cards(a)}
function play_card(a,b,c,e){var d=all_available_cards[battle_info["deck_"+a][b].card_id],f=!0,g=1;a==1&&(g=2);(c==void 0||c==0)&&d.abilities.minimum_allies!=void 0&&count_ally_units(a)<d.abilities.minimum_allies&&(f=!1);(c==void 0||c==0)&&d.abilities.minimum_ally_creatures!=void 0&&count_ally_units(a,"creature")<d.abilities.minimum_ally_creatures&&(f=!1);(c==void 0||c==0)&&d.abilities.minimum_dead_ally_creatures!=void 0&&count_grave_cards(battle_info["deck_"+a],"creature")<d.abilities.minimum_dead_ally_creatures&&
(f=!1);(c==void 0||c==0)&&d.abilities.minimum_enemies!=void 0&&count_enemy_units(a)<d.abilities.minimum_enemies&&(f=!1);(c==void 0||c==0)&&d.abilities.minimum_enemy_creatures!=void 0&&count_enemy_units(a,"creature")<d.abilities.minimum_enemy_creatures&&(f=!1);(c==void 0||c==0)&&d.abilities.maximum_allies!=void 0&&count_ally_units(a)>d.abilities.maximum_allies&&(f=!1);(c==void 0||c==0)&&d.abilities.maximum_enemies!=void 0&&count_enemy_units(a)>d.abilities.maximum_enemies&&(f=!1);(c==void 0||c==0)&&
d.abilities.minimum_units!=void 0&&count_units()<d.abilities.minimum_units&&(f=!1);(c==void 0||c==0)&&d.abilities.maximum_units!=void 0&&count_units()>d.abilities.maximum_units&&(f=!1);(c==void 0||c==0)&&d.abilities.no_allies!=void 0&&count_ally_units(a)>0&&(f=!1);(c==void 0||c==0)&&d.abilities.maximum_hero_health!=void 0&&battle_info.combat_units[a].current_health/battle_info.combat_units[a].health*100>d.abilities.maximum_hero_health&&(f=!1);(c==void 0||c==0)&&d.abilities.min_enemy_hand_cards!=void 0&&
count_hand_cards(battle_info["deck_"+g])<d.abilities.min_enemy_hand_cards&&(f=!1);(c==void 0||c==0)&&d.abilities.min_hand_cards!=void 0&&count_hand_cards(battle_info["deck_"+a])<d.abilities.min_hand_cards&&(f=!1);(c==void 0||c==0)&&d.abilities.max_hand_cards!=void 0&&count_hand_cards(battle_info["deck_"+a])>d.abilities.max_hand_cards&&(f=!1);if(f==1){f=!1;battle_info["deck_"+a][b].status="in_play";if(d.type=="creature"||d.type=="structure"||d.type=="object")f=play_unit_card(a,battle_info["deck_"+
a][b].card_id,b,c,e);d.type=="artifact"&&(f=play_artifact_card(a,battle_info["deck_"+a][b].card_id,b));if(d.type=="spell"||d.type=="attack"||d.type=="consumable")f=play_action_card(a,battle_info["deck_"+a][b].card_id,b);f==1&&update_deck_counts()}else f=!1;f==1&&(battle_info["deck_"+a][b].played=battle_info["deck_"+a][b].played==void 0?1:battle_info["deck_"+a][b].played+1);if(f==0&&battle_info["deck_"+a][b].time_left<1){battle_info["deck_"+a][b].status="hand";battle_info["deck_"+a][b].time_left<1&&
(battle_info["deck_"+a][b].time_left=1);var h=battle_info["deck_"+a][b].hand_slot+0,k=battle_info["deck_"+a][b].time_left+0,l=a+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+h+".side_"+l+" .card_time").html(k)},total_timeout)}else check_ability_procs(a,"card_played"),e==void 0&&check_all_ready_cards()}
function clone_unit(a,b,c,e,d){var f=!1,g=find_free_slot(a,battle_info.combat_units[b].card_type);if(g!=0&&combat_alive==1){highest_unit_id++;var h=highest_unit_id;battle_info.combat_units[h]=true_copyobject(battle_info.combat_units[b]);battle_info.combat_units[h].abilities={};$.each(battle_info.combat_units[b].abilities,function(q,m){q=="bring_clone"||d.remove_skills!=void 0&&match_array_values(d.remove_skills,q)!=0||(battle_info.combat_units[h].abilities[q]=m)});battle_info.combat_units[h].slot=
g;battle_info.combat_units[h].unit_id=h;battle_info.combat_units[h].card_id=void 0;battle_info.combat_units[h].acted_this_turn=0;c!=void 0&&c==1&&(battle_info.combat_units[h].effects.stunned=battle_info.combat_units[h].effects.stunned==void 0?1:battle_info.combat_units[h].effects.stunned+1);f=!0;var k=0;battle_info["deck_"+a][b]!=void 0&&(k=battle_info["deck_"+a][b].hand_slot);var l="";if(e==void 0||battle_info.combat_units[e]==void 0||battle_info.combat_units[e].type!="creature"&&battle_info.combat_units[e].type!=
"structure"&&battle_info.combat_units[e].type!="object")p=parse_combat_unit(battle_info.combat_units[h],"hand_card fake_hand_slot_"+k);else{var p=parse_combat_unit(battle_info.combat_units[h],"slot_"+battle_info.combat_units[e].slot,!0);l="slot_"+battle_info.combat_units[e].slot}timeout_key++;var n=battle_info.combat_units[h].slot;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(p);setTimeout(function(){$(".unit_id_"+h).removeClass("hand_card");$(".unit_id_"+h).removeClass("fake_hand_slot_"+
k);$(".unit_id_"+h).removeClass(l);$(".unit_id_"+h).addClass("slot_"+n)},50)},total_timeout);check_visible_skills(h);check_unit_power(h);check_unit_hp(h);update_passive_effects(h);total_timeout+=500*battle_speed;$.each(battle_info.combat_units[h].abilities,function(q,m){match_array_values(all_abilities[q].proc,["on_play"])==1&&q!="bring_clone"&&(total_timeout+=500,process_ability(h,all_abilities[q],m,void 0,"on_play"))})}return f}
function turn_into(a,b,c,e){if(battle_info.combat_units[a]!=void 0&&b.card_id!=void 0){var d=true_copyobject(battle_info.combat_units[a]),f=true_copyobject(battle_info.combat_units[a].effects),g=0;battle_info.combat_units[a].abilities.blessed!=void 0&&(g+=battle_info.combat_units[a].abilities.blessed);var h=battle_info.combat_units[a].card_type,k=b.card_id+"",l=b.card_subtypes;b.card_subtypes=="target_subtypes"&&(l=battle_info.combat_units[a].subtypes);b.additional_subtypes!=void 0&&$.each(b.additional_subtypes,
function(q,m){l[get_highest_key_in_object(l)+1]=m});k=="random"&&(k=get_random_card_based_on_time(b.card_type,calculate_effect({amount:b.max_time,amount_adjustment:b.max_time_adjustment},a,c,e),void 0,void 0,l,calculate_effect({amount:b.min_time},a,c,e),[h]));if(k!=0){var p=create_combat_unit(all_available_cards[k],d.side);d.slot==0&&all_available_cards[k].hero_version!=void 0&&(p=create_hero(k,d.side));$.each(p,function(q,m){battle_info.combat_units[a][q]=m});battle_info.combat_units[a].card_type=
k;d.original_card_type==void 0&&(battle_info.combat_units[a].original_card_type=h);battle_info.combat_units[a].current_health=battle_info.combat_units[a].health;$.each(battle_info.combat_units[a].abilities,function(q,m){all_abilities[q].remove_on_transform!=void 0&&all_abilities[q].remove_on_transform==1&&delete battle_info.combat_units[a].abilities[q]});g>0&&(battle_info.combat_units[a].abilities.blessed==void 0||battle_info.combat_units[a].abilities.blessed<g)&&(battle_info.combat_units[a].abilities.blessed=
g);battle_info.combat_units[a].effects=true_copyobject(f);battle_info.combat_units[a].original_unit=true_copyobject(d);var n=parse_abilities(a);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a+" .card_image").css("background-image","url(images/"+p.image+")");p.image_position!=void 0?$(".unit_id_"+a+" .card_image").css("background-position",p.image_position):$(".unit_id_"+a+" .card_image").css("background-position","");$(".unit_id_"+a+" .card_name").html(capitalizeFirstLetter(p.name));
$(".battle_container .unit_id_"+a+" .card_abilities").html(n);$(".battle_container .unit_id_"+a+" .card_color").removeClass("color_green color_blue color_purple color_red color_orange color_yellow color_colorless");count_object(p.color)==1?($(".battle_container .unit_id_"+a+" .card_color").addClass("color_"+p.color[0]),$(".battle_container .unit_id_"+a+" .color_number_0").addClass("color_number_0_not"),$(".battle_container .unit_id_"+a+" .color_number_0").removeClass("color_number_0"),$(".battle_container .unit_id_"+
a+" .color_number_1").addClass("hidden")):($(".battle_container .unit_id_"+a+" .color_number_0").addClass("color_"+p.color[0]),$(".battle_container .unit_id_"+a+" .color_number_1").addClass("color_"+p.color[1]),$(".battle_container .unit_id_"+a+" .color_number_1").removeClass("hidden"))},total_timeout);check_unit_hp(a);check_visible_skills(a);check_unit_power(a);update_passive_effects(a);total_timeout+=500*battle_speed}}}
function turn_into_original(a,b){if(battle_info.combat_units[a]!=void 0&&battle_info.combat_units[a].original_card_type!=void 0){b=true_copyobject(battle_info.combat_units[a]);var c=true_copyobject(battle_info.combat_units[a].original_unit),e=true_copyobject(battle_info.combat_units[a].effects);battle_info.combat_units[a].card_type=battle_info.combat_units[a].original_card_type;$.each(c,function(f,g){battle_info.combat_units[a][f]=g});battle_info.combat_units[a].slot=b.slot;battle_info.combat_units[a].side=
b.side;delete battle_info.combat_units[a].original_card_type;$.each(battle_info.combat_units[a].abilities,function(f,g){all_abilities[f].remove_on_transform!=void 0&&all_abilities[f].remove_on_transform==1&&delete battle_info.combat_units[a].abilities[f]});battle_info.combat_units[a].effects=true_copyobject(e);var d=parse_abilities(a);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+a+" .card_image").css("background-image","url(images/"+c.image+")");c.image_position!=void 0?
$(".unit_id_"+a+" .card_image").css("background-position",c.image_position):$(".unit_id_"+a+" .card_image").css("background-position","");$(".unit_id_"+a+" .card_name").html(capitalizeFirstLetter(c.name));$(".battle_container .unit_id_"+a+" .card_abilities").html(d);$(".battle_container .unit_id_"+a+" .card_color").removeClass("color_green color_blue color_purple color_red color_orange color_yellow color_colorless");count_object(c.color)==1?($(".battle_container .unit_id_"+a+" .card_color").addClass("color_"+
c.color[0]),$(".battle_container .unit_id_"+a+" .color_number_0").addClass("color_number_0_not"),$(".battle_container .unit_id_"+a+" .color_number_0").removeClass("color_number_0"),$(".battle_container .unit_id_"+a+" .color_number_1").addClass("hidden")):($(".battle_container .unit_id_"+a+" .color_number_0_not").addClass("color_number_0"),$(".battle_container .unit_id_"+a+" .color_number_0_not").removeClass("color_number_0_not"),$(".battle_container .unit_id_"+a+" .color_number_0").addClass("color_"+
c.color[0]),$(".battle_container .unit_id_"+a+" .color_number_1").addClass("color_"+c.color[1]),$(".battle_container .unit_id_"+a+" .color_number_1").removeClass("hidden"))},total_timeout);check_unit_hp(a);check_visible_skills(a);check_unit_power(a);update_passive_effects(a);total_timeout+=500*battle_speed;return!0}return!1}
function play_unit_card(a,b,c,e,d){var f=!1,g=find_free_slot(a,b);if(e!=void 0&&g==0||e!=void 0&&e!=1)g=find_free_slot(a,b,"none",e,void 0,d,void 0);if(g!=0&&combat_alive==1){highest_unit_id++;var h=highest_unit_id;battle_info.combat_units[h]=create_combat_unit(all_available_cards[b],a);battle_info.combat_units[h].slot=g;battle_info.combat_units[h].side=a;battle_info.combat_units[h].origin_side=a;battle_info.combat_units[h].unit_id=h;battle_info.combat_units[h].card_id=c;battle_info.combat_units[h].card_type=
b;battle_info.combat_units[h].acted_this_turn=a==active_turn?0:1;battle_info.combat_units[h].used_ability=!1;battle_info.combat_units[h].current_health=battle_info.combat_units[h].health;f=!0;var k=0;battle_info["deck_"+a][c]!=void 0&&(k=battle_info["deck_"+a][c].hand_slot);var l="",p="side_"+a;if(d==void 0||battle_info.combat_units[d]==void 0||battle_info.combat_units[d].type!="creature"&&battle_info.combat_units[d].type!="structure"&&battle_info.combat_units[d].type!="object"&&battle_info.combat_units[d].type!=
"spell"&&battle_info.combat_units[d].type!="artifact")n=parse_combat_unit(battle_info.combat_units[h],"hand_card fake_hand_slot_"+k,!0);else{battle_info.combat_units[d].side!=a&&(p="side_"+battle_info.combat_units[d].side);var n=parse_combat_unit(battle_info.combat_units[h],"slot_"+(battle_info.combat_units[d].slot+" combat_unzoom "+p),!0);l="slot_"+(battle_info.combat_units[d].slot+" combat_unzoom "+p)}timeout_key++;var q=battle_info.combat_units[h].slot;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(n);
$(".unit_id_"+h).removeClass("side_"+a);$(".unit_id_"+h).addClass(p)},total_timeout);timeout_key++;if(battle_info["deck_"+a][c]!=void 0){var m=battle_info["deck_"+a][c].hand_slot+0,r=a+0,t=battle_info["deck_"+a][c].hand_slot_id+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+m+".side_"+r+".hand_slot_id_"+t).each(function(){this.remove()})},total_timeout);battle_info["deck_"+a][c].status="in_play"}all_timeouts[timeout_key]=setTimeout(function(){$(".unit_id_"+h).removeClass("hand_card");
$(".unit_id_"+h).removeClass("fake_hand_slot_"+k);$(".unit_id_"+h).removeClass(l);$(".unit_id_"+h).removeClass(p);$(".unit_id_"+h).addClass("side_"+a);$(".unit_id_"+h).addClass("slot_"+q)},total_timeout+150);check_visible_skills(h);update_passive_effects(h);total_timeout+=1E3*battle_speed;battle_info.combat_units[d]!=void 0&&$.each(battle_info.combat_units[d].abilities,function(v,w){match_array_values(all_abilities[v].proc,["played_unit"])==1&&process_ability(d,all_abilities[v],w,h,void 0,"played_unit")});
check_ability_procs(a,all_available_cards[b].type+"_card_played",h);check_ability_procs(a,"unit_card_played",h);a==2&&(check_quests(all_available_cards[b].type+"_card_played"),add_battle_stats(all_available_cards[b].type+"_card_played"),$.each(all_available_cards[b].subtypes,function(v,w){check_quests(w+"_card_played")}));battle_info.combat_units[h]!=void 0&&$.each(battle_info.combat_units[h].abilities,function(v,w){match_array_values(all_abilities[v].proc,["on_play"])==1&&(total_timeout+=1E3*battle_speed,
battle_info.combat_units[h]!=void 0&&process_ability(h,all_abilities[v],w,void 0,void 0,"on_play"))});battle_info["deck_"+a][c]!=void 0&&battle_info["deck_"+a][c].status=="hand"&&(f=!1)}return f}
function play_action_card(a,b,c,e){if(combat_alive==1){highest_unit_id++;var d=highest_unit_id;battle_info.combat_units[d]=create_combat_unit(all_available_cards[b],a);battle_info.combat_units[d].slot=-10;battle_info.combat_units[d].side=a;battle_info.combat_units[d].origin_side=a;battle_info.combat_units[d].unit_id=d;battle_info.combat_units[d].card_id=c;battle_info.combat_units[d].card_type=b;battle_info.combat_units[d].acted_this_turn=0;battle_info.combat_units[d].used_ability=!1;battle_info.combat_units[d].current_health=
battle_info.combat_units[d].health;var f=0;battle_info["deck_"+a][c]!=void 0&&(f=battle_info["deck_"+a][c].hand_slot+0);var g=parse_combat_unit(battle_info.combat_units[d],"hand_card fake_hand_slot_"+f),h=total_timeout+0;total_timeout+=1500*battle_speed;check_ability_procs(a,all_available_cards[b].type+"_card_preplayed",d);var k=!1,l=!1;k=battle_info.combat_units[d]!=void 0?process_single_unit(d,!0):l=!0;if(k==1||e!=void 0){check_ability_procs(a,all_available_cards[b].type+"_card_willbeplayed",d);
var p=a+0;battle_info["deck_"+a][c]!=void 0&&battle_info.combat_units[d]!=void 0&&(battle_info["deck_"+a][c].status="grave",check_ability_procs("deck_"+a,"moved_to_grave",c));timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+f+".side_"+p).remove();$(".battle_container").append(g);setTimeout(function(){$(".unit_id_"+d).removeClass("hand_card");$(".unit_id_"+d).removeClass("fake_hand_slot_"+f)},100)},h);total_timeout+=500*battle_speed;battle_info.combat_units[d]!=void 0&&
total_timeout<h+5E3*battle_speed&&(total_timeout=h+5E3*battle_speed);battle_info.combat_units[d]!=void 0&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .unit_id_"+d).remove()},total_timeout),total_timeout+=500*battle_speed);l==0&&(check_ability_procs(a,all_available_cards[b].type+"_card_played",c),a==2&&(check_quests(all_available_cards[b].type+"_card_played"),add_battle_stats(all_available_cards[b].type+"_card_played"),$.each(all_available_cards[b].subtypes,
function(n,q){check_quests(q+"_card_played")})))}else total_timeout=h+0;delete battle_info.combat_units[d]}return k}
function play_artifact_card(a,b,c,e){e=!0;var d=find_free_artifact_slot(a);if(d!=0&&combat_alive==1){highest_unit_id++;var f=highest_unit_id;battle_info.combat_units[f]=create_combat_unit(all_available_cards[b],a);battle_info.combat_units[f].slot=d;battle_info.combat_units[f].side=a;battle_info.combat_units[f].origin_side=a;battle_info.combat_units[f].unit_id=f;battle_info.combat_units[f].card_id=c;battle_info.combat_units[f].card_type=b;battle_info.combat_units[f].acted_this_turn=0;battle_info.combat_units[f].used_ability=
!1;battle_info.combat_units[f].current_health=battle_info.combat_units[f].health;var g=0;battle_info["deck_"+a][c]!=void 0&&(g=battle_info["deck_"+a][c].hand_slot);var h=parse_combat_unit(battle_info.combat_units[f],"hand_card fake_hand_slot_"+g);d=total_timeout+0;total_timeout+=100*battle_speed;if(e!=void 0){var k=0;c!=void 0&&(k=battle_info["deck_"+a][c].hand_slot+0);var l=a+0;battle_info["deck_"+a][c]!=void 0&&(battle_info["deck_"+a][c].status="in_play");timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){$(".hand_slot_"+k+".side_"+l).remove();$(".battle_container").append(h);setTimeout(function(){$(".unit_id_"+f).removeClass("hand_card");$(".unit_id_"+f).removeClass("fake_hand_slot_"+g)},100)},d);total_timeout<d+100&&(total_timeout=d+100);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){},total_timeout);$.each(battle_info.combat_units,function(p,n){});setTimeout(function(){$(".unit_id_"+f).addClass("placed")},total_timeout);total_timeout+=500*battle_speed;check_ability_procs(a,
all_available_cards[b].type+"_card_played",c);a==2&&(check_quests(all_available_cards[b].type+"_card_played"),add_battle_stats(all_available_cards[b].type+"_card_played"),$.each(all_available_cards[b].subtypes,function(p,n){check_quests(n+"_card_played")}));$.each(battle_info.combat_units[f].abilities,function(p,n){match_array_values(all_abilities[p].proc,["on_play"])==1&&(total_timeout+=1E3*battle_speed,process_ability(f,all_abilities[p],n,void 0,void 0,"on_play"))})}return!0}return!1}
function find_free_artifact_slot(a){for(var b={},c=-5;c<=-1;c++)check_slot_free(c,a)==1&&(b[c]=c);return pick_left_most_slot(b)}
function find_free_slot(a,b,c,e,d,f,g){var h=!1,k={};b=all_available_cards[b];if(b.type!="artifact")for(var l=1;l<=5;l++){var p=check_slot_free(l,a);p==1&&(k[l]=l)}else for(l=-5;l<=-1;l++)p=check_slot_free(l,a),p==1&&(k[l]=l);c==void 0&&b.safe_slot!=void 0&&b.safe_slot==1&&(k=filter_free_slots_by_safe(k,d));c==void 0&&b.safe_slot!=void 0&&b.safe_slot==0&&(k=filter_free_slots_by_not_safe(k,d));c!=void 0&&c==1&&(k=filter_free_slots_by_safe(k,d));c!=void 0&&c==0&&(k=filter_free_slots_by_not_safe(k,d));
g!=void 0&&$.each(g,function(n,q){n=="has_adjacent_structure"&&q==1&&(k=filter_free_slots_by_has_adjacent(k,"structure",f));n=="has_adjacent_creature"&&q==1&&(k=filter_free_slots_by_has_adjacent(k,"creature",f));n=="opposing_structure"&&(k=filter_free_slots_by_opposing(k,"structure",f,q))});if(count_object(k)>0)if(e==void 0){if(b.placement==void 0||b.placement=="left")h=pick_left_most_slot(k);b.placement!=void 0&&b.placement=="right"&&(h=pick_right_most_slot(k));b.placement!=void 0&&b.placement==
"random"&&(h=pick_random_slot(k))}else e=="right"&&(h=pick_right_most_slot(k)),e=="left"&&(h=pick_left_most_slot(k)),e=="random"&&(h=pick_random_slot(k)),e=="furthest"&&(h=pick_furthest_slot(k,f)),e=="adjacent_of_origin"&&(h=pick_adjacent_slot(k,f)),e=="origin_old_slot"&&(h=pick_origin_old_slot(k,f)),e=="opposing"&&(h=f==void 0||battle_info.combat_units[f]==void 0?!1:k[battle_info.combat_units[f].slot]==void 0?!1:battle_info.combat_units[f].slot);return h}
function filter_free_slots_by_opposing(a,b,c,e){$.each(a,function(d,f){var g=!1;$.each(battle_info.combat_units,function(h,k){k.slot!=f||b!=void 0&&b!=k.type||(g=!0)});g==e&&delete a[d]});return a}function filter_free_slots_by_has_adjacent(a,b,c){$.each(a,function(e,d){var f=!1;$.each(battle_info.combat_units,function(g,h){h.slot!=d+1&&h.slot!=d-1||b!=void 0&&b!=h.type||c!=void 0&&c==h.unit_id||h.side!=battle_info.combat_units[c].side||(f=!0)});f==0&&delete a[e]});return a}
function check_slot_free(a,b){var c=!0;$.each(battle_info.combat_units,function(e,d){e=0;d.current_health!=void 0&&d.current_health>0&&d.dead==void 0&&(e+=d.current_health);d.temp_health!=void 0&&d.temp_health>0&&d.dead==void 0&&(e+=d.temp_health);d.side==b&&d.slot==a&&(e>0||d.health==0)&&d.dead==void 0&&(c=!1)});return c}function filter_free_slots_by_safe(a,b){$.each(a,function(c,e){$.each(battle_info.combat_units,function(d,f){f.slot!=e||b!=void 0&&b!=f.type||delete a[c]})});return a}
function filter_free_slots_by_not_safe(a,b){$.each(a,function(c,e){var d=!1;$.each(battle_info.combat_units,function(f,g){g.slot==e&&(b==void 0||b==g.type)&&g.current_health>0&&(d=!0)});d==0&&delete a[c]});return a}function pick_left_most_slot(a){var b=!1;$.each(a,function(c,e){if(b==0||e<b)b=e});return b}function pick_right_most_slot(a){var b=!1;$.each(a,function(c,e){if(b==0||e>b)b=e});return b}
function pick_furthest_slot(a,b){var c=!1,e=0;battle_info.combat_units[b]!=void 0&&(e=battle_info.combat_units[b].slot);var d=0;$.each(a,function(f,g){f=g-e;f<0&&(f*=-1);f>=d&&(c=g,d=f+0)});return c}function pick_random_slot(a){return a[get_random_key_from_object(a)]}function pick_adjacent_slot(a,b){var c=!1,e=battle_info.combat_units[b].slot;$.each(a,function(d,f){f!=e-1&&f!=e+1&&delete a[d]});count_object(a)>0&&(c=a[get_random_key_from_object(a)]);return c}
function pick_origin_old_slot(a,b){var c=!1,e=!1;battle_info.combat_units[b].old_slot!=void 0&&(e=battle_info.combat_units[b].old_slot);$.each(a,function(d,f){f!=e&&delete a[d]});count_object(a)>0&&(c=a[get_random_key_from_object(a)]);return c}
function reduce_all_hand_times(a){var b=!1;$.each(battle_info["deck_"+a],function(c,e){if(e.status=="hand"&&e.time_left>0&&combat_alive==1){b=!0;--e.time_left;var d=e.hand_slot+0,f=e.time_left+0,g=a+0;timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".hand_slot_"+d+".side_"+g+" .card_time").html(f)},total_timeout)}});b==1&&combat_alive==1&&(total_timeout+=500*battle_speed)}
function add_card_to_combat_deck(a,b,c){if(all_available_cards[b]!=void 0){var e=battle_info["deck_"+a],d=get_highest_key_in_object(e)+1;e[d]={card_id:b,status:"deck",time_left:all_available_cards[b].time};c=="grave"&&(e[d].status="grave");update_deck_counts();c=="hand"?draw_card(a,d):total_timeout+=250*battle_speed}}
function draw_card(a,b,c,e,d){d==void 0&&(d=!0);var f=battle_info["deck_"+a],g=count_deck_cards(f,c),h=Math.ceil(Math.random()*g),k=!1,l=get_first_free_hand_slot(f),p=0,n=!1;hand_slot_id+=1;l!=0&&g>0&&combat_alive==1&&($.each(f,function(q,m){if(!(m.status!="deck"&&b==void 0||c!=void 0&&all_available_cards[m.card_id].type!=c)&&(h--,(h==0&&b==void 0||b!=void 0&&q==b)&&k==0)){n=q;all_available_cards[m.card_id].abilities.righthand!=void 0&&(l=get_last_free_hand_slot(f));m.status="hand";m.hand_slot=l;
m.time_left=all_available_cards[m.card_id].time;m.hand_slot_id=hand_slot_id;var r=parse_hand_card(a,q,d,hand_slot_id);timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(r);all_timeouts[timeout_key]=setTimeout(function(){$(".hand_card.hand_slot_"+l).removeClass("just_drawn")},50)},total_timeout);k=!0;p=all_available_cards[m.card_id].time}}),k==1&&(update_deck_counts(),total_timeout=p>0?total_timeout+500*battle_speed:total_timeout+500),n!=0&&d==1&&check_ability_procs(a,
"card_drawn",n,[]));g==0&&combat_alive==1&&e!=void 0&&receive_damage(a,void 0,e,[])}
function parse_hand_card(a,b,c,e){var d=battle_info["deck_"+a][b],f="",g="";b=all_available_cards[d.card_id];c!=void 0&&c==1&&(g="just_drawn");c="";if(a==2||test_mode==1)c="onclick=\"show_card_details('"+d.card_id+"')\"";f+='<div class="card hand_card hand_slot_'+d.hand_slot+" side_"+a+" "+g+" hand_slot_id_"+e+'" '+c+' style="">';a==2&&gamedata.hand_card_back!=void 0&&gamedata.hand_card_back!=""&&(f+='<div class="hand_card_back" style="background-image:url(images/'+gamedata.hand_card_back+')"></div>');
a==1&&enemy_card_back!=void 0&&enemy_card_back!=""&&(f+='<div class="hand_card_back" style="background-image:url(images/'+enemy_card_back+')"></div>');count_object(b.color)>1?$.each(b.color,function(h,k){f+='<div class="card_color color_'+k+" color_number_"+h+'"></div>'}):f+='<div class="card_color color_'+b.color[0]+'"></div>';f+='<div class="card_time">'+d.time_left+"</div>";a==2&&(a=findLongestWord(b.name),e=13,a>8&&(e=8/a*13),f+='<div class="card_name" style="font-size:'+e+'px">'+b.name+"</div>");
return f+="</div>"}function show_unit_details(a,b){var c="";$.each($(".unit.slot_"+b+".side_"+a),function(e,d){e=d.getAttribute("data-card_type");all_available_cards[e]!=void 0&&(c=e)});c!=""&&$.each(battle_info.combat_units,function(e,d){d.side==a&&d.slot==b&&(c=d.card_type)});c!=""&&(b==0?show_card_details(c,!0):show_card_details(c),pause_game())}
function get_first_free_hand_slot(a){for(var b=!1,c=1;c<11;c++){var e=!0;b==0?$.each(a,function(d,f){f.status=="hand"&&f.hand_slot!=void 0&&f.hand_slot==c&&(e=!1)}):e=!1;e==1&&(b=c)}return b}function get_last_free_hand_slot(a){for(var b=!1,c=10;c>0;c--){var e=!0;b==0?$.each(a,function(d,f){f.status=="hand"&&f.hand_slot!=void 0&&f.hand_slot==c&&(e=!1)}):e=!1;e==1&&(b=c)}return b}
function clear_all_timeouts(){$.each(all_timeouts,function(a,b){clearTimeout(all_timeouts[a]);delete all_timeouts[a]});clearTimeout(next_turn_timeout);clearTimeout(next_action_timeout)}function set_all_enemy_cards(a){$.each(battle_info.deck_1,function(b,c){c.card_id=a})}
function update_wins_losses(a,b,c){c==void 0?$.post("ajax.php",{data:"update_wins_losses",deck_id:arena_deck_id,wins:a,losses:b},function(e){}):(console.log(gamedata.account_id),$.post("ajax.php",{data:"update_wins_losses",current_id:gamedata.account_id,deck_id:arena_deck_id,wins:a,losses:b},function(e){console.log(e)}))}
function resign_combat(){clear_all_timeouts();$(".projectile").remove();endless_waves==1?(current_reward_origin="waves",current_reward_text="You resigned at wave "+endless_wave_count+"...",show_content("current_rewards")):(gamedata.battles_lost++,gamedata.summon_min_power*=.9,saveToLocalStorage(),show_content("summon"))}
function end_combat(a){a!=void 0&&a==1&&(gamedata.battles_lost++,gamedata.summon_min_power*=.9,saveToLocalStorage());clear_all_timeouts();$(".projectile").remove();current_battle_type=="random"&&(map_hero!=void 0&&all_available_cards[map_hero]!=void 0?show_content("map"):show_content("random_battles"));current_battle_type=="summoned"&&show_content("summon")}function pause_game(){}
function check_ready_to_resume(){game_paused==1&&(game_paused=!1,ready_to_resume==1&&combat_alive==1&&process_next_turn())}
function process_player_combat_boosts(){gamedata.combat_boosts!=void 0&&(gamedata.combat_boosts=sortObj(gamedata.combat_boosts),$.each(gamedata.combat_boosts,function(a,b){b>0&&(all_available_cards[a].type!="creature"&&all_available_cards[a].type!="structure"&&all_available_cards[a].type!="object"||play_unit_card(2,a),all_available_cards[a].type!="spell"&&all_available_cards[a].type!="consumable"||play_action_card(2,a),all_available_cards[a].type=="artifact"&&play_artifact_card(2,a),--gamedata.combat_boosts[a])}),
saveToLocalStorage())}function process_enemy_combat_boosts(){battle_info.enemy_combat_boosts!=void 0&&$.each(battle_info.enemy_combat_boosts,function(a,b){if(b>0)for(--b;b>=0;b--)play_action_card(1,a,void 0,!0)})}var projectile_count=0;
function create_projectile(a,b,c,e,d,f,g,h,k,l){if(battle_info.combat_units[a]!=void 0&&(battle_info.combat_units[b]!=void 0||d!=void 0)){g==void 0&&(g="");k==void 0&&(k=1E3);k*=battle_speed;k<500&&(k=500);projectile_count++;var p=projectile_count+0;a=battle_info.combat_units[a];var n=a.slot+"",q=a.side+"";if(d==void 0){b=battle_info.combat_units[b];var m="slot_"+b.slot,r=b.side+""}else d=="deck"&&f!=void 0&&(a=1,f=="ally"&&q==2&&(a=2),f=="enemy"&&q==1&&(a=2),b=battle_info["deck_"+a][b],m="hand_card hand_slot_"+
b.hand_slot,b.status!="hand"&&(m="hand_card deck_slot"),r=a+""),d=="deck"&&f==void 0&&(m=m="hand_card deck_slot",r=q+"");d="";l!=void 0&&l==1&&(d=" big ");var t='<div class="projectile card unit projectile_count_'+p+" projectile_"+c+" slot_"+n+" side_"+q+" "+d+'"><div class="projectile_text" '+(h!=void 0?'style="color:'+h+'"':"")+">"+g+"</div></div>";timeout_key++;all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container").append(t)},total_timeout-0);timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){$(".projectile_count_"+p).removeClass("slot_"+n+" side_"+q);$(".projectile_count_"+p).addClass(m+" side_"+r)},total_timeout+k/10);e!=void 0&&e==1&&(timeout_key++,all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .projectile_count_"+p).addClass("dead")},total_timeout+k/3),timeout_key++);all_timeouts[timeout_key]=setTimeout(function(){$(".battle_container .projectile_count_"+p).remove()},total_timeout+k*1)}}
var possible_pickups={},pickup_counter=0,clear_pickup_timers={},last_spawned_pickup=0;
function spawn_monthly_pickup(){if(count_object(pickup_rewards)<100&&last_spawned_pickup+1E3<nowint()){last_spawned_pickup=nowint();pickup_counter++;var a=pickup_counter+0;count_object(possible_pickups)<1&&(possible_pickups=get_all_possible_pickups());var b=1,c=get_random_key_from_object_based_on_num_value(possible_pickups);Math.random()<.75&&(c="scraps",b=round_by_percent(get_upgrade_factor("floating_scraps","any",!0)));var e='<div class="pickup pickup_'+pickup_counter+'" style="top:'+Math.floor(Math.random()*
80+10)+'%" onclick="claim_pickups('+pickup_counter+')">'+parse_card(c)+"</div>";$(".battle_container").append(e);pickup_rewards[a]={card_id:c,card_amount:b};clear_pickup_timers[a]=setTimeout(function(){pickup_rewards={};$(".pickup_"+a).remove()},15E3)}}
function claim_pickups(a){if(pickup_rewards[a]!=void 0){if(gamedata.upgrades!=void 0){var b=get_upgrade_factor("loot",[pickup_rewards[a].card_id],!0);pickup_rewards[a].card_amount=round_by_percent(pickup_rewards[a].card_amount*b)}check_quests("claimed_pickup");all_available_cards[pickup_rewards[a].card_id]!=void 0&&gain_card(pickup_rewards[a].card_id,pickup_rewards[a].card_amount);pickup_rewards[a].card_id=="scraps"&&(gamedata.scraps+=pickup_rewards[a].card_amount)}$(".pickup_"+a).remove();delete pickup_rewards[a];
clearTimeout(clear_pickup_timers[a])}function get_all_possible_pickups(){var a={},b=(new Date).getMonth()+1;$.each(all_available_cards,function(c,e){match_array_values(b,e.months_available)&&e.type=="currency"&&(a[c]=1/Math.sqrt(e.value))});a.peasant=1;return a}
var current_battle_type="",battle_info={},total_timeout=0,active_turn=1,total_turn_counter=0,combat_alive=!1,difficulty_setting=1,current_test_deck=0,arena_deck={},arena_deck_id=0,arena_reward_amount=0,current_arena_player_name="",endless_waves=!1,fight_number=0,king_of_the_hill_streak=0,enemy_card_back="",arena_card_back="",fixed_hero=!1,next_random_hero="",map_hero="",battle_stats={},endless_wave_count=1;
function show_random_battle(){enemy_card_back="";current_battle_type="random";show_content("battle")}
function show_battle(){set_game_speed(!1);battle_speed>.65&&($(".main_window").removeClass("game_speed_fast"),$(".main_window").removeClass("game_speed_medium"),$(".main_window").addClass("game_speed_slow"));battle_speed==.65&&($(".main_window").removeClass("game_speed_slow"),$(".main_window").removeClass("game_speed_fast"),$(".main_window").addClass("game_speed_medium"));battle_speed<.65&&($(".main_window").removeClass("game_speed_slow"),$(".main_window").removeClass("game_speed_medium"),$(".main_window").addClass("game_speed_fast"));
endless_waves==0&&gamedata.battles_started++;saveToLocalStorage();clear_all_timeouts();fight_number+=1;if(gamedata.decks[gamedata.current_deck].hero!=void 0){battle_info={combat_units:{},enemy_combat_boosts:{}};battle_stats={};$(".battle_container").html("");$(".projectile").remove();$(".battle_container").append('<div class="total_turn_counter_container">TURN: <span class="total_turn_counter"></span></div>');$(".resign_button").css("display","none");total_turn_counter=total_timeout=0;active_turn=
Math.ceil(Math.random()*2);$(".battle_container").append('<div class="turn_pointer turn_pointer_'+active_turn+'"></div>');combat_alive=!0;for(var a=1;a<3;a++)for(var b=-5;b<6;b++)$(".battle_container").append('<div class="unit slot_container side_'+a+" slot_"+b+'" onclick="show_unit_details('+a+","+b+')"></div>');gamedata.decks[gamedata.current_deck].hero!=void 0&&(battle_info.combat_units[2]=create_hero(gamedata.decks[gamedata.current_deck].hero,2),battle_info.combat_units[2].color=["green"],battle_info.combat_units[2].slot=
0,battle_info.combat_units[2].side=2,battle_info.combat_units[2].origin_side=2,battle_info.combat_units[2].unit_id=2,battle_info.combat_units[2].card_type=gamedata.decks[gamedata.current_deck].hero+"",battle_info.combat_units[2].current_health=battle_info.combat_units[2].health,a=parse_combat_unit(battle_info.combat_units[2],void 0,void 0,!0),$(".battle_container").append(a));current_battle_type=="test_deck"&&(battle_info.combat_units[1]=create_hero(gamedata.decks[current_test_deck].hero),battle_info.combat_units[1].slot=
0,battle_info.combat_units[1].side=1,battle_info.combat_units[1].origin_side=1,battle_info.combat_units[1].unit_id=1,battle_info.combat_units[1].card_type=c,battle_info.combat_units[1].current_health=battle_info.combat_units[1].health,enemy_card_back=battle_info.combat_units[1].image+"",a=parse_combat_unit(battle_info.combat_units[1],void 0,void 0,!0),$(".battle_container").append(a));if(current_battle_type=="summoned"){if(endless_waves==0){var c=gamedata.current_summon.hero;difficulty_setting=gamedata.current_summon.level}endless_waves==
1&&(c=get_summon_stats(),c=get_random_hero(!0,c.min_rarity,c.max_rarity,c.common_reduction),difficulty_setting=(endless_wave_count-1)/get_upgrade_factor("wave_power_increase","any",!0)+get_upgrade_factor("wave_min_power","any",!0));battle_info.combat_units[1]=create_hero(c,1);battle_info.combat_units[1].color=["red"];battle_info.combat_units[1].slot=0;battle_info.combat_units[1].side=1;battle_info.combat_units[1].origin_side=1;battle_info.combat_units[1].unit_id=1;battle_info.combat_units[1].card_type=
c;battle_info.combat_units[1].current_health=battle_info.combat_units[1].health;a=parse_combat_unit(battle_info.combat_units[1],void 0,void 0,!0);enemy_card_back=battle_info.combat_units[1].image+"";$(".battle_container").append(a)}battle_info.deck_2={};var e=0;$.each(gamedata.decks[gamedata.current_deck],function(d,f){if(d!="hero")for(var g=0;g<f;g++)battle_info.deck_2[e]={card_id:d,status:"deck",time_left:all_available_cards[d].time},e++});current_battle_type=="summoned"&&(endless_waves==1||gamedata.current_summon.deck==
void 0?(a=30*get_effective_power_factor(),a>30&&(a=30),a<1&&(a=1),battle_info.deck_1=Math.random()>1.5?construct_random_deck(a,c):construct_random_deck(a,c,!0),endless_waves==0&&(gamedata.current_summon.deck=true_copyobject(battle_info.deck_1))):battle_info.deck_1=true_copyobject(gamedata.current_summon.deck));update_deck_counts();check_visible_skills(1);check_visible_skills(2);total_timeout=0;current_battle_type!="summoned"&&current_battle_type!="king_of_the_hill"||show_vs();timeout_key++;all_timeouts[timeout_key]=
setTimeout(function(){start_next_turn()},total_timeout)}else show_content("home"),$(".detail_overlay  .card_detail").html('<div class="big_text">You need to asign a hero<br/>to be able to fight a battle</div>'),$(".detail_overlay").removeClass("hidden")}
function show_vs(){var a="";endless_waves==1&&(a+="<br/><span>Wave "+endless_wave_count+" ("+Math.floor(difficulty_setting*10)+"%)</span>");var b='<div class="vs_container"><div class="vs_player_image" style="background-image:url(images/'+(battle_info.combat_units[2].image+')"></div>');b+='<div class="vs_enemy_image" style="background-image:url(images/'+battle_info.combat_units[1].image+')"></div>';b+='<div class="vs_player_name">'+capitalizeFirstLetter(battle_info.combat_units[2].name)+"</div>";
b+='<div class="vs_enemy_name">'+capitalizeFirstLetter(battle_info.combat_units[1].name)+a+"</div>";b+='<div class="vs_vs">V&nbsp;<br/>&nbsp;S</div></div>';$(".main_window").append(b);current_battle_type=="king_of_the_hill"&&$(".vs_enemy_name span").prepend("King ");timeout_key++;total_timeout+=100;all_timeouts[timeout_key]=setTimeout(function(){$(".vs_player_image").addClass("active");$(".vs_enemy_image").addClass("active")},total_timeout);timeout_key++;total_timeout+=400;all_timeouts[timeout_key]=
setTimeout(function(){$(".vs_player_name").addClass("active")},total_timeout);timeout_key++;total_timeout+=0;all_timeouts[timeout_key]=setTimeout(function(){$(".vs_enemy_name").addClass("active")},total_timeout);timeout_key++;total_timeout+=0;all_timeouts[timeout_key]=setTimeout(function(){$(".vs_vs").addClass("active")},total_timeout);total_timeout+=0;all_timeouts[timeout_key]=setTimeout(function(){$(".vs_vs").addClass("active2")},total_timeout);timeout_key++;total_timeout+=2E3;all_timeouts[timeout_key]=
setTimeout(function(){$(".vs_container").addClass("faded")},total_timeout);timeout_key++;total_timeout+=1E3;all_timeouts[timeout_key]=setTimeout(function(){$(".vs_container").remove()},total_timeout);total_timeout-=2500}
function convert_deck(a){var b={};b=create_combat_unit(a.hero);b.slot=0;b.side=1;b.origin_side=1;b.unit_id=1;b.current_health=b.health;var c={},e=0;$.each(a.deck,function(d,f){if(d!="hero")for(var g=0;g<f;g++)c[e]={card_id:d,status:"deck",time_left:all_available_cards[d].time},e++});console.log(JSON.stringify(b));console.log("-------------");console.log(JSON.stringify(c))}
function create_fake_hero(a){var b=get_random_hero();a!=void 0&&(b=a);a=create_hero(b);a.slot=0;a.side=1;a.origin_side=1;a.unit_id=1;a.card_type=b;a.current_health=a.health;return a}function construct_random_enemy_deck(a,b){a==void 0&&(a=get_random_hero());b==void 0&&(b=30);var c=create_fake_hero(a);a=construct_random_deck(b,a,!0);console.log(c);console.log("-------------");console.log(a)}
var random_deck_times={basic:{percent_main:10,percent_slow:90,percent_massive:200},fast:{percent_main:30,percent_slow:90,percent_massive:200},slow:{percent_main:10,percent_slow:70,percent_massive:200},cheap:{percent_main:55,percent_slow:90,percent_massive:200},muscle:{percent_main:0,percent_slow:75,percent_massive:200},cheap_only:{percent_main:90,percent_slow:90,percent_massive:200}};
function get_active_deck_speed(){var a=0,b=gamedata.decks[gamedata.current_deck],c=count_object(b)-1,e=0;c>0&&(c=0,$.each(b,function(d,f){d!="hero"&&all_available_cards[d]!=void 0&&(e+=all_available_cards[d].time*f,c+=f)}),a=e/c);return a}var show_deck_construction=!1;
function construct_random_deck(a,b,c){var e=1E3,d=0,f=0,g=0;Math.random()>.5&&(e=Math.floor(Math.random()*6)+3);var h={},k=all_available_cards[b].color[0],l=!1,p=[],n=["cardback"];all_available_cards[b].color[1]!=void 0&&(l=all_available_cards[b].color[1]);var q=!1;all_available_cards[b].hero_version.theme!=void 0&&(q=all_available_cards[b].hero_version.theme);var m=get_random_card("any",e,k,l,0,q,p,n),r=0,t=get_random_key_from_object(random_deck_times);Math.random()<.5&&(t="basic");all_available_cards[b].hero_version.time_theme!=
void 0&&Math.random()<.9&&(t=all_available_cards[b].hero_version.time_theme);e=get_active_deck_speed();Math.random()<.25&&(e>0&&e<2&&(t="cheap"),e>=2&&e<4&&(t="fast"),e>=4&&e<6&&(t="basic"),e>=6&&e<8&&(t="slow"),e>=8&&(t="muscle"));var v=random_deck_times[t];all_available_cards[b].hero_version.deck_times!=void 0&&$.each(all_available_cards[b].hero_version.deck_times,function(z,A){v[z]=A});if(a<30){var w=30/a;$.each(v,function(z,A){v[z]*=w})}for(b=0;b<a;b++){r+=1;var x=b/a*100;d=0;e=4;x>=v.percent_main&&
(d=5,e=9);x>=v.percent_slow&&(d=10,e=150);x>=v.percent_massive&&(d=16,e=100);r=0;$.each(h,function(z,A){A.card_id==m&&(r+=1)});if(r>4||all_available_cards[m].max_in_deck!=void 0&&r>=all_available_cards[m].max_in_deck){var u=!1;$.each(p,function(z,A){A==m&&(u=!0)});u==0&&(p[get_highest_key_in_object(p)+1]=m)}if(r>4||c!=void 0&&c==1)m=get_random_card("any",e,k,l,d,q,p,n),all_available_cards[m]!=void 0&&(all_available_cards[m].type=="artifact"&&f>3&&(all_available_cards[m].selfdestructs==void 0||all_available_cards[m].selfdestructs==
0)||all_available_cards[m].type=="spell"&&g>10)&&(m=get_random_card("any",e,k,l,d,q,p,n)),all_available_cards[m]==void 0||all_available_cards[m].type!="artifact"||all_available_cards[m].selfdestructs!=void 0&&all_available_cards[m].selfdestructs!=0||(f++,f>4&&match_array_values(n,["artifact"])==0&&(n[count_object(n)]="artifact")),all_available_cards[m]!=void 0&&all_available_cards[m].type=="spell"&&g++,r=0;all_available_cards[m]!=void 0&&all_available_cards[m].pick_chance>0?($.each(all_available_cards[m].color,
function(z,A){k=="colorless"&&(k=A);A!=k&&A!="colorless"&&(l=A)}),h[b]={card_id:m,status:"deck",time_left:all_available_cards[m].time}):console.log(m)}h=check_deck_min_enemy_targets(h,q);if(show_deck_construction==1){console.log("DECK CONSTRUCTION");console.log("Theme:");console.log(q);var y={},B=0;$.each(h,function(z,A){y[A.card_id]==void 0?y[A.card_id]=1:y[A.card_id]++;B+=all_available_cards[A.card_id].time});console.log("cards:");console.log(y);console.log("deck times:");console.log(t);console.log(v);
console.log("artifact count: "+f);console.log("average card time: "+B/30)}return h}
function check_deck_min_enemy_targets(a,b){var c=count_object(a),e=0,d={};$.each(a,function(h,k){all_available_cards[k.card_id]!=void 0&&match_array_values("aoe",all_available_cards[k.card_id].theme)==1?e++:d[h]=k.time_left});show_deck_construction==1&&console.log("aoe theme count: "+e);if(e+1<=c/10){c=get_random_key_from_object(d);for(var f=true_copyobject(b),g=3;g>=0;g--)f[get_highest_key_in_object(f)+1]="aoe";f=get_random_card("any",d[c]+2,void 0,void 0,d[c]-2,f,void 0,void 0);f==0&&(f=get_random_card("any",
d[c]+2,void 0,void 0,d[c]-2,["aoe"],void 0,void 0));show_deck_construction==1&&console.log("replacing "+a[c].card_id+"("+a[c].time_left+") with "+f+"("+all_available_cards[f].time+")");f!=0&&(a[c]={card_id:f,status:"deck",time_left:all_available_cards[f].time});a=check_deck_min_enemy_targets(a,b)}return a}
function count_enemy_deck_cards(){if(battle_info!=void 0&&battle_info.deck_1!=void 0){var a={};$.each(battle_info.deck_1,function(b,c){a[c.card_id]==void 0?a[c.card_id]=1:a[c.card_id]++});console.log(a)}}
function update_deck_counts(){var a=count_deck_cards(battle_info.deck_1),b=count_grave_cards(battle_info.deck_1),c=count_deck_cards(battle_info.deck_2),e=count_grave_cards(battle_info.deck_2);setTimeout(function(){$(".player_deck_counter").html(c+" / "+e);$(".enemy_deck_counter").html(a+" / "+b)},total_timeout)}function count_deck_cards(a,b){var c=0;$.each(a,function(e,d){d.status!="deck"||b!=void 0&&all_available_cards[d.card_id].type!=b||c++});return c}
function count_hand_cards(a,b){var c=0;$.each(a,function(e,d){d.status!="hand"||b!=void 0&&all_available_cards[d.card_id].type!=b||c++});return c}function count_grave_cards(a,b){var c=0;$.each(a,function(e,d){d.status!="grave"||b!=void 0&&all_available_cards[d.card_id].type!=b||c++});return c}
function get_random_hero(a,b,c,e){gamedata.known_recipes==void 0&&(gamedata.known_recipes={});var d=!1,f=0;$.each(all_available_cards,function(h,k){if(k.hero_version!=void 0&&(c==void 0||k.value<=c)&&(b==void 0||k.value>=b))if(a==void 0||a==0)f+=1;else{var l=k.value;e!=void 0&&l<e&&(gamedata.known_recipes[h]!=void 0||k.recipe==void 0)&&(l=e);f+=1/(l*l)}});var g=Math.random()*f;$.each(all_available_cards,function(h,k){if(k.hero_version!=void 0&&(c==void 0||k.value<=c)&&(b==void 0||k.value>=b)){if(a==
void 0||a==0)--g;else{var l=k.value;e!=void 0&&l<e&&(gamedata.known_recipes[h]!=void 0||k.recipe==void 0)&&(l=e);g-=1/(l*l)}g<=0&&d==0&&(d=h)}});d==0&&b!=void 0&&(b/=2,d=get_random_hero(a,b,c,e));d==0&&(d="peasant");return d}
function get_random_card(a,b,c,e,d,f,g,h){var k=0,l=!1,p=(new Date).getMonth()+1;$.each(all_available_cards,function(q,m){if(m.type!=void 0&&match_array_values(m.type,h)==0&&(match_array_values(m.type,a)||a=="any")&&(b==void 0||b>=m.time)&&(d==void 0||d<=m.time)&&(m.months_available==void 0||match_array_values([p],m.months_available)==1)){var r=!0;c!=void 0&&e!=void 0&&(e==0&&m.color[0]!=c&&m.color[1]!=void 0&&m.color[1]!=c&&(r=!1),$.each(m.color,function(t,v){v!=c&&e!=0&&v!=e&&v!="colorless"&&(r=
!1)}));g!=void 0&&match_array_values(g,q)==1&&(r=!1);m.pick_chance!=void 0&&m.pick_chance==0&&(r=!1);m.not_theme!=void 0&&match_array_values(m.not_theme,f)>0&&(r=!1);r==1&&(q=1,m.pick_chance!=void 0&&(q=m.pick_chance),m.color[0]=="colorless"&&(q*=1),f!=void 0&&(m=match_array_values(m.theme,f,!0),m=to_the_nth(1,10,m+1),q*=m),k+=q)}});var n=Math.random()*k;$.each(all_available_cards,function(q,m){if(m.type!=void 0&&match_array_values(m.type,h)==0&&(match_array_values(m.type,a)||a=="any")&&(b==void 0||
b>=m.time)&&(d==void 0||d<=m.time)&&(m.months_available==void 0||match_array_values([p],m.months_available)==1)){var r=!0;c!=void 0&&e!=void 0&&(e==0&&m.color[0]!=c&&m.color[1]!=void 0&&m.color[1]!=c&&(r=!1),$.each(m.color,function(v,w){w!=c&&e!=0&&w!=e&&w!="colorless"&&(r=!1)}));g!=void 0&&match_array_values(g,q)==1&&(r=!1);m.pick_chance!=void 0&&m.pick_chance==0&&(r=!1);m.not_theme!=void 0&&match_array_values(m.not_theme,f)>0&&(r=!1);if(r==1){var t=1;m.pick_chance!=void 0&&(t=m.pick_chance);m.color[0]==
"colorless"&&(t*=1);f!=void 0&&(m=match_array_values(m.theme,f,!0),m=to_the_nth(1,10,m+1),t*=m);n-=t;n<=0&&l==0&&(l=q)}}});l==0&&(l=get_random_card(a,b,c,e));return l}
function get_random_card_based_on_time(a,b,c,e,d,f,g,h){var k=0,l=!1,p=(new Date).getMonth()+1;$.each(all_available_cards,function(q,m){if(m.pick_chance>0&&m.type!=void 0&&(h==void 0||match_array_values(m.subtypes,h)==0||h=="any")&&(m.type==a||a=="any"||a==void 0)&&(b==void 0||b>=m.time)&&(f==void 0||f<=m.time)&&(d==void 0||match_array_values(d,m.subtypes)==1)&&(m.months_available==void 0||match_array_values([p],m.months_available)==1)){var r=!0;c!=void 0&&e!=void 0&&(e==0&&m.color[0]!=c&&m.color[1]!=
void 0&&m.color[1]!=c&&(r=!1),$.each(m.color,function(t,v){v!=c&&e!=0&&v!=e&&(r=!1)}));g!=void 0&&match_array_values(g,q)==1&&(r=!1);r==1&&(q=1,m.time!=void 0&&m.time>1&&(q/=sqr(m.time/1)),k+=q)}});var n=Math.random()*k;$.each(all_available_cards,function(q,m){if(m.pick_chance>0&&m.type!=void 0&&(h==void 0||match_array_values(m.subtypes,h)==0||h=="any")&&(m.type==a||a=="any"||a==void 0)&&(b==void 0||b>=m.time)&&(f==void 0||f<=m.time)&&(d==void 0||match_array_values(d,m.subtypes)==1)&&(m.months_available==
void 0||match_array_values([p],m.months_available)==1)){var r=!0;c!=void 0&&e!=void 0&&(e==0&&m.color[0]!=c&&m.color[1]!=void 0&&m.color[1]!=c&&(r=!1),$.each(m.color,function(v,w){w!=c&&e!=0&&w!=e&&(r=!1)}));g!=void 0&&match_array_values(g,q)==1&&(r=!1);if(r==1){var t=1;m.time!=void 0&&m.time>1&&(t/=sqr(m.time/1));n-=t;n<=0&&l==0&&(l=q)}}});l==0&&(l=get_random_card_based_on_time(a,b+1));return l}
function test_based_on_time(a,b,c,e,d,f,g,h,k){for(var l=0,p=!1,n=!1,q=0;q<a;q++){var m=get_random_card_based_on_time(b,c,e,d,f,g,h,k);l+=all_available_cards[m].time;if(p===!1||all_available_cards[m].time<p)p=all_available_cards[m].time;if(n===!1||all_available_cards[m].time>n)n=all_available_cards[m].time}console.log("average: "+l/a);console.log("lowest: "+p);console.log("highest: "+n)}
function get_random_card_based_on_value(a,b,c,e,d,f){var g=0,h=!1;a==void 0&&(a=1);a<=0&&(a=1);var k=(new Date).getMonth()+1;$.each(all_available_cards,function(p,n){!((d==void 0||match_array_values(d,p)==0)&&(n.pick_chance>0||n.basic_reward!=void 0||e!=void 0)&&(c==void 0&&n.type!="cardback"&&n.type!="consumable"&&n.type!="currency"&&n.type!="item"&&n.type!="treasure"||match_array_values(n.type,c)==1)&&n.value!=void 0&&n.value>=a&&(f==void 0||n.value<=f))||b!=void 0&&n.color[0]!=b||n.months_available!=
void 0&&match_array_values([k],n.months_available)!=1||(p=get_pick_chance_on_value(n.value,a),g+=p)});var l=Math.random()*g;$.each(all_available_cards,function(p,n){!((d==void 0||match_array_values(d,p)==0)&&(n.pick_chance>0||n.basic_reward!=void 0||e!=void 0)&&(c==void 0&&n.type!="cardback"&&n.type!="consumable"&&n.type!="currency"&&n.type!="item"&&n.type!="treasure"||match_array_values(n.type,c)==1)&&n.value!=void 0&&n.value>=a&&(f==void 0||n.value<=f))||b!=void 0&&n.color[0]!=b||n.months_available!=
void 0&&match_array_values([k],n.months_available)!=1||(n=get_pick_chance_on_value(n.value,a),l-=n,l<=0&&h==0&&(h=p))});return h}function get_pick_chance_on_value(a,b){b=1;a!=void 0&&(a<1&&(a=1),b=1E5/(a*(1+a/10)));return b}function apply_min_value(a,b){if(b==void 0||b<1)b=1;return a=100*a+sqr(b)}
function get_basic_reward_card(a){var b=(new Date).getMonth()+1,c="peasant",e={};$.each(all_available_cards,function(d,f){if(f.basic_reward!=void 0&&f.basic_reward==1||f.value==1&&match_array_values([b],f.months_available)==1){var g=!0;$.each(a,function(h,k){k.card_id==d&&(g=!1)});g==1&&(e[d]=!0)}});count_object(e)>0&&(c=get_random_key_from_object(e));return c}
function get_fragment_card(){var a=(new Date).getMonth()+1,b="",c={};$.each(all_available_cards,function(e,d){d.type!="fragment"||d.months_available!=void 0&&match_array_values([a],d.months_available)!=1||(c[e]=1/d.value*(1/d.value))});count_object(c)>0&&(b=get_random_key_from_object_based_on_num_value(c));return b}
function get_back_card_card(){var a=(new Date).getMonth()+1,b="",c={};$.each(all_available_cards,function(e,d){d.non_tradable!=void 0||d.type!="cardback"||d.reward==void 0||d.reward.type==void 0||d.reward.type!="card_back"||d.months_available!=void 0&&match_array_values([a],d.months_available)!=1||(c[e]=1/d.value*(1/d.value))});count_object(c)>0&&(b=get_random_key_from_object_based_on_num_value(c));return b}
function check_get_random_card_value(a,b,c,e){for(var d=[],f=0,g=1;g>0;g--){var h=get_random_card_based_on_value(a,b,c,e,d);f+=all_available_cards[h].value}console.log(f/1)}function check_get_random_card(){for(var a=100;a>=0;a--)get_random_card("any")==0&&console.log("failed")}
function parse_combat_unit(a,b,c,e){var d="";b==void 0&&(b="");var f=" slot_"+a.slot;c!=void 0&&c==1&&(f="");d=current_battle_type=="chapter_battle"&&typeof a.card_type=="object"?d+('<div class="unit unit_id_'+a.unit_id+" unit_type_"+a.type+f+" side_"+a.side+" "+b+'" onclick="show_card_details(\''+current_chapter+"', "+e+",undefined,undefined,"+a.unit_id+'), pause_game()">'):d+('<div class="unit unit_id_'+a.unit_id+" unit_type_"+a.type+f+" side_"+a.side+" "+b+'" data-card_type="'+a.card_type+'" onclick="show_card_details(\''+
a.card_type+"', "+e+'), pause_game()">');count_object(a.color)>1?$.each(a.color,function(g,h){d+='<div class="card_color color_'+h+" color_number_"+g+'"></div>'}):d+='<div class="card_color color_'+a.color[0]+' color_number_0"></div><div class="card_color color_'+a.color[0]+' color_number_1"></div>';b="";a.image_position!=void 0&&(b=";background-position:"+a.image_position);d+='<div class="card_image" style="background-image:url(images/'+a.image+")"+b+'"></div>';a.time!=void 0&&a.time!=0&&(d+='<div class="card_time">'+
a.time+"</div>");d+='<div class="card_name">'+capitalizeFirstLetter(a.name)+"</div>";d=a.power!==!1?d+('<div class="card_power">'+a.power+"</div>"):d+'<div class="card_power hidden"></div>';a.health!=0&&(d+='<div class="card_health"><div class="current_health"></div><div class="temp_health"></div><div class="max_health">'+a.current_health+"</div></div>");b="0";a.armor>0&&(b=1);d+='<div class="card_armor" style="opacity:'+b+'">'+a.armor+"</div>";d+='<div class="unit_effects">';$.each(a.effects,function(g,
h){d+='<div class="effect_'+g+'">'+h+"</div>"});d+="</div>";return d+="</div>"}
function parse_abilities(a){var b=battle_info.combat_units[a],c="";$.each(b.abilities,function(e,d){if((e!="strike"&&e!="strike_unit"||d!=1)&&all_abilities[e]!=void 0&&all_abilities[e].do_not_show==void 0){c!=""&&(c+=",&nbsp;</span>");var f=d;typeof f=="object"&&(f=d.level);var g=all_abilities[e];c+='<span class="'+e+'" style="color:'+g.name_color+'">';c+=g.name;if(f>1||g.show_amount_adjustment!=void 0||d.level_2!=void 0)g.show_amount_adjustment!=void 0&&(f+=g.show_amount_adjustment),f>1&&(c+=" "+
f),g.post_name!=void 0&&(c+=g.post_name);d.level_2!=void 0&&d.level_2>1&&(c+="/"+d.level_2);b.ability_delays[e]!=void 0&&b.ability_delays[e]>0&&(c+=" ("+b.ability_delays[e]+")")}});c!=""&&(c+="</span>");c="";return c='<div class="card_type">'+b.type+"</div>"+c}
function create_hero(a,b){var c=all_available_cards[a].hero_version;c.color=all_available_cards[a].color;var e=create_combat_unit(c);if(b!=void 0&&b==1){var d=get_effective_power_factor();e.power>0&&(e.power=e.power*d>1?round_by_percent(e.power*d):Math.ceil(e.power*d));e.health=e.health*d>1?round_by_percent(e.health*d):Math.ceil(e.health*d);$.each(e.abilities,function(f,g){all_abilities[f]!=void 0&&all_abilities[f].scales!=void 0&&all_abilities[f].scales==1&&(e.abilities[f]=g*d>1?round_by_percent(g*
d):Math.ceil(g*d))})}return e}
function apply_power_factor(a,b){var c=get_effective_power_factor();b==1&&(a.power>0&&(a.power=a.power*c>1?round_by_percent(a.power*c):Math.ceil(a.power*c)),a.health>0&&(a.health=a.health*c>1?round_by_percent(a.health*c):Math.ceil(a.health*c)),a.armor>0&&(a.armor=Math.ceil(a.armor*c)),$.each(a.abilities,function(e,d){all_abilities[e]!=void 0&&all_abilities[e].scales!=void 0&&all_abilities[e].scales==1&&(a.abilities[e]=d*c>1?round_by_percent(d*c):Math.ceil(d*c))}));return a}
function get_effective_power_factor(a){a==void 0&&(a=difficulty_setting);sqr(.5+a/20);return a/10}
function create_combat_unit(a,b){var c=true_copyobject(a);c.effects=true_copyobject(a.effects);c.effects==void 0&&(c.effects={});var e={};$.each(c.abilities,function(d,f){e[d]=f});c.abilities=e;c=apply_power_factor(c,b);c.ability_delays={};$.each(c.abilities,function(d,f){all_abilities[d].starting_delay!=void 0&&(c.ability_delays[d]=all_abilities[d].starting_delay);typeof f=="object"&&f.starting_delay!=void 0&&(c.ability_delays[d]=f.starting_delay)});return c}
function add_battle_stats(a,b,c){b==void 0&&(b=1);check_achievement_goals();battle_stats[a+"_total"]==void 0&&(battle_stats[a+"_total"]=0);battle_stats[a+"_times"]==void 0&&(battle_stats[a+"_times"]=0);battle_stats[a+"_max"]==void 0&&(battle_stats[a+"_max"]=0);battle_stats[a+"_total"]+=b;battle_stats[a+"_times"]+=1;b>battle_stats[a+"_max"]&&(battle_stats[a+"_max"]=b);all_achievement_goals[a]!=void 0&&check_quests(a);all_achievement_goals[a+"_total"]!=void 0&&check_quests(a+"_total",battle_stats[a+
"_total"]);all_achievement_goals[a+"_times"]!=void 0&&check_quests(a+"_times",battle_stats[a+"_times"]);all_achievement_goals[a+"_max"]!=void 0&&check_quests(a+"_max",battle_stats[a+"_max"])}
function find_new_ability(a,b){var c="",e=0,d=[],f=0;$.each(a,function(h,k){d[f]=h;f++});$.each(all_abilities,function(h,k){match_array_values(d,[h])==0&&check_if_ability_can_be_added(h,b)&&e++});var g=Math.floor(Math.random()*e)+1;$.each(all_abilities,function(h,k){match_array_values(d,[h])==0&&check_if_ability_can_be_added(h,b)&&(g--,g<1&&c==""&&(c=h))});return c}
function check_if_ability_can_be_added(a,b){var c=!1;a=all_abilities[a];a.good_random!=void 0&&a.good_random==1&&(c=!0);a.need_power!=void 0&&a.need_power==1&&b.power<1&&(c=!1);a.proc=="dealt_damage"&&b.power<1&&(c=!1);a.proc=="overkill"&&b.power<2&&(c=!1);return c};